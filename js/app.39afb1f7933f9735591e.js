(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{"+P3/":function(e){e.exports=[{name:"北京市",id:"110000000000"},{name:"天津市",id:"120000000000"},{name:"河北省",id:"130000000000"},{name:"山西省",id:"140000000000"},{name:"内蒙古自治区",id:"150000000000"},{name:"辽宁省",id:"210000000000"},{name:"吉林省",id:"220000000000"},{name:"黑龙江省",id:"230000000000"},{name:"上海市",id:"310000000000"},{name:"江苏省",id:"320000000000"},{name:"浙江省",id:"330000000000"},{name:"安徽省",id:"340000000000"},{name:"福建省",id:"350000000000"},{name:"江西省",id:"360000000000"},{name:"山东省",id:"370000000000"},{name:"河南省",id:"410000000000"},{name:"湖北省",id:"420000000000"},{name:"湖南省",id:"430000000000"},{name:"广东省",id:"440000000000"},{name:"广西壮族自治区",id:"450000000000"},{name:"海南省",id:"460000000000"},{name:"重庆市",id:"500000000000"},{name:"四川省",id:"510000000000"},{name:"贵州省",id:"520000000000"},{name:"云南省",id:"530000000000"},{name:"西藏自治区",id:"540000000000"},{name:"陕西省",id:"610000000000"},{name:"甘肃省",id:"620000000000"},{name:"青海省",id:"630000000000"},{name:"宁夏回族自治区",id:"640000000000"},{name:"新疆维吾尔自治区",id:"650000000000"}]},0:function(e,t,i){e.exports=i("x7I7")},"28lc":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),a=i("q1tI"),s=o(a),r=o(i("iKIH"));function o(e){return e&&e.__esModule?e:{default:e}}var l=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.Component),n(t,[{key:"render",value:function(){return s.default.createElement("div",{className:r.default.loading},s.default.createElement("span",null))}}]),t}();t.default=l;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(l,"ReLoading","D:/shun/gs3power/src/components/widgets/ReLoading/index.js")},"4M7o":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r,o,l,h,c,u,d,p,f,m=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),v=i("2vnA"),g=i("Yixb"),_=(f=g)&&f.__esModule?f:{default:f};function y(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function b(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var x=(n=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.sdkReady=!1,y(this,"ready",a,this),y(this,"active",s,this),y(this,"miniprogram",r,this),y(this,"signature",o,this),y(this,"shareTitle",l,this),y(this,"shareDesc",h,this),y(this,"shareLogo",c,this),y(this,"shareTitle2",u,this),y(this,"shareDesc2",d,this),y(this,"shareLogo2",p,this),window.WeixinJSBridge&&WeixinJSBridge.invoke?this.onReady():document.addEventListener("WeixinJSBridgeReady",this.onReady.bind(this),!1)}return m(e,[{key:"onReady",value:function(){this.update("ready",!0),"miniprogram"===window.__wxjs_environment&&this.update("miniprogram",!0),"micromessenger"==navigator.userAgent.toLowerCase().match(/MicroMessenger/i)&&this.getWeChaSignature(location.href)}},{key:"getWeChaSignature",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";_.default.get($$.api("wechat_share"),{params:{share_url:encodeURIComponent(e),wechat_name:"realibox"}}).then(function(e){(0,v.runInAction)(function(){t.signature=e.info,t.weChatConfigInit()})}).catch(function(e){})}},{key:"weChatConfigInit",value:function(){var e=this;wx.config({debug:!1,appId:this.signature.appId,timestamp:this.signature.timestamp,nonceStr:this.signature.nonceStr,signature:this.signature.signature,jsApiList:["onMenuShareTimeline","updateAppMessageShareData","updateTimelineShareData","translateVoice"]}),wx.ready(function(){e.sdkReady=!0,e.weChatShareConfig()})}},{key:"weChatShareConfig",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"normal";this.sdkReady&&(wx.updateAppMessageShareData({title:"normal"===e?this.shareTitle:this.shareTitle2,desc:"normal"===e?this.shareDesc:this.shareDesc2,link:location.href,imgUrl:"normal"===e?this.shareLogo:this.shareLogo2,success:function(){}}),wx.updateTimelineShareData({title:"normal"===e?this.shareTitle:this.shareTitle2,desc:"normal"===e?this.shareDesc:this.shareDesc2,link:location.href,imgUrl:"normal"===e?this.shareLogo:this.shareLogo2,success:function(){}}))}},{key:"navigateTo",value:function(i){var n=this;return new Promise(function(e,t){n.ready&&n.miniprogram?wx.miniProgram.navigateTo({url:i,success:function(){e()},fail:function(){t()}}):t()})}},{key:"switchTab",value:function(i){var n=this;return new Promise(function(e,t){n.ready&&n.miniprogram?wx.miniProgram.switchTab({url:i,success:function(){e()},fail:function(){t(!1)}}):t(!0)})}},{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}}]),e}(),a=b(n.prototype,"ready",[v.observable],{enumerable:!0,initializer:function(){return!1}}),s=b(n.prototype,"active",[v.observable],{enumerable:!0,initializer:function(){return!1}}),r=b(n.prototype,"miniprogram",[v.observable],{enumerable:!0,initializer:function(){return!1}}),o=b(n.prototype,"signature",[v.observable],{enumerable:!0,initializer:function(){return{}}}),l=b(n.prototype,"shareTitle",[v.observable],{enumerable:!0,initializer:function(){return"8万级黄金动力SUV 传祺GS3 POWER VR展厅"}}),h=b(n.prototype,"shareDesc",[v.observable],{enumerable:!0,initializer:function(){return'应有劲有 向新潮的智能体验"劲"击'}}),c=b(n.prototype,"shareLogo",[v.observable],{enumerable:!0,initializer:function(){return"https://xxx.com/wechat_share.png"}}),u=b(n.prototype,"shareTitle2",[v.observable],{enumerable:!0,initializer:function(){return""}}),d=b(n.prototype,"shareDesc2",[v.observable],{enumerable:!0,initializer:function(){return""}}),p=b(n.prototype,"shareLogo2",[v.observable],{enumerable:!0,initializer:function(){return""}}),b(n.prototype,"weChatShareConfig",[v.observable],Object.getOwnPropertyDescriptor(n.prototype,"weChatShareConfig"),n.prototype),b(n.prototype,"update",[v.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),n);t.default=x;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(x,"WeChat","D:/shun/gs3power/src/stores/wechat.js")},"5aor":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r,o=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),l=i("2vnA");function h(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function c(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var u=(n=function(){function t(){var e=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.sceneID="main",h(this,"loaded",a,this),h(this,"progress",s,this),h(this,"stopInteraction",r,this),$$.events.method("store",function(){return e})}return o(t,[{key:"initAppEvent",value:function(){this.app.events.on("edk:scene:resource:preload:progress",this.onResourceProgress.bind(this)),this.app.events.on("edk:scene:resource:preload:end",this.onLoadResourceEnd.bind(this)),this.app.events.on("edk:plugin:annotation:click",this.onAnnotationClick.bind(this))}},{key:"onResourceProgress",value:function(e,t){t&&(this.progress=100*t.progress,100<this.progress&&(this.progress=100))}},{key:"onLoadResourceEnd",value:function(){this.loaded=!0,this.app&&this.app.events.call("edk:app:resize")}},{key:"recordInteraction",value:function(e,t){this.app&&this.app.events.call("edk:scene:interaction:record",e,t)}},{key:"runInteraction",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.sceneID;this.app.events.call("edk:scene:interaction:run",t,e)}},{key:"onInteraction",value:function(e){this.app&&this.app.events.on("edk:scene:interaction:timeline:stop",e)}},{key:"onAnnotationClick",value:function(e){}},{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}}]),t}(),a=c(n.prototype,"loaded",[l.observable],{enumerable:!0,initializer:function(){return!1}}),s=c(n.prototype,"progress",[l.observable],{enumerable:!0,initializer:function(){return 0}}),c(n.prototype,"onResourceProgress",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"onResourceProgress"),n.prototype),c(n.prototype,"onLoadResourceEnd",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"onLoadResourceEnd"),n.prototype),r=c(n.prototype,"stopInteraction",[l.action],{enumerable:!0,initializer:function(){var e=this;return function(){e.app&&e.app.events.call("edk:scene:interaction:clear",e.sceneID)}}}),c(n.prototype,"recordInteraction",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"recordInteraction"),n.prototype),c(n.prototype,"runInteraction",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"runInteraction"),n.prototype),c(n.prototype,"onInteraction",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"onInteraction"),n.prototype),c(n.prototype,"onAnnotationClick",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"onAnnotationClick"),n.prototype),c(n.prototype,"update",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),n);t.default=u;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(u,"Base","D:/shun/gs3power/src/stores/base.js")},Cm0m:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();var h={},a={},s=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t)}return n(t,[{key:"attach",value:function(e){var t=this;return e.on=t.on,e.fire=t.fire,e.remove=t.remove,e.method=t.method,e.callcall=t.call,e._listener={},e._hooks={},e}},{key:"on",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this,n=this._listener||h;return"string"==typeof e&&"function"==typeof t&&(void 0===n[e]?n[e]=[{scope:i,callback:t}]:0===n[e].filter(function(e){return e.scope===i&&e.callback===t}).length&&n[e].push({scope:i,callback:t})),this}},{key:"fire",value:function(e){var t=this._listener||h;if(e&&t[e]){var i=[];if(1<arguments.length)for(var n=1;n<arguments.length;n++)i.push(arguments[n]);for(var a=t[e].length,s=0;s<a;s+=1){var r=t[e][s];r.callback.apply(r.scope,i)}}return this}},{key:"remove",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this,n=this._listener||h,a=n[e];if(a instanceof Array)if("function"==typeof t){for(var s=0,r=a.length;s<r;s+=1)if(a[s].callback===t&&a[s].scope===this){a.splice(s,1);break}}else if(t instanceof Array)for(var o=0,l=t.length;o<l;o+=1)this.remove(e,t[l],i);else delete n[e];return this}},{key:"method",value:function(e,t){var i=this._hooks||a;if(void 0!==i[e])throw new Error("can't override hook: "+e);i[e]=t}},{key:"methodRemove",value:function(e){delete(this._hooks||a)[e]}},{key:"call",value:function(e){var t=this._hooks||a;if(t[e]){var i=Array.prototype.slice.call(arguments,1);try{return t[e].apply(null,i)}catch(e){}}return null}}]),t}();t.default=s;"undefined"!=typeof __REACT_HOT_LOADER__&&(__REACT_HOT_LOADER__.register(h,"_listener","D:/shun/gs3power/src/core/events.js"),__REACT_HOT_LOADER__.register(a,"_hooks","D:/shun/gs3power/src/core/events.js"),__REACT_HOT_LOADER__.register(s,"Events","D:/shun/gs3power/src/core/events.js"))},HMSZ:function(e,t,i){e.exports=function(t){i.e(4).then(function(e){t(i("8E7f"))}.bind(null,i)).catch(i.oe)}},IfyZ:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r,o,l=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),h=i("2vnA");function c(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function u(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var d=(n=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,"loading",a,this),c(this,"shopping",s,this),c(this,"sidebar",r,this),c(this,"eqgo",o,this),this.store=$$.events.call("store")}return l(t,[{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}}]),t}(),a=u(n.prototype,"loading",[h.observable],{enumerable:!0,initializer:function(){return[{titleImg:$$.asset("images/loading/loading_text1.png"),bgImg:"url("+$$.asset("images/loading/loading_image1.png")+")"},{titleImg:$$.asset("images/loading/loading_text2.png"),bgImg:"url("+$$.asset("images/loading/loading_image2.png")+")"},{titleImg:$$.asset("images/loading/loading_text3.png"),bgImg:"url("+$$.asset("images/loading/loading_image3.png")+")"},{titleImg:$$.asset("images/loading/loading_text4.png"),bgImg:"url("+$$.asset("images/loading/loading_image4.png")+")"}]}}),s=u(n.prototype,"shopping",[h.observable],{enumerable:!0,initializer:function(){return!1}}),r=u(n.prototype,"sidebar",[h.observable],{enumerable:!0,initializer:function(){var e=this;return[{title:"首页",icon:"iconbar_home",click:function(){e.store.wechat&&e.store.wechat.miniprogram?e.store.wechat.switchTab($$.url("mini_home")).then(function(){}).catch(function(e){}):window.open("https://www.gacmotor.com/")}},{title:"购买",icon:"iconbar_purchase",click:function(){e.shopping=!0,e.store.menu.eqgo.purchase&&(e.store.menu.eqgo.purchase=!1,e.store.menu.eqgoShow=!0)}},{title:"APP下载",icon:"iconapperweima",click:function(){$$.utils.platform().mobile?window.open($$.config.appDownloadUrl):e.store.menu.qrcodeShow=!0}}]}}),o=u(n.prototype,"eqgo",[h.observable],{enumerable:!0,initializer:function(){return{text1:"e祺购",text2:"成为传祺合伙人，躺赚收益",text3:"扫描识别二维码，更多赚钱新功能等你来发现",text4:"长按识别二维码，更多赚钱新功能等你来发现",boxSrc:"url("+$$.asset("images/sidebar/eqgo.jpg")+")",qrcode:$$.asset("images/sidebar/qrcode.jpg")}}}),u(n.prototype,"update",[h.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),n);t.default=d;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(d,"staticData","D:/shun/gs3power/src/stores/staticData.js")},IgRy:function(e){e.exports={11e10:[{province:"北京市",name:"市辖区",id:"110100000000"}],12e10:[{province:"天津市",name:"市辖区",id:"120100000000"}],13e10:[{province:"河北省",name:"石家庄市",id:"130100000000"},{province:"河北省",name:"唐山市",id:"130200000000"},{province:"河北省",name:"秦皇岛市",id:"130300000000"},{province:"河北省",name:"邯郸市",id:"130400000000"},{province:"河北省",name:"邢台市",id:"130500000000"},{province:"河北省",name:"保定市",id:"130600000000"},{province:"河北省",name:"张家口市",id:"130700000000"},{province:"河北省",name:"承德市",id:"130800000000"},{province:"河北省",name:"沧州市",id:"130900000000"},{province:"河北省",name:"廊坊市",id:"131000000000"},{province:"河北省",name:"衡水市",id:"131100000000"}],14e10:[{province:"山西省",name:"太原市",id:"140100000000"},{province:"山西省",name:"大同市",id:"140200000000"},{province:"山西省",name:"阳泉市",id:"140300000000"},{province:"山西省",name:"长治市",id:"140400000000"},{province:"山西省",name:"晋城市",id:"140500000000"},{province:"山西省",name:"朔州市",id:"140600000000"},{province:"山西省",name:"晋中市",id:"140700000000"},{province:"山西省",name:"运城市",id:"140800000000"},{province:"山西省",name:"忻州市",id:"140900000000"},{province:"山西省",name:"临汾市",id:"141000000000"},{province:"山西省",name:"吕梁市",id:"141100000000"}],15e10:[{province:"内蒙古自治区",name:"呼和浩特市",id:"150100000000"},{province:"内蒙古自治区",name:"包头市",id:"150200000000"},{province:"内蒙古自治区",name:"乌海市",id:"150300000000"},{province:"内蒙古自治区",name:"赤峰市",id:"150400000000"},{province:"内蒙古自治区",name:"通辽市",id:"150500000000"},{province:"内蒙古自治区",name:"鄂尔多斯市",id:"150600000000"},{province:"内蒙古自治区",name:"呼伦贝尔市",id:"150700000000"},{province:"内蒙古自治区",name:"巴彦淖尔市",id:"150800000000"},{province:"内蒙古自治区",name:"乌兰察布市",id:"150900000000"},{province:"内蒙古自治区",name:"兴安盟",id:"152200000000"},{province:"内蒙古自治区",name:"锡林郭勒盟",id:"152500000000"},{province:"内蒙古自治区",name:"阿拉善盟",id:"152900000000"}],21e10:[{province:"辽宁省",name:"沈阳市",id:"210100000000"},{province:"辽宁省",name:"大连市",id:"210200000000"},{province:"辽宁省",name:"鞍山市",id:"210300000000"},{province:"辽宁省",name:"抚顺市",id:"210400000000"},{province:"辽宁省",name:"本溪市",id:"210500000000"},{province:"辽宁省",name:"丹东市",id:"210600000000"},{province:"辽宁省",name:"锦州市",id:"210700000000"},{province:"辽宁省",name:"营口市",id:"210800000000"},{province:"辽宁省",name:"阜新市",id:"210900000000"},{province:"辽宁省",name:"辽阳市",id:"211000000000"},{province:"辽宁省",name:"盘锦市",id:"211100000000"},{province:"辽宁省",name:"铁岭市",id:"211200000000"},{province:"辽宁省",name:"朝阳市",id:"211300000000"},{province:"辽宁省",name:"葫芦岛市",id:"211400000000"}],22e10:[{province:"吉林省",name:"长春市",id:"220100000000"},{province:"吉林省",name:"吉林市",id:"220200000000"},{province:"吉林省",name:"四平市",id:"220300000000"},{province:"吉林省",name:"辽源市",id:"220400000000"},{province:"吉林省",name:"通化市",id:"220500000000"},{province:"吉林省",name:"白山市",id:"220600000000"},{province:"吉林省",name:"松原市",id:"220700000000"},{province:"吉林省",name:"白城市",id:"220800000000"},{province:"吉林省",name:"延边朝鲜族自治州",id:"222400000000"}],23e10:[{province:"黑龙江省",name:"哈尔滨市",id:"230100000000"},{province:"黑龙江省",name:"齐齐哈尔市",id:"230200000000"},{province:"黑龙江省",name:"鸡西市",id:"230300000000"},{province:"黑龙江省",name:"鹤岗市",id:"230400000000"},{province:"黑龙江省",name:"双鸭山市",id:"230500000000"},{province:"黑龙江省",name:"大庆市",id:"230600000000"},{province:"黑龙江省",name:"伊春市",id:"230700000000"},{province:"黑龙江省",name:"佳木斯市",id:"230800000000"},{province:"黑龙江省",name:"七台河市",id:"230900000000"},{province:"黑龙江省",name:"牡丹江市",id:"231000000000"},{province:"黑龙江省",name:"黑河市",id:"231100000000"},{province:"黑龙江省",name:"绥化市",id:"231200000000"},{province:"黑龙江省",name:"大兴安岭地区",id:"232700000000"}],31e10:[{province:"上海市",name:"市辖区",id:"310100000000"}],32e10:[{province:"江苏省",name:"南京市",id:"320100000000"},{province:"江苏省",name:"无锡市",id:"320200000000"},{province:"江苏省",name:"徐州市",id:"320300000000"},{province:"江苏省",name:"常州市",id:"320400000000"},{province:"江苏省",name:"苏州市",id:"320500000000"},{province:"江苏省",name:"南通市",id:"320600000000"},{province:"江苏省",name:"连云港市",id:"320700000000"},{province:"江苏省",name:"淮安市",id:"320800000000"},{province:"江苏省",name:"盐城市",id:"320900000000"},{province:"江苏省",name:"扬州市",id:"321000000000"},{province:"江苏省",name:"镇江市",id:"321100000000"},{province:"江苏省",name:"泰州市",id:"321200000000"},{province:"江苏省",name:"宿迁市",id:"321300000000"}],33e10:[{province:"浙江省",name:"杭州市",id:"330100000000"},{province:"浙江省",name:"宁波市",id:"330200000000"},{province:"浙江省",name:"温州市",id:"330300000000"},{province:"浙江省",name:"嘉兴市",id:"330400000000"},{province:"浙江省",name:"湖州市",id:"330500000000"},{province:"浙江省",name:"绍兴市",id:"330600000000"},{province:"浙江省",name:"金华市",id:"330700000000"},{province:"浙江省",name:"衢州市",id:"330800000000"},{province:"浙江省",name:"舟山市",id:"330900000000"},{province:"浙江省",name:"台州市",id:"331000000000"},{province:"浙江省",name:"丽水市",id:"331100000000"}],34e10:[{province:"安徽省",name:"合肥市",id:"340100000000"},{province:"安徽省",name:"芜湖市",id:"340200000000"},{province:"安徽省",name:"蚌埠市",id:"340300000000"},{province:"安徽省",name:"淮南市",id:"340400000000"},{province:"安徽省",name:"马鞍山市",id:"340500000000"},{province:"安徽省",name:"淮北市",id:"340600000000"},{province:"安徽省",name:"铜陵市",id:"340700000000"},{province:"安徽省",name:"安庆市",id:"340800000000"},{province:"安徽省",name:"黄山市",id:"341000000000"},{province:"安徽省",name:"滁州市",id:"341100000000"},{province:"安徽省",name:"阜阳市",id:"341200000000"},{province:"安徽省",name:"宿州市",id:"341300000000"},{province:"安徽省",name:"六安市",id:"341500000000"},{province:"安徽省",name:"亳州市",id:"341600000000"},{province:"安徽省",name:"池州市",id:"341700000000"},{province:"安徽省",name:"宣城市",id:"341800000000"}],35e10:[{province:"福建省",name:"福州市",id:"350100000000"},{province:"福建省",name:"厦门市",id:"350200000000"},{province:"福建省",name:"莆田市",id:"350300000000"},{province:"福建省",name:"三明市",id:"350400000000"},{province:"福建省",name:"泉州市",id:"350500000000"},{province:"福建省",name:"漳州市",id:"350600000000"},{province:"福建省",name:"南平市",id:"350700000000"},{province:"福建省",name:"龙岩市",id:"350800000000"},{province:"福建省",name:"宁德市",id:"350900000000"}],36e10:[{province:"江西省",name:"南昌市",id:"360100000000"},{province:"江西省",name:"景德镇市",id:"360200000000"},{province:"江西省",name:"萍乡市",id:"360300000000"},{province:"江西省",name:"九江市",id:"360400000000"},{province:"江西省",name:"新余市",id:"360500000000"},{province:"江西省",name:"鹰潭市",id:"360600000000"},{province:"江西省",name:"赣州市",id:"360700000000"},{province:"江西省",name:"吉安市",id:"360800000000"},{province:"江西省",name:"宜春市",id:"360900000000"},{province:"江西省",name:"抚州市",id:"361000000000"},{province:"江西省",name:"上饶市",id:"361100000000"}],37e10:[{province:"山东省",name:"济南市",id:"370100000000"},{province:"山东省",name:"青岛市",id:"370200000000"},{province:"山东省",name:"淄博市",id:"370300000000"},{province:"山东省",name:"枣庄市",id:"370400000000"},{province:"山东省",name:"东营市",id:"370500000000"},{province:"山东省",name:"烟台市",id:"370600000000"},{province:"山东省",name:"潍坊市",id:"370700000000"},{province:"山东省",name:"济宁市",id:"370800000000"},{province:"山东省",name:"泰安市",id:"370900000000"},{province:"山东省",name:"威海市",id:"371000000000"},{province:"山东省",name:"日照市",id:"371100000000"},{province:"山东省",name:"莱芜市",id:"371200000000"},{province:"山东省",name:"临沂市",id:"371300000000"},{province:"山东省",name:"德州市",id:"371400000000"},{province:"山东省",name:"聊城市",id:"371500000000"},{province:"山东省",name:"滨州市",id:"371600000000"},{province:"山东省",name:"菏泽市",id:"371700000000"}],41e10:[{province:"河南省",name:"郑州市",id:"410100000000"},{province:"河南省",name:"开封市",id:"410200000000"},{province:"河南省",name:"洛阳市",id:"410300000000"},{province:"河南省",name:"平顶山市",id:"410400000000"},{province:"河南省",name:"安阳市",id:"410500000000"},{province:"河南省",name:"鹤壁市",id:"410600000000"},{province:"河南省",name:"新乡市",id:"410700000000"},{province:"河南省",name:"焦作市",id:"410800000000"},{province:"河南省",name:"濮阳市",id:"410900000000"},{province:"河南省",name:"许昌市",id:"411000000000"},{province:"河南省",name:"漯河市",id:"411100000000"},{province:"河南省",name:"三门峡市",id:"411200000000"},{province:"河南省",name:"南阳市",id:"411300000000"},{province:"河南省",name:"商丘市",id:"411400000000"},{province:"河南省",name:"信阳市",id:"411500000000"},{province:"河南省",name:"周口市",id:"411600000000"},{province:"河南省",name:"驻马店市",id:"411700000000"},{province:"河南省",name:"省直辖县级行政区划",id:"419000000000"}],42e10:[{province:"湖北省",name:"武汉市",id:"420100000000"},{province:"湖北省",name:"黄石市",id:"420200000000"},{province:"湖北省",name:"十堰市",id:"420300000000"},{province:"湖北省",name:"宜昌市",id:"420500000000"},{province:"湖北省",name:"襄阳市",id:"420600000000"},{province:"湖北省",name:"鄂州市",id:"420700000000"},{province:"湖北省",name:"荆门市",id:"420800000000"},{province:"湖北省",name:"孝感市",id:"420900000000"},{province:"湖北省",name:"荆州市",id:"421000000000"},{province:"湖北省",name:"黄冈市",id:"421100000000"},{province:"湖北省",name:"咸宁市",id:"421200000000"},{province:"湖北省",name:"随州市",id:"421300000000"},{province:"湖北省",name:"恩施土家族苗族自治州",id:"422800000000"},{province:"湖北省",name:"省直辖县级行政区划",id:"429000000000"}],43e10:[{province:"湖南省",name:"长沙市",id:"430100000000"},{province:"湖南省",name:"株洲市",id:"430200000000"},{province:"湖南省",name:"湘潭市",id:"430300000000"},{province:"湖南省",name:"衡阳市",id:"430400000000"},{province:"湖南省",name:"邵阳市",id:"430500000000"},{province:"湖南省",name:"岳阳市",id:"430600000000"},{province:"湖南省",name:"常德市",id:"430700000000"},{province:"湖南省",name:"张家界市",id:"430800000000"},{province:"湖南省",name:"益阳市",id:"430900000000"},{province:"湖南省",name:"郴州市",id:"431000000000"},{province:"湖南省",name:"永州市",id:"431100000000"},{province:"湖南省",name:"怀化市",id:"431200000000"},{province:"湖南省",name:"娄底市",id:"431300000000"},{province:"湖南省",name:"湘西土家族苗族自治州",id:"433100000000"}],44e10:[{province:"广东省",name:"广州市",id:"440100000000"},{province:"广东省",name:"韶关市",id:"440200000000"},{province:"广东省",name:"深圳市",id:"440300000000"},{province:"广东省",name:"珠海市",id:"440400000000"},{province:"广东省",name:"汕头市",id:"440500000000"},{province:"广东省",name:"佛山市",id:"440600000000"},{province:"广东省",name:"江门市",id:"440700000000"},{province:"广东省",name:"湛江市",id:"440800000000"},{province:"广东省",name:"茂名市",id:"440900000000"},{province:"广东省",name:"肇庆市",id:"441200000000"},{province:"广东省",name:"惠州市",id:"441300000000"},{province:"广东省",name:"梅州市",id:"441400000000"},{province:"广东省",name:"汕尾市",id:"441500000000"},{province:"广东省",name:"河源市",id:"441600000000"},{province:"广东省",name:"阳江市",id:"441700000000"},{province:"广东省",name:"清远市",id:"441800000000"},{province:"广东省",name:"东莞市",id:"441900000000"},{province:"广东省",name:"中山市",id:"442000000000"},{province:"广东省",name:"潮州市",id:"445100000000"},{province:"广东省",name:"揭阳市",id:"445200000000"},{province:"广东省",name:"云浮市",id:"445300000000"}],45e10:[{province:"广西壮族自治区",name:"南宁市",id:"450100000000"},{province:"广西壮族自治区",name:"柳州市",id:"450200000000"},{province:"广西壮族自治区",name:"桂林市",id:"450300000000"},{province:"广西壮族自治区",name:"梧州市",id:"450400000000"},{province:"广西壮族自治区",name:"北海市",id:"450500000000"},{province:"广西壮族自治区",name:"防城港市",id:"450600000000"},{province:"广西壮族自治区",name:"钦州市",id:"450700000000"},{province:"广西壮族自治区",name:"贵港市",id:"450800000000"},{province:"广西壮族自治区",name:"玉林市",id:"450900000000"},{province:"广西壮族自治区",name:"百色市",id:"451000000000"},{province:"广西壮族自治区",name:"贺州市",id:"451100000000"},{province:"广西壮族自治区",name:"河池市",id:"451200000000"},{province:"广西壮族自治区",name:"来宾市",id:"451300000000"},{province:"广西壮族自治区",name:"崇左市",id:"451400000000"}],46e10:[{province:"海南省",name:"海口市",id:"460100000000"},{province:"海南省",name:"三亚市",id:"460200000000"},{province:"海南省",name:"三沙市",id:"460300000000"},{province:"海南省",name:"儋州市",id:"460400000000"},{province:"海南省",name:"省直辖县级行政区划",id:"469000000000"}],5e11:[{province:"重庆市",name:"市辖区",id:"500100000000"},{province:"重庆市",name:"县",id:"500200000000"}],51e10:[{province:"四川省",name:"成都市",id:"510100000000"},{province:"四川省",name:"自贡市",id:"510300000000"},{province:"四川省",name:"攀枝花市",id:"510400000000"},{province:"四川省",name:"泸州市",id:"510500000000"},{province:"四川省",name:"德阳市",id:"510600000000"},{province:"四川省",name:"绵阳市",id:"510700000000"},{province:"四川省",name:"广元市",id:"510800000000"},{province:"四川省",name:"遂宁市",id:"510900000000"},{province:"四川省",name:"内江市",id:"511000000000"},{province:"四川省",name:"乐山市",id:"511100000000"},{province:"四川省",name:"南充市",id:"511300000000"},{province:"四川省",name:"眉山市",id:"511400000000"},{province:"四川省",name:"宜宾市",id:"511500000000"},{province:"四川省",name:"广安市",id:"511600000000"},{province:"四川省",name:"达州市",id:"511700000000"},{province:"四川省",name:"雅安市",id:"511800000000"},{province:"四川省",name:"巴中市",id:"511900000000"},{province:"四川省",name:"资阳市",id:"512000000000"},{province:"四川省",name:"阿坝藏族羌族自治州",id:"513200000000"},{province:"四川省",name:"甘孜藏族自治州",id:"513300000000"},{province:"四川省",name:"凉山彝族自治州",id:"513400000000"}],52e10:[{province:"贵州省",name:"贵阳市",id:"520100000000"},{province:"贵州省",name:"六盘水市",id:"520200000000"},{province:"贵州省",name:"遵义市",id:"520300000000"},{province:"贵州省",name:"安顺市",id:"520400000000"},{province:"贵州省",name:"毕节市",id:"520500000000"},{province:"贵州省",name:"铜仁市",id:"520600000000"},{province:"贵州省",name:"黔西南布依族苗族自治州",id:"522300000000"},{province:"贵州省",name:"黔东南苗族侗族自治州",id:"522600000000"},{province:"贵州省",name:"黔南布依族苗族自治州",id:"522700000000"}],53e10:[{province:"云南省",name:"昆明市",id:"530100000000"},{province:"云南省",name:"曲靖市",id:"530300000000"},{province:"云南省",name:"玉溪市",id:"530400000000"},{province:"云南省",name:"保山市",id:"530500000000"},{province:"云南省",name:"昭通市",id:"530600000000"},{province:"云南省",name:"丽江市",id:"530700000000"},{province:"云南省",name:"普洱市",id:"530800000000"},{province:"云南省",name:"临沧市",id:"530900000000"},{province:"云南省",name:"楚雄彝族自治州",id:"532300000000"},{province:"云南省",name:"红河哈尼族彝族自治州",id:"532500000000"},{province:"云南省",name:"文山壮族苗族自治州",id:"532600000000"},{province:"云南省",name:"西双版纳傣族自治州",id:"532800000000"},{province:"云南省",name:"大理白族自治州",id:"532900000000"},{province:"云南省",name:"德宏傣族景颇族自治州",id:"533100000000"},{province:"云南省",name:"怒江傈僳族自治州",id:"533300000000"},{province:"云南省",name:"迪庆藏族自治州",id:"533400000000"}],54e10:[{province:"西藏自治区",name:"拉萨市",id:"540100000000"},{province:"西藏自治区",name:"日喀则市",id:"540200000000"},{province:"西藏自治区",name:"昌都市",id:"540300000000"},{province:"西藏自治区",name:"林芝市",id:"540400000000"},{province:"西藏自治区",name:"山南市",id:"540500000000"},{province:"西藏自治区",name:"那曲市",id:"540600000000"},{province:"西藏自治区",name:"阿里地区",id:"542500000000"}],61e10:[{province:"陕西省",name:"西安市",id:"610100000000"},{province:"陕西省",name:"铜川市",id:"610200000000"},{province:"陕西省",name:"宝鸡市",id:"610300000000"},{province:"陕西省",name:"咸阳市",id:"610400000000"},{province:"陕西省",name:"渭南市",id:"610500000000"},{province:"陕西省",name:"延安市",id:"610600000000"},{province:"陕西省",name:"汉中市",id:"610700000000"},{province:"陕西省",name:"榆林市",id:"610800000000"},{province:"陕西省",name:"安康市",id:"610900000000"},{province:"陕西省",name:"商洛市",id:"611000000000"}],62e10:[{province:"甘肃省",name:"兰州市",id:"620100000000"},{province:"甘肃省",name:"嘉峪关市",id:"620200000000"},{province:"甘肃省",name:"金昌市",id:"620300000000"},{province:"甘肃省",name:"白银市",id:"620400000000"},{province:"甘肃省",name:"天水市",id:"620500000000"},{province:"甘肃省",name:"武威市",id:"620600000000"},{province:"甘肃省",name:"张掖市",id:"620700000000"},{province:"甘肃省",name:"平凉市",id:"620800000000"},{province:"甘肃省",name:"酒泉市",id:"620900000000"},{province:"甘肃省",name:"庆阳市",id:"621000000000"},{province:"甘肃省",name:"定西市",id:"621100000000"},{province:"甘肃省",name:"陇南市",id:"621200000000"},{province:"甘肃省",name:"临夏回族自治州",id:"622900000000"},{province:"甘肃省",name:"甘南藏族自治州",id:"623000000000"}],63e10:[{province:"青海省",name:"西宁市",id:"630100000000"},{province:"青海省",name:"海东市",id:"630200000000"},{province:"青海省",name:"海北藏族自治州",id:"632200000000"},{province:"青海省",name:"黄南藏族自治州",id:"632300000000"},{province:"青海省",name:"海南藏族自治州",id:"632500000000"},{province:"青海省",name:"果洛藏族自治州",id:"632600000000"},{province:"青海省",name:"玉树藏族自治州",id:"632700000000"},{province:"青海省",name:"海西蒙古族藏族自治州",id:"632800000000"}],64e10:[{province:"宁夏回族自治区",name:"银川市",id:"640100000000"},{province:"宁夏回族自治区",name:"石嘴山市",id:"640200000000"},{province:"宁夏回族自治区",name:"吴忠市",id:"640300000000"},{province:"宁夏回族自治区",name:"固原市",id:"640400000000"},{province:"宁夏回族自治区",name:"中卫市",id:"640500000000"}],65e10:[{province:"新疆维吾尔自治区",name:"乌鲁木齐市",id:"650100000000"},{province:"新疆维吾尔自治区",name:"克拉玛依市",id:"650200000000"},{province:"新疆维吾尔自治区",name:"吐鲁番市",id:"650400000000"},{province:"新疆维吾尔自治区",name:"哈密市",id:"650500000000"},{province:"新疆维吾尔自治区",name:"昌吉回族自治州",id:"652300000000"},{province:"新疆维吾尔自治区",name:"博尔塔拉蒙古自治州",id:"652700000000"},{province:"新疆维吾尔自治区",name:"巴音郭楞蒙古自治州",id:"652800000000"},{province:"新疆维吾尔自治区",name:"阿克苏地区",id:"652900000000"},{province:"新疆维吾尔自治区",name:"克孜勒苏柯尔克孜自治州",id:"653000000000"},{province:"新疆维吾尔自治区",name:"喀什地区",id:"653100000000"},{province:"新疆维吾尔自治区",name:"和田地区",id:"653200000000"},{province:"新疆维吾尔自治区",name:"伊犁哈萨克自治州",id:"654000000000"},{province:"新疆维吾尔自治区",name:"塔城地区",id:"654200000000"},{province:"新疆维吾尔自治区",name:"阿勒泰地区",id:"654300000000"},{province:"新疆维吾尔自治区",name:"自治区直辖县级行政区划",id:"659000000000"}]}},JNVv:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={Home:{Logo:"images/home/logo.png",Shadow:"images/home/shadow.png",Product:{Background1:"images/home/product/bg1.jpg",Background2:"images/home/product/bg2.jpg",Background2Mobile:"images/home/product/bg2-mobile.jpg",Car1:"images/home/product/d60.png",Car2:"images/home/product/t60.png",Car3:"images/home/product/qcx.png",Car4:"images/home/product/t90.png"}},Scene:{Indoor:{Selected:"images/d60/scene/indoor_selected.png",Normal:"images/d60/scene/indoor_normal.png"},Daytime:{Selected:"images/d60/scene/daytime_selected.png",Normal:"images/d60/scene/daytime_normal.png"},Night:{Selected:"images/d60/scene/night_selected.png",Normal:"images/d60/scene/night_normal.png"},Studio:{Selected:"images/d60/scene/studio_selected.png",Normal:"images/d60/scene/studio_normal.png"}},Atlas:{Pic1:"images/d60/atlas/1.jpg",Pic2:"images/d60/atlas/2.jpg",Pic3:"images/d60/atlas/3.jpg",Pic4:"images/d60/atlas/4.jpg",Pic5:"images/d60/atlas/5.jpg",Pic6:"images/d60/atlas/6.jpg",Pic7:"images/d60/atlas/7.jpg",Pic8:"images/d60/atlas/8.jpg",Pic9:"images/d60/atlas/9.jpg",Pic10:"images/d60/atlas/10.jpg",Pic11:"images/d60/atlas/11.jpg",Pic12:"images/d60/atlas/12.jpg",Pic13:"images/d60/atlas/13.jpg",Pic14:"images/d60/atlas/14.jpg"},Loading:{Logo1:"images/d60/loading/loading-logo-1.png",Logo2:"images/d60/loading/loading-logo-2.png",Background:"images/d60/loading/bg.jpg",Img1:"images/d60/loading/img/img-1.png",Img2:"images/d60/loading/img/img-2.png",Img3:"images/d60/loading/img/img-3.png",Img4:"images/d60/loading/img/img-4.png"},Appearance:{Roof:{Roof_1:"images/d60/appearance/roof_1.png",Roof_2:"images/d60/appearance/roof_2.png",Roof_3:"images/d60/appearance/roof_3.png"}},InteriorTrim:{Color:{Black:"images/d60/interior-trim/color/black.jpg",BlackGray:"images/d60/interior-trim/color/black-gray.jpg",BlackBrown:"images/d60/interior-trim/color/black-brown.jpg"},Position:{MainDriving:"images/d60/interior-trim/position/main-driving.jpg",DeputyDriving:"images/d60/interior-trim/position/deputy-driving.jpg",RearRow:"images/d60/interior-trim/position/rear-row.jpg"}}};t.default=n;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(n,"default","D:/shun/gs3power/src/core/config/image.js")},JPoV:function(e,t,i){"use strict";var n,a,s,dx="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};s=function(){var m=void 0!==("undefined"==typeof self?"undefined":dx(self))?self:this;function l(e,t,i,n,a,s,r){try{var o=e[s](r),l=o.value}catch(e){return void i(e)}o.done?t(l):Promise.resolve(l).then(n,a)}function o(o){return function(){var e=this,r=arguments;return new Promise(function(t,i){var n=o.apply(e,r);function a(e){l(n,t,i,a,s,"next",e)}function s(e){l(n,t,i,a,s,"throw",e)}a(void 0)})}}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function h(){return(h=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e}).apply(this,arguments)}function u(e,t){e.prototype=Object.create(t.prototype),s(e.prototype.constructor=e,t)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function z(e,t,i){return(z=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,i){var n=[null];n.push.apply(n,t);var a=new(Function.bind.apply(e,n));return i&&s(a,i.prototype),a}).apply(null,arguments)}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function _(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){if(e){if("string"==typeof e)return a(e,void 0);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?a(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}!function(){var f={};var i=function e(t){var i=t.gl;this.ext=t,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(t.maxVertexAttribs);for(var n=0;n<this.attribs.length;n++){var a=new e.VertexAttrib(i);this.attribs[n]=a}this.maxAttrib=0};(i.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var a=function(n){var t,i,l=this;this.gl=n,i=(t=n).getError,t.getError=function(){for(;(e=i.apply(t))!=t.NO_ERROR&&(f[e]=!0),e!=t.NO_ERROR;);for(var e in f)if(f[e])return delete f[e],parseInt(e);return t.NO_ERROR};var h=this.original={getParameter:n.getParameter,enableVertexAttribArray:n.enableVertexAttribArray,disableVertexAttribArray:n.disableVertexAttribArray,bindBuffer:n.bindBuffer,getVertexAttrib:n.getVertexAttrib,vertexAttribPointer:n.vertexAttribPointer};n.getParameter=function(e){return e==l.VERTEX_ARRAY_BINDING_OES?l.currentVertexArrayObject==l.defaultVertexArrayObject?null:l.currentVertexArrayObject:h.getParameter.apply(this,arguments)},n.enableVertexAttribArray=function(e){var t=l.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!0,h.enableVertexAttribArray.apply(this,arguments)},n.disableVertexAttribArray=function(e){var t=l.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!1,h.disableVertexAttribArray.apply(this,arguments)},n.bindBuffer=function(e,t){switch(e){case n.ARRAY_BUFFER:l.currentArrayBuffer=t;break;case n.ELEMENT_ARRAY_BUFFER:l.currentVertexArrayObject.elementArrayBuffer=t}return h.bindBuffer.apply(this,arguments)},n.getVertexAttrib=function(e,t){var i=l.currentVertexArrayObject.attribs[e];switch(t){case n.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return i.buffer;case n.VERTEX_ATTRIB_ARRAY_ENABLED:return i.enabled;case n.VERTEX_ATTRIB_ARRAY_SIZE:return i.size;case n.VERTEX_ATTRIB_ARRAY_STRIDE:return i.stride;case n.VERTEX_ATTRIB_ARRAY_TYPE:return i.type;case n.VERTEX_ATTRIB_ARRAY_NORMALIZED:return i.normalized;default:return h.getVertexAttrib.apply(this,arguments)}},n.vertexAttribPointer=function(e,t,i,n,a,s){var r=l.currentVertexArrayObject;r.maxAttrib=Math.max(r.maxAttrib,e);var o=r.attribs[e];return o.buffer=l.currentArrayBuffer,o.size=t,o.type=i,o.normalized=n,o.stride=a,o.offset=s,o.recache(),h.vertexAttribPointer.apply(this,arguments)},n.instrumentExtension&&n.instrumentExtension(this,"OES_vertex_array_object"),n.canvas.addEventListener("webglcontextrestored",function(){window.console&&window.console.log&&window.console.log("OESVertexArrayObject emulation library context restored"),l.reset_()},!0),this.reset_()};a.prototype.VERTEX_ARRAY_BINDING_OES=34229,a.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var t=this.gl;this.maxVertexAttribs=t.getParameter(t.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new i(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},a.prototype.createVertexArrayOES=function(){var e=new i(this);return this.vertexArrayObjects.push(e),e},a.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},a.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof i&&e.hasBeenBound&&e.ext==this)},a.prototype.bindVertexArrayOES=function(e){var t,i,n,a=this.gl;if(!e||e.isAlive){var s=this.original,r=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var o=this.currentVertexArrayObject;if(r!=o){r&&o.elementArrayBuffer==r.elementArrayBuffer||s.bindBuffer.call(a,a.ELEMENT_ARRAY_BUFFER,o.elementArrayBuffer);for(var l=this.currentArrayBuffer,h=Math.max(r?r.maxAttrib:0,o.maxAttrib),c=0;c<=h;c++){var u=o.attribs[c],d=r?r.attribs[c]:null;if(r&&u.enabled==d.enabled||(u.enabled?s.enableVertexAttribArray.call(a,c):s.disableVertexAttribArray.call(a,c)),u.enabled){var p=!1;r&&u.buffer==d.buffer||(l!=u.buffer&&(s.bindBuffer.call(a,a.ARRAY_BUFFER,u.buffer),l=u.buffer),p=!0),(p||u.cached!=d.cached)&&s.vertexAttribPointer.call(a,c,u.size,u.type,u.normalized,u.stride,u.offset)}}this.currentArrayBuffer!=l&&s.bindBuffer.call(a,a.ARRAY_BUFFER,this.currentArrayBuffer)}}else t=a.INVALID_OPERATION,i="bindVertexArrayOES: attempt to bind deleted arrayObject",f[t]=!0,void 0!==i&&(n=i,window.console&&window.console.error&&window.console.error(n))},window.setupVertexArrayObject=function(t){if(t.getSupportedExtensions){if(-1!=t.getSupportedExtensions().indexOf("OES_vertex_array_object"))return}else if(t.getExtension&&t.getExtension("OES_vertex_array_object"))return;if(t.getSupportedExtensions){var i=t.getSupportedExtensions;t.getSupportedExtensions=function(){var e=i.call(this)||[];return e.push("OES_vertex_array_object"),e}}var n=t.getExtension;t.getExtension=function(e){return"OES_vertex_array_object"==e?(t.__OESVertexArrayObject||(t.__OESVertexArrayObject=new a(t)),t.__OESVertexArrayObject):n?n.call(this,e):null}}}();var i=function(){for(var e={},t=["Array","Object","Function","Date","RegExp","Float32Array"],i=0;i<t.length;i++)e["[object "+t[i]+"]"]=t[i].toLowerCase();return e}();function r(e){if(null===e)return"null";var t=void 0===e?"undefined":dx(e);return"undefined"===t||"number"===t||"string"===t||"boolean"===t?t:i[Object.prototype.toString.call(e)]}function v(e,t){for(var i in t){var n=t[i];"object"===r(n)?e[i]=v({},n):"array"===r(n)?e[i]=v([],n):e[i]=n}return e}function d(e){return void 0!==e}var p=function(){function e(){this.initEventHandler()}var t=e.prototype;return t.initEventHandler=function(){this._callbacks={},this._callbackActive={},this._hooks={}},t._addCallback=function(e,t,i,n){void 0===n&&(n=!1),e&&"string"==typeof e&&t&&(this._callbacks[e]||(this._callbacks[e]=[]),this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].push({callback:t,scope:i||this,once:n}))},t.on=function(e,t,i){return this._addCallback(e,t,i,!1),this},t.off=function(e,t,i){if(e)this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());else for(var n in this._callbackActive)this._callbacks[n]&&this._callbacks[n]===this._callbackActive[n]&&(this._callbackActive[n]=this._callbackActive[n].slice());if(e)if(t){var a=this._callbacks[e];if(!a)return this;for(var s=a.length,r=0;r<s;r++)a[r].callback===t&&(i&&a[r].scope!==i||(a[r--]=a[--s]));a.length=s}else this._callbacks[e]&&(this._callbacks[e]=[]);else this._callbacks={},this.methodRemove();return this},t.fire=function(e,t,i,n,a,s,r,o,l){if(!e||!this._callbacks[e])return this;var h;this._callbackActive[e]?(this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),h=this._callbacks[e].slice()):this._callbackActive[e]=this._callbacks[e];for(var c=0;(h||this._callbackActive[e])&&c<(h||this._callbackActive[e]).length;c++){var u=(h||this._callbackActive[e])[c];if(u.callback.call(u.scope,t,i,n,a,s,r,o,l),u.once){var d=this._callbacks[e],p=d?d.indexOf(u):-1;-1!==p&&(this._callbackActive[e]===d&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].splice(p,1))}}return h||(this._callbackActive[e]=null),this},t.once=function(e,t,i){return this._addCallback(e,t,i,!0),this},t.hasEvent=function(e){return this._callbacks[e]&&0!==this._callbacks[e].length||!1},t.hasMethod=function(e){return void 0!==this._hooks[e]},t.method=function(e,t,i){if(void 0!==this._hooks[e])throw new Error("can't override hook: "+e);return this._hooks[e]={callback:t,scope:i||this},this},t.call=function(e){if(this._hooks[e]){var t=Array.prototype.slice.call(arguments,1);try{return this._hooks[e].callback.apply(this._hooks[e].scope,t)}catch(t){}}return null},t.methodRemove=function(e){e?this._hooks[e]&&delete this._hooks[e]:this._hooks={}},e}(),f={attach:function(e){var t=f;return e._addCallback=t._addCallback,e.on=t.on,e.off=t.off,e.fire=t.fire,e.once=t.once,e.hasEvent=t.hasEvent,e._callbacks={},e._callbackActive={},e},_addCallback:p.prototype._addCallback,on:p.prototype.on,off:p.prototype.off,fire:p.prototype.fire,once:p.prototype.once,hasEvent:p.prototype.hasEvent},B=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},C={delimiter:"/",join:function(){for(var e=arguments.length,t=arguments[0],i=0;i<e-1;++i){var n=arguments[i],a=arguments[i+1];if(!d(n)||!d(a))throw new Error("undefined argument to pc.path.join");a[0]!==C.delimiter?n&&a&&n[n.length-1]!==C.delimiter&&a[0]!==C.delimiter?t+=C.delimiter+a:t+=a:t=a}return t},normalize:function(e){for(var t=e.startsWith(C.delimiter),i=e.endsWith(C.delimiter),n=e.split("/"),a="",s=[],r=0;r<n.length;r++)""!==n[r]&&"."!==n[r]&&(".."===n[r]&&0<s.length?s=s.slice(0,s.length-2):(0<r&&s.push(C.delimiter),s.push(n[r])));return a=s.join(""),t||a[0]!==C.delimiter||(a=a.slice(1)),i&&a[a.length-1]!==C.delimiter&&(a+=C.delimiter),a},split:function(e){var t=e.split(C.delimiter),i=t.slice(t.length-1)[0];return[t.slice(0,t.length-1).join(C.delimiter),i]},getBasename:function(e){return C.split(e)[1]},getDirectory:function(e){var t=e.split(C.delimiter);return t.slice(0,t.length-1).join(C.delimiter)},getExtension:function(e){var t=e.split("?")[0].split(".").pop();return t!==e?"."+t:""},isRelativePath:function(e){return"/"!==e.charAt(0)&&null===e.match(/:\/\//)},extractPath:function(e){var t="",i=e.split("/"),n=0;if(1<i.length)if(C.isRelativePath(e))if("."===i[0])for(n=0;n<i.length-1;++n)t+=0===n?i[n]:"/"+i[n];else if(".."===i[0])for(n=0;n<i.length-1;++n)t+=0===n?i[n]:"/"+i[n];else for(t=".",n=0;n<i.length-1;++n)t+="/"+i[n];else for(n=0;n<i.length-1;++n)t+=0===n?i[n]:"/"+i[n];return t}},e=!1,t=!1,y=!1,b=!1;if("undefined"!=typeof navigator){var x=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(x),/xbox/i.test(x),!!/(windows phone|iemobile|wpdesktop)/i.test(x)||(!!/android/i.test(x)||/ip([ao]d|hone)/i.test(x)&&(e=!0)),"undefined"!=typeof window&&(t="ontouchstart"in window||"maxTouchPoints"in navigator&&0<navigator.maxTouchPoints),navigator,y="undefined"!=typeof Worker;try{var M=Object.defineProperty({},"passive",{get:function(){return!(b=!0)}});window.addEventListener("testpassive",null,M),window.removeEventListener("testpassive",null,M)}catch(m){}}var S=e,w=t,P=y,T=b,A=55296,E=127462,R=127487,D=65024,I=65039;function k(e,t){void 0===t&&(t=0);var i=e.length;if(t<0||i<=t)return null;var n=e.charCodeAt(t);if(1<i&&A<=n&&n<=56319){var a=e.charCodeAt(t+1);if(56320<=a&&a<=57343)return{code:1024*(n-A)+a-56320+65536,long:!0}}return{code:n,long:!1}}function L(e,t,i){if(!e)return!1;var n=k(e);if(n){var a=n.code;return t<=a&&a<=i}return!1}function O(e,t){if(t===e.length-1)return 1;if(L(e[t],A,56319)){var i=e.substring(t,t+2),n=e.substring(t+2,t+4);return L(n,127995,127999)||L(i,E,R)&&L(n,E,R)?4:L(n,D,I)?3:2}return L(e[t+1],D,I)?2:1}var F,V,Me={ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(e){for(var t=1;t<arguments.length;t++)e=e.replace("{"+(t-1)+"}",arguments[t]);return e},toBool:function(e,t){if(void 0===t&&(t=!1),"true"===e)return!0;if(t){if("false"===e)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(e,t){var i=k(e,t);return i&&i.code},getCodePoints:function(e){if("string"!=typeof e)throw new TypeError("Not a string");for(var t,i=0,n=[];t=k(e,i);)n.push(t.code),i+=t.long?2:1;return n},getSymbols:function(e){if("string"!=typeof e)throw new TypeError("Not a string");for(var t,i=0,n=e.length,a=[],s=0;i<n;)if(L(t=e[i+(s+=O(e,i+s))],8400,8447)&&(t=e[i+s++]),L(t,D,I)&&(t=e[i+s++]),t&&8205===t.charCodeAt(0))t=e[i+s++];else{var r=e.substring(i,i+s);a.push(r),i+=s,s=0}return a},fromCodePoint:function(){for(var e,t,i,n=[],a=0;a<arguments.length;++a)t=(e=Number(arguments[a]))-65536,i=65535<e?[55296+(t>>10),t%1024+56320]:[e],n.push(String.fromCharCode.apply(null,i));return n.join("")}},U=function(){function e(){this._list=[],this._index={}}var t=e.prototype;return t.push=function(e,t){if(this._index[e])throw Error("Key already in index "+e);var i=this._list.push(t)-1;this._index[e]=i},t.has=function(e){return void 0!==this._index[e]},t.get=function(e){var t=this._index[e];return void 0!==t?this._list[t]:null},t.remove=function(e){var t=this._index[e];if(void 0!==t){for(e in this._list.splice(t,1),delete this._index[e],this._index){var i=this._index[e];t<i&&(this._index[e]=i-1)}return!0}return!1},t.list=function(){return this._list},t.clear=function(){for(var e in this._list.length=0,this._index)delete this._index[e]},e}(),N=function(){function e(e){this._sortBy=e.sortBy,this.items=[],this.length=0,this.loopIndex=-1,this._sortHandler=this._doSort.bind(this)}var t=e.prototype;return t._binarySearch=function(e){for(var t,i,n=0,a=this.items.length-1,s=e[this._sortBy];n<=a;)t=Math.floor((n+a)/2),(i=this.items[t][this._sortBy])<=s?n=t+1:s<i&&(a=t-1);return n},t._doSort=function(e,t){var i=this._sortBy;return e[i]-t[i]},t.insert=function(e){var t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++},t.append=function(e){this.items.push(e),this.length++},t.remove=function(e){var t=this.items.indexOf(e);t<0||(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)},t.sort=function(){var e=0<=this.loopIndex?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==e&&(this.loopIndex=this.items.indexOf(e))},e}(),G=function(i){function e(e){var t;return(t=i.call(this)||this)._index={},t._list=[],t._parent=e,t}u(e,i);var t=e.prototype;return t.add=function(){var e=!1,t=this._processArguments(arguments,!0);if(!t.length)return e;for(var i=0;i<t.length;i++)this._index[t[i]]||(e=!0,this._index[t[i]]=!0,this._list.push(t[i]),this.fire("add",t[i],this._parent));return e&&this.fire("change",this._parent),e},t.remove=function(){var e=!1;if(!this._list.length)return e;var t=this._processArguments(arguments,!0);if(!t.length)return e;for(var i=0;i<t.length;i++)this._index[t[i]]&&(e=!0,delete this._index[t[i]],this._list.splice(this._list.indexOf(t[i]),1),this.fire("remove",t[i],this._parent));return e&&this.fire("change",this._parent),e},t.clear=function(){if(this._list.length){var e=this._list.slice(0);this._list=[],this._index={};for(var t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}},t.has=function(){return!!this._list.length&&this._has(this._processArguments(arguments))},t._has=function(e){if(!this._list.length||!e.length)return!1;for(var t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return!0}else{for(var i=!0,n=0;n<e[t].length;n++)if(!this._index[e[t][n]]){i=!1;break}if(i)return!0}return!1},t.list=function(){return this._list.slice(0)},t._processArguments=function(e,t){var i=[],n=[];if(!e||!e.length)return i;for(var a=0;a<e.length;a++)if(e[a]instanceof Array){t||(n=[]);for(var s=0;s<e[a].length;s++)"string"==typeof e[a][s]&&(t?i.push(e[a][s]):n.push(e[a][s]));!t&&n.length&&i.push(n)}else"string"==typeof e[a]&&(t?i.push(e[a]):i.push([e[a]]));return i},c(e,[{key:"size",get:function(){return this._list.length}}]),e}(p),W="undefined"!=typeof window&&window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now,H=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,j=function(){function e(e){var t=e.match(H);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}var t=e.prototype;return t.toString=function(){var e="";return this.scheme&&(e+=this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e},t.getQuery=function(){var e={};if(this.query)for(var t,i=_(decodeURIComponent(this.query).split("&"));!(t=i()).done;){var n=t.value.split("=");e[n[0]]=n[1]}return e},t.setQuery=function(e){var t="";for(var i in e)e.hasOwnProperty(i)&&(""!==t&&(t+="&"),t+=encodeURIComponent(i)+"="+encodeURIComponent(e[i]));this.query=t},e}(),Se={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(e,t,i){return i<=e?i:e<=t?t:e},intToBytes24:function(e){return[e>>16&255,e>>8&255,255&e]},intToBytes32:function(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]},bytesToInt24:function(e,t,i){return e.length&&(i=e[2],t=e[1],e=e[0]),e<<16|t<<8|i},bytesToInt32:function(e,t,i,n){return e.length&&(n=e[3],i=e[2],t=e[1],e=e[0]),(e<<24|t<<16|i<<8|n)>>>32},lerp:function(e,t,i){return e+(t-e)*Se.clamp(i,0,1)},lerpAngle:function(e,t,i){return 180<t-e&&(t-=360),t-e<-180&&(t+=360),Se.lerp(e,t,Se.clamp(i,0,1))},powerOfTwo:function(e){return 0!==e&&!(e&e-1)},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},random:function(e,t){var i=t-e;return Math.random()*i+e},smoothstep:function(e,t,i){return i<=e?0:t<=i?1:(i=(i-e)/(t-e))*i*(3-2*i)},smootherstep:function(e,t,i){return i<=e?0:t<=i?1:(i=(i-e)/(t-e))*i*i*(i*(6*i-15)+10)},roundUp:function(e,t){return 0===t?e:Math.ceil(e/t)*t},float2Half:(F=new Float32Array(1),V=new Int32Array(F.buffer),function(e){F[0]=e;var t=V[0],i=t>>16&32768,n=t>>12&2047,a=t>>23&255;return a<103?i:142<a?(i|=31744,i|=(255===a?0:1)&&8388607&t):a<113?i|=((n|=2048)>>114-a)+(n>>113-a&1):(i|=a-112<<10|n>>1,i+=1&n)}),between:function(e,t,i,n){var a=Math.min(t,i),s=Math.max(t,i);return n?a<=e&&e<=s:a<e&&e<s}},X=function(){function f(){this.ContentType=f.ContentType,this.ResponseType=f.ResponseType,this.binaryExtensions=f.binaryExtensions}var e=f.prototype;return e.get=function(e,t,i){return"function"==typeof t&&(i=t,t={}),this.request("GET",e,t,i)},e.post=function(e,t,i,n){return"function"==typeof i&&(n=i,i={}),i.postdata=t,this.request("POST",e,i,n)},e.put=function(e,t,i,n){return"function"==typeof i&&(n=i,i={}),i.postdata=t,this.request("PUT",e,i,n)},e.del=function(e,t,i){return"function"==typeof t&&(i=t,t={}),this.request("DELETE",e,t,i)},e.request=function(e,t,i,n){var a,s,r,o,l,h=!1;if("function"==typeof i&&(n=i,i={}),i.retry&&(i=Object.assign({retries:0,maxRetries:5},i)),i.callback=n,null==i.async&&(i.async=!0),null==i.headers&&(i.headers={}),null!=i.postdata)if(i.postdata instanceof Document)o=i.postdata;else if(i.postdata instanceof FormData)o=i.postdata;else if(i.postdata instanceof Object){var c=i.headers["Content-Type"];switch(void 0===c&&(i.headers["Content-Type"]=f.ContentType.FORM_URLENCODED,c=i.headers["Content-Type"]),c){case f.ContentType.FORM_URLENCODED:var u=!(o="");for(var d in i.postdata)i.postdata.hasOwnProperty(d)&&(u?u=!1:o+="&",o+=escape(d)+"="+escape(i.postdata[d]));break;default:case f.ContentType.JSON:null==c&&(i.headers["Content-Type"]=f.ContentType.JSON),o=JSON.stringify(i.postdata)}}else o=i.postdata;for(var p in!1===i.cache&&(r=W(),(a=new j(t)).query?a.query=a.query+"&ts="+r:a.query="ts="+r,t=a.toString()),i.query&&(s=v((a=new j(t)).getQuery(),i.query),a.setQuery(s),t=a.toString()),(l=new XMLHttpRequest).open(e,t,i.async),l.withCredentials=void 0!==i.withCredentials&&i.withCredentials,l.responseType=i.responseType||this._guessResponseType(t),i.headers)i.headers.hasOwnProperty(p)&&l.setRequestHeader(p,i.headers[p]);l.onreadystatechange=function(){this._onReadyStateChange(e,t,i,l)}.bind(this),l.onerror=function(){this._onError(e,t,i,l),h=!0}.bind(this);try{l.send(o)}catch(e){h||i.error(l.status,l,e)}return l},e._guessResponseType=function(e){var t=new j(e),i=C.getExtension(t.path);return 0<=f.binaryExtensions.indexOf(i)?f.ResponseType.ARRAY_BUFFER:".xml"===i?f.ResponseType.DOCUMENT:f.ResponseType.TEXT},e._isBinaryContentType=function(e){return 0<=[f.ContentType.MP4,f.ContentType.WAV,f.ContentType.OGG,f.ContentType.MP3,f.ContentType.BIN,f.ContentType.DDS,f.ContentType.BASIS,f.ContentType.GLB].indexOf(e)},e._onReadyStateChange=function(e,t,i,n){if(4===n.readyState)switch(n.status){case 0:n.responseURL&&n.responseURL.startsWith("file:///")?this._onSuccess(e,t,i,n):this._onError(e,t,i,n);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,i,n);break;default:this._onError(e,t,i,n)}},e._onSuccess=function(e,t,i,n){var a,s,r;(s=n.getResponseHeader("Content-Type"))&&(r=s.split(";")[0].trim());try{a=r===this.ContentType.JSON||t.split("?")[0].endsWith(".json")?JSON.parse(n.responseText):this._isBinaryContentType(r)||n.responseType===f.ResponseType.ARRAY_BUFFER||n.responseType===f.ResponseType.BLOB||n.responseType===f.ResponseType.JSON?n.response:n.responseType===f.ResponseType.DOCUMENT||r===this.ContentType.XML?n.responseXML:n.responseText,i.callback(null,a)}catch(e){i.callback(e)}},e._onError=function(e,t,i,n){if(!i.retrying)if(i.retry&&i.retries<i.maxRetries){i.retries++,i.retrying=!0;var a=Se.clamp(Math.pow(2,i.retries)*f.retryDelay,0,i.maxRetryDelay||5e3);setTimeout(function(){i.retrying=!1,this.request(e,t,i,i.callback)}.bind(this),a)}else i.callback(0===n.status?"Network error":n.status,null)},f}();X.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"},X.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},X.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb"],X.retryDelay=100;var q=new X,$=function(){function e(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1);var a=e.length;3===a||4===a?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=void 0!==e[3]?e[3]:1):(this.r=e,this.g=t,this.b=i,this.a=n)}var t=e.prototype;return t.clone=function(){return new e(this.r,this.g,this.b,this.a)},t.copy=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},t.equals=function(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a},t.set=function(e,t,i,n){return void 0===n&&(n=1),this.r=e,this.g=t,this.b=i,this.a=n,this},t.lerp=function(e,t,i){return this.r=e.r+i*(t.r-e.r),this.g=e.g+i*(t.g-e.g),this.b=e.b+i*(t.b-e.b),this.a=e.a+i*(t.a-e.a),this},t.fromString=function(e){var t,i=parseInt(e.replace("#","0x"),16);return 7<e.length?t=Se.intToBytes32(i):(t=Se.intToBytes24(i))[3]=255,this.set(t[0]/255,t[1]/255,t[2]/255,t[3]/255),this},t.toString=function(e){var t="#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);if(!0===e){var i=Math.round(255*this.a).toString(16);this.a<16/255?t+="0"+i:t+=i}return t},e}();$.BLACK=Object.freeze(new $(0,0,0,1)),$.BLUE=Object.freeze(new $(0,0,1,1)),$.CYAN=Object.freeze(new $(0,1,1,1)),$.GRAY=Object.freeze(new $(.5,.5,.5,1)),$.GREEN=Object.freeze(new $(0,1,0,1)),$.MAGENTA=Object.freeze(new $(1,0,1,1)),$.RED=Object.freeze(new $(1,0,0,1)),$.WHITE=Object.freeze(new $(1,1,1,1)),$.YELLOW=Object.freeze(new $(1,1,0,1));var Y=function(){function e(e,t){this._curve=e,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._reset(t||0)}var t=e.prototype;return t.evaluate=function(e,t){var i;(t||e<this._left||e>=this._right)&&this._reset(e);var n=this._curve.type;if(5===n)i=this._p0;else{var a=0===this._recip?0:(e-this._left)*this._recip;i=0===n?Se.lerp(this._p0,this._p1,a):1===n?Se.lerp(this._p0,this._p1,a*a*(3-2*a)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,a)}return i},t._reset=function(e){var t=this._curve.keys,i=t.length;if(i)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[i-1][0])this._left=t[i-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[i-1][1],this._m0=this._m1=0;else{for(var n=0;e>=t[n+1][0];)n++;this._left=t[n][0],this._right=t[n+1][0];var a=1/(this._right-this._left);this._recip=isFinite(a)?a:0,this._p0=t[n][1],this._p1=t[n+1][1],this._isHermite()&&this._calcTangents(t,n)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0},t._isHermite=function(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type},t._calcTangents=function(e,t){var i,n,a=e[t],s=e[t+1];if(i=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],n=t===e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){var r=2*(s[0]-a[0])/(s[0]-i[0]),o=2*(s[0]-a[0])/(n[0]-a[0]);this._m0=this._curve.tension*(isFinite(r)?r:0)*(s[1]-i[1]),this._m1=this._curve.tension*(isFinite(o)?o:0)*(n[1]-a[1])}else{var l=(s[0]-a[0])/(a[0]-i[0]),h=(s[0]-a[0])/(n[0]-s[0]),c=a[1]+(i[1]-a[1])*(isFinite(l)?l:0),u=s[1]+(n[1]-s[1])*(isFinite(h)?h:0),d=2===this._curve.type?.5:this._curve.tension;this._m0=d*(s[1]-c),this._m1=d*(u-a[1])}},t._evaluateHermite=function(e,t,i,n,a){var s=a*a,r=a+a,o=1-a,l=o*o;return e*((1+r)*l)+i*(a*l)+t*(s*(3-r))+n*(s*(a-1))},e}(),K=function(){function t(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new Y(this),e)for(var t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}var e=t.prototype;return e.add=function(e,t){for(var i=this.keys,n=i.length,a=0;a<n&&!(i[a][0]>e);a++);var s=[e,t];return this.keys.splice(a,0,s),s},e.get=function(e){return this.keys[e]},e.sort=function(){this.keys.sort(function(e,t){return e[0]-t[0]})},e.value=function(e){return this._eval.evaluate(e,!0)},e.closest=function(e){for(var t=this.keys,i=t.length,n=2,a=null,s=0;s<i;s++){var r=Math.abs(e-t[s][0]);if(!(r<=n))break;n=r,a=t[s]}return a},e.clone=function(){var e=new t;return e.keys=v(e.keys,this.keys),e.type=this.type,e.tension=this.tension,e},e.quantize=function(e){e=Math.max(e,2);var t=new Float32Array(e),i=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(var n=1;n<e;n++)t[n]=this._eval.evaluate(i*n);return t},e.quantizeClamped=function(e,t,i){for(var n=this.quantize(e),a=0;a<n.length;++a)n[a]=Math.min(i,Math.max(t,n[a]));return n},c(t,[{key:"length",get:function(){return this.keys.length}}]),t}(),Z=function(){function i(){if(this.curves=[],(this._type=1)<arguments.length)for(var e=0;e<arguments.length;e++)this.curves.push(new K(arguments[e]));else if(0===arguments.length)this.curves.push(new K);else{var t=arguments[0];if("number"==typeof t)for(var i=0;i<t;i++)this.curves.push(new K);else for(var n=0;n<t.length;n++)this.curves.push(new K(t[n]))}}var e=i.prototype;return e.get=function(e){return this.curves[e]},e.value=function(e,t){void 0===t&&(t=[]);var i=this.curves.length;t.length=i;for(var n=0;n<i;n++)t[n]=this.curves[n].value(e);return t},e.clone=function(){var e=new i;e.curves=[];for(var t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e},e.quantize=function(e){e=Math.max(e,2);for(var t=this.curves.length,i=new Float32Array(e*t),n=1/(e-1),a=0;a<t;a++)for(var s=new Y(this.curves[a]),r=0;r<e;r++)i[r*t+a]=s.evaluate(n*r);return i},e.quantizeClamped=function(e,t,i){for(var n=this.quantize(e),a=0;a<n.length;++a)n[a]=Math.min(i,Math.max(t,n[a]));return n},c(i,[{key:"length",get:function(){return this.curves.length}},{key:"type",get:function(){return this._type},set:function(e){this._type=e;for(var t=0;t<this.curves.length;t++)this.curves[t].type=e}}]),i}(),de=function(){function e(e,t,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=i)}var t=e.prototype;return t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},t.add2=function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},t.addScalar=function(e){return this.x+=e,this.y+=e,this.z+=e,this},t.clone=function(){return new e(this.x,this.y,this.z)},t.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},t.cross=function(e,t){var i=e.x,n=e.y,a=e.z,s=t.x,r=t.y,o=t.z;return this.x=n*o-r*a,this.y=a*s-o*i,this.z=i*r-s*n,this},t.distance=function(e){var t=this.x-e.x,i=this.y-e.y,n=this.z-e.z;return Math.sqrt(t*t+i*i+n*n)},t.div=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},t.div2=function(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this},t.divScalar=function(e){return this.x/=e,this.y/=e,this.z/=e,this},t.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},t.equals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},t.lerp=function(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this.z=e.z+i*(t.z-e.z),this},t.mul=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},t.mul2=function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},t.mulScalar=function(e){return this.x*=e,this.y*=e,this.z*=e,this},t.normalize=function(){var e=this.x*this.x+this.y*this.y+this.z*this.z;if(0<e){var t=1/Math.sqrt(e);this.x*=t,this.y*=t,this.z*=t}return this},t.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},t.ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},t.round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},t.min=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this},t.max=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this},t.project=function(e){var t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this},t.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},t.sub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},t.sub2=function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},t.subScalar=function(e){return this.x-=e,this.y-=e,this.z-=e,this},t.toString=function(){return"["+this.x+", "+this.y+", "+this.z+"]"},e}();de.ZERO=Object.freeze(new de(0,0,0)),de.ONE=Object.freeze(new de(1,1,1)),de.UP=Object.freeze(new de(0,1,0)),de.DOWN=Object.freeze(new de(0,-1,0)),de.RIGHT=Object.freeze(new de(1,0,0)),de.LEFT=Object.freeze(new de(-1,0,0)),de.FORWARD=Object.freeze(new de(0,0,-1)),de.BACK=Object.freeze(new de(0,0,1));var Q=function(){function e(){var e=new Float32Array(9);e[0]=e[4]=e[8]=1,this.data=e}var t=e.prototype;return t.clone=function(){return(new e).copy(this)},t.copy=function(e){var t=e.data,i=this.data;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],this},t.set=function(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this},t.equals=function(e){var t=this.data,i=e.data;return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]&&t[4]===i[4]&&t[5]===i[5]&&t[6]===i[6]&&t[7]===i[7]&&t[8]===i[8]},t.isIdentity=function(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]},t.setIdentity=function(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},t.toString=function(){for(var e="[",t=0;t<9;t++)e+=this.data[t],e+=8!==t?", ":"";return e+"]"},t.transpose=function(){var e,t=this.data;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},t.setFromMat4=function(e){var t=e.data,i=this.data;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[4],i[4]=t[5],i[5]=t[6],i[6]=t[8],i[7]=t[9],i[8]=t[10],this},t.transformVector=function(e,t){void 0===t&&(t=new de);var i=this.data,n=e.x,a=e.y,s=e.z;return t.x=n*i[0]+a*i[3]+s*i[6],t.y=n*i[1]+a*i[4]+s*i[7],t.z=n*i[2]+a*i[5]+s*i[8],t},e}();Q.IDENTITY=Object.freeze(new Q),Q.ZERO=Object.freeze((new Q).set([0,0,0,0,0,0,0,0,0]));var J=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t)}var t=e.prototype;return t.add=function(e){return this.x+=e.x,this.y+=e.y,this},t.add2=function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},t.addScalar=function(e){return this.x+=e,this.y+=e,this},t.clone=function(){return new e(this.x,this.y)},t.copy=function(e){return this.x=e.x,this.y=e.y,this},t.cross=function(e){return this.x*e.y-this.y*e.x},t.distance=function(e){var t=this.x-e.x,i=this.y-e.y;return Math.sqrt(t*t+i*i)},t.div=function(e){return this.x/=e.x,this.y/=e.y,this},t.div2=function(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this},t.divScalar=function(e){return this.x/=e,this.y/=e,this},t.dot=function(e){return this.x*e.x+this.y*e.y},t.equals=function(e){return this.x===e.x&&this.y===e.y},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.lengthSq=function(){return this.x*this.x+this.y*this.y},t.lerp=function(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this},t.mul=function(e){return this.x*=e.x,this.y*=e.y,this},t.mul2=function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this},t.mulScalar=function(e){return this.x*=e,this.y*=e,this},t.normalize=function(){var e=this.x*this.x+this.y*this.y;if(0<e){var t=1/Math.sqrt(e);this.x*=t,this.y*=t}return this},t.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},t.ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},t.round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},t.min=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this},t.max=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this},t.set=function(e,t){return this.x=e,this.y=t,this},t.sub=function(e){return this.x-=e.x,this.y-=e.y,this},t.sub2=function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},t.subScalar=function(e){return this.x-=e,this.y-=e,this},t.toString=function(){return"["+this.x+", "+this.y+"]"},e.angleRad=function(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)},e}();J.ZERO=Object.freeze(new J(0,0)),J.ONE=Object.freeze(new J(1,1)),J.UP=Object.freeze(new J(0,1)),J.DOWN=Object.freeze(new J(0,-1)),J.RIGHT=Object.freeze(new J(1,0)),J.LEFT=Object.freeze(new J(-1,0));var ee=function(){function e(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=i,this.w=n)}var t=e.prototype;return t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},t.add2=function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},t.addScalar=function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},t.clone=function(){return new e(this.x,this.y,this.z,this.w)},t.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},t.div=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},t.div2=function(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this},t.divScalar=function(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this},t.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},t.equals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t.lerp=function(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this.z=e.z+i*(t.z-e.z),this.w=e.w+i*(t.w-e.w),this},t.mul=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},t.mul2=function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this},t.mulScalar=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},t.normalize=function(){var e=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(0<e){var t=1/Math.sqrt(e);this.x*=t,this.y*=t,this.z*=t,this.w*=t}return this},t.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},t.ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},t.round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},t.min=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this},t.max=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this},t.set=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},t.sub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},t.sub2=function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},t.subScalar=function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},t.toString=function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"},e}();ee.ZERO=Object.freeze(new ee(0,0,0,0)),ee.ONE=Object.freeze(new ee(1,1,1,1));var te=new J,ie=new de,ne=new de,ae=new de,se=new de,pe=function(){function s(){var e=new Float32Array(16);e[0]=e[5]=e[10]=e[15]=1,this.data=e}s._getPerspectiveHalfSize=function(e,t,i,n,a){a?(e.x=n*Math.tan(t*Math.PI/360),e.y=e.x/i):(e.y=n*Math.tan(t*Math.PI/360),e.x=e.y*i)};var e=s.prototype;return e.add2=function(e,t){var i=e.data,n=t.data,a=this.data;return a[0]=i[0]+n[0],a[1]=i[1]+n[1],a[2]=i[2]+n[2],a[3]=i[3]+n[3],a[4]=i[4]+n[4],a[5]=i[5]+n[5],a[6]=i[6]+n[6],a[7]=i[7]+n[7],a[8]=i[8]+n[8],a[9]=i[9]+n[9],a[10]=i[10]+n[10],a[11]=i[11]+n[11],a[12]=i[12]+n[12],a[13]=i[13]+n[13],a[14]=i[14]+n[14],a[15]=i[15]+n[15],this},e.add=function(e){return this.add2(this,e)},e.clone=function(){return(new s).copy(this)},e.copy=function(e){var t=e.data,i=this.data;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],this},e.equals=function(e){var t=this.data,i=e.data;return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]&&t[4]===i[4]&&t[5]===i[5]&&t[6]===i[6]&&t[7]===i[7]&&t[8]===i[8]&&t[9]===i[9]&&t[10]===i[10]&&t[11]===i[11]&&t[12]===i[12]&&t[13]===i[13]&&t[14]===i[14]&&t[15]===i[15]},e.isIdentity=function(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},e.mul2=function(e,t){var i,n,a,s,r=e.data,o=t.data,l=this.data,h=r[0],c=r[1],u=r[2],d=r[3],p=r[4],f=r[5],m=r[6],v=r[7],g=r[8],_=r[9],y=r[10],b=r[11],x=r[12],M=r[13],S=r[14],w=r[15];return i=o[0],n=o[1],a=o[2],s=o[3],l[0]=h*i+p*n+g*a+x*s,l[1]=c*i+f*n+_*a+M*s,l[2]=u*i+m*n+y*a+S*s,l[3]=d*i+v*n+b*a+w*s,i=o[4],n=o[5],a=o[6],s=o[7],l[4]=h*i+p*n+g*a+x*s,l[5]=c*i+f*n+_*a+M*s,l[6]=u*i+m*n+y*a+S*s,l[7]=d*i+v*n+b*a+w*s,i=o[8],n=o[9],a=o[10],s=o[11],l[8]=h*i+p*n+g*a+x*s,l[9]=c*i+f*n+_*a+M*s,l[10]=u*i+m*n+y*a+S*s,l[11]=d*i+v*n+b*a+w*s,i=o[12],n=o[13],a=o[14],s=o[15],l[12]=h*i+p*n+g*a+x*s,l[13]=c*i+f*n+_*a+M*s,l[14]=u*i+m*n+y*a+S*s,l[15]=d*i+v*n+b*a+w*s,this},e.mulAffine2=function(e,t){var i,n,a,s=e.data,r=t.data,o=this.data,l=s[0],h=s[1],c=s[2],u=s[4],d=s[5],p=s[6],f=s[8],m=s[9],v=s[10],g=s[12],_=s[13],y=s[14];return i=r[0],n=r[1],a=r[2],o[0]=l*i+u*n+f*a,o[1]=h*i+d*n+m*a,o[2]=c*i+p*n+v*a,o[3]=0,i=r[4],n=r[5],a=r[6],o[4]=l*i+u*n+f*a,o[5]=h*i+d*n+m*a,o[6]=c*i+p*n+v*a,o[7]=0,i=r[8],n=r[9],a=r[10],o[8]=l*i+u*n+f*a,o[9]=h*i+d*n+m*a,o[10]=c*i+p*n+v*a,o[11]=0,i=r[12],n=r[13],a=r[14],o[12]=l*i+u*n+f*a+g,o[13]=h*i+d*n+m*a+_,o[14]=c*i+p*n+v*a+y,o[15]=1,this},e.mul=function(e){return this.mul2(this,e)},e.transformPoint=function(e,t){void 0===t&&(t=new de);var i=this.data,n=e.x,a=e.y,s=e.z;return t.x=n*i[0]+a*i[4]+s*i[8]+i[12],t.y=n*i[1]+a*i[5]+s*i[9]+i[13],t.z=n*i[2]+a*i[6]+s*i[10]+i[14],t},e.transformVector=function(e,t){void 0===t&&(t=new de);var i=this.data,n=e.x,a=e.y,s=e.z;return t.x=n*i[0]+a*i[4]+s*i[8],t.y=n*i[1]+a*i[5]+s*i[9],t.z=n*i[2]+a*i[6]+s*i[10],t},e.transformVec4=function(e,t){void 0===t&&(t=new ee);var i=this.data,n=e.x,a=e.y,s=e.z,r=e.w;return t.x=n*i[0]+a*i[4]+s*i[8]+r*i[12],t.y=n*i[1]+a*i[5]+s*i[9]+r*i[13],t.z=n*i[2]+a*i[6]+s*i[10]+r*i[14],t.w=n*i[3]+a*i[7]+s*i[11]+r*i[15],t},e.setLookAt=function(e,t,i){ae.sub2(e,t).normalize(),ne.copy(i).normalize(),ie.cross(ne,ae).normalize(),ne.cross(ae,ie);var n=this.data;return n[0]=ie.x,n[1]=ie.y,n[2]=ie.z,n[3]=0,n[4]=ne.x,n[5]=ne.y,n[6]=ne.z,n[7]=0,n[8]=ae.x,n[9]=ae.y,n[10]=ae.z,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,this},e.setFrustum=function(e,t,i,n,a,s){var r=2*a,o=t-e,l=n-i,h=s-a,c=this.data;return c[0]=r/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=r/l,c[6]=0,c[7]=0,c[8]=(t+e)/o,c[9]=(n+i)/l,c[10]=(-s-a)/h,c[11]=-1,c[12]=0,c[13]=0,c[14]=-r*s/h,c[15]=0,this},e.setPerspective=function(e,t,i,n,a){return s._getPerspectiveHalfSize(te,e,t,i,a),this.setFrustum(-te.x,te.x,-te.y,te.y,i,n)},e.setOrtho=function(e,t,i,n,a,s){var r=this.data;return r[0]=2/(t-e),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(n-i),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/(s-a),r[11]=0,r[12]=-(t+e)/(t-e),r[13]=-(n+i)/(n-i),r[14]=-(s+a)/(s-a),r[15]=1,this},e.setFromAxisAngle=function(e,t){t*=Se.DEG_TO_RAD;var i=e.x,n=e.y,a=e.z,s=Math.cos(t),r=Math.sin(t),o=1-s,l=o*i,h=o*n,c=this.data;return c[0]=l*i+s,c[1]=l*n+r*a,c[2]=l*a-r*n,c[3]=0,c[4]=l*n-r*a,c[5]=h*n+s,c[6]=h*a+r*i,c[7]=0,c[8]=l*a+r*n,c[9]=h*a-i*r,c[10]=o*a*a+s,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this},e.setTranslate=function(e,t,i){var n=this.data;return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e,n[13]=t,n[14]=i,n[15]=1,this},e.setScale=function(e,t,i){var n=this.data;return n[0]=e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=t,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=i,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this},e.setViewport=function(e,t,i,n){var a=this.data;return a[0]=.5*i,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=.5*n,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=.5,a[11]=0,a[12]=e+.5*i,a[13]=t+.5*n,a[14]=.5,a[15]=1,this},e.invert=function(){var e=this.data,t=e[0],i=e[1],n=e[2],a=e[3],s=e[4],r=e[5],o=e[6],l=e[7],h=e[8],c=e[9],u=e[10],d=e[11],p=e[12],f=e[13],m=e[14],v=e[15],g=t*r-i*s,_=t*o-n*s,y=t*l-a*s,b=i*o-n*r,x=i*l-a*r,M=n*l-a*o,S=h*f-c*p,w=h*m-u*p,C=h*v-d*p,P=c*m-u*f,T=c*v-d*f,A=u*v-d*m,E=g*A-_*T+y*P+b*C-x*w+M*S;if(0===E)this.setIdentity();else{var R=1/E;e[0]=(r*A-o*T+l*P)*R,e[1]=(-i*A+n*T-a*P)*R,e[2]=(f*M-m*x+v*b)*R,e[3]=(-c*M+u*x-d*b)*R,e[4]=(-s*A+o*C-l*w)*R,e[5]=(t*A-n*C+a*w)*R,e[6]=(-p*M+m*y-v*_)*R,e[7]=(h*M-u*y+d*_)*R,e[8]=(s*T-r*C+l*S)*R,e[9]=(-t*T+i*C-a*S)*R,e[10]=(p*x-f*y+v*g)*R,e[11]=(-h*x+c*y-d*g)*R,e[12]=(-s*P+r*w-o*S)*R,e[13]=(t*P-i*w+n*S)*R,e[14]=(-p*b+f*_-m*g)*R,e[15]=(h*b-c*_+u*g)*R}return this},e.set=function(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},e.setIdentity=function(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},e.setTRS=function(e,t,i){var n=t.x,a=t.y,s=t.z,r=t.w,o=i.x,l=i.y,h=i.z,c=n+n,u=a+a,d=s+s,p=n*c,f=n*u,m=n*d,v=a*u,g=a*d,_=s*d,y=r*c,b=r*u,x=r*d,M=this.data;return M[0]=(1-(v+_))*o,M[1]=(f+x)*o,M[2]=(m-b)*o,M[3]=0,M[4]=(f-x)*l,M[5]=(1-(p+_))*l,M[6]=(g+y)*l,M[7]=0,M[8]=(m+b)*h,M[9]=(g-y)*h,M[10]=(1-(p+v))*h,M[11]=0,M[12]=e.x,M[13]=e.y,M[14]=e.z,M[15]=1,this},e.transpose=function(){var e,t=this.data;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},e.invertTo3x3=function(e){var t=this.data,i=e.data,n=t[0],a=t[1],s=t[2],r=t[4],o=t[5],l=t[6],h=t[8],c=t[9],u=t[10],d=u*o-l*c,p=-u*a+s*c,f=l*a-s*o,m=-u*r+l*h,v=u*n-s*h,g=-l*n+s*r,_=c*r-o*h,y=-c*n+a*h,b=o*n-a*r,x=n*d+a*m+s*_;if(0===x)return this;var M=1/x;return i[0]=M*d,i[1]=M*p,i[2]=M*f,i[3]=M*m,i[4]=M*v,i[5]=M*g,i[6]=M*_,i[7]=M*y,i[8]=M*b,this},e.getTranslation=function(e){return void 0===e&&(e=new de),e.set(this.data[12],this.data[13],this.data[14])},e.getX=function(e){return void 0===e&&(e=new de),e.set(this.data[0],this.data[1],this.data[2])},e.getY=function(e){return void 0===e&&(e=new de),e.set(this.data[4],this.data[5],this.data[6])},e.getZ=function(e){return void 0===e&&(e=new de),e.set(this.data[8],this.data[9],this.data[10])},e.getScale=function(e){return void 0===e&&(e=new de),this.getX(ie),this.getY(ne),this.getZ(ae),e.set(ie.length(),ne.length(),ae.length()),e},e.setFromEulerAngles=function(e,t,i){e*=Se.DEG_TO_RAD,t*=Se.DEG_TO_RAD,i*=Se.DEG_TO_RAD;var n=Math.sin(-e),a=Math.cos(-e),s=Math.sin(-t),r=Math.cos(-t),o=Math.sin(-i),l=Math.cos(-i),h=this.data;return h[0]=r*l,h[1]=-r*o,h[2]=s,h[3]=0,h[4]=a*o+l*n*s,h[5]=a*l-n*s*o,h[6]=-r*n,h[7]=0,h[8]=n*o-a*l*s,h[9]=l*n+a*s*o,h[10]=a*r,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this},e.getEulerAngles=function(e){void 0===e&&(e=new de),this.getScale(se);var t=se.x,i=se.y,n=se.z;if(0===t||0===i||0===n)return e.set(0,0,0);var a,s,r=this.data,o=Math.asin(-r[2]/t),l=.5*Math.PI;return o<l?-l<o?(a=Math.atan2(r[6]/i,r[10]/n),s=Math.atan2(r[1]/t,r[0]/t)):(s=0,a=-Math.atan2(r[4]/i,r[5]/i)):(s=0,a=Math.atan2(r[4]/i,r[5]/i)),e.set(a,o,s).mulScalar(Se.RAD_TO_DEG)},e.toString=function(){for(var e="[",t=0;t<16;t+=1)e+=this.data[t],e+=15!==t?", ":"";return e+"]"},e.rotate=function(e,t,i){var n,a,s,r,o,l,h,c,u,d,p,f,m,v,g,_,y,b,x,M,S,w,C,P,T=this.data,A=e.data,E=i.x,R=i.y,D=i.z,I=Math.hypot(E,R,D);return I<1e-6?null:(E*=I=1/I,R*=I,D*=I,n=Math.sin(t),s=1-(a=Math.cos(t)),r=A[0],o=A[1],l=A[2],h=A[3],c=A[4],u=A[5],d=A[6],p=A[7],f=A[8],m=A[9],v=A[10],g=A[11],_=E*E*s+a,y=R*E*s+D*n,b=D*E*s-R*n,x=E*R*s-D*n,M=R*R*s+a,S=D*R*s+E*n,w=E*D*s+R*n,C=R*D*s-E*n,P=D*D*s+a,T[0]=r*_+c*y+f*b,T[1]=o*_+u*y+m*b,T[2]=l*_+d*y+v*b,T[3]=h*_+p*y+g*b,T[4]=r*x+c*M+f*S,T[5]=o*x+u*M+m*S,T[6]=l*x+d*M+v*S,T[7]=h*x+p*M+g*S,T[8]=r*w+c*C+f*P,T[9]=o*w+u*C+m*P,T[10]=l*w+d*C+v*P,T[11]=h*w+p*C+g*P,e!==this&&(T[12]=A[12],T[13]=A[13],T[14]=A[14],T[15]=A[15]),this)},s}();pe.IDENTITY=Object.freeze(new pe),pe.ZERO=Object.freeze((new pe).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));var fe=function(){function e(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=i,this.w=n)}var t=e.prototype;return t.clone=function(){return new e(this.x,this.y,this.z,this.w)},t.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},t.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},t.equals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},t.getAxisAngle=function(e){var t=2*Math.acos(this.w),i=Math.sin(t/2);return 0!==i?(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*Se.RAD_TO_DEG},t.getEulerAngles=function(e){var t,i,n;void 0===e&&(e=new de);var a=this.x,s=this.y,r=this.z,o=this.w,l=2*(o*s-a*r);return l<=-.99999?(t=2*Math.atan2(a,o),i=-Math.PI/2,n=0):.99999<=l?(t=2*Math.atan2(a,o),i=Math.PI/2,n=0):(t=Math.atan2(2*(o*a+s*r),1-2*(a*a+s*s)),i=Math.asin(l),n=Math.atan2(2*(o*r+a*s),1-2*(s*s+r*r))),e.set(t,i,n).mulScalar(Se.RAD_TO_DEG)},t.invert=function(){return this.conjugate().normalize()},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t.mul=function(e){var t=this.x,i=this.y,n=this.z,a=this.w,s=e.x,r=e.y,o=e.z,l=e.w;return this.x=a*s+t*l+i*o-n*r,this.y=a*r+i*l+n*s-t*o,this.z=a*o+n*l+t*r-i*s,this.w=a*l-t*s-i*r-n*o,this},t.mul2=function(e,t){var i=e.x,n=e.y,a=e.z,s=e.w,r=t.x,o=t.y,l=t.z,h=t.w;return this.x=s*r+i*h+n*l-a*o,this.y=s*o+n*h+a*r-i*l,this.z=s*l+a*h+i*o-n*r,this.w=s*h-i*r-n*o-a*l,this},t.normalize=function(){var e=this.length();return 0===e?(this.x=this.y=this.z=0,this.w=1):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},t.set=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},t.setFromAxisAngle=function(e,t){t*=.5*Se.DEG_TO_RAD;var i=Math.sin(t),n=Math.cos(t);return this.x=i*e.x,this.y=i*e.y,this.z=i*e.z,this.w=n,this},t.setFromEulerAngles=function(e,t,i){var n=.5*Se.DEG_TO_RAD;e*=n,t*=n,i*=n;var a=Math.sin(e),s=Math.cos(e),r=Math.sin(t),o=Math.cos(t),l=Math.sin(i),h=Math.cos(i);return this.x=a*o*h-s*r*l,this.y=s*r*h+a*o*l,this.z=s*o*l-a*r*h,this.w=s*o*h+a*r*l,this},t.setFromMat4=function(e){var t,i,n,a,s,r,o,l,h,c,u,d,p,f;if(t=(e=e.data)[0],i=e[1],n=e[2],a=e[4],s=e[5],r=e[6],o=e[8],l=e[9],h=e[10],0==(d=t*t+i*i+n*n))return this;if(d=1/Math.sqrt(d),0==(p=a*a+s*s+r*r))return this;if(p=1/Math.sqrt(p),0==(f=o*o+l*l+h*h))return this;i*=d,n*=d,a*=p,r*=p,o*=f=1/Math.sqrt(f),l*=f;var m=(t*=d)+(s*=p)+(h*=f);return 0<=m?(c=Math.sqrt(m+1),this.w=.5*c,c=.5/c,this.x=(r-l)*c,this.y=(o-n)*c,this.z=(i-a)*c):s<t?h<t?(u=t-(s+h)+1,u=Math.sqrt(u),this.x=.5*u,u=.5/u,this.w=(r-l)*u,this.y=(i+a)*u,this.z=(n+o)*u):(u=h-(t+s)+1,u=Math.sqrt(u),this.z=.5*u,u=.5/u,this.w=(i-a)*u,this.x=(o+n)*u,this.y=(l+r)*u):h<s?(u=s-(h+t)+1,u=Math.sqrt(u),this.y=.5*u,u=.5/u,this.w=(o-n)*u,this.z=(r+l)*u,this.x=(a+i)*u):(u=h-(t+s)+1,u=Math.sqrt(u),this.z=.5*u,u=.5/u,this.w=(i-a)*u,this.x=(o+n)*u,this.y=(l+r)*u),this},t.slerp=function(e,t,i){var n=e.x,a=e.y,s=e.z,r=e.w,o=t.x,l=t.y,h=t.z,c=t.w,u=r*c+n*o+a*l+s*h;if(u<0&&(c=-c,o=-o,l=-l,h=-h,u=-u),1<=Math.abs(u))return this.w=r,this.x=n,this.y=a,this.z=s,this;var d=Math.acos(u),p=Math.sqrt(1-u*u);if(Math.abs(p)<.001)return this.w=.5*r+.5*c,this.x=.5*n+.5*o,this.y=.5*a+.5*l,this.z=.5*s+.5*h,this;var f=Math.sin((1-i)*d)/p,m=Math.sin(i*d)/p;return this.w=r*f+c*m,this.x=n*f+o*m,this.y=a*f+l*m,this.z=s*f+h*m,this},t.transformVector=function(e,t){void 0===t&&(t=new de);var i=e.x,n=e.y,a=e.z,s=this.x,r=this.y,o=this.z,l=this.w,h=l*i+r*a-o*n,c=l*n+o*i-s*a,u=l*a+s*n-r*i,d=-s*i-r*n-o*a;return t.x=h*l+d*-s+c*-o-u*-r,t.y=c*l+d*-r+u*-s-h*-o,t.z=u*l+d*-o+h*-r-c*-s,t},t.toString=function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"},e}();fe.IDENTITY=Object.freeze(new fe(0,0,0,1)),fe.ZERO=Object.freeze(new fe(0,0,0,0));var re=new de,oe=new de,le=new de,he=new de,ce=new de,ue=function(){function e(e,t){void 0===e&&(e=new de),void 0===t&&(t=new de(.5,.5,.5)),this.center=e,this.halfExtents=t,this._min=new de,this._max=new de}var t=e.prototype;return t.add=function(e){var t=this.center,i=t.x,n=t.y,a=t.z,s=this.halfExtents,r=s.x,o=s.y,l=s.z,h=i-r,c=i+r,u=n-o,d=n+o,p=a-l,f=a+l,m=e.center,v=m.x,g=m.y,_=m.z,y=e.halfExtents,b=y.x,x=y.y,M=y.z,S=v-b,w=v+b,C=g-x,P=g+x,T=_-M,A=_+M;S<h&&(h=S),c<w&&(c=w),C<u&&(u=C),d<P&&(d=P),T<p&&(p=T),f<A&&(f=A),t.x=.5*(h+c),t.y=.5*(u+d),t.z=.5*(p+f),s.x=.5*(c-h),s.y=.5*(d-u),s.z=.5*(f-p)},t.copy=function(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents)},t.clone=function(){return new e(this.center.clone(),this.halfExtents.clone())},t.intersects=function(e){var t=this.getMax(),i=this.getMin(),n=e.getMax(),a=e.getMin();return i.x<=n.x&&t.x>=a.x&&i.y<=n.y&&t.y>=a.y&&i.z<=n.z&&t.z>=a.z},t._intersectsRay=function(e,t){var i=re.copy(this.getMin()).sub(e.origin),n=oe.copy(this.getMax()).sub(e.origin),a=e.direction;0===a.x?(i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,n.x=n.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.x/=a.x,n.x/=a.x),0===a.y?(i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,n.y=n.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.y/=a.y,n.y/=a.y),0===a.z?(i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,n.z=n.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.z/=a.z,n.z/=a.z);var s=le.set(Math.min(i.x,n.x),Math.min(i.y,n.y),Math.min(i.z,n.z)),r=he.set(Math.max(i.x,n.x),Math.max(i.y,n.y),Math.max(i.z,n.z)),o=Math.min(Math.min(r.x,r.y),r.z),l=Math.max(Math.max(s.x,s.y),s.z),h=l<=o&&0<=l;return h&&t.copy(e.direction).mulScalar(l).add(e.origin),h},t._fastIntersectsRay=function(e){var t=re,i=oe,n=le,a=he,s=ce,r=e.direction;return t.sub2(e.origin,this.center),a.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),n.mul2(t,r),!(a.x>this.halfExtents.x&&0<=n.x||a.y>this.halfExtents.y&&0<=n.y||a.z>this.halfExtents.z&&0<=n.z||(s.set(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z)),i.cross(r,t),i.set(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z)),i.x>this.halfExtents.y*s.z+this.halfExtents.z*s.y||i.y>this.halfExtents.x*s.z+this.halfExtents.z*s.x||i.z>this.halfExtents.x*s.y+this.halfExtents.y*s.x))},t.intersectsRay=function(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)},t.setMinMax=function(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5)},t.getMin=function(){return this._min.copy(this.center).sub(this.halfExtents)},t.getMax=function(){return this._max.copy(this.center).add(this.halfExtents)},t.containsPoint=function(e){var t=this.getMin(),i=this.getMax();return!(e.x<t.x||e.x>i.x||e.y<t.y||e.y>i.y||e.z<t.z||e.z>i.z)},t.setFromTransformedAabb=function(e,t){var i=e.center,n=e.halfExtents,a=t.data,s=a[0],r=a[4],o=a[8],l=a[1],h=a[5],c=a[9],u=a[2],d=a[6],p=a[10];this.center.set(a[12]+s*i.x+r*i.y+o*i.z,a[13]+l*i.x+h*i.y+c*i.z,a[14]+u*i.x+d*i.y+p*i.z),this.halfExtents.set(Math.abs(s)*n.x+Math.abs(r)*n.y+Math.abs(o)*n.z,Math.abs(l)*n.x+Math.abs(h)*n.y+Math.abs(c)*n.z,Math.abs(u)*n.x+Math.abs(d)*n.y+Math.abs(p)*n.z)},t.compute=function(e,t){if(0<(t=void 0===t?e.length/3:t)){for(var i=re.set(e[0],e[1],e[2]),n=oe.set(e[0],e[1],e[2]),a=1;a<t;a++){var s=e[3*a+0],r=e[3*a+1],o=e[3*a+2];s<i.x&&(i.x=s),r<i.y&&(i.y=r),o<i.z&&(i.z=o),s>n.x&&(n.x=s),r>n.y&&(n.y=r),o>n.z&&(n.z=o)}this.setMinMax(i,n)}},t.intersectsBoundingSphere=function(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius},t._distanceToBoundingSphereSq=function(e){for(var t=this.getMin(),i=this.getMax(),n=0,a=["x","y","z"],s=0;s<3;++s){var r=0,o=e.center[a[s]],l=t[a[s]],h=i[a[s]],c=0;o<l&&(r+=(c=l-o)*c),h<o&&(r+=(c=o-h)*c),n+=r}return n},t._expand=function(e,t){re.add2(this.getMin(),e),oe.add2(this.getMax(),t),this.setMinMax(re,oe)},e}(),me=new de,ve=new de,ge=function(){function e(e,t){void 0===e&&(e=new de),void 0===t&&(t=.5),this.center=e,this.radius=t}var t=e.prototype;return t.containsPoint=function(e){var t=me.sub2(e,this.center).lengthSq(),i=this.radius;return t<i*i},t.intersectsRay=function(e,t){var i=me.copy(e.origin).sub(this.center),n=i.dot(ve.copy(e.direction).normalize()),a=i.dot(i)-this.radius*this.radius;if(0<a&&0<n)return null;var s=n*n-a;if(s<0)return!1;var r=Math.abs(-n-Math.sqrt(s));return t&&t.copy(e.direction).mulScalar(r).add(e.origin),!0},t.intersectsBoundingSphere=function(e){me.sub2(e.center,this.center);var t=e.radius+this.radius;return me.lengthSq()<=t*t},e}(),_e="none",ye=[new de,new de,new de,new de,new de,new de,new de,new de],be=function(){function e(){this.planes=[];for(var e=0;e<6;e++)this.planes[e]=[]}var t=e.prototype;return t.setFromMat4=function(e){var t,i=e.data,n=this.planes;(t=n[0])[0]=i[3]-i[0],t[1]=i[7]-i[4],t[2]=i[11]-i[8],t[3]=i[15]-i[12];var a=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=a,t[1]/=a,t[2]/=a,t[3]/=a,(t=n[1])[0]=i[3]+i[0],t[1]=i[7]+i[4],t[2]=i[11]+i[8],t[3]=i[15]+i[12],a=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),t[0]/=a,t[1]/=a,t[2]/=a,t[3]/=a,(t=n[2])[0]=i[3]+i[1],t[1]=i[7]+i[5],t[2]=i[11]+i[9],t[3]=i[15]+i[13],a=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),t[0]/=a,t[1]/=a,t[2]/=a,t[3]/=a,(t=n[3])[0]=i[3]-i[1],t[1]=i[7]-i[5],t[2]=i[11]-i[9],t[3]=i[15]-i[13],a=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),t[0]/=a,t[1]/=a,t[2]/=a,t[3]/=a,(t=n[4])[0]=i[3]-i[2],t[1]=i[7]-i[6],t[2]=i[11]-i[10],t[3]=i[15]-i[14],a=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),t[0]/=a,t[1]/=a,t[2]/=a,t[3]/=a,(t=n[5])[0]=i[3]+i[2],t[1]=i[7]+i[6],t[2]=i[11]+i[10],t[3]=i[15]+i[14],a=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),t[0]/=a,t[1]/=a,t[2]/=a,t[3]/=a},t.containsPoint=function(e){var t,i;for(t=0;t<6;t++)if((i=this.planes[t])[0]*e.x+i[1]*e.y+i[2]*e.z+i[3]<=0)return!1;return!0},t.containsSphere=function(e){var t,i,n,a=0,s=e.radius,r=e.center,o=r.x,l=r.y,h=r.z,c=this.planes;for(i=0;i<6;i++){if((t=(n=c[i])[0]*o+n[1]*l+n[2]*h+n[3])<=-s)return 0;s<t&&a++}return 6===a?2:1},e.getPoints=function(e,t,i){t=t||e._nearClip,i=i||e._farClip;var n=e._fov*Math.PI/180,a=0===e._projection?Math.tan(n/2)*t:e._orthoHeight,s=a*e._aspectRatio,r=ye;return r[0].x=s,r[0].y=-a,r[0].z=-t,r[1].x=s,r[1].y=a,r[1].z=-t,r[2].x=-s,r[2].y=a,r[2].z=-t,r[3].x=-s,r[3].y=-a,r[3].z=-t,0===e._projection&&(s=(a=Math.tan(n/2)*i)*e._aspectRatio),r[4].x=s,r[4].y=-a,r[4].z=-i,r[5].x=s,r[5].y=a,r[5].z=-i,r[6].x=-s,r[6].y=a,r[6].z=-i,r[7].x=-s,r[7].y=-a,r[7].z=-i,r},e}(),xe=function(){function e(e,t){void 0===e&&(e=new de),void 0===t&&(t=new de(0,0,-1)),this.origin=e,this.direction=t}return e.prototype.set=function(e,t){return this.origin.copy(e),this.direction.copy(t),this},e}();new de;var we=12,Ce=14,Pe=17,Te="POSITION",Ae="NORMAL",Ee="TANGENT",Re="BLENDWEIGHT",De="BLENDINDICES",Ie="COLOR",ke="TEXCOORD",Le="TEXCOORD0",Oe="TEXCOORD1",Fe="TEXCOORD2",ze="TEXCOORD3",Be="TEXCOORD4",Ve="TEXCOORD5",Ue="TEXCOORD6",Ne="TEXCOORD7",Ge="ATTR0",We="ATTR8",He="ATTR9",je="ATTR10",Xe="ATTR11",qe="ATTR12",$e="ATTR13",Ye="ATTR14",Ke="ATTR15",Ze="default",Qe="rgbm",Je="rgbe",et="swizzleGGGR",tt="none",it="cube",nt="equirect",at=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],st=[1,1,2,2,4,4,4],rt=[Uint8Array,Uint16Array,Uint32Array],ot={POSITION:0,NORMAL:1,BLENDWEIGHT:2,BLENDINDICES:3,COLOR:4,TEXCOORD0:5,TEXCOORD1:6,TEXCOORD2:7,TEXCOORD3:8,TEXCOORD4:9,TEXCOORD5:10,TEXCOORD6:11,TEXCOORD7:12,TANGENT:13,ATTR0:0,ATTR1:1,ATTR2:2,ATTR3:3,ATTR4:4,ATTR5:5,ATTR6:6,ATTR7:7,ATTR8:8,ATTR9:9,ATTR10:10,ATTR11:11,ATTR12:12,ATTR13:13,ATTR14:14,ATTR15:15},lt=0,ht=function(){function e(e,t,i,n,a){void 0===n&&(n=0),this.device=e,this.format=t,this.numVertices=i,this.usage=n,this.id=lt++,this._vao=null,this.instancing=!1,this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*i,e._vram.vb+=this.numBytes,a?this.setData(a):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}var t=e.prototype;return t.destroy=function(){var e=this.device,t=e.buffers.indexOf(this);if(-1!==t&&e.buffers.splice(t,1),this.bufferId){var i=e.gl;e.boundVao=null,i.bindVertexArray(null),i.deleteBuffer(this.bufferId),e._vram.vb-=this.storage.byteLength,this.bufferId=null}},t.loseContext=function(){this.bufferId=void 0,this._vao=null},t.getFormat=function(){return this.format},t.getUsage=function(){return this.usage},t.getNumVertices=function(){return this.numVertices},t.lock=function(){return this.storage},t.unlock=function(){var e,t=this.device.gl;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case 0:e=t.STATIC_DRAW;break;case 1:e=t.DYNAMIC_DRAW;break;case 2:e=t.STREAM_DRAW;break;case 3:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ARRAY_BUFFER,this.bufferId),t.bufferData(t.ARRAY_BUFFER,this.storage,e)},t.setData=function(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)},e}();function ct(e){for(var t=0,i=0,n=e.length;i<n;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}var ut=function(){function t(e,t,i){this.elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=i,this.interleaved=void 0===i,this.size=t.reduce(function(e,t){return e+4*Math.ceil(t.components*st[t.type]/4)},0);for(var n,a=0,s=0,r=t.length;s<r;s++){var o=t[s];n=o.components*st[o.type],i&&(a=Se.roundUp(a,n));var l={name:o.semantic,offset:i?a:o.hasOwnProperty("offset")?o.offset:a,stride:i?n:o.hasOwnProperty("stride")?o.stride:this.size,dataType:o.type,numComponents:o.components,normalize:void 0!==o.normalize&&o.normalize,size:n};this.elements.push(l),a+=i?n*i:4*Math.ceil(n/4),o.semantic===Le?this.hasUv0=!0:o.semantic===Oe?this.hasUv1=!0:o.semantic===Ie?this.hasColor=!0:o.semantic===Ee&&(this.hasTangents=!0)}i&&(this.verticesByteSize=a),this.update()}t.init=function(e){t._defaultInstancingFormat=new t(e,[{semantic:Fe,components:4,type:6},{semantic:ze,components:4,type:6},{semantic:Be,components:4,type:6},{semantic:Ve,components:4,type:6}])};var e=t.prototype;return e.update=function(){this._evaluateHash()},e._evaluateHash=function(){for(var e,t,i=[],n=[],a=this.elements.length,s=0;s<a;s++){var r=this.elements[s];e=r.name,e+=r.dataType,e+=r.numComponents,e+=r.normalize,i.push(e),t=e,t+=r.offset,t+=r.stride,t+=r.size,n.push(t)}i.sort(),this.batchingHash=ct(i.join()),this.renderingingHash=ct(n.join())},c(t,null,[{key:"defaultInstancingFormat",get:function(){return t._defaultInstancingFormat}}]),t}();function dt(e){this.array[this.index]=e}function pt(e,t){this.array[this.index]=e,this.array[this.index+1]=t}function ft(e,t,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=i}function mt(e,t,i,n){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=i,this.array[this.index+3]=n}function vt(e,t,i){this.array[e]=t[i]}function gt(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1]}function _t(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1],this.array[e+2]=t[i+2]}function yt(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1],this.array[e+2]=t[i+2],this.array[e+3]=t[i+3]}function bt(e,t,i){t[i]=this.array[e]}function xt(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1]}function Mt(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1],t[i+2]=this.array[e+2]}function St(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1],t[i+2]=this.array[e+2],t[i+3]=this.array[e+3]}ut._defaultInstancingFormat=null;var wt=function(){function e(e,t,i){switch(this.index=0,this.numComponents=t.numComponents,i.interleaved?this.array=new at[t.dataType](e,t.offset):this.array=new at[t.dataType](e,t.offset,i.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=dt,this.getToArray=bt,this.setFromArray=vt;break;case 2:this.set=pt,this.getToArray=xt,this.setFromArray=gt;break;case 3:this.set=ft,this.getToArray=Mt,this.setFromArray=_t;break;case 4:this.set=mt,this.getToArray=St,this.setFromArray=yt}}var t=e.prototype;return t.get=function(e){return this.array[this.index+e]},t.set=function(e,t,i,n){},t.getToArray=function(e,t,i){},t.setFromArray=function(e,t,i){},e}(),Ct=function(){function e(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};for(var t=this.vertexBuffer.getFormat(),i=0;i<t.elements.length;i++){var n=t.elements[i];this.accessors[i]=new wt(this.buffer,n,t),this.element[n.name]=this.accessors[i]}}var t=e.prototype;return t.next=function(e){void 0===e&&(e=1);for(var t=0,i=this.accessors,n=this.accessors.length;t<n;){var a=i[t++];a.index+=e*a.stride}},t.end=function(){this.vertexBuffer.unlock(),this.vertexBuffer=null},t.writeData=function(e,t,i){var n=this.element[e];if(n){i>this.vertexBuffer.numVertices&&(i=this.vertexBuffer.numVertices);var a=n.numComponents;if(this.vertexBuffer.getFormat().interleaved)for(var s=0,r=0;r<i;r++)n.setFromArray(s,t,r*a),s+=n.stride;else if(t.length>i*a){var o=i*a;if(ArrayBuffer.isView(t))t=t.subarray(0,o),n.array.set(t);else for(var l=0;l<o;l++)n.array[l]=t[l]}else n.array.set(t)}},t.readData=function(e,t){var i=this.element[e],n=0;if(i){var a;n=this.vertexBuffer.numVertices;var s=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0);var r=i.index=0;for(a=0;a<n;a++)i.getToArray(r,t,a*s),r+=i.stride}else if(ArrayBuffer.isView(t))t.set(i.array);else{var o=n*s;for(a=t.length=0;a<o;a++)t[a]=i.array[a]}}return n},e}(),Pt=null,Tt={type:5,base:0,count:4,indexed:!1};function At(e,t,i,n,a,s){if(void 0===s&&(s=!1),null===Pt){var r=new ut(e,[{semantic:Te,components:2,type:6}]);Pt=new ht(e,r,4);var o=new Ct(Pt);o.element.POSITION.set(-1,-1),o.next(),o.element.POSITION.set(1,-1),o.next(),o.element.POSITION.set(-1,1),o.next(),o.element.POSITION.set(1,1),o.end()}var l,h,c,u,d,p,f,m,v=e.renderTarget;e.setRenderTarget(t),e.updateBegin(),n?(l=n.x,h=n.y,c=n.z,u=n.w):(c=t?t.width:e.width,u=t?t.height:e.height,h=l=0),a?(d=a.x,p=a.y,f=a.z,m=a.w):(d=l,p=h,f=c,m=u);var g=e.vx,_=e.vy,y=e.vw,b=e.vh;e.setViewport(l,h,c,u);var x=e.sx,M=e.sy,S=e.sw,w=e.sh;e.setScissor(d,p,f,m);var C=e.getDepthTest(),P=e.getDepthWrite(),T=e.getCullMode(),A=e.writeRed,E=e.writeGreen,R=e.writeBlue,D=e.writeAlpha;e.setDepthTest(!1),e.setDepthWrite(!1),e.setCullMode(0),e.setColorWrite(!0,!0,!0,!0),s||e.setBlending(!1),e.setVertexBuffer(Pt,0),e.setShader(i),e.draw(Tt),e.setDepthTest(C),e.setDepthWrite(P),e.setCullMode(T),e.setColorWrite(A,E,R,D),e.updateEnd(),e.setRenderTarget(v),e.updateBegin(),e.setViewport(g,_,y,b),e.setScissor(x,M,S,w)}var Et=function(){function e(e,t){this.device=e,this.definition=t,this.init(),this.device.createShader(this)}var t=e.prototype;return t.init=function(){this.attributes=[],this.uniforms=[],this.samplers=[],this.ready=!1,this.failed=!1},t.destroy=function(){this.device.destroyShader(this)},t.loseContext=function(){this.init()},e}(),Rt={cubemapPS:"attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nvarying vec3 WorldPos;\nvoid main(void) {\n\tmat4 view = matrix_view;\n\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\tWorldPos = aPosition;\n}\n",irradianceMapVS:"\nvarying vec3 WorldPos;\nuniform samplerCube texture_cubeMap;\nuniform vec3 flag;\nuniform vec3 up;\nconst float PI = 3.14159265359;\nvoid main()\n{\n\tvec3 N = normalize(flag * WorldPos);\n\tvec3 irradiance = vec3(0.0);\n\tvec3 up = up;\n\tvec3 right = normalize(cross(up, N));\n\tup\t\t = normalize(cross(N, right));\n\tconst float sampleDelta = 0.025;\n\tfloat nrSamples = 0.0;\n\tfor(float phi = 0.0; phi < 2.0 * PI; phi += sampleDelta)\n\t{\n\t\tfor(float theta = 0.0; theta < 0.5 * PI; theta += sampleDelta)\n\t\t{\n\t\t\tvec3 tangentSample = vec3(sin(theta) * cos(phi),  sin(theta) * sin(phi), cos(theta));\n\t\t\tvec3 sampleVec = tangentSample.x * right + tangentSample.y * up + tangentSample.z * N;\n\t\t\tirradiance += $textureCubeSAMPLE(texture_cubeMap, sampleVec).rgb * cos(theta) * sin(theta);\n\t\t\tnrSamples++;\n\t\t}\n\t}\n\tirradiance = PI * irradiance * (1.0 / nrSamples);\n\tgl_FragColor = vec4(irradiance, 1.0);\n}\n",prefilterMapPS:"\n#ifndef GL2\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nvarying vec3 WorldPos;\nuniform samplerCube texture_cubeMap;\nuniform float roughness;\nfloat PI = 3.14159265359;\nfloat DistributionGGX(vec3 N, vec3 H, float roughness)\n{\n\tfloat a = roughness*roughness;\n\tfloat a2 = a*a;\n\tfloat NdotH = max(dot(N, H), 0.0);\n\tfloat NdotH2 = NdotH*NdotH;\n\tfloat nom   = a2;\n\tfloat denom = (NdotH2 * (a2 - 1.0) + 1.0);\n\tdenom = PI * denom * denom;\n\treturn nom / denom;\n}\nfloat VanDerCorpus(int n, int base)\n{\n\tfloat invBase = 1.0 / float(base);\n\tfloat denom   = 1.0;\n\tfloat result  = 0.0;\n\tfor(int i = 0; i < 32; ++i)\n\t{\n\t\tif(n > 0)\n\t\t{\n\t\t\tdenom   = mod(float(n), 2.0);\n\t\t\tresult += denom * invBase;\n\t\t\tinvBase = invBase / 2.0;\n\t\t\tn\t   = int(float(n) / 2.0);\n\t\t}\n\t}\n\treturn result;\n}\nvec2 Hammersley(int i, int N)\n{\n\treturn vec2(float(i)/float(N), VanDerCorpus(i, 2));\n}\nvec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness)\n{\n\tfloat a = roughness*roughness;\n\tfloat phi = 2.0 * PI * Xi.x;\n\tfloat cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a*a - 1.0) * Xi.y));\n\tfloat sinTheta = sqrt(1.0 - cosTheta*cosTheta);\n\tvec3 H;\n\tH.x = cos(phi) * sinTheta;\n\tH.y = sin(phi) * sinTheta;\n\tH.z = cosTheta;\n\tvec3 up\t\t  = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);\n\tvec3 tangent   = normalize(cross(up, N));\n\tvec3 bitangent = cross(N, tangent);\n\tvec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;\n\treturn normalize(sampleVec);\n}\nvoid main()\n{\n\tvec3 N = normalize(WorldPos);\n\tvec3 R = N;\n\tvec3 V = R;\n\tconst int SAMPLE_COUNT = 1024;\n\tvec3 prefilteredColor = vec3(0.0);\n\tfloat totalWeight = 0.0;\n\tfor(int i = 0; i < SAMPLE_COUNT; ++i)\n\t{\n\t\tvec2 Xi = Hammersley(i, SAMPLE_COUNT);\n\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);\n\t\tvec3 L  = normalize(2.0 * dot(V, H) * H - V);\n\t\tfloat NdotL = max(dot(N, L), 0.0);\n\t\tif(NdotL > 0.0)\n\t\t{\n\t\t\tfloat D   = DistributionGGX(N, H, roughness);\n\t\t\tfloat NdotH = max(dot(N, H), 0.0);\n\t\t\tfloat HdotV = max(dot(H, V), 0.0);\n\t\t\tfloat pdf = D * NdotH / (4.0 * HdotV) + 0.0001;\n\t\t\tfloat resolution = 512.0;\n\t\t\tfloat saTexel  = 4.0 * PI / (6.0 * resolution * resolution);\n\t\t\tfloat saSample = 1.0 / (float(SAMPLE_COUNT) * pdf + 0.0001);\n\t\t\tfloat mipLevel = roughness == 0.0 ? 0.0 : 0.5 * log2(saSample / saTexel);\n\t\t\tprefilteredColor += decodeRGBM( textureCubeLodEXT(texture_cubeMap, L, mipLevel) ).rgb * NdotL;\n\t\t\ttotalWeight\t  += NdotL;\n\t\t}\n\t}\n\tprefilteredColor = prefilteredColor / totalWeight;\n\tgl_FragColor = vec4(prefilteredColor, 1.0);\n}\n",prefilterPBRPS:"\n#ifndef GL2\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nuniform float roughness;\nfloat DistributionGGX(vec3 N, vec3 H, float roughness)\n{\n\tfloat a = roughness*roughness;\n\tfloat a2 = a*a;\n\tfloat NdotH = max(dot(N, H), 0.0);\n\tfloat NdotH2 = NdotH*NdotH;\n\tfloat nom   = a2;\n\tfloat denom = (NdotH2 * (a2 - 1.0) + 1.0);\n\tdenom = PI * denom * denom;\n\treturn nom / denom;\n}\nfloat VanDerCorpus(int n, int base)\n{\n\tfloat invBase = 1.0 / float(base);\n\tfloat denom   = 1.0;\n\tfloat result  = 0.0;\n\tfor(int i = 0; i < 32; ++i)\n\t{\n\t\tif(n > 0)\n\t\t{\n\t\t\tdenom   = mod(float(n), 2.0);\n\t\t\tresult += denom * invBase;\n\t\t\tinvBase = invBase / 2.0;\n\t\t\tn\t   = int(float(n) / 2.0);\n\t\t}\n\t}\n\treturn result;\n}\nvec2 Hammersley(int i, int N)\n{\n\treturn vec2(float(i)/float(N), VanDerCorpus(i, 2));\n}\nvec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness)\n{\n\tfloat a = roughness*roughness;\n\tfloat phi = 2.0 * PI * Xi.x;\n\tfloat cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a*a - 1.0) * Xi.y));\n\tfloat sinTheta = sqrt(1.0 - cosTheta*cosTheta);\n\tvec3 H;\n\tH.x = cos(phi) * sinTheta;\n\tH.y = sin(phi) * sinTheta;\n\tH.z = cosTheta;\n\tvec3 up\t\t  = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);\n\tvec3 tangent   = normalize(cross(up, N));\n\tvec3 bitangent = cross(N, tangent);\n\tvec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;\n\treturn normalize(sampleVec);\n}\nvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\t#ifdef REPROJECT_CUBEMAP_ROTATION\n\t\tdir = dir * reprojectCubeMapRotationMatrix;\n\t#endif\n\tvec2 sph = toSpherical(dir);\n\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n}\nvec4 sampleCubemap(vec3 dir, float mipLevel) {\n\t#ifdef REPROJECT_CUBEMAP_ROTATION\n\t\tdir = dir * reprojectCubeMapRotationMatrix;\n\t#endif\n\treturn textureCubeLodEXT(sourceCube, modifySeams(dir, sourceCubeSeamScale()), mipLevel);\n}\nvec3 prefilterPBR(vec3 WorldPos) {\n\tvec3 N = normalize(WorldPos);\n\tvec3 R = N;\n\tvec3 V = R;\n\tconst int SAMPLE_COUNT = 1024;\n\tvec3 prefilteredColor = vec3(0.0);\n\tfloat totalWeight = 0.0;\n\tfor(int i = 0; i < SAMPLE_COUNT; ++i)\n\t{\n\t\tvec2 Xi = Hammersley(i, SAMPLE_COUNT);\n\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);\n\t\tvec3 L  = normalize(2.0 * dot(V, H) * H - V);\n\t\tfloat NdotL = max(dot(N, L), 0.0);\n\t\tif(NdotL > 0.0)\n\t\t{\n\t\t\tfloat D   = DistributionGGX(N, H, roughness);\n\t\t\tfloat NdotH = max(dot(N, H), 0.0);\n\t\t\tfloat HdotV = max(dot(H, V), 0.0);\n\t\t\tfloat pdf = D * NdotH / (4.0 * HdotV) + 0.0001;\n\t\t\tfloat resolution = 512.0;\n\t\t\tfloat saTexel  = 4.0 * PI / (6.0 * resolution * resolution);\n\t\t\tfloat saSample = 1.0 / (float(SAMPLE_COUNT) * pdf + 0.0001);\n\t\t\tfloat mipLevel = roughness == 0.0 ? 0.0 : 0.5 * log2(saSample / saTexel);\n\t\t\tprefilteredColor += DECODE_FUNC( SOURCE_FUNC(L, mipLevel) ).rgb * NdotL;\n\t\t\ttotalWeight\t  += NdotL;\n\t\t}\n\t}\n\tprefilteredColor = prefilteredColor / totalWeight;\n\treturn prefilteredColor;\n}\n",reflectionPrefilterPBRPS:"uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvec3 calcPrefilterReflection(vec3 refl, float roughness) {\n\t#ifdef PBR_MAPS_LOADED\n\t\tvec4 c0 = textureCube(texture_prefilteredCubeMap128, refl);\n\t\tvec4 c1 = textureCube(texture_prefilteredCubeMap64, refl);\n\t\tvec4 c2 = textureCube(texture_prefilteredCubeMap32, refl);\n\t\tvec4 c3 = textureCube(texture_prefilteredCubeMap16, refl);\n\t\tvec4 c4 = textureCube(texture_prefilteredCubeMap8, refl);\n\t\tvec4 c5 = textureCube(texture_prefilteredCubeMap4, refl);\n\t\tfloat bias = roughness * 4.0;\n\t\tvec4 cubes0;\n\t\tvec4 cubes1;\n\t\tif(bias < 1.0) {\n\t\t\tcubes0 = c0;\n\t\t\tcubes1 = c1;\n\t\t} else if(bias < 2.0) {\n\t\t\tcubes0 = c1;\n\t\t\tcubes1 = c2;\n\t\t} else if(bias < 3.0) {\n\t\t\tcubes0 = c2;\n\t\t\tcubes1 = c3;\n\t\t} else if (bias < 4.0) {\n\t\t\tcubes0 = c3;\n\t\t\tcubes1 = c4;\n\t\t} else {\n\t\t\tcubes0 = c4;\n\t\t\tcubes1 = c5;\n\t\t}\n\t\tvec4 cubeFinal = mix(cubes0, cubes1, fract(bias));\n\t\treturn processEnvironment($DECODE(cubeFinal).rgb);\n\t#else\n\t\treturn vec3(1.0);\n\t#endif\n}\n",indirectLightPS:"\nvec3 evaluateSpecularIBL(float roughness, vec3 F, vec3 F0, vec3 N, vec3 V, vec3 R, float NdotV) {\n\t#ifdef GL2\n\t\tvec3 prefilteredColor = calcPrefilterReflection(R, roughness);\n\t#else\n\t\tvec3 prefilteredColor = calcPrefilterReflection(R, roughness);\n\t#endif\n\tvec2 brdf = integrateSpecularBRDF(NdotV , roughness);\n\tvec3 envSpecBRDFs = F * brdf.x + brdf.y;\n\treturn prefilteredColor * envSpecBRDFs;\n}\n",brdfPS:"#define MEDIUMP_FLT_MAX\t65504.0\n#define saturate(x)\t\tclamp(x, 0.0, 1.0)\n#ifdef TARGET_MOBILE\n#define FLT_EPS\t\t\tMEDIUMP_FLT_MIN\n#define saturateMediump(x) min(x, MEDIUMP_FLT_MAX)\n#else\n#define FLT_EPS\t\t\t1e-5\n#define saturateMediump(x) x\n#endif\n#define IBL_INTEGRATION_IMPORTANCE_SAMPLING_COUNT   64\nconst float PI = 3.14159265359;\nconst float RECIPROCAL_PI = 0.3183098861837907;\nfloat pow5(float x) {\n\tfloat x2 = x * x;\n\treturn x2 * x2 * x;\n}\nfloat VanDerCorpus(int n, int base)\n{\n\tfloat invBase = 1.0 / float(base);\n\tfloat denom   = 1.0;\n\tfloat result  = 0.0;\n\tfor(int i = 0; i < 32; ++i)\n\t{\n\t\tif(n > 0)\n\t\t{\n\t\t\tdenom   = mod(float(n), 2.0);\n\t\t\tresult += denom * invBase;\n\t\t\tinvBase = invBase / 2.0;\n\t\t\tn\t   = int(float(n) / 2.0);\n\t\t}\n\t}\n\treturn result;\n}\nvec2 Hammersley(int i, int N)\n{\n\treturn vec2(float(i)/float(N), VanDerCorpus(i, 2));\n}\nfloat DistributionGGX(vec3 N, vec3 H, float roughness)\n{\n\tfloat a = roughness*roughness;\n\tfloat a2 = a*a;\n\tfloat NdotH = max(dot(N, H), 0.0);\n\tfloat NdotH2 = NdotH*NdotH;\n\tfloat nom   = a2;\n\tfloat denom = (NdotH2 * (a2 - 1.0) + 1.0);\n\tdenom = PI * denom * denom;\n\treturn nom / denom;\n}\nfloat GeometrySchlickGGX(float NdotV, float roughness)\n{\n\tfloat a = roughness;\n\tfloat k = (a * a) / 2.0;\n\tfloat nom   = NdotV;\n\tfloat denom = NdotV * (1.0 - k) + k;\n\treturn nom / denom;\n}\nfloat GeometrySmith(vec3 N, vec3 V, vec3 L, float roughness)\n{\n\tfloat NdotV = max(dot(N, V), 0.0);\n\tfloat NdotL = max(dot(N, L), 0.0);\n\tfloat ggx2 = GeometrySchlickGGX(NdotV, roughness);\n\tfloat ggx1 = GeometrySchlickGGX(NdotL, roughness);\n\treturn ggx1 * ggx2;\n}\nvec3 fresnelSchlick(float cosTheta, vec3 F0)\n{\n\treturn F0 + (1.0 - F0) * pow(max(1.0 - cosTheta, 0.0), 5.0);\n}\nvec3 fresnelSchlickRoughness(float cosTheta, vec3 F0, float roughness)\n{\n\treturn F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(max(1.0 - cosTheta, 0.0), 5.0);\n}\nvec2 integrateSpecularBRDF( const float dotNV, const float roughness ) {\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\treturn vec2( -1.04, 1.04 ) * a004 + r.zw;\n}\n",brdfLUTVS:"attribute vec3 aPosition;\nattribute vec2 aTexCoords;\nvarying vec2 TexCoords;\nvoid main()\n{\n\tTexCoords = aTexCoords;\n\tgl_Position = vec4(aPosition, 1.0);\n}\n",brdfLUTPS:"varying vec2 TexCoords;\nvec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness)\n{\n\tfloat a = roughness * roughness;\n\tfloat phi = 2.0 * PI * Xi.x;\n\tfloat cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a*a - 1.0) * Xi.y));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 H;\n\tH.x = cos(phi) * sinTheta;\n\tH.y = sin(phi) * sinTheta;\n\tH.z = cosTheta;\n\tvec3 up = abs(N.z) < 0.999 ? vec3 (0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);\n\tvec3 tangent = normalize(cross(up, N));\n\tvec3 bitangent = cross(N, tangent);\n\tvec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;\n\treturn normalize(sampleVec);\n}\nvec2 IntegrateBRDF(float NdotV, float roughness)\n{\n\tvec3 V;\n\tV.x = sqrt(1.0 - NdotV*NdotV);\n\tV.y = 0.0;\n\tV.z = NdotV;\n\tfloat A = 0.0;\n\tfloat B = 0.0;\n\tvec3 N = vec3(0.0, 0.0, 1.0);\n\tconst int SAMPLE_COUNT = 1024;\n\tfor(int i = 0; i < SAMPLE_COUNT; ++i)\n\t{\n\t\tvec2 Xi = Hammersley(i, SAMPLE_COUNT);\n\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);\n\t\tvec3 L = normalize(2.0 * dot(V, H) * H - V);\n\t\tfloat NdotL = max(L.z, 0.0);\n\t\tfloat NdotH = max(H.z, 0.0);\n\t\tfloat VdotH = max(dot(V, H), 0.0);\n\t\tif(NdotL > 0.0)\n\t\t{\n\t\t\tfloat G = GeometrySmith(N, V, L, roughness);\n\t\t\tfloat G_Vis = (G * VdotH) / (NdotH * NdotV);\n\t\t\tfloat Fc = pow(1.0 - VdotH, 5.0);\n\t\t\tA += (1.0 - Fc) * G_Vis;\n\t\t\tB += Fc * G_Vis;\n\t\t}\n\t}\n\tA /= float(SAMPLE_COUNT);\n\tB /= float(SAMPLE_COUNT);\n\treturn vec2(A, B);\n}\nvoid main()\n{\n\tvec2 integratedBRDF = IntegrateBRDF(TexCoords.x, TexCoords.y);\n\tgl_FragColor = vec4(integratedBRDF, 0.0, 0.0);\n}\n",tonemappingPBRPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",gammaPBRPS:"vec3 gammaCorrectInput(vec3 color) {\n\treturn pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n\treturn pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\tcolor += vec3(0.0000001);\n\treturn pow(color, vec3(1.0 / 2.2));\n}\n",transmissionPS:"#ifdef USE_TRANSMISSION\n\tfloat transmissionAlpha = 1.0;\n\tvec3 n = inverseTransformDirection( vNormalW, matrix_view );\n\tvec4 transmission = dTransmission * getIBLVolumeRefraction(\n\t\tn, dViewDirW, roughness,\n\t\talbedo * (vec3(1.0) + material_diffuseTransmission),\n\t\tspecular, ior, dThickness,\n\t\tattenuationColor, attenuationDistance );\n\tfloat w = (material_specularTransmission.r + material_specularTransmission.g + material_specularTransmission.b) / 3.0;\n\tdiffuse = mix( diffuse, transmission.rgb * material_specularTransmission, dTransmission * w);\n\ttransmissionAlpha = mix( transmissionAlpha, transmission.a, dTransmission );\n\tdAlpha *= transmissionAlpha + 0.1;\n#endif\n",transmissionParsPS:"\n#ifdef MAPFLOAT\n\tuniform float material_transmission;\n#endif\n#ifdef MAPTEXTURE\n\tuniform sampler2D texture_transmissionMap;\n\tuniform float transmissionMapRadian;\n\tuniform int transmissionMapReverseMode;\n\tuniform int transmissionMapTilingMode;\n\tbool transmissionMapClampToBorder=false;\n\t#ifdef transmissionMapMappingEnabled\n\t\tuniform int transmissionMapMappingType;\n\t\tuniform vec2 transmissionMapTiling;\n\t\tuniform vec2 transmissionMapOffset;\n\t\tuniform mat4 transmissionMapMappingMatrix;\n\t\tuniform vec3 transmissionMapPlaneMappingCameraFront;\n\t\tuniform vec3 transmissionMapGizmoPlanePosWS;\n\t\tuniform float transmissionMapPlaneMappingDepth;\n\t#endif\n#endif\nvoid getTransmission() {\n\tdTransmission = 1.0;\n\t#ifdef MAPFLOAT\n\tdTransmission *= material_transmission;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef transmissionMapMappingEnabled\n\tvec2 gUV=GetUV(transmissionMapMappingType,$UV,transmissionMapClampToBorder,transmissionMapMappingMatrix,transmissionMapTiling,transmissionMapOffset,transmissionMapRadian,transmissionMapReverseMode,transmissionMapTilingMode,transmissionMapPlaneMappingCameraFront,transmissionMapGizmoPlanePosWS,transmissionMapPlaneMappingDepth);\n\t#else\n\tvec2 gUV=GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),transmissionMapClampToBorder,vec2(1.0),vec2(0.0),transmissionMapRadian,transmissionMapReverseMode,transmissionMapTilingMode);\n\t#endif\n\tif(!transmissionMapClampToBorder)\n\t\tdTransmission *= texture2D(texture_transmissionMap,gUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdTransmission *= saturate(vVertexColor.$VC);\n\t#endif\n}\n#ifndef GL2\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nuniform vec3 attenuationColor;\nuniform float attenuationDistance;\nuniform float ior;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\n\tuniform mat4 matrix_view;\n#endif\nuniform vec2 transmissionSamplerSize;\nuniform sampler2D transmissionSamplerMap;\nvec3 getVolumeTransmissionRay(vec3 n, vec3 v, float thickness, float ior, mat4 modelMatrix) {\n\tvec3 refractionVector = refract(-v, normalize(n), 1.0 / ior);\n\tvec3 modelScale;\n\tmodelScale.x = length(vec3(modelMatrix[0].xyz));\n\tmodelScale.y = length(vec3(modelMatrix[1].xyz));\n\tmodelScale.z = length(vec3(modelMatrix[2].xyz));\n\treturn normalize(refractionVector) * thickness * modelScale;\n}\nfloat applyIorToRoughness(float roughness, float ior) {\n\treturn roughness * clamp(ior * 2.0 - 2.0, 0.0, 1.0);\n}\nvec4 getTransmissionSample(vec2 fragCoord, float roughness, float ior) {\n\tfloat framebufferLod = log2(transmissionSamplerSize.x) * applyIorToRoughness(roughness, ior);\n\treturn texture2DLodEXT(transmissionSamplerMap, fragCoord.xy, framebufferLod);\n}\nvec3 applyVolumeAttenuation(vec3 radiance, float transmissionDistance, vec3 attenuationColor, float attenuationDistance) {\n\tif(attenuationDistance == 0.0) {\n\t\treturn radiance;\n\t} else {\n\t\tvec3 attenuationCoefficient = -log(attenuationColor) / attenuationDistance;\n\t\tvec3 transmittance = exp(-attenuationCoefficient * transmissionDistance);\n\t\treturn transmittance * radiance;\n\t}\n}\nvec4 getIBLVolumeRefraction(vec3 n, vec3 v, float perceptualRoughness, vec3 baseColor, vec3 specularColor, float ior, float thickness, vec3 attenuationColor, float attenuationDistance) {\n\tvec3 transmissionRay = getVolumeTransmissionRay(n, v, thickness, ior, matrix_model);\n\tvec3 refractedRayExit = vPositionW + transmissionRay;\n\tvec4 ndcPos = matrix_viewProjection * vec4(refractedRayExit, 1.0);\n\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\trefractionCoords += 1.0;\n\trefractionCoords /= 2.0;\n\tvec4 transmittedLight = getTransmissionSample(refractionCoords, perceptualRoughness, ior);\n\ttransmittedLight = clamp(pow(transmittedLight, vec4(2.2)), 0.0, 1.0);\n\tvec3 attenuatedColor = applyVolumeAttenuation(transmittedLight.rgb, length(transmissionRay), attenuationColor, attenuationDistance);\n\treturn vec4((1.0 - specularColor) * attenuatedColor * baseColor, transmittedLight.a);\n}\nvec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {\n\treturn normalize((vec4(dir, 0.0) * matrix).xyz);\n}\n",PBRParsPS:"uniform vec3 subsurfaceColor;\n",PBRFactorsPS:"\n",roughnessPS:"#ifdef MAPFLOAT\nuniform float material_roughness;\n#endif\n#ifdef MAPTEXTURE\n\tuniform sampler2D texture_roughnessMap;\n\tuniform float roughnessMapRadian;\n\tuniform int roughnessMapReverseMode;\n\tuniform int roughnessMapTilingMode;\n\tbool roughnessMapClampToBorder=false;\n\t#ifdef roughnessMapMappingEnabled\n\t\tuniform int roughnessMapMappingType;\n\t\tuniform vec2 roughnessMapTiling;\n\t\tuniform vec2 roughnessMapOffset;\n\t\tuniform mat4 roughnessMapMappingMatrix;\n\t\tuniform vec3 roughnessMapPlaneMappingCameraFront;\n\t\tuniform vec3 roughnessMapGizmoPlanePosWS;\n\t\tuniform float roughnessMapPlaneMappingDepth;\n\t#endif\n#endif\nvoid getRoughness() {\n\tdRoughness = 1.0;\n\t#ifdef MAPFLOAT\n\tdRoughness *= material_roughness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t\t#ifdef roughnessMapMappingEnabled\n\t\t\tvec2 gUV=GetUV(roughnessMapMappingType,$UV,roughnessMapClampToBorder,roughnessMapMappingMatrix,roughnessMapTiling,roughnessMapOffset,roughnessMapRadian,roughnessMapReverseMode,roughnessMapTilingMode,roughnessMapPlaneMappingCameraFront,roughnessMapGizmoPlanePosWS,roughnessMapPlaneMappingDepth);\n\t\t#else\n\t\t\tvec2 gUV=GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),roughnessMapClampToBorder,vec2(1.0),vec2(0.0),roughnessMapRadian,roughnessMapReverseMode,roughnessMapTilingMode);\n\t\t#endif\n\t\tif(!roughnessMapClampToBorder)\n\t\t\tdRoughness *= texture2D(texture_roughnessMap,gUV).$CH;\n\t#endif\n\t#ifdef SAMPLE_METALLNESS_MAP\n\t\tvec2 gUV=GetUV_Uv0Uv1(vec4(METALNESS_UV, 0.0, 0.0), metalnessMapClampToBorder, vec2(1.0), vec2(0.0), metalnessMapRadian, metalnessMapReverseMode, metalnessMapTilingMode);\n\t\tdRoughness *= texture2D(texture_metalnessMap,gUV).g;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdRoughness *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",thicknessPS:"#ifdef MAPFLOAT\nuniform float material_thickness;\n#endif\n#ifdef MAPTEXTURE\n\tuniform sampler2D texture_thicknessMap;\n\tuniform float thicknessMapRadian;\n\tuniform int thicknessMapReverseMode;\n\tuniform int thicknessMapTilingMode;\n\tbool thicknessMapClampToBorder=false;\n\t#ifdef thicknessMapMappingEnabled\n\t\tuniform int thicknessMapMappingType;\n\t\tuniform vec2 thicknessMapTiling;\n\t\tuniform vec2 thicknessMapOffset;\n\t\tuniform mat4 thicknessMapMappingMatrix;\n\t\tuniform vec3 thicknessMapPlaneMappingCameraFront;\n\t\tuniform vec3 thicknessMapGizmoPlanePosWS;\n\t\tuniform float thicknessMapPlaneMappingDepth;\n\t#endif\n#endif\nvoid getThickness() {\n\tdThickness = 1.0;\n\t#ifdef MAPFLOAT\n\tdThickness *= material_thickness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef thicknessMapMappingEnabled\n\tvec2 gUV=GetUV(thicknessMapMappingType,$UV,thicknessMapClampToBorder,thicknessMapMappingMatrix,thicknessMapTiling,thicknessMapOffset,thicknessMapRadian,thicknessMapReverseMode,thicknessMapTilingMode,thicknessMapPlaneMappingCameraFront,thicknessMapGizmoPlanePosWS,thicknessMapPlaneMappingDepth);\n\t#else\n\tvec2 gUV=GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),thicknessMapClampToBorder,vec2(1.0),vec2(0.0),thicknessMapRadian,thicknessMapReverseMode,thicknessMapTilingMode);\n\t#endif\n\tif(!thicknessMapClampToBorder)\n\t\tdThickness *= texture2D(texture_thicknessMap,gUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdThickness *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",diffuseTransmissionPS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuseTransmission;\n#endif\n#ifdef MAPTEXTURE\n\tuniform sampler2D texture_diffuseTransmissionMap;\n\tuniform float diffuseTransmissionMapRadian;\n\tuniform int diffuseTransmissionMapReverseMode;\n\tuniform int diffuseTransmissionMapTilingMode;\n\tbool diffuseTransmissionMapClampToBorder=false;\n\t#ifdef diffuseTransmissionMapMappingEnabled\n\t\tuniform int diffuseTransmissionMapMappingType;\n\t\tuniform vec2 diffuseTransmissionMapTiling;\n\t\tuniform vec2 diffuseTransmissionMapOffset;\n\t\tuniform mat4 diffuseTransmissionMapMappingMatrix;\n\t\tuniform vec3 diffuseTransmissionMapPlaneMappingCameraFront;\n\t\tuniform vec3 diffuseTransmissionMapGizmoPlanePosWS;\n\t\tuniform float diffuseTransmissionMapPlaneMappingDepth;\n\t#endif\n#endif\nvoid getDiffuseTransmission() {\n\tdDiffuseTransmission = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdDiffuseTransmission *= material_diffuseTransmission;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef diffuseTransmissionMapMappingEnabled\n\tvec2 gUV=GetUV(diffuseTransmissionMapMappingType,$UV,diffuseTransmissionMapClampToBorder,diffuseTransmissionMapMappingMatrix,diffuseTransmissionMapTiling,diffuseTransmissionMapOffset,diffuseTransmissionMapRadian,diffuseTransmissionMapReverseMode,diffuseTransmissionMapTilingMode,diffuseTransmissionMapPlaneMappingCameraFront,diffuseTransmissionMapGizmoPlanePosWS,diffuseTransmissionMapPlaneMappingDepth);\n\t#else\n\tvec2 gUV=GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),diffuseTransmissionMapClampToBorder,vec2(1.0),vec2(0.0),diffuseTransmissionMapRadian,diffuseTransmissionMapReverseMode,diffuseTransmissionMapTilingMode);\n\t#endif\n\tif(!diffuseTransmissionMapClampToBorder)\n\t\tdDiffuseTransmission *= texture2D(texture_diffuseTransmissionMap,gUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdDiffuseTransmission *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",specularTransmissionPS:"#ifdef MAPCOLOR\nuniform vec3 material_specularTransmission;\n#endif\n#ifdef MAPTEXTURE\n\tuniform sampler2D texture_specularTransmissionMap;\n\tuniform float specularTransmissionMapRadian;\n\tuniform int specularTransmissionMapReverseMode;\n\tuniform int specularTransmissionMapTilingMode;\n\tbool specularTransmissionMapClampToBorder=false;\n\t#ifdef specularTransmissionMapMappingEnabled\n\t\tuniform int specularTransmissionMapMappingType;\n\t\tuniform vec2 specularTransmissionMapTiling;\n\t\tuniform vec2 specularTransmissionMapOffset;\n\t\tuniform mat4 specularTransmissionMapMappingMatrix;\n\t\tuniform vec3 specularTransmissionMapPlaneMappingCameraFront;\n\t\tuniform vec3 specularTransmissionMapGizmoPlanePosWS;\n\t\tuniform float specularTransmissionMapPlaneMappingDepth;\n\t#endif\n#endif\nvoid getSpecularTransmission() {\n\tdSpecularTransmission = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdSpecularTransmission *= material_specularTransmission;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef specularTransmissionMapMappingEnabled\n\tvec2 gUV=GetUV(specularTransmissionMapMappingType,$UV,specularTransmissionMapClampToBorder,specularTransmissionMapMappingMatrix,specularTransmissionMapTiling,specularTransmissionMapOffset,specularTransmissionMapRadian,specularTransmissionMapReverseMode,specularTransmissionMapTilingMode,specularTransmissionMapPlaneMappingCameraFront,specularTransmissionMapGizmoPlanePosWS,specularTransmissionMapPlaneMappingDepth);\n\t#else\n\tvec2 gUV=GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),specularTransmissionMapClampToBorder,vec2(1.0),vec2(0.0),specularTransmissionMapRadian,specularTransmissionMapReverseMode,specularTransmissionMapTilingMode);\n\t#endif\n\tif(!specularTransmissionMapClampToBorder)\n\t\tdSpecularTransmission *= texture2D(texture_specularTransmissionMap,gUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdSpecularTransmission *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",outputAlphaWBOITPS:"\ngl_FragColor *= dAlpha;\ngl_FragColor.a = dAlpha;\n",accumPS:"\ngl_FragColor.rgb *= dAlpha;\nfloat w = weight(gl_FragCoord.z, dAlpha);\nvec4 accumColor = vec4(0.0);\nif (accumAlpha) {\n\taccumColor = vec4(dAlpha * w, 0.0, 0.0, 1.0);\n} else {\n\taccumColor = vec4(gl_FragColor.rgb * w, dAlpha);\n}\nivec2 fragCoord = ivec2(gl_FragCoord.xy);\nfloat dep = texelFetch(uOpaqueDepth, fragCoord, 0).r;\nif (gl_FragCoord.z > dep)\n\tdiscard;\ngl_FragColor = accumColor;\n",accumDrawPS:"#ifdef WBOIT\n#ifdef GL2\nivec2 fragCoord = ivec2(gl_FragCoord.xy);\nvec4 accum = texelFetch(uAccumulate, fragCoord, 0);\ndAlpha = 1.0 - accum.a;\naccum.a = texelFetch(uAccumulateAlpha, fragCoord, 0).r;\n#else\nvec2 fragCoord = gl_FragCoord.xy / uResolution;\nvec4 accum = texture2D(uAccumulate, fragCoord);\ndAlpha = 1.0 - accum.a;\naccum.a = texture2D(uAccumulateAlpha, fragCoord).r;\n#endif\ncolor = accum.rgb / clamp(accum.a, 0.001, 50000.0);\n#endif\n",accumParsPS:"\n#ifdef WBOIT\nuniform sampler2D uAccumulate;\nuniform sampler2D uAccumulateAlpha;\nuniform sampler2D uDepthMap;\nuniform vec2 uResolution;\n#endif\n#define BLOG 1\n#define TWITTER 2\n#define MODIFIED_TWITTER 3\n#define PERCEP_PAPER 3\n#define POLY_D 4\n#define WEIGHT_FUNC BLOG\nfloat weight(float z, float a) {\n\t#if WEIGHT_FUNC == BLOG\n\t\treturn clamp(pow(min(1.0, a * 10.0) + 0.01, 3.0) * 1e8 * pow(1.0 - z * 0.9, 3.0), 1e-2, 3e3);\n\t#elif WEIGHT_FUNC == TWITTER\n\t\tfloat tmp = 1.0 - z * 0.99;\n\t\ttmp *= tmp * tmp * 1e4;\n\t\ttmp = clamp(tmp, 1e-3, 1.0);\n\t\treturn clamp(a * tmp, 1e-3, 1.5e2);\n\t#elif WEIGHT_FUNC == MODIFIED_TWITTER\n\t\tfloat tmp = 1.0 - z * 0.99;\n\t\ttmp *= tmp * tmp * 1e4;\n\t\treturn clamp(a * tmp, 1e-3, 3e4);\n\t#elif WEIGHT_FUNC == PERCEP_PAPER\n\t\tfloat tmp = 10.0 * (1.0 - 0.99 * z) * a;\n\t\tfloat tmp *= tmp * tmp;\n\t\treturn clamp(tmp, 0.01, 30.0);\n\t#elif WEIGHT_FUNC == POLY_D\n\t\tfloat d = 1.0 - z * 0.99;\n\t\tfloat d2 = d * d;\n\t\tfloat d4 = d2 * d2;\n\t\tfloat d8 = d4 * d4;\n\t\tfloat d16 = d8 * d8;\n\t\tfloat depthWeight = d + 10.0 * d2 + 1e2 * d4 + 1e5 * d16;\n\t\treturn clamp(a * depthWeight, 0.01, 1e4);\n\t#endif\n}\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#ifdef ACCUM\nuniform bool accumAlpha;\n#endif\n#ifdef DPOIT\n#define MAX_DEPTH 99999.0\nuniform sampler2D uDepth;\nuniform sampler2D uFrontColor;\nuniform int uLayout;\nlayout(location=1) out highp vec4 frontColor;\nlayout(location=2) out highp vec4 backColor;\n#endif\nuniform sampler2D uOpaqueDepth;\n",DPOITpeelingPS:"\ngl_FragColor.a = dAlpha;\nvec4 color = gl_FragColor;\nfloat fragDepth = gl_FragCoord.z;\nivec2 fragCoord = ivec2(gl_FragCoord.xy);\nfloat dep = texelFetch(uOpaqueDepth, fragCoord, 0).r;\nif (fragDepth >= dep)\n{\n\tdiscard;\n}\nvec2 lastDepth = texelFetch(uDepth, fragCoord, 0).rg;\nvec4 lastFrontColor = texelFetch(uFrontColor, fragCoord, 0);\ngl_FragColor = vec4(-MAX_DEPTH, -MAX_DEPTH, 0.0, 1.0);\nfrontColor = lastFrontColor;\nbackColor = vec4(0.0);\nfloat nearestDepth = - lastDepth.x;\nfloat furthestDepth = lastDepth.y;\nfloat alphaMultiplier = 1.0 - lastFrontColor.a;\nif (fragDepth < nearestDepth || fragDepth > furthestDepth) {\n\treturn;\n}\nif (fragDepth > nearestDepth && fragDepth < furthestDepth) {\n\tgl_FragColor.rg = vec2(-fragDepth, fragDepth);\n\treturn;\n}\nif (fragDepth == nearestDepth) {\n\tfrontColor.rgb += color.rgb * color.a * alphaMultiplier;\n\tfrontColor.a = 1.0 - alphaMultiplier * (1.0 - color.a);\n} else {\n\tbackColor += color;\n}\n",DPOITblendBackPS:"uniform sampler2D uBackColor;\nvoid main() {\n\tgl_FragColor = texelFetch(uBackColor, ivec2(gl_FragCoord.xy), 0);\n\tif(gl_FragColor.a == 0.0) {\n\t\tdiscard;\n\t}\n}\n",DPOITfinalPS:"uniform sampler2D uFrontColor;\nuniform sampler2D uBackColor;\nuniform sampler2D uTest;\nvoid main() {\n\tivec2 fragCoord = ivec2(gl_FragCoord.xy);\n\tvec4 frontColor = texelFetch(uFrontColor, fragCoord, 0);\n\tvec4 backColor = texelFetch(uBackColor, fragCoord, 0);\n\tfloat alphaMultiplier = 1.0 - frontColor.a;\n\tgl_FragColor = vec4(frontColor.rgb + alphaMultiplier * backColor.rgb, frontColor.a + backColor.a);\n\tif(gl_FragColor.a == 0.0) {\n\t\tdiscard;\n\t}\n}\n",alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"void addAmbient() {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientPrefilteredCubePS:"#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(cubeMapRotate(dNormalW), 1.0 - 1.0 / 4.0);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tdDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n",ambientPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(cubeMapRotate(dNormalW), 1.0 - 1.0 / 4.0);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tdDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n",ambientPrefilteredCubePBRPS:"uniform samplerCube irradianceMap;\nvoid addAmbient() {\n\tvec3 fixedReflDir = cubeMapProject(dReflDirW);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\t#ifdef PBR_MAPS_LOADED\n\t\tdDiffuseLight += processEnvironment( $DECODE( textureCube(irradianceMap, fixedReflDir) ));\n\t#endif\n}\n",ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n\tvec3 n = cubeMapRotate(dNormalW);\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\nuniform float aoMapRadian;\nuniform int aoMapReverseMode;\nuniform int aoMapTilingMode;\nbool aoMapClampToBorder=false;\n#ifdef aoMapMappingEnabled\nuniform int aoMapMappingType;\nuniform vec2 aoMapTiling;\nuniform vec2 aoMapOffset;\nuniform mat4 aoMapMappingMatrix;\nuniform vec3 aoMapPlaneMappingCameraFront;\nuniform vec3 aoMapGizmoPlanePosWS;\nuniform float aoMapPlaneMappingDepth;\n#endif\n#endif\nvoid applyAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\t#ifdef aoMapMappingEnabled\n\tvec2 aoUV=GetUV(aoMapMappingType,$UV,aoMapClampToBorder,aoMapMappingMatrix,aoMapTiling,aoMapOffset,aoMapRadian,aoMapReverseMode,aoMapTilingMode,aoMapPlaneMappingCameraFront,aoMapGizmoPlanePosWS,aoMapPlaneMappingDepth);\n\t#else\n\tvec2 aoUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),aoMapClampToBorder,vec2(1.0),vec2(0.0),aoMapRadian,aoMapReverseMode,aoMapTilingMode);\n\t#endif\n\tif(!aoMapClampToBorder)\n\t\tdAo *= texture2D(texture_aoMap,aoUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight *= dAo;\n}\n",aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstPS:"void occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstSimplePS:"void occludeSpecular() {\n\tfloat specOcc = dAo;\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",bakeDirLmEndPS:"\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",bakeLmEndPS:"\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n",basePS:"\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nmat4 Transpose(mat4 inMatrix) {\n\t vec4 i0 = inMatrix[0];\n\t vec4 i1 = inMatrix[1];\n\t vec4 i2 = inMatrix[2];\n\t vec4 i3 = inMatrix[3];\n\t mat4 outMatrix = mat4(\n\t\t\t\t vec4(i0.x, i1.x, i2.x, i3.x),\n\t\t\t\t vec4(i0.y, i1.y, i2.y, i3.y),\n\t\t\t\t vec4(i0.z, i1.z, i2.z, i3.z),\n\t\t\t\t vec4(i0.w, i1.w, i2.w, i3.w)\n\t\t\t\t );\n\treturn outMatrix;\n}\nmat4 Inverse(mat4 m)\n{\n\tfloat Coef00 = m[2][2] * m[3][3] - m[3][2] * m[2][3];\n\tfloat Coef02 = m[1][2] * m[3][3] - m[3][2] * m[1][3];\n\tfloat Coef03 = m[1][2] * m[2][3] - m[2][2] * m[1][3];\n\tfloat Coef04 = m[2][1] * m[3][3] - m[3][1] * m[2][3];\n\tfloat Coef06 = m[1][1] * m[3][3] - m[3][1] * m[1][3];\n\tfloat Coef07 = m[1][1] * m[2][3] - m[2][1] * m[1][3];\n\tfloat Coef08 = m[2][1] * m[3][2] - m[3][1] * m[2][2];\n\tfloat Coef10 = m[1][1] * m[3][2] - m[3][1] * m[1][2];\n\tfloat Coef11 = m[1][1] * m[2][2] - m[2][1] * m[1][2];\n\tfloat Coef12 = m[2][0] * m[3][3] - m[3][0] * m[2][3];\n\tfloat Coef14 = m[1][0] * m[3][3] - m[3][0] * m[1][3];\n\tfloat Coef15 = m[1][0] * m[2][3] - m[2][0] * m[1][3];\n\tfloat Coef16 = m[2][0] * m[3][2] - m[3][0] * m[2][2];\n\tfloat Coef18 = m[1][0] * m[3][2] - m[3][0] * m[1][2];\n\tfloat Coef19 = m[1][0] * m[2][2] - m[2][0] * m[1][2];\n\tfloat Coef20 = m[2][0] * m[3][1] - m[3][0] * m[2][1];\n\tfloat Coef22 = m[1][0] * m[3][1] - m[3][0] * m[1][1];\n\tfloat Coef23 = m[1][0] * m[2][1] - m[2][0] * m[1][1];\n\tconst vec4 SignA = vec4( 1.0, -1.0,  1.0, -1.0);\n\tconst vec4 SignB = vec4(-1.0,  1.0, -1.0,  1.0);\n\tvec4 Fac0 = vec4(Coef00, Coef00, Coef02, Coef03);\n\tvec4 Fac1 = vec4(Coef04, Coef04, Coef06, Coef07);\n\tvec4 Fac2 = vec4(Coef08, Coef08, Coef10, Coef11);\n\tvec4 Fac3 = vec4(Coef12, Coef12, Coef14, Coef15);\n\tvec4 Fac4 = vec4(Coef16, Coef16, Coef18, Coef19);\n\tvec4 Fac5 = vec4(Coef20, Coef20, Coef22, Coef23);\n\tvec4 Vec0 = vec4(m[1][0], m[0][0], m[0][0], m[0][0]);\n\tvec4 Vec1 = vec4(m[1][1], m[0][1], m[0][1], m[0][1]);\n\tvec4 Vec2 = vec4(m[1][2], m[0][2], m[0][2], m[0][2]);\n\tvec4 Vec3 = vec4(m[1][3], m[0][3], m[0][3], m[0][3]);\n\tvec4 Inv0 = SignA * (Vec1 * Fac0 - Vec2 * Fac1 + Vec3 * Fac2);\n\tvec4 Inv1 = SignB * (Vec0 * Fac0 - Vec2 * Fac3 + Vec3 * Fac4);\n\tvec4 Inv2 = SignA * (Vec0 * Fac1 - Vec1 * Fac3 + Vec3 * Fac5);\n\tvec4 Inv3 = SignB * (Vec0 * Fac2 - Vec1 * Fac4 + Vec2 * Fac5);\n\tmat4 Inverse = mat4(Inv0, Inv1, Inv2, Inv3);\n\tvec4 Row0 = vec4(Inverse[0][0], Inverse[1][0], Inverse[2][0], Inverse[3][0]);\n\tfloat Determinant = dot(m[0], Row0);\n\tInverse /= Determinant;\n\treturn Inverse;\n}\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n#define TEXTURE_MAPPING_REVERSE_HORIZONTAL 0\n#define TEXTURE_MAPPING_REVERSE_VERTICAL 1\n#define TEXTURE_MAPPING_REVERSE_BOTH 2\n#define TEXTURE_MAPPING_REVERSE_NONE 3\n#define TEXTURE_MAPPING_TILING_HORIZONTAL 0\n#define TEXTURE_MAPPING_TILING_VERTICAL 1\n#define TEXTURE_MAPPING_TILING_BOTH 2\n#define TEXTURE_MAPPING_TILING_NONE 3\n#define TEXTURE_MAPPING_UV0 0\n#define TEXTURE_MAPPING_UV1 1\n#define TEXTURE_MAPPING_CUBE 2\n#define TEXTURE_MAPPING_SPHERE 3\n#define TEXTURE_MAPPING_CYLINDER 4\n#define TEXTURE_MAPPING_PLANE 5\n#define TEXTURE_MAPPING_CAMERA 6\n#define TEXTURE_MAPPING_CAMERA_ADAPTIVE 7\nvec2 uvReverse(vec2 originUV,int reverseMode)\n{\n\tif(reverseMode==TEXTURE_MAPPING_REVERSE_HORIZONTAL)\n\t\treturn vec2(1.0-originUV.x,originUV.y);\n\telse if(reverseMode==TEXTURE_MAPPING_REVERSE_VERTICAL)\n\t\treturn vec2(originUV.x,1.0-originUV.y);\n\telse if(reverseMode==TEXTURE_MAPPING_REVERSE_BOTH)\n\t\treturn 1.0-originUV;\n\telse if(reverseMode==TEXTURE_MAPPING_REVERSE_NONE)\n\t\treturn originUV;\n\treturn vec2(-1000.0);\n}\nvec2 uvTiling(vec2 originUV,inout bool isClampToBorder,int tilingMode)\n{\n\tif(tilingMode==TEXTURE_MAPPING_TILING_HORIZONTAL)\n\t{\n\t\tif(originUV.y<0.0||originUV.y>=1.0)\n\t\t\tisClampToBorder=true;\n\t}\n\telse if(tilingMode==TEXTURE_MAPPING_TILING_VERTICAL)\n\t{\n\t\tif(originUV.x<0.0||originUV.x>=1.0)\n\t\t\tisClampToBorder=true;\n\t}\n\telse if(tilingMode==TEXTURE_MAPPING_TILING_BOTH)\n\t\treturn originUV;\n\telse\n\t{\n\t\tif(originUV.y<0.0||originUV.y>=1.0||originUV.x<0.0||originUV.x>=1.0)\n\t\t\tisClampToBorder=true;\n\t}\n\treturn originUV;\n}\nvec2 uvRotate(vec2 originUV,float radian)\n{\n\tmat2 rotMat;\n\trotMat[0][0]=rotMat[1][1]=cos(radian);\n\trotMat[1][0]=sin(radian);\n\trotMat[0][1]=-sin(radian);\n\treturn rotMat*originUV;\n}\nvec2 GetUV_Uv0Uv1(vec4 inUv,inout bool isClampToBorder,vec2 tiling,vec2 offset,float radian,int reverseMode,int tilingMode)\n{\n\tvec2 uv=uvRotate(inUv.xy*tiling+offset,radian);\n\tuv=uvReverse(uv,reverseMode);\n\tuv=uvTiling(uv,isClampToBorder,tilingMode);\n\treturn uv;\n}\nvec2 GetUV_Sphere(vec4 inUv,inout bool isClampToBorder,vec2 tiling,vec2 offset,float radian,int reverseMode,int tilingMode)\n{\n\tconst vec2 invAtan=vec2(0.1591,0.3183);\n\tvec2 uv=vec2(atan(inUv.z,inUv.x),asin(inUv.y));\n\tuv*=invAtan;\n\tuv+=0.5;\n\tuv=uvRotate(uv*tiling+offset,radian);\n\tuv=uvReverse(uv,reverseMode);\n\tuv=uvTiling(uv,isClampToBorder,tilingMode);\n\treturn uv;\n}\nvec2 GetUV_Plane(vec4 inUv,inout bool isClampToBorder,vec2 tiling,vec2 offset,float radian,int reverseMode,int tilingMode,vec3 planeMappingCameraFront,vec3 gizmoPlanePosWS,float planeMappingDepth)\n{\n\tfloat cos_theta=dot(normalize(planeMappingCameraFront),normalize(vPositionW-gizmoPlanePosWS));\n\tfloat width=abs(length(vPositionW-gizmoPlanePosWS)*cos_theta);\n\tif(width>planeMappingDepth&&planeMappingDepth>0.0)\n\t\tisClampToBorder;\n\tvec2 uv=uvRotate(inUv.xy+offset,radian);\n\tuv=uv*0.5+0.5;\n\tuv=uvReverse(uv,reverseMode);\n\tuv=uvTiling(uv,isClampToBorder,tilingMode);\n\treturn uv;\n}\nvec2 GetUV_Cylinder(vec4 inUv,inout bool isClampToBorder,vec2 tiling,vec2 offset,float radian,int reverseMode,int tilingMode)\n{\n\tconst float PI=3.1415926535;\n\tvec2 uv=vec2(atan(inUv.z,inUv.x)+PI,inUv.y);\n\tuv=uvRotate(uv*tiling+offset,radian);\n\tuv=uv*0.5+0.5;\n\tuv=uvReverse(uv,reverseMode);\n\tuv=uvTiling(uv,isClampToBorder,tilingMode);\n\treturn uv;\n}\nvec2 GetUV_Cube(vec4 inUv,inout bool isClampToBorder,mat4 mappingMatrix,vec2 tiling,vec2 offset,float radian,int reverseMode,int tilingMode)\n{\n\tvec3 mappingPosition=vec3(mappingMatrix[3][0],mappingMatrix[3][1],mappingMatrix[3][2]);\n\tvec2 uv=vec2(0.0);\n\tmat3 trMappingMatrix=mat3(Transpose(Inverse(mappingMatrix)));\n\tinUv=mat4(trMappingMatrix)*inUv;\n\tfloat mag=max(max(abs(inUv.x),abs(inUv.y)),abs(inUv.z));\n\tif(mag==abs(inUv.x))\n\t{\n\t\tvec2 mappingPosition2=vec2(mappingPosition.z,mappingPosition.y);\n\t\tvec3 fullUv=trMappingMatrix*vPosition*2.0+inUv.xyz;\n\t\tif(fullUv.x>0.0)\n\t\t{\n\t\t\tuv=uvRotate(vec2(fullUv.z,fullUv.y)*tiling+offset+mappingPosition2,radian);\n\t\t\tuv=uv*0.5+0.5;\n\t\t\tuv.x=1.0-uv.x;\n\t\t}\n\t\telse if(fullUv.x<0.0)\n\t\t{\n\t\t\tuv=uvRotate(vec2(fullUv.z,fullUv.y)*tiling+offset+mappingPosition2,radian);\n\t\t\tuv=uv*0.5+0.5;\n\t\t}\n\t}\n\telse if(mag==abs(inUv.y))\n\t{\n\t\tvec2 mappingPosition2=vec2(mappingPosition.x,mappingPosition.z);\n\t\t\tvec3 fullUv=trMappingMatrix*vPosition*2.0+inUv.xyz;\n\t\tif(fullUv.y>0.0)\n\t\t{\n\t\t\tuv=uvRotate(vec2(fullUv.x,fullUv.z)*tiling+offset+mappingPosition2,radian);\n\t\t\tuv=uv*0.5+0.5;\n\t\t\tuv.y=1.0-uv.y;\n\t\t}\n\t\telse if(fullUv.y<0.0)\n\t\t{\n\t\t\tuv=uvRotate(vec2(fullUv.x,fullUv.z)*tiling+offset+mappingPosition2,radian);\n\t\t\tuv=uv*0.5+0.5;\n\t\t}\n\t}\n\telse if(mag==abs(inUv.z))\n\t{\n\t\tvec2 mappingPosition2=vec2(mappingPosition.x,mappingPosition.y);\n\t\t\tvec3 fullUv=trMappingMatrix*vPosition*2.0+inUv.xyz;\n\t\tif(fullUv.z>0.0)\n\t\t{\n\t\t\tuv=uvRotate(vec2(fullUv.x,fullUv.y)*tiling+offset+mappingPosition2,radian);\n\t\t\tuv=uv*0.5+0.5;\n\t\t}\n\t\telse if(fullUv.z<0.0)\n\t\t{\n\t\t\tuv=uvRotate(vec2(fullUv.x,fullUv.y)*tiling+offset+mappingPosition2,radian);\n\t\t\tuv=uv*0.5+0.5;\n\t\t\tuv.x=1.0-uv.x;\n\t\t}\n\t}\n\tuv=uvReverse(uv,reverseMode);\n\tuv=uvTiling(uv,isClampToBorder,tilingMode);\n\treturn uv;\n}\nvec2 GetUV_Camera(vec4 inUv,inout bool isClampToBorder,vec2 tiling,vec2 offset,float radian,int reverseMode,int tilingMode)\n{\n\tvec4 tmpTexcoord=inUv;\n\ttmpTexcoord.xyz/=tmpTexcoord.w;\n\ttmpTexcoord.xyz=tmpTexcoord.xyz*0.5+0.5;\n\tvec2 tmpUV=(tmpTexcoord.xy-0.5)*tiling;\n\tvec2 uv=uvRotate(tmpUV-offset,radian);\n\tuv+=0.5;\n\tuv=uvReverse(uv,reverseMode);\n\tuv=uvTiling(uv,isClampToBorder,tilingMode);\n\treturn uv;\n}\nvec2 GetUV_CameraAdaptive(vec4 inUv,inout bool isClampToBorder,vec2 tiling,vec2 offset,float radian,int reverseMode,int tilingMode)\n{\n\tvec2 uv=uvRotate(inUv.xy+offset,radian);\n\tuv=uv*0.5+0.5;\n\tuv=uvReverse(uv,reverseMode);\n\tuv=uvTiling(uv,isClampToBorder,tilingMode);\n\treturn uv;\n}\nvec2 GetUV(int mappingType,vec4 inUv,inout bool isClampToBorder,mat4 mappingMatrix,vec2 tiling,vec2 offset,float radian,int reverseMode,int tilingMode,vec3 planeMappingCameraFront,vec3 gizmoPlanePosWS,float planeMappingDepth)\n{\n \tif(mappingType==TEXTURE_MAPPING_CAMERA)\n\t\treturn GetUV_Camera(inUv,isClampToBorder,tiling,offset,radian,reverseMode,tilingMode);\n\telse if(mappingType==TEXTURE_MAPPING_CAMERA_ADAPTIVE)\n\t\treturn GetUV_CameraAdaptive(inUv,isClampToBorder,tiling,offset,radian,reverseMode,tilingMode);\n\telse if(mappingType==TEXTURE_MAPPING_CUBE)\n\t\treturn GetUV_Cube(inUv,isClampToBorder,mappingMatrix,tiling,offset,radian,reverseMode,tilingMode);\n\telse if(mappingType==TEXTURE_MAPPING_PLANE)\n\t\treturn GetUV_Plane(inUv,isClampToBorder,tiling,offset,radian,reverseMode,tilingMode,planeMappingCameraFront,gizmoPlanePosWS,planeMappingDepth);\n\telse if(mappingType==TEXTURE_MAPPING_CYLINDER)\n\t\treturn GetUV_Cylinder(inUv,isClampToBorder,tiling,offset,radian,reverseMode,tilingMode);\n\telse if(mappingType==TEXTURE_MAPPING_SPHERE)\n\t\treturn GetUV_Sphere(inUv,isClampToBorder,tiling,offset,radian,reverseMode,tilingMode);\n\telse\n\t\treturn GetUV_Uv0Uv1(inUv,isClampToBorder,tiling,offset,radian,reverseMode,tilingMode);\n}\n",baseVS:"attribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n",baseNineSlicedPS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n\treturn maxBias;\n}\n",blurVSMPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef PACKED\n\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t#endif\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\t#ifdef PACKED\n\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t#else\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t#endif\n}\n",clearCoatPS:"#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatMap;\nuniform float clearCoatMapRadian;\nuniform int clearCoatMapReverseMode;\nuniform int clearCoatMapTilingMode;\nbool clearCoatMapClampToBorder=false;\n#ifdef clearCoatMapMappingEnabled\nuniform int clearCoatMapMappingType;\nuniform vec2 clearCoatMapTiling;\nuniform vec2 clearCoatMapOffset;\nuniform vec3 clearcoatMapMappingPosition;\nuniform vec3  clearCoatMapPlaneMappingCameraFront;\nuniform vec3  clearCoatMapGizmoPlanePosWS;\nuniform float  clearCoatMapPlaneMappingDepth;\n#endif\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef clearCoatMapMappingEnabled\n\tvec2 ccUV= GetUV(clearCoatMapMappingType,$UV,clearCoatMapClampToBorder,clearcoatMapMappingPosition,clearCoatMapTiling,clearCoatMapOffset,clearCoatMapRadian,\n\t\t\t\tclearCoatMapReverseMode,clearCoatMapTilingMode,clearCoatMapPlaneMappingCameraFront,clearCoatMapGizmoPlanePosWS,clearCoatMapPlaneMappingDepth);\n\t#else\n\tvec2 ccUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),clearCoatMapClampToBorder,vec2(1.0),vec2(0.0),clearCoatMapRadian,clearCoatMapReverseMode,clearCoatMapTilingMode);\n\t#endif\n\tif(!clearCoatMapClampToBorder)\n\t\tccSpecularity *= texture2D(texture_clearCoatMap,ccUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\nuniform float clearCoatGlossMapRadian;\nuniform int clearCoatGlossMapReverseMode;\nuniform int clearCoatGlossMapTilingMode;\nbool clearCoatGlossMapClampToBorder=false;\n#ifdef diffuseMapMappingEnabled\nuniform int clearCoatGlossMapMappingType;\nuniform vec2 clearCoatGlossMapTiling;\nuniform vec2 clearCoatGlossMapOffset;\nuniform vec3 clearcoatGlossMapMappingPosition;\nuniform vec3 clearCoatGlossMapPlaneMappingCameraFront;\nuniform vec3 clearCoatGlossMapGizmoPlanePosWS;\nuniform float clearCoatGlossMapPlaneMappingDepth;\n#endif\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGlossiness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef diffuseMapMappingEnabled\n\tvec2 ccgUV=GetUV(clearCoatGlossMapMappingType,$UV,clearCoatGlossMapClampToBorder,clearcoatGlossMapMappingPosition,clearCoatGlossMapTiling,clearCoatGlossMapOffset,clearCoatGlossMapRadian,clearCoatGlossMapReverseMode,clearCoatGlossMapTilingMode,clearCoatGlossMapPlaneMappingCameraFront,clearCoatGlossMapGizmoPlanePosWS,clearCoatGlossMapPlaneMappingDepth);\n\t#else\n\tvec2 ccgUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),diffuseMapClampToBorder,vec2(1.0),vec2(0.0),diffuseMapRadian,diffuseMapReverseMode,diffuseMapTilingMode);\n\t#endif\n\tif(!clearCoatGlossMapClampToBorder)\n\t\tccGlossiness *= texture2D(texture_clearCoatGlossMap,ccgUV ).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatNormalMap;\nuniform float clearCoatNormalMapRadian;\nuniform int clearCoatNormalMapReverseMode;\nuniform int clearCoatNormalMapTilingMode;\nbool clearCoatNormalMapClampToBorder=false;\n#ifdef clearCoatNormalMapMappingEnabled\nuniform int clearCoatNormalMapMappingType;\nuniform vec2 clearCoatNormalMapTiling;\nuniform vec2 clearCoatNormalMapOffset;\nuniform vec3 clearcoatNormalMapMappingPosition;\nuniform vec3 clearCoatNormalMapPlaneMappingCameraFront;\nuniform vec3 clearCoatNormalMapGizmoPlanePosWS;\nuniform float clearCoatNormalMapPlaneMappingDepth;\nuniform float material_clearCoatBumpiness;\n#endif\n#endif\nvoid getClearCoatNormal() {\n\t#ifdef MAPTEXTURE\n\t#ifdef clearCoatNormalMapMappingEnabled\n\tvec2 nUV=GetUV(clearCoatNormalMapMappingType,$UV,clearCoatNormalMapClampToBorder,clearcoatNormalMapMappingPosition,clearCoatNormalMapTiling,clearCoatNormalMapOffset,clearCoatNormalMapRadian,clearCoatNormalMapReverseMode,clearCoatNormalMapTilingMode,clearCoatNormalMapPlaneMappingCameraFront,clearCoatNormalMapGizmoPlanePosWS,clearCoatNormalMapPlaneMappingDepth);\n\t#else\n\tvec2 nUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),clearCoatNormalMapClampToBorder,vec2(1.0),vec2(0.0),clearCoatNormalMapRadian,clearCoatNormalMapReverseMode,clearCoatNormalMapTilingMode);\n\t#endif\n\tif(!clearCoatNormalMapClampToBorder)\n\t{\n\t\tvec3 normalMap = unpackNormal(texture2D(texture_clearCoatNormalMap,nUV));\n\t\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness));\n\t\tccNormalW = dTBN * normalMap;\n\t}\n\telse  ccNormalW = normalize(dVertexNormalW);\n\t#else\n\tccNormalW = normalize(dVertexNormalW);\n\t#endif\n\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n}\n",clusteredLightLoopPS:"\nvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\nif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\tclusterV = (clusterV + 0.5) * clusterTextureSize.z;\n\tconst float maxLightCells = 256.0 / 4.0;\n\tfor (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {\n\t\tvec4 lightIndices = texture2D(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV));\n\t\tvec4 indices = lightIndices * 255.0;\n\t\tif (indices.x <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.x);\n\t\tif (indices.y <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.y);\n\t\tif (indices.z <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.z);\n\t\tif (indices.w <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.w);\n\t\tif (lightCellIndex > clusterPixelsPerCell) {\n\t\t\tbreak;\n\t\t}\n\t}\n}\n",clusteredLightPS:"uniform sampler2D clusterWorldTexture;\nuniform sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\nuniform float clusterPixelsPerCell;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec4 lightsTextureInvSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nfloat DecodeClusterFloat4(vec4 data) {\n\treturn dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\nfloat DecodeClusterFloat2(vec2 data) {\n\treturn dot(data, vec2(1.0, 1.0 / 255.0));\n}\nvoid EvaluateClusterLight(float lightIndex) {\n\tfloat lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;\n\tvec4 lightInfo = texture2D(lightsTexture8, vec2(0.5 * lightsTextureInvSize.z, lightV));\n\tfloat lightType = lightInfo.x;\n\tfloat lightShape = lightInfo.y;\n\tfloat falloffMode = lightInfo.z;\n\tvec4 colorA = texture2D(lightsTexture8, vec2(1.5 * lightsTextureInvSize.z, lightV));\n\tvec4 colorB = texture2D(lightsTexture8, vec2(2.5 * lightsTextureInvSize.z, lightV));\n\tvec3 lightColor = vec3(\n\t\tDecodeClusterFloat2(colorA.xy),\n\t\tDecodeClusterFloat2(colorA.zw),\n\t\tDecodeClusterFloat2(colorB.xy)\n\t) * clusterCompressionLimit0.y;\n\tvec4 coneAngle = texture2D(lightsTexture8, vec2(3.5 * lightsTextureInvSize.z, lightV));\n\tfloat innerConeAngleCos = DecodeClusterFloat2(coneAngle.xy) * 2.0 - 1.0;\n\tfloat outerConeAngleCos = DecodeClusterFloat2(coneAngle.zw) * 2.0 - 1.0;\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tvec4 lightPosRange = texture2D(lightsTextureFloat, vec2(0.5 * lightsTextureInvSize.x, lightV));\n\t\tvec3 lightPos = lightPosRange.xyz;\n\t\tfloat range = lightPosRange.w;\n\t\tvec4 lightDir_Unused = texture2D(lightsTextureFloat, vec2(1.5 * lightsTextureInvSize.x, lightV));\n\t\tvec3 lightDir = lightDir_Unused.xyz;\n\t#else\n\t\tvec4 encPosX = texture2D(lightsTexture8, vec2(4.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encPosY = texture2D(lightsTexture8, vec2(5.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encPosZ = texture2D(lightsTexture8, vec2(6.5 * lightsTextureInvSize.z, lightV));\n\t\tvec3 lightPos = vec3(\n\t\t\tDecodeClusterFloat4(encPosX),\n\t\t\tDecodeClusterFloat4(encPosY),\n\t\t\tDecodeClusterFloat4(encPosZ)\n\t\t) * clusterBoundsDelta + clusterBoundsMin;\n\t\tvec4 encRange = texture2D(lightsTexture8, vec2(7.5 * lightsTextureInvSize.z, lightV));\n\t\tfloat range = DecodeClusterFloat4(encRange) * clusterCompressionLimit0.x;\n\t\tvec4 encDirX = texture2D(lightsTexture8, vec2(8.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encDirY = texture2D(lightsTexture8, vec2(9.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encDirZ = texture2D(lightsTexture8, vec2(10.5 * lightsTextureInvSize.z, lightV));\n\t\tvec3 lightDir = vec3(\n\t\t\tDecodeClusterFloat4(encDirX),\n\t\t\tDecodeClusterFloat4(encDirY),\n\t\t\tDecodeClusterFloat4(encDirZ)\n\t\t) * 2.0 - 1.0;\n\t#endif\n\tgetLightDirPoint(lightPos);\n\tdAtten = getFalloffLinear(range);\n\tif (dAtten > 0.00001) {\n\t\tif (lightType > 0.5) {\n\t\t\tdAtten *= getSpotEffect(lightDir, innerConeAngleCos, outerConeAngleCos);\n\t\t}\n\t\tdAtten *= getLightDiffuse();\n\t\tdDiffuseLight += dAtten * lightColor;\n\t}\n}\n",combineClearCoatPS:"vec3 combineColorCC() {\n\treturn combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight;\n}\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n\tfloat roughness = max(1.0 - dGlossiness, 0.045);\n\tvec3 diffuse = dAlbedo * dDiffuseLight;\n\tvec3 specular = dSpecularLight + dReflection.rgb * dReflection.a;\n\t#include <transmissionPS>\n\tvec3 color =  mix(diffuse, specular, dSpecularity);\n\t$OIT\n\treturn color;\n}\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n\treturn (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",combineDiffuseSpecularPBRPS:"uniform vec3 camPos;\nuniform sampler2D brdfLUT;\nvec3 RE_Direct_Scattering(vec3 lightPosition, vec3 lightColor, vec3 vPosition, vec3 N, vec3 V, vec3 subsurfaceColor, float thicknessFactor, float thicknessDistortion, float thicknessAmbient, float thicknessAttenuation, float thicknessPower, float thicknessScale) {\n\tvec3 thickness = vec3(thicknessFactor);\n\tvec3 L = normalize(lightPosition - vPosition);\n\tvec3 scatteringHalf = normalize(L + (N * thicknessDistortion));\n\tfloat scatteringDot = pow(saturate(dot(V, -scatteringHalf)), thicknessPower) * thicknessScale;\n\tvec3 scatteringIllu = (scatteringDot + thicknessAmbient) * thickness;\n\treturn scatteringIllu * thicknessAttenuation * lightColor * subsurfaceColor;\n}\nvec3 getLo(vec3 lightPosition, vec3 lightColor, vec3 vPosition, vec3 N, vec3 V, in vec3 F0, vec3 albedo, float roughness) {\n\tvec3 L = normalize(lightPosition - vPosition);\n\tvec3 H = normalize(V + L);\n\tfloat NoL = max(dot(N, L), 0.0);\n\tfloat distance = length(lightPosition - vPosition);\n\tfloat attenuation = 1.0 / (distance * distance);\n\tvec3 radiance = lightColor * attenuation;\n\tfloat NDF = DistributionGGX(N, H, roughness);\n\tfloat G   = GeometrySmith(N, V, L, roughness);\n\tvec3 F\t= fresnelSchlick(max(dot(H, V), 0.0), F0);\n\tvec3 nominator\t= NDF * G * F;\n\tfloat denominator = 4.0 * max(dot(N, V), 0.0) * max(dot(N, L), 0.0) + 0.001;\n\tvec3 specular = nominator / denominator;\n\tvec3 kS = F;\n\tvec3 kD = vec3(1.0) - kS;\n\tkD *= 1.0 - metallic;\n\tvec3 BRDF = kD * albedo / PI + specular;\n\treturn BRDF * radiance * NoL;\n}\nvec3 combineColor() {\n\t#include <PBRFactorsPS>\n\tvec3 albedo = dAlbedo;\n\tfloat ao = dAo;\n\t#ifdef USE_METALNESS\n\t\tfloat roughness = max(dRoughness, 0.045);\n\t#else\n\t\tfloat roughness = max(1.0 - dGlossiness, 0.045);\n\t#endif\n\t#ifdef GL2\n\t\tvec3 N = vNormalW;\n\t\tif (!gl_FrontFacing) {\n\t\t\tN = normalize(  cross(dFdx(vPositionW),  dFdy(vPositionW))  );\n\t\t}\n\t#else\n\t\tvec3 N = vNormalW;\n\t#endif\n\tvec3 V = dViewDirW;\n\tvec3 R = dReflDirW;\n\t#ifndef RIGHT_HANDED_CUBEMAP\n\t\tR.x *= -1.0;\n\t#endif\n\tR = cubeMapProject(R);\n\tfloat NoV = max(dot(N, V), 0.0);\n\tfloat dielectricSpecular = 0.04;\n\t#ifdef USE_TRANSMISSION\n\tdielectricSpecular = pow((ior - 1.0)/(ior + 1.0), 2.0);\n\t#endif\n\tvec3 F0 = vec3(dielectricSpecular);\n\tF0 = mix(F0, albedo, metallic);\n\tvec3 F = fresnelSchlickRoughness(max(dot(N, V), 0.0), F0, roughness);\n\tF = clamp(F, 0.0, 1.0);\n\tvec3 kS = F;\n\tvec3 kD = 1.0 - kS;\n\tkD *= 1.0 - metallic;\n\tvec3 Lo = vec3(0.0);\n\t$Lo\n\tLo = max(Lo, vec3(0));\n\tvec3 diffuse = albedo * dDiffuseLight * kD;\n\tvec3 specular = evaluateSpecularIBL(roughness, F, F0, N, V, R, NoV) * dSpecularity;\n\t#include <transmissionPS>\n\tvec3 color = (diffuse + specular) * ao + Lo;\n\t$OIT\n\tvec3 Scatter = vec3(0.0);\n\t$Scatter\n\tcolor += Scatter;\n\tScatter = max(Scatter, vec3(0));\n\treturn color;\n}\n",cookiePS:"vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tnrdir = cubeMapRotate(nrdir);\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn posonbox - envBoxPos;\n}\n",cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",diffusePS:"uniform vec3 material_diffuse;\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\nuniform float diffuseMapRadian;\nuniform int diffuseMapReverseMode;\nuniform int diffuseMapTilingMode;\nbool diffuseMapClampToBorder=false;\n#ifdef diffuseMapMappingEnabled\nuniform vec2 diffuseMapTiling;\nuniform vec2 diffuseMapOffset;\nuniform int diffuseMapMappingType;\nuniform mat4 diffuseMapMappingMatrix;\nuniform vec3 diffuseMapPlaneMappingCameraFront;\nuniform vec3 diffuseMapGizmoPlanePosWS;\nuniform float diffuseMapPlaneMappingDepth;\n#endif\nfloat dDiffuseAlpha=1.0;\n#endif\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef diffuseMapMappingEnabled\n\tvec2 albedoUV= GetUV(diffuseMapMappingType,$UV,diffuseMapClampToBorder,diffuseMapMappingMatrix,diffuseMapTiling,diffuseMapOffset,diffuseMapRadian,diffuseMapReverseMode,diffuseMapTilingMode,diffuseMapPlaneMappingCameraFront,diffuseMapGizmoPlanePosWS,diffuseMapPlaneMappingDepth);\n\t#else\n\tvec2 albedoUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),diffuseMapClampToBorder,vec2(1.0),vec2(0.0),diffuseMapRadian,diffuseMapReverseMode,diffuseMapTilingMode);\n\t#endif\n\tvec4 d=texture2D(texture_diffuseMap,albedoUV);\n\tif(!diffuseMapClampToBorder)\n\t\tdAlbedo *= gammaCorrectInput(addAlbedoDetail(d.$CH))*dDiffuseAlpha+material_diffuse.$CH*(1.0-dDiffuseAlpha);\n\telse  dAlbedo *= material_diffuse.rgb;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\nuniform float diffuseDetailMapRadian;\nuniform int diffuseDetailMapReverseMode;\nuniform int diffuseDetailMapTilingMode;\nbool diffuseDetailMapClampToBorder=false;;\n#ifdef diffuseDetailMapMappingEnabled\nuniform int diffuseDetailMapMappingType;\nuniform vec2 diffuseDetailMapTiling;\nuniform vec2 diffuseDetailMapOffset;\nuniform mat4 diffuseDetailMapMappingMatrix;\nuniform vec3 diffuseDetailMapPlaneMappingCameraFront;\nuniform vec3 diffuseDetailMapGizmoPlanePosWS;\nuniform float diffuseDetailMapPlaneMappingDepth;\n#endif\n#endif\nvec3 addAlbedoDetail(vec3 albedo) {\n\t#ifdef MAPTEXTURE\n\t#ifdef diffuseDetailMapMappingEnabled\n\tvec2 adUV=GetUV(diffuseDetailMapMappingType,$UV,diffuseDetailMapClampToBorder,diffuseDetailMapMappingMatrix,diffuseDetailMapTiling,diffuseDetailMapOffset,diffuseDetailMapRadian,diffuseDetailMapReverseMode,diffuseDetailMapTilingMode,diffuseDetailMapPlaneMappingCameraFront,diffuseDetailMapGizmoPlanePosWS,diffuseDetailMapPlaneMappingDepth);\n\t#else\n\tvec2 adUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),diffuseDetailMapClampToBorder,vec2(1.0),vec2(0.0),diffuseDetailMapRadian,diffuseDetailMapReverseMode,diffuseDetailMapTilingMode);\n\t#endif\n\tif(!diffuseDetailMapClampToBorder)\n\t{\n\t\tvec3 albedoDetail= vec3(texture2D(texture_diffuseDetailMap,adUV).$CH);\n\t\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n\t}\n\telse return albedo;\n\t#else\n\treturn albedo;\n\t#endif\n}\n",dilatePS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n\tvec4 c = texture2D(source, vUv0);\n\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\tgl_FragColor = c;\n}\n",dpAtlasQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tuv = uv * 2.0 - vec2(1.0);\n\tuv *= params.xy;\n\tuv = uv * 0.5 + 0.5;\n\tgl_FragColor = texture2D(source, uv);\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\nuniform float emissiveMapRadian;\nuniform int emissiveMapReverseMode;\nuniform int emissiveMapTilingMode;\nbool emissiveMapClampToBorder=false;\n#ifdef emissiveMapMappingEnabled\nuniform int emissiveMapMappingType;\nuniform vec2 emissiveMapTiling;\nuniform vec2 emissiveMapOffset;\nuniform mat4 emissiveMapMappingMatrix;\nuniform vec3 emissiveMapPlaneMappingCameraFront;\nuniform vec3 emissiveMapGizmoPlanePosWS;\nuniform float emissiveMapPlaneMappingDepth;\n#endif\n#endif\nvec3 getEmission() {\n\tvec3 emission = vec3(1.0);\n\t#ifdef MAPFLOAT\n\temission *= material_emissiveIntensity;\n\t#endif\n\t#ifdef MAPCOLOR\n\temission *= material_emissive;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef emissiveMapMappingEnabled\n\tvec2 eUV=GetUV(emissiveMapMappingType,$UV,emissiveMapClampToBorder,emissiveMapMappingMatrix,emissiveMapTiling,emissiveMapOffset,emissiveMapRadian,emissiveMapReverseMode,emissiveMapTilingMode,emissiveMapPlaneMappingCameraFront,emissiveMapGizmoPlanePosWS,emissiveMapPlaneMappingDepth);\n\t#else\n\tvec2 eUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),emissiveMapClampToBorder,vec2(1.0),vec2(0.0),emissiveMapRadian,emissiveMapReverseMode,emissiveMapTilingMode);\n\t#endif\n\tif(!emissiveMapClampToBorder)\n\t\temission *= $texture2DSAMPLE(texture_emissiveMap,eUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\temission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n\treturn emission;\n}\n",endPS:"\t#ifndef EMISSIVE\n\t\t#ifdef CLEARCOAT\n\t\tgl_FragColor.rgb = combineColorCC();\n\t\t#else\n\t\tgl_FragColor.rgb = combineColor();\n\t\t#endif\n\t#endif\n\tgl_FragColor.rgb += getEmission();\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\t#ifndef HDR\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t#endif\n",endVS:"\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffWindow(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n\tfloat d = length(dLightDirW);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\treturn vec3(0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\tfloat scale = 1.0 - 1.0 / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\tfloat scale = invRecMipSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat M = max(avec.x, max(avec.y, avec.z));\n\treturn vec3(avec.x != M ? 1.0 : 0.0,\n\t\t\t\tavec.y != M ? 1.0 : 0.0,\n\t\t\t\tavec.z != M ? 1.0 : 0.0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec * (seam * -scale + vec3(1.0));\n}\n",fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\tfogFactor = gammaCorrectInput(fogFactor);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"float dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\treturn color;\n}\n",fresnelSchlickPS:"\nuniform float material_fresnelFactor;\nvoid getFresnel() {\n\tfloat fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n\tfloat fresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= dGlossiness * dGlossiness;\n\tdSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n\t#ifdef CLEARCOAT\n\tfresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n\tfresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= ccGlossiness * ccGlossiness;\n\tccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n\t#endif\n}\n",fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\treturn texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\treturn texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\treturn textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\n",gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n\treturn pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n\treturn pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\tvec4 rgba = texture2D(tex, uv);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\tvec4 rgba = texture2D(tex, uv, bias);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\tvec4 rgba = textureCube(tex, uvw);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\t#ifdef HDR\n\treturn color;\n\t#else\n\tcolor += vec3(0.0000001);\n\treturn pow(color, vec3(0.45));\n\t#endif\n}\n",genParaboloidPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tfloat side = uv.x < 0.5? 1.0 : -1.0;\n\tvec2 tc;\n\ttc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n\ttc.y = uv.y * 2.0 - 1.0;\n\tconst float scale = 1.1;\n\ttc *= scale;\n\tvec3 dir;\n\tdir.y = (dot(tc, tc) - 1.0) * side;\n\tdir.xz = tc * -2.0;\n\tdir.x *= -side * params.y;\n\tdir = fixSeams(dir, params.x);\n\tvec4 color = textureCube(source, dir, -100.0);\n\tgl_FragColor = color;\n}\n",gles3PS:"#define varying in\nlayout(location=0) out highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\nuniform float glossMapRadian;\nuniform int glossMapReverseMode;\nuniform int glossMapTilingMode;\nbool glossMapClampToBorder=false;\n#ifdef glossMapMappingEnabled\nuniform int glossMapMappingType;\nuniform vec2 glossMapTiling;\nuniform vec2 glossMapOffset;\nuniform mat4 glossMapMappingMatrix;\nuniform vec3 glossMapPlaneMappingCameraFront;\nuniform vec3 glossMapGizmoPlanePosWS;\nuniform float glossMapPlaneMappingDepth;\n#endif\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef glossMapMappingEnabled\n\tvec2 gUV=GetUV(glossMapMappingType,$UV,glossMapClampToBorder,glossMapMappingMatrix,glossMapTiling,glossMapOffset,glossMapRadian,glossMapReverseMode,glossMapTilingMode,glossMapPlaneMappingCameraFront,glossMapGizmoPlanePosWS,glossMapPlaneMappingDepth);\n\t#else\n\tvec2 gUV=GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),glossMapClampToBorder,vec2(1.0),vec2(0.0),glossMapRadian,glossMapReverseMode,glossMapTilingMode);\n\t#endif\n\tif(!glossMapClampToBorder)\n\t\tdGlossiness *= texture2D(texture_glossMap,gUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",instancingVS:"attribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"float getLightDiffuse() {\n\treturn max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform float lightMapRadian;\nuniform int lightMapReverseMode;\nuniform int lightMapTilingMode;\nbool lightMapClampToBorder=false;\n#ifdef lightMapMappingEnabled\nuniform int lightMapMappingType;\nuniform vec2 lightMapTiling;\nuniform vec2 lightMapOffset;\nuniform mat4 lightMapMappingMatrix;\nuniform vec3 lightMapPlaneMappingCameraFront;\nuniform vec3 lightMapGizmoPlanePosWS;\nuniform float lightMapPlaneMappingDepth;\n#endif\nuniform sampler2D texture_dirLightMap;\nuniform float dirLightMapRadian;\nuniform int dirLightMapReverseMode;\nuniform int dirLightMapTilingMode;\nbool dirLightMapClampToBorder=false;\n#ifdef dirLightMapMappingEnabled\nuniform int dirLightMapMappingType;\nuniform vec2 dirLightMapTiling;\nuniform vec2 dirLightMapOffset;\nuniform mat4 dirLightMapMappingMatrix;\nuniform vec3 dirLightMapPlaneMappingCameraFront;\nuniform vec3 dirLightMapGizmoPlanePosWS;\nuniform float dirLightMapPlaneMappingDepth;\n#endif\nvoid addLightMap() {\n\t#ifdef lightMapMappingEnabled\n\tvec2 lightUV = GetUV(lightMapMappingType,$UV,lightMapClampToBorder,lightMapMappingMatrix,lightMapTiling,lightMapOffset,lightMapRadian,lightMapReverseMode,lightMapTilingMode,lightMapPlaneMappingCameraFront,lightMapGizmoPlanePosWS,lightMapPlaneMappingDepth);\n\t#else\n\tvec2 lightUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),lightMapClampToBorder,vec2(1.0),vec2(0.0),lightMapRadian,lightMapReverseMode,lightMapTilingMode);\n\t#endif\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, lightUV).$CH;\n\t#ifdef dirLightMapMappingEnabled\n\tvec3 dirLightUV = GetUV(dirLightMapMappingType,$UV,dirLightMapTiling,dirLightMapOffset,dirLightMapRadian,dirLightMapReverseMode,dirLightMapTilingMode,dirLightMapPlaneMappingCameraFront,dirLightMapGizmoPlanePosWS,dirLightMapPlaneMappingDepth);\n\t#else\n\tvec2 dirLightUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),dirLightMapClampToBorder,vec2(1.0),vec2(0.0),dirLightMapRadian,dirLightMapReverseMode,dirLightMapTilingMode);\n\t#endif\n\tvec3 dir = texture2D(texture_dirLightMap, dirLightUV).xyz;\n\tif (dot(dir, vec3(1.0)) < 0.00001) {\n\t\tdDiffuseLight += color;\n\t} else {\n\t\tdLightDirNormW = normalize(dir * 2.0 - vec3(1.0));\n\t\tfloat vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n\t\tfloat flight = saturate(dot(dLightDirNormW, -dNormalW));\n\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\tdDiffuseLight += color * nlight * 2.0;\n\t}\n\tdSpecularLight += color * getLightSpecular();\n}\n",lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\nuniform float lightMapRadian;\nuniform int lightMapReverseMode;\nuniform int lightMapTilingMode;\nbool lightMapClampToBorder=false;\n#ifdef lightMapMappingEnabled\nuniform int lightMapMappingType;\nuniform vec2 lightMapTiling;\nuniform vec2 lightMapOffset;\nuniform mat4 lightMapMappingMatrix;\nuniform vec3 lightMapPlaneMappingCameraFront;\nuniform vec3 lightMapGizmoPlanePosWS;\nuniform float lightMapPlaneMappingDepth;\n#endif\n#endif\nvoid addLightMap() {\n\tvec3 lm = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\t#ifdef lightMapMappingEnabled\n\tvec2 lightUV = GetUV(lightMapMappingType,$UV,lightMapClampToBorder,lightMapMappingMatrix,lightMapTiling,lightMapOffset,lightMapRadian,lightMapReverseMode,lightMapTilingMode,lightMapPlaneMappingCameraFront,lightMapGizmoPlanePosWS,lightMapPlaneMappingDepth);\n\t#else\n\tvec2 lightUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),lightMapClampToBorder,vec2(1.0),vec2(0.0),lightMapRadian,lightMapReverseMode,lightMapTilingMode);\n\t#endif\n\tlm *= $texture2DSAMPLE(texture_lightMap, lightUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tlm *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight += lm;\n}\n",lightmapSingleVertPS:"void addLightMap() {\n\tdDiffuseLight += saturate(vVertexColor.$CH);\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tvec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\tfloat NoH = dot(tNormalW, h);\n\tfloat ToH = dot(dTBN[0], h);\n\tfloat BoH = dot(dTBN[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(dTBN[0], dViewDirW);\n\tfloat BoV = dot(dTBN[1], dViewDirW);\n\tfloat ToL = dot(dTBN[0], -dLightDirNormW);\n\tfloat BoL = dot(dTBN[1], -dLightDirNormW);\n\tfloat NoV = dot(tNormalW, dViewDirW);\n\tfloat NoL = dot(tNormalW, -dLightDirNormW);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tvec3 h = normalize( -dLightDirNormW + dViewDirW );\n\tfloat nh = max( dot( h, tNormalW ), 0.0 );\n\tfloat specPow = exp2(tGlossiness * 11.0);\n\tspecPow = antiAliasGlossiness(specPow);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n\tfloat specPow = tGlossiness;\n\tspecPow = antiAliasGlossiness(specPow);\n\treturn pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dReflDirW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",ltc:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tfloat radius = max(length(halfWidth), length(halfWidth));\n\tdSphereRadius = radius;\n\tvec3 f = normalize(lightPos-view_position);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\tcoords.coord0 = lightPos + w * radius - h * radius;\n\tcoords.coord1 = lightPos - w * radius - h * radius;\n\tcoords.coord2 = lightPos - w * radius + h * radius;\n\tcoords.coord3 = lightPos + w * radius + h * radius;\n\treturn coords;\n}\nvec2 dLTCUV;\n#ifdef CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float tGlossiness, vec3 tNormalW)\n{\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\treturn LTC_Uv( tNormalW, dViewDirW, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 tSpecularity)\n{\n\tvec4 t2 = texture2D( areaLightsLutTex2, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt2 *= vec4(0.693103,1,1,1);\n\tt2 += vec4(0.306897,0,0,0);\n\t#endif\n\treturn tSpecularity * t2.x + ( vec3( 1.0 ) - tSpecularity) * t2.y;\n}\nvoid calcLTCLightValues()\n{\n\tdLTCUV = getLTCLightUV(dGlossiness, dNormalW);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, dSpecularityNoFres);\n#ifdef CLEARCOAT\n\tccLTCUV = getLTCLightUV(ccGlossiness, ccNormalW);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(ccSpecularityNoFres));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n\tcalcLTCLightValues();\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n\tcalcLTCLightValues();\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = cross(V1, V2);\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2D( areaLightsLutTex2, uv ).w;\n\treturn formFactor*scale;\n}\nfloat getRectLightDiffuse() {\n\treturn LTC_EvaluateRect( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse() {\n\treturn LTC_EvaluateDisk( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getSphereLightDiffuse() {\n\tfloat falloff = dSphereRadius / (dot(dLightDirW, dLightDirW) + dSphereRadius);\n\treturn getLightDiffuse()*falloff;\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2D( areaLightsLutTex1, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n\tt1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n\t#endif\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular() {\n\treturn calcRectLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getRectLightSpecularCC() {\n\treturn calcRectLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat calcDiskLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getDiskLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat getSphereLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getSphereLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n",metalnessPS:"void processMetalness(float metalness) {\n\tconst float dielectricF0 = 0.04;\n\tdSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n\t#ifndef PBR\n\tdAlbedo *= 1.0 - metalness;\n\t#endif\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\nuniform float metalnessMapRadian;\nuniform int metalnessMapReverseMode;\nuniform int metalnessMapTilingMode;\nbool metalnessMapClampToBorder=false;\n#ifdef metalnessMapMappingEnabled\nuniform int metalnessMapMappingType;\nuniform vec2 metalnessMapTiling;\nuniform vec2 metalnessMapOffset;\nuniform mat4 metalnessMapMappingMatrix;\nuniform vec3 metalnessMapPlaneMappingCameraFront;\nuniform vec3 metalnessMapGizmoPlanePosWS;\nuniform float metalnessMapPlaneMappingDepth;\n#endif\n#endif\nvoid getSpecularity() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef metalnessMapMappingEnabled\n\tvec2 mUV=GetUV(metalnessMapMappingType,$UV,metalnessMapClampToBorder,metalnessMapMappingMatrix,metalnessMapTiling,metalnessMapOffset,metalnessMapRadian,metalnessMapReverseMode,metalnessMapTilingMode,metalnessMapPlaneMappingCameraFront,metalnessMapGizmoPlanePosWS,metalnessMapPlaneMappingDepth);\n\t#else\n\tvec2 mUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),metalnessMapClampToBorder,vec2(1.0),vec2(0.0),metalnessMapRadian,metalnessMapReverseMode,metalnessMapTilingMode);\n\t#endif\n\tif(!metalnessMapClampToBorder)\n\t\tmetalness *= texture2D(texture_metalnessMap,mUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tmetallic = metalness;\n\tprocessMetalness(metalness);\n}\n",msdfPS:"uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0_msdf.xy).rgb;\n\tvec2 uvShdw = vUv0_msdf.xy - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\t#ifdef USE_FWIDTH\n\tvec2 w = fwidth(vUv0_msdf.xy);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n\t#else\n\tfloat font_size = 16.0;\n\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n\t#endif\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\treturn tcolor;\n}\n",normalVS:"#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\nvec3 getNormal() {\n\t#ifdef SKIN\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t#elif defined(INSTANCING)\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t#else\n\tdNormalMatrix = matrix_normal;\n\t#endif\n\tvec3 tempNormal = vertex_normal;\n\t#ifdef MORPHING\n\t#ifdef MORPHING_NRM03\n\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t#endif\n\t#ifdef MORPHING_NRM47\n\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\ttempNormal += morphNormal;\n\t#endif\n\treturn normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float normalDetailMapRadian;\nuniform int normalDetailMapReverseMode;\nuniform int normalDetailMapTilingMode;\nbool normalDetailMapClampToBorder=false;\n#ifdef normalDetailMapMappingEnabled\nuniform int normalDetailMapMappingType;\nuniform vec2 normalDetailMapTiling;\nuniform vec2 normalDetailMapOffset;\nuniform mat4 normalDetailMapMappingMatrix;\nuniform vec3 normalDetailMapPlaneMappingCameraFront;\nuniform vec3 normalDetailMapGizmoPlanePosWS;\nuniform float normalDetailMapPlaneMappingDepth;\nuniform float material_normalDetailMapBumpiness;\n#endif\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n\t#ifdef MAPTEXTURE\n\t#ifdef normalDetailMapMappingEnabled\n\tvec2 ndUV= GetUV(normalDetailMapMappingType,$UV,normalDetailMapClampToBorder,normalDetailMapMappingMatrix,normalDetailMapTiling,normalDetailMapOffset,normalDetailMapRadian,normalDetailMapReverseMode,normalDetailMapTilingMode,normalDetailMapPlaneMappingCameraFront,normalDetailMapGizmoPlanePosWS,normalDetailMapPlaneMappingDepth);\n\t#else\n\tvec2 ndUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),normalDetailMapClampToBorder,vec2(1.0),vec2(0.0),normalDetailMapRadian,normalDetailMapReverseMode,normalDetailMapTilingMode);\n\t#endif\n\tif(!normalDetailMapClampToBorder)\n\t{\n\t\tvec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap,ndUV));\n\t\tnormalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n\t\treturn blendNormals(normalMap, normalDetailMap);\n\t}\n\telse return normalMap;\n\t#else\n\treturn normalMap;\n\t#endif\n}\n",normalInstancedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n\t#ifdef normalMapMappingEnabled\n\tvec2 nUV=GetUV(normalMapMappingType,$UV,normalMapClampToBorder,normalMapMappingMatrix,normalMapTiling,normalMapOffset,normalMapRadian,normalMapReverseMode,normalMapTilingMode,normalMapPlaneMappingCameraFront,normalMapGizmoPlanePosWS,normalMapPlaneMappingDepth);\n\t#else\n\tvec2 nUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),normalMapClampToBorder,vec2(1.0),vec2(0.0),normalMapRadian,normalMapReverseMode,normalMapTilingMode);\n\t#endif\n\tif(!normalMapClampToBorder)\n\t{\n\t\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap,nUV));\n\t\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n\t\tdNormalMap = addNormalDetail(normalMap);\n\t\tdNormalW = dTBN * dNormalMap;\n\t}\n\telse\n\t{\n\t\tdNormalW = normalize(dVertexNormalW);\n\t}\n}\n",normalMapFastPS:"uniform sampler2D texture_normalMap;\nuniform float normalMapRadian;\nuniform int normalMapReverseMode;\nuniform int normalMapTilingMode;\nbool normalMapClampToBorder=false;\n#ifdef normalMapMappingEnabled\nuniform int normalMapMappingType;\nuniform vec2 normalMapTiling;\nuniform vec2 normalMapOffset;\nuniform mat4 normalMapMappingMatrix;\nuniform vec3 normalMapPlaneMappingCameraFront;\nuniform vec3 normalMapGizmoPlanePosWS;\nuniform float normalMapPlaneMappingDepth;\n#endif\nvoid getNormal() {\n\t#ifdef normalMapMappingEnabled\n\tvec2 nUV=GetUV(normalMapMappingType,$UV,normalMapClampToBorder,normalMapMappingMatrix,normalMapTiling,normalMapOffset,normalMapRadian,normalMapReverseMode,normalMapTilingMode,normalMapPlaneMappingCameraFront,normalMapGizmoPlanePosWS,normalMapPlaneMappingDepth);\n\t#else\n\tvec2 nUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),normalMapClampToBorder,vec2(1.0),vec2(0.0),normalMapRadian,normalMapReverseMode,normalMapTilingMode);\n\t#endif\n\tif(!normalMapClampToBorder)\n\t{\n\t\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap,nUV));\n\t\tdNormalMap = addNormalDetail(normalMap);\n\t\tdNormalW = dTBN * dNormalMap;\n\t}\n\telse\n\t{\n\t\tdNormalW = normalize(dVertexNormalW);\n\t}\n}\n",normalSkinnedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalVertexPS:"void getNormal() {\n\tdNormalW = normalize(dVertexNormalW);\n}\n",normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\nuniform float opacityMapRadian;\nuniform int opacityMapReverseMode;\nuniform int opacityMapTilingMode;\nbool opacityClampToBorder=false;\n#ifdef opacityMapMappingEnabled\nuniform int opacityMapMappingType;\nuniform vec2 opacityMapTiling;\nuniform vec2 opacityMapOffset;\nuniform mat4 opacityMapMappingMatrix;\nuniform vec3 opacityMapPlaneMappingCameraFront;\nuniform vec3 opacityMapGizmoPlanePosWS;\nuniform float opacityMapPlaneMappingDepth;\n#endif\n#endif\nvoid getOpacity() {\n\tdAlpha = 1.0;\n\t#ifdef MAPFLOAT\n\tdAlpha *= material_opacity;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef opacityMapMappingEnabled\n\tvec2 aUV=GetUV(opacityMapMappingType,$UV,opacityClampToBorder,opacityMapMappingMatrix,opacityMapTiling,opacityMapOffset,opacityMapRadian,opacityMapReverseMode,opacityMapTilingMode,opacityMapPlaneMappingCameraFront,opacityMapGizmoPlanePosWS,opacityMapPlaneMappingDepth);\n\t#else\n\tvec2 aUV=GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),opacityClampToBorder,vec2(1.0),vec2(0.0),opacityMapRadian,opacityMapReverseMode,opacityMapTilingMode);\n\t#endif\n\tif(!opacityClampToBorder)\n\t\tdAlpha *= texture2D(texture_opacityMap,aUV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",outputAlphaPS:"gl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) {\n\tcolor.rgb = pow(color.rgb, vec3(0.5));\n\tcolor.rgb *= 1.0 / 8.0;\n\tcolor.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n\tcolor.a = ceil(color.a * 255.0) / 255.0;\n\tcolor.rgb /= color.a;\n\treturn color;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tgl_FragColor = textureCube(source, vec);\n\tif (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n",outputTex2DPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",packDepthMaskPS:"vec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres.x = 0.0;\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float heightMapRadian;\nuniform int heightMapReverseMode;\nuniform int heightMapTilingMode;\nbool heightMapClampToBorder=false;\n#ifdef heightMapMappingEnabled\nuniform int heightMapMappingType;\nuniform vec2 heightMapTiling;\nuniform vec2 heightMapOffset;\nuniform mat4 heightMapMappingMatrix;\nuniform vec3 heightMapPlaneMappingCameraFront;\nuniform vec3 heightMapGizmoPlanePosWS;\nuniform float heightMapPlaneMappingDepth;\n#endif\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\t#ifdef heightMapMappingEnabled\n\tfloat height=0.0;\n\tvec2 hUV= GetUV(heightMapMappingType,$UV,heightMapClampToBorder,heightMapMappingMatrix,heightMapTiling,heightMapOffset,heightMapRadian,heightMapReverseMode,heightMapTilingMode,heightMapPlaneMappingCameraFront,heightMapGizmoPlanePosWS,heightMapPlaneMappingDepth);\n\t#else\n\tvec2 hUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),heightMapClampToBorder,vec2(1.0),vec2(0.0),heightMapRadian,heightMapReverseMode,heightMapTilingMode);\n\t#endif\n\tif(hUV!=vec2(-1000.0))\n\t\theight = texture2D(texture_heightMap,hUV).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\n#endif\nvoid main(void) {\n\tvec4 tex  = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n\tvec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",particleVS:"vec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"void readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"void writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\twriteOutput();\n}\n",particleUpdaterInitPS:"varying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"float saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\tif (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"attribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\tvec3 normalMap = normalize(texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"void main(void) {\n\tgl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"uniform sampler2D source;\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\nvoid main(void) {\n\tfloat c = texture2D(source, vec2(0.0)).r;\n\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\tgl_FragColor = packFloat(diff);\n}\n",prefilterCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n\treturn fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = sqrt(1.0 - uv.x);\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tif (params.w==1.0 || params.w==3.0) {\n\t\tst = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n\t}\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tmat3 vecSpace = matrixFromVector(normalize(vec));\n\tvec3 color = vec3(0.0);\n\tconst int samples = $NUMSAMPLES;\n\tvec3 vect;\n\tfor(int i=0; i<samples; i++) {\n\t\tfloat sini = sin(float(i));\n\t\tfloat cosi = cos(float(i));\n\t\tfloat rand = rnd(vec2(sini, cosi));\n\t\tvect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\t\tcolor += $textureCube(source, vect).rgb;\n\t}\n\tcolor /= float(samples);\n\tgl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n",reflDirPS:"void getReflDir() {\n\tdReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",reflDirAnisoPS:"void getReflDir() {\n\tfloat roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-dViewDirW, bentNormal);\n}\n",reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {\n\tccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n#ifndef RIGHT_HANDED_CUBEMAP\n\tlookupVec.x *= -1.0;\n#endif\n\treturn $textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionDpAtlasPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n\tvec4 rect;\n\tfloat sx = saturate(mip - 2.0);\n\trect.x = sx * 0.5;\n\tfloat t = mip - rect.x * 6.0;\n\tfloat i = 1.0 - rect.x;\n\trect.y = min(t * 0.5, 0.75) * i + rect.x;\n\tfloat st = saturate(t);\n\trect.z = (1.0 - st * 0.5) * i;\n\trect.w = rect.z * 0.5;\n\tfloat rcRectZ = 1.0 / rect.z;\n\tfloat scaleFactor = 0.00390625 * rcRectZ;\n\tvec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n\tuv = uv * (vec2(1.0) - scale) + scale * 0.5;\n\tuv = uv * rect.zw + rect.xy;\n\treturn uv;\n}\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDir = normalize(cubeMapProject(tReflDirW));\n\tbool up = reflDir.y > 0.0;\n\tfloat scale = 0.90909090909090909090909090909091;\n\tvec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n\tfloat reflDirVer = abs(reflDir.y) + 1.0;\n\treflDirWarp /= reflDirVer;\n\treflDirWarp *= scale;\n\treflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n\tvec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tfloat mip = floor(bias);\n\tvec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\tmip = min(mip + 1.0, 5.0);\n\tvec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\ttex1 = mix(tex1, tex2, fract(bias));\n\ttex1 = processEnvironment(tex1);\n\treturn tex1;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubePS:"uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 refl = cubeMapProject(tReflDirW);\n#ifndef RIGHT_HANDED_CUBEMAP\n\trefl.x *= -1.0;\n#endif\n\tvec3 seam = calcSeam(refl);\n\tvec4 c0 = textureCube(texture_prefilteredCubeMap128, applySeam(refl, seam, 1.0 / 128.0));\n\tvec4 c1 = textureCube(texture_prefilteredCubeMap64, applySeam(refl, seam, 2.0 / 128.0));\n\tvec4 c2 = textureCube(texture_prefilteredCubeMap32, applySeam(refl, seam, 4.0 / 128.0));\n\tvec4 c3 = textureCube(texture_prefilteredCubeMap16, applySeam(refl, seam, 8.0 / 128.0));\n\tvec4 c4 = textureCube(texture_prefilteredCubeMap8, applySeam(refl, seam, 16.0 / 128.0));\n\tvec4 c5 = textureCube(texture_prefilteredCubeMap4, applySeam(refl, seam, 32.0 / 128.0));\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec4 cubes0;\n\tvec4 cubes1;\n\tif (bias < 1.0) {\n\t\tcubes0 = c0;\n\t\tcubes1 = c1;\n\t} else if (bias < 2.0) {\n\t\tcubes0 = c1;\n\t\tcubes1 = c2;\n\t} else if (bias < 3.0) {\n\t\tcubes0 = c2;\n\t\tcubes1 = c3;\n\t} else if (bias < 4.0) {\n\t\tcubes0 = c3;\n\t\tcubes1 = c4;\n\t} else {\n\t\tcubes0 = c4;\n\t\tcubes1 = c5;\n\t}\n\tvec4 cubeFinal = mix(cubes0, cubes1, fract(bias));\n\treturn processEnvironment($DECODE(cubeFinal).rgb);\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tvec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n\treturn refl;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = vNormalV;\n\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n\tfloat vn = dot(viewVec, Normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n\treturn refrVec;\n}\nvoid addRefraction() {\n\tvec3 tmp = dReflDirW;\n\tvec4 tmp2 = dReflection;\n\tdReflection = vec4(0.0);\n\tdReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\taddReflection();\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n\tdReflDirW = tmp;\n\tdReflection = tmp2;\n}\n",reprojectPS:"\nvarying vec2 vUv0;\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\n#ifdef REPROJECT_CUBEMAP_ROTATION\nuniform mat3 reprojectCubeMapRotationMatrix;\n#endif\nuniform vec4 params;\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\nconst float PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 decodeLinear(vec4 source) {\n\treturn source.rgb;\n}\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec3 decodeGamma(vec4 source) {\n\treturn pow(source.xyz, vec3(2.2));\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec3 decodeRGBE(vec4 source) {\n\tif (source.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn source.xyz * pow(2.0, source.w * 255.0 - 128.0);\n\t}\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\nvec3 modifySeams(vec3 dir, float amount) {\n\tif (amount != 1.0) {\n\t\tvec3 adir = abs(dir);\n\t\tfloat M = max(max(adir.x, adir.y), adir.z);\n\t\tif (adir.x == M) {\n\t\t\tdir.y *= amount;\n\t\t\tdir.z *= amount;\n\t\t}\n\t\telse if (adir.y == M) {\n\t\t\tdir.x *= amount;\n\t\t\tdir.z *= amount;\n\t\t} else {\n\t\t\tdir.x *= amount;\n\t\t\tdir.y *= amount;\n\t\t}\n\t}\n\treturn dir;\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(atan(dir.z, dir.x), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * cos(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * sin(uv.x));\n}\nvec4 sampleEquirect(vec2 sph) {\n\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\nvec4 sampleEquirect(vec3 dir) {\n\treturn sampleEquirect(toSpherical(dir));\n}\nvec4 sampleCubemap(vec3 dir) {\n\treturn textureCube(sourceCube, modifySeams(dir, sourceCubeSeamScale()));\n}\nvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\nvec4 sampleOctahedral(vec3 dir) {\n\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\nvec4 sampleOctahedral(vec2 sph) {\n\treturn sampleOctahedral(fromSpherical(sph));\n}\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\t#ifdef REPROJECT_CUBEMAP_ROTATION\n\t\tvec = vec * reprojectCubeMapRotationMatrix;\n\t#endif\n\treturn normalize(modifySeams(vec, 1.0 / targetCubeSeamScale()));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 a = normalize(cross(n, vec3(0, 1, 0)));\n\tvec3 b = cross(n, a);\n\treturn mat3(a, b, n);\n}\nfloat rnd(int i) {\n\tfloat sini = sin(float(i));\n\tfloat cosi = cos(float(i));\n\treturn fract(sin(dot(vec2(sini, cosi), vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nvec3 hemisphereSamplePhong(vec2 uv, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\treturn vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n}\n#include <prefilterPBRPS>\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec2 sph = toSpherical(TARGET_FUNC());\n\t\tvec2 sphu = dFdx(sph);\n\t\tvec2 sphv = dFdy(sph);\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n\t\t\tfor (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(sph +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphu * (u / NUM_SAMPLES_SQRT - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphv * (v / NUM_SAMPLES_SQRT - 0.5)));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n\t}\n}\nvec4 prefilter() {\n\tvec3 vec = TARGET_FUNC();\n\tmat3 vecSpace = matrixFromVectorSlow(vec);\n\tvec3 result = vec3(0.0);\n\tfor (int i=0; i<NUM_SAMPLES; ++i) {\n\t\tvec2 uv = vec2(float(i) / float(NUM_SAMPLES), rnd(i));\n\t\tvec3 dir = vecSpace * hemisphereSamplePhong(uv, specularPower());\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(dir));\n\t}\n\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\nvec4 prefilterPBR() {\n\tvec3 vec = TARGET_FUNC();\n\treturn ENCODE_FUNC(prefilterPBR(vec));\n}\nuniform vec3 up;\nvec4 irradiance() {\n\tvec3 vec = TARGET_FUNC();\n\tvec3 N = normalize(vec);\n\tvec3 irradiance = vec3(0.0);\n\tvec3 up = up;\n\tvec3 right = normalize(cross(up, N));\n\tup\t\t = normalize(cross(N, right));\n\tconst float sampleDelta = 0.025;\n\tfloat nrSamples = 0.0;\n\tfor(float phi = 0.0; phi < 2.0 * PI; phi += sampleDelta)\n\t{\n\t\tfor(float theta = 0.0; theta < 0.5 * PI; theta += sampleDelta)\n\t\t{\n\t\t\tvec3 tangentSample = vec3(sin(theta) * cos(phi),  sin(theta) * sin(phi), cos(theta));\n\t\t\tvec3 sampleVec = tangentSample.x * right + tangentSample.y * up + tangentSample.z * N;\n\t\t\tirradiance += DECODE_FUNC(SOURCE_FUNC(sampleVec)) * cos(theta) * sin(theta);\n\t\t\tnrSamples++;\n\t\t}\n\t}\n\tirradiance = PI * irradiance * (1.0 / nrSamples);\n\treturn ENCODE_FUNC(irradiance);\n}\nvoid main(void) {\n\tgl_FragColor = PROCESS_FUNC();\n}\n",rgbmPS:"vec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n\treturn decodeRGBM(textureCube(tex, uvw));\n}\n",screenDepthPS:"uniform sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\tz = z * 2.0 - 1.0;\n\treturn 1.0 / (camera_params.z * z + camera_params.w);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef GL2\n\treturn linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n\t#else\n\treturn unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"const float maxCascades = 4.0;\nmat4 cascadeShadowMat;\nvoid getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tfloat cascadeIndex = 0.0;\n\tfor (float i = 0.0; i < maxCascades; i++) {\n\t\tif (depth < shadowCascadeDistances[int(i)]) {\n\t\t\tcascadeIndex = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tcascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);\n\t#ifdef GL2\n\t\tcascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];\n\t#else\n\t\tif (cascadeIndex == 0.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[0];\n\t\t}\n\t\telse if (cascadeIndex == 1.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[1];\n\t\t}\n\t\telse if (cascadeIndex == 2.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[2];\n\t\t}\n\t\telse {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[3];\n\t\t}\n\t#endif\n}\nvoid fadeShadow(float shadowCascadeDistances[4]) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {\n\t\tdShadowCoord.z = -9999999.0;\n\t}\n}\n",shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n\tfloat distScale = length(dLightDirW);\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - dLightPosW;\n\tdLightDirW = dir;\n}\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tdShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xy /= projPos.w;\n\tdShadowCoord.xy = projPos.xy;\n\tdShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordVS:"void getLightDirPoint(vec3 lightPosW) {\n\tvec3 lightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(lightDirW);\n\tdLightPosW = lightPosW;\n}\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tvMainShadowUv = projPos;\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tvMainShadowUv = projPos;\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n\treturn clamp((b - a)*1000.0, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n\tmat3 shadowKernel;\n\tvec3 shadowCoord = dShadowCoord;\n\tvec3 shadowZ = vec3(shadowCoord.z);\n\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\tvec3 shadowCoord = dShadowCoord;\n\tfloat xoffset = 1.0 / shadowParams.x;\n\tfloat dx0 = -xoffset;\n\tfloat dx1 = xoffset;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\tdepthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\tdepthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\tdepthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\tdepthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n\tdepthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\tdepthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\tdepthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\tdepthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\treturn _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\tvec3 tc = normalize(dir);\n\tvec3 tcAbs = abs(tc);\n\tvec4 dirX = vec4(1,0,0, tc.x);\n\tvec4 dirY = vec4(0,1,0, tc.y);\n\tfloat majorAxisLength = tc.z;\n\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\tdirX = vec4(0,0,1, tc.z);\n\t\tdirY = vec4(0,1,0, tc.y);\n\t\tmajorAxisLength = tc.x;\n\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\tdirX = vec4(1,0,0, tc.x);\n\t\tdirY = vec4(0,0,1, tc.z);\n\t\tmajorAxisLength = tc.y;\n\t}\n\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\tvec3 dx0 = -xoffset;\n\tvec3 dy0 = -yoffset;\n\tvec3 dx1 = xoffset;\n\tvec3 dy1 = yoffset;\n\tmat3 shadowKernel;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n\treturn _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = gammaCorrectInput(sum);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",shadowStandardGL2VSPS:"float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\n",shadowStandardVSPS:"#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\n",shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * Z;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec4 c = texture2D(tex, texCoords);\n\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\treturn calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSMVSPS:"float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z += shadowParams.z;\n\tdShadowCoord.xyz /= vMainShadowUv.w;\n\tdShadowCoord.z = min(dShadowCoord.z, 1.0);\n\treturn $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nmat4 getBoneMatrix(const in float i) {\n\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tv1 = matrix_pose[int(3.0 * i)];\n\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tgl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n",skyboxVS:"attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nvarying vec3 vViewDir;\nvoid main(void) {\n\tmat4 view = matrix_view;\n\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\tgl_Position.z = gl_Position.w - 0.00001;\n\tvViewDir = aPosition;\n}\n",skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvoid main(void) {\n#ifdef CUBEMAP_ROTATION\n\tvec3 dir=vViewDir * cubeMapRotationMatrix;\n#else\n\tvec3 dir=vViewDir;\n#endif\n#ifndef RIGHT_HANDED_CUBEMAP\n\tdir.x *= -1.0;\n#endif\n\tvec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)).rgb);\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",skyboxPrefilteredCubePS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvoid main(void) {\n\tvec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\nuniform float specularMapRadian;\nuniform int specularMapReverseMode;\nuniform int specularMapTilingMode;\nbool specularMapClampToBorder=false;\n#ifdef specularMapMappingEnabled\nuniform int specularMapMappingType;\nuniform vec2 specularMapTiling;\nuniform vec2 specularMapOffset;\nuniform mat4 specularMapMappingMatrix;\nuniform vec3 specularMapPlaneMappingCameraFront;\nuniform vec3 specularMapGizmoPlanePosWS;\nuniform float specularMapPlaneMappingDepth;\n#endif\n#endif\nvoid getSpecularity(\n\t#ifdef PBR\n\t\tbool pbr\n\t#endif\n) {\n\tdSpecularity = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdSpecularity *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\t#ifdef specularMapMappingEnabled\n\tvec2 sUV=GetUV(specularMapMappingType,$UV,specularMapClampToBorder,specularMapMappingMatrix,specularMapTiling,specularMapOffset,specularMapRadian,specularMapReverseMode,specularMapTilingMode,specularMapPlaneMappingCameraFront,specularMapGizmoPlanePosWS,specularMapPlaneMappingDepth);\n\t#else\n\tvec2 sUV= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),specularMapClampToBorder,vec2(1.0),vec2(0.0),specularMapRadian,specularMapReverseMode,specularMapTilingMode);\n\t#endif\n\tif(!specularMapClampToBorder)\n\t\tdSpecularity *= texture2D(texture_specularMap,sUV ).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",specularAaNonePS:"float antiAliasGlossiness(float power) {\n\treturn power;\n}\n",specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * mix(1.0, toksvig, material_bumpiness);\n}\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * toksvig;\n}\n",spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n\tfloat cosAngle = dot(dLightDirNormW, lightSpotDirW);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"void main(void) {\n\tdDiffuseLight = vec3(0);\n\tdSpecularLight = vec3(0);\n\tdReflection = vec4(0);\n\tdSpecularity = vec3(0);\n\t#ifdef CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec4(0);\n\t#endif\n",startVS:"void main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\tnineSlicedUv = vUv0;\n",startNineSlicedTiledPS:"\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n",storeEVSMPS:"float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"vec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\nvec3 getObjectSpaceUp() {\n\treturn normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",TBNPS:"uniform float normalMapRadian;\nuniform int normalMapReverseMode;\nuniform int normalMapTilingMode;\nbool normalMapClampToBorder=false;\n#ifdef normalMapMappingEnabled\nuniform int normalMapMappingType;\nuniform vec2 normalMapTiling;\nuniform vec2 normalMapOffset;\nuniform mat4 normalMapMappingMatrix;\nuniform vec3 normalMapPlaneMappingCameraFront;\nuniform vec3 normalMapGizmoPlanePosWS;\nuniform float normalMapPlaneMappingDepth;\n#endif\nvoid getTBN() {\n\tdTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",TBNderivativePS:"uniform float normalMapRadian;\nuniform int normalMapReverseMode;\nuniform int normalMapTilingMode;\nbool normalMapClampToBorder=false;\n#ifdef normalMapMappingEnabled\nuniform int normalMapMappingType;\nuniform vec2 normalMapTiling;\nuniform vec2 normalMapOffset;\nuniform mat4 normalMapMappingMatrix;\nuniform vec3 normalMapPlaneMappingCameraFront;\nuniform vec3 normalMapGizmoPlanePosWS;\nuniform float normalMapPlaneMappingDepth;\n#endif\nvoid getTBN() {\n\t#ifdef normalMapMappingEnabled\n\tvec2 uv = GetUV(normalMapMappingType,$UV,normalMapClampToBorder,normalMapMappingMatrix,normalMapTiling,normalMapOffset,normalMapRadian,normalMapReverseMode,normalMapTilingMode,normalMapPlaneMappingCameraFront,normalMapGizmoPlanePosWS,normalMapPlaneMappingDepth);\n\t#else\n\tvec2 uv= GetUV_Uv0Uv1(vec4($UV, 0.0, 0.0),normalMapClampToBorder,vec2(1.0),vec2(0.0),normalMapRadian,normalMapReverseMode,normalMapTilingMode);\n\t#endif\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, dVertexNormalW );\n\tvec3 dp1perp = cross( dVertexNormalW, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat invmax = 1.0 / sqrt( max( dot(T,T), dot(B,B) ) );\n\tdTBN = mat3( T * invmax, B * invmax, dVertexNormalW );\n}\n",TBNfastPS:"uniform float normalMapRadian;\nuniform int normalMapReverseMode;\nuniform int normalMapTilingMode;\nbool normalMapClampToBorder=false;\n#ifdef normalMapMappingEnabled\nuniform int normalMapMappingType;\nuniform vec2 normalMapTiling;\nuniform vec2 normalMapOffset;\nuniform mat4 normalMapMappingMatrix;\nuniform vec3 normalMapPlaneMappingCameraFront;\nuniform vec3 normalMapGizmoPlanePosWS;\nuniform float normalMapPlaneMappingDepth;\n#endif\nvoid getTBN() {\n\tdTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",TBNObjectSpacePS:"void getTBN() {\n\tvec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n\tvec3 T = cross(dVertexNormalW, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\t\tif (dVertexNormalW.x==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,1,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.y==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,0,1));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.z==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(1,0,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",tonemappingAcesPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNonePS:"vec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\nvec2 getTextureMorphCoords() {\n\tfloat vertexId = morph_vertex_id;\n\tvec2 textureSize = morph_tex_params.xy;\n\tvec2 invTextureSize = morph_tex_params.zw;\n\tfloat morphGridV = floor(vertexId * invTextureSize.x);\n\tfloat morphGridU = vertexId - (morphGridV * textureSize.x);\n\treturn (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",uv0VS:"#ifdef NINESLICED\nvec4 getUv0(int mappingType) {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn vec4(uv,0.0,0.0);\n}\n#else\n#define TEXTURE_MAPPING_UV0 0\n#define TEXTURE_MAPPING_UV1 1\n#define TEXTURE_MAPPING_CUBE 2\n#define TEXTURE_MAPPING_SPHERE 3\n#define TEXTURE_MAPPING_CYLINDER 4\n#define TEXTURE_MAPPING_PLANE 5\n#define TEXTURE_MAPPING_CAMERA 6\n#define TEXTURE_MAPPING_CAMERA_ADAPTIVE 7\nvec2 getUv0(vec2 tiling, vec2 offset) {\n\treturn vertex_texCoord0 * tiling + offset;\n}\nvec4 getUv_UV0() {\n\treturn vec4(vertex_texCoord0.x,vertex_texCoord0.y,0.0,0.0);\n}\n#define SphereCylinderCube 0\n#define PlaneCameraCameraAdaptive 1\nvec4 getUv_SphereCylinderCube(int mappingType,mat4 mappingMatrix)\n{\n\tmat4 tMappingMatrix=mappingMatrix;\n\tif(mappingType==TEXTURE_MAPPING_CUBE)\n\t{\n\t\ttMappingMatrix[3][0]=tMappingMatrix[3][1]=tMappingMatrix[3][2]=0.0;\n\t\treturn mappingMatrix*vec4(vertex_normal,1.0);\n\t}\n\treturn tMappingMatrix*vec4(vertex_position,1.0);\n}\nvec4 getUv_PlaneCameraCameraAdaptive(mat4 projViewMatrix)\n{\n\treturn projViewMatrix*matrix_model*vec4(vertex_position,1.0);\n}\nvec4 getUv0(int mappingType,mat4 mappingMatrix)\n{\n\tif(mappingType==TEXTURE_MAPPING_CAMERA||mappingType==TEXTURE_MAPPING_CAMERA_ADAPTIVE||mappingType==TEXTURE_MAPPING_PLANE)\n\t   return getUv_PlaneCameraCameraAdaptive(mappingMatrix);\n\telse if(mappingType==TEXTURE_MAPPING_SPHERE||mappingType==TEXTURE_MAPPING_CUBE||mappingType==TEXTURE_MAPPING_CYLINDER)\n\t\treturn getUv_SphereCylinderCube(mappingType,mappingMatrix);\n\telse if(mappingType==TEXTURE_MAPPING_UV0)\n\t\treturn getUv_UV0();\n\treturn vec4(0.0);\n}\n#endif\n",uv1VS:"#define TEXTURE_MAPPING_UV0 0\n#define TEXTURE_MAPPING_UV1 1\n#define TEXTURE_MAPPING_CUBE 2\n#define TEXTURE_MAPPING_SPHERE 3\n#define TEXTURE_MAPPING_CYLINDER 4\n#define TEXTURE_MAPPING_PLANE 5\n#define TEXTURE_MAPPING_CAMERA 6\n#define TEXTURE_MAPPING_CAMERA_ADAPTIVE 7\nvec2 getUv1(vec2 tiling, vec2 offset) {\n\treturn vertex_texCoord1 * tiling + offset;\n}\nvec4 getUv_UV1() {\n\treturn vec4(vertex_texCoord1.x,vertex_texCoord1.y,0.0,0.0);\n}\n#ifndef SphereCylinderCube\nvec4 getUv_SphereCylinderCube(int mappingType,mat4 mappingMatrix)\n{\n\tmat4 tMappingMatrix=mappingMatrix;\n\tif(mappingType==TEXTURE_MAPPING_CUBE)\n\t{\n\t\ttMappingMatrix[3][0]=tMappingMatrix[3][1]=tMappingMatrix[3][2]=0.0;\n\t\treturn mappingMatrix*vec4(vertex_normal,1.0);\n\t}\n\treturn tMappingMatrix*vec4(vertex_position,1.0);\n}\n#endif\n#ifndef PlaneCameraCameraAdaptive\nvec4 getUv_PlaneCameraCameraAdaptive(mat4 projViewMatrix)\n{\n\treturn projViewMatrix*matrix_model*vec4(vertex_position,1.0);\n}\n#endif\nvec4 getUv1(int mappingType,mat4 mappingMatrix)\n{\n\tif(mappingType==TEXTURE_MAPPING_CAMERA||mappingType==TEXTURE_MAPPING_CAMERA_ADAPTIVE||mappingType==TEXTURE_MAPPING_PLANE)\n\t   return getUv_PlaneCameraCameraAdaptive(mappingMatrix);\n\telse if(mappingType==TEXTURE_MAPPING_SPHERE||mappingType==TEXTURE_MAPPING_CUBE||mappingType==TEXTURE_MAPPING_CYLINDER)\n\t\treturn getUv_SphereCylinderCube(mappingType,mappingMatrix);\n\telse if(mappingType==TEXTURE_MAPPING_UV1)\n\t\treturn getUv_UV1();\n\treturn vec4(0.0);\n}\n",viewDirPS:"void getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n"},Dt={alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"void addAmbient() {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientPrefilteredCubePS:"#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(cubeMapRotate(dNormalW), 1.0 - 1.0 / 4.0);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tdDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n",ambientPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(cubeMapRotate(dNormalW), 1.0 - 1.0 / 4.0);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tdDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n",ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n\tvec3 n = cubeMapRotate(dNormalW);\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\nvoid applyAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\tdAo *= texture2D(texture_aoMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight *= dAo;\n}\n",aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstPS:"void occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstSimplePS:"void occludeSpecular() {\n\tfloat specOcc = dAo;\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",bakeDirLmEndPS:"\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",bakeLmEndPS:"\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n",basePS:"uniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:"attribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\n",baseNineSlicedPS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n\treturn maxBias;\n}\n",blurVSMPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef PACKED\n\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t#endif\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\t#ifdef PACKED\n\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t#else\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t#endif\n}\n",clearCoatPS:"#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatMap;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccSpecularity *= texture2D(texture_clearCoatMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGlossiness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatNormalMap;\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n\t#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2D(texture_clearCoatNormalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness));\n\tccNormalW = dTBN * normalMap;\n\t#else\n\tccNormalW = normalize(dVertexNormalW);\n\t#endif\n\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n}\n",clusteredLightLoopPS:"\nvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\nif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\tclusterV = (clusterV + 0.5) * clusterTextureSize.z;\n\tconst float maxLightCells = 256.0 / 4.0;\n\tfor (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {\n\t\tvec4 lightIndices = texture2D(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV));\n\t\tvec4 indices = lightIndices * 255.0;\n\t\tif (indices.x <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.x);\n\t\tif (indices.y <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.y);\n\t\tif (indices.z <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.z);\n\t\tif (indices.w <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.w);\n\t\tif (lightCellIndex > clusterPixelsPerCell) {\n\t\t\tbreak;\n\t\t}\n\t}\n}\n",clusteredLightPS:"uniform sampler2D clusterWorldTexture;\nuniform sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\nuniform float clusterPixelsPerCell;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec4 lightsTextureInvSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nfloat DecodeClusterFloat4(vec4 data) {\n\treturn dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\nfloat DecodeClusterFloat2(vec2 data) {\n\treturn dot(data, vec2(1.0, 1.0 / 255.0));\n}\nvoid EvaluateClusterLight(float lightIndex) {\n\tfloat lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;\n\tvec4 lightInfo = texture2D(lightsTexture8, vec2(0.5 * lightsTextureInvSize.z, lightV));\n\tfloat lightType = lightInfo.x;\n\tfloat lightShape = lightInfo.y;\n\tfloat falloffMode = lightInfo.z;\n\tvec4 colorA = texture2D(lightsTexture8, vec2(1.5 * lightsTextureInvSize.z, lightV));\n\tvec4 colorB = texture2D(lightsTexture8, vec2(2.5 * lightsTextureInvSize.z, lightV));\n\tvec3 lightColor = vec3(\n\t\tDecodeClusterFloat2(colorA.xy),\n\t\tDecodeClusterFloat2(colorA.zw),\n\t\tDecodeClusterFloat2(colorB.xy)\n\t) * clusterCompressionLimit0.y;\n\tvec4 coneAngle = texture2D(lightsTexture8, vec2(3.5 * lightsTextureInvSize.z, lightV));\n\tfloat innerConeAngleCos = DecodeClusterFloat2(coneAngle.xy) * 2.0 - 1.0;\n\tfloat outerConeAngleCos = DecodeClusterFloat2(coneAngle.zw) * 2.0 - 1.0;\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tvec4 lightPosRange = texture2D(lightsTextureFloat, vec2(0.5 * lightsTextureInvSize.x, lightV));\n\t\tvec3 lightPos = lightPosRange.xyz;\n\t\tfloat range = lightPosRange.w;\n\t\tvec4 lightDir_Unused = texture2D(lightsTextureFloat, vec2(1.5 * lightsTextureInvSize.x, lightV));\n\t\tvec3 lightDir = lightDir_Unused.xyz;\n\t#else\n\t\tvec4 encPosX = texture2D(lightsTexture8, vec2(4.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encPosY = texture2D(lightsTexture8, vec2(5.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encPosZ = texture2D(lightsTexture8, vec2(6.5 * lightsTextureInvSize.z, lightV));\n\t\tvec3 lightPos = vec3(\n\t\t\tDecodeClusterFloat4(encPosX),\n\t\t\tDecodeClusterFloat4(encPosY),\n\t\t\tDecodeClusterFloat4(encPosZ)\n\t\t) * clusterBoundsDelta + clusterBoundsMin;\n\t\tvec4 encRange = texture2D(lightsTexture8, vec2(7.5 * lightsTextureInvSize.z, lightV));\n\t\tfloat range = DecodeClusterFloat4(encRange) * clusterCompressionLimit0.x;\n\t\tvec4 encDirX = texture2D(lightsTexture8, vec2(8.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encDirY = texture2D(lightsTexture8, vec2(9.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encDirZ = texture2D(lightsTexture8, vec2(10.5 * lightsTextureInvSize.z, lightV));\n\t\tvec3 lightDir = vec3(\n\t\t\tDecodeClusterFloat4(encDirX),\n\t\t\tDecodeClusterFloat4(encDirY),\n\t\t\tDecodeClusterFloat4(encDirZ)\n\t\t) * 2.0 - 1.0;\n\t#endif\n\tgetLightDirPoint(lightPos);\n\tdAtten = getFalloffLinear(range);\n\tif (dAtten > 0.00001) {\n\t\tif (lightType > 0.5) {\n\t\t\tdAtten *= getSpotEffect(lightDir, innerConeAngleCos, outerConeAngleCos);\n\t\t}\n\t\tdAtten *= getLightDiffuse();\n\t\tdDiffuseLight += dAtten * lightColor;\n\t}\n}\n",combineClearCoatPS:"vec3 combineColorCC() {\n\treturn combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight;\n}\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n\treturn (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",cookiePS:"vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tnrdir = cubeMapRotate(nrdir);\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn posonbox - envBoxPos;\n}\n",cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",diffusePS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\nvec3 addAlbedoDetail(vec3 albedo) {\n\t#ifdef MAPTEXTURE\n\tvec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n\t#else\n\treturn albedo;\n\t#endif\n}\n",dilatePS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n\tvec4 c = texture2D(source, vUv0);\n\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\tgl_FragColor = c;\n}\n",dpAtlasQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tuv = uv * 2.0 - vec2(1.0);\n\tuv *= params.xy;\n\tuv = uv * 0.5 + 0.5;\n\tgl_FragColor = texture2D(source, uv);\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n\tvec3 emission = vec3(1.0);\n\t#ifdef MAPFLOAT\n\temission *= material_emissiveIntensity;\n\t#endif\n\t#ifdef MAPCOLOR\n\temission *= material_emissive;\n\t#endif\n\t#ifdef MAPTEXTURE\n\temission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\temission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n\treturn emission;\n}\n",endPS:"\t#ifdef CLEARCOAT\n\tgl_FragColor.rgb = combineColorCC();\n\t#else\n\tgl_FragColor.rgb = combineColor();\n\t#endif\n\tgl_FragColor.rgb += getEmission();\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\t#ifndef HDR\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t#endif\n",endVS:"\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffWindow(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n\tfloat d = length(dLightDirW);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\treturn vec3(0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\tfloat scale = 1.0 - 1.0 / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\tfloat scale = invRecMipSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat M = max(avec.x, max(avec.y, avec.z));\n\treturn vec3(avec.x != M ? 1.0 : 0.0,\n\t\t\t\tavec.y != M ? 1.0 : 0.0,\n\t\t\t\tavec.z != M ? 1.0 : 0.0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec * (seam * -scale + vec3(1.0));\n}\n",fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\tfogFactor = gammaCorrectInput(fogFactor);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"float dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\treturn color;\n}\n",fresnelSchlickPS:"\nuniform float material_fresnelFactor;\nvoid getFresnel() {\n\tfloat fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n\tfloat fresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= dGlossiness * dGlossiness;\n\tdSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n\t#ifdef CLEARCOAT\n\tfresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n\tfresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= ccGlossiness * ccGlossiness;\n\tccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n\t#endif\n}\n",fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\treturn texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\treturn texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\treturn textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\n",gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n\treturn pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n\treturn pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\tvec4 rgba = texture2D(tex, uv);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\tvec4 rgba = texture2D(tex, uv, bias);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\tvec4 rgba = textureCube(tex, uvw);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\t#ifdef HDR\n\treturn color;\n\t#else\n\tcolor += vec3(0.0000001);\n\treturn pow(color, vec3(0.45));\n\t#endif\n}\n",genParaboloidPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tfloat side = uv.x < 0.5? 1.0 : -1.0;\n\tvec2 tc;\n\ttc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n\ttc.y = uv.y * 2.0 - 1.0;\n\tconst float scale = 1.1;\n\ttc *= scale;\n\tvec3 dir;\n\tdir.y = (dot(tc, tc) - 1.0) * side;\n\tdir.xz = tc * -2.0;\n\tdir.x *= -side * params.y;\n\tdir = fixSeams(dir, params.x);\n\tvec4 color = textureCube(source, dir, -100.0);\n\tgl_FragColor = color;\n}\n",gles3PS:"#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",instancingVS:"attribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"float getLightDiffuse() {\n\treturn max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\tvec3 dir = texture2D(texture_dirLightMap, $UV).xyz;\n\tif (dot(dir, vec3(1.0)) < 0.00001) {\n\t\tdDiffuseLight += color;\n\t} else {\n\t\tdLightDirNormW = normalize(dir * 2.0 - vec3(1.0));\n\t\tfloat vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n\t\tfloat flight = saturate(dot(dLightDirNormW, -dNormalW));\n\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\tdDiffuseLight += color * nlight * 2.0;\n\t}\n\tdSpecularLight += color * getLightSpecular();\n}\n",lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n\tvec3 lm = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tlm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tlm *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight += lm;\n}\n",lightmapSingleVertPS:"void addLightMap() {\n\tdDiffuseLight += saturate(vVertexColor.$CH);\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tvec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\tfloat NoH = dot(tNormalW, h);\n\tfloat ToH = dot(dTBN[0], h);\n\tfloat BoH = dot(dTBN[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(dTBN[0], dViewDirW);\n\tfloat BoV = dot(dTBN[1], dViewDirW);\n\tfloat ToL = dot(dTBN[0], -dLightDirNormW);\n\tfloat BoL = dot(dTBN[1], -dLightDirNormW);\n\tfloat NoV = dot(tNormalW, dViewDirW);\n\tfloat NoL = dot(tNormalW, -dLightDirNormW);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tvec3 h = normalize( -dLightDirNormW + dViewDirW );\n\tfloat nh = max( dot( h, tNormalW ), 0.0 );\n\tfloat specPow = exp2(tGlossiness * 11.0);\n\tspecPow = antiAliasGlossiness(specPow);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n\tfloat specPow = tGlossiness;\n\tspecPow = antiAliasGlossiness(specPow);\n\treturn pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dReflDirW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",ltc:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tfloat radius = max(length(halfWidth), length(halfWidth));\n\tdSphereRadius = radius;\n\tvec3 f = normalize(lightPos-view_position);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\tcoords.coord0 = lightPos + w * radius - h * radius;\n\tcoords.coord1 = lightPos - w * radius - h * radius;\n\tcoords.coord2 = lightPos - w * radius + h * radius;\n\tcoords.coord3 = lightPos + w * radius + h * radius;\n\treturn coords;\n}\nvec2 dLTCUV;\n#ifdef CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float tGlossiness, vec3 tNormalW)\n{\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\treturn LTC_Uv( tNormalW, dViewDirW, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 tSpecularity)\n{\n\tvec4 t2 = texture2D( areaLightsLutTex2, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt2 *= vec4(0.693103,1,1,1);\n\tt2 += vec4(0.306897,0,0,0);\n\t#endif\n\treturn tSpecularity * t2.x + ( vec3( 1.0 ) - tSpecularity) * t2.y;\n}\nvoid calcLTCLightValues()\n{\n\tdLTCUV = getLTCLightUV(dGlossiness, dNormalW);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, dSpecularityNoFres);\n#ifdef CLEARCOAT\n\tccLTCUV = getLTCLightUV(ccGlossiness, ccNormalW);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(ccSpecularityNoFres));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n\tcalcLTCLightValues();\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n\tcalcLTCLightValues();\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = cross(V1, V2);\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2D( areaLightsLutTex2, uv ).w;\n\treturn formFactor*scale;\n}\nfloat getRectLightDiffuse() {\n\treturn LTC_EvaluateRect( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse() {\n\treturn LTC_EvaluateDisk( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getSphereLightDiffuse() {\n\tfloat falloff = dSphereRadius / (dot(dLightDirW, dLightDirW) + dSphereRadius);\n\treturn getLightDiffuse()*falloff;\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2D( areaLightsLutTex1, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n\tt1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n\t#endif\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular() {\n\treturn calcRectLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getRectLightSpecularCC() {\n\treturn calcRectLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat calcDiskLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getDiskLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat getSphereLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getSphereLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n",metalnessPS:"void processMetalness(float metalness) {\n\tconst float dielectricF0 = 0.04;\n\tdSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n\tdAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\nvoid getSpecularity() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2D(texture_metalnessMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tprocessMetalness(metalness);\n}\n",msdfPS:"uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\t#ifdef USE_FWIDTH\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n\t#else\n\tfloat font_size = 16.0;\n\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n\t#endif\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\treturn tcolor;\n}\n",normalVS:"#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\nvec3 getNormal() {\n\t#ifdef SKIN\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t#elif defined(INSTANCING)\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t#else\n\tdNormalMatrix = matrix_normal;\n\t#endif\n\tvec3 tempNormal = vertex_normal;\n\t#ifdef MORPHING\n\t#ifdef MORPHING_NRM03\n\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t#endif\n\t#ifdef MORPHING_NRM47\n\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\ttempNormal += morphNormal;\n\t#endif\n\treturn normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n\t#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n\tnormalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n\treturn blendNormals(normalMap, normalDetailMap);\n\t#else\n\treturn normalMap;\n\t#endif\n}\n",normalInstancedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalMapFastPS:"uniform sampler2D texture_normalMap;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalSkinnedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalVertexPS:"void getNormal() {\n\tdNormalW = normalize(dVertexNormalW);\n}\n",normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n\tdAlpha = 1.0;\n\t#ifdef MAPFLOAT\n\tdAlpha *= material_opacity;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",outputAlphaPS:"gl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) {\n\tcolor.rgb = pow(color.rgb, vec3(0.5));\n\tcolor.rgb *= 1.0 / 8.0;\n\tcolor.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n\tcolor.a = ceil(color.a * 255.0) / 255.0;\n\tcolor.rgb /= color.a;\n\treturn color;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tif (params.y == -1.0) {\n\t\tvec.x *= -1.0;\n\t}\n\tgl_FragColor = textureCube(source, vec);\n\tif (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n",outputTex2DPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",packDepthMaskPS:"vec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres.x = 0.0;\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2D(texture_heightMap, $UV).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\n#endif\nvoid main(void) {\n\tvec4 tex  = texture2DSRGB(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));\n\tvec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",particleVS:"vec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"void readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"void writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\twriteOutput();\n}\n",particleUpdaterInitPS:"varying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"float saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\tif (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifdef USE_MESH\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"attribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\tvec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"void main(void) {\n\tgl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"uniform sampler2D source;\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\nvoid main(void) {\n\tfloat c = texture2D(source, vec2(0.0)).r;\n\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\tgl_FragColor = packFloat(diff);\n}\n",prefilterCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n\treturn fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = sqrt(1.0 - uv.x);\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tif (params.w==1.0 || params.w==3.0) {\n\t\tst = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n\t}\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tmat3 vecSpace = matrixFromVector(normalize(vec));\n\tvec3 color = vec3(0.0);\n\tconst int samples = $NUMSAMPLES;\n\tvec3 vect;\n\tfor(int i=0; i<samples; i++) {\n\t\tfloat sini = sin(float(i));\n\t\tfloat cosi = cos(float(i));\n\t\tfloat rand = rnd(vec2(sini, cosi));\n\t\tvect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\t\tcolor += $textureCube(source, vect).rgb;\n\t}\n\tcolor /= float(samples);\n\tgl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n",reflDirPS:"void getReflDir() {\n\tdReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",reflDirAnisoPS:"void getReflDir() {\n\tfloat roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-dViewDirW, bentNormal);\n}\n",reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {\n\tccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n#ifndef RIGHT_HANDED_CUBEMAP\n\tlookupVec.x *= -1.0;\n#endif\n\treturn $textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionDpAtlasPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n\tvec4 rect;\n\tfloat sx = saturate(mip - 2.0);\n\trect.x = sx * 0.5;\n\tfloat t = mip - rect.x * 6.0;\n\tfloat i = 1.0 - rect.x;\n\trect.y = min(t * 0.5, 0.75) * i + rect.x;\n\tfloat st = saturate(t);\n\trect.z = (1.0 - st * 0.5) * i;\n\trect.w = rect.z * 0.5;\n\tfloat rcRectZ = 1.0 / rect.z;\n\tfloat scaleFactor = 0.00390625 * rcRectZ;\n\tvec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n\tuv = uv * (vec2(1.0) - scale) + scale * 0.5;\n\tuv = uv * rect.zw + rect.xy;\n\treturn uv;\n}\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDir = normalize(cubeMapProject(tReflDirW));\n\tbool up = reflDir.y > 0.0;\n\tfloat scale = 0.90909090909090909090909090909091;\n\tvec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n\tfloat reflDirVer = abs(reflDir.y) + 1.0;\n\treflDirWarp /= reflDirVer;\n\treflDirWarp *= scale;\n\treflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n\tvec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tfloat mip = floor(bias);\n\tvec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\tmip = min(mip + 1.0, 5.0);\n\tvec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\ttex1 = mix(tex1, tex2, fract(bias));\n\ttex1 = processEnvironment(tex1);\n\treturn tex1;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubePS:"\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 refl = cubeMapProject(tReflDirW);\n#ifndef RIGHT_HANDED_CUBEMAP\n\trefl.x *= -1.0;\n#endif\n\tvec3 seam = calcSeam(refl);\n\tvec4 c0 = textureCube(texture_prefilteredCubeMap128, applySeam(refl, seam, 1.0 / 128.0));\n\tvec4 c1 = textureCube(texture_prefilteredCubeMap64, applySeam(refl, seam, 2.0 / 128.0));\n\tvec4 c2 = textureCube(texture_prefilteredCubeMap32, applySeam(refl, seam, 4.0 / 128.0));\n\tvec4 c3 = textureCube(texture_prefilteredCubeMap16, applySeam(refl, seam, 8.0 / 128.0));\n\tvec4 c4 = textureCube(texture_prefilteredCubeMap8, applySeam(refl, seam, 16.0 / 128.0));\n\tvec4 c5 = textureCube(texture_prefilteredCubeMap4, applySeam(refl, seam, 32.0 / 128.0));\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec4 cubes0;\n\tvec4 cubes1;\n\tif (bias < 1.0) {\n\t\tcubes0 = c0;\n\t\tcubes1 = c1;\n\t} else if (bias < 2.0) {\n\t\tcubes0 = c1;\n\t\tcubes1 = c2;\n\t} else if (bias < 3.0) {\n\t\tcubes0 = c2;\n\t\tcubes1 = c3;\n\t} else if (bias < 4.0) {\n\t\tcubes0 = c3;\n\t\tcubes1 = c4;\n\t} else {\n\t\tcubes0 = c4;\n\t\tcubes1 = c5;\n\t}\n\tvec4 cubeFinal = mix(cubes0, cubes1, fract(bias));\n\treturn processEnvironment($DECODE(cubeFinal).rgb);\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#ifndef GL2\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tvec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n\treturn refl;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = vNormalV;\n\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n\tfloat vn = dot(viewVec, Normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n\treturn refrVec;\n}\nvoid addRefraction() {\n\tvec3 tmp = dReflDirW;\n\tvec4 tmp2 = dReflection;\n\tdReflection = vec4(0.0);\n\tdReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\taddReflection();\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n\tdReflDirW = tmp;\n\tdReflection = tmp2;\n}\n",reprojectPS:"\nvarying vec2 vUv0;\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\n#ifdef REPROJECT_CUBEMAP_ROTATION\nuniform mat3 reprojectCubeMapRotationMatrix;\n#endif\nuniform vec4 params;\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 decodeLinear(vec4 source) {\n\treturn source.rgb;\n}\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec3 decodeGamma(vec4 source) {\n\treturn pow(source.xyz, vec3(2.2));\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec3 decodeRGBE(vec4 source) {\n\tif (source.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn source.xyz * pow(2.0, source.w * 255.0 - 128.0);\n\t}\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\nvec3 modifySeams(vec3 dir, float amount) {\n\tif (amount != 1.0) {\n\t\tvec3 adir = abs(dir);\n\t\tfloat M = max(max(adir.x, adir.y), adir.z);\n\t\tif (adir.x == M) {\n\t\t\tdir.y *= amount;\n\t\t\tdir.z *= amount;\n\t\t}\n\t\telse if (adir.y == M) {\n\t\t\tdir.x *= amount;\n\t\t\tdir.z *= amount;\n\t\t} else {\n\t\t\tdir.x *= amount;\n\t\t\tdir.y *= amount;\n\t\t}\n\t}\n\treturn dir;\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(atan(dir.z, dir.x), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * cos(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * sin(uv.x));\n}\nvec4 sampleEquirect(vec2 sph) {\n\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\nvec4 sampleEquirect(vec3 dir) {\n\treturn sampleEquirect(toSpherical(dir));\n}\nvec4 sampleCubemap(vec3 dir) {\n\treturn textureCube(sourceCube, modifySeams(dir, sourceCubeSeamScale()));\n}\nvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\nvec4 sampleOctahedral(vec3 dir) {\n\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\nvec4 sampleOctahedral(vec2 sph) {\n\treturn sampleOctahedral(fromSpherical(sph));\n}\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\t#ifdef REPROJECT_CUBEMAP_ROTATION\n\t\tvec = vec * reprojectCubeMapRotationMatrix;\n\t#endif\n\treturn normalize(modifySeams(vec, 1.0 / targetCubeSeamScale()));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 a = normalize(cross(n, vec3(0, 1, 0)));\n\tvec3 b = cross(n, a);\n\treturn mat3(a, b, n);\n}\nfloat rnd(int i) {\n\tfloat sini = sin(float(i));\n\tfloat cosi = cos(float(i));\n\treturn fract(sin(dot(vec2(sini, cosi), vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nvec3 hemisphereSamplePhong(vec2 uv, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\treturn vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec2 sph = toSpherical(TARGET_FUNC());\n\t\tvec2 sphu = dFdx(sph);\n\t\tvec2 sphv = dFdy(sph);\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n\t\t\tfor (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(sph +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphu * (u / NUM_SAMPLES_SQRT - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphv * (v / NUM_SAMPLES_SQRT - 0.5)));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n\t}\n}\nvec4 prefilter() {\n\tvec3 vec = TARGET_FUNC();\n\tmat3 vecSpace = matrixFromVectorSlow(vec);\n\tvec3 result = vec3(0.0);\n\tfor (int i=0; i<NUM_SAMPLES; ++i) {\n\t\tvec2 uv = vec2(float(i) / float(NUM_SAMPLES), rnd(i));\n\t\tvec3 dir = vecSpace * hemisphereSamplePhong(uv, specularPower());\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(dir));\n\t}\n\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\nvoid main(void) {\n\tgl_FragColor = PROCESS_FUNC();\n}\n",rgbmPS:"vec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n\treturn decodeRGBM(textureCube(tex, uvw));\n}\n",screenDepthPS:"uniform sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\tz = z * 2.0 - 1.0;\n\treturn 1.0 / (camera_params.z * z + camera_params.w);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef GL2\n\treturn linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n\t#else\n\treturn unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"const float maxCascades = 4.0;\nmat4 cascadeShadowMat;\nvoid getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tfloat cascadeIndex = 0.0;\n\tfor (float i = 0.0; i < maxCascades; i++) {\n\t\tif (depth < shadowCascadeDistances[int(i)]) {\n\t\t\tcascadeIndex = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tcascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);\n\t#ifdef GL2\n\t\tcascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];\n\t#else\n\t\tif (cascadeIndex == 0.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[0];\n\t\t}\n\t\telse if (cascadeIndex == 1.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[1];\n\t\t}\n\t\telse if (cascadeIndex == 2.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[2];\n\t\t}\n\t\telse {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[3];\n\t\t}\n\t#endif\n}\nvoid fadeShadow(float shadowCascadeDistances[4]) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {\n\t\tdShadowCoord.z = -9999999.0;\n\t}\n}\n",shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n\tfloat distScale = length(dLightDirW);\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - dLightPosW;\n\tdLightDirW = dir;\n}\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tdShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xy /= projPos.w;\n\tdShadowCoord.xy = projPos.xy;\n\tdShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n\treturn clamp((b - a)*1000.0, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n\tmat3 shadowKernel;\n\tvec3 shadowCoord = dShadowCoord;\n\tvec3 shadowZ = vec3(shadowCoord.z);\n\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\tvec3 shadowCoord = dShadowCoord;\n\tfloat xoffset = 1.0 / shadowParams.x;\n\tfloat dx0 = -xoffset;\n\tfloat dx1 = xoffset;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\tdepthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\tdepthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\tdepthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\tdepthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n\tdepthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\tdepthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\tdepthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\tdepthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\treturn _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\tvec3 tc = normalize(dir);\n\tvec3 tcAbs = abs(tc);\n\tvec4 dirX = vec4(1,0,0, tc.x);\n\tvec4 dirY = vec4(0,1,0, tc.y);\n\tfloat majorAxisLength = tc.z;\n\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\tdirX = vec4(0,0,1, tc.z);\n\t\tdirY = vec4(0,1,0, tc.y);\n\t\tmajorAxisLength = tc.x;\n\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\tdirX = vec4(1,0,0, tc.x);\n\t\tdirY = vec4(0,0,1, tc.z);\n\t\tmajorAxisLength = tc.y;\n\t}\n\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\tvec3 dx0 = -xoffset;\n\tvec3 dy0 = -yoffset;\n\tvec3 dx1 = xoffset;\n\tvec3 dy1 = yoffset;\n\tmat3 shadowKernel;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n\treturn _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = gammaCorrectInput(sum);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * Z;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec4 c = texture2D(tex, texCoords);\n\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\treturn calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nmat4 getBoneMatrix(const in float i) {\n\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tv1 = matrix_pose[int(3.0 * i)];\n\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tgl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n",skyboxVS:"attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nvarying vec3 vViewDir;\nvoid main(void) {\n\tmat4 view = matrix_view;\n\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\tgl_Position.z = gl_Position.w - 0.00001;\n\tvViewDir = aPosition;\n}\n",skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvoid main(void) {\n#ifdef CUBEMAP_ROTATION\n\tvec3 dir=vViewDir * cubeMapRotationMatrix;\n#else\n\tvec3 dir=vViewDir;\n#endif\n#ifndef RIGHT_HANDED_CUBEMAP\n\tdir.x *= -1.0;\n#endif\n\tvec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)).rgb);\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",skyboxPrefilteredCubePS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvoid main(void) {\n\tvec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdSpecularity *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",specularAaNonePS:"float antiAliasGlossiness(float power) {\n\treturn power;\n}\n",specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * mix(1.0, toksvig, material_bumpiness);\n}\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * toksvig;\n}\n",spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n\tfloat cosAngle = dot(dLightDirNormW, lightSpotDirW);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"void main(void) {\n\tdDiffuseLight = vec3(0);\n\tdSpecularLight = vec3(0);\n\tdReflection = vec4(0);\n\tdSpecularity = vec3(0);\n\tmetallic = 1.0;\n\t#ifdef CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec4(0);\n\t#endif\n",startVS:"void main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\tnineSlicedUv = vUv0;\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",startNineSlicedTiledPS:"\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",storeEVSMPS:"float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"vec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\nvec3 getObjectSpaceUp() {\n\treturn normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",TBNPS:"void getTBN() {\n\tdTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",TBNderivativePS:"\nvoid getTBN() {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, dVertexNormalW );\n\tvec3 dp1perp = cross( dVertexNormalW, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat denom = max( dot(T,T), dot(B,B) );\n\tfloat invmax = (denom == 0.0) ? 0.0 : 1.0 / sqrt( denom );\n\tdTBN = mat3( T * invmax, -B * invmax, dVertexNormalW );\n}\n",TBNfastPS:"void getTBN() {\n\tdTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",TBNObjectSpacePS:"void getTBN() {\n\tvec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n\tvec3 T = cross(dVertexNormalW, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\t\tif (dVertexNormalW.x==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,1,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.y==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,0,1));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.z==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(1,0,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",tonemappingAcesPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNonePS:"vec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\nvec2 getTextureMorphCoords() {\n\tfloat vertexId = morph_vertex_id;\n\tvec2 textureSize = morph_tex_params.xy;\n\tvec2 invTextureSize = morph_tex_params.zw;\n\tfloat morphGridV = floor(vertexId * invTextureSize.x);\n\tfloat morphGridU = vertexId - (morphGridV * textureSize.x);\n\treturn (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",uv0VS:"#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"vec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"void getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n"};function It(e,t){return t||(t=Dt),1===e||2===e?t.gamma2_2PS?t.gamma2_2PS:Dt.gamma2_2PS:3===e?"#define HDR\n"+(t.gamma2_2PS?t.gamma2_2PS:Dt.gamma2_2PS):t.gamma1_0PS?t.gamma1_0PS:Dt.gamma1_0PS}function kt(e,t){return t||(t=Dt),1===e?t.tonemappingFilmicPS?t.tonemappingFilmicPS:Dt.tonemappingFilmicPS:0===e?t.tonemappingLinearPS?t.tonemappingLinearPS:Dt.tonemappingLinearPS:2===e?t.tonemappingHejlPS?t.tonemappingHejlPS:Dt.tonemappingHejlPS:3===e?t.tonemappingAcesPS?t.tonemappingAcesPS:Dt.tonemappingAcesPS:4===e?t.tonemappingAces2PS?t.tonemappingAces2PS:Dt.tonemappingAces2PS:5===e?t.tonemappingPBRPS?t.tonemappingPBRPS:Dt.tonemappingPBRPS:t.tonemapingNonePS?t.tonemapingNonePS:Dt.tonemappingNonePS}function Lt(e,t){return t||(t=Dt),"linear"===e?t.fogLinearPS?t.fogLinearPS:Dt.fogLinearPS:"exp"===e?t.fogExpPS?t.fogExpPS:Dt.fogExpPS:"exp2"===e?t.fogExp2PS?t.fogExp2PS:Dt.fogExp2PS:t.fogNonePS?t.fogNonePS:Dt.fogNonePS}function Ot(e,t){return t||(t=Dt),e.supportsBoneTextures?t.skinTexVS:"#define BONE_LIMIT "+e.getBoneLimit()+"\n"+t.skinConstVS}function Ft(e){var t="precision "+e.precision+" float;\n";return t+="precision "+e.precision+" int;\n",e.webgl2&&(t+="#ifdef GL2\nprecision "+e.precision+" sampler2DShadow;\n#endif\n"),t}function zt(e){return e.webgl2?"#version 300 es\n":""}var Bt={UV0:0,UV1:1,Box:2,Sphere:3,Cylinder:4,Planar:5,Camera:6},Vt=/^[ \t]*#include +<([\w\d./]+)>/gm;function Ut(e){return e.replace(Vt,Nt)}function Nt(e,t){var i=Rt[t];if(void 0===i)throw new Error("Can not resolve #include <"+t+">");return Ut(i)}var Gt={vertex_position:Te,vertex_normal:Ae,vertex_tangent:Ee,vertex_texCoord0:Le,vertex_texCoord1:Oe,vertex_texCoord2:Fe,vertex_texCoord3:ze,vertex_texCoord4:Be,vertex_texCoord5:Ve,vertex_texCoord6:Ue,vertex_texCoord7:Ne,vertex_color:Ie,vertex_boneIndices:De,vertex_boneWeights:Re};function Wt(e){for(var t={},i=0,n=e.indexOf("attribute");0<=n&&!(0<n&&"/"===e[n-1]);){var a=e.indexOf(";",n),s=e.lastIndexOf(" ",a),r=e.substr(s+1,a-(s+1)),o=Gt[r];void 0!==o?t[r]=o:(t[r]="ATTR"+i,i++),n=e.indexOf("attribute",n+1)}return t}function Ht(e,t,i,n,a,s){var r=e.programLib._cache,o=r[n];if(void 0!==o)return o;i=Ut(i=Ft(e)+"\n"+(i||"void main(void) {gl_FragColor = vec4(0.0);}"));var l=Wt(t);return e.webgl2&&(t=zt(e)+Rt.gles3VS+t,i=zt(e)+Rt.gles3PS+i),r[n]=new Et(e,{attributes:l,vshader:t,fshader:(s||"")+i,useTransformFeedback:a}),r[n]}Rt.collectAttribs=Wt,Rt.createShader=function(e,t,i,n){var a=Rt[t],s=Ft(e)+"\n"+Rt[i],r=Wt(a);return e.webgl2&&(a=zt(e)+Rt.gles3VS+a,s=zt(e)+Rt.gles3PS+s),new Et(e,{attributes:r,vshader:a,fshader:s,useTransformFeedback:n})},Rt.createShaderFromCode=Ht;var jt={generateKey:function(e){var t="basic";return e.fog&&(t+="_fog"),e.alphaTest&&(t+="_atst"),e.vertexColors&&(t+="_vcol"),e.diffuseMap&&(t+="_diff"),e.skin&&(t+="_skin"),e.screenSpace&&(t+="_ss"),e.useInstancing&&(t+="_inst"),e.useMorphPosition&&(t+="_morphp"),e.useMorphNormal&&(t+="_morphn"),e.useMorphTextureBased&&(t+="_morpht"),t+"_"+e.pass},createShaderDefinition:function(e,t){var i={vertex_position:Te};t.skin&&(i.vertex_boneWeights=Re,i.vertex_boneIndices=De),t.vertexColors&&(i.vertex_color=Ie),t.diffuseMap&&(i.vertex_texCoord0=Le);var n="";n+=Dt.transformDeclVS,t.skin?(n+=Ot(e),n+=Dt.transformSkinnedVS):n+=Dt.transformVS,t.vertexColors&&(n+="attribute vec4 vertex_color;\n",n+="varying vec4 vColor;\n"),t.diffuseMap&&(n+="attribute vec2 vertex_texCoord0;\n",n+="varying vec2 vUv0;\n"),2===t.pass&&(n+="varying float vDepth;\n",n+="#ifndef VIEWMATRIX\n",n+="#define VIEWMATRIX\n",n+="uniform mat4 matrix_view;\n",n+="#endif\n",n+="#ifndef CAMERAPLANES\n",n+="#define CAMERAPLANES\n",n+="uniform vec4 camera_params;\n\n",n+="#endif\n"),n+="void main(void)\n{\n",n+="   gl_Position = getPosition();\n",2===t.pass&&(n+="    vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),t.vertexColors&&(n+="    vColor = vertex_color;\n"),t.diffuseMap&&(n+="    vUv0 = vertex_texCoord0;\n");var a=n+="}\n";return n=Ft(e),t.vertexColors?n+="varying vec4 vColor;\n":n+="uniform vec4 uColor;\n",t.diffuseMap&&(n+="varying vec2 vUv0;\n",n+="uniform sampler2D texture_diffuseMap;\n"),t.fog&&(n+=Lt(t.fog)),t.alphatest&&(n+=Dt.alphaTestPS),2===t.pass&&(n+="varying float vDepth;\n",n+=Dt.packDepthPS),n+="void main(void)\n{\n",t.vertexColors?n+="    gl_FragColor = vColor;\n":n+="    gl_FragColor = uColor;\n",t.diffuseMap&&(n+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),t.alphatest&&(n+="   alphaTest(gl_FragColor.a);\n"),18!==t.pass&&(2===t.pass?n+="    gl_FragColor = packFloat(vDepth);\n":t.fog&&(n+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),{attributes:i,vshader:a,fshader:n+="}\n"}}},Xt={generateKey:function(e){var t="particle";for(var i in e)e.hasOwnProperty(i)&&(t+=e[i]);return t},_animTex:function(e){var t="";return(t+=e.animTexLoop?Dt.particleAnimFrameLoopVS:Dt.particleAnimFrameClampVS)+Dt.particleAnimTexVS},createShaderDefinition:function(e,t){var i="",n=Ft(e)+"\n";n+="#define PARTICLE\n",e.webgl2&&(i+="#define GL2\n",n+="#define GL2\n"),i+="#define VERTEXSHADER\n",t.mesh&&(i+="#define USE_MESH\n"),t.localSpace&&(i+="#define LOCAL_SPACE\n"),t.screenSpace&&(i+="#define SCREEN_SPACE\n"),t.animTex&&(i+="\nuniform vec2 animTexTilesParams;\n"),t.animTex&&(i+="\nuniform vec4 animTexParams;\n"),t.animTex&&(i+="\nuniform vec2 animTexIndexParams;\n"),2===t.normal&&(i+="\nvarying mat3 ParticleMat;\n"),1===t.normal&&(i+="\nvarying vec3 Normal;\n"),t.soft&&(i+="\nvarying float vDepth;\n");var a=t.customFace?Dt.particle_customFaceVS:Dt.particle_billboardVS;return t.useCpu?(0<t.soft&&(i+=Dt.screenDepthPS),i+=Dt.particle_cpuVS,t.localSpace&&(i+=Dt.particle_localShiftVS),t.animTex&&(i+=this._animTex(t)),t.alignToMotion&&(i+=Dt.particle_pointAlongVS),i+=t.mesh?Dt.particle_meshVS:a,1===t.normal&&(i+=Dt.particle_normalVS),2===t.normal&&(i+=Dt.particle_TBNVS),0<t.stretch&&(i+=Dt.particle_stretchVS),i+=Dt.particle_cpu_endVS):(i+=Dt.particle_initVS,i+=t.pack8?Dt.particleInputRgba8PS:Dt.particleInputFloatPS,0<t.soft&&(i+=Dt.screenDepthPS),i+=Dt.particleVS,t.localSpace&&(i+=Dt.particle_localShiftVS),t.animTex&&(i+=this._animTex(t)),t.wrap&&(i+=Dt.particle_wrapVS),t.alignToMotion&&(i+=Dt.particle_pointAlongVS),i+=t.mesh?Dt.particle_meshVS:a,1===t.normal&&(i+=Dt.particle_normalVS),2===t.normal&&(i+=Dt.particle_TBNVS),0<t.stretch&&(i+=Dt.particle_stretchVS),i+=Dt.particle_endVS),0<t.soft&&(i+=Dt.particle_softVS),i+="}\n",0<t.normal&&(1===t.normal?n+="\nvarying vec3 Normal;\n":2===t.normal&&(n+="\nvarying mat3 ParticleMat;\n"),n+="\nuniform vec3 lightCube[6];\n"),t.soft&&(n+="\nvarying float vDepth;\n"),0===t.normal&&"none"===t.fog&&(t.srgb=!1),n+=It(t.gamma),n+=kt(t.toneMap),"linear"===t.fog?n+=Dt.fogLinearPS:"exp"===t.fog?n+=Dt.fogExpPS:"exp2"===t.fog?n+=Dt.fogExp2PS:n+=Dt.fogNonePS,2===t.normal&&(n+="\nuniform sampler2D normalMap;\n"),0<t.soft&&(n+=Dt.screenDepthPS),n+=Dt.particlePS,0<t.soft&&(n+=Dt.particle_softPS),1===t.normal&&(n+="\nvec3 normal = Normal;\n"),2===t.normal&&(n+=Dt.particle_normalMapPS),0<t.normal&&(n+=t.halflambert?Dt.particle_halflambertPS:Dt.particle_lambertPS),0<t.normal&&(n+=Dt.particle_lightingPS),2===t.blend?n+=Dt.particle_blendNormalPS:1===t.blend?n+=Dt.particle_blendAddPS:5===t.blend&&(n+=Dt.particle_blendMultiplyPS),n+=Dt.particle_endPS,{attributes:Wt(i),vshader:i,fshader:n}}},qt={generateKey:function(e){return"skybox"+e.rgbm+" "+e.hdr+" "+e.fixSeams+e.toneMapping+e.gamma+e.useIntensity+e.useCubeMapRotation+e.useRightHandedCubeMap+e.mip},createShaderDefinition:function(e,t){var i=Ft(e);return i+=t.useCubeMapRotation?"#define CUBEMAP_ROTATION\n":"",i+=t.useRightHandedCubeMap?"#define RIGHT_HANDED_CUBEMAP\n":"",i+=t.mip?Dt.fixCubemapSeamsStretchPS:Dt.fixCubemapSeamsNonePS,i+=t.useIntensity?Dt.envMultiplyPS:Dt.envConstPS,i+=It(t.gamma),i+=kt(t.toneMapping),i+=Dt.rgbmPS,i+=Dt.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,t.rgbm?"textureCubeRGBM":t.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,32,16,8,4,2][t.mip]+""),{attributes:{aPosition:Te},vshader:Dt.skyboxVS,fshader:i}}},$t=null,Yt=null,Kt=function(){function t(e,t){this.device=e,this.name=null,this._width=4,this._height=4,this._depth=1,this._format=7,this.type=Ze,this.projection=tt,this._cubemap=!1,this._volume=!1,this.fixCubemapSeams=!1,this._flipY=!0,this._premultiplyAlpha=!1,this._isRenderTarget=!1,this._mipmaps=!0,this._minFilter=5,this._magFilter=1,this._anisotropy=1,this._addressU=0,this._addressV=0,this._addressW=0,this._compareOnRead=!1,this._compareFunc=1,void 0!==t&&(void 0!==t.name&&(this.name=t.name),this._width=void 0!==t.width?t.width:this._width,this._height=void 0!==t.height?t.height:this._height,this._format=void 0!==t.format?t.format:this._format,t.hasOwnProperty("type")?this.type=t.type:t.hasOwnProperty("rgbm")?this.type=t.rgbm?Qe:Ze:t.hasOwnProperty("swizzleGGGR")&&(this.type=t.swizzleGGGR?et:Ze),void 0!==t.mipmaps?this._mipmaps=t.mipmaps:this._mipmaps=void 0!==t.autoMipmap?t.autoMipmap:this._mipmaps,this._levels=t.levels,this._cubemap=void 0!==t.cubemap?t.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==t.fixCubemapSeams?t.fixCubemapSeams:this.fixCubemapSeams,this._cubemap?this.projection=it:t.projection&&t.projection!==it&&(this.projection=t.projection),this._minFilter=void 0!==t.minFilter?t.minFilter:this._minFilter,this._magFilter=void 0!==t.magFilter?t.magFilter:this._magFilter,this._anisotropy=void 0!==t.anisotropy?t.anisotropy:this._anisotropy,this._addressU=void 0!==t.addressU?t.addressU:this._addressU,this._addressV=void 0!==t.addressV?t.addressV:this._addressV,this._compareOnRead=void 0!==t.compareOnRead?t.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==t._compareFunc?t._compareFunc:this._compareFunc,this._flipY=void 0!==t.flipY?t.flipY:this._flipY,this._premultiplyAlpha=void 0!==t.premultiplyAlpha?t.premultiplyAlpha:this._premultiplyAlpha,e.webgl2&&(this._depth=void 0!==t.depth?t.depth:this._depth,this._volume=void 0!==t.volume?t.volume:this._volume,this._addressW=void 0!==t.addressW?t.addressW:this._addressW)),this._compressed=8===this._format||9===this._format||10===this._format||21<=this._format,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0}t.calcGpuSize=function(e,t,i,n,a,s){$t||(($t=[])[0]=1,$t[1]=1,$t[2]=2,$t[3]=2,$t[4]=2,$t[5]=2,$t[6]=4,$t[7]=4,$t[11]=8,$t[12]=8,$t[13]=16,$t[14]=16,$t[15]=4,$t[16]=4,$t[17]=4,$t[18]=4,$t[19]=4,$t[20]=4),Yt||((Yt=[])[21]=8,Yt[22]=8,Yt[24]=8,Yt[25]=8,Yt[26]=8,Yt[27]=8,Yt[8]=8,Yt[29]=8,Yt[23]=16,Yt[9]=16,Yt[10]=16,Yt[28]=16,Yt[30]=16);for(var r=$t.hasOwnProperty(n)?$t[n]:0,o=Yt.hasOwnProperty(n)?Yt[n]:0,l=0;;){if(0<r)l+=e*t*i*r;else{var h=Math.floor((e+3)/4),c=Math.floor((t+3)/4),u=Math.floor((i+3)/4);24!==n&&25!==n||(h=Math.max(Math.floor(h/2),1)),l+=h*c*u*o}if(!a||1===e&&1===t&&1===i)break;e=Math.max(Math.floor(e/2),1),t=Math.max(Math.floor(t/2),1),i=Math.max(Math.floor(i/2),1)}return l*(s?6:1)};var e=t.prototype;return e.destroy=function(){this.device&&this.device.destroyTexture(this),this.device=null,this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]},e.dirtyAll=function(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255},e.lock=function(e){if(void 0===e&&(e={}),void 0===e.level&&(e.level=0),void 0===e.face&&(e.face=0),void 0===e.mode&&(e.mode=2),this._lockedLevel=e.level,null===this._levels[e.level])switch(this._format){case 0:case 1:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth);break;case 2:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case 3:case 4:case 5:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth);break;case 6:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case 7:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case 8:this._levels[e.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case 9:case 10:this._levels[e.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case 11:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case 13:this._levels[e.level]=new Float32Array(this._width*this._height*this._depth*3);break;case we:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case Ce:this._levels[e.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[e.level]},e.setSource=function(e,t){var i;void 0===t&&(t=0);var n,a,s=!1;if(this._cubemap){if(e[0])for(n=e[0].width||0,a=e[0].height||0,i=0;i<6;i++){var r=e[i];if(!r||r.width!==n||r.height!==a||!this.device._isBrowserInterface(r)){s=!0;break}}else s=!0;if(!s)for(i=0;i<6;i++)this._levels[t][i]!==e[i]&&(this._levelsUpdated[t][i]=!0)}else this.device._isBrowserInterface(e)||(s=!0),s||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),n=e.width,a=e.height);if(s)if(this._width=4,this._height=4,this._cubemap)for(i=0;i<6;i++)this._levels[t][i]=null,this._levelsUpdated[t][i]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else 0===t&&(this._width=n,this._height=a),this._levels[t]=e;this._invalid===s&&s||(this._invalid=s,this.upload())},e.getSource=function(e){return void 0===e&&(e=0),this._levels[e]},e.unlock=function(){this.upload(),this._lockedLevel=-1},e.upload=function(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps},e.getDds=function(){for(var e,t,i=128,n=0;this._levels[n];){var a;if(this.cubemap)for(t=0;t<6;t++){if(!this._levels[n][t])return;if(!(a=this._levels[n][t].length))return;i+=a}else{if(!(a=this._levels[n].length))return;i+=a}i+=this._levels[n].length,n++}var s=new ArrayBuffer(i),r=new Uint32Array(s,0,32),o=528391;1<this._levels.length&&(o|=131072);var l=4096;1<this._levels.length&&(l|=4194304),(1<this._levels.length||this.cubemap)&&(l|=8);var h=this.cubemap?65024:0;for(r[0]=542327876,r[1]=124,r[2]=o,r[3]=this.height,r[4]=this.width,r[5]=this.width*this.height*4,r[6]=0,r[7]=this._levels.length,n=0;n<11;n++)r[8+n]=0;r[19]=32,r[20]=65,r[21]=0,r[22]=32,r[23]=16711680,r[24]=65280,r[25]=255,r[26]=4278190080,r[27]=l,r[28]=h,r[29]=0,r[30]=0,r[31]=0;var c,u,d=128;if(this.cubemap)for(t=0;t<6;t++)for(n=0;n<this._levels.length;n++){for(c=this._levels[n][t],u=new Uint8Array(s,d,c.length),e=0;e<c.length;e++)u[e]=c[e];d+=c.length}else for(n=0;n<this._levels.length;n++){for(c=this._levels[n],u=new Uint8Array(s,d,c.length),e=0;e<c.length;e++)u[e]=c[e];d+=c.length}return s},c(t,[{key:"minFilter",get:function(){return this._minFilter},set:function(e){this._minFilter!==e&&(this._minFilter=e,this._parameterFlags|=1)}},{key:"magFilter",get:function(){return this._magFilter},set:function(e){this._magFilter!==e&&(this._magFilter=e,this._parameterFlags|=2)}},{key:"addressU",get:function(){return this._addressU},set:function(e){this._addressU!==e&&(this._addressU=e,this._parameterFlags|=4)}},{key:"addressV",get:function(){return this._addressV},set:function(e){this._addressV!==e&&(this._addressV=e,this._parameterFlags|=8)}},{key:"addressW",get:function(){return this._addressW},set:function(e){this.device.webgl2&&this._volume&&e!==this._addressW&&(this._addressW=e,this._parameterFlags|=16)}},{key:"compareOnRead",get:function(){return this._compareOnRead},set:function(e){this._compareOnRead!==e&&(this._compareOnRead=e,this._parameterFlags|=32)}},{key:"compareFunc",get:function(){return this._compareFunc},set:function(e){this._compareFunc!==e&&(this._compareFunc=e,this._parameterFlags|=64)}},{key:"anisotropy",get:function(){return this._anisotropy},set:function(e){this._anisotropy!==e&&(this._anisotropy=e,this._parameterFlags|=128)}},{key:"autoMipmap",get:function(){return this._mipmaps},set:function(e){this._mipmaps=e}},{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){this._mipmaps!==e&&(this._mipmaps=e,this._minFilterDirty=!0,e&&(this._needsMipmapsUpload=!0))}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"format",get:function(){return this._format}},{key:"cubemap",get:function(){return this._cubemap}},{key:"gpuSize",get:function(){var e=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return t.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}},{key:"volume",get:function(){return this._volume}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}},{key:"premultiplyAlpha",get:function(){return this._premultiplyAlpha},set:function(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}},{key:"pot",get:function(){return Se.powerOfTwo(this._width)&&Se.powerOfTwo(this._height)}}]),t}(),Zt=new de,Qt=new de,Jt=new de,ei=new ue,ti=1/255;function ii(e,t,i,n){var a=255*e%1;if(t[i+0]=Math.round(255*(e%1-ti*a)),1<n){var s=65025*e%1;if(t[i+1]=Math.round(255*(a-ti*s)),2<n){var r=16581375*e%1;t[i+2]=Math.round(255*(s-ti*r)),3<n&&(t[i+3]=Math.round(255*r))}}}var ni=function(){this.light=null,this.min=new de,this.max=new de},ai=function(){function d(e,t,i){this.device=e,this.name="Untitled",this.reportCount=0,this._bounds=new ue,this.boundsMin=new de,this.boundsMax=new de,this.boundsDelta=new de,this._cells=new de,this._cellsLimit=new de,this.cells=t,this._maxCellLightCount=0,this._pixelsPerCellCount=0,this.maxCellLightCount=i,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new ni),this.registerUniforms(e),this.initLightsTexture()}d.init=function(e){d.lightTextureFormat=e.extTextureFloat?d.FORMAT_FLOAT:d.FORMAT_8BIT};var e=d.prototype;return e.destroy=function(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null),this.releaseClusterTexture()},e.releaseClusterTexture=function(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)},e.registerUniforms=function(e){this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterPixelsPerCellId=e.scope.resolve("clusterPixelsPerCell"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=e.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)},e.createTexture=function(e,t,i){return new Kt(this.device,{width:e,height:t,mipmaps:!1,format:i,addressU:1,addressV:1,type:Ze,magFilter:0,minFilter:0,anisotropy:1})},e.initLightsTexture=function(){this.maxLights=255;var e=4,t=0;d.lightTextureFormat===d.FORMAT_FLOAT?t=2:e=11,this.lights8=new Uint8ClampedArray(4*e*this.maxLights),this.lightsTexture8=this.createTexture(e,this.maxLights,7),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),t?(this.lightsFloat=new Float32Array(4*t*this.maxLights),this.lightsTextureFloat=this.createTexture(t,this.maxLights,Ce),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=t?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=t?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height},e.getSpotDirection=function(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize()},e.addLightData=function(e,t,i){var n=2===e._type,a=e._node.getPosition(),s=this.lights8,r=t*this.lightsTexture8.width*4;s[r+0]=n?255:0,s[r+1]=255*e._shape,s[r+2]=255*e._falloffMode,r+=4;var o=1/this._maxColorValue,l=i?e._linearFinalColor:e._finalColor;if(ii(l[0]*o,s,r+0,2),ii(l[1]*o,s,r+2,2),ii(l[2]*o,s,r+4,2),r+=8,n&&(ii(.499999*e._innerConeAngleCos+.5,s,r+0,2),ii(.499999*e._outerConeAngleCos+.5,s,r+2,2)),r+=4,d.lightTextureFormat===d.FORMAT_FLOAT){var h=this.lightsFloat,c=t*this.lightsTextureFloat.width*4;h[c+0]=a.x,h[c+1]=a.y,h[c+2]=a.z,h[c+3]=e.attenuationEnd,n&&(this.getSpotDirection(Zt,e),h[c+4]=Zt.x,h[c+5]=Zt.y,h[c+6]=Zt.z)}else{var u=Zt.sub2(a,this.boundsMin).div(this.boundsDelta);ii(u.x,s,r+0,4),ii(u.y,s,r+4,4),ii(u.z,s,r+8,4),ii(e.attenuationEnd/this._maxAttenuation,s,r+12,4),r+=16,n&&(this.getSpotDirection(Zt,e),ii(.499999*Zt.x+.5,s,r+0,4),ii(.499999*Zt.y+.5,s,r+4,4),ii(.499999*Zt.z+.5,s,r+8,4))}},e.updateCells=function(){if(this._cellsDirty){this._cellsDirty=!1;var e=this._cells.x,t=this._cells.y,i=this._cells.z,n=e*t*i,a=this._pixelsPerCellCount*n,s=Math.ceil(Math.sqrt(a));s=Se.roundUp(s,this._pixelsPerCellCount);var r=Math.ceil(a/s);this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=i,this._clusterCellsDotData[0]=this._pixelsPerCellCount,this._clusterCellsDotData[1]=e*i*this._pixelsPerCellCount,this._clusterCellsDotData[2]=e*this._pixelsPerCellCount,this.clusters=new Uint8ClampedArray(4*a),this.counts=new Int32Array(n),this._clusterTextureSizeData[0]=s,this._clusterTextureSizeData[1]=1/s,this._clusterTextureSizeData[2]=1/r,this.releaseClusterTexture(),this.clusterTexture=this.createTexture(s,r,7)}},e.uploadTextures=function(){var e=this.clusterTexture.lock();e.set(this.clusters),this.clusterTexture.unlock(),this.lightsTextureFloat&&((e=this.lightsTextureFloat.lock()).set(this.lightsFloat),this.lightsTextureFloat.unlock()),(e=this.lightsTexture8.lock()).set(this.lights8),this.lightsTexture8.unlock()},e.updateUniforms=function(){this._clusterWorldTextureId.setValue(this.clusterTexture),this._lightsTexture8Id.setValue(this.lightsTexture8),d.lightTextureFormat===d.FORMAT_FLOAT&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat);var e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterPixelsPerCellId.setValue(this._pixelsPerCellCount),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData),this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)},e.evalLightCellMinMax=function(e,t,i){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),i.copy(e.max),i.sub(this.boundsMin),i.div(this.boundsDelta),i.mul2(i,this.cells),i.ceil(),t.max(de.ZERO),i.min(this._cellsLimit)},e.collectLights=function(e){for(var t=this._usedLights,i=1,n=0;n<e.length;n++){var a=e[n];if(a.enabled&&0!==a.type&&a.visibleThisFrame&&0<a.intensity){if(!(i<this.maxLights))break;var s=void 0;i<t.length?s=t[i]:(s=new ni,t.push(s)),(s.light=a).getBoundingBox(ei),s.min.copy(ei.getMin()),s.max.copy(ei.getMax()),i++}}t.length=i},e.evaluateBounds=function(){var e=this._usedLights,t=this.boundsMin,i=this.boundsMax;if(1<e.length){t.copy(e[1].min),i.copy(e[1].max);for(var n=2;n<e.length;n++)t.min(e[n].min),i.max(e[n].max)}else t.set(0,0,0),i.set(1,1,1);this.boundsDelta.sub2(i,t)},e.evaluateCompressionLimits=function(e){for(var t=0,i=0,n=this._usedLights,a=1;a<n.length;a++){var s=n[a].light;t=Math.max(s.attenuationEnd,t);var r=e?s._linearFinalColor:s._finalColor;i=Math.max(r[0],i),i=Math.max(r[1],i),i=Math.max(r[2],i)}this._maxAttenuation=t+1e-6,this._maxColorValue=i+1e-6},e.updateClusters=function(e){this.counts.fill(0),this.clusters.fill(0);for(var t=this._cells.x,i=this._cells.z,n=this.counts,a=this._maxCellLightCount,s=this.clusters,r=this._pixelsPerCellCount,o=this._usedLights,l=1;l<o.length;l++){var h=o[l],c=h.light;this.addLightData(c,l,e),this.evalLightCellMinMax(h,Qt,Jt);for(var u=Qt.x,d=Jt.x,p=Qt.y,f=Jt.y,m=Qt.z,v=Jt.z,g=u;g<=d;g++)for(var _=m;_<=v;_++)for(var y=p;y<=f;y++){var b=g+t*(_+y*i),x=n[b];x<a&&(s[r*b*4+x]=l,n[b]=x+1)}}},e.update=function(e,t){this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.evaluateCompressionLimits(t),this.updateClusters(t),this.uploadTextures()},e.activate=function(){this.updateUniforms()},c(d,[{key:"maxCellLightCount",get:function(){return this._maxCellLightCount},set:function(e){var t=Se.roundUp(e,4);t!==this._maxCellLightCount&&(this._maxCellLightCount=t,this._pixelsPerCellCount=this._maxCellLightCount/4,this._cellsDirty=!0)}},{key:"cells",get:function(){return this._cells},set:function(e){Zt.copy(e).floor(),this._cells.equals(Zt)||(this._cells.copy(Zt),this._cellsLimit.copy(Zt).sub(de.ONE),this._cellsDirty=!0)}}]),d}();ai.FORMAT_FLOAT=0,ai.FORMAT_8BIT=1,ai.lightTextureFormat=ai.FORMAT_8BIT;var si,ri=function(e,t){if(e.size!==t.size)return!1;for(var i,n=_(e);!(i=n()).done;){var a=i.value;if(!t.has(a))return!1}return!0},oi=function(){function e(){this.layerIndex=0,this.cameraIndex=0,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.directionalLightsSet=new Set,this.directionalLights=[],this.directionalLightsIndices=[]}var t=e.prototype;return t.reset=function(){this.lightClusters=null,this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0},t.collectDirectionalLights=function(e,t,i){this.directionalLightsSet.clear(),this.directionalLights.length=0;for(var n=this.directionalLightsIndices.length=0;n<t.length;n++){var a=t[n];if(a.castShadows)for(var s=0;s<e.length;s++)if(0<=e[s]._splitLights[0].indexOf(a)&&!this.directionalLightsSet.has(a)){this.directionalLightsSet.add(a),this.directionalLights.push(a);var r=i.indexOf(a);this.directionalLightsIndices.push(r)}}},e}(),li=function(){function e(){this.shadowCastersSet=new Set,this.shadowCastersList=[]}var t=e.prototype;return t.clearShadowCasters=function(){this.shadowCastersSet.clear(),this.shadowCastersList.length=0},t.addShadowCasters=function(e){for(var t=0;t<e.length;t++){var i=e[t];this.shadowCastersSet.has(i)||(this.shadowCastersSet.add(i),this.shadowCastersList.push(i))}},e}();function hi(){return si}function ci(e){si=e}var ui=new Set,di=[],pi=function(a){function m(e,t){var i,n;return void 0===t&&(t="Untitled"),"string"==typeof e&&(t=e=null),(n=a.call(this)||this).device=e||(null==(i=hi())?void 0:i.graphicsDevice),n.name=t,n.logRenderActions=!1,n.layerList=[],n.subLayerList=[],n.subLayerEnabled=[],n._opaqueOrder={},n._transparentOrder={},n._dirty=!1,n._dirtyBlend=!1,n._dirtyLights=!1,n._dirtyCameras=!1,n._meshInstances=[],n._meshInstancesSet=new Set,n._lights=[],n._lightsMap=new Map,n._lightCompositionData=[],n._splitLights=[[],[],[]],n.cameras=[],n._renderActions=[],n._worldClusters=[],n._emptyWorldClusters=null,n._clusteredLightingCells=new de(10,3,10),n._clusteredLightingMaxLights=64,n}u(m,a);var e=m.prototype;return e.destroy=function(){this._emptyWorldClusters&&(this._emptyWorldClusters.destroy(),this._emptyWorldClusters=null),this._worldClusters.forEach(function(e){return e.destroy()}),this._worldClusters=null},e.updateWorldClusters=function(){var t=this;this._worldClusters.forEach(function(e){e.cells=t._clusteredLightingCells,e.maxCellLightCount=t._clusteredLightingMaxLights})},e._splitLightsArray=function(e){var t,i=e._lights;e._splitLights[0].length=0,e._splitLights[1].length=0;for(var n=e._splitLights[2].length=0;n<i.length;n++)(t=i[n]).enabled&&e._splitLights[t._type].push(t)},e._update=function(){var e,t,i,n,a,s=this.layerList.length,r=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(e=0;e<s;e++)(i=this.layerList[e])._dirty&&(this._dirty=!0),i._dirtyLights&&(this._dirtyLights=!0),i._dirtyCameras&&(this._dirtyCameras=!0);function o(e,t,i){for(var n,a,s=!1,r=i.length,o=0;o<r;o++)n=i[o],t.has(n)||(t.add(n),e.push(n),(a=n.material)&&a._dirtyBlend&&(s=!0,a._dirtyBlend=!1));return s}if(this._dirty){for(r|=1,this._meshInstances.length=0,this._meshInstancesSet.clear(),e=0;e<s;e++)(i=this.layerList[e]).passThrough||(this._dirtyBlend=o(this._meshInstances,this._meshInstancesSet,i.opaqueMeshInstances)||this._dirtyBlend,this._dirtyBlend=o(this._meshInstances,this._meshInstancesSet,i.transparentMeshInstances)||this._dirtyBlend),i._dirty=!1;this._dirty=!1}function l(e,t,i){for(var n,a=0;a<t.length;)((n=t[a].material)&&3!==n.blendType)===i?(e.push(t[a]),t[a]=t[t.length-1],t.length--):a++}if(this._dirtyBlend){for(r|=8,e=0;e<s;e++)(i=this.layerList[e]).passThrough||(l(i.opaqueMeshInstances,i.transparentMeshInstances,!1),l(i.transparentMeshInstances,i.opaqueMeshInstances,!0));this._dirtyBlend=!1}if(this._dirtyLights&&(r|=2,this._dirtyLights=!1,this.updateLights()),r&&this.updateShadowCasters(),this._dirtyCameras||2&r){for(this._dirtyCameras=!1,r|=4,e=this.cameras.length=0;e<s;e++)for((i=this.layerList[e])._dirtyCameras=!1,t=0;t<i.cameras.length;t++)n=i.cameras[t],this.cameras.indexOf(n)<0&&this.cameras.push(n);1<this.cameras.length&&this.cameras.sort(function(e,t){return e.priority-t.priority});var h=[],c=0;for(e=0;e<this.cameras.length;e++){n=this.cameras[e];var u=!(h.length=0),d=c,p=null,f=!1;for(t=0;t<s;t++)(i=this.layerList[t])&&0<i.cameras.length&&0<=n.layers.indexOf(i.id)&&(h.push(i),f||i.id!==n.disablePostEffectsLayer||(f=!0,p&&(p.triggerPostprocess=!0)),0<=(a=i.cameras.indexOf(n))&&(p=this.addRenderAction(this._renderActions,c,i,t,a,u,f),c++,u=!1));d<c&&this._renderActions[d].collectDirectionalLights(h,this._splitLights[0],this._lights),!f&&p&&(p.triggerPostprocess=!0),n.renderTarget&&n.postEffectsEnabled&&this.propagateRenderTarget(d-1,n)}this._renderActions.length=c,m.clusteredLightingEnabled&&this.allocateLightClusters()}return(2&r||4&r)&&this._logRenderActions(),r},e.updateShadowCasters=function(){for(var e=this._lights.length,t=0;t<e;t++)this._lightCompositionData[t].clearShadowCasters();for(var i=this.layerList.length,n=0;n<i;n++){var a=this.layerList[n];if(!ui.has(a)){ui.add(a);for(var s=a._lights,r=0;r<s.length;r++)if(s[r].castShadows){var o=this._lightsMap.get(s[r]);this._lightCompositionData[o].addShadowCasters(a.shadowCasters)}}}ui.clear()},e.updateLights=function(){this._lights.length=0,this._lightsMap.clear();for(var e=this.layerList.length,t=0;t<e;t++){var i=this.layerList[t];if(!ui.has(i)){ui.add(i);for(var n=i._lights,a=0;a<n.length;a++){var s=n[a],r=this._lightsMap.get(s);if(void 0===r){r=this._lights.length,this._lightsMap.set(s,r),this._lights.push(s);var o=this._lightCompositionData[r];o||(o=new li,this._lightCompositionData[r]=o)}}}this._splitLightsArray(i),i._dirtyLights=!1}ui.clear(),this._splitLightsArray(this);var l=this._lights.length;this._lightCompositionData.length=l},e.findCompatibleCluster=function(e,t){for(var i=0;i<t;i++){var n=this._renderActions[i],a=this.layerList[n.layerIndex];if(e===a)return n.lightClusters;if(n.lightClusters&&ri(e._clusteredLightsSet,a._clusteredLightsSet))return n.lightClusters}return null},e.allocateLightClusters=function(){di.push.apply(di,this._worldClusters),this._worldClusters.length=0;for(var e=this._renderActions.length,t=0;t<e;t++){var i=this._renderActions[t],n=this.layerList[i.layerIndex];if(n._clusteredLightsSet.size&&(this.subLayerList[i.layerIndex]?n.transparentMeshInstances:n.opaqueMeshInstances).length){var a=this.findCompatibleCluster(n,t);a||(di.length&&(a=di.pop()),a||(a=new ai(this.device,this._clusteredLightingCells,this._clusteredLightingMaxLights)),a.name="Cluster-"+this._worldClusters.length,this._worldClusters.push(a)),i.lightClusters=a}i.lightClusters||(i.lightClusters=this.emptyWorldClusters)}di.forEach(function(e){return e.destroy()}),di.length=0},e.addRenderAction=function(e,t,i,n,a,s,r){var o=e[t];o||(o=e[t]=new oi);var l=i.renderTarget,h=i.cameras[a];h&&h.renderTarget&&1!==i.id&&(l=h.renderTarget);for(var c=!1,u=t-1;0<=u;u--)if(e[u].camera===h&&e[u].renderTarget===l){c=!0;break}var d=s||!c,p=!!d&&h.clearColorBuffer,f=!!d&&h.clearDepthBuffer,m=!!d&&h.clearStencilBuffer;return p|=i.clearColorBuffer,f|=i.clearDepthBuffer,m|=i.clearStencilBuffer,r&&h.postEffectsEnabled&&(l=null),o.reset(),o.triggerPostprocess=!1,o.layerIndex=n,o.cameraIndex=a,o.camera=h,o.renderTarget=l,o.clearColor=p,o.clearDepth=f,o.clearStencil=m,o.firstCameraUse=s,o},e.propagateRenderTarget=function(e,t){for(var i=e;0<=i;i--){var n=this._renderActions[i],a=this.layerList[n.layerIndex];if(n.renderTarget&&1!==a.id)break;if(1!==a.id){var s=null==n?void 0:n.camera.camera;if(s&&(!t.camera.rect.equals(s.rect)||!t.camera.scissorRect.equals(s.scissorRect)))break;n.renderTarget=t.renderTarget}}},e._logRenderActions=function(){},e._isLayerAdded=function(e){return 0<=this.layerList.indexOf(e)},e._isSublayerAdded=function(e,t){for(var i=0;i<this.layerList.length;i++)if(this.layerList[i]===e&&this.subLayerList[i]===t)return!0;return!1},e.push=function(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e))},e.insert=function(e,t){if(!this._isLayerAdded(e)){this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);var i=this.layerList.length;this._updateOpaqueOrder(t,i-1),this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,0,!0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e)}},e.remove=function(e){var t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];0<=t;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("remove",e);var i=this.layerList.length;this._updateOpaqueOrder(0,i-1),this._updateTransparentOrder(0,i-1)},e.pushOpaque=function(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e))},e.insertOpaque=function(e,t){if(!this._isSublayerAdded(e,!1)){this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1);var i=this.subLayerList.length;this._updateOpaqueOrder(t,i-1),this.subLayerEnabled.splice(t,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e)}},e.removeOpaque=function(e){for(var t=0,i=this.layerList.length;t<i;t++)if(this.layerList[t]===e&&!this.subLayerList[t])return this.layerList.splice(t,1),this.subLayerList.splice(t,1),i--,this._updateOpaqueOrder(t,i-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(e)<0&&this.fire("remove",e))},e.pushTransparent=function(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e))},e.insertTransparent=function(e,t){if(!this._isSublayerAdded(e,!0)){this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0);var i=this.subLayerList.length;this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",e)}},e.removeTransparent=function(e){for(var t=0,i=this.layerList.length;t<i;t++)if(this.layerList[t]===e&&this.subLayerList[t])return this.layerList.splice(t,1),this.subLayerList.splice(t,1),i--,this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(e)<0&&this.fire("remove",e))},e._getSublayerIndex=function(e,t){var i=this.layerList.indexOf(e);if(i<0)return-1;if(this.subLayerList[i]!==t){if((i=this.layerList.indexOf(e,i+1))<0)return-1;if(this.subLayerList[i]!==t)return-1}return i},e.getOpaqueIndex=function(e){return this._getSublayerIndex(e,!1)},e.getTransparentIndex=function(e){return this._getSublayerIndex(e,!0)},e.getLayerById=function(e){for(var t=0;t<this.layerList.length;t++)if(this.layerList[t].id===e)return this.layerList[t];return null},e.getLayerByName=function(e){for(var t=0;t<this.layerList.length;t++)if(this.layerList[t].name===e)return this.layerList[t];return null},e._updateOpaqueOrder=function(e,t){for(var i=e;i<=t;i++)!1===this.subLayerList[i]&&(this._opaqueOrder[this.layerList[i].id]=i)},e._updateTransparentOrder=function(e,t){for(var i=e;i<=t;i++)!0===this.subLayerList[i]&&(this._transparentOrder[this.layerList[i].id]=i)},e._sortLayersDescending=function(e,t,i){var n=0,a=0,s=0,r=-1,o=-1;for(n=0,a=e.length;n<a;n++)s=e[n],i.hasOwnProperty(s)&&(r=Math.max(r,i[s]));for(n=0,a=t.length;n<a;n++)s=t[n],i.hasOwnProperty(s)&&(o=Math.max(o,i[s]));return-1===r&&-1!==o?1:-1===o&&-1!==r?-1:o-r},e.sortTransparentLayers=function(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)},e.sortOpaqueLayers=function(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)},c(m,[{key:"clusteredLightingCells",get:function(){return this._clusteredLightingCells},set:function(e){this._clusteredLightingCells.equals(e)||(this._clusteredLightingCells.copy(e),this.updateWorldClusters())}},{key:"clusteredLightingMaxLights",get:function(){return this._clusteredLightingMaxLights},set:function(e){this._clusteredLightingMaxLights!==e&&(this._clusteredLightingMaxLights=e,this.updateWorldClusters())}},{key:"emptyWorldClusters",get:function(){return this._emptyWorldClusters||(this._emptyWorldClusters=new ai(this.device,new de(1,1,1),4),this._emptyWorldClusters.name="ClusterEmpty",this._emptyWorldClusters.update([],!1)),this._emptyWorldClusters}}]),m}(p);pi.clusteredLightingEnabled=!1;var fi="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==m?m:"undefined"!=typeof self?self:{};function mi(e){var t={exports:{}};return e(t,t.exports),t.exports}var vi=mi(function(O,F){(function(){var Ys,Ks="Expected a function",Zs="__lodash_hash_undefined__",Qs="__lodash_placeholder__",Js=9007199254740991,er=4294967295,tr=[["ary",128],["bind",1],["bindKey",2],["curry",8],["curryRight",16],["flip",512],["partial",32],["partialRight",64],["rearg",256]],ir="[object Arguments]",nr="[object Array]",ar="[object Boolean]",sr="[object Date]",rr="[object Error]",or="[object Function]",lr="[object GeneratorFunction]",hr="[object Map]",cr="[object Number]",ur="[object Object]",dr="[object Promise]",pr="[object RegExp]",fr="[object Set]",mr="[object String]",vr="[object Symbol]",gr="[object WeakMap]",_r="[object ArrayBuffer]",yr="[object DataView]",br="[object Float32Array]",xr="[object Float64Array]",Mr="[object Int8Array]",Sr="[object Int16Array]",wr="[object Int32Array]",Cr="[object Uint8Array]",Pr="[object Uint8ClampedArray]",Tr="[object Uint16Array]",Ar="[object Uint32Array]",Er=/\b__p \+= '';/g,Rr=/\b(__p \+=) '' \+/g,Dr=/(__e\(.*?\)|\b__t\)) \+\n'';/g,Ir=/&(?:amp|lt|gt|quot|#39);/g,kr=/[&<>"']/g,Lr=RegExp(Ir.source),Or=RegExp(kr.source),Fr=/<%-([\s\S]+?)%>/g,zr=/<%([\s\S]+?)%>/g,Br=/<%=([\s\S]+?)%>/g,Vr=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Ur=/^\w*$/,Nr=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Gr=/[\\^$.*+?()[\]{}|]/g,Wr=RegExp(Gr.source),Hr=/^\s+/,i=/\s/,jr=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,Xr=/\{\n\/\* \[wrapped with (.+)\] \*/,qr=/,? & /,$r=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,Yr=/[()=,{}\[\]\/\s]/,Kr=/\\(\\)?/g,Zr=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,Qr=/\w*$/,Jr=/^[-+]0x[0-9a-f]+$/i,eo=/^0b[01]+$/i,to=/^\[object .+?Constructor\]$/,io=/^0o[0-7]+$/i,no=/^(?:0|[1-9]\d*)$/,ao=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,so=/($^)/,ro=/['\n\r\u2028\u2029\\]/g,e="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff",t="a-z\\xdf-\\xf6\\xf8-\\xff",n="A-Z\\xc0-\\xd6\\xd8-\\xde",a="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",s="["+a+"]",r="["+e+"]",o="\\d+",l="["+t+"]",h="[^\\ud800-\\udfff"+a+o+"\\u2700-\\u27bf"+t+n+"]",c="\\ud83c[\\udffb-\\udfff]",u="[^\\ud800-\\udfff]",d="(?:\\ud83c[\\udde6-\\uddff]){2}",p="[\\ud800-\\udbff][\\udc00-\\udfff]",f="["+n+"]",m="(?:"+l+"|"+h+")",v="(?:"+f+"|"+h+")",g="(?:['’](?:d|ll|m|re|s|t|ve))?",_="(?:['’](?:D|LL|M|RE|S|T|VE))?",y="(?:"+r+"|"+c+")?",b="[\\ufe0e\\ufe0f]?",x=b+y+"(?:\\u200d(?:"+[u,d,p].join("|")+")"+b+y+")*",M="(?:"+["[\\u2700-\\u27bf]",d,p].join("|")+")"+x,S="(?:"+[u+r+"?",r,d,p,"[\\ud800-\\udfff]"].join("|")+")",oo=RegExp("['’]","g"),lo=RegExp(r,"g"),w=RegExp(c+"(?="+c+")|"+S+x,"g"),ho=RegExp([f+"?"+l+"+"+g+"(?="+[s,f,"$"].join("|")+")",v+"+"+_+"(?="+[s,f+m,"$"].join("|")+")",f+"?"+m+"+"+g,f+"+"+_,"\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",o,M].join("|"),"g"),C=RegExp("[\\u200d\\ud800-\\udfff"+e+"\\ufe0e\\ufe0f]"),co=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,uo=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],po=-1,fo={};fo[br]=fo[xr]=fo[Mr]=fo[Sr]=fo[wr]=fo[Cr]=fo[Pr]=fo[Tr]=fo[Ar]=!0,fo[ir]=fo[nr]=fo[_r]=fo[ar]=fo[yr]=fo[sr]=fo[rr]=fo[or]=fo[hr]=fo[cr]=fo[ur]=fo[pr]=fo[fr]=fo[mr]=fo[gr]=!1;var mo={};mo[ir]=mo[nr]=mo[_r]=mo[yr]=mo[ar]=mo[sr]=mo[br]=mo[xr]=mo[Mr]=mo[Sr]=mo[wr]=mo[hr]=mo[cr]=mo[ur]=mo[pr]=mo[fr]=mo[mr]=mo[vr]=mo[Cr]=mo[Pr]=mo[Tr]=mo[Ar]=!0,mo[rr]=mo[or]=mo[gr]=!1;var P={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},vo=parseFloat,go=parseInt,T="object"==(void 0===fi?"undefined":dx(fi))&&fi&&fi.Object===Object&&fi,A="object"==("undefined"==typeof self?"undefined":dx(self))&&self&&self.Object===Object&&self,_o=T||A||Function("return this")(),E=F&&!F.nodeType&&F,R=E&&O&&!O.nodeType&&O,yo=R&&R.exports===E,D=yo&&T.process,I=function(){try{return R&&R.require&&R.require("util").types||D&&D.binding&&D.binding("util")}catch(e){}}(),bo=I&&I.isArrayBuffer,xo=I&&I.isDate,Mo=I&&I.isMap,So=I&&I.isRegExp,wo=I&&I.isSet,Co=I&&I.isTypedArray;function Po(e,t,i){switch(i.length){case 0:return e.call(t);case 1:return e.call(t,i[0]);case 2:return e.call(t,i[0],i[1]);case 3:return e.call(t,i[0],i[1],i[2])}return e.apply(t,i)}function To(e,t,i,n){for(var a=-1,s=null==e?0:e.length;++a<s;){var r=e[a];t(n,r,i(r),e)}return n}function Ao(e,t){for(var i=-1,n=null==e?0:e.length;++i<n&&!1!==t(e[i],i,e););return e}function Eo(e,t){for(var i=-1,n=null==e?0:e.length;++i<n;)if(!t(e[i],i,e))return!1;return!0}function Ro(e,t){for(var i=-1,n=null==e?0:e.length,a=0,s=[];++i<n;){var r=e[i];t(r,i,e)&&(s[a++]=r)}return s}function Do(e,t){return!(null==e||!e.length)&&-1<Uo(e,t,0)}function Io(e,t,i){for(var n=-1,a=null==e?0:e.length;++n<a;)if(i(t,e[n]))return!0;return!1}function ko(e,t){for(var i=-1,n=null==e?0:e.length,a=Array(n);++i<n;)a[i]=t(e[i],i,e);return a}function Lo(e,t){for(var i=-1,n=t.length,a=e.length;++i<n;)e[a+i]=t[i];return e}function Oo(e,t,i,n){var a=-1,s=null==e?0:e.length;for(n&&s&&(i=e[++a]);++a<s;)i=t(i,e[a],a,e);return i}function Fo(e,t,i,n){var a=null==e?0:e.length;for(n&&a&&(i=e[--a]);a--;)i=t(i,e[a],a,e);return i}function zo(e,t){for(var i=-1,n=null==e?0:e.length;++i<n;)if(t(e[i],i,e))return!0;return!1}var k=Ho("length");function Bo(e,n,t){var a;return t(e,function(e,t,i){if(n(e,t,i))return a=t,!1}),a}function Vo(e,t,i,n){for(var a=e.length,s=i+(n?1:-1);n?s--:++s<a;)if(t(e[s],s,e))return s;return-1}function Uo(e,t,s){return t==t?function(e,t,i){for(var n=s-1,a=e.length;++n<a;)if(e[n]===t)return n;return-1}(e,t):Vo(e,Go,s)}function No(e,t,i,n){for(var a=i-1,s=e.length;++a<s;)if(n(e[a],t))return a;return-1}function Go(e){return e!=e}function Wo(e,t){var i=null==e?0:e.length;return i?Xo(e,t)/i:NaN}function Ho(t){return function(e){return null==e?Ys:e[t]}}function L(t){return function(e){return null==t?Ys:t[e]}}function jo(e,n,a,s,t){return t(e,function(e,t,i){a=s?(s=!1,e):n(a,e,t,i)}),a}function Xo(e,t){for(var i,n=-1,a=e.length;++n<a;){var s=t(e[n]);s!==Ys&&(i=i===Ys?s:i+s)}return i}function qo(e,t){for(var i=-1,n=Array(e);++i<e;)n[i]=t(i);return n}function $o(e){return e?e.slice(0,cl(e)+1).replace(Hr,""):e}function Yo(t){return function(e){return t(e)}}function Ko(t,e){return ko(e,function(e){return t[e]})}function Zo(e,t){return e.has(t)}function Qo(e,t){for(var i=-1,n=e.length;++i<n&&-1<Uo(t,e[i],0););return i}function Jo(e,t){for(var i=e.length;i--&&-1<Uo(t,e[i],0););return i}var el=L({"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","Ç":"C","ç":"c","Ð":"D","ð":"d","È":"E","É":"E","Ê":"E","Ë":"E","è":"e","é":"e","ê":"e","ë":"e","Ì":"I","Í":"I","Î":"I","Ï":"I","ì":"i","í":"i","î":"i","ï":"i","Ñ":"N","ñ":"n","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","Ù":"U","Ú":"U","Û":"U","Ü":"U","ù":"u","ú":"u","û":"u","ü":"u","Ý":"Y","ý":"y","ÿ":"y","Æ":"Ae","æ":"ae","Þ":"Th","þ":"th","ß":"ss","Ā":"A","Ă":"A","Ą":"A","ā":"a","ă":"a","ą":"a","Ć":"C","Ĉ":"C","Ċ":"C","Č":"C","ć":"c","ĉ":"c","ċ":"c","č":"c","Ď":"D","Đ":"D","ď":"d","đ":"d","Ē":"E","Ĕ":"E","Ė":"E","Ę":"E","Ě":"E","ē":"e","ĕ":"e","ė":"e","ę":"e","ě":"e","Ĝ":"G","Ğ":"G","Ġ":"G","Ģ":"G","ĝ":"g","ğ":"g","ġ":"g","ģ":"g","Ĥ":"H","Ħ":"H","ĥ":"h","ħ":"h","Ĩ":"I","Ī":"I","Ĭ":"I","Į":"I","İ":"I","ĩ":"i","ī":"i","ĭ":"i","į":"i","ı":"i","Ĵ":"J","ĵ":"j","Ķ":"K","ķ":"k","ĸ":"k","Ĺ":"L","Ļ":"L","Ľ":"L","Ŀ":"L","Ł":"L","ĺ":"l","ļ":"l","ľ":"l","ŀ":"l","ł":"l","Ń":"N","Ņ":"N","Ň":"N","Ŋ":"N","ń":"n","ņ":"n","ň":"n","ŋ":"n","Ō":"O","Ŏ":"O","Ő":"O","ō":"o","ŏ":"o","ő":"o","Ŕ":"R","Ŗ":"R","Ř":"R","ŕ":"r","ŗ":"r","ř":"r","Ś":"S","Ŝ":"S","Ş":"S","Š":"S","ś":"s","ŝ":"s","ş":"s","š":"s","Ţ":"T","Ť":"T","Ŧ":"T","ţ":"t","ť":"t","ŧ":"t","Ũ":"U","Ū":"U","Ŭ":"U","Ů":"U","Ű":"U","Ų":"U","ũ":"u","ū":"u","ŭ":"u","ů":"u","ű":"u","ų":"u","Ŵ":"W","ŵ":"w","Ŷ":"Y","ŷ":"y","Ÿ":"Y","Ź":"Z","Ż":"Z","Ž":"Z","ź":"z","ż":"z","ž":"z","Ĳ":"IJ","ĳ":"ij","Œ":"Oe","œ":"oe","ŉ":"'n","ſ":"s"}),tl=L({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"});function il(e){return"\\"+P[e]}function nl(e){return C.test(e)}function al(e){var i=-1,n=Array(e.size);return e.forEach(function(e,t){n[++i]=[t,e]}),n}function sl(t,i){return function(e){return t(i(e))}}function rl(e,t){for(var i=-1,n=e.length,a=0,s=[];++i<n;){var r=e[i];r!==t&&r!==Qs||(e[i]=Qs,s[a++]=i)}return s}function ol(e){var t=-1,i=Array(e.size);return e.forEach(function(e){i[++t]=e}),i}function ll(e){return nl(e)?function(e){for(var t=w.lastIndex=0;w.test(e);)++t;return t}(e):k(e)}function hl(e){return nl(e)?e.match(w)||[]:e.split("")}function cl(e){for(var t=e.length;t--&&i.test(e.charAt(t)););return t}var ul=L({"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"}),dl=function e(t){var i,A=(t=null==t?_o:dl.defaults(_o.Object(),t,dl.pick(_o,uo))).Array,n=t.Date,v=t.Error,g=t.Function,a=t.Math,S=t.Object,_=t.RegExp,c=t.String,E=t.TypeError,s=A.prototype,r=g.prototype,u=S.prototype,o=t["__core-js_shared__"],l=r.toString,w=u.hasOwnProperty,h=0,d=(i=/[^.]+$/.exec(o&&o.keys&&o.keys.IE_PROTO||""))?"Symbol(src)_1."+i:"",p=u.toString,f=l.call(S),m=_o._,y=_("^"+l.call(w).replace(Gr,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),b=yo?t.Buffer:Ys,x=t.Symbol,M=t.Uint8Array,C=b?b.allocUnsafe:Ys,P=sl(S.getPrototypeOf,S),T=S.create,R=u.propertyIsEnumerable,D=s.splice,I=x?x.isConcatSpreadable:Ys,k=x?x.iterator:Ys,L=x?x.toStringTag:Ys,O=function(){try{var e=ki(S,"defineProperty");return e({},"",{}),e}catch(e){}}(),F=t.clearTimeout!==_o.clearTimeout&&t.clearTimeout,z=n&&n.now!==_o.Date.now&&n.now,B=t.setTimeout!==_o.setTimeout&&t.setTimeout,V=a.ceil,U=a.floor,N=S.getOwnPropertySymbols,G=b?b.isBuffer:Ys,W=t.isFinite,H=s.join,j=sl(S.keys,S),X=a.max,q=a.min,$=n.now,Y=t.parseInt,K=a.random,Z=s.reverse,Q=ki(t,"DataView"),J=ki(t,"Map"),ee=ki(t,"Promise"),te=ki(t,"Set"),ie=ki(t,"WeakMap"),ne=ki(S,"create"),ae=ie&&new ie,se={},re=ln(Q),oe=ln(J),le=ln(ee),he=ln(te),ce=ln(ie),ue=x?x.prototype:Ys,de=ue?ue.valueOf:Ys,pe=ue?ue.toString:Ys;function fe(e){if(Ca(e)&&!fa(e)&&!(e instanceof _e)){if(e instanceof ge)return e;if(w.call(e,"__wrapped__"))return hn(e)}return new ge(e)}var me=function(){function i(){}return function(e){if(!wa(e))return{};if(T)return T(e);i.prototype=e;var t=new i;return i.prototype=Ys,t}}();function ve(){}function ge(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=Ys}function _e(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=er,this.__views__=[]}function ye(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var n=e[t];this.set(n[0],n[1])}}function be(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var n=e[t];this.set(n[0],n[1])}}function xe(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var n=e[t];this.set(n[0],n[1])}}function Me(e){var t=-1,i=null==e?0:e.length;for(this.__data__=new xe;++t<i;)this.add(e[t])}function Se(e){var t=this.__data__=new be(e);this.size=t.size}function we(e,t){var i=fa(e),n=!i&&pa(e),a=!i&&!n&&_a(e),s=!i&&!n&&!a&&ka(e),r=i||n||a||s,o=r?qo(e.length,c):[],l=o.length;for(var h in e)!t&&!w.call(e,h)||r&&("length"==h||a&&("offset"==h||"parent"==h)||s&&("buffer"==h||"byteLength"==h||"byteOffset"==h)||Ui(h,l))||o.push(h);return o}function Ce(e){var t=e.length;return t?e[yt(0,t-1)]:Ys}function Pe(e,t,i){(i!==Ys&&!ca(e[t],i)||i===Ys&&!(t in e))&&De(e,t,i)}function Te(e,t,i){var n=e[t];w.call(e,t)&&ca(n,i)&&(i!==Ys||t in e)||De(e,t,i)}function Ae(e,t){for(var i=e.length;i--;)if(ca(e[i][0],t))return i;return-1}function Ee(e,n,a,s){return Be(e,function(e,t,i){n(s,e,a(e),i)}),s}function Re(e,t){return e&&Qt(t,ts(t),e)}function De(e,t,i){"__proto__"==t&&O?O(e,t,{configurable:!0,enumerable:!0,value:i,writable:!0}):e[t]=i}function Ie(e,t){for(var i=-1,n=t.length,a=A(n),s=null==e;++i<n;)a[i]=s?Ys:Ka(e,t[i]);return a}function ke(e,t,i){return e==e&&(i!==Ys&&(e=e<=i?e:i),t!==Ys&&(e=t<=e?e:t)),e}function Le(i,n,a,e,t,s){var r,o=1&n,l=2&n,h=4&n;if(a&&(r=t?a(i,e,t,s):a(i)),r!==Ys)return r;if(!wa(i))return i;var c,u,d,p,f,m,v,g,_=fa(i);if(_){if(v=(m=i).length,g=new m.constructor(v),v&&"string"==typeof m[0]&&w.call(m,"index")&&(g.index=m.index,g.input=m.input),r=g,!o)return Zt(i,r)}else{var y=Fi(i),b=y==or||y==lr;if(_a(i))return jt(i,o);if(y==ur||y==ir||b&&!t){if(r=l||b?{}:Bi(i),!o)return l?(d=i,p=(f=r)&&Qt(i,is(i),f),Qt(d,Oi(d),p)):(u=Re(r,c=i),Qt(c,Li(c),u))}else{if(!mo[y])return t?i:{};r=function(e,t,i){var n,a,s,r,o,l=e.constructor;switch(t){case _r:return Xt(e);case ar:case sr:return new l(+e);case yr:return s=e,r=i?Xt(s.buffer):s.buffer,new s.constructor(r,s.byteOffset,s.byteLength);case br:case xr:case Mr:case Sr:case wr:case Cr:case Pr:case Tr:case Ar:return qt(e,i);case hr:return new l;case cr:case mr:return new l(e);case pr:return(a=new(n=e).constructor(n.source,Qr.exec(n))).lastIndex=n.lastIndex,a;case fr:return new l;case vr:return o=e,de?S(de.call(o)):{}}}(i,y,o)}}s||(s=new Se);var x=s.get(i);if(x)return x;s.set(i,r),Ra(i)?i.forEach(function(e){r.add(Le(e,n,a,e,i,s))}):Pa(i)&&i.forEach(function(e,t){r.set(t,Le(e,n,a,t,i,s))});var M=_?Ys:(h?l?Pi:Ci:l?is:ts)(i);return Ao(M||i,function(e,t){M&&(e=i[t=e]),Te(r,t,Le(e,n,a,t,i,s))}),r}function Oe(e,t,i){var n=i.length;if(null==e)return!n;for(e=S(e);n--;){var a=i[n],s=t[a],r=e[a];if(r===Ys&&!(a in e)||!s(r))return!1}return!0}function Fe(e,t,i){if("function"!=typeof e)throw new E(Ks);return Qi(function(){e.apply(Ys,i)},t)}function ze(e,t,i,n){var a=-1,s=Do,r=!0,o=e.length,l=[],h=t.length;if(!o)return l;i&&(t=ko(t,Yo(i))),n?(s=Io,r=!1):200<=t.length&&(s=Zo,r=!1,t=new Me(t));e:for(;++a<o;){var c=e[a],u=null==i?c:i(c);if(c=n||0!==c?c:0,r&&u==u){for(var d=h;d--;)if(t[d]===u)continue e;l.push(c)}else s(t,u,n)||l.push(c)}return l}fe.templateSettings={escape:Fr,evaluate:zr,interpolate:Br,variable:"",imports:{_:fe}},(fe.prototype=ve.prototype).constructor=fe,(ge.prototype=me(ve.prototype)).constructor=ge,(_e.prototype=me(ve.prototype)).constructor=_e,ye.prototype.clear=function(){this.__data__=ne?ne(null):{},this.size=0},ye.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},ye.prototype.get=function(e){var t=this.__data__;if(ne){var i=t[e];return i===Zs?Ys:i}return w.call(t,e)?t[e]:Ys},ye.prototype.has=function(e){var t=this.__data__;return ne?t[e]!==Ys:w.call(t,e)},ye.prototype.set=function(e,t){var i=this.__data__;return this.size+=this.has(e)?0:1,i[e]=ne&&t===Ys?Zs:t,this},be.prototype.clear=function(){this.__data__=[],this.size=0},be.prototype.delete=function(e){var t=this.__data__,i=Ae(t,e);return!(i<0||(i==t.length-1?t.pop():D.call(t,i,1),--this.size,0))},be.prototype.get=function(e){var t=this.__data__,i=Ae(t,e);return i<0?Ys:t[i][1]},be.prototype.has=function(e){return-1<Ae(this.__data__,e)},be.prototype.set=function(e,t){var i=this.__data__,n=Ae(i,e);return n<0?(++this.size,i.push([e,t])):i[n][1]=t,this},xe.prototype.clear=function(){this.size=0,this.__data__={hash:new ye,map:new(J||be),string:new ye}},xe.prototype.delete=function(e){var t=Di(this,e).delete(e);return this.size-=t?1:0,t},xe.prototype.get=function(e){return Di(this,e).get(e)},xe.prototype.has=function(e){return Di(this,e).has(e)},xe.prototype.set=function(e,t){var i=Di(this,e),n=i.size;return i.set(e,t),this.size+=i.size==n?0:1,this},Me.prototype.add=Me.prototype.push=function(e){return this.__data__.set(e,Zs),this},Me.prototype.has=function(e){return this.__data__.has(e)},Se.prototype.clear=function(){this.__data__=new be,this.size=0},Se.prototype.delete=function(e){var t=this.__data__,i=t.delete(e);return this.size=t.size,i},Se.prototype.get=function(e){return this.__data__.get(e)},Se.prototype.has=function(e){return this.__data__.has(e)},Se.prototype.set=function(e,t){var i=this.__data__;if(i instanceof be){var n=i.__data__;if(!J||n.length<199)return n.push([e,t]),this.size=++i.size,this;i=this.__data__=new xe(n)}return i.set(e,t),this.size=i.size,this};var Be=ti(Xe),Ve=ti(qe,!0);function Ue(e,n){var a=!0;return Be(e,function(e,t,i){return a=!!n(e,t,i)}),a}function Ne(e,t,i){for(var n=-1,a=e.length;++n<a;){var s=e[n],r=t(s);if(null!=r&&(o===Ys?r==r&&!Ia(r):i(r,o)))var o=r,l=s}return l}function Ge(e,n){var a=[];return Be(e,function(e,t,i){n(e,t,i)&&a.push(e)}),a}function We(e,t,i,n,a){var s=-1,r=e.length;for(i||(i=Vi),a||(a=[]);++s<r;){var o=e[s];0<t&&i(o)?1<t?We(o,t-1,i,n,a):Lo(a,o):n||(a[a.length]=o)}return a}var He=ii(),je=ii(!0);function Xe(e,t){return e&&He(e,t,ts)}function qe(e,t){return e&&je(e,t,ts)}function $e(t,e){return Ro(e,function(e){return xa(t[e])})}function Ye(e,t){for(var i=0,n=(t=Nt(t,e)).length;null!=e&&i<n;)e=e[on(t[i++])];return i&&i==n?e:Ys}function Ke(e,t,i){var n=t(e);return fa(e)?n:Lo(n,i(e))}function Ze(e){return null==e?e===Ys?"[object Undefined]":"[object Null]":L&&L in S(e)?function(e){var t=w.call(e,L),i=e[L];try{e[L]=Ys;var n=!0}catch(e){}var a=p.call(e);return n&&(t?e[L]=i:delete e[L]),a}(e):(t=e,p.call(t));var t}function Qe(e,t){return t<e}function Je(e,t){return null!=e&&w.call(e,t)}function et(e,t){return null!=e&&t in S(e)}function tt(e,t,i){for(var n=i?Io:Do,a=e[0].length,s=e.length,r=s,o=A(s),l=1/0,h=[];r--;){var c=e[r];r&&t&&(c=ko(c,Yo(t))),l=q(c.length,l),o[r]=!i&&(t||120<=a&&120<=c.length)?new Me(r&&c):Ys}c=e[0];var u=-1,d=o[0];e:for(;++u<a&&h.length<l;){var p=c[u],f=t?t(p):p;if(p=i||0!==p?p:0,!(d?Zo(d,f):n(h,f,i))){for(r=s;--r;){var m=o[r];if(!(m?Zo(m,f):n(e[r],f,i)))continue e}d&&d.push(f),h.push(p)}}return h}function it(e,t,i){var n=null==(e=Yi(e,t=Nt(t,e)))?e:e[on(bn(t))];return null==n?Ys:Po(n,e,i)}function nt(e){return Ca(e)&&Ze(e)==ir}function at(e,t,i,n,a){return e===t||(null==e||null==t||!Ca(e)&&!Ca(t)?e!=e&&t!=t:function(e,t,i,n,a,s){var r=fa(e),o=fa(t),u=r?nr:Fi(e),l=o?nr:Fi(t),h=(u=u==ir?ur:u)==ur,c=(l=l==ir?ur:l)==ur,d=u==l;if(d&&_a(e)){if(!_a(t))return!1;h=!(r=!0)}if(d&&!h)return s||(s=new Se),r||ka(e)?Si(e,t,i,n,a,s):function(e,t,i,n,a,s,r){switch(u){case yr:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case _r:return!(e.byteLength!=t.byteLength||!s(new M(e),new M(t)));case ar:case sr:case cr:return ca(+e,+t);case rr:return e.name==t.name&&e.message==t.message;case pr:case mr:return e==t+"";case hr:var o=al;case fr:var l=1&n;if(o||(o=ol),e.size!=t.size&&!l)return!1;var h=r.get(e);if(h)return h==t;n|=2,r.set(e,t);var c=Si(o(e),o(t),n,a,s,r);return r.delete(e),c;case vr:if(de)return de.call(e)==de.call(t)}return!1}(e,t,0,i,n,a,s);if(!(1&i)){var p=h&&w.call(e,"__wrapped__"),f=c&&w.call(t,"__wrapped__");if(p||f){var m=p?e.value():e,v=f?t.value():t;return s||(s=new Se),a(m,v,i,n,s)}}return!!d&&(s||(s=new Se),function(e,t,i,n,a,s){var r=1&i,o=Ci(e),l=o.length;if(l!=Ci(t).length&&!r)return!1;for(var h=l;h--;){var c=o[h];if(!(r?c in t:w.call(t,c)))return!1}var u=s.get(e),d=s.get(t);if(u&&d)return u==t&&d==e;var p=!0;s.set(e,t),s.set(t,e);for(var f=r;++h<l;){var m=e[c=o[h]],v=t[c];if(n)var g=r?n(v,m,c,t,e,s):n(m,v,c,e,t,s);if(!(g===Ys?m===v||a(m,v,i,n,s):g)){p=!1;break}f||(f="constructor"==c)}if(p&&!f){var _=e.constructor,y=t.constructor;_==y||!("constructor"in e)||!("constructor"in t)||"function"==typeof _&&_ instanceof _&&"function"==typeof y&&y instanceof y||(p=!1)}return s.delete(e),s.delete(t),p}(e,t,i,n,a,s))}(e,t,i,n,at,a))}function st(e,t,i,n){var a=i.length,s=a,r=!n;if(null==e)return!s;for(e=S(e);a--;){var o=i[a];if(r&&o[2]?o[1]!==e[o[0]]:!(o[0]in e))return!1}for(;++a<s;){var l=(o=i[a])[0],h=e[l],c=o[1];if(r&&o[2]){if(h===Ys&&!(l in e))return!1}else{var u=new Se;if(n)var d=n(h,c,l,e,t,u);if(!(d===Ys?at(c,h,3,n,u):d))return!1}}return!0}function rt(e){return!(!wa(e)||d&&d in e)&&(xa(e)?y:to).test(ln(e))}function ot(e){return"function"==typeof e?e:null==e?Ts:"object"==(void 0===e?"undefined":dx(e))?fa(e)?dt(e[0],e[1]):ut(e):Fs(e)}function lt(e){if(!ji(e))return j(e);var t=[];for(var i in S(e))w.call(e,i)&&"constructor"!=i&&t.push(i);return t}function ht(e,t){return e<t}function ct(e,n){var a=-1,s=va(e)?A(e.length):[];return Be(e,function(e,t,i){s[++a]=n(e,t,i)}),s}function ut(t){var i=Ii(t);return 1==i.length&&i[0][2]?qi(i[0][0],i[0][1]):function(e){return e===t||st(e,t,i)}}function dt(i,n){return Gi(i)&&Xi(n)?qi(on(i),n):function(e){var t=Ka(e,i);return t===Ys&&t===n?Za(e,i):at(n,t,3)}}function pt(n,a,s,r,o){n!==a&&He(a,function(e,t){if(o||(o=new Se),wa(e))!function(e,t,i,n,a,s,r){var o=Ki(e,i),l=Ki(t,i),h=r.get(l);if(h)Pe(e,i,h);else{var c=s?s(o,l,i+"",e,t,r):Ys,u=c===Ys;if(u){var d=fa(l),p=!d&&_a(l),f=!d&&!p&&ka(l);c=l,d||p||f?fa(o)?c=o:ga(o)?c=Zt(o):p?c=jt(l,!(u=!1)):f?c=qt(l,!(u=!1)):c=[]:Aa(l)||pa(l)?pa(c=o)?c=Na(o):wa(o)&&!xa(o)||(c=Bi(l)):u=!1}u&&(r.set(l,c),a(c,l,n,s,r),r.delete(l)),Pe(e,i,c)}}(n,a,t,s,pt,r,o);else{var i=r?r(Ki(n,t),e,t+"",n,a,o):Ys;i===Ys&&(i=e),Pe(n,t,i)}},is)}function ft(e,t){var i=e.length;if(i)return Ui(t+=t<0?i:0,i)?e[t]:Ys}function mt(e,n,a){n=n.length?ko(n,function(t){return fa(t)?function(e){return Ye(e,1===t.length?t[0]:t)}:t}):[Ts];var s=-1;return n=ko(n,Yo(Ri())),function(e,t){var i=e.length;for(e.sort(function(e,t){return function(e,t,i){for(var n=-1,a=e.criteria,s=t.criteria,r=a.length,o=i.length;++n<r;){var l=$t(a[n],s[n]);if(l)return o<=n?l:l*("desc"==i[n]?-1:1)}return e.index-t.index}(e,t,a)});i--;)e[i]=e[i].value;return e}(ct(e,function(t,e,i){return{criteria:ko(n,function(e){return e(t)}),index:++s,value:t}}))}function vt(e,t,i){for(var n=-1,a=t.length,s={};++n<a;){var r=t[n],o=Ye(e,r);i(o,r)&&Mt(s,Nt(r,e),o)}return s}function gt(e,t,i,n){var a=n?No:Uo,s=-1,r=t.length,o=e;for(e===t&&(t=Zt(t)),i&&(o=ko(e,Yo(i)));++s<r;)for(var l=0,h=t[s],c=i?i(h):h;-1<(l=a(o,c,l,n));)o!==e&&D.call(o,l,1),D.call(e,l,1);return e}function _t(e,t){for(var i=e?t.length:0,n=i-1;i--;){var a=t[i];if(i==n||a!==s){var s=a;Ui(a)?D.call(e,a,1):kt(e,a)}}return e}function yt(e,t){return e+U(K()*(t-e+1))}function bt(e,t){var i="";if(!e||t<1||Js<t)return i;for(;t%2&&(i+=e),(t=U(t/2))&&(e+=e),t;);return i}function xt(e,t){return Ji($i(e,t,Ts),e+"")}function Mt(e,t,i,n){if(!wa(e))return e;for(var a=-1,s=(t=Nt(t,e)).length,r=s-1,o=e;null!=o&&++a<s;){var l=on(t[a]),h=i;if("__proto__"===l||"constructor"===l||"prototype"===l)return e;if(a!=r){var c=o[l];(h=n?n(c,l,o):Ys)===Ys&&(h=wa(c)?c:Ui(t[a+1])?[]:{})}Te(o,l,h),o=o[l]}return e}var St=ae?function(e,t){return ae.set(e,t),e}:Ts,wt=O?function(e,t){return O(e,"toString",{configurable:!0,enumerable:!1,value:ws(t),writable:!0})}:Ts;function Ct(e,t,i){var n=-1,a=e.length;t<0&&(t=a<-t?0:a+t),(i=a<i?a:i)<0&&(i+=a),a=i<t?0:i-t>>>0,t>>>=0;for(var s=A(a);++n<a;)s[n]=e[n+t];return s}function Pt(e,n){var a;return Be(e,function(e,t,i){return!(a=n(e,t,i))}),!!a}function Tt(e,t,i){var n=0,a=null==e?n:e.length;if("number"==typeof t&&t==t&&a<=2147483647){for(;n<a;){var s=n+a>>>1,r=e[s];null!==r&&!Ia(r)&&(i?r<=t:r<t)?n=s+1:a=s}return a}return At(e,t,Ts,i)}function At(e,t,i,n){var a=0,s=null==e?0:e.length;if(0===s)return 0;for(var r=(t=i(t))!=t,o=null===t,l=Ia(t),h=t===Ys;a<s;){var c=U((a+s)/2),u=i(e[c]),d=u!==Ys,p=null===u,f=u==u,m=Ia(u);if(r)var v=n||f;else v=h?f&&(n||d):o?f&&d&&(n||!p):l?f&&d&&!p&&(n||!m):!p&&!m&&(n?u<=t:u<t);v?a=c+1:s=c}return q(s,4294967294)}function Et(e,t){for(var i=-1,n=e.length,a=0,s=[];++i<n;){var r=e[i],o=t?t(r):r;if(!i||!ca(o,l)){var l=o;s[a++]=0===r?0:r}}return s}function Rt(e){return"number"==typeof e?e:Ia(e)?NaN:+e}function Dt(e){if("string"==typeof e)return e;if(fa(e))return ko(e,Dt)+"";if(Ia(e))return pe?pe.call(e):"";var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function It(e,t,i){var n=-1,a=Do,s=e.length,r=!0,o=[],l=o;if(i)r=!1,a=Io;else if(200<=s){var h=t?null:gi(e);if(h)return ol(h);r=!1,a=Zo,l=new Me}else l=t?[]:o;e:for(;++n<s;){var c=e[n],u=t?t(c):c;if(c=i||0!==c?c:0,r&&u==u){for(var d=l.length;d--;)if(l[d]===u)continue e;t&&l.push(u),o.push(c)}else a(l,u,i)||(l!==o&&l.push(u),o.push(c))}return o}function kt(e,t){return null==(e=Yi(e,t=Nt(t,e)))||delete e[on(bn(t))]}function Lt(e,t,i,n){return Mt(e,t,i(Ye(e,t)),n)}function Ot(e,t,i,n){for(var a=e.length,s=n?a:-1;(n?s--:++s<a)&&t(e[s],s,e););return i?Ct(e,n?0:s,n?s+1:a):Ct(e,n?s+1:0,n?a:s)}function Ft(e,t){var i=e;return i instanceof _e&&(i=i.value()),Oo(t,function(e,t){return t.func.apply(t.thisArg,Lo([e],t.args))},i)}function zt(e,t,i){var n=e.length;if(n<2)return n?It(e[0]):[];for(var a=-1,s=A(n);++a<n;)for(var r=e[a],o=-1;++o<n;)o!=a&&(s[a]=ze(s[a]||r,e[o],t,i));return It(We(s,1),t,i)}function Bt(e,t,i){for(var n=-1,a=e.length,s=t.length,r={};++n<a;){var o=n<s?t[n]:Ys;i(r,e[n],o)}return r}function Vt(e){return ga(e)?e:[]}function Ut(e){return"function"==typeof e?e:Ts}function Nt(e,t){return fa(e)?e:Gi(e,t)?[e]:rn(Ga(e))}var Gt=xt;function Wt(e,t,i){var n=e.length;return i=i===Ys?n:i,!t&&n<=i?e:Ct(e,t,i)}var Ht=F||function(e){return _o.clearTimeout(e)};function jt(e,t){if(t)return e.slice();var i=e.length,n=C?C(i):new e.constructor(i);return e.copy(n),n}function Xt(e){var t=new e.constructor(e.byteLength);return new M(t).set(new M(e)),t}function qt(e,t){var i=t?Xt(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.length)}function $t(e,t){if(e!==t){var i=e!==Ys,n=null===e,a=e==e,s=Ia(e),r=t!==Ys,o=null===t,l=t==t,h=Ia(t);if(!o&&!h&&!s&&t<e||s&&r&&l&&!o&&!h||n&&r&&l||!i&&l||!a)return 1;if(!n&&!s&&!h&&e<t||h&&i&&a&&!n&&!s||o&&i&&a||!r&&a||!l)return-1}return 0}function Yt(e,t,i,n){for(var a=-1,s=e.length,r=i.length,o=-1,l=t.length,h=X(s-r,0),c=A(l+h),u=!n;++o<l;)c[o]=t[o];for(;++a<r;)(u||a<s)&&(c[i[a]]=e[a]);for(;h--;)c[o++]=e[a++];return c}function Kt(e,t,i,n){for(var a=-1,s=e.length,r=-1,o=i.length,l=-1,h=t.length,c=X(s-o,0),u=A(c+h),d=!n;++a<c;)u[a]=e[a];for(var p=a;++l<h;)u[p+l]=t[l];for(;++r<o;)(d||a<s)&&(u[p+i[r]]=e[a++]);return u}function Zt(e,t){var i=-1,n=e.length;for(t||(t=A(n));++i<n;)t[i]=e[i];return t}function Qt(e,t,i,n){var a=!i;i||(i={});for(var s=-1,r=t.length;++s<r;){var o=t[s],l=n?n(i[o],e[o],o,i,e):Ys;l===Ys&&(l=e[o]),a?De(i,o,l):Te(i,o,l)}return i}function Jt(a,s){return function(e,t){var i=fa(e)?To:Ee,n=s?s():{};return i(e,a,Ri(t,2),n)}}function ei(o){return xt(function(e,t){var i=-1,n=t.length,a=1<n?t[n-1]:Ys,s=2<n?t[2]:Ys;for(a=3<o.length&&"function"==typeof a?(n--,a):Ys,s&&Ni(t[0],t[1],s)&&(a=n<3?Ys:a,n=1),e=S(e);++i<n;){var r=t[i];r&&o(e,r,i,a)}return e})}function ti(s,r){return function(e,t){if(null==e)return e;if(!va(e))return s(e,t);for(var i=e.length,n=r?i:-1,a=S(e);(r?n--:++n<i)&&!1!==t(a[n],n,a););return e}}function ii(l){return function(e,t,i){for(var n=-1,a=S(e),s=i(e),r=s.length;r--;){var o=s[l?r:++n];if(!1===t(a[o],o,a))break}return e}}function ni(a){return function(e){var t=nl(e=Ga(e))?hl(e):Ys,i=t?t[0]:e.charAt(0),n=t?Wt(t,1).join(""):e.slice(1);return i[a]()+n}}function ai(t){return function(e){return Oo(xs(ps(e).replace(oo,"")),t,"")}}function si(n){return function(){var e=arguments;switch(e.length){case 0:return new n;case 1:return new n(e[0]);case 2:return new n(e[0],e[1]);case 3:return new n(e[0],e[1],e[2]);case 4:return new n(e[0],e[1],e[2],e[3]);case 5:return new n(e[0],e[1],e[2],e[3],e[4]);case 6:return new n(e[0],e[1],e[2],e[3],e[4],e[5]);case 7:return new n(e[0],e[1],e[2],e[3],e[4],e[5],e[6])}var t=me(n.prototype),i=n.apply(t,e);return wa(i)?i:t}}function ri(r){return function(e,t,i){var n=S(e);if(!va(e)){var a=Ri(t,3);e=ts(e),t=function(e){return a(n[e],e,n)}}var s=r(e,t,i);return-1<s?n[a?e[s]:s]:Ys}}function oi(l){return wi(function(a){var s=a.length,e=s,t=ge.prototype.thru;for(l&&a.reverse();e--;){var i=a[e];if("function"!=typeof i)throw new E(Ks);if(t&&!r&&"wrapper"==Ai(i))var r=new ge([],!0)}for(e=r?e:s;++e<s;){var n=Ai(i=a[e]),o="wrapper"==n?Ti(i):Ys;r=o&&Wi(o[0])&&424==o[1]&&!o[4].length&&1==o[9]?r[Ai(o[0])].apply(r,o[3]):1==i.length&&Wi(i)?r[n]():r.thru(i)}return function(){var e=arguments,t=e[0];if(r&&1==e.length&&fa(t))return r.plant(t).value();for(var i=0,n=s?a[i].apply(this,e):t;++i<s;)n=a[i].call(this,n);return n}})}function li(h,c,u,d,p,f,m,v,g,_){var y=128&c,b=1&c,x=2&c,M=24&c,S=512&c,w=x?Ys:si(h);return function e(){for(var t=arguments.length,i=A(t),n=t;n--;)i[n]=arguments[n];if(M)var a=Ei(e),s=function(e,t){for(var i=e.length,n=0;i--;)e[i]===t&&++n;return n}(i,a);if(d&&(i=Yt(i,d,p,M)),f&&(i=Kt(i,f,m,M)),t-=s,M&&t<_){var r=rl(i,a);return mi(h,c,li,e.placeholder,u,i,r,v,g,_-t)}var o=b?u:this,l=x?o[h]:h;return t=i.length,v?i=function(e,t){for(var i=e.length,n=q(t.length,i),a=Zt(e);n--;){var s=t[n];e[n]=Ui(s,i)?a[s]:Ys}return e}(i,v):S&&1<t&&i.reverse(),y&&g<t&&(i.length=g),this&&this!==_o&&this instanceof e&&(l=w||si(l)),l.apply(o,i)}}function hi(r,o){return function(e,t){return i=e,n=r,a=o(t),s={},Xe(i,function(e,t,i){n(s,a(e),t,i)}),s;var i,n,a,s}}function ci(n,a){return function(e,t){var i;if(e===Ys&&t===Ys)return a;if(e!==Ys&&(i=e),t!==Ys){if(i===Ys)return t;"string"==typeof e||"string"==typeof t?(e=Dt(e),t=Dt(t)):(e=Rt(e),t=Rt(t)),i=n(e,t)}return i}}function ui(n){return wi(function(e){return e=ko(e,Yo(Ri())),xt(function(t){var i=this;return n(e,function(e){return Po(e,i,t)})})})}function di(e,t){var i=(t=t===Ys?" ":Dt(t)).length;if(i<2)return i?bt(t,e):t;var n=bt(t,V(e/ll(t)));return nl(t)?Wt(hl(n),0,e).join(""):n.slice(0,e)}function pi(n){return function(e,t,i){return i&&"number"!=typeof i&&Ni(e,t,i)&&(t=i=Ys),e=za(e),t===Ys?(t=e,e=0):t=za(t),function(e,t,i,n){for(var a=-1,s=X(V((t-e)/(i||1)),0),r=A(s);s--;)r[n?s:++a]=e,e+=i;return r}(e,t,i=i===Ys?e<t?1:-1:za(i),n)}}function fi(i){return function(e,t){return"string"==typeof e&&"string"==typeof t||(e=Ua(e),t=Ua(t)),i(e,t)}}function mi(e,t,i,n,a,s,r,o,l,h){var c=8&t;t|=c?32:64,4&(t&=~(c?64:32))||(t&=-4);var u=[e,t,a,c?s:Ys,c?r:Ys,c?Ys:s,c?Ys:r,o,l,h],d=i.apply(Ys,u);return Wi(e)&&Zi(d,u),d.placeholder=n,en(d,e,t)}function vi(e){var n=a[e];return function(e,t){if(e=Ua(e),(t=null==t?0:q(Ba(t),292))&&W(e)){var i=(Ga(e)+"e").split("e");return+((i=(Ga(n(i[0]+"e"+(+i[1]+t)))+"e").split("e"))[0]+"e"+(+i[1]-t))}return n(e)}}var gi=te&&1/ol(new te([,-0]))[1]==1/0?function(e){return new te(e)}:Is;function _i(r){return function(e){var t,i,n,a,s=Fi(e);return s==hr?al(e):s==fr?(i=e,n=-1,a=Array(i.size),i.forEach(function(e){a[++n]=[e,e]}),a):ko(r(t=e),function(e){return[e,t[e]]})}}function yi(e,t,i,n,a,s,r,o){var l=2&t;if(!l&&"function"!=typeof e)throw new E(Ks);var h=n?n.length:0;if(h||(t&=-97,n=a=Ys),r=r===Ys?r:X(Ba(r),0),o=o===Ys?o:Ba(o),h-=a?a.length:0,64&t){var c=n,u=a;n=a=Ys}var d,p,f,m,v,g,_,y,b,x,M,S,w,C=l?Ys:Ti(e),P=[e,t,i,n,a,c,u,s,r,o];if(C&&function(e,t){var i=e[1],n=t[1],a=i|n,s=a<131,r=128==n&&8==i||128==n&&256==i&&e[7].length<=t[8]||384==n&&t[7].length<=t[8]&&8==i;if(!s&&!r)return;1&n&&(e[2]=t[2],a|=1&i?0:4);var o=t[3];if(o){var l=e[3];e[3]=l?Yt(l,o,t[4]):o,e[4]=l?rl(e[3],Qs):t[4]}(o=t[5])&&(l=e[5],e[5]=l?Kt(l,o,t[6]):o,e[6]=l?rl(e[5],Qs):t[6]),(o=t[7])&&(e[7]=o),128&n&&(e[8]=null==e[8]?t[8]:q(e[8],t[8])),null==e[9]&&(e[9]=t[9]),e[0]=t[0],e[1]=a}(P,C),e=P[0],t=P[1],i=P[2],n=P[3],a=P[4],!(o=P[9]=P[9]===Ys?l?0:e.length:X(P[9]-h,0))&&24&t&&(t&=-25),t&&1!=t)T=8==t||16==t?(M=t,S=o,w=si(x=e),function e(){for(var t=arguments.length,i=A(t),n=t,a=Ei(e);n--;)i[n]=arguments[n];var s=t<3&&i[0]!==a&&i[t-1]!==a?[]:rl(i,a);return(t-=s.length)<S?mi(x,M,li,e.placeholder,Ys,i,s,Ys,Ys,S-t):Po(this&&this!==_o&&this instanceof e?w:x,this,i)}):32!=t&&33!=t||a.length?li.apply(Ys,P):(g=i,_=n,y=1&t,b=si(v=e),function e(){for(var t=-1,i=arguments.length,n=-1,a=_.length,s=A(a+i),r=this&&this!==_o&&this instanceof e?b:v;++n<a;)s[n]=_[n];for(;i--;)s[n++]=arguments[++t];return Po(r,y?g:this,s)});else var T=(p=i,f=1&t,m=si(d=e),function e(){return(this&&this!==_o&&this instanceof e?m:d).apply(f?p:this,arguments)});return en((C?St:Zi)(T,P),e,t)}function bi(e,t,i,n){return e===Ys||ca(e,u[i])&&!w.call(n,i)?t:e}function xi(e,t,i,n,a,s){return wa(e)&&wa(t)&&(s.set(t,e),pt(e,t,Ys,xi,s),s.delete(t)),e}function Mi(e){return Aa(e)?Ys:e}function Si(e,t,i,n,a,s){var r=1&i,o=e.length,l=t.length;if(o!=l&&!(r&&o<l))return!1;var h=s.get(e),c=s.get(t);if(h&&c)return h==t&&c==e;var u=-1,d=!0,p=2&i?new Me:Ys;for(s.set(e,t),s.set(t,e);++u<o;){var f=e[u],m=t[u];if(n)var v=r?n(m,f,u,t,e,s):n(f,m,u,e,t,s);if(v!==Ys){if(v)continue;d=!1;break}if(p){if(!zo(t,function(e,t){if(!Zo(p,t)&&(f===e||a(f,e,i,n,s)))return p.push(t)})){d=!1;break}}else if(f!==m&&!a(f,m,i,n,s)){d=!1;break}}return s.delete(e),s.delete(t),d}function wi(e){return Ji($i(e,Ys,mn),e+"")}function Ci(e){return Ke(e,ts,Li)}function Pi(e){return Ke(e,is,Oi)}var Ti=ae?function(e){return ae.get(e)}:Is;function Ai(e){for(var t=e.name+"",i=se[t],n=w.call(se,t)?i.length:0;n--;){var a=i[n],s=a.func;if(null==s||s==e)return a.name}return t}function Ei(e){return(w.call(fe,"placeholder")?fe:e).placeholder}function Ri(){var e=fe.iteratee||As;return e=e===As?ot:e,arguments.length?e(arguments[0],arguments[1]):e}function Di(e,t){var i,n,a=e.__data__;return("string"==(n=void 0===(i=t)?"undefined":dx(i))||"number"==n||"symbol"==n||"boolean"==n?"__proto__"!==i:null===i)?a["string"==typeof t?"string":"hash"]:a.map}function Ii(e){for(var t=ts(e),i=t.length;i--;){var n=t[i],a=e[n];t[i]=[n,a,Xi(a)]}return t}function ki(e,t){var i=null==e?Ys:e[t];return rt(i)?i:Ys}var Li=N?function(t){return null==t?[]:(t=S(t),Ro(N(t),function(e){return R.call(t,e)}))}:Vs,Oi=N?function(e){for(var t=[];e;)Lo(t,Li(e)),e=P(e);return t}:Vs,Fi=Ze;function zi(e,t,i){for(var n=-1,a=(t=Nt(t,e)).length,s=!1;++n<a;){var r=on(t[n]);if(!(s=null!=e&&i(e,r)))break;e=e[r]}return s||++n!=a?s:!!(a=null==e?0:e.length)&&Sa(a)&&Ui(r,a)&&(fa(e)||pa(e))}function Bi(e){return"function"!=typeof e.constructor||ji(e)?{}:me(P(e))}function Vi(e){return fa(e)||pa(e)||!!(I&&e&&e[I])}function Ui(e,t){var i=void 0===e?"undefined":dx(e);return!!(t=null==t?Js:t)&&("number"==i||"symbol"!=i&&no.test(e))&&-1<e&&e%1==0&&e<t}function Ni(e,t,i){if(!wa(i))return!1;var n=void 0===t?"undefined":dx(t);return!!("number"==n?va(i)&&Ui(t,i.length):"string"==n&&t in i)&&ca(i[t],e)}function Gi(e,t){if(fa(e))return!1;var i=void 0===e?"undefined":dx(e);return!("number"!=i&&"symbol"!=i&&"boolean"!=i&&null!=e&&!Ia(e))||Ur.test(e)||!Vr.test(e)||null!=t&&e in S(t)}function Wi(e){var t=Ai(e),i=fe[t];if("function"!=typeof i||!(t in _e.prototype))return!1;if(e===i)return!0;var n=Ti(i);return!!n&&e===n[0]}(Q&&Fi(new Q(new ArrayBuffer(1)))!=yr||J&&Fi(new J)!=hr||ee&&Fi(ee.resolve())!=dr||te&&Fi(new te)!=fr||ie&&Fi(new ie)!=gr)&&(Fi=function(e){var t=Ze(e),i=t==ur?e.constructor:Ys,n=i?ln(i):"";if(n)switch(n){case re:return yr;case oe:return hr;case le:return dr;case he:return fr;case ce:return gr}return t});var Hi=o?xa:Us;function ji(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||u)}function Xi(e){return e==e&&!wa(e)}function qi(t,i){return function(e){return null!=e&&e[t]===i&&(i!==Ys||t in S(e))}}function $i(s,r,o){return r=X(r===Ys?s.length-1:r,0),function(){for(var e=arguments,t=-1,i=X(e.length-r,0),n=A(i);++t<i;)n[t]=e[r+t];t=-1;for(var a=A(r+1);++t<r;)a[t]=e[t];return a[r]=o(n),Po(s,this,a)}}function Yi(e,t){return t.length<2?e:Ye(e,Ct(t,0,-1))}function Ki(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}var Zi=tn(St),Qi=B||function(e,t){return _o.setTimeout(e,t)},Ji=tn(wt);function en(e,t,i){var n,a,s,r=t+"";return Ji(e,function(e,t){var i=t.length;if(!i)return e;var n=i-1;return t[n]=(1<i?"& ":"")+t[n],t=t.join(2<i?", ":" "),e.replace(jr,"{\n/* [wrapped with "+t+"] */\n")}(r,(s=r.match(Xr),n=s?s[1].split(qr):[],a=i,Ao(tr,function(e){var t="_."+e[0];a&e[1]&&!Do(n,t)&&n.push(t)}),n.sort())))}function tn(i){var n=0,a=0;return function(){var e=$(),t=16-(e-a);if(a=e,0<t){if(800<=++n)return arguments[0]}else n=0;return i.apply(Ys,arguments)}}function nn(e,t){var i=-1,n=e.length,a=n-1;for(t=t===Ys?n:t;++i<t;){var s=yt(i,a),r=e[s];e[s]=e[i],e[i]=r}return e.length=t,e}var an,sn,rn=(sn=(an=aa(function(e){var a=[];return 46===e.charCodeAt(0)&&a.push(""),e.replace(Nr,function(e,t,i,n){a.push(i?n.replace(Kr,"$1"):t||e)}),a},function(e){return 500===sn.size&&sn.clear(),e})).cache,an);function on(e){if("string"==typeof e||Ia(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function ln(e){if(null!=e){try{return l.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function hn(e){if(e instanceof _e)return e.clone();var t=new ge(e.__wrapped__,e.__chain__);return t.__actions__=Zt(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}var cn=xt(function(e,t){return ga(e)?ze(e,We(t,1,ga,!0)):[]}),un=xt(function(e,t){var i=bn(t);return ga(i)&&(i=Ys),ga(e)?ze(e,We(t,1,ga,!0),Ri(i,2)):[]}),dn=xt(function(e,t){var i=bn(t);return ga(i)&&(i=Ys),ga(e)?ze(e,We(t,1,ga,!0),Ys,i):[]});function pn(e,t,i){var n=null==e?0:e.length;if(!n)return-1;var a=null==i?0:Ba(i);return a<0&&(a=X(n+a,0)),Vo(e,Ri(t,3),a)}function fn(e,t,i){var n=null==e?0:e.length;if(!n)return-1;var a=n-1;return i!==Ys&&(a=Ba(i),a=i<0?X(n+a,0):q(a,n-1)),Vo(e,Ri(t,3),a,!0)}function mn(e){return null!=e&&e.length?We(e,1):[]}function vn(e){return e&&e.length?e[0]:Ys}var gn=xt(function(e){var t=ko(e,Vt);return t.length&&t[0]===e[0]?tt(t):[]}),_n=xt(function(e){var t=bn(e),i=ko(e,Vt);return t===bn(i)?t=Ys:i.pop(),i.length&&i[0]===e[0]?tt(i,Ri(t,2)):[]}),yn=xt(function(e){var t=bn(e),i=ko(e,Vt);return(t="function"==typeof t?t:Ys)&&i.pop(),i.length&&i[0]===e[0]?tt(i,Ys,t):[]});function bn(e){var t=null==e?0:e.length;return t?e[t-1]:Ys}var xn=xt(Mn);function Mn(e,t){return e&&e.length&&t&&t.length?gt(e,t):e}var Sn=wi(function(e,t){var i=null==e?0:e.length,n=Ie(e,t);return _t(e,ko(t,function(e){return Ui(e,i)?+e:e}).sort($t)),n});function wn(e){return null==e?e:Z.call(e)}var Cn=xt(function(e){return It(We(e,1,ga,!0))}),Pn=xt(function(e){var t=bn(e);return ga(t)&&(t=Ys),It(We(e,1,ga,!0),Ri(t,2))}),Tn=xt(function(e){var t=bn(e);return t="function"==typeof t?t:Ys,It(We(e,1,ga,!0),Ys,t)});function An(t){if(!t||!t.length)return[];var i=0;return t=Ro(t,function(e){if(ga(e))return i=X(e.length,i),!0}),qo(i,function(e){return ko(t,Ho(e))})}function En(e,t){if(!e||!e.length)return[];var i=An(e);return null==t?i:ko(i,function(e){return Po(t,Ys,e)})}var Rn=xt(function(e,t){return ga(e)?ze(e,t):[]}),Dn=xt(function(e){return zt(Ro(e,ga))}),In=xt(function(e){var t=bn(e);return ga(t)&&(t=Ys),zt(Ro(e,ga),Ri(t,2))}),kn=xt(function(e){var t=bn(e);return t="function"==typeof t?t:Ys,zt(Ro(e,ga),Ys,t)}),Ln=xt(An),On=xt(function(e){var t=e.length,i=1<t?e[t-1]:Ys;return En(e,i="function"==typeof i?(e.pop(),i):Ys)});function Fn(e){var t=fe(e);return t.__chain__=!0,t}function zn(e,t){return t(e)}var Bn=wi(function(t){var i=t.length,e=i?t[0]:0,n=this.__wrapped__,a=function(e){return Ie(e,t)};return!(1<i||this.__actions__.length)&&n instanceof _e&&Ui(e)?((n=n.slice(e,+e+(i?1:0))).__actions__.push({func:zn,args:[a],thisArg:Ys}),new ge(n,this.__chain__).thru(function(e){return i&&!e.length&&e.push(Ys),e})):this.thru(a)}),Vn=Jt(function(e,t,i){w.call(e,i)?++e[i]:De(e,i,1)}),Un=ri(pn),Nn=ri(fn);function Gn(e,t){return(fa(e)?Ao:Be)(e,Ri(t,3))}function Wn(e,t){return(fa(e)?function(e,t){for(var i=null==e?0:e.length;i--&&!1!==t(e[i],i,e););return e}:Ve)(e,Ri(t,3))}var Hn=Jt(function(e,t,i){w.call(e,i)?e[i].push(t):De(e,i,[t])}),jn=xt(function(e,t,i){var n=-1,a="function"==typeof t,s=va(e)?A(e.length):[];return Be(e,function(e){s[++n]=a?Po(t,e,i):it(e,t,i)}),s}),Xn=Jt(function(e,t,i){De(e,i,t)});function qn(e,t){return(fa(e)?ko:ct)(e,Ri(t,3))}var $n=Jt(function(e,t,i){e[i?0:1].push(t)},function(){return[[],[]]}),Yn=xt(function(e,t){if(null==e)return[];var i=t.length;return 1<i&&Ni(e,t[0],t[1])?t=[]:2<i&&Ni(t[0],t[1],t[2])&&(t=[t[0]]),mt(e,We(t,1),[])}),Kn=z||function(){return _o.Date.now()};function Zn(e,t,i){return t=i?Ys:t,t=e&&null==t?e.length:t,yi(e,128,Ys,Ys,Ys,Ys,t)}function Qn(e,t){var i;if("function"!=typeof t)throw new E(Ks);return e=Ba(e),function(){return 0<--e&&(i=t.apply(this,arguments)),e<=1&&(t=Ys),i}}var Jn=xt(function(e,t,i){var n=1;if(i.length){var a=rl(i,Ei(Jn));n|=32}return yi(e,n,t,i,a)}),ea=xt(function(e,t,i){var n=3;if(i.length){var a=rl(i,Ei(ea));n|=32}return yi(t,n,e,i,a)});function ta(n,a,e){var s,r,i,o,l,h,c=0,u=!1,d=!1,t=!0;if("function"!=typeof n)throw new E(Ks);function p(e){var t=s,i=r;return s=r=Ys,c=e,o=n.apply(i,t)}function f(e){var t=e-h;return h===Ys||a<=t||t<0||d&&i<=e-c}function m(){var e,t=Kn();if(f(t))return v(t);l=Qi(m,(e=a-(t-h),d?q(e,i-(t-c)):e))}function v(e){return l=Ys,t&&s?p(e):(s=r=Ys,o)}function g(){var e,t=Kn(),i=f(t);if(s=arguments,r=this,h=t,i){if(l===Ys)return c=e=h,l=Qi(m,a),u?p(e):o;if(d)return Ht(l),l=Qi(m,a),p(h)}return l===Ys&&(l=Qi(m,a)),o}return a=Ua(a)||0,wa(e)&&(u=!!e.leading,i=(d="maxWait"in e)?X(Ua(e.maxWait)||0,a):i,t="trailing"in e?!!e.trailing:t),g.cancel=function(){l!==Ys&&Ht(l),c=0,s=h=r=l=Ys},g.flush=function(){return l===Ys?o:v(Kn())},g}var ia=xt(function(e,t){return Fe(e,1,t)}),na=xt(function(e,t,i){return Fe(e,Ua(t)||0,i)});function aa(s,r){if("function"!=typeof s||null!=r&&"function"!=typeof r)throw new E(Ks);var e=function e(){var t=arguments,i=r?r.apply(this,t):t[0],n=e.cache;if(n.has(i))return n.get(i);var a=s.apply(this,t);return e.cache=n.set(i,a)||n,a};return e.cache=new(aa.Cache||xe),e}function sa(t){if("function"!=typeof t)throw new E(Ks);return function(){var e=arguments;switch(e.length){case 0:return!t.call(this);case 1:return!t.call(this,e[0]);case 2:return!t.call(this,e[0],e[1]);case 3:return!t.call(this,e[0],e[1],e[2])}return!t.apply(this,e)}}aa.Cache=xe;var ra=Gt(function(n,a){var s=(a=1==a.length&&fa(a[0])?ko(a[0],Yo(Ri())):ko(We(a,1),Yo(Ri()))).length;return xt(function(e){for(var t=-1,i=q(e.length,s);++t<i;)e[t]=a[t].call(this,e[t]);return Po(n,this,e)})}),oa=xt(function(e,t){var i=rl(t,Ei(oa));return yi(e,32,Ys,t,i)}),la=xt(function(e,t){var i=rl(t,Ei(la));return yi(e,64,Ys,t,i)}),ha=wi(function(e,t){return yi(e,256,Ys,Ys,Ys,t)});function ca(e,t){return e===t||e!=e&&t!=t}var ua=fi(Qe),da=fi(function(e,t){return t<=e}),pa=nt(function(){return arguments}())?nt:function(e){return Ca(e)&&w.call(e,"callee")&&!R.call(e,"callee")},fa=A.isArray,ma=bo?Yo(bo):function(e){return Ca(e)&&Ze(e)==_r};function va(e){return null!=e&&Sa(e.length)&&!xa(e)}function ga(e){return Ca(e)&&va(e)}var _a=G||Us,ya=xo?Yo(xo):function(e){return Ca(e)&&Ze(e)==sr};function ba(e){if(!Ca(e))return!1;var t=Ze(e);return t==rr||"[object DOMException]"==t||"string"==typeof e.message&&"string"==typeof e.name&&!Aa(e)}function xa(e){if(!wa(e))return!1;var t=Ze(e);return t==or||t==lr||"[object AsyncFunction]"==t||"[object Proxy]"==t}function Ma(e){return"number"==typeof e&&e==Ba(e)}function Sa(e){return"number"==typeof e&&-1<e&&e%1==0&&e<=Js}function wa(e){var t=void 0===e?"undefined":dx(e);return null!=e&&("object"==t||"function"==t)}function Ca(e){return null!=e&&"object"==(void 0===e?"undefined":dx(e))}var Pa=Mo?Yo(Mo):function(e){return Ca(e)&&Fi(e)==hr};function Ta(e){return"number"==typeof e||Ca(e)&&Ze(e)==cr}function Aa(e){if(!Ca(e)||Ze(e)!=ur)return!1;var t=P(e);if(null===t)return!0;var i=w.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&l.call(i)==f}var Ea=So?Yo(So):function(e){return Ca(e)&&Ze(e)==pr},Ra=wo?Yo(wo):function(e){return Ca(e)&&Fi(e)==fr};function Da(e){return"string"==typeof e||!fa(e)&&Ca(e)&&Ze(e)==mr}function Ia(e){return"symbol"==(void 0===e?"undefined":dx(e))||Ca(e)&&Ze(e)==vr}var ka=Co?Yo(Co):function(e){return Ca(e)&&Sa(e.length)&&!!fo[Ze(e)]},La=fi(ht),Oa=fi(function(e,t){return e<=t});function Fa(e){if(!e)return[];if(va(e))return Da(e)?hl(e):Zt(e);if(k&&e[k])return function(e){for(var t,i=[];!(t=e.next()).done;)i.push(t.value);return i}(e[k]());var t=Fi(e);return(t==hr?al:t==fr?ol:cs)(e)}function za(e){return e?(e=Ua(e))===1/0||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}function Ba(e){var t=za(e),i=t%1;return t==t?i?t-i:t:0}function Va(e){return e?ke(Ba(e),0,er):0}function Ua(e){if("number"==typeof e)return e;if(Ia(e))return NaN;if(wa(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=wa(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=$o(e);var i=eo.test(e);return i||io.test(e)?go(e.slice(2),i?2:8):Jr.test(e)?NaN:+e}function Na(e){return Qt(e,is(e))}function Ga(e){return null==e?"":Dt(e)}var Wa=ei(function(e,t){if(ji(t)||va(t))Qt(t,ts(t),e);else for(var i in t)w.call(t,i)&&Te(e,i,t[i])}),Ha=ei(function(e,t){Qt(t,is(t),e)}),ja=ei(function(e,t,i,n){Qt(t,is(t),e,n)}),Xa=ei(function(e,t,i,n){Qt(t,ts(t),e,n)}),qa=wi(Ie),$a=xt(function(e,t){e=S(e);var i=-1,n=t.length,a=2<n?t[2]:Ys;for(a&&Ni(t[0],t[1],a)&&(n=1);++i<n;)for(var s=t[i],r=is(s),o=-1,l=r.length;++o<l;){var h=r[o],c=e[h];(c===Ys||ca(c,u[h])&&!w.call(e,h))&&(e[h]=s[h])}return e}),Ya=xt(function(e){return e.push(Ys,xi),Po(as,Ys,e)});function Ka(e,t,i){var n=null==e?Ys:Ye(e,t);return n===Ys?i:n}function Za(e,t){return null!=e&&zi(e,t,et)}var Qa=hi(function(e,t,i){null!=t&&"function"!=typeof t.toString&&(t=p.call(t)),e[t]=i},ws(Ts)),Ja=hi(function(e,t,i){null!=t&&"function"!=typeof t.toString&&(t=p.call(t)),w.call(e,t)?e[t].push(i):e[t]=[i]},Ri),es=xt(it);function ts(e){return va(e)?we(e):lt(e)}function is(e){return va(e)?we(e,!0):function(e){if(!wa(e))return function(e){var t=[];if(null!=e)for(var i in S(e))t.push(i);return t}(e);var t=ji(e),i=[];for(var n in e)("constructor"!=n||!t&&w.call(e,n))&&i.push(n);return i}(e)}var ns=ei(function(e,t,i){pt(e,t,i)}),as=ei(function(e,t,i,n){pt(e,t,i,n)}),ss=wi(function(t,e){var i={};if(null==t)return i;var n=!1;e=ko(e,function(e){return e=Nt(e,t),n||(n=1<e.length),e}),Qt(t,Pi(t),i),n&&(i=Le(i,7,Mi));for(var a=e.length;a--;)kt(i,e[a]);return i}),rs=wi(function(e,t){return null==e?{}:vt(i=e,t,function(e,t){return Za(i,t)});var i});function os(e,i){if(null==e)return{};var t=ko(Pi(e),function(e){return[e]});return i=Ri(i),vt(e,t,function(e,t){return i(e,t[0])})}var ls=_i(ts),hs=_i(is);function cs(e){return null==e?[]:Ko(e,ts(e))}var us=ai(function(e,t,i){return t=t.toLowerCase(),e+(i?ds(t):t)});function ds(e){return bs(Ga(e).toLowerCase())}function ps(e){return(e=Ga(e))&&e.replace(ao,el).replace(lo,"")}var fs=ai(function(e,t,i){return e+(i?"-":"")+t.toLowerCase()}),ms=ai(function(e,t,i){return e+(i?" ":"")+t.toLowerCase()}),vs=ni("toLowerCase"),gs=ai(function(e,t,i){return e+(i?"_":"")+t.toLowerCase()}),_s=ai(function(e,t,i){return e+(i?" ":"")+bs(t)}),ys=ai(function(e,t,i){return e+(i?" ":"")+t.toUpperCase()}),bs=ni("toUpperCase");function xs(e,t,i){return e=Ga(e),(t=i?Ys:t)===Ys?(n=e,co.test(n)?e.match(ho)||[]:e.match($r)||[]):e.match(t)||[];var n}var Ms=xt(function(e,t){try{return Po(e,Ys,t)}catch(e){return ba(e)?e:new v(e)}}),Ss=wi(function(t,e){return Ao(e,function(e){e=on(e),De(t,e,Jn(t[e],t))}),t});function ws(e){return function(){return e}}var Cs=oi(),Ps=oi(!0);function Ts(e){return e}function As(e){return ot("function"==typeof e?e:Le(e,1))}var Es=xt(function(t,i){return function(e){return it(e,t,i)}}),Rs=xt(function(t,i){return function(e){return it(t,e,i)}});function Ds(n,t,e){var i=ts(t),a=$e(t,i);null!=e||wa(t)&&(a.length||!i.length)||(e=t,t=n,n=this,a=$e(t,ts(t)));var s=!(wa(e)&&"chain"in e&&!e.chain),r=xa(n);return Ao(a,function(e){var i=t[e];n[e]=i,r&&(n.prototype[e]=function(){var e=this.__chain__;if(s||e){var t=n(this.__wrapped__);return(t.__actions__=Zt(this.__actions__)).push({func:i,args:arguments,thisArg:n}),t.__chain__=e,t}return i.apply(n,Lo([this.value()],arguments))})}),n}function Is(){}var ks=ui(ko),Ls=ui(Eo),Os=ui(zo);function Fs(e){return Gi(e)?Ho(on(e)):(t=e,function(e){return Ye(e,t)});var t}var zs=pi(),Bs=pi(!0);function Vs(){return[]}function Us(){return!1}var Ns,Gs=ci(function(e,t){return e+t},0),Ws=vi("ceil"),Hs=ci(function(e,t){return e/t},1),js=vi("floor"),Xs=ci(function(e,t){return e*t},1),qs=vi("round"),$s=ci(function(e,t){return e-t},0);return fe.after=function(e,t){if("function"!=typeof t)throw new E(Ks);return e=Ba(e),function(){if(--e<1)return t.apply(this,arguments)}},fe.ary=Zn,fe.assign=Wa,fe.assignIn=Ha,fe.assignInWith=ja,fe.assignWith=Xa,fe.at=qa,fe.before=Qn,fe.bind=Jn,fe.bindAll=Ss,fe.bindKey=ea,fe.castArray=function(){if(!arguments.length)return[];var e=arguments[0];return fa(e)?e:[e]},fe.chain=Fn,fe.chunk=function(e,t,i){t=(i?Ni(e,t,i):t===Ys)?1:X(Ba(t),0);var n=null==e?0:e.length;if(!n||t<1)return[];for(var a=0,s=0,r=A(V(n/t));a<n;)r[s++]=Ct(e,a,a+=t);return r},fe.compact=function(e){for(var t=-1,i=null==e?0:e.length,n=0,a=[];++t<i;){var s=e[t];s&&(a[n++]=s)}return a},fe.concat=function(){var e=arguments.length;if(!e)return[];for(var t=A(e-1),i=arguments[0],n=e;n--;)t[n-1]=arguments[n];return Lo(fa(i)?Zt(i):[i],We(t,1))},fe.cond=function(n){var a=null==n?0:n.length,t=Ri();return n=a?ko(n,function(e){if("function"!=typeof e[1])throw new E(Ks);return[t(e[0]),e[1]]}):[],xt(function(e){for(var t=-1;++t<a;){var i=n[t];if(Po(i[0],this,e))return Po(i[1],this,e)}})},fe.conforms=function(e){return t=Le(e,1),i=ts(t),function(e){return Oe(e,t,i)};var t,i},fe.constant=ws,fe.countBy=Vn,fe.create=function(e,t){var i=me(e);return null==t?i:Re(i,t)},fe.curry=function e(t,i,n){var a=yi(t,8,Ys,Ys,Ys,Ys,Ys,i=n?Ys:i);return a.placeholder=e.placeholder,a},fe.curryRight=function e(t,i,n){var a=yi(t,16,Ys,Ys,Ys,Ys,Ys,i=n?Ys:i);return a.placeholder=e.placeholder,a},fe.debounce=ta,fe.defaults=$a,fe.defaultsDeep=Ya,fe.defer=ia,fe.delay=na,fe.difference=cn,fe.differenceBy=un,fe.differenceWith=dn,fe.drop=function(e,t,i){var n=null==e?0:e.length;return n?Ct(e,(t=i||t===Ys?1:Ba(t))<0?0:t,n):[]},fe.dropRight=function(e,t,i){var n=null==e?0:e.length;return n?Ct(e,0,(t=n-(t=i||t===Ys?1:Ba(t)))<0?0:t):[]},fe.dropRightWhile=function(e,t){return e&&e.length?Ot(e,Ri(t,3),!0,!0):[]},fe.dropWhile=function(e,t){return e&&e.length?Ot(e,Ri(t,3),!0):[]},fe.fill=function(e,t,i,n){var a=null==e?0:e.length;return a?(i&&"number"!=typeof i&&Ni(e,t,i)&&(i=0,n=a),function(e,t,i,n){var a=e.length;for((i=Ba(i))<0&&(i=a<-i?0:a+i),(n=n===Ys||a<n?a:Ba(n))<0&&(n+=a),n=n<i?0:Va(n);i<n;)e[i++]=t;return e}(e,t,i,n)):[]},fe.filter=function(e,t){return(fa(e)?Ro:Ge)(e,Ri(t,3))},fe.flatMap=function(e,t){return We(qn(e,t),1)},fe.flatMapDeep=function(e,t){return We(qn(e,t),1/0)},fe.flatMapDepth=function(e,t,i){return i=i===Ys?1:Ba(i),We(qn(e,t),i)},fe.flatten=mn,fe.flattenDeep=function(e){return null!=e&&e.length?We(e,1/0):[]},fe.flattenDepth=function(e,t){return null!=e&&e.length?We(e,t=t===Ys?1:Ba(t)):[]},fe.flip=function(e){return yi(e,512)},fe.flow=Cs,fe.flowRight=Ps,fe.fromPairs=function(e){for(var t=-1,i=null==e?0:e.length,n={};++t<i;){var a=e[t];n[a[0]]=a[1]}return n},fe.functions=function(e){return null==e?[]:$e(e,ts(e))},fe.functionsIn=function(e){return null==e?[]:$e(e,is(e))},fe.groupBy=Hn,fe.initial=function(e){return null!=e&&e.length?Ct(e,0,-1):[]},fe.intersection=gn,fe.intersectionBy=_n,fe.intersectionWith=yn,fe.invert=Qa,fe.invertBy=Ja,fe.invokeMap=jn,fe.iteratee=As,fe.keyBy=Xn,fe.keys=ts,fe.keysIn=is,fe.map=qn,fe.mapKeys=function(e,n){var a={};return n=Ri(n,3),Xe(e,function(e,t,i){De(a,n(e,t,i),e)}),a},fe.mapValues=function(e,n){var a={};return n=Ri(n,3),Xe(e,function(e,t,i){De(a,t,n(e,t,i))}),a},fe.matches=function(e){return ut(Le(e,1))},fe.matchesProperty=function(e,t){return dt(e,Le(t,1))},fe.memoize=aa,fe.merge=ns,fe.mergeWith=as,fe.method=Es,fe.methodOf=Rs,fe.mixin=Ds,fe.negate=sa,fe.nthArg=function(t){return t=Ba(t),xt(function(e){return ft(e,t)})},fe.omit=ss,fe.omitBy=function(e,t){return os(e,sa(Ri(t)))},fe.once=function(e){return Qn(2,e)},fe.orderBy=function(e,t,i,n){return null==e?[]:(fa(t)||(t=null==t?[]:[t]),fa(i=n?Ys:i)||(i=null==i?[]:[i]),mt(e,t,i))},fe.over=ks,fe.overArgs=ra,fe.overEvery=Ls,fe.overSome=Os,fe.partial=oa,fe.partialRight=la,fe.partition=$n,fe.pick=rs,fe.pickBy=os,fe.property=Fs,fe.propertyOf=function(t){return function(e){return null==t?Ys:Ye(t,e)}},fe.pull=xn,fe.pullAll=Mn,fe.pullAllBy=function(e,t,i){return e&&e.length&&t&&t.length?gt(e,t,Ri(i,2)):e},fe.pullAllWith=function(e,t,i){return e&&e.length&&t&&t.length?gt(e,t,Ys,i):e},fe.pullAt=Sn,fe.range=zs,fe.rangeRight=Bs,fe.rearg=ha,fe.reject=function(e,t){return(fa(e)?Ro:Ge)(e,sa(Ri(t,3)))},fe.remove=function(e,t){var i=[];if(!e||!e.length)return i;var n=-1,a=[],s=e.length;for(t=Ri(t,3);++n<s;){var r=e[n];t(r,n,e)&&(i.push(r),a.push(n))}return _t(e,a),i},fe.rest=function(e,t){if("function"!=typeof e)throw new E(Ks);return xt(e,t=t===Ys?t:Ba(t))},fe.reverse=wn,fe.sampleSize=function(e,t,i){return t=(i?Ni(e,t,i):t===Ys)?1:Ba(t),(fa(e)?function(e,t){return nn(Zt(e),ke(t,0,e.length))}:function(e,t){var i=cs(e);return nn(i,ke(t,0,i.length))})(e,t)},fe.set=function(e,t,i){return null==e?e:Mt(e,t,i)},fe.setWith=function(e,t,i,n){return n="function"==typeof n?n:Ys,null==e?e:Mt(e,t,i,n)},fe.shuffle=function(e){return(fa(e)?function(e){return nn(Zt(e))}:function(e){return nn(cs(e))})(e)},fe.slice=function(e,t,i){var n=null==e?0:e.length;return n?(i&&"number"!=typeof i&&Ni(e,t,i)?(t=0,i=n):(t=null==t?0:Ba(t),i=i===Ys?n:Ba(i)),Ct(e,t,i)):[]},fe.sortBy=Yn,fe.sortedUniq=function(e){return e&&e.length?Et(e):[]},fe.sortedUniqBy=function(e,t){return e&&e.length?Et(e,Ri(t,2)):[]},fe.split=function(e,t,i){return i&&"number"!=typeof i&&Ni(e,t,i)&&(t=i=Ys),(i=i===Ys?er:i>>>0)?(e=Ga(e))&&("string"==typeof t||null!=t&&!Ea(t))&&!(t=Dt(t))&&nl(e)?Wt(hl(e),0,i):e.split(t,i):[]},fe.spread=function(n,a){if("function"!=typeof n)throw new E(Ks);return a=null==a?0:X(Ba(a),0),xt(function(e){var t=e[a],i=Wt(e,0,a);return t&&Lo(i,t),Po(n,this,i)})},fe.tail=function(e){var t=null==e?0:e.length;return t?Ct(e,1,t):[]},fe.take=function(e,t,i){return e&&e.length?Ct(e,0,(t=i||t===Ys?1:Ba(t))<0?0:t):[]},fe.takeRight=function(e,t,i){var n=null==e?0:e.length;return n?Ct(e,(t=n-(t=i||t===Ys?1:Ba(t)))<0?0:t,n):[]},fe.takeRightWhile=function(e,t){return e&&e.length?Ot(e,Ri(t,3),!1,!0):[]},fe.takeWhile=function(e,t){return e&&e.length?Ot(e,Ri(t,3)):[]},fe.tap=function(e,t){return t(e),e},fe.throttle=function(e,t,i){var n=!0,a=!0;if("function"!=typeof e)throw new E(Ks);return wa(i)&&(n="leading"in i?!!i.leading:n,a="trailing"in i?!!i.trailing:a),ta(e,t,{leading:n,maxWait:t,trailing:a})},fe.thru=zn,fe.toArray=Fa,fe.toPairs=ls,fe.toPairsIn=hs,fe.toPath=function(e){return fa(e)?ko(e,on):Ia(e)?[e]:Zt(rn(Ga(e)))},fe.toPlainObject=Na,fe.transform=function(e,n,a){var t=fa(e),i=t||_a(e)||ka(e);if(n=Ri(n,4),null==a){var s=e&&e.constructor;a=i?t?new s:[]:wa(e)&&xa(s)?me(P(e)):{}}return(i?Ao:Xe)(e,function(e,t,i){return n(a,e,t,i)}),a},fe.unary=function(e){return Zn(e,1)},fe.union=Cn,fe.unionBy=Pn,fe.unionWith=Tn,fe.uniq=function(e){return e&&e.length?It(e):[]},fe.uniqBy=function(e,t){return e&&e.length?It(e,Ri(t,2)):[]},fe.uniqWith=function(e,t){return t="function"==typeof t?t:Ys,e&&e.length?It(e,Ys,t):[]},fe.unset=function(e,t){return null==e||kt(e,t)},fe.unzip=An,fe.unzipWith=En,fe.update=function(e,t,i){return null==e?e:Lt(e,t,Ut(i))},fe.updateWith=function(e,t,i,n){return n="function"==typeof n?n:Ys,null==e?e:Lt(e,t,Ut(i),n)},fe.values=cs,fe.valuesIn=function(e){return null==e?[]:Ko(e,is(e))},fe.without=Rn,fe.words=xs,fe.wrap=function(e,t){return oa(Ut(t),e)},fe.xor=Dn,fe.xorBy=In,fe.xorWith=kn,fe.zip=Ln,fe.zipObject=function(e,t){return Bt(e||[],t||[],Te)},fe.zipObjectDeep=function(e,t){return Bt(e||[],t||[],Mt)},fe.zipWith=On,fe.entries=ls,fe.entriesIn=hs,fe.extend=Ha,fe.extendWith=ja,Ds(fe,fe),fe.add=Gs,fe.attempt=Ms,fe.camelCase=us,fe.capitalize=ds,fe.ceil=Ws,fe.clamp=function(e,t,i){return i===Ys&&(i=t,t=Ys),i!==Ys&&(i=(i=Ua(i))==i?i:0),t!==Ys&&(t=(t=Ua(t))==t?t:0),ke(Ua(e),t,i)},fe.clone=function(e){return Le(e,4)},fe.cloneDeep=function(e){return Le(e,5)},fe.cloneDeepWith=function(e,t){return Le(e,5,t="function"==typeof t?t:Ys)},fe.cloneWith=function(e,t){return Le(e,4,t="function"==typeof t?t:Ys)},fe.conformsTo=function(e,t){return null==t||Oe(e,t,ts(t))},fe.deburr=ps,fe.defaultTo=function(e,t){return null==e||e!=e?t:e},fe.divide=Hs,fe.endsWith=function(e,t,i){e=Ga(e),t=Dt(t);var n=e.length,a=i=i===Ys?n:ke(Ba(i),0,n);return 0<=(i-=t.length)&&e.slice(i,a)==t},fe.eq=ca,fe.escape=function(e){return(e=Ga(e))&&Or.test(e)?e.replace(kr,tl):e},fe.escapeRegExp=function(e){return(e=Ga(e))&&Wr.test(e)?e.replace(Gr,"\\$&"):e},fe.every=function(e,t,i){var n=fa(e)?Eo:Ue;return i&&Ni(e,t,i)&&(t=Ys),n(e,Ri(t,3))},fe.find=Un,fe.findIndex=pn,fe.findKey=function(e,t){return Bo(e,Ri(t,3),Xe)},fe.findLast=Nn,fe.findLastIndex=fn,fe.findLastKey=function(e,t){return Bo(e,Ri(t,3),qe)},fe.floor=js,fe.forEach=Gn,fe.forEachRight=Wn,fe.forIn=function(e,t){return null==e?e:He(e,Ri(t,3),is)},fe.forInRight=function(e,t){return null==e?e:je(e,Ri(t,3),is)},fe.forOwn=function(e,t){return e&&Xe(e,Ri(t,3))},fe.forOwnRight=function(e,t){return e&&qe(e,Ri(t,3))},fe.get=Ka,fe.gt=ua,fe.gte=da,fe.has=function(e,t){return null!=e&&zi(e,t,Je)},fe.hasIn=Za,fe.head=vn,fe.identity=Ts,fe.includes=function(e,t,i,n){e=va(e)?e:cs(e),i=i&&!n?Ba(i):0;var a=e.length;return i<0&&(i=X(a+i,0)),Da(e)?i<=a&&-1<e.indexOf(t,i):!!a&&-1<Uo(e,t,i)},fe.indexOf=function(e,t,i){var n=null==e?0:e.length;if(!n)return-1;var a=null==i?0:Ba(i);return a<0&&(a=X(n+a,0)),Uo(e,t,a)},fe.inRange=function(e,t,i){return t=za(t),i===Ys?(i=t,t=0):i=za(i),(n=e=Ua(e))>=q(a=t,s=i)&&n<X(a,s);var n,a,s},fe.invoke=es,fe.isArguments=pa,fe.isArray=fa,fe.isArrayBuffer=ma,fe.isArrayLike=va,fe.isArrayLikeObject=ga,fe.isBoolean=function(e){return!0===e||!1===e||Ca(e)&&Ze(e)==ar},fe.isBuffer=_a,fe.isDate=ya,fe.isElement=function(e){return Ca(e)&&1===e.nodeType&&!Aa(e)},fe.isEmpty=function(e){if(null==e)return!0;if(va(e)&&(fa(e)||"string"==typeof e||"function"==typeof e.splice||_a(e)||ka(e)||pa(e)))return!e.length;var t=Fi(e);if(t==hr||t==fr)return!e.size;if(ji(e))return!lt(e).length;for(var i in e)if(w.call(e,i))return!1;return!0},fe.isEqual=function(e,t){return at(e,t)},fe.isEqualWith=function(e,t,i){var n=(i="function"==typeof i?i:Ys)?i(e,t):Ys;return n===Ys?at(e,t,Ys,i):!!n},fe.isError=ba,fe.isFinite=function(e){return"number"==typeof e&&W(e)},fe.isFunction=xa,fe.isInteger=Ma,fe.isLength=Sa,fe.isMap=Pa,fe.isMatch=function(e,t){return e===t||st(e,t,Ii(t))},fe.isMatchWith=function(e,t,i){return i="function"==typeof i?i:Ys,st(e,t,Ii(t),i)},fe.isNaN=function(e){return Ta(e)&&e!=+e},fe.isNative=function(e){if(Hi(e))throw new v("Unsupported core-js use. Try https://npms.io/search?q=ponyfill.");return rt(e)},fe.isNil=function(e){return null==e},fe.isNull=function(e){return null===e},fe.isNumber=Ta,fe.isObject=wa,fe.isObjectLike=Ca,fe.isPlainObject=Aa,fe.isRegExp=Ea,fe.isSafeInteger=function(e){return Ma(e)&&-9007199254740991<=e&&e<=Js},fe.isSet=Ra,fe.isString=Da,fe.isSymbol=Ia,fe.isTypedArray=ka,fe.isUndefined=function(e){return e===Ys},fe.isWeakMap=function(e){return Ca(e)&&Fi(e)==gr},fe.isWeakSet=function(e){return Ca(e)&&"[object WeakSet]"==Ze(e)},fe.join=function(e,t){return null==e?"":H.call(e,t)},fe.kebabCase=fs,fe.last=bn,fe.lastIndexOf=function(e,t,i){var n=null==e?0:e.length;if(!n)return-1;var a=n;return i!==Ys&&(a=(a=Ba(i))<0?X(n+a,0):q(a,n-1)),t==t?function(e,t,i){for(var n=a+1;n--;)if(e[n]===t)return n;return n}(e,t):Vo(e,Go,a,!0)},fe.lowerCase=ms,fe.lowerFirst=vs,fe.lt=La,fe.lte=Oa,fe.max=function(e){return e&&e.length?Ne(e,Ts,Qe):Ys},fe.maxBy=function(e,t){return e&&e.length?Ne(e,Ri(t,2),Qe):Ys},fe.mean=function(e){return Wo(e,Ts)},fe.meanBy=function(e,t){return Wo(e,Ri(t,2))},fe.min=function(e){return e&&e.length?Ne(e,Ts,ht):Ys},fe.minBy=function(e,t){return e&&e.length?Ne(e,Ri(t,2),ht):Ys},fe.stubArray=Vs,fe.stubFalse=Us,fe.stubObject=function(){return{}},fe.stubString=function(){return""},fe.stubTrue=function(){return!0},fe.multiply=Xs,fe.nth=function(e,t){return e&&e.length?ft(e,Ba(t)):Ys},fe.noConflict=function(){return _o._===this&&(_o._=m),this},fe.noop=Is,fe.now=Kn,fe.pad=function(e,t,i){e=Ga(e);var n=(t=Ba(t))?ll(e):0;if(!t||t<=n)return e;var a=(t-n)/2;return di(U(a),i)+e+di(V(a),i)},fe.padEnd=function(e,t,i){e=Ga(e);var n=(t=Ba(t))?ll(e):0;return t&&n<t?e+di(t-n,i):e},fe.padStart=function(e,t,i){e=Ga(e);var n=(t=Ba(t))?ll(e):0;return t&&n<t?di(t-n,i)+e:e},fe.parseInt=function(e,t,i){return i||null==t?t=0:t&&(t=+t),Y(Ga(e).replace(Hr,""),t||0)},fe.random=function(e,t,i){if(i&&"boolean"!=typeof i&&Ni(e,t,i)&&(t=i=Ys),i===Ys&&("boolean"==typeof t?(i=t,t=Ys):"boolean"==typeof e&&(i=e,e=Ys)),e===Ys&&t===Ys?(e=0,t=1):(e=za(e),t===Ys?(t=e,e=0):t=za(t)),t<e){var n=e;e=t,t=n}if(i||e%1||t%1){var a=K();return q(e+a*(t-e+vo("1e-"+((a+"").length-1))),t)}return yt(e,t)},fe.reduce=function(e,t,i){var n=fa(e)?Oo:jo,a=arguments.length<3;return n(e,Ri(t,4),i,a,Be)},fe.reduceRight=function(e,t,i){var n=fa(e)?Fo:jo,a=arguments.length<3;return n(e,Ri(t,4),i,a,Ve)},fe.repeat=function(e,t,i){return t=(i?Ni(e,t,i):t===Ys)?1:Ba(t),bt(Ga(e),t)},fe.replace=function(){var e=arguments,t=Ga(e[0]);return e.length<3?t:t.replace(e[1],e[2])},fe.result=function(e,t,i){var n=-1,a=(t=Nt(t,e)).length;for(a||(a=1,e=Ys);++n<a;){var s=null==e?Ys:e[on(t[n])];s===Ys&&(n=a,s=i),e=xa(s)?s.call(e):s}return e},fe.round=qs,fe.runInContext=e,fe.sample=function(e){return(fa(e)?Ce:function(e){return Ce(cs(e))})(e)},fe.size=function(e){if(null==e)return 0;if(va(e))return Da(e)?ll(e):e.length;var t=Fi(e);return t==hr||t==fr?e.size:lt(e).length},fe.snakeCase=gs,fe.some=function(e,t,i){var n=fa(e)?zo:Pt;return i&&Ni(e,t,i)&&(t=Ys),n(e,Ri(t,3))},fe.sortedIndex=function(e,t){return Tt(e,t)},fe.sortedIndexBy=function(e,t,i){return At(e,t,Ri(i,2))},fe.sortedIndexOf=function(e,t){var i=null==e?0:e.length;if(i){var n=Tt(e,t);if(n<i&&ca(e[n],t))return n}return-1},fe.sortedLastIndex=function(e,t){return Tt(e,t,!0)},fe.sortedLastIndexBy=function(e,t,i){return At(e,t,Ri(i,2),!0)},fe.sortedLastIndexOf=function(e,t){if(null!=e&&e.length){var i=Tt(e,t,!0)-1;if(ca(e[i],t))return i}return-1},fe.startCase=_s,fe.startsWith=function(e,t,i){return e=Ga(e),i=null==i?0:ke(Ba(i),0,e.length),t=Dt(t),e.slice(i,i+t.length)==t},fe.subtract=$s,fe.sum=function(e){return e&&e.length?Xo(e,Ts):0},fe.sumBy=function(e,t){return e&&e.length?Xo(e,Ri(t,2)):0},fe.template=function(r,e,t){var i=fe.templateSettings;t&&Ni(r,e,t)&&(e=Ys),r=Ga(r),e=ja({},e,i,bi);var o,l,n=ja({},e.imports,i.imports,bi),a=ts(n),s=Ko(n,a),h=0,c=e.interpolate||so,u="__p += '",d=_((e.escape||so).source+"|"+c.source+"|"+(c===Br?Zr:so).source+"|"+(e.evaluate||so).source+"|$","g"),p="//# sourceURL="+(w.call(e,"sourceURL")?(e.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++po+"]")+"\n";r.replace(d,function(e,t,i,n,a,s){return i||(i=n),u+=r.slice(h,s).replace(ro,il),t&&(o=!0,u+="' +\n__e("+t+") +\n'"),a&&(l=!0,u+="';\n"+a+";\n__p += '"),i&&(u+="' +\n((__t = ("+i+")) == null ? '' : __t) +\n'"),h=s+e.length,e}),u+="';\n";var f=w.call(e,"variable")&&e.variable;if(f){if(Yr.test(f))throw new v("Invalid `variable` option passed into `_.template`")}else u="with (obj) {\n"+u+"\n}\n";u=(l?u.replace(Er,""):u).replace(Rr,"$1").replace(Dr,"$1;"),u="function("+(f||"obj")+") {\n"+(f?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(o?", __e = _.escape":"")+(l?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+u+"return __p\n}";var m=Ms(function(){return g(a,p+"return "+u).apply(Ys,s)});if(m.source=u,ba(m))throw m;return m},fe.times=function(e,t){if((e=Ba(e))<1||Js<e)return[];var i=er,n=q(e,er);t=Ri(t),e-=er;for(var a=qo(n,t);++i<e;)t(i);return a},fe.toFinite=za,fe.toInteger=Ba,fe.toLength=Va,fe.toLower=function(e){return Ga(e).toLowerCase()},fe.toNumber=Ua,fe.toSafeInteger=function(e){return e?ke(Ba(e),-9007199254740991,Js):0===e?e:0},fe.toString=Ga,fe.toUpper=function(e){return Ga(e).toUpperCase()},fe.trim=function(e,t,i){if((e=Ga(e))&&(i||t===Ys))return $o(e);if(!e||!(t=Dt(t)))return e;var n=hl(e),a=hl(t);return Wt(n,Qo(n,a),Jo(n,a)+1).join("")},fe.trimEnd=function(e,t,i){if((e=Ga(e))&&(i||t===Ys))return e.slice(0,cl(e)+1);if(!e||!(t=Dt(t)))return e;var n=hl(e);return Wt(n,0,Jo(n,hl(t))+1).join("")},fe.trimStart=function(e,t,i){if((e=Ga(e))&&(i||t===Ys))return e.replace(Hr,"");if(!e||!(t=Dt(t)))return e;var n=hl(e);return Wt(n,Qo(n,hl(t))).join("")},fe.truncate=function(e,t){var i=30,n="...";if(wa(t)){var a="separator"in t?t.separator:a;i="length"in t?Ba(t.length):i,n="omission"in t?Dt(t.omission):n}var s=(e=Ga(e)).length;if(nl(e)){var r=hl(e);s=r.length}if(s<=i)return e;var o=i-ll(n);if(o<1)return n;var l=r?Wt(r,0,o).join(""):e.slice(0,o);if(a===Ys)return l+n;if(r&&(o+=l.length-o),Ea(a)){if(e.slice(o).search(a)){var h,c=l;for(a.global||(a=_(a.source,Ga(Qr.exec(a))+"g")),a.lastIndex=0;h=a.exec(c);)var u=h.index;l=l.slice(0,u===Ys?o:u)}}else if(e.indexOf(Dt(a),o)!=o){var d=l.lastIndexOf(a);-1<d&&(l=l.slice(0,d))}return l+n},fe.unescape=function(e){return(e=Ga(e))&&Lr.test(e)?e.replace(Ir,ul):e},fe.uniqueId=function(e){var t=++h;return Ga(e)+t},fe.upperCase=ys,fe.upperFirst=bs,fe.each=Gn,fe.eachRight=Wn,fe.first=vn,Ds(fe,(Ns={},Xe(fe,function(e,t){w.call(fe.prototype,t)||(Ns[t]=e)}),Ns),{chain:!1}),fe.VERSION="4.17.21",Ao(["bind","bindKey","curry","curryRight","partial","partialRight"],function(e){fe[e].placeholder=fe}),Ao(["drop","take"],function(i,n){_e.prototype[i]=function(e){e=e===Ys?1:X(Ba(e),0);var t=this.__filtered__&&!n?new _e(this):this.clone();return t.__filtered__?t.__takeCount__=q(e,t.__takeCount__):t.__views__.push({size:q(e,er),type:i+(t.__dir__<0?"Right":"")}),t},_e.prototype[i+"Right"]=function(e){return this.reverse()[i](e).reverse()}}),Ao(["filter","map","takeWhile"],function(e,t){var i=t+1,n=1==i||3==i;_e.prototype[e]=function(e){var t=this.clone();return t.__iteratees__.push({iteratee:Ri(e,3),type:i}),t.__filtered__=t.__filtered__||n,t}}),Ao(["head","last"],function(e,t){var i="take"+(t?"Right":"");_e.prototype[e]=function(){return this[i](1).value()[0]}}),Ao(["initial","tail"],function(e,t){var i="drop"+(t?"":"Right");_e.prototype[e]=function(){return this.__filtered__?new _e(this):this[i](1)}}),_e.prototype.compact=function(){return this.filter(Ts)},_e.prototype.find=function(e){return this.filter(e).head()},_e.prototype.findLast=function(e){return this.reverse().find(e)},_e.prototype.invokeMap=xt(function(t,i){return"function"==typeof t?new _e(this):this.map(function(e){return it(e,t,i)})}),_e.prototype.reject=function(e){return this.filter(sa(Ri(e)))},_e.prototype.slice=function(e,t){e=Ba(e);var i=this;return i.__filtered__&&(0<e||t<0)?new _e(i):(e<0?i=i.takeRight(-e):e&&(i=i.drop(e)),t!==Ys&&(i=(t=Ba(t))<0?i.dropRight(-t):i.take(t-e)),i)},_e.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},_e.prototype.toArray=function(){return this.take(er)},Xe(_e.prototype,function(u,e){var d=/^(?:filter|find|map|reject)|While$/.test(e),p=/^(?:head|last)$/.test(e),f=fe[p?"take"+("last"==e?"Right":""):e],m=p||/^find/.test(e);f&&(fe.prototype[e]=function(){var e=this.__wrapped__,i=p?[1]:arguments,t=e instanceof _e,n=i[0],a=t||fa(e),s=function(e){var t=f.apply(fe,Lo([e],i));return p&&r?t[0]:t};a&&d&&"function"==typeof n&&1!=n.length&&(t=a=!1);var r=this.__chain__,o=!!this.__actions__.length,l=m&&!r,h=t&&!o;if(!m&&a){e=h?e:new _e(this);var c=u.apply(e,i);return c.__actions__.push({func:zn,args:[s],thisArg:Ys}),new ge(c,r)}return l&&h?u.apply(this,i):(c=this.thru(s),l?p?c.value()[0]:c.value():c)})}),Ao(["pop","push","shift","sort","splice","unshift"],function(e){var i=s[e],n=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",a=/^(?:pop|shift)$/.test(e);fe.prototype[e]=function(){var t=arguments;if(a&&!this.__chain__){var e=this.value();return i.apply(fa(e)?e:[],t)}return this[n](function(e){return i.apply(fa(e)?e:[],t)})}}),Xe(_e.prototype,function(e,t){var i=fe[t];if(i){var n=i.name+"";w.call(se,n)||(se[n]=[]),se[n].push({name:t,func:i})}}),se[li(Ys,2).name]=[{name:"wrapper",func:Ys}],_e.prototype.clone=function(){var e=new _e(this.__wrapped__);return e.__actions__=Zt(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=Zt(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=Zt(this.__views__),e},_e.prototype.reverse=function(){if(this.__filtered__){var e=new _e(this);e.__dir__=-1,e.__filtered__=!0}else(e=this.clone()).__dir__*=-1;return e},_e.prototype.value=function(){var e=this.__wrapped__.value(),t=this.__dir__,i=fa(e),n=t<0,a=i?e.length:0,s=function(e,t,i){for(var n=-1,a=i.length;++n<a;){var s=i[n],r=s.size;switch(s.type){case"drop":e+=r;break;case"dropRight":t-=r;break;case"take":t=q(t,e+r);break;case"takeRight":e=X(e,t-r)}}return{start:e,end:t}}(0,a,this.__views__),r=s.start,o=s.end,l=o-r,h=n?o:r-1,c=this.__iteratees__,u=c.length,d=0,p=q(l,this.__takeCount__);if(!i||!n&&a==l&&p==l)return Ft(e,this.__actions__);var f=[];e:for(;l--&&d<p;){for(var m=-1,v=e[h+=t];++m<u;){var g=c[m],_=g.iteratee,y=g.type,b=_(v);if(2==y)v=b;else if(!b){if(1==y)continue e;break e}}f[d++]=v}return f},fe.prototype.at=Bn,fe.prototype.chain=function(){return Fn(this)},fe.prototype.commit=function(){return new ge(this.value(),this.__chain__)},fe.prototype.next=function(){this.__values__===Ys&&(this.__values__=Fa(this.value()));var e=this.__index__>=this.__values__.length;return{done:e,value:e?Ys:this.__values__[this.__index__++]}},fe.prototype.plant=function(e){for(var t,i=this;i instanceof ve;){var n=hn(i);n.__index__=0,n.__values__=Ys,t?a.__wrapped__=n:t=n;var a=n;i=i.__wrapped__}return a.__wrapped__=e,t},fe.prototype.reverse=function(){var e=this.__wrapped__;if(e instanceof _e){var t=e;return this.__actions__.length&&(t=new _e(this)),(t=t.reverse()).__actions__.push({func:zn,args:[wn],thisArg:Ys}),new ge(t,this.__chain__)}return this.thru(wn)},fe.prototype.toJSON=fe.prototype.valueOf=fe.prototype.value=function(){return Ft(this.__wrapped__,this.__actions__)},fe.prototype.first=fe.prototype.head,k&&(fe.prototype[k]=function(){return this}),fe}();R?((R.exports=dl)._=dl,E._=dl):_o._=dl}).call(fi)}),gi=function(e,t,i){return"\n#ifdef MAPFLOAT\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"},_i=function(e,t,i){return"\n#ifdef MAPCOLOR\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"},yi=function(e,t,i){return"\n#ifdef MAPTEXTURE\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"},bi=function(e,t,i){return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"},xi=function(e,t,i){return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"},Mi=function(e,t,i){return"\n#ifdef MAPVERTEX\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"},Si=function(e,t,i){return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"},wi=function(e,t,i){return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"},Ci=[],Pi={_oldChunkToNew:{aoTexPS:{n:"aoPS",f:yi},aoVertPS:{n:"aoPS",f:Mi},diffuseConstPS:{n:"diffusePS",f:_i},diffuseTexPS:{n:"diffusePS",f:yi},diffuseTexConstPS:{n:"diffusePS",f:bi},diffuseVertPS:{n:"diffusePS",f:Mi},diffuseVertConstPS:{n:"diffusePS",f:Si},emissiveConstPS:{n:"emissivePS",f:_i},emissiveTexPS:{n:"emissivePS",f:yi},emissiveTexConstPS:{n:"emissivePS",f:bi},emissiveTexConstFloatPS:{n:"emissivePS",f:xi},emissiveVertPS:{n:"emissivePS",f:Mi},emissiveVertConstPS:{n:"emissivePS",f:Si},emissiveVertConstFloatPS:{n:"emissivePS",f:wi},glossConstPS:{n:"glossPS",f:gi},glossTexPS:{n:"glossPS",f:yi},glossTexConstPS:{n:"glossPS",f:xi},glossVertPS:{n:"glossPS",f:Mi},glossVertConstPS:{n:"glossPS",f:wi},metalnessConstPS:{n:"metalnessPS",f:gi},metalnessTexPS:{n:"metalnessPS",f:yi},metalnessTexConstPS:{n:"metalnessPS",f:xi},metalnessVertPS:{n:"metalnessPS",f:Mi},metalnessVertConstPS:{n:"metalnessPS",f:wi},opacityConstPS:{n:"opacityPS",f:gi},opacityTexPS:{n:"opacityPS",f:yi},opacityTexConstPS:{n:"opacityPS",f:xi},opacityVertPS:{n:"opacityPS",f:Mi},opacityVertConstPS:{n:"opacityPS",f:wi},specularConstPS:{n:"specularPS",f:_i},specularTexPS:{n:"specularPS",f:yi},specularTexConstPS:{n:"specularPS",f:bi},specularVertPS:{n:"specularPS",f:Mi},specularVertConstPS:{n:"specularPS",f:Si},transformBatchSkinnedVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef DYNAMICBATCH\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"}},transformInstancedVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef INSTANCING\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"}},transformPixelSnapVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef PIXELSNAP\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"}},transformScreenSpaceVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef SCREENSPACE\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"}},transformScreenSpaceBatchSkinned:{n:"transformVS",f:function(e,t,i){return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"}},transformSkinned:{n:"transformVS",f:function(e,t,i){return"\n#ifdef SKIN\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"}},transformUv1:{n:"transformVS",f:function(e,t,i){return"\n#ifdef UV1LAYOUT\n"+e+"\n#else\n"+Rt[t]+"\n#endif\n"}}},optionsContext:{},optionsContextMin:{},generateKey:function(e){var t,i=function(e){var t=[];for(var i in e)e.hasOwnProperty(i)&&"chunks"!==i&&"lights"!==i&&t.push(i);return t.sort()};e===this.optionsContextMin?(this.propsMin||(this.propsMin=i(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=i(e)),t=this.props):t=i(e);var n,a="standard";for(n=0;n<t.length;n++)e[t[n]]&&(a+=t[n]+e[t[n]]);if(e.chunks){var s=[];for(var r in e.chunks)e.chunks.hasOwnProperty(r)&&s.push(r+e.chunks[r]);s.sort(),a+=s}if(e.lights)for(n=0;n<e.lights.length;n++)a+=e.lights[n].key;return ct(a)},_correctChannel:function(e,t){if(0<Ci[e]){if(Ci[e]<t.length)return t.substring(0,Ci[e]);if(Ci[e]>t.length){for(var i=t,n=i.charAt(i.length-1),a=Ci[e]-i.length,s=0;s<a;s++)i+=n;return i}return t}},_setMapMappingParameter:function(e,t,i,n){return n?(e[0]+="uniform int "+t+"MapMappingType;\n",e[0]+="uniform mat4 "+t+"MapMappingMatrix;\n",e[1]+="varying vec4 vUv"+i+"_"+t+";\n",e[2]+="   vUv"+i+"_"+t+" =  getUv"+i+"("+t+"MapMappingType,"+t+"MapMappingMatrix);\n"):(e[0]+="uniform vec2 "+t+"MapTiling;\n",e[0]+="uniform vec2 "+t+"MapOffset;\n",e[1]+="varying vec2 vUv"+i+"_"+t+";\n",e[2]+="   vUv"+i+"_"+t+" =  getUv"+i+"("+t+"MapTiling,"+t+"MapOffset);\n"),e},_getUvSourceExpression:function(e,t,i){var n=i[t],a=0===i.pass||1===i.pass;return a&&1===i.nineSlicedMode?"nineSlicedUv":a&&2===i.nineSlicedMode?"nineSlicedUv, -1000.0":"vUv"+n+"_"+e},_addMapDef:function(e,t){var i="\n#undef "+e+"\n";return t&&(i+=" #define "+e+"\n"),i},_addMapDefs:function(e,t,i,n,a){var s="";return s+=this._addMapDef("MAPFLOAT",e),s+=this._addMapDef("MAPCOLOR",t),s+=this._addMapDef("MAPVERTEX",i),s+=this._addMapDef("MAPTEXTURE",n),a&&(s+=this._addMapDef(a,!!a)),s},_addMap:function(e,t,i,n,a){void 0===a&&(a=-1);var s=e+"Map",r=s+"Uv",o=s+"Channel",l=e+"VertexColorChannel",h=e+"VertexColor",c=e+"Mode",u=i[e+"Tint"],d=i[h],p=i[s],f=i[c],m=n[t];if(p){var v,g=this._getUvSourceExpression(e,r,i);if(m=m.replace(/\$UV/g,g).replace(/\$CH/g,null==(v=i[o])?void 0:v.toLowerCase()),-1!==a){var _=0===a?"texture2DSRGB":1===a?"texture2DRGBM":"texture2D";m=m.replace(/\$texture2DSAMPLE/g,_)}}d&&(m=m.replace(/\$VC/g,i[l])),f&&(m=m.replace(/\$DETAILMODE/g,f));var y=1===u,b=3===u,x=[Bt.UV0,Bt.UV1].includes(i[s+"MappingType"])?"":s+"MappingEnabled";return(m=this._addMapDefs(y,b,d,p,x)+m).replace(/\$/g,"")},_directionalShadowMapProjection:function(e,t,i,n,a){var s="";return 1<e.numCascades&&(s+="getShadowCascadeMatrix(light"+n+"_shadowMatrixPalette, light"+n+"_shadowCascadeDistances, light"+n+"_shadowCascadeCount);\n",t="(cascadeShadowMat, "+i+");\n"),(s+=a+t)+"fadeShadow(light"+n+"_shadowCascadeDistances);\n"},_nonPointShadowMapProjection:function(e,t,i,n,a){var s="("+i+", "+n+");\n";return!t._normalOffsetBias||t._isVsm?2===t._type?t._isPcf&&(e.webgl2||e.extStandardDerivatives)?"       getShadowCoordPerspZbuffer"+s:"       getShadowCoordPersp"+s:this._directionalShadowMapProjection(t,s,n,a,"getShadowCoordOrtho"):2===t._type?t._isPcf&&(e.webgl2||e.extStandardDerivatives)?"       getShadowCoordPerspZbufferNormalOffset"+s:"       getShadowCoordPerspNormalOffset"+s:this._directionalShadowMapProjection(t,s,n,a,"getShadowCoordOrthoNormalOffset")},_addVaryingIfNeeded:function(e,t,i){return 0<=e.indexOf(i)?"varying "+t+" "+i+";\n":""},_getLightSourceShapeString:function(e){switch(e){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}},_vsAddTransformCode:function(e,t,i,n){return e+i.transformVS},_vsAddBaseCode:function(e,t,i,n){return e+=i.baseVS,1!==n.nineSlicedMode&&2!==n.nineSlicedMode||(e+=i.baseNineSlicedVS),e},_fsAddBaseCode:function(e,t,i,n){return e+=i.basePS,1===n.nineSlicedMode?e+=i.baseNineSlicedPS:2===n.nineSlicedMode&&(e+=i.baseNineSlicedTiledPS),e},_fsAddStartCode:function(e,t,i,n){return e+=i.startPS,1===n.nineSlicedMode?e+=i.startNineSlicedPS:2===n.nineSlicedMode&&(e+=i.startNineSlicedTiledPS),e},createShaderDefinition:function(e,t){var i,n,a=0<t.lights.length;t.dirLightMap&&(a=!0),pi.clusteredLightingEnabled&&(a=!0),0===t.shadingModel?(t.fresnelModel=0,t.specularAntialias=!1,t.prefilteredCubemap=!1,t.dpAtlas=!1,t.ambientSH=!1):t.fresnelModel=0===t.fresnelModel?2:t.fresnelModel,2===t.shadingModel&&(t.toneMap=5);var s=(t.cubeMap||t.prefilteredCubemap&&t.useSpecular)&&!t.sphereMap&&!t.dpAtlas,r=t.sphereMap||s||t.dpAtlas,o=t.useTexCubeLod;t.cubeMap&&(t.sphereMap=null),t.dpAtlas&&(t.prefilteredCubemap=null),t.useSpecular||(t.specularMap=t.glossMap=null);var l=a||r||t.ambientSH||t.prefilteredCubemap||t.heightMap||t.enableGGXSpecular||2===t.shadingModel;for(var h in Ci)t[h+"Map"]&&(l=!0);var c=3<=t.pass&&t.pass<=17;this.options=t;var u,d,p,f="",m="",v="",g=Rt,_={vertex_position:Te};if(t.chunks){var y,b={};for(n in g)g.hasOwnProperty(n)&&(t.chunks[n]?(0<=(p=t.chunks[n]).indexOf("vertex_normal")&&(_.vertex_normal=Ae),0<=p.indexOf("vertex_tangent")&&(_.vertex_tangent=Ee),0<=p.indexOf("vertex_texCoord0")&&(_.vertex_texCoord0=Le),0<=p.indexOf("vertex_texCoord1")&&(_.vertex_texCoord1=Oe),0<=p.indexOf("vertex_color")&&(_.vertex_color=Ie),0<=p.indexOf("vertex_boneWeights")&&(_.vertex_boneWeights=Re),0<=p.indexOf("vertex_boneIndices")&&(_.vertex_boneIndices=De),b[n]=p):b[n]=g[n]);for(n in t.chunks)(y=this._oldChunkToNew[n])&&(b[y.n]=y.f(t.chunks[n],y.n,n));g=b}f=this._vsAddBaseCode(f,e,g,t),m+="   vPositionW    = getWorldPosition();\n",2===t.pass&&(f+="varying float vDepth;\n",f+="#ifndef VIEWMATRIX\n",f+="#define VIEWMATRIX\n",f+="uniform mat4 matrix_view;\n",f+="#endif\n",f+="#ifndef CAMERAPLANES\n",f+="#define CAMERAPLANES\n",f+="uniform vec4 camera_params;\n\n",f+="#endif\n",m+="    vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),t.useInstancing&&(_.instance_line1=Fe,_.instance_line2=ze,_.instance_line3=Be,_.instance_line4=Ve,f+=g.instancingVS),l&&(_.vertex_normal=Ae,m+="   vNormalW    = dNormalW = getNormal();\n",t.sphereMap&&e.fragmentUniformsCount<=16&&(f+=g.viewNormalVS,m+="   vNormalV    = getViewNormal();\n"),(t.heightMap||t.normalMap||t.enableGGXSpecular)&&t.hasTangents?(_.vertex_tangent=Ee,f+=g.tangentBinormalVS,m+="   vTangentW   = getTangent();\n",m+="   vBinormalW  = getBinormal();\n"):t.enableGGXSpecular&&(f+=g.tangentBinormalVS,m+="   vObjectSpaceUpW  = getObjectSpaceUp();\n"));var x,M,S,w=[];for(n in Ci)M=n+"Map",t[n+"VertexColor"]&&(t[x=n+"VertexColorChannel"]=this._correctChannel(n,t[x])),t[M]&&(x=M+"Channel",t[S=M+"Uv"]=Math.min(t[S],1),t[x]=this._correctChannel(n,t[x]),w[t[S]]=!0);for(t.forceUv1&&(w[1]=!0),i=0;i<2;i++)w[i]&&(_["vertex_texCoord"+i]="TEXCOORD"+i,f+=g["uv"+i+"VS"]);var C=[f,v,m,[]];for(n in Ci)if(t[M=n+"Map"]){S=M+"Uv";var P=![Bt.UV0,Bt.UV1].includes(t[M+"MappingType"]);this._setMapMappingParameter(C,n,t[S],P)}f=C[0],v=C[1],m=C[2],t.vertexColors&&(_.vertex_color=Ie,m+="   vVertexColor = vertex_color;\n"),(t.useMorphPosition||t.useMorphNormal)&&(t.useMorphTextureBased?(f+="#define MORPHING_TEXTURE_BASED\n",t.useMorphPosition&&(f+="#define MORPHING_TEXTURE_BASED_POSITION\n"),t.useMorphNormal&&(f+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),_.morph_vertex_id=Ke,f+="attribute float morph_vertex_id;\n"):(f+="#define MORPHING\n",t.useMorphPosition?(_.morph_pos0=We,_.morph_pos1=He,_.morph_pos2=je,_.morph_pos3=Xe,f+="#define MORPHING_POS03\n",f+="attribute vec3 morph_pos0;\n",f+="attribute vec3 morph_pos1;\n",f+="attribute vec3 morph_pos2;\n",f+="attribute vec3 morph_pos3;\n"):t.useMorphNormal&&(_.morph_nrm0=We,_.morph_nrm1=He,_.morph_nrm2=je,_.morph_nrm3=Xe,f+="#define MORPHING_NRM03\n",f+="attribute vec3 morph_nrm0;\n",f+="attribute vec3 morph_nrm1;\n",f+="attribute vec3 morph_nrm2;\n",f+="attribute vec3 morph_nrm3;\n"),t.useMorphNormal?(_.morph_nrm4=qe,_.morph_nrm5=$e,_.morph_nrm6=Ye,_.morph_nrm7=Ke,f+="#define MORPHING_NRM47\n",f+="attribute vec3 morph_nrm4;\n",f+="attribute vec3 morph_nrm5;\n",f+="attribute vec3 morph_nrm6;\n",f+="attribute vec3 morph_nrm7;\n"):(_.morph_pos4=qe,_.morph_pos5=$e,_.morph_pos6=Ye,_.morph_pos7=Ke,f+="#define MORPHING_POS47\n",f+="attribute vec3 morph_pos4;\n",f+="attribute vec3 morph_pos5;\n",f+="attribute vec3 morph_pos6;\n",f+="attribute vec3 morph_pos7;\n"))),t.skin?(_.vertex_boneWeights=Re,_.vertex_boneIndices=De,f+=Ot(e,g),f+="#define SKIN\n"):t.useInstancing&&(f+="#define INSTANCING\n"),t.screenSpace&&(f+="#define SCREENSPACE\n"),t.pixelSnap&&(f+="#define PIXELSNAP\n"),f=this._vsAddTransformCode(f,e,g,t),l&&(f+=g.normalVS),f+="\n",f+=g.startVS,f+=m,f+=g.endVS;var T=f+="}",A=v;v="",v+=this._addVaryingIfNeeded(f,"vec4","vVertexColor"),v+=this._addVaryingIfNeeded(f,"vec3","vPositionW"),v+=this._addVaryingIfNeeded(f,"vec3","vPosition"),v+=this._addVaryingIfNeeded(f,"vec3","vNormalV"),v+=this._addVaryingIfNeeded(f,"vec3","vNormalW"),v+=this._addVaryingIfNeeded(f,"vec3","vTangentW"),v+=this._addVaryingIfNeeded(f,"vec3","vBinormalW"),v+=this._addVaryingIfNeeded(f,"vec3","vObjectSpaceUpW"),T=(v+=A)+T;var E="";if(e.webgl2?(E=zt(e),g.extensionVS&&(E+=g.extensionVS+"\n"),T=E+g.gles3VS+T):(g.extensionVS&&(E=g.extensionVS+"\n"),T=E+T),t.forceFragmentPrecision&&"highp"!==t.forceFragmentPrecision&&"mediump"!==t.forceFragmentPrecision&&"lowp"!==t.forceFragmentPrecision&&(t.forceFragmentPrecision=null),t.forceFragmentPrecision&&("highp"===t.forceFragmentPrecision&&"highp"!==e.maxPrecision&&(t.forceFragmentPrecision="mediump"),"mediump"===t.forceFragmentPrecision&&"lowp"===e.maxPrecision&&(t.forceFragmentPrecision="lowp")),f="",e.webgl2&&(f+=zt(e)),e.extStandardDerivatives&&!e.webgl2&&(f+="#extension GL_OES_standard_derivatives : enable\n\n"),g.extensionPS&&(f+=g.extensionPS+"\n"),e.webgl2&&(f+=g.gles3PS),f+=t.forceFragmentPrecision?"precision "+t.forceFragmentPrecision+" float;\n\n":Ft(e),18===t.pass)return f+="uniform vec4 uColor;\n",f+=v,t.alphaTest&&(f+="float dAlpha;\n",f+=this._addMap("opacity","opacityPS",t,g),f+=g.alphaTestPS),f+="void main(void)\n{\n",t.alphaTest&&(f+="   getOpacity();\n",f+="   alphaTest(dAlpha);\n"),f+="    gl_FragColor = uColor;\n",{attributes:_,vshader:T,fshader:f+="}\n"};if(2===t.pass)return f+="varying float vDepth;\n",f+=v,f+=g.packDepthPS,t.alphaTest&&(f+="float dAlpha;\n",f+=this._addMap("opacity","opacityPS",t,g),f+=g.alphaTestPS),f+="void main(void)\n{\n",t.alphaTest&&(f+="   getOpacity();\n",f+="   alphaTest(dAlpha);\n"),f+="    gl_FragColor = packFloat(vDepth);\n",{attributes:_,vshader:T,fshader:f+="}\n"};if(c){var R=t.pass-3,D=R-5*(u=Math.floor(R/5));return e.extStandardDerivatives&&!e.webgl2&&(f+="uniform vec2 polygonOffset;\n"),3===D?e.textureFloatHighPrecision?f+="#define VSM_EXPONENT 15.0\n\n":f+="#define VSM_EXPONENT 5.54\n\n":2===D&&(f+="#define VSM_EXPONENT 5.54\n\n"),0!==u&&(f+="uniform vec3 view_position;\n",f+="uniform float light_radius;\n"),f+=v,t.alphaTest&&(f+="float dAlpha;\n",f+=this._addMap("opacity","opacityPS",t,g),f+=g.alphaTestPS),0!==D||e.webgl2&&1!==u?1===D&&(f+="vec2 encodeFloatRG( float v ) {\n",f+="    vec2 enc = vec2(1.0, 255.0) * v;\n",f+="    enc = fract(enc);\n",f+="    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",f+="    return enc;\n",f+="}\n\n"):f+=g.packDepthPS,f+="void main(void)\n{\n",t.alphaTest&&(f+="   getOpacity();\n",f+="   alphaTest(dAlpha);\n"),f+=1===u||(1===D||2===D||3===D)&&0!==u?"   float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":"   float depth = gl_FragCoord.z;\n",0!==D||e.webgl2&&1!==u?f+=0===D||4===D?"   gl_FragColor = vec4(1.0);\n":1===D?"   gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":g.storeEVSMPS:(e.extStandardDerivatives&&!e.webgl2&&(f+="   float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",f+="   depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),f+="   gl_FragColor = packFloat(depth);\n"),{attributes:_,vshader:T,fshader:f+="}\n"}}if(t.customFragmentShader)return{attributes:_,vshader:T,fshader:f+t.customFragmentShader,tag:1};f+=v,f=this._fsAddBaseCode(f,e,g,t),t.detailModes&&(f+=g.detailModesPS);var I=f;f="",0<t.clearCoat&&(f+="#define CLEARCOAT\n"),(3!==t.blendType||t.alphaTest||t.alphaToCoverage)&&(1===t.oit?t.accumOIT?f+="#define ACCUM\n":f+="#define WBOIT\n":2===t.oit&&(f+="#define DPOIT\n").replace("$DPOIT",e.webgl2?"\n                layout(location=0) out vec4 depth;  // RG32F, R - negative front depth, G - back depth\n                layout(location=1) out vec4 frontColor;\n                layout(location=2) out vec4 backColor;\n                 ":"")),!1===t.opacityFadesSpecular&&(f+="uniform float material_alphaFade;\n");var k,L=0,O=[],F=!1,z=!1,B=!1,V=t.lights.some(function(e){return e._shape&&0!==e._shape});7===e.areaLightLutFormat?(f+="#define AREA_R8_G8_B8_A8_LUTS\n",f+="#define AREA_LUTS_PRECISION lowp\n"):f+="#define AREA_LUTS_PRECISION highp\n",V&&(f+="#define AREA_LIGHTS\n",f+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex1;\n",f+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex2;\n");var U,N=0;for(i=0;i<t.lights.length;i++)f+="uniform vec3 light"+i+"_color;\n",0===(u=(k=t.lights[i])._type)?(f+="uniform vec3 light"+i+"_direction;\n",f+="uniform vec3 light"+i+"_position;\n"):(f+="uniform vec3 light"+i+"_position;\n",f+="uniform float light"+i+"_radius;\n",2===u&&(f+="uniform vec3 light"+i+"_direction;\n",f+="uniform float light"+i+"_innerConeAngle;\n",f+="uniform float light"+i+"_outerConeAngle;\n")),0!==(N=V&&k._shape?k._shape:0)&&(f+="uniform vec3 light"+i+"_halfWidth;\n",f+="uniform vec3 light"+i+"_halfHeight;\n"),k.castShadows&&!t.noShadow&&(f+="uniform mat4 light"+i+"_shadowMatrix;\n",0===u&&(f+="uniform mat4 light"+i+"_shadowMatrixPalette[4];\n",f+="uniform float light"+i+"_shadowCascadeDistances[4];\n",f+="uniform float light"+i+"_shadowCascadeCount;\n"),0!==u?f+="uniform vec4 light"+i+"_shadowParams;\n":(F=!0,f+="uniform vec3 light"+i+"_shadowParams;\n"),1===u?f+="uniform samplerCube light"+i+"_shadowMap;\n":k._isPcf&&e.webgl2?f+="uniform sampler2DShadow light"+i+"_shadowMap;\n":f+="uniform sampler2D light"+i+"_shadowMap;\n",L++,O[k._shadowType]=!0,k._isVsm&&(z=!0),k._isPcf&&(e.webgl2||e.extStandardDerivatives)&&2===u&&(B=!0)),k._cookie&&(k._cookie._cubemap?1===u&&(f+="uniform samplerCube light"+i+"_cookie;\n",f+="uniform float light"+i+"_cookieIntensity;\n",k.castShadows&&!t.noShadow||(f+="uniform mat4 light"+i+"_shadowMatrix;\n")):2===u&&(f+="uniform sampler2D light"+i+"_cookie;\n",f+="uniform float light"+i+"_cookieIntensity;\n",k.castShadows&&!t.noShadow||(f+="uniform mat4 light"+i+"_shadowMatrix;\n"),k._cookieTransform&&(f+="uniform vec4 light"+i+"_cookieMatrix;\n",f+="uniform vec2 light"+i+"_cookieOffset;\n")));if(f+="\n",U=!t.hasTangents&&e.extStandardDerivatives?g.TBNderivativePS:t.fastTbn?g.TBNfastPS:g.TBNPS,l)if(t.normalMap||t.clearCoatNormalMap){if(f+=t.packedNormal?g.normalXYPS:g.normalXYZPS,!t.hasTangents){var G=this._getUvSourceExpression("normal","normalMapUv",t);U=U.replace(/\$UV/g,G);var W=[Bt.UV0,Bt.UV1].includes(t.normalMapMappingType)?"":"normalMapMappingEnabled";W&&(U=this._addMapDef(W,!!W)+U)}f+=U}else t.enableGGXSpecular&&!t.heightMap&&(f+=g.normalVertexPS,f+=g.TBNObjectSpacePS);if(l)if(t.normalMap){t.normalDetail&&(f+=this._addMap("normalDetail","normalDetailMapPS",t,g));var H=this._getUvSourceExpression("normal","normalMapUv",t);t.normalizeNormalMap?f+=g.normalMapPS.replace(/\$UV/g,H):f+=g.normalMapFastPS.replace(/\$UV/g,H)}else t.enableGGXSpecular&&!t.heightMap||(f+=g.normalVertexPS);if(f+=It(t.gamma,g),f+=kt(t.toneMap,g),f+=Lt(t.fog,g),t.useRgbm&&(f+=g.rgbmPS),(s||t.prefilteredCubemap)&&(f+=t.fixSeams?g.fixCubemapSeamsStretchPS:g.fixCubemapSeamsNonePS),t.useCubeMapRotation&&(f+="#define CUBEMAP_ROTATION\n"),t.useRightHandedCubeMap&&(f+="#define RIGHT_HANDED_CUBEMAP\n"),l&&(f+=g.cubeMapRotatePS,f+=0<t.cubeMapProjection?g.cubeMapProjectBoxPS:g.cubeMapProjectNonePS,f+=t.skyboxIntensity?g.envMultiplyPS:g.envConstPS),2===t.shadingModel&&(f+="#define PBR\n",e.PBRMapsLoaded&&t.useIBL&&(f+="#define PBR_MAPS_LOADED\n"),t.useMetalness&&(f+="#define USE_METALNESS\n")),t.diffuseDetail&&(f+=this._addMap("diffuseDetail","diffuseDetailMapPS",t,g)),f+=this._addMap("diffuse","diffusePS",t,g),(3!==t.blendType||t.alphaTest||t.alphaToCoverage)&&(f+=this._addMap("opacity","opacityPS",t,g)),f+=this._addMap("emissive","emissivePS",t,g,t.emissiveFormat),a&&t.useSpecular||r){t.specularAntialias&&t.normalMap?t.normalizeNormalMap&&l?f+=g.specularAaToksvigPS:f+=g.specularAaToksvigFastPS:f+=g.specularAaNonePS;var j=t.useMetalness?"metalness":"specular";if(f+=this._addMap(j,j+"PS",t,g),2===t.shadingModel){var X=t.useMetalness?"specular":"metalness";f+=this._addMap(X,X+"PS",t,g),t.useMetalness?(!t.roughnessMap&&t.metalnessMap&&(f+="#define SAMPLE_METALLNESS_MAP;\n"),f+=this._addMap("roughness","roughnessPS",t,g).replace("METALNESS_UV",t.metalnessMap?this._getUvSourceExpression("metalness","metalnessMapUv",t):this._getUvSourceExpression("roughness","roughnessMapUv",t))):f+=this._addMap("gloss","glossPS",t,g)}else f+=this._addMap("gloss","glossPS",t,g);2===t.fresnelModel&&(f+=g.fresnelSchlickPS)}if(0<t.clearCoat&&(f+=this._addMap("clearCoat","clearCoatPS",t,g),f+=this._addMap("clearCoatGloss","clearCoatGlossPS",t,g),f+=this._addMap("clearCoatNormal","clearCoatNormalPS",t,g)),t.heightMap){if(!t.normalMap){var q=this._getUvSourceExpression("height","heightMapUv",t);t.hasTangents||(U=U.replace(/\$UV/g,q)),f+=U}f+=this._addMap("height","parallaxPS",t,g)}var $=t.aoMap||t.aoVertexColor;$&&(f+=this._addMap("ao","aoPS",t,g),t.occludeSpecular&&(1===t.occludeSpecular?f+=t.occludeSpecularFloat?g.aoSpecOccSimplePS:g.aoSpecOccConstSimplePS:f+=t.occludeSpecularFloat?g.aoSpecOccPS:g.aoSpecOccConstPS));var Y=t.rgbmReflection?"decodeRGBM":t.hdrReflection?"":"gammaCorrectInput";if(2===t.shadingModel)f+=g.reflectionPrefilterPBRPS.replace(/\$DECODE/g,"decodeRGBM");else if(t.sphereMap){var K=16<e.fragmentUniformsCount?g.reflectionSpherePS:g.reflectionSphereLowPS;f+=K=K.replace(/\$texture2DSAMPLE/g,t.rgbmReflection?"texture2DRGBM":t.hdrReflection?"texture2D":"texture2DSRGB")}else s?t.prefilteredCubemap?f+=o?g.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,Y):g.reflectionPrefilteredCubePS.replace(/\$DECODE/g,Y):f+=g.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,t.rgbmReflection?"textureCubeRGBM":t.hdrReflection?"textureCube":"textureCubeSRGB"):t.dpAtlas&&(f+=g.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,t.rgbmReflection?"texture2DRGBM":t.hdrReflection?"texture2D":"texture2DSRGB"));(s||t.sphereMap||t.dpAtlas)&&(0<t.clearCoat&&(f+=g.reflectionCCPS),t.refraction&&(f+=g.refractionPS)),0<L&&(F&&(f+=Rt.shadowCascadesPS),O[0]&&(f+=g.shadowStandardPS),O[4]&&(f+=g.shadowStandardGL2PS),z&&(f+=g.shadowVSM_commonPS,O[1]&&(f+=g.shadowVSM8PS),O[2]&&(f+=e.extTextureHalfFloatLinear?g.shadowEVSMPS.replace(/\$/g,"16"):g.shadowEVSMnPS.replace(/\$/g,"16")),O[3]&&(f+=e.extTextureFloatLinear?g.shadowEVSMPS.replace(/\$/g,"32"):g.shadowEVSMnPS.replace(/\$/g,"32"))),e.webgl2||e.extStandardDerivatives||(f+=g.biasConstPS),f+=g.shadowCoordPS+g.shadowCommonPS,B&&(f+=g.shadowCoordPerspZbufferPS)),2===t.shadingModel&&(f+=g.brdfPS,f+=g.indirectLightPS,(vi.isNumber(t.transmission)||t.transmissionMap)&&(f+="#define USE_TRANSMISSION\n",f+=this._addMap("transmission","transmissionParsPS",t,g),f+="uniform vec3 material_diffuseTransmission;\n",f+="uniform vec3 material_specularTransmission;\n",f+="#define USE_TRANSMISSION\n"),(vi.isNumber(t.thickness)||t.thicknessMap)&&(f+=this._addMap("thickness","thicknessPS",t,g)),"self_luminous"===t.PBR_type&&(f+="#define EMISSIVE;\n"),f+="#include <PBRParsPS>\n"),t.enableGGXSpecular&&(f+="uniform float material_anisotropy;\n"),t.oit&&(f+="#include <accumParsPS>\n"),a&&(f+=g.lightDiffuseLambertPS,V&&(f+=g.ltc));var Z=!1;if(t.useSpecular)if(a&&(f+=0===t.shadingModel?g.lightSpecularPhongPS:t.enableGGXSpecular?g.lightSpecularAnisoGGXPS:g.lightSpecularBlinnPS),t.sphereMap||s||t.dpAtlas||0<t.fresnelModel)if(0<t.fresnelModel)if(t.conserveEnergy&&!V)if(2===t.shadingModel){var Q=g.combineDiffuseSpecularPBRPS.replace(/\$LIGHTS_SIZE/g,1).replace(/\$OIT/g,1===t.oit?"#include <accumDrawPS>":"");t.transmission||(Q=Q.replace("#include <transmissionPS>","")),f+=Q}else f+=g.combineDiffuseSpecularPS.replace(/\$OIT/g,1===t.oit?"#include <accumDrawPS>":"");else f+=g.combineDiffuseSpecularNoConservePS;else f+=g.combineDiffuseSpecularOldPS;else t.diffuseMap?f+=g.combineDiffuseSpecularNoReflPS:(f+=g.combineDiffuseSpecularNoReflSeparateAmbientPS,Z=!0);else f+=g.combineDiffusePS;0<t.clearCoat&&(f+=g.combineClearCoatPS);var J=!0;if(t.lightMap||t.lightVertexColor){var ee=t.dirLightMap&&t.useSpecular?"lightmapDirPS":"lightmapSinglePS";f+=this._addMap("light",ee,t,g,t.lightMapFormat),J=t.lightMapWithoutAmbient}if(J){var te=t.rgbmAmbient?"decodeRGBM":t.hdrAmbient?"":"gammaCorrectInput";t.ambientSH?f+=g.ambientSHPS:t.prefilteredCubemap?o?f+=g.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,te):2===t.shadingModel?f+=g.ambientPrefilteredCubePBRPS.replace(/\$DECODE/g,te):f+=g.ambientPrefilteredCubePS.replace(/\$DECODE/g,te):f+=g.ambientConstantPS}if(t.ambientTint&&!Z&&(f+="uniform vec3 material_ambient;\n"),t.alphaTest&&(f+=g.alphaTestPS),t.msdf&&(f+=g.msdfPS),l&&(f+=g.viewDirPS,t.useSpecular&&(f+=t.enableGGXSpecular?g.reflDirAnisoPS:g.reflDirPS)),I.includes("vNormalW")||(t.useClearCoat=!1),t.useClearCoat){var ie="";f.includes("vec3 decodeRGBM")||(ie+=["vec3 decodeRGBM(vec4 rgbm) {\n","   vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n","   return color * color;\n","}\n"].join("")),f.includes("uniform samplerCube texture_prefilteredCubeMap128")||(ie+=["uniform samplerCube texture_prefilteredCubeMap128;\n"].join("")),t.uClearCoatColor&&(ie+=["#define CC_MAPCOLOR\n"].join("")),t.uClearCoatMap&&(ie+=["#define CC_MAPTEXTURE\n"].join("")),f+=ie+=["uniform float uClearCoatFactor;\n","uniform float uClearCoatIor;\n","uniform float uClearCoatF0;\n","uniform float uClearCoatThickness;\n","uniform float uClearCoatFresnelPower;\n","\n","#ifdef CC_MAPCOLOR\n","uniform vec3 uClearCoatColor;\n","#endif\n","\n","#ifdef CC_MAPTEXTURE\n","uniform sampler2D texture_uClearCoatMap;\n","#endif\n","\n","float F_Schlick(const float f0, const float f90, const in float VoH) {\n","   return f0 + (f90 - f0) * pow(1.0 - VoH, uClearCoatFresnelPower);\n","}\n","#ifndef saturate\n","#define saturate(_x) clamp(_x, 0., 1.)\n","#endif\n","\n","vec3 beerLambert(const float NoV, const float NoL, const vec3 tint, const float d) {\n","   return exp(tint * -(d * ((NoL + NoV) / max(NoL * NoV, 1e-3))));\n","}\n","\n","vec3 getClearCoatAbsorbtion(const in float NoV, const in float NoL, const in float clearCoatFactor){\n","   vec3 uClearCoatTint = vec3(1.0,1.0,1.0);\n","   #ifdef CC_MAPCOLOR\n","   uClearCoatTint = uClearCoatColor;\n","   #endif\n","   #ifdef CC_MAPTEXTURE\n","   uClearCoatTint = texture2D(texture_uClearCoatMap, vUv0).rgb;\n","   #endif\n","   uClearCoatTint = clamp(uClearCoatTint,vec3(.01,.01,.01),vec3(0.99,0.99,0.99));\n","   float t = max(20.0-uClearCoatThickness,0.01);\n","   uClearCoatTint = -log(uClearCoatTint)/t;\n","   return mix(vec3(1.0), beerLambert(NoV, NoL, uClearCoatTint, uClearCoatThickness), clearCoatFactor);\n","}\n","\n","vec3 addClearCoat(vec4 fragColor){\n","   vec3 viewVec = vPositionW.xyz - view_position;\n","   vec3 materialClearCoatNormal = dNormalW;\n","   vec3 eyeVector = dViewDirW;\n","   vec3 worldNormal = vNormalW;\n","   vec3 vFrasnelReflect = reflect( normalize(viewVec ), worldNormal );\n","   #ifndef RIGHT_HANDED_CUBEMAP\n","   vFrasnelReflect.x = -vFrasnelReflect.x;\n","   #endif\n","   float ccNoV = saturate(dot(materialClearCoatNormal, -refract(eyeVector, materialClearCoatNormal, 1.0 / uClearCoatIor)));\n","   vec3 ccAbsorbtion = getClearCoatAbsorbtion(ccNoV, ccNoV, uClearCoatFactor);\n","   float ccF0 = uClearCoatFactor * F_Schlick(uClearCoatF0, 1.0, ccNoV);\n","   vec3 frasnelEnvColor = vec3 (processEnvironment(decodeRGBM(textureCube( texture_prefilteredCubeMap128, vFrasnelReflect ))));\n","   return mix(fragColor.rgb*ccAbsorbtion,frasnelEnvColor,ccF0);\n","}\n"].join("")}var ne,ae=!1,se=!1,re=!1,oe=!1,le=!1;pi.clusteredLightingEnabled&&(se=ae=oe=!0,f+="\n#define CLUSTER_TEXTURE_"+(ai.lightTextureFormat===ai.FORMAT_FLOAT?"FLOAT":"8BIT")+"\n",f+=g.clusteredLightPS),t.twoSidedLighting&&(f+="uniform float twoSidedLightingNegScaleFactor;\n"),f=this._fsAddStartCode(f,e,g,t),l&&(t.hasTangents||!e.extStandardDerivatives||t.fastTbn?t.twoSidedLighting?f+="   dVertexNormalW = gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor;\n":f+="   dVertexNormalW = vNormalW;\n":t.twoSidedLighting?f+="   dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);\n":f+="   dVertexNormalW = normalize(vNormalW);\n",(t.heightMap||t.normalMap)&&t.hasTangents&&(t.twoSidedLighting?(f+="   dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;\n",f+="   dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;\n"):(f+="   dTangentW = vTangentW;\n",f+="   dBinormalW = vBinormalW;\n")));var he=!1;3!==t.blendType||t.alphaTest||t.alphaToCoverage?t.heightMap&&t.opacityMap?he=!0:(f+="   getOpacity();\n",t.alphaTest&&(f+="   alphaTest(dAlpha);\n")):f+="   dAlpha = 1.0;\n";var ce=!1;l&&(f+="   getViewDir();\n",(t.heightMap||t.normalMap||t.clearCoatNormalMap||t.enableGGXSpecular)&&(f+="   getTBN();\n"),t.heightMap&&(f+="   getParallax();\n"),he&&(f+="   getOpacity();\n",t.alphaTest&&(f+="   alphaTest(dAlpha);\n")),f+="   getNormal();\n",t.useSpecular&&(t.enableGGXSpecular&&(f+="   getGlossiness();\n",ce=!0),f+="   getReflDir();\n")),f+="   getAlbedo();\n",0<t.clearCoat&&(f+="   getClearCoat();\n",f+="   getClearCoatGlossiness();\n",f+="   getClearCoatNormal();\n");var ue="",de="";if((a&&t.useSpecular||r)&&(f+="   getSpecularity();\n",2===t.shadingModel?(f+="   getSpecularity(true);\n",t.useMetalness?f+="   getRoughness();\n":ce||(f+="   getGlossiness();\n")):ce||(f+="   getGlossiness();\n"),V&&(f+="   #ifdef AREA_LIGHTS\n",f+="   dSpecularityNoFres = dSpecularity;\n",f+="   #ifdef CLEARCOAT\n",f+="   ccSpecularityNoFres = ccSpecularity;\n",f+="   #endif\n",f+="   #endif\n"),0<t.fresnelModel&&(f+="   getFresnel();\n")),2===t.shadingModel&&((t.thickness||t.thicknessMap)&&(f+="   getThickness();\n"),(t.transmission||t.transmissionMap)&&(f+="   getTransmission();\n")),J&&(f+="   addAmbient();\n"),t.ambientTint&&!Z&&(f+="   dDiffuseLight *= material_ambient;\n"),$&&!t.occludeDirect&&(f+="    applyAO();\n"),(t.lightMap||t.lightVertexColor)&&(f+="   addLightMap();\n"),a||r){2!==t.shadingModel&&(s||t.sphereMap||t.dpAtlas)&&(0<t.clearCoat&&(f+="   addReflectionCC();\n"),f+="   addReflection();\n"),V&&(f+="   ccReflection.rgb *= ccSpecularity;\n",f+="   dReflection.rgb *= dSpecularity;\n",f+="   dSpecularLight *= dSpecularity;\n",f+="   float roughness = max((1.0 - dGlossiness) * (1.0 - dGlossiness), 0.001);\n");var pe="";for(pi.clusteredLightingEnabled&&(ae=se=!0,f+=g.clusteredLightLoopPS),i=0;i<t.lights.length;i++)if(u=(k=t.lights[i])._type,!pi.clusteredLightingEnabled||0===u){if(ne=!1,V&&k._shape?(N=k._shape,pe=this._getLightSourceShapeString(N)):(N=0,pe=""),0!==N&&(f+="   calc"+pe+"LightValues(light"+i+"_position, light"+i+"_halfWidth, light"+i+"_halfHeight);\n"),0===u?(f+="   dLightDirNormW = light"+i+"_direction;\n",f+="   dAtten = 1.0;\n"):(k._cookie&&(2!==u||k._cookie._cubemap?1===u&&k._cookie._cubemap&&(ne=le=!0):ne=le=!0),f+="   getLightDirPoint(light"+i+"_position);\n",ae=!0,ne&&(f+=2===u?"   dAtten3 = getCookie2D"+(k._cookieFalloff?"":"Clip")+(k._cookieTransform?"Xform":"")+"(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity"+(k._cookieTransform?", light"+i+"_cookieMatrix, light"+i+"_cookieOffset":"")+")."+k._cookieChannel+";\n":"   dAtten3 = getCookieCube(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity)."+k._cookieChannel+";\n"),0===N?0===k._falloffMode?(f+="   dAtten = getFalloffLinear(light"+i+"_radius);\n",se=!0):(f+="   dAtten = getFalloffInvSquared(light"+i+"_radius);\n",re=!0):(f+="   dAtten = getFalloffWindow(light"+i+"_radius);\n",re=!0),f+="   if (dAtten > 0.00001) {\n",2===u&&(ne&&!k._cookieFalloff||(f+="       dAtten *= getSpotEffect(light"+i+"_direction, light"+i+"_innerConeAngle, light"+i+"_outerConeAngle);\n",oe=!0))),f+=0!==N?0===u?"       dAttenD = getLightDiffuse();\n":"       dAttenD = get"+pe+"LightDiffuse() * 16.0;\n":"       dAtten *= getLightDiffuse();\n",k.castShadows&&!t.noShadow){var fe=null,me=void 0;if(1===k._shadowType?(fe="VSM8",me="0.0"):2===k._shadowType?(fe="VSM16",me="5.54"):3===k._shadowType?(fe="VSM32",me=e.textureFloatHighPrecision?"15.0":"5.54"):fe=4===k._shadowType?"PCF5x5":"PCF3x3",null!==fe)if(1===u)d="(light"+i+"_shadowMap, light"+i+"_shadowParams);\n",k._normalOffsetBias&&(f+="       normalOffsetPointShadow(light"+i+"_shadowParams);\n"),f+="       dAtten *= getShadowPoint"+fe+d;else{var ve="light"+i+"_shadowMatrix",ge="light"+i+"_shadowParams";f+=this._nonPointShadowMapProjection(e,t.lights[i],ve,ge,i),2===u&&(fe="Spot"+fe),f+="       dAtten *= getShadow"+fe+"(light"+i+"_shadowMap, light"+i+"_shadowParams"+(k._isVsm?", "+me:"")+");\n"}}0!==N?t.conserveEnergy&&t.useSpecular?f+="       dDiffuseLight += mix((dAttenD * dAtten) * light"+i+"_color"+(ne?" * dAtten3":"")+", vec3(0), dLTCSpecFres);\n":f+="       dDiffuseLight += (dAttenD * dAtten) * light"+i+"_color"+(ne?" * dAtten3":"")+";\n":V&&t.conserveEnergy&&t.useSpecular?f+="       dDiffuseLight += mix(dAtten * light"+i+"_color"+(ne?" * dAtten3":"")+", vec3(0), dSpecularity);\n":f+="       dDiffuseLight += dAtten * light"+i+"_color"+(ne?" * dAtten3":"")+";\n",0!==N?(0<t.clearCoat&&(f+="       ccSpecularLight += ccLTCSpecFres * get"+pe+"LightSpecularCC() * dAtten * light"+i+"_color"+(ne?" * dAtten3":"")+";\n"),t.useSpecular&&(f+="       dSpecularLight += dLTCSpecFres * get"+pe+"LightSpecular() * dAtten * light"+i+"_color"+(ne?" * dAtten3":"")+";\n")):V?(0<t.clearCoat&&(f+="       ccSpecularLight += ccSpecularity * getLightSpecularCC() * dAtten * light"+i+"_color"+(ne?" * dAtten3":"")+";\n"),t.useSpecular&&(f+="       dSpecularLight += dSpecularity * getLightSpecular() * dAtten * light"+i+"_color"+(ne?" * dAtten3":"")+";\n")):(0<t.clearCoat&&(f+="       ccSpecularLight += getLightSpecularCC() * dAtten * light"+i+"_color"+(ne?" * dAtten3":"")+";\n"),t.useSpecular&&(f+="       dSpecularLight += getLightSpecular() * dAtten * light"+i+"_color"+(ne?" * dAtten3":"")+";\n")),2===t.shadingModel&&(ue+="Lo += getLo(light"+i+"_position,light"+i+"_color,vPosition,N, V, F0, albedo, roughness);\n",de+="Scatter += RE_Direct_Scattering(light"+i+"_position,light"+i+"_color, vPosition,N, V, subsurfaceColor,dThickness,0.1,0.1,0.1,2.0,10.0);\n"),0!==u&&(f+="   }\n"),f+="\n"}V&&(0<t.clearCoat&&(f+="   ccSpecularity = 1.0;\n"),t.useSpecular&&(f+="   dSpecularity = vec3(1);\n")),(s||t.sphereMap||t.dpAtlas)&&t.refraction&&(f+="   addRefraction();\n")}f=(f=f.replace("$Lo",ue||"")).replace("$Scatter",de||""),f+="\n",$?(t.occludeDirect&&(f+="    applyAO();\n"),t.occludeSpecular&&(f+="    occludeSpecular();\n")):2===t.shadingModel&&(f+="    dAo = 1.0;\n"),!1===t.opacityFadesSpecular&&(2!==t.blendType&&4!==t.blendType||(f+="float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n",f+="#ifdef CLEARCOAT\n specLum += dot(ccSpecularLight * ccSpecularity + ccReflection.rgb * ccReflection.a * ccSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif\n",f+="dAlpha = clamp(dAlpha + gammaCorrectInput(specLum), 0.0, 1.0);\n"),f+="dAlpha *= material_alphaFade;\n"),f+=g.endPS,t.useClearCoat&&(f+="    gl_FragColor.rgb = addClearCoat(gl_FragColor);\n"),1===t.oit?t.accumOIT?f+=g.accumPS:f+=g.outputAlphaWBOITPS:2===t.oit?f+=g.DPOITpeelingPS:2===t.blendType||6===t.blendType||t.alphaToCoverage?f+=g.outputAlphaPS:4===t.blendType?f+=g.outputAlphaPremulPS:f+=g.outputAlphaOpaquePS,t.msdf&&(f+="   gl_FragColor = applyMsdf(gl_FragColor);\n"),f+="\n",f+="}\n",ae&&(f=g.lightDirPointPS+f),se&&(f=g.falloffLinearPS+f),re&&(f=g.falloffInvSquaredPS+f),oe&&(f=g.spotPS+f),le&&(f=g.cookiePS+f);var _e="";return f.includes("dReflection")&&(_e+="vec4 dReflection;\n"),f.includes("dTBN")&&(_e+="mat3 dTBN;\n"),f.includes("dAlbedo")&&(_e+="vec3 dAlbedo;\n"),f.includes("dEmission")&&(_e+="vec3 dEmission;\n"),f.includes("dNormalW")&&(_e+="vec3 dNormalW;\n"),f.includes("dVertexNormalW")&&(_e+="vec3 dVertexNormalW;\n"),f.includes("dTangentW")&&(_e+="vec3 dTangentW;\n"),f.includes("dBinormalW")&&(_e+="vec3 dBinormalW;\n"),f.includes("dViewDirW")&&(_e+="vec3 dViewDirW;\n"),f.includes("dReflDirW")&&(_e+="vec3 dReflDirW;\n"),f.includes("dDiffuseLight")&&(_e+="vec3 dDiffuseLight;\n"),f.includes("dSpecularLight")&&(_e+="vec3 dSpecularLight;\n"),f.includes("dLightDirNormW")&&(_e+="vec3 dLightDirNormW;\n"),f.includes("dLightDirW")&&(_e+="vec3 dLightDirW;\n"),f.includes("dLightPosW")&&(_e+="vec3 dLightPosW;\n"),f.includes("dShadowCoord")&&(_e+="vec3 dShadowCoord;\n"),f.includes("dNormalMap")&&(_e+="vec3 dNormalMap;\n"),f.includes("dSpecularity")&&(_e+="vec3 dSpecularity;\n"),f.includes("dSpecularityNoFres")&&(_e+="vec3 dSpecularityNoFres;\n"),f.includes("dUvOffset")&&(_e+="vec2 dUvOffset;\n"),f.includes("dGlossiness")&&(_e+="float dGlossiness;\n"),f.includes("dRoughness")&&(_e+="float dRoughness;\n"),f.includes("dThickness")&&(_e+="float dThickness;\n"),f.includes("dTransmission")&&(_e+="float dTransmission;\n"),f.includes("dDiffuseTransmission")&&(_e+="vec3 dDiffuseTransmission;\n"),f.includes("dSpecularTransmission")&&(_e+="vec3 dSpecularTransmission;\n"),f.includes("dAlpha")&&(_e+="float dAlpha;\n"),f.includes("dAtten")&&(_e+="float dAtten;\n"),f.includes("dAttenD")&&(_e+="float dAttenD;\n"),f.includes("dAtten3")&&(_e+="vec3 dAtten3;\n"),f.includes("dAo")&&(_e+="float dAo;\n"),f.includes("dMsdf")&&(_e+="vec4 dMsdf;\n"),f.includes("ccReflection")&&(_e+="vec4 ccReflection;\n"),f.includes("ccNormalW")&&(_e+="vec3 ccNormalW;\n"),f.includes("ccReflDirW")&&(_e+="vec3 ccReflDirW;\n"),f.includes("ccSpecularLight")&&(_e+="vec3 ccSpecularLight;\n"),f.includes("ccSpecularity")&&(_e+="float ccSpecularity;\n"),f.includes("ccSpecularityNoFres")&&(_e+="float ccSpecularityNoFres;\n"),f.includes("ccGlossiness")&&(_e+="float ccGlossiness;\n"),f.includes("metallic")&&(_e+="float metallic;\n"),f.includes("Lo")&&(_e+="vec3 Lo;\n"),{attributes:_,vshader:T,fshader:Ut(f=I+_e+f),tag:1}}},Ti={generateKey:function(e){return"irradiance"+e.rgbm+" "+e.hdr},createShaderDefinition:function(e,t){var i;return i=Ft(e),i+=Rt.rgbmPS,i+=Rt.irradianceMapVS.replace(/\$textureCubeSAMPLE/g,t.rgbm?"textureCubeRGBM":t.hdr?"textureCube":"textureCubeSRGB"),{attributes:{aPosition:Te},vshader:Rt.cubemapPS,fshader:i}}},Ai={generateKey:function(e){return"prefilter"+e.rgbm+" "+e.hdr+" "+e.toneMapping+e.gamma},createShaderDefinition:function(e,t){var i="",n="";return e.webgl2&&(n+=zt(e),n+=Rt.gles3VS,i+=zt(e),i+=Rt.gles3PS),n+=Rt.cubemapPS,i+=Ft(e),i+=t.mip?Rt.fixCubemapSeamsStretchPS:Rt.fixCubemapSeamsNonePS,i+=Rt.rgbmPS,i+=Rt.prefilterMapPS.replace(/\$textureCubeSAMPLE/g,t.rgbm?"textureCubeRGBM":t.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,32,16,8,4,2][t.mip]+""),{attributes:{aPosition:Te},vshader:n,fshader:i}}},Ei={generateKey:function(e){return"brdf"+e.rgbm+" "+e.hdr+" "+e.toneMapping+e.gamma},createShaderDefinition:function(e,t){var i;return i=Ft(e),i+=Rt.brdfPS,i+=Rt.brdfLUTPS,{attributes:{aPosition:Te,aTexCoords:Le},vshader:Rt.brdfLUTVS,fshader:i}}},Ri={begin:function(){return"void main(void)\n{\n"},dummyFragmentCode:function(){return"void main(void) {gl_FragColor = vec4(0.0);}"},end:function(){return"}\n"},fogCode:Lt,gammaCode:It,precisionCode:Ft,skinCode:Ot,tonemapCode:kt,versionCode:zt,basic:jt,particle:Xt,skybox:qt,standard:Pi,irradiance:Ti,prefilter:Ai,brdf:Ei},Di=new de,Ii=new de,ki=new de,Li=new pe,Oi=function(){function e(){this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new $(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullingMask=4294967295,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new ee(0,0,1,1),this._renderTarget=null,this._scissorRect=new ee(0,0,1,1),this._vrDisplay=null,this._projMat=new pe,this._projMatDirty=!0,this._projMatSkybox=new pe,this._viewMat=new pe,this._viewMatDirty=!0,this._viewProjMat=new pe,this._viewProjMatDirty=!0,this.frustum=new be}var t=e.prototype;return t.clone=function(){return(new e).copy(this)},t.copy=function(e){return this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.cullingMask=e.cullingMask,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.vrDisplay=e.vrDisplay,this},t._updateViewProjMat=function(){if(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var e=this.projectionMatrix,t=this.viewMatrix;this._viewProjMat.mul2(e,t),this._viewProjMatDirty=!1}},t.worldToScreen=function(e,t,i,n){void 0===n&&(n=new de),this._updateViewProjMat(),this._viewProjMat.transformPoint(e,n);var a=this._viewProjMat.data,s=e.x*a[3]+e.y*a[7]+e.z*a[11]+1*a[15];return n.x=.5*(n.x/s+1)*t,n.y=.5*(1-n.y/s)*i,n},t.screenToWorld=function(e,t,i,n,a,s){void 0===s&&(s=new de);var r=this._farClip-this._nearClip;if(Di.set(e/n,(a-t)/a,i/r),Di.mulScalar(2),Di.sub(de.ONE),0===this._projection){pe._getPerspectiveHalfSize(Ii,this._fov,this._aspectRatio,this._nearClip,this._horizontalFov),Ii.x*=Di.x,Ii.y*=Di.y;var o=this._node.getWorldTransform();Ii.z=-this._nearClip,o.transformPoint(Ii,ki);var l=this._node.getPosition();s.sub2(ki,l),s.normalize(),s.mulScalar(i),s.add(l)}else this._updateViewProjMat(),Li.copy(this._viewProjMat).invert(),Li.transformPoint(Di,s);return s},t._evaluateProjectionMatrix=function(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{var e=this._orthoHeight,t=e*this._aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this._nearClip,this._farClip),this._projMatSkybox.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip)}this._projMatDirty=!1}},t.getProjectionMatrixSkybox=function(){return this._evaluateProjectionMatrix(),this._projMatSkybox},c(e,[{key:"aspectRatio",get:function(){return this._aspectRatio},set:function(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=!0)}},{key:"aspectRatioMode",get:function(){return this._aspectRatioMode},set:function(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=!0)}},{key:"calculateProjection",get:function(){return this._calculateProjection},set:function(e){this._calculateProjection=e,this._projMatDirty=!0}},{key:"calculateTransform",get:function(){return this._calculateTransform},set:function(e){this._calculateTransform=e}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.copy(e)}},{key:"clearColorBuffer",get:function(){return this._clearColorBuffer},set:function(e){this._clearColorBuffer=e}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearDepthBuffer",get:function(){return this._clearDepthBuffer},set:function(e){this._clearDepthBuffer=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"clearStencilBuffer",get:function(){return this._clearStencilBuffer},set:function(e){this._clearStencilBuffer=e}},{key:"cullingMask",get:function(){return this._cullingMask},set:function(e){this._cullingMask=e}},{key:"cullFaces",get:function(){return this._cullFaces},set:function(e){this._cullFaces=e}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}},{key:"flipFaces",get:function(){return this._flipFaces},set:function(e){this._flipFaces=e}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}},{key:"frustumCulling",get:function(){return this._frustumCulling},set:function(e){this._frustumCulling=e}},{key:"horizontalFov",get:function(){return this._horizontalFov},set:function(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}},{key:"layers",get:function(){return this._layers},set:function(e){this._layers=e.slice(0)}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}},{key:"projectionMatrix",get:function(){return this._evaluateProjectionMatrix(),this._projMat}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.copy(e)}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}},{key:"scissorRect",get:function(){return this._scissorRect},set:function(e){this._scissorRect.copy(e)}},{key:"viewMatrix",get:function(){if(this._viewMatDirty){var e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat}},{key:"vrDisplay",get:function(){return this._vrDisplay},set:function(e){(this._vrDisplay=e)&&(e._camera=this)}}]),e}();function Fi(e,t,i,n){var a=t.fixCubemapSeams?Dt.fixCubemapSeamsStretchPS:Dt.fixCubemapSeamsNonePS,s=Ht(e,Dt.fullscreenQuadVS,a+Dt.genParaboloidPS,"genParaboloid"),r=e.scope.resolve("source"),o=e.scope.resolve("params"),l=new Float32Array(4),h=t.width,c=t.format;h=2*Math.max(h,8);var u=new Kt(e,{type:t.type,format:c,width:2*h,height:h,mipmaps:!1});u.name="paraboloid";var d=new Fm({colorBuffer:u,depth:!1});return l[0]=i,l[1]=n?-1:1,r.setValue(t),o.setValue(l),At(e,d,s),u}function zi(e,t){e.x=.5*Se.clamp(t-2,0,1);var i=t-6*e.x,n=1-e.x;return e.y=Math.min(.5*i,.75)*n+e.x,e.z=(1-.5*Se.clamp(i,0,1))*n,e.w=.5*e.z,1/e.z}function Bi(e,t,i){var n,a=new ee,s=new Float32Array(4),r=2*t[0].width*2,o=Ht(e,Dt.fullscreenQuadVS,Dt.dpAtlasQuadPS,"dpAtlasQuad"),l=e.scope.resolve("source"),h=e.scope.resolve("params"),c=new Kt(e,{type:t[0].type,format:t[0].format,width:r,height:r,mipmaps:!1});c.name="paraboloid";for(var u,d=new Fm({colorBuffer:c,depth:!1}),p=(r+2)/r-1,f=0;f<6;f++)n=Fi(e,t[f],f,i),l.setValue(n),u=zi(a,f),s[0]=u*p,s[1]=2*s[0],s[0]+=1,s[1]+=1,h.setValue(s),a.x*=r,a.y*=r,a.z*=r,a.w*=r,At(e,d,o,a);return c}var Vi=0,Ui=function(){function s(){this.name="Untitled",this.id=Vi++,this._shader=null,this.variants={},this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this.blend=!1,this.blendSrc=1,this.blendDst=0,this.blendEquation=0,this.separateAlphaBlend=!1,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.blendAlphaEquation=0,this.cull=1,this.depthTest=!0,this.depthWrite=!0,this.stencilFront=null,this.stencilBack=null,this.depthBias=0,this.slopeDepthBias=0,this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0}var e=s.prototype;return e._cloneInternal=function(e){e.name=this.name,e.shader=this.shader,e.alphaTest=this.alphaTest,e.alphaToCoverage=this.alphaToCoverage,e.blend=this.blend,e.blendSrc=this.blendSrc,e.blendDst=this.blendDst,e.blendEquation=this.blendEquation,e.separateAlphaBlend=this.separateAlphaBlend,e.blendSrcAlpha=this.blendSrcAlpha,e.blendDstAlpha=this.blendDstAlpha,e.blendAlphaEquation=this.blendAlphaEquation,e.cull=this.cull,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.depthBias=this.depthBias,e.slopeDepthBias=this.slopeDepthBias,this.stencilFront&&(e.stencilFront=this.stencilFront.clone()),this.stencilBack&&(this.stencilFront===this.stencilBack?e.stencilBack=e.stencilFront:e.stencilBack=this.stencilBack.clone()),e.redWrite=this.redWrite,e.greenWrite=this.greenWrite,e.blueWrite=this.blueWrite,e.alphaWrite=this.alphaWrite},e.clone=function(){var e=new s;return this._cloneInternal(e),e},e._updateMeshInstanceKeys=function(){var e,t=this.meshInstances;for(e=0;e<t.length;e++)t[e].updateKey()},e.updateUniforms=function(){},e.updateShader=function(e,t,i){},e.update=function(){this.dirty=!0,this._shader&&(this._shader.failed=!1)},e.clearParameters=function(){this.parameters={}},e.getParameters=function(){return this.parameters},e.clearVariants=function(){var e,t;this.variants={};for(var i=0;i<this.meshInstances.length;i++)for(e=this.meshInstances[i],t=0;t<e._shader.length;t++)e._shader[t]=null},e.getParameter=function(e){return this.parameters[e]},e.setParameter=function(e,t){if(void 0===t&&"object"==(void 0===e?"undefined":dx(e))){var i=e;if(i.length){for(var n=0;n<i.length;n++)this.setParameter(i[n]);return}e=i.name,t=i.value}var a=this.parameters[e];a?a.data=t:this.parameters[e]={scopeId:null,data:t}},e.deleteParameter=function(e){this.parameters[e]&&delete this.parameters[e]},e.setParameters=function(e,t){var i,n=this.parameters;for(var a in void 0===t&&(t=n),t)(i=n[a])&&(i.scopeId||(i.scopeId=e.scope.resolve(a)),i.scopeId.setValue(i.data))},e.setIBL=function(){m.ibl&&(this.setParameter("texture_prefilteredCubeMap128",m.ibl),this.setParameter("texture_prefilteredCubeMap64",m.ibl),this.setParameter("texture_prefilteredCubeMap32",m.ibl),this.setParameter("texture_prefilteredCubeMap16",m.ibl),this.setParameter("texture_prefilteredCubeMap8",m.ibl),this.setParameter("texture_prefilteredCubeMap4",m.ibl),m.ibl=null)},e.destroy=function(){this.variants={},this.meshInstances=[],this.shader=null;for(var e=0;e<this.meshInstances.length;e++){for(var t=this.meshInstances[e],i=0;i<t._shader.length;i++)t._shader[i]=null;t._material=null;var n=s.defaultMaterial;this!==n&&(t.material=n)}if(this._assetReferences){for(var a in this._assetReferences)this._assetReferences[a]&&this._assetReferences[a].destroy(),delete this._assetReferences[a];this._assetReferences={}}},e.addMeshInstanceRef=function(e){this.meshInstances.push(e)},e.removeMeshInstanceRef=function(e){var t=this.meshInstances,i=t.indexOf(e);-1!==i&&t.splice(i,1)},c(s,[{key:"shader",get:function(){return this._shader},set:function(e){this._shader=e}},{key:"blendType",get:function(){return this.blend||1!==this.blendSrc||0!==this.blendDst||0!==this.blendEquation?this.blend&&6===this.blendSrc&&8===this.blendDst&&0===this.blendEquation?2:this.blend&&1===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?1:this.blend&&6===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?6:this.blend&&4===this.blendSrc&&2===this.blendDst&&0===this.blendEquation?7:this.blend&&5===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?8:this.blend&&1===this.blendSrc&&1===this.blendDst&&3===this.blendEquation?9:this.blend&&1===this.blendSrc&&1===this.blendDst&&4===this.blendEquation?10:this.blend&&4===this.blendSrc&&0===this.blendDst&&0===this.blendEquation?5:this.blend&&1===this.blendSrc&&8===this.blendDst&&0===this.blendEquation?4:2:3},set:function(e){var t=this.blend;switch(e){case 3:this.blend=!1,this.blendSrc=1,this.blendDst=0,this.blendEquation=0;break;case 2:this.blend=!0,this.blendSrc=6,this.blendDst=8,this.blendEquation=0;break;case 4:this.blend=!0,this.blendSrc=1,this.blendDst=8,this.blendEquation=0;break;case 1:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=0;break;case 6:this.blend=!0,this.blendSrc=6,this.blendDst=1,this.blendEquation=0;break;case 7:this.blend=!0,this.blendSrc=4,this.blendDst=2,this.blendEquation=0;break;case 8:this.blend=!0,this.blendSrc=5,this.blendDst=1,this.blendEquation=0;break;case 5:this.blend=!0,this.blendSrc=4,this.blendDst=0,this.blendEquation=0;break;case 9:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=3;break;case 10:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=4}t!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0),this._updateMeshInstanceKeys()}}]),s}();function Ni(){this._mapXForms=null}Ui.defaultMaterial=null,Ni.prototype.updateMinRef=function(e,t,i,n,a,s,r,o,l){this._updateSharedOptions(e,n,a,r),this._updateMinOptions(e,n),this._updateUVOptions(e,n,a,!0)},Ni.prototype.updateRef=function(e,t,i,n,a,s,r,o,l){this._updateSharedOptions(e,n,a,r),e.useTexCubeLod=t.useTexCubeLod,this._updateEnvOptions(e,n,i,l),this._updateMaterialOptions(e,n),1===r&&(e.gamma&&(e.gamma=3),e.toneMap=0),e.hasTangents=a&&n.normalMap&&0!=(512&a),this._updateLightOptions(e,n,a,o,s),this._updateUVOptions(e,n,a,!1),e.clearCoat=n.clearCoat,e.clearCoatGlossiness=n.clearCoatGlossiness},Ni.prototype._updateSharedOptions=function(e,t,i,n){e.pass=n,e.alphaTest=0<t.alphaTest,e.forceFragmentPrecision=t.forceFragmentPrecision||"",e.chunks=t.chunks||"",e.blendType=t.blendType,e.forceUv1=t.forceUv1,e.screenSpace=i&&0!=(256&i),e.skin=i&&0!=(2&i),e.useInstancing=i&&0!=(32&i),e.useMorphPosition=i&&0!=(1024&i),e.useMorphNormal=i&&0!=(2048&i),e.useMorphTextureBased=i&&0!=(4096&i),e.nineSlicedMode=t.nineSlicedMode||0},Ni.prototype._updateUVOptions=function(e,t,i,n){var a=!1,s=!1,r=!1;for(var o in i&&(a=0!=(4&i),s=0!=(8&i),r=0!=(16&i)),e.vertexColors=!1,this._mapXForms=[],Ci)this._updateTexOptions(e,t,o,a,s,r,n);this._mapXForms=null},Ni.prototype._updateMinOptions=function(e,t){e.opacityTint=1!==t.opacity&&3!==t.blendType,e.lights=[]},Ni.prototype._updateMaterialOptions=function(e,t){var i=1===t.diffuse.r&&1===t.diffuse.g&&1===t.diffuse.b||!t.diffuseTint&&(t.diffuseMap||t.diffuseVertexColor)?0:3,n=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||t.dpAtlas);n=(n=(n=n||!!t.useMetalness||!(0===t.specular.r&&0===t.specular.g&&0===t.specular.b))||t.enableGGXSpecular)||0<t.clearCoat,2===e.shadingModel&&(n=!0);var a=n&&!t.useMetalness&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&1!==t.specular.r||1!==t.specular.g||1!==t.specular.b,s=t.emissiveMap?0:3;s||(s=(s=(1!==t.emissive.r||1!==t.emissive.g||1!==t.emissive.b||1!==t.emissiveIntensity)&&t.emissiveTint)?3:1!==t.emissiveIntensity?1:0);var r=!!t.normalMap&&(10===t.normalMap.format||t.normalMap.type===et);e.ior=t.ior,e.transmission=t.transmission,e.thickness=t.thickness,e.attenuationColor=t.attenuationColor,e.attenuationDistance=t.attenuationDistance,e.subsurfaceColor=t.subsurfaceColor,e.opacityTint=1!==t.opacity&&3!==t.blendType?1:0,e.blendMapsWithColors=!0,e.ambientTint=t.ambientTint,e.diffuseTint=i,e.specularTint=a?3:0,e.metalnessTint=t.useMetalness&&t.metalness<1?1:0,e.glossTint=1,e.roughnessTint=1,e.transmissionTint=1,e.thicknessTint=1,e.diffuseTransmission=t.diffuseTransmission,e.specularTransmission=t.specularTransmission,e.emissiveTint=s,e.alphaToCoverage=t.alphaToCoverage,e.normalizeNormalMap=t.normalizeNormalMap,e.sphereMap=!!t.sphereMap,e.cubeMap=!!t.cubeMap,e.dpAtlas=!!t.dpAtlas,e.ambientSH=!!t.ambientSH,e.useSpecular=n,e.emissiveFormat=t.emissiveMap?t.emissiveMap.type===Qe?1:t.emissiveMap.format===Ce?2:0:null,e.lightMapFormat=t.lightMap?t.lightMap.type===Qe?1:t.lightMap.format===Ce?2:0:null,e.specularAntialias=t.specularAntialias&&!!t.normalMap&&!!t.normalMap.mipmaps&&!r,e.conserveEnergy=t.conserveEnergy,e.opacityFadesSpecular=t.opacityFadesSpecular,e.alphaFade=t.alphaFade,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.occludeDirect=t.occludeDirect,e.shadingModel=t.shadingModel,e.fresnelModel=t.fresnelModel,e.packedNormal=r,e.fastTbn=t.fastTbn,e.cubeMapProjection=t.cubeMapProjection,e.customFragmentShader=t.customFragmentShader,e.refraction=!!t.refraction,e.useMetalness=t.useMetalness,e.enableGGXSpecular=t.enableGGXSpecular,e.useClearCoat=t.useClearCoat,e.uClearCoatColor=t.uClearCoatColor,e.uClearCoatMap=!!t.uClearCoatMap,e.msdf=!!t.msdfMap,e.twoSidedLighting=t.twoSidedLighting,e.pixelSnap=t.pixelSnap,e.aoMapUv=t.aoUvSet,e.diffuseDetail=!!t.diffuseMap,e.normalDetail=!!t.normalMap,e.diffuseDetailMode=t.diffuseDetailMode,e.detailModes=!!e.diffuseDetail,e.clearCoatTint=1!==t.clearCoat?1:0,e.clearCoatGlossTint=1!==t.clearCoatGlossiness?1:0,e.PBR_type=t.PBR_type,e.oit=t.oit,e.accumOIT=!!t.accumOIT},Ni.prototype._updateEnvOptions=function(e,t,i,n){var a,s=n&&n.type===Qe||t.cubeMap&&t.cubeMap.type===Qe||t.dpAtlas&&t.dpAtlas.type===Qe,r=n&&(n.type===Qe||n.format===Ce)||t.cubeMap&&(t.cubeMap.type===Qe||t.cubeMap.format===Ce)||t.dpAtlas&&(t.dpAtlas.type===Qe||t.dpAtlas.format===Ce),o=n&&!t.cubeMap&&!t.sphereMap&&!t.dpAtlas&&n.type===Qe||t.cubeMap&&t.cubeMap.type===Qe||t.sphereMap&&t.sphereMap.type===Qe||t.dpAtlas&&t.dpAtlas.type===Qe,l=!(!n||t.cubeMap||t.sphereMap||t.dpAtlas)&&(n.type===Qe||n.format===Ce)||t.cubeMap&&(t.cubeMap.type===Qe||t.cubeMap.format===Ce)||t.sphereMap&&(t.sphereMap.type===Qe||t.sphereMap.format===Ce)||t.dpAtlas&&(t.dpAtlas.type===Qe||t.dpAtlas.format===Ce);t.useSkybox&&i._skyboxPrefiltered&&(a=i._skyboxPrefiltered[0]),e.fog=t.useFog?i.fog:"none",e.gamma=t.useGammaTonemap?i.gammaCorrection:0,e.toneMap=t.useGammaTonemap?i.toneMapping:-1,e.rgbmAmbient=s,e.hdrAmbient=r,e.rgbmReflection=o,e.hdrReflection=l,e.useRgbm=o||s||t.emissiveMap&&t.emissiveMap.type===Qe||t.lightMap&&t.lightMap.type===Qe,e.fixSeams=n?n.fixCubemapSeams:!!t.cubeMap&&t.cubeMap.fixCubemapSeams,e.prefilteredCubemap=!!n,e.skyboxIntensity=n&&a&&n===a&&1!==i.skyboxIntensity,e.useCubeMapRotation=t.useSkybox&&i&&i.skyboxRotation&&!i.skyboxRotation.equals(fe.IDENTITY),e.useRightHandedCubeMap=t.cubeMap?t.cubeMap._isRenderTarget:t.useSkybox&&i&&i._skyboxIsRenderTarget},Ni.prototype._updateLightOptions=function(e,t,i,n,a){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.noShadow=0!=(1&i),0!=(64&i)&&(e.lightMapFormat=1,e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.lightMapWithoutAmbient=!t.lightMap,e.useRgbm=!0,0!=(128&i)&&(e.dirLightMap=!0))),t.useLighting){var s=[],r=i?i>>16:1;n&&(this._collectLights(0,n[0],s,r),this._collectLights(1,n[1],s,r,a),this._collectLights(2,n[2],s,r,a)),e.lights=s}else e.lights=[];0===e.lights.length&&(e.noShadow=!0)},Ni.prototype._updateTexOptions=function(e,t,i,n,a,s,r){var o=i+"Map",l=i+"VertexColor",h=i+"VertexColorChannel",c=o+"Channel",u=o+"MappingType",d=o+"Tiling",p=o+"Offset",f=o+"Rotation",m=o+"MappingTranslation",v=o+"MappingRotation",g=o+"MappingScale",_=o+"PlaneMappingDepth",y=o+"CameraMappingLock",b=o+"ReverseMode",x=o+"TilingMode",M=o+"Uv";"light"!==i&&(e[o]=!1,e[c]="",e[u]=0,e[d]=0,e[p]=0,e[f]=0,e[m]=0,e[v]=0,e[g]=0,e[_]=0,e[y]=0,e[b]=0,e[x]=0,e[M]=0),e[l]=!1,e[h]="";var S="opacity"===i;if(S&&3===t.blendType&&0===t.alphaTest&&!t.alphaToCoverage)return e;if((!r||S)&&("height"!==i&&t[l]&&s&&(e[l]=t[l],e[h]=t[h],e.vertexColors=!0),t[o])){var w=!0;0!==t[M]||n||(w=!1),1!==t[M]||a||(w=!1),w&&(e[o]=!!t[o],e[u]=t[u],e[d]=t[d],e[p]=t[d],e[f]=t[f],e[m]=this._getMapTranslationRotationScaleID(t[m],t[M]),e[v]=this._getMapTranslationRotationScaleID(t[v],t[M]),e[g]=this._getMapTranslationRotationScaleID(t[g],t[M]),e[_]=t[_],e[y]=t[y],e[b]=t[b],e[x]=t[x],e[c]=t[c],e[M]=t[M])}},Ni.prototype._collectLights=function(e,t,i,n,a){var s,r;for(r=0;r<t.length;r++)if((s=t[r]).enabled&&s.mask&n){if(0!==e&&s.isStatic)continue;i.push(s)}if(a)for(r=0;r<a.length;r++)(s=a[r])._type===e&&i.push(s)},Ni.prototype._getMapTranslationRotationScaleID=function(e,t){if(!e)return 0;var i,n;for(this._mapXForms[t]||(this._mapXForms[t]=[]),i=0;i<this._mapXForms[t].length;i++){if(n=!0,this._mapXForms[t][i][0]!=e.x){n=!1;break}if(this._mapXForms[t][i][1]!=e.y){n=!1;break}if(this._mapXForms[t][i][2]!=e.z){n=!1;break}if(n)return i+1}var a=this._mapXForms[t].length;return this._mapXForms[t][a]=[],this._mapXForms[t][a][0]=e.x,this._mapXForms[t][a][1]=e.y,this._mapXForms[t][a][2]=e.z,a+1};var Gi,Wi={uuid:"string",name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",aoMapMappingType:"enum:textureMappingType",aoMapRadian:"number",aoMapMappingTranslation:"vec3",aoMapMappingRotation:"vec3",aoMapMappingScale:"vec3",aoMapGizmoPlanePosWS:"vec3",aoMapPlaneMappingDepth:"number",aoMapCameraMappingLock:"boolean",aoMapReverseMode:"enum:textureMappingReverseMode",aoMapTilingMode:"enum:textureMappingTilingMode",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseMapMappingType:"enum:textureMappingType",diffuseMapRadian:"number",diffuseMapMappingTranslation:"vec3",diffuseMapMappingRotation:"vec3",diffuseMapMappingScale:"vec3",diffuseMapGizmoPlanePosWS:"vec3",diffuseMapPlaneMappingDepth:"number",diffuseMapCameraMappingLock:"boolean",diffuseMapReverseMode:"enum:textureMappingReverseMode",diffuseMapTilingMode:"enum:textureMappingTilingMode",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMode:"string",diffuseDetailMapMappingType:"enum:textureMappingType",diffuseDetailMapRadian:"number",diffuseDetailMapMappingTranslation:"vec3",diffuseDetailMapMappingRotation:"vec3",diffuseDetailMapMappingScale:"vec3",diffuseDetailMapGizmoPlanePosWS:"vec3",diffuseDetailMapPlaneMappingDepth:"number",diffuseDetailMapCameraMappingLock:"boolean",diffuseDetailMapReverseMode:"enum:textureMappingReverseMode",diffuseDetailMapTilingMode:"enum:textureMappingRepeatMode",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularMapMappingType:"enum:textureMappingType",specularMapRadian:"number",specularMapMappingTranslation:"vec3",specularMapMappingRotation:"vec3",specularMapMappingScale:"vec3",specularMapGizmoPlanePosWS:"vec3",specularMapPlaneMappingDepth:"number",specularMapCameraMappingLock:"boolean",specularMapReverseMode:"enum:textureMappingReverseMode",specularMapTilingMode:"enum:textureMappingTilingMode",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",transmissionTint:"boolean",transmissionVertexColor:"boolean",transmissionVertexColorChannel:"string",transmissionMap:"texture",transmissionMapChannel:"string",transmissionMapUv:"number",transmissionMapTiling:"vec2",transmissionMapOffset:"vec2",transmissionMapMappingType:"enum:textureMappingType",transmissionMapRadian:"number",transmissionMapMappingTranslation:"vec3",transmissionMapMappingRotation:"vec3",transmissionMapMappingScale:"vec3",transmissionMapGizmoPlanePosWS:"vec3",transmissionMapPlaneMappingDepth:"number",transmissionMapCameraMappingLock:"boolean",transmissionMapReverseMode:"enum:textureMappingReverseMode",transmissionMapTilingMode:"enum:textureMappingTilingMode",thicknessTint:"boolean",thicknessVertexColor:"boolean",thicknessVertexColorChannel:"string",thicknessMap:"texture",thicknessMapChannel:"string",thicknessMapUv:"number",thicknessMapTiling:"vec2",thicknessMapOffset:"vec2",thicknessMapMappingType:"enum:textureMappingType",thicknessMapRadian:"number",thicknessMapMappingTranslation:"vec3",thicknessMapMappingRotation:"vec3",thicknessMapMappingScale:"vec3",thicknessMapGizmoPlanePosWS:"vec3",thicknessMapPlaneMappingDepth:"number",thicknessMapCameraMappingLock:"boolean",thicknessMapReverseMode:"enum:textureMappingReverseMode",thicknessMapTilingMode:"enum:textureMappingTilingMode",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",metalnessMapMappingType:"enum:textureMappingType",metalnessMapRadian:"number",metalnessMapMappingTranslation:"vec3",metalnessMapMappingRotation:"vec3",metalnessMapMappingScale:"vec3",metalnessMapGizmoPlanePosWS:"vec3",metalnessMapPlaneMappingDepth:"number",metalnessMapCameraMappingLock:"boolean",metalnessMapReverseMode:"enum:textureMappingReverseMode",metalnessMapTilingMode:"enum:textureMappingTilingMode",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",glossMapMappingType:"enum:textureMappingType",glossMapRadian:"number",glossMapMappingTranslation:"vec3",glossMapMappingRotation:"vec3",glossMapMappingScale:"vec3",glossMapGizmoPlanePosWS:"vec3",glossMapPlaneMappingDepth:"number",glossMapCameraMappingLock:"boolean",glossMapReverseMode:"enum:textureMappingReverseMode",glossMapTilingMode:"enum:textureMappingTilingMode",roughness:"number",roughnessTint:"boolean",roughnessVertexColor:"boolean",roughnessVertexColorChannel:"string",roughnessMap:"texture",roughnessMapChannel:"string",roughnessMapUv:"number",roughnessMapTiling:"vec2",roughnessMapOffset:"vec2",roughnessMapMappingType:"enum:textureMappingType",roughnessMapRadian:"number",roughnessMapMappingTranslation:"vec3",roughnessMapMappingRotation:"vec3",roughnessMapMappingScale:"vec3",roughnessMapGizmoPlanePosWS:"vec3",roughnessMapPlaneMappingDepth:"number",roughnessMapCameraMappingLock:"boolean",roughnessMapReverseMode:"enum:textureMappingReverseMode",roughnessMapTilingMode:"enum:textureMappingTilingMode",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatMapMappingType:"enum:textureMappingType",clearCoatMapRadian:"number",clearCoatMapMappingTranslation:"vec3",clearCoatMapMappingRotation:"vec3",clearCoatMapMappingScale:"vec3",clearCoatMapGizmoPlanePosWS:"vec3",clearCoatMapPlaneMappingDepth:"number",clearCoatMapCameraMappingLock:"boolean",clearCoatMapReverseMode:"enum:textureMappingReverseMode",clearCoatMapTilingMode:"enum:textureMappingTilingMode",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatGlossMapMappingType:"enum:textureMappingType",clearCoatGlossMapRadian:"number",clearCoatGlossMapMappingTranslation:"vec3",clearCoatGlossMapMappingRotation:"vec3",clearCoatGlossMapMappingScale:"vec3",clearCoatGlossMapGizmoPlanePosWS:"vec3",clearCoatGlossMapPlaneMappingDepth:"number",clearCoatGlossMapCameraMappingLock:"boolean",clearCoatGlossMapReverseMode:"enum:textureMappingReverseMode",clearCoatGlossMapTilingMode:"enum:textureMappingTilingMode",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",clearCoatNormalMapMappingType:"enum:textureMappingType",clearCoatNormalMapRadian:"number",clearCoatNormalMapMappingTranslation:"vec3",clearCoatNormalMapMappingRotation:"vec3",clearCoatNormalMapMappingScale:"vec3",clearCoatNormalMapGizmoPlanePosWS:"vec3",clearCoatNormalMapPlaneMappingDepth:"number",clearCoatNormalMapCameraMappingLock:"boolean",clearCoatNormalMapReverseMode:"enum:textureMappingReverseMode",clearCoatNormalMapTilingMode:"enum:textureMappingTilingMode",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveMapMappingType:"enum:textureMappingType",emissiveMapRadian:"number",emissiveMapMappingTranslation:"vec3",emissiveMapMappingRotation:"vec3",emissiveMapMappingScale:"vec3",emissiveMapGizmoPlanePosWS:"vec3",emissiveMapPlaneMappingDepth:"number",emissiveMapCameraMappingLock:"boolean",emissiveMapReverseMode:"enum:textureMappingReverseMode",emissiveMapTilingMode:"enum:textureMappingTilingMode",emissiveIntensity:"number",normalMap:"texture",normalMapUv:"number",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapMappingType:"enum:textureMappingType",normalMapRadian:"number",normalMapMappingTranslation:"vec3",normalMapMappingRotation:"vec3",normalMapMappingScale:"vec3",normalMapGizmoPlanePosWS:"vec3",normalMapPlaneMappingDepth:"number",normalMapCameraMappingLock:"boolean",normalMapReverseMode:"enum:textureMappingReverseMode",normalMapTilingMode:"enum:textureMappingTilingMode",bumpiness:"number",normalDetailMap:"texture",normalDetailMapUv:"number",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapMappingType:"enum:textureMappingType",normalDetailMapRadian:"number",normalDetailMapMappingTranslation:"vec3",normalDetailMapMappingRotation:"vec3",normalDetailMapMappingScale:"vec3",normalDetailMapGizmoPlanePosWS:"vec3",normalDetailMapPlaneMappingDepth:"number",normalDetailMapCameraMappingLock:"boolean",normalDetailMapReverseMode:"enum:textureMappingReverseMode",normalDetailMapTilingMode:"enum:textureMappingTilingMode",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapMappingType:"enum:textureMappingType",heightMapRadian:"number",heightMapMappingTranslation:"vec3",heightMapMappingRotation:"vec3",heightMapMappingScale:"vec3",heightMapGizmoPlanePosWS:"vec3",heightMapPlaneMappingDepth:"number",heightMapCameraMappingLock:"boolean",heightMapReverseMode:"enum:textureMappingReverseMode",heightMapTilingMode:"enum:textureMappingTilingMode",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",opacityMapMappingType:"enum:textureMappingType",opacityMapRadian:"number",opacityMapMappingTranslation:"vec3",opacityMapMappingRotation:"vec3",opacityMapMappingScale:"vec3",opacityMapGizmoPlanePosWS:"vec3",opacityMapPlaneMappingDepth:"number",opacityMapCameraMappingLock:"boolean",opacityMapReverseMode:"enum:textureMappingReverseMode",opacityMapTilingMode:"enum:textureMappingTilingMode",opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",lightMapMappingType:"enum:textureMappingType",lightMapRadian:"number",lightMapMappingTranslation:"vec3",lightMapMappingRotation:"vec3",lightMapMappingScale:"vec3",lightMapGizmoPlanePosWS:"vec3",lightMapPlaneMappingDepth:"number",lightMapCameraMappingLock:"boolean",lightMapReverseMode:"enum:textureMappingReverseMode",lightMapTilingMode:"enum:textureMappingTilingMode",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useClearCoat:"boolean",uClearCoatFactor:"number",uClearCoatIor:"number",uClearCoatF0:"number",uClearCoatReflection:"number",uClearCoatF0Radio:"number",uClearCoatThickness:"number",uClearCoatColor:"rgb",uClearCoatMap:"texture",uClearCoatMapChannel:"string",uClearCoatMapUv:"number",uClearCoatMapTiling:"vec2",uClearCoatMapOffset:"vec2",uClearCoatMapMappingType:"enum:textureMappingType",uClearCoatMapRadian:"number",uClearCoatMapMappingTranslation:"vec3",uClearCoatMapMappingRotation:"vec3",uClearCoatMapMappingScale:"vec3",uClearCoatMapGizmoPlanePosWS:"vec3",uClearCoatMapPlaneMappingDepth:"number",uClearCoatMapCameraMappingLock:"boolean",uClearCoatMapReverseMode:"enum:textureMappingReverseMode",uClearCoatMapTilingMode:"enum:textureMappingTilingMode",uClearCoatFresnelPower:"number",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture",ior:"number",transmission:"number",thickness:"number",attenuationDistance:"number",attenuationColor:"rgb",diffuseTransmission:"rgb",specularTransmission:"rgb",subsurfaceColor:"rgb",PBR_type:"string"},Hi=[];for(Gi in Wi)"texture"===Wi[Gi]&&Hi.push(Gi);var ji=[];for(Gi in Wi)"cubemap"===Wi[Gi]&&ji.push(Gi);var Xi=function(){function e(){this._refCount=0}var t=e.prototype;return t.incRefCount=function(){this._refCount++},t.decRefCount=function(){this._refCount--},t.getRefCount=function(){return this._refCount},e}(),qi=function(){function e(e,t,i,n,a){void 0===n&&(n=0),this.device=e,this.format=t,this.numIndices=i,this.usage=n;var s,r=this.device.gl;0===t?(s=1,this.glFormat=r.UNSIGNED_BYTE):1===t?(s=2,this.glFormat=r.UNSIGNED_SHORT):2===t&&(s=4,this.glFormat=r.UNSIGNED_INT),this.bytesPerIndex=s,this.numBytes=this.numIndices*s,a?this.setData(a):this.storage=new ArrayBuffer(this.numBytes),e._vram.ib+=this.numBytes,this.device.buffers.push(this)}var t=e.prototype;return t.destroy=function(){var e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.bufferId&&(this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null))},t.loseContext=function(){this.bufferId=void 0},t.getFormat=function(){return this.format},t.getNumIndices=function(){return this.numIndices},t.lock=function(){return this.storage},t.unlock=function(){var e,t=this.device.gl;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case 0:e=t.STATIC_DRAW;break;case 1:e=t.DYNAMIC_DRAW;break;case 2:e=t.STREAM_DRAW;break;case 3:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.bufferId),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.storage,e)},t.setData=function(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)},t._lockTypedArray=function(){var e=this.lock();return 2===this.format?new Uint32Array(e):1===this.format?new Uint16Array(e):new Uint8Array(e)},t.writeData=function(e,t){var i=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),i.set(e);else for(var n=0;n<t;n++)i[n]=e[n];else i.set(e);this.unlock()},t.readData=function(e){var t=this._lockTypedArray(),i=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else for(var n=e.length=0;n<i;n++)e[n]=t[n];return i},e}(),$i=0,Yi=function(){function e(){this.initDefaults()}var t=e.prototype;return t.initDefaults=function(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null},t._validateVertexCount=function(e,t){},t._changeVertexCount=function(e,t){this.vertexCount?this._validateVertexCount(e,t):this.vertexCount=e},e}();Yi.DEFAULT_COMPONENTS_POSITION=3,Yi.DEFAULT_COMPONENTS_NORMAL=3,Yi.DEFAULT_COMPONENTS_UV=2,Yi.DEFAULT_COMPONENTS_COLORS=4;var Ki=function(e,t,i,n){this.data=e,this.componentCount=t,this.dataType=i,this.dataTypeNormalize=n},Zi=function(i){function e(e){var t;return(t=i.call(this)||this).id=$i++,t.device=e||hi().graphicsDevice,t.vertexBuffer=null,t.indexBuffer=[null],t.primitive=[{type:0,base:0,count:0}],t.skin=null,t.morph=null,t._geometryData=null,t._aabb=new ue,t.boneAabb=null,t}u(e,i);var t=e.prototype;return t.destroy=function(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(var e=0;e<this.indexBuffer.length;e++)this._destroyIndexBuffer(e);this.indexBuffer.length=0,this._geometryData=null,this._aabb=null},t._destroyIndexBuffer=function(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)},t._initBoneAabbs=function(e){this.boneAabb=[],this.boneUsed=[];var t,i,n,a,s,r,o,l,h,c,u,d,p,f,m,v,g,_,y,b,x,M=this.vertexBuffer.numVertices,S=[],w=[],C=this.boneUsed,P=this.skin.boneNames.length;for(t=0;t<P;t++)S[t]=new de(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),w[t]=new de(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);var T=new Ct(this.vertexBuffer),A=T.element.POSITION,E=T.element.BLENDWEIGHT,R=T.element.BLENDINDICES;for(i=0;i<M;i++){for(n=0;n<4;n++)if(0<E.array[E.index+n]&&(C[u=R.array[R.index+n]]=!0,s=A.array[A.index],r=A.array[A.index+1],o=A.array[A.index+2],l=w[u],(h=S[u]).x>s&&(h.x=s),h.y>r&&(h.y=r),h.z>o&&(h.z=o),l.x<s&&(l.x=s),l.y<r&&(l.y=r),l.z<o&&(l.z=o),e)){for(d=m=s,p=v=r,f=g=o,a=0;a<e.length;a++)(_=(x=e[a]).deltaPositions[3*i])<0?d+=_:m+=_,(y=x.deltaPositions[3*i+1])<0?p+=y:v+=y,(b=x.deltaPositions[3*i+2])<0?f+=b:g+=b;h.x>d&&(h.x=d),h.y>p&&(h.y=p),h.z>f&&(h.z=f),l.x<m&&(l.x=m),l.y<v&&(l.y=v),l.z<g&&(l.z=g)}T.next()}for(t=0;t<P;t++)(c=new ue).setMinMax(S[t],w[t]),this.boneAabb.push(c)},t._initGeometryData=function(){this._geometryData||(this._geometryData=new Yi,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),0<this.indexBuffer.length&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))},t.clear=function(e,t,i,n){void 0===i&&(i=0),void 0===n&&(n=0),this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=i,this._geometryData.maxIndices=n,this._geometryData.verticesUsage=e?0:1,this._geometryData.indicesUsage=t?0:1},t.setVertexStream=function(e,t,i,n,a,s){void 0===a&&(a=6),void 0===s&&(s=!1),this._initGeometryData();var r=n||t.length/i;this._geometryData._changeVertexCount(r,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new Ki(t,i,a,s)},t.getVertexStream=function(e,t){var i=0,n=!1;if(this._geometryData){var a=this._geometryData.vertexStreamDictionary[e];a&&(n=!0,i=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(a.data):(t.length=0,t.push(a.data)))}return n||this.vertexBuffer&&(i=new Ct(this.vertexBuffer).readData(e,t)),i},t.setPositions=function(e,t,i){void 0===t&&(t=Yi.DEFAULT_COMPONENTS_POSITION),this.setVertexStream(Te,e,t,i,6,!1)},t.setNormals=function(e,t,i){void 0===t&&(t=Yi.DEFAULT_COMPONENTS_NORMAL),this.setVertexStream(Ae,e,t,i,6,!1)},t.setUvs=function(e,t,i,n){void 0===i&&(i=Yi.DEFAULT_COMPONENTS_UV),this.setVertexStream(ke+e,t,i,n,6,!1)},t.setColors=function(e,t,i){void 0===t&&(t=Yi.DEFAULT_COMPONENTS_COLORS),this.setVertexStream(Ie,e,t,i,6,!1)},t.setColors32=function(e,t){this.setVertexStream(Ie,e,Yi.DEFAULT_COMPONENTS_COLORS,t,1,!0)},t.setIndices=function(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length},t.getPositions=function(e){return this.getVertexStream(Te,e)},t.getNormals=function(e){return this.getVertexStream(Ae,e)},t.getUvs=function(e,t){return this.getVertexStream(ke+e,t)},t.getColors=function(e){return this.getVertexStream(Ie,e)},t.getIndices=function(e){var t=0;if(this._geometryData&&this._geometryData.indices){var i=this._geometryData.indices;t=this._geometryData.indexCount,ArrayBuffer.isView(e)?e.set(i):(e.length=0,e.push(i))}else 0<this.indexBuffer.length&&this.indexBuffer[0]&&(t=this.indexBuffer[0].readData(e));return t},t.update=function(e,t){if(void 0===e&&(e=4),void 0===t&&(t=!0),this._geometryData){if(t){var i=this._geometryData.vertexStreamDictionary.POSITION;i&&3===i.componentCount&&this._aabb.compute(i.data,this._geometryData.vertexCount)}var n=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(n=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),n&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);var a=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(a=!0,this._geometryData.maxIndices=this._geometryData.indexCount),a&&0<this.indexBuffer.length&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,0<this.indexBuffer.length&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}},t._buildVertexFormat=function(e){var t=[];for(var i in this._geometryData.vertexStreamDictionary){var n=this._geometryData.vertexStreamDictionary[i];t.push({semantic:i,components:n.componentCount,type:n.dataType,normalize:n.dataTypeNormalize})}return new ut(this.device,t,e)},t._updateVertexBuffer=function(){if(!this.vertexBuffer){var e=this._geometryData.maxVertices,t=this._buildVertexFormat(e);this.vertexBuffer=new ht(this.device,t,e,this._geometryData.verticesUsage)}var i=new Ct(this.vertexBuffer),n=this._geometryData.vertexCount;for(var a in this._geometryData.vertexStreamDictionary){var s=this._geometryData.vertexStreamDictionary[a];i.writeData(a,s.data,n),delete this._geometryData.vertexStreamDictionary[a]}i.end()},t._updateIndexBuffer=function(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){var e=65535<this._geometryData.maxVertices?2:1;this.indexBuffer[0]=new qi(this.device,e,this._geometryData.maxIndices,this._geometryData.indicesUsage)}var t=this._geometryData.indices;t&&(this.indexBuffer[0].writeData(t,this._geometryData.indexCount),this._geometryData.indices=null)},t.prepareRenderState=function(e){1===e?this.generateWireframe():2===e&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})},t.updateRenderStates=function(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)},t.generateWireframe=function(){this._destroyIndexBuffer(1);var e,t=[];if(0<this.indexBuffer.length&&this.indexBuffer[0]){for(var i=[[0,1],[1,2],[2,0]],n=this.primitive[0].base,a=this.primitive[0].count,s=this.indexBuffer[0],r=new rt[s.format](s.storage),o={},l=n;l<n+a;l+=3)for(var h=0;h<3;h++){var c=r[l+i[h][0]],u=r[l+i[h][1]],d=u<c?u<<16|c:c<<16|u;void 0===o[d]&&(o[d]=0,t.push(c,u))}e=s.format}else{for(var p=0;p<this.vertexBuffer.numVertices;p+=3)t.push(p,p+1,p+1,p+2,p+2,p);e=65535<t.length?2:1}var f=new qi(this.vertexBuffer.device,e,t.length);new rt[f.format](f.storage).set(t),f.unlock(),this.primitive[1]={type:1,base:0,count:t.length,indexed:!0},this.indexBuffer[1]=f},c(e,[{key:"aabb",get:function(){return this._aabb},set:function(e){this._aabb=e}}]),e}(Xi),Qi=function(){function e(){this.cache=new Map}var t=e.prototype;return t.destroy=function(){this.cache.forEach(function(e,t){t.destroy()}),this.cache.clear()},t.incRef=function(e){var t=(this.cache.get(e)||0)+1;this.cache.set(e,t)},t.decRef=function(e){if(e){var t=this.cache.get(e);t&&(0==--t?(this.cache.delete(e),e.destroy()):this.cache.set(e,t))}},e}(),Ji=new pe,en=new de,tn=new fe,nn=new fe,an=new de,sn=new de,rn=new pe,on=new fe,ln=new de,hn=new pe,cn=new fe,un=new fe,dn=new pe,pn=new de,fn=new de,mn=function(i){function t(e){var t;return(t=i.call(this)||this).name="string"==typeof e?e:"Untitled",t.tags=new G(g(t)),t._labels={},t.localPosition=new de(0,0,0),t.localRotation=new fe(0,0,0,1),t.localScale=new de(1,1,1),t.localEulerAngles=new de(0,0,0),t.position=new de(0,0,0),t.rotation=new fe(0,0,0,1),t.eulerAngles=new de(0,0,0),t._scale=null,t.localTransform=new pe,t._dirtyLocal=!1,t._aabbVer=0,t._frozen=!1,t.worldTransform=new pe,t._dirtyWorld=!1,t.normalMatrix=new Q,t._dirtyNormal=!0,t._right=null,t._up=null,t._forward=null,t._parent=null,t._children=[],t._graphDepth=0,t._enabled=!0,t._enabledInHierarchy=!1,t.scaleCompensation=!1,t}u(t,i);var e=t.prototype;return e._notifyHierarchyStateChanged=function(e,t){e._onHierarchyStateChanged(t);for(var i=e._children,n=0,a=i.length;n<a;n++)i[n]._enabled&&this._notifyHierarchyStateChanged(i[n],t)},e._onHierarchyStateChanged=function(e){(this._enabledInHierarchy=e)&&!this._frozen&&this._unfreezeParentToRoot()},e._cloneInternal=function(e){e.name=this.name;var t=this.tags._list;e.tags.clear();for(var i=0;i<t.length;i++)e.tags.add(t[i]);e._labels=Object.assign({},this._labels),e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1},e.clone=function(){var e=new t;return this._cloneInternal(e),e},e.copy=function(e){return e._cloneInternal(this),this},e.find=function(e,t){var i,n,a=[],s=this._children.length;if(e instanceof Function){var r=e;for(r(this)&&a.push(this),i=0;i<s;i++)(n=this._children[i].find(r)).length&&(a=a.concat(n))}else for(this[e]&&(this[e]instanceof Function?this[e]():this[e])===t&&a.push(this),i=0;i<s;++i)(n=this._children[i].find(e,t)).length&&(a=a.concat(n));return a},e.findOne=function(e,t){var i,n=this._children.length,a=null;if(e instanceof Function){var s=e;if(a=s(this))return this;for(i=0;i<n;i++)if(a=this._children[i].findOne(s))return a}else{if(this[e]&&(this[e]instanceof Function?this[e]():this[e])===t)return this;for(i=0;i<n;i++)if(null!==(a=this._children[i].findOne(e,t)))return a}return null},e.findByTag=function(){var e=this.tags._processArguments(arguments);return this._findByTag(e)},e._findByTag=function(e){var t,i,n=[],a=this._children.length;for(t=0;t<a;t++)this._children[t].tags._has(e)&&n.push(this._children[t]),(i=this._children[t]._findByTag(e)).length&&(n=n.concat(i));return n},e.findByName=function(e){if(this.name===e)return this;for(var t=0;t<this._children.length;t++){var i=this._children[t].findByName(e);if(null!==i)return i}return null},e.findByPath=function(e){var t;if(Array.isArray(e)){if(0===e.length)return null;t=e}else t=e.split("/");for(var i=this,n=null,a=0,s=t.length;a<s&&i;a++){var r=t[a];n=null;for(var o=i._children,l=0,h=o.length;l<h;l++)if(o[l].name===r){n=o[l];break}i=n}return n},e.forEach=function(e,t){e.call(t,this);for(var i=this._children,n=0;n<i.length;n++)i[n].forEach(e,t)},e.isDescendantOf=function(e){for(var t=this._parent;t;){if(t===e)return!0;t=t._parent}return!1},e.isAncestorOf=function(e){return e.isDescendantOf(this)},e.getEulerAngles=function(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles},e.getLocalEulerAngles=function(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles},e.getLocalPosition=function(){return this.localPosition},e.getLocalRotation=function(){return this.localRotation},e.getLocalScale=function(){return this.localScale},e.getLocalTransform=function(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform},e.getPosition=function(){return this.getWorldTransform().getTranslation(this.position),this.position},e.getRotation=function(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation},e.getScale=function(){return this._scale||(this._scale=new de),this.getWorldTransform().getScale(this._scale)},e.getWorldTransform=function(){return(this._dirtyLocal||this._dirtyWorld)&&(this._parent&&this._parent.getWorldTransform(),this._sync()),this.worldTransform},e.reparent=function(e,t){var i=this._parent;i&&i.removeChild(this),e&&(0<=t?e.insertChild(this,t):e.addChild(this))},e.setLocalEulerAngles=function(e,t,i){e instanceof de?this.localRotation.setFromEulerAngles(e.x,e.y,e.z):this.localRotation.setFromEulerAngles(e,t,i),this._dirtyLocal||this._dirtifyLocal()},e.setLocalPosition=function(e,t,i){e instanceof de?this.localPosition.copy(e):this.localPosition.set(e,t,i),this._dirtyLocal||this._dirtifyLocal()},e.setLocalRotation=function(e,t,i,n){e instanceof fe?this.localRotation.copy(e):this.localRotation.set(e,t,i,n),this._dirtyLocal||this._dirtifyLocal()},e.setLocalScale=function(e,t,i){e instanceof de?this.localScale.copy(e):this.localScale.set(e,t,i),this._dirtyLocal||this._dirtifyLocal()},e._dirtifyLocal=function(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())},e._unfreezeParentToRoot=function(){for(var e=this._parent;e;)e._frozen=!1,e=e._parent},e._dirtifyWorld=function(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()},e._dirtifyWorldInternal=function(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(var e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._aabbVer++},e.setPosition=function(e,t,i){e instanceof de?ln.copy(e):ln.set(e,t,i),null===this._parent?this.localPosition.copy(ln):(hn.copy(this._parent.getWorldTransform()).invert(),hn.transformPoint(ln,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()},e.setRotation=function(e,t,i,n){if(e instanceof fe?cn.copy(e):cn.set(e,t,i,n),null===this._parent)this.localRotation.copy(cn);else{var a=this._parent.getRotation();un.copy(a).invert(),this.localRotation.copy(un).mul(cn)}this._dirtyLocal||this._dirtifyLocal()},e.setEulerAngles=function(e,t,i){if(e instanceof de?this.localRotation.setFromEulerAngles(e.x,e.y,e.z):this.localRotation.setFromEulerAngles(e,t,i),null!==this._parent){var n=this._parent.getRotation();un.copy(n).invert(),this.localRotation.mul2(un,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()},e.addChild=function(e){if(null!==e._parent)throw new Error("GraphNode is already parented");this._children.push(e),this._onInsertChild(e)},e.addChildAndSaveTransform=function(e){var t=e.getPosition(),i=e.getRotation(),n=e._parent;n&&n.removeChild(e),e.setPosition(rn.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(on.copy(this.getRotation()).invert().mul(i)),this._children.push(e),this._onInsertChild(e)},e.insertChild=function(e,t){if(null!==e._parent)throw new Error("GraphNode is already parented");this._children.splice(t,0,e),this._onInsertChild(e)},e._onInsertChild=function(e){e._parent=this;var t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e.fire&&e.fire("insert",this),this.fire&&this.fire("childinsert",e)},e._updateGraphDepth=function(){this._parent?this._graphDepth=this._parent._graphDepth+1:this._graphDepth=0;for(var e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()},e.removeChild=function(e){var t,i=this._children.length;for(t=0;t<i;++t)if(this._children[t]===e)return this._children.splice(t,1),e._parent=null,e.fire&&e.fire("remove",this),void(this.fire&&this.fire("childremove",e))},e._sync=function(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var e,t=this._parent,i=this.localScale,n=t;if(n){for(;n&&n.scaleCompensation;)n=n._parent;n&&(n=n._parent)&&(e=n.worldTransform.getScale(),an.mul2(e,this.localScale),i=an)}nn.setFromMat4(t.worldTransform),tn.mul2(nn,this.localRotation);var a=t.worldTransform;t.scaleCompensation&&(sn.mul2(e,t.getLocalScale()),Ji.setTRS(t.worldTransform.getTranslation(en),nn,sn),a=Ji),a.transformPoint(this.localPosition,en),this.worldTransform.setTRS(en,tn,i)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}},e.syncHierarchy=function(){if(this._enabled&&!this._frozen){this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var e=this._children,t=0,i=e.length;t<i;t++)e[t].syncHierarchy()}},e.lookAt=function(e,t,i,n,a,s){if(void 0===n&&(n=0),void 0===a&&(a=1),void 0===s&&(s=0),e instanceof de)pn.copy(e),t instanceof de?fn.copy(t):fn.copy(de.UP);else{if(void 0===i)return;pn.set(e,t,i),fn.set(n,a,s)}dn.setLookAt(this.getPosition(),pn,fn),cn.setFromMat4(dn),this.setRotation(cn)},e.translate=function(e,t,i){e instanceof de?ln.copy(e):ln.set(e,t,i),ln.add(this.getPosition()),this.setPosition(ln)},e.translateLocal=function(e,t,i){e instanceof de?ln.copy(e):ln.set(e,t,i),this.localRotation.transformVector(ln,ln),this.localPosition.add(ln),this._dirtyLocal||this._dirtifyLocal()},e.rotate=function(e,t,i){if(e instanceof de?cn.setFromEulerAngles(e.x,e.y,e.z):cn.setFromEulerAngles(e,t,i),null===this._parent)this.localRotation.mul2(cn,this.localRotation);else{var n=this.getRotation(),a=this._parent.getRotation();un.copy(a).invert(),cn.mul2(un,cn),this.localRotation.mul2(cn,n)}this._dirtyLocal||this._dirtifyLocal()},e.rotateLocal=function(e,t,i){e instanceof de?cn.setFromEulerAngles(e.x,e.y,e.z):cn.setFromEulerAngles(e,t,i),this.localRotation.mul(cn),this._dirtyLocal||this._dirtifyLocal()},c(t,[{key:"right",get:function(){return this._right||(this._right=new de),this.getWorldTransform().getX(this._right).normalize()}},{key:"up",get:function(){return this._up||(this._up=new de),this.getWorldTransform().getY(this._up).normalize()}},{key:"forward",get:function(){return this._forward||(this._forward=new de),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}},{key:"enabled",get:function(){return this._enabled&&this._enabledInHierarchy},set:function(e){this._enabled!==e&&(this._enabled=e,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,e))}},{key:"parent",get:function(){return this._parent}},{key:"path",get:function(){var e=this._parent;if(e){for(var t=this.name;e&&e._parent;)t=e.name+"/"+t,e=e._parent;return t}return""}},{key:"root",get:function(){var e=this._parent;if(!e)return this;for(;e._parent;)e=e._parent;return e}},{key:"children",get:function(){return this._children}},{key:"graphDepth",get:function(){return this._graphDepth}}]),t}(p),vn=new ue,gn=new ue,_n=new ge,yn=new Set,bn=function(e){this.count=e,this.vertexBuffer=null},xn=function(){function e(e,t,i){this._key=[],this._key[0]=Sn(e,t,!0,0),this.command=i}return c(e,[{key:"key",get:function(){return this._key[0]},set:function(e){this._key[0]=e}}]),e}(),Mn=function(){function n(e,t,i){if(void 0===i&&(i=null),e instanceof mn){var n=e;e=t,t=i,i=n}this._key=[0,0],this._shader=[null,null,null],this.isStatic=!1,this._staticLightList=null,this._staticSource=null,(((this.node=i).meshInstance=this)._mesh=e).incRefCount(),this.material=t,this._shaderDefs=65536,this._shaderDefs|=e.vertexBuffer.format.hasUv0?4:0,this._shaderDefs|=e.vertexBuffer.format.hasUv1?8:0,this._shaderDefs|=e.vertexBuffer.format.hasColor?16:0,this._shaderDefs|=e.vertexBuffer.format.hasTangents?512:0,this._lightHash=0,this.visible=!0,this.layer=15,this._renderStyle=0,this.castShadow=!1,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new ue,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=0,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFaces=!1}n.incRefLightmap=function(e){this._lightmapCache.incRef(e)},n.decRefLightmap=function(e){this._lightmapCache.decRef(e)},n.destroyLightmapCache=function(){this._lightmapCache.destroy()},n._prepareRenderStyleForArray=function(e,t){if(e){for(var i=0;i<e.length;i++){e[i]._renderStyle=t;var n=e[i].mesh;yn.has(n)||(yn.add(n),n.prepareRenderState(t))}yn.clear()}};var e=n.prototype;return e.destroy=function(){var e=this.mesh;e&&(this.mesh=null,e.getRefCount()<1&&e.destroy()),this.setRealtimeLightmap(n.lightmapParamNames[0],null),this.setRealtimeLightmap(n.lightmapParamNames[1],null),this._skinInstance&&(this._skinInstance.destroy(),this._skinInstance=null),this.morphInstance&&(this.morphInstance.destroy(),this.morphInstance=null),this.material=null},e.syncAabb=function(){},e._isVisible=function(e){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(e):(_n.center=this.aabb.center,_n.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(_n)))},e.updateKey=function(){var e=this.material;this._key[0]=Sn(this.layer,e.alphaToCoverage||e.alphaTest?2:e.blendType,!1,e.id)},e.setInstancing=function(e){e?(this.instancingData=new bn(e.numVertices),(this.instancingData.vertexBuffer=e).instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)},e.clearParameters=function(){this.parameters={}},e.getParameters=function(){return this.parameters},e.getParameter=function(e){return this.parameters[e]},e.setParameter=function(e,t,i){if(void 0===i&&(i=-262141),void 0===t&&"object"==(void 0===e?"undefined":dx(e))){var n=e;if(n.length){for(var a=0;a<n.length;a++)this.setParameter(n[a]);return}e=n.name,t=n.value}var s=this.parameters[e];s?(s.data=t,s.passFlags=i):this.parameters[e]={scopeId:null,data:t,passFlags:i}},e.setRealtimeLightmap=function(e,t){var i=this.getParameter(e);i!==t&&(i&&n.decRefLightmap(i.data),t?(n.incRefLightmap(t),this.setParameter(e,t)):this.deleteParameter(e))},e.deleteParameter=function(e){this.parameters[e]&&delete this.parameters[e]},e.setParameters=function(e,t){var i,n=this.parameters;for(var a in n)(i=n[a]).passFlags&t&&(i.scopeId||(i.scopeId=e.scope.resolve(a)),i.scopeId.setValue(i.data))},e.setLightmapped=function(e){e?this.mask=-6&(2|this.mask):(this.setRealtimeLightmap(n.lightmapParamNames[0],null),this.setRealtimeLightmap(n.lightmapParamNames[1],null),this._shaderDefs&=-193,this.mask=-7&(1|this.mask))},e.setCustomAabb=function(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()},e._setupSkinUpdate=function(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)},c(n,[{key:"renderStyle",get:function(){return this._renderStyle},set:function(e){this._renderStyle=e,this.mesh.prepareRenderState(e)}},{key:"mesh",get:function(){return this._mesh},set:function(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),(this._mesh=e)&&e.incRefCount())}},{key:"aabb",get:function(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);var e=this._customAabb,t=!!e;if(!e)if(e=vn,this.skinInstance){if(!this.mesh.boneAabb){var i=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(i)}for(var n=this.mesh.boneUsed,a=!0,s=0;s<this.mesh.boneAabb.length;s++)n[s]&&(gn.setFromTransformedAabb(this.mesh.boneAabb[s],this.skinInstance.matrices[s]),a?(a=!1,e.center.copy(gn.center),e.halfExtents.copy(gn.halfExtents)):e.add(gn));t=!0}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&e._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),t=!0,this._aabbVer=this.node._aabbVer);return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb},set:function(e){this._aabb=e}},{key:"material",get:function(){return this._material},set:function(e){for(var t=0;t<this._shader.length;t++)this._shader[t]=null;var i=this._material;if(i&&i.removeMeshInstanceRef(this),this._material=e,this._material&&(this._material.addMeshInstanceRef(this),this.updateKey(),(i&&3!==i.blendType)!==(3!==this._material.blendType))){var n=this._material._scene;!n&&i&&i._scene&&(n=i._scene),n?n.layers._dirtyBlend=!0:this._material._dirtyBlend=!0}}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this.updateKey()}},{key:"calculateSortDistance",get:function(){return this._calculateSortDistance},set:function(e){this._calculateSortDistance=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e,this._shaderDefs=e?-2&this._shaderDefs:1|this._shaderDefs,this._shader[0]=null,this._shader[1]=null}},{key:"skinInstance",get:function(){return this._skinInstance},set:function(e){this._skinInstance=e,this._shaderDefs=e?2|this._shaderDefs:-3&this._shaderDefs;for(var t=0;t<this._shader.length;t++)this._shader[t]=null;this._setupSkinUpdate()}},{key:"morphInstance",get:function(){return this._morphInstance},set:function(e){this._morphInstance=e,this._morphInstance&&(this._morphInstance.meshInstance=this),this._shaderDefs=e&&e.morph.useTextureMorph?4096|this._shaderDefs:-4097&this._shaderDefs,this._shaderDefs=e&&e.morph.morphPositions?1024|this._shaderDefs:-1025&this._shaderDefs,this._shaderDefs=e&&e.morph.morphNormals?2048|this._shaderDefs:-2049&this._shaderDefs;for(var t=0;t<this._shader.length;t++)this._shader[t]=null}},{key:"screenSpace",get:function(){return this._screenSpace},set:function(e){this._screenSpace=e,this._shaderDefs=e?256|this._shaderDefs:-257&this._shaderDefs,this._shader[0]=null}},{key:"key",get:function(){return this._key[0]},set:function(e){this._key[0]=e}},{key:"mask",get:function(){return this._shaderDefs>>16},set:function(e){var t=65535&this._shaderDefs;this._shaderDefs=t|e<<16,this._shader[0]=null,this._shader[1]=null}},{key:"instancingCount",get:function(){return this.instancingData?this.instancingData.count:0},set:function(e){this.instancingData&&(this.instancingData.count=e)}}]),n}();function Sn(e,t,i,n){return(15&e)<<27|(3===t?1:0)<<26|(i?1:0)<<25|(33554431&n)<<0}Mn.lightmapParamNames=["texture_lightMap","texture_dirLightMap"],Mn._lightmapCache=new Qi;var wn=function(){function e(e,t,i){this.origMeshInstances=e,this._aabb=new ue,this.meshInstance=null,this.dynamic=t,this.batchGroupId=i}var t=e.prototype;return t.destroy=function(e,t){this.meshInstance&&(this.removeFromLayers(e,t),this.meshInstance.destroy())},t.addToLayers=function(e,t){for(var i=0;i<t.length;i++){var n=e.layers.getLayerById(t[i]);n&&n.addMeshInstances([this.meshInstance])}},t.removeFromLayers=function(e,t){for(var i=0;i<t.length;i++){var n=e.layers.getLayerById(t[i]);n&&n.removeMeshInstances([this.meshInstance])}},t.updateBoundingBox=function(){this._aabb.copy(this.origMeshInstances[0].aabb);for(var e=1;e<this.origMeshInstances.length;e++)this._aabb.add(this.origMeshInstances[e].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0},e}(),Cn=function(e,t,i,n,a){void 0===a&&(a=[0]),this.dynamic=i,this.maxAabbSize=n,this.id=e,this.name=t,this.layers=a,this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]}};Cn.MODEL="model",Cn.ELEMENT="element",Cn.SPRITE="sprite",Cn.RENDER="render";var Pn=new pe,Tn=function(){function e(e){this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,e&&this.initSkin(e)}var t=e.prototype;return t.init=function(e,t){if(e.supportsBoneTextures){var i=3*t,n=Math.ceil(Math.sqrt(i));n=Se.roundUp(n,3);var a=Math.ceil(i/n);this.boneTexture=new Kt(e,{width:n,height:a,format:Ce,mipmaps:!1,minFilter:0,magFilter:0}),this.boneTexture.name="skin",this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(12*t)},t.destroy=function(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)},t.resolve=function(e,t){this.rootBone=e;for(var i=this.skin,n=[],a=0;a<i.boneNames.length;a++){var s=i.boneNames[a],r=e.findByName(s);r||(r=t),n.push(r)}this.bones=n},t.initSkin=function(e){this.skin=e,this.bones=[];var t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(var i=0;i<t;i++)this.matrices[i]=new pe},t.uploadBones=function(e){e.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())},t._updateMatrices=function(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,Pn.copy(e.getWorldTransform()).invert();for(var i=this.bones.length-1;0<=i;i--)this.matrices[i].mulAffine2(Pn,this.bones[i].getWorldTransform()),this.matrices[i].mulAffine2(this.matrices[i],this.skin.inverseBindPose[i])}},t.updateMatrices=function(e,t){this._updateBeforeCull&&this._updateMatrices(e,t)},t.updateMatrixPalette=function(e,t){var i;this._updateMatrices(e,t);for(var n,a=this.matrixPalette,s=this.bones.length,r=0;r<s;r++)i=this.matrices[r].data,a[n=12*r]=i[0],a[n+1]=i[4],a[n+2]=i[8],a[n+3]=i[12],a[n+4]=i[1],a[n+5]=i[5],a[n+6]=i[9],a[n+7]=i[13],a[n+8]=i[2],a[n+9]=i[6],a[n+10]=i[10],a[n+11]=i[14];this.uploadBones(this.skin.device)},c(e,[{key:"rootBone",get:function(){return this._rootBone},set:function(e){this._rootBone=e}}]),e}(),An=function(s){function e(e,t,i){var n;n=s.call(this)||this;var a=t.length;return n.init(e,a),n.device=e,n.rootNode=i,n.bones=t,n}u(e,s);var t=e.prototype;return t.updateMatrices=function(e,t){},t.updateMatrixPalette=function(e,t){for(var i,n,a=this.matrixPalette,s=this.bones.length,r=0;r<s;r++)i=this.bones[r].getWorldTransform().data,a[n=12*r]=i[0],a[n+1]=i[4],a[n+2]=i[8],a[n+3]=i[12],a[n+4]=i[1],a[n+5]=i[5],a[n+6]=i[9],a[n+7]=i[13],a[n+8]=i[2],a[n+9]=i[6],a[n+10]=i[10],a[n+11]=i[14];this.uploadBones(this.device)},e}(Tn);function En(e,t){if(e&&!t)return!1;if(!e&&t)return!1;if((e=e.data)===(t=t.data))return!0;if(e instanceof Float32Array&&t instanceof Float32Array){if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}return!1}function Rn(e,t){var i;for(i in e)if(e.hasOwnProperty(i)&&!En(e[i],t[i]))return!1;for(i in t)if(t.hasOwnProperty(i)&&!En(t[i],e[i]))return!1;return!0}function Dn(e,t){var i;for(i=0;i<e.length;i++)if(t.indexOf(e[i])<0)return!1;for(i=0;i<t.length;i++)if(e.indexOf(t[i])<0)return!1;return!0}var In=new Q,kn=new de,Ln=new de,On=new de;function Fn(e){var t=e.node.worldTransform;return t.getX(kn),t.getY(Ln),t.getZ(On),kn.cross(kn,Ln),0<=kn.dot(On)?1:-1}var zn=function(){function e(e,t,i){this.device=e,this.rootNode=t,this.scene=i,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}var t=e.prototype;return t.destroy=function(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]},t.addGroup=function(e,t,i,n,a){var s;if(void 0===n&&(n=this._batchGroupCounter,this._batchGroupCounter++),!this._batchGroups[n])return this._batchGroups[n]=s=new Cn(n,e,t,i,a),s},t.removeGroup=function(e){if(this._batchGroups[e]){for(var t=[],i=0;i<this._batchList.length;i++)this._batchList[i].batchGroupId==e?this.destroyBatch(this._batchList[i]):t.push(this._batchList[i]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e]}},t.markGroupDirty=function(e){this._dirtyGroups.indexOf(e)<0&&this._dirtyGroups.push(e)},t.getGroupByName=function(e){var t=this._batchGroups;for(var i in t)if(t.hasOwnProperty(i)&&t[i].name===e)return t[i];return null},t.getBatches=function(e){for(var t=[],i=this._batchList.length,n=0;n<i;n++){var a=this._batchList[n];a.batchGroupId===e&&t.push(a)}return t},t._removeModelsFromBatchGroup=function(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.render&&e.render.batchGroupId===t&&(e.render.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(var i=0;i<e._children.length;i++)this._removeModelsFromBatchGroup(e._children[i],t)}},t.insert=function(e,t,i){var n=this._batchGroups[t];n&&n._obj[e].indexOf(i)<0&&(n._obj[e].push(i),this.markGroupDirty(t))},t.remove=function(e,t,i){var n=this._batchGroups[t];if(n){var a=n._obj[e].indexOf(i);0<=a&&(n._obj[e].splice(a,1),this.markGroupDirty(t))}},t._extractRender=function(e,t,i,n){if(e.render){if(e.render.isStatic){for(var a=this.scene.drawCalls,s=e.render.meshInstances,r=0;r<a.length;r++)a[r]._staticSource&&(s.indexOf(a[r]._staticSource)<0||t.push(a[r]));for(var o=0;o<s.length;o++)0<=a.indexOf(s[o])&&t.push(s[o])}else t=n[e.render.batchGroupId]=t.concat(e.render.meshInstances);e.render.removeFromLayers()}return t},t._extractModel=function(e,t,i,n){if(e.model&&e.model.model){if(e.model.isStatic){for(var a=this.scene.drawCalls,s=e.model.meshInstances,r=0;r<a.length;r++)a[r]._staticSource&&(s.indexOf(a[r]._staticSource)<0||t.push(a[r]));for(var o=0;o<s.length;o++)0<=a.indexOf(s[o])&&t.push(s[o])}else t=n[e.model.batchGroupId]=t.concat(e.model.meshInstances);e.model.removeModelFromLayers()}return t},t._extractElement=function(e,t,i){if(e.element){var n=!1;e.element._text&&0<e.element._text._model.meshInstances.length?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),n=!0):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),e.element._image._renderable.unmaskMeshInstance&&(t.push(e.element._image._renderable.unmaskMeshInstance),e.element._image._renderable.unmaskMeshInstance.stencilFront&&e.element._image._renderable.unmaskMeshInstance.stencilBack||(e.element._dirtifyMask(),e.element._onPrerender())),n=!0),n&&(i._ui=!0)}},t._collectAndRemoveMeshInstances=function(e,t){for(var i=0;i<t.length;i++){var n=t[i],a=this._batchGroups[n];if(a){var s=e[n];s||(s=e[n]=[]);for(var r=0;r<a._obj.model.length;r++)s=this._extractModel(a._obj.model[r],s,a,e);for(var o=0;o<a._obj.render.length;o++)s=this._extractRender(a._obj.render[o],s,a,e);for(var l=0;l<a._obj.element.length;l++)this._extractElement(a._obj.element[l],s,a);for(var h=0;h<a._obj.sprite.length;h++){var c=a._obj.sprite[h];c.sprite&&c.sprite._meshInstance&&(a.dynamic||0===c.sprite.sprite._renderMode)&&(s.push(c.sprite._meshInstance),c.sprite.removeModelFromLayers(),a._sprite=!0,c.sprite._batchGroup=a)}}}},t.generate=function(e){var t={};e||(e=Object.keys(this._batchGroups));for(var i,n,a,s,r=[],o=0;o<this._batchList.length;o++)e.indexOf(this._batchList[o].batchGroupId)<0?r.push(this._batchList[o]):this.destroyBatch(this._batchList[o]);if(this._batchList=r,this._collectAndRemoveMeshInstances(t,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else{for(var l=[],h=0;h<this._dirtyGroups.length;h++)e.indexOf(this._dirtyGroups[h])<0&&l.push(this._dirtyGroups[h]);this._dirtyGroups=l}for(var c in t)if(t.hasOwnProperty(c)&&(i=t[c],a=this._batchGroups[c])){n=this.prepare(i,a.dynamic,a.maxAabbSize,a._ui||a._sprite);for(var u=0;u<n.length;u++)(s=this.create(n[u],a.dynamic,parseInt(c,10)))&&s.addToLayers(this.scene,a.layers)}},t.prepare=function(e,t,i,n){if(void 0===i&&(i=Number.POSITIVE_INFINITY),0===e.length)return[];var a,s,r,o,l,h,c,u,d,p,f,m,v,g,_,y=.5*i,b=this.device.supportsBoneTextures?1024:this.device.boneLimit,x=this.device.extUintElement?4294967295:65535,M=new ue,S=new ue,w=null,C=[],P=0;n&&e.sort(function(e,t){return e.drawOrder-t.drawOrder});for(var T,A=e,E=n?function(e){w?w.add(e.aabb):w=e.aabb.clone(),T.push(e)}:function(e){T.push(e)};0<A.length;){for(C[P]=[A[0]],T=[],a=A[0].material,s=A[0].layer,h=A[0]._shaderDefs,o=A[0].parameters,c=A[0].stencilFront,l=A[0]._staticLightList,r=A[0].mesh.vertexBuffer.getNumVertices(),p=A[0].drawOrder,M.copy(A[0].aabb),d=Fn(A[0]),m=A[0].mesh.vertexBuffer.format.batchingHash,f=A[0].mesh.primitive[0].indexed,w=null,_=1;_<A.length;_++){if(v=A[_],t&&C[P].length>=b){T=T.concat(A.slice(_));break}if(a!==v.material||s!==v.layer||m!==v.mesh.vertexBuffer.format.batchingHash||f!==v.mesh.primitive[0].indexed||h!==v._shaderDefs||r+v.mesh.vertexBuffer.getNumVertices()>x)E(v);else if(S.copy(M),S.add(v.aabb),S.halfExtents.x>y||S.halfExtents.y>y||S.halfExtents.z>y)E(v);else if(!c||(g=v.stencilFront)&&c.func===g.func&&c.zpass===g.zpass)if(d===Fn(v))if(Rn(o,v.parameters)){if(u=v._staticLightList,l&&u){if(!Dn(l,u)){E(v);continue}}else if(l||u){E(v);continue}n&&w&&w.intersects(v.aabb)&&v.drawOrder!==p?E(v):(M.add(v.aabb),r+=v.mesh.vertexBuffer.getNumVertices(),C[P].push(v))}else E(v);else E(v);else E(v)}P++,A=T}return C},t.create=function(e,t,i){if(!this._init){var n="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n";this.transformVS=n+"#define DYNAMICBATCH\n"+Dt.transformVS,this.skinTexVS=Dt.skinBatchTexVS,this.skinConstVS=Dt.skinBatchConstVS,this.vertexFormats={},this._init=!0}var a,s,r,o,l,h,c,u=null,d=null,p=0,f=0,m=null;for(a=0;a<e.length;a++)if(e[a].visible&&(p+=c=(l=e[a].mesh).vertexBuffer.numVertices,f+=l.primitive[0].indexed?l.primitive[0].count:6===l.primitive[0].type&&4===l.primitive[0].count?6:0,!u)){for(d=e[a].material,u={},h=l.vertexBuffer.format.elements,s=0;s<h.length;s++)u[o=h[s].name]={numComponents:h[s].numComponents,dataType:h[s].dataType,normalize:h[s].normalize,count:0};t&&(u.BLENDINDICES={numComponents:1,dataType:6,normalize:!1,count:0})}if(u){var v,g,_;m=new wn(e,t,i),this._batchList.push(m);var y,b=0,x=0,M=new de,S=new(p<=65535?Uint16Array:Uint32Array)(f);for(o in u)(r=u[o]).typeArrayType=at[r.dataType],r.elementByteSize=st[r.dataType],r.buffer=new r.typeArrayType(p*r.numComponents);for(a=0;a<e.length;a++)if(e[a].visible){for(o in c=(l=e[a].mesh).vertexBuffer.numVertices,t||(y=e[a].node.getWorldTransform()),u)if(o!==De){var w=new(r=u[o]).typeArrayType(r.buffer.buffer,r.elementByteSize*r.count),C=l.getVertexStream(o,w)*r.numComponents;if(r.count+=C,!t&&3<=r.numComponents)if(o===Te)for(s=0;s<C;s+=r.numComponents)M.set(w[s],w[s+1],w[s+2]),y.transformPoint(M,M),w[s]=M.x,w[s+1]=M.y,w[s+2]=M.z;else if(o===Ae||o===Ee)for(y.invertTo3x3(In),In.transpose(),s=0;s<C;s+=r.numComponents)M.set(w[s],w[s+1],w[s+2]),In.transformVector(M,M),w[s]=M.x,w[s+1]=M.y,w[s+2]=M.z}if(t)for(r=u.BLENDINDICES,s=0;s<c;s++)r.buffer[r.count++]=a;if(l.primitive[0].indexed){v=l.primitive[0].base,g=l.primitive[0].count;var P=l.indexBuffer[0].getFormat();_=new rt[P](l.indexBuffer[0].storage)}else{if(6!==l.primitive[0].type||4!==l.primitive[0].count){g=0;continue}g=6,_=[v=0,1,3,2,3,1]}for(s=0;s<g;s++)S[s+x]=_[v+s]+b;x+=g,b+=c}for(o in l=new Zi(this.device),u)r=u[o],l.setVertexStream(o,r.buffer,r.numComponents,void 0,r.dataType,r.normalize);0<S.length&&l.setIndices(S),l.update(4,!1),t&&((d=d.clone()).chunks.transformVS=this.transformVS,d.chunks.skinTexVS=this.skinTexVS,d.chunks.skinConstVS=this.skinConstVS,d.update());var T=new Mn(l,d,this.rootNode);T.castShadow=m.origMeshInstances[0].castShadow,T.parameters=m.origMeshInstances[0].parameters,T.isStatic=m.origMeshInstances[0].isStatic,T.layer=m.origMeshInstances[0].layer,T._staticLightList=m.origMeshInstances[0]._staticLightList,T._shaderDefs=m.origMeshInstances[0]._shaderDefs,T.cull=m.origMeshInstances[0].cull;var A=this._batchGroups[i];if(A&&A._ui&&(T.cull=!1),t){var E=[];for(a=0;a<m.origMeshInstances.length;a++)E.push(m.origMeshInstances[a].node);T.skinInstance=new An(this.device,E,this.rootNode)}T._updateAabb=!1,T.drawOrder=m.origMeshInstances[0].drawOrder,T.stencilFront=m.origMeshInstances[0].stencilFront,T.stencilBack=m.origMeshInstances[0].stencilBack,T.flipFaces=Fn(m.origMeshInstances[0])<0,T.castShadow=m.origMeshInstances[0].castShadow,m.meshInstance=T,m.updateBoundingBox()}return m},t.updateAll=function(){0<this._dirtyGroups.length&&this.generate(this._dirtyGroups);for(var e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this._batchList[e].updateBoundingBox()},t.clone=function(e,t){var i=new wn(t,e.dynamic,e.batchGroupId);this._batchList.push(i);for(var n=[],a=0;a<t.length;a++)n.push(t[a].node);return i.meshInstance=new Mn(e.meshInstance.mesh,e.meshInstance.material,e.meshInstance.node),i.meshInstance._updateAabb=!1,i.meshInstance.parameters=t[0].parameters,i.meshInstance.isStatic=t[0].isStatic,i.meshInstance.cull=t[0].cull,i.meshInstance.layer=t[0].layer,i.meshInstance._staticLightList=t[0]._staticLightList,e.dynamic&&(i.meshInstance.skinInstance=new An(this.device,n,this.rootNode)),i.meshInstance.castShadow=e.meshInstance.castShadow,i.meshInstance._shader=e.meshInstance._shader,i.meshInstance.castShadow=e.meshInstance.castShadow,i},t.destroyBatch=function(e){e.destroy(this.scene,this._batchGroups[e.batchGroupId].layers)},e}(),Bn=function(){function o(e,t){this.texture=e,this.cached=!1,this.renderTargets=t}return o.prototype.destroy=function(){this.texture&&(this.texture.destroy(),this.texture=null);for(var e=this.renderTargets,t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0},o.getShadowFormat=function(e,t){return 3===t?Ce:2===t?we:4===t||0===t&&e.webgl2?16:7},o.getShadowFiltering=function(e,t){return 0!==t||e.webgl2?3===t?e.extTextureFloatLinear?1:0:2===t?e.extTextureHalfFloatLinear?1:0:1:0},o.create=function(e,t){return 1===t._type?this.createCubemap(e,t._shadowResolution):this.create2dMap(e,t._shadowResolution,t._shadowType)},o.create2dMap=function(e,t,i){var n=this.getShadowFormat(e,i),a=this.getShadowFiltering(e,i),s=new Kt(e,{format:n,width:t,height:t,mipmaps:!1,minFilter:a,magFilter:a,addressU:1,addressV:1});s.name="ShadowMap2D";var r=null;return 4===i||0===i&&e.webgl2?(s.compareOnRead=!0,s.compareFunc=1,r=new Fm({depthBuffer:s})):r=new Fm({colorBuffer:s,depth:!0}),new o(s,[r])},o.createCubemap=function(e,t){var i=new Kt(e,{format:7,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});i.name="ShadowMapCube";for(var n=[],a=0;a<6;a++){var s=new Fm({colorBuffer:i,face:a,depth:!0});n.push(s)}return new o(i,n)},o}(),Vn=function(){function e(){this.shadowMapCache=new Map}var t=e.prototype;return t.destroy=function(){this.clear(),this.shadowMapCache=null},t.clear=function(){this.shadowMapCache.forEach(function(e){e.forEach(function(e){e.destroy()})}),this.shadowMapCache.clear()},t.getKey=function(e){return(1===e._type)+"-"+e._shadowType+"-"+e._shadowResolution},t.get=function(e,t){var i=this.getKey(t),n=this.shadowMapCache.get(i);if(n&&n.length)return n.pop();var a=Bn.create(e,t);return a.cached=!0,a},t.add=function(e,t){var i=this.getKey(e),n=this.shadowMapCache.get(i);n?n.push(t):this.shadowMapCache.set(i,[t])},e}(),Un=[(new fe).setFromEulerAngles(0,90,180),(new fe).setFromEulerAngles(0,-90,180),(new fe).setFromEulerAngles(90,0,0),(new fe).setFromEulerAngles(-90,0,0),(new fe).setFromEulerAngles(0,180,180),(new fe).setFromEulerAngles(0,0,180)],Nn=[new de,new de,new de,new de,new de,new de,new de,new de],Gn={min:0,max:0};function Wn(e,t,i){Nn[0].x=Nn[1].x=Nn[2].x=Nn[3].x=t.x,Nn[1].y=Nn[3].y=Nn[7].y=Nn[5].y=t.y,Nn[2].z=Nn[3].z=Nn[6].z=Nn[7].z=t.z,Nn[4].x=Nn[5].x=Nn[6].x=Nn[7].x=i.x,Nn[0].y=Nn[2].y=Nn[4].y=Nn[6].y=i.y,Nn[0].z=Nn[1].z=Nn[4].z=Nn[5].z=i.z;for(var n=9999999999,a=-9999999999,s=0;s<8;++s){e.transformPoint(Nn[s],Nn[s]);var r=Nn[s].z;r<n&&(n=r),a<r&&(a=r)}return Gn.min=n,Gn.max=a,Gn}var Hn=new ue,jn=new pe,Xn=new pe,qn=new Float32Array(2),$n={x:1,y:1,z:0,w:0},Yn={r:1,g:2,b:3,a:4},Kn=new de,Zn=new pe;function Qn(e){var t=e.material,i=e.skinInstance?10:0,n=0;if(t.opacityMap){var a=t.opacityMapChannel;a&&(n=Yn[a])}return i+n}var Jn,ea,ta,ia,na=function(){function r(e){this.device=e.device,this.forwardRenderer=e;var t=this.device.scope;this.sourceId=t.resolve("source"),this.pixelOffsetId=t.resolve("pixelOffset"),this.weightId=t.resolve("weight[0]"),this.blurVsmShaderCode=[Dt.blurVSMPS,"#define GAUSS\n"+Dt.blurVSMPS];var i="#define PACKED\n";this.blurPackedVsmShaderCode=[i+this.blurVsmShaderCode[0],i+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=t.resolve("light_radius"),this.shadowMapCache=new Vn}var e=r.prototype;return e.destroy=function(){this.shadowMapCache.destroy(),this.shadowMapCache=null},r.createShadowCamera=function(e,t,i,n){var a=new Oi;switch(a.node=new mn("ShadowCamera"),a.aspectRatio=1,i){case 1:a.node.setRotation(Un[n]),a.fov=90,a.projection=0;break;case 2:a.projection=0;break;case 0:a.projection=1}var s=4===t||0===t&&e.webgl2;return 1===i&&(s=!1),a.clearColor=1<=t&&t<=3?new $(0,0,0,0):new $(1,1,1,1),a.clearColorBuffer=!s,a.clearDepthBuffer=!0,a.clearStencilBuffer=!1,a},e.cullShadowCasters=function(e,t,i){for(var n=0,a=e.length,s=0;s<a;s++){var r=e[s];r.cull&&!r._isVisible(i)||(r.visibleThisFrame=!0,t[n]=r,n++)}t.length=n,t.sort(this.forwardRenderer.depthSortCompare)},e.cullLocal=function(e,t){e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=Bn.create(this.device,e));for(var i=e._type,n=2===i?1:6,a=0;a<n;a++){var s=e.getRenderData(null,a),r=s.shadowCamera;r.nearClip=e.attenuationEnd/1e3,r.farClip=e.attenuationEnd;var o=r._node,l=e._node;o.setPosition(l.getPosition()),2===i&&(r.fov=2*e._outerConeAngle,o.setRotation(l.getRotation()),o.rotateLocal(-90,0,0)),r.renderTarget=e._shadowMap.renderTargets[a],this.forwardRenderer.updateCameraFrustum(r),this.cullShadowCasters(t,s.visibleCasters,r)}},e.generateSplitDistances=function(e,t,i){e._shadowCascadeDistances.fill(i);for(var n=1;n<e.numCascades;n++){var a=n/e.numCascades,s=t+(i-t)*a,r=t*Math.pow(i/t,a),o=Se.lerp(s,r,e.cascadeDistribution);e._shadowCascadeDistances[n-1]=o}},e.cullDirectional=function(e,t,i){e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=Bn.create(this.device,e));var n=i._nearClip;this.generateSplitDistances(e,n,e.shadowDistance);for(var a=0;a<e.numCascades;a++){var s=e.getRenderData(i,a),r=s.shadowCamera;r.renderTarget=e._shadowMap.renderTargets[0];var o=r._node,l=e._node;o.setPosition(l.getPosition()),o.setRotation(l.getRotation()),o.rotateLocal(-90,0,0);var h=0===a?n:e._shadowCascadeDistances[a-1],c=e._shadowCascadeDistances[a],u=be.getPoints(i,h,c);Kn.set(0,0,0);for(var d=i.node.getWorldTransform(),p=0;p<8;p++)d.transformPoint(u[p],u[p]),Kn.add(u[p]);Kn.mulScalar(1/8);for(var f=0,m=0;m<8;m++){var v=u[m].sub(Kn).length();f<v&&(f=v)}var g=o.right,_=o.up,y=o.forward,b=.25*e._shadowResolution/f,x=Math.ceil(Kn.dot(_)*b)/b,M=Math.ceil(Kn.dot(g)*b)/b,S=_.mulScalar(x),w=g.mulScalar(M),C=Kn.dot(y),P=y.mulScalar(C);Kn.add2(S,w).add(P),o.setPosition(Kn),o.translateLocal(0,0,1e6),r.nearClip=0,r.farClip=2e6,r.orthoHeight=f,this.forwardRenderer.updateCameraFrustum(r),this.cullShadowCasters(t,s.visibleCasters,r);for(var T=!0,A=s.visibleCasters,E=0;E<A.length;E++){var R=A[E];T?(T=!1,Hn.copy(R.aabb)):Hn.add(R.aabb)}jn.copy(o.getWorldTransform()).invert();var D=Wn(jn,Hn.getMin(),Hn.getMax());o.translateLocal(0,0,D.max+.1),r.farClip=D.max-D.min+.2}},e.setupRenderState=function(e,t){if(e.webgl2)1===t._type?e.setDepthBias(!1):(e.setDepthBias(!0),e.setDepthBiasValues(-1e3*t.shadowBias,-1e3*t.shadowBias));else if(e.extStandardDerivatives){var i=this.forwardRenderer;1===t._type?(i.polygonOffset[0]=0,i.polygonOffset[1]=0):(i.polygonOffset[0]=-1e3*t.shadowBias,i.polygonOffset[1]=-1e3*t.shadowBias),i.polygonOffsetId.setValue(i.polygonOffset)}e.setBlending(!1),e.setDepthWrite(!0),e.setDepthTest(!0),t._isPcf&&e.webgl2&&1!==t._type?e.setColorWrite(!1,!1,!1,!1):e.setColorWrite(!0,!0,!0,!0)},e.dispatchUniforms=function(e,t,i,n){var a=t._node;if(0!==e._type&&(this.forwardRenderer.dispatchViewPos(a.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),1!==e._type)if(jn.setTRS(a.getPosition(),a.getRotation(),de.ONE).invert(),Xn.mul2(t.projectionMatrix,jn),0===e._type){var s=e.cascades[n];t.rect=s,t.scissorRect=s,Zn.setViewport(s.x,s.y,s.z,s.w),i.shadowMatrix.mul2(Zn,Xn),e._shadowMatrixPalette.set(i.shadowMatrix.data,16*n)}else i.shadowMatrix.mul2(r.scaleShiftMatrix,Xn)},e.submitCasters=function(e,t,i){for(var n=this.device,a=this.forwardRenderer,s=t._shadowType+5*t._type,r=e.length,o=0;o<r;o++){var l=e[o],h=l.mesh,c=l.material;a.setBaseConstants(n,c),a.setSkinning(n,l,c),c.dirty&&(c.updateUniforms(i),c.dirty=!1),c.chunks&&(a.setCullMode(!0,!1,l),c.setParameters(n),l.setParameters(n,8));var u=l._shader[3+s];u||(a.updateShader(l,l._shaderDefs,null,3+s),u=l._shader[3+s],l._key[1]=Qn(l)),n.setShader(u),a.setVertexBuffers(n,h),a.setMorphing(n,l.morphInstance);var d=l.renderStyle;n.setIndexBuffer(h.indexBuffer[d]),o+=a.drawInstance(n,l,h,d),a._shadowDrawCalls++}},e.render=function(e,t){if(e.enabled&&e.castShadows&&0!==e.shadowUpdateMode&&e.visibleThisFrame){var i=this.device;1===e.shadowUpdateMode&&(e.shadowUpdateMode=0);var n=1,a=e._type;0===a?n=e.numCascades:1===a&&(n=6);var s=this.forwardRenderer;s._shadowMapUpdates+=n,this.setupRenderState(i,e);for(var r=0;r<n;r++){var o=e.getRenderData(0===a?t:null,r),l=o.shadowCamera;this.dispatchUniforms(e,l,o,r),s.setCamera(l,l.renderTarget,!0,1===n),this.submitCasters(o.visibleCasters,e,t)}e._isVsm&&1<e._vsmBlurSize&&this.applyVsmBlur(e,t)}},e.getVsmBlurShader=function(e,t,i){var n=(e?this.blurPackedVsmShader:this.blurVsmShader)[t][i];if(!n){this.blurVsmWeights[i]=function(e){25<e&&(e=25);for(var t=(e-1)/6,i=.5*(e-1),n=new Array(e),a=0,s=0;s<e;++s)n[s]=(r=s-i,o=t,Math.exp(-r*r/(2*o*o))),a+=n[s];for(var r,o,l=0;l<e;++l)n[l]/=a;return n}(i);var a=Dt.fullscreenQuadVS,s="#define SAMPLES "+i+"\n";s+=e?this.blurPackedVsmShaderCode[t]:this.blurVsmShaderCode[t];var r="blurVsm"+t+i+e;n=Ht(this.device,a,s,r),e?this.blurPackedVsmShader[t][i]=n:this.blurVsmShader[t][i]=n}return n},e.applyVsmBlur=function(e,t){var i=this.device,n=e.getRenderData(0===e._type?t:null,0).shadowCamera.renderTarget,a=this.shadowMapCache.get(i,e),s=a.renderTargets[0],r=1===e._shadowType,o=e.vsmBlurMode,l=e._vsmBlurSize,h=this.getVsmBlurShader(r,o,l);$n.z=e._shadowResolution-2,$n.w=$n.z,this.sourceId.setValue(n.colorBuffer),qn[0]=1/e._shadowResolution,qn[1]=0,this.pixelOffsetId.setValue(qn),1===o&&this.weightId.setValue(this.blurVsmWeights[l]),At(i,s,h,null,$n),this.sourceId.setValue(s.colorBuffer),qn[1]=qn[0],qn[0]=0,this.pixelOffsetId.setValue(qn),At(i,n,h,null,$n),this.shadowMapCache.add(e,a)},r}();na.scaleShiftMatrix=(new pe).setViewport(0,0,1,1);var aa=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){return Jn=e._key[0],ea=t._key[0],Jn===ea&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:ea-Jn},function(e,t){return t.zdist-e.zdist},function(e,t){return e.zdist-t.zdist}];function sa(e,t){return t.key-e.key}var ra,oa,la,ha,ca,ua,da,pa,fa,ma=0,va=function(){this.list=[],this.length=0,this.done=!1},ga=function(){function e(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}var t=e.prototype;return t.prepare=function(e){this.visibleOpaque[e]||(this.visibleOpaque[e]=new va),this.visibleTransparent[e]||(this.visibleTransparent[e]=new va),this.visibleOpaque[e].done=!1,this.visibleTransparent[e].done=!1},t.delete=function(e){e<this.visibleOpaque.length&&this.visibleOpaque.splice(e,1),e<this.visibleTransparent.length&&this.visibleTransparent.splice(e,1)},e}(),_a=function(){function e(e){void 0===e&&(e={}),void 0!==e.id?(this.id=e.id,ma=Math.max(this.id+1,ma)):this.id=ma++,this.name=e.name,this._enabled=void 0===e.enabled||e.enabled,this._refCounter=this._enabled?1:0,this.opaqueSortMode=void 0===e.opaqueSortMode?2:e.opaqueSortMode,this.transparentSortMode=void 0===e.transparentSortMode?3:e.transparentSortMode,this.renderTarget=e.renderTarget,this.shaderPass=void 0===e.shaderPass?0:e.shaderPass,this.passThrough=void 0!==e.passThrough&&e.passThrough,this._clearColorBuffer=!!e.clearColorBuffer&&e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer&&e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer&&e.clearStencilBuffer,this.onPreCull=e.onPreCull,this.onPreRender=e.onPreRender,this.onPreRenderOpaque=e.onPreRenderOpaque,this.onPreRenderTransparent=e.onPreRenderTransparent,this.onPostCull=e.onPostCull,this.onPostRender=e.onPostRender,this.onPostRenderOpaque=e.onPostRenderOpaque,this.onPostRenderTransparent=e.onPostRenderTransparent,this.onDrawCall=e.onDrawCall,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=e.layerReference,this.instances=e.layerReference?e.layerReference.instances:new ga,this.cullingMask=e.cullingMask?e.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customSortCallback=null,this.customCalculateSortValues=null,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this.cameras=[],this._dirty=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._lightHash=0,this._staticLightHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._lightCube=null}var t=e.prototype;return t.incrementCounter=function(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++},t.decrementCounter=function(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--},t.addMeshInstances=function(e,t){for(var i,n,a,s=this._shaderVersion,r=this.shadowCasters,o=0;o<e.length;o++)n=3===(a=(i=e[o]).material).blendType?this.opaqueMeshInstances:this.transparentMeshInstances,this.opaqueMeshInstances.indexOf(i)<0&&this.transparentMeshInstances.indexOf(i)<0&&n.push(i),!t&&i.castShadow&&r.indexOf(i)<0&&r.push(i),!this.passThrough&&0<=s&&a._shaderVersion!==s&&(a.updateShader!==Ui.prototype.updateShader&&(a.clearVariants(),a.shader=null),a._shaderVersion=s);this.passThrough||(this._dirty=!0)},t.removeMeshInstanceFromArray=function(e,t){for(var i,n=-1,a=0,s=t.length,r=0;r<s;r++){if((i=t[r])===e){n=r,a=1;break}if(i._staticSource===e)n<0&&(n=r),a++;else if(0<=n)break}0<=n&&t.splice(n,a)},t.removeMeshInstances=function(e,t){for(var i,n,a=this.opaqueMeshInstances,s=this.transparentMeshInstances,r=this.shadowCasters,o=0;o<e.length;o++)n=e[o],this.removeMeshInstanceFromArray(n,a),this.removeMeshInstanceFromArray(n,s),t||0<=(i=r.indexOf(n))&&r.splice(i,1);this._dirty=!0},t.clearMeshInstances=function(e){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!e&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,e||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))},t.addLight=function(e){var t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),0!==t.type&&this._clusteredLightsSet.add(t),this._lights.push(t),this._dirtyLights=!0,this._generateLightHash())},t.removeLight=function(e){var t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),0!==t.type&&this._clusteredLightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this._dirtyLights=!0,this._generateLightHash())},t.clearLights=function(){this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this._dirtyLights=!0},t.addShadowCasters=function(e){for(var t,i=this.shadowCasters,n=0;n<e.length;n++)(t=e[n]).castShadow&&i.indexOf(t)<0&&i.push(t);this._dirtyLights=!0},t.removeShadowCasters=function(e){for(var t,i=this.shadowCasters,n=0;n<e.length;n++)0<=(t=i.indexOf(e[n]))&&i.splice(t,1);this._dirtyLights=!0},t._generateLightHash=function(){if(0<this._lights.length){this._lights.sort(sa);for(var e="",t="",i=0;i<this._lights.length;i++)this._lights[i].isStatic?t+=this._lights[i].key:e+=this._lights[i].key;0===e.length?this._lightHash=0:this._lightHash=ct(e),0===t.length?this._staticLightHash=0:this._staticLightHash=ct(t)}else this._lightHash=0,this._staticLightHash=0},t.addCamera=function(e){0<=this.cameras.indexOf(e)||(this.cameras.push(e),this._dirtyCameras=!0)},t.removeCamera=function(e){var t=this.cameras.indexOf(e);0<=t&&(this.cameras.splice(t,1),this._dirtyCameras=!0,this.instances.delete(t))},t.clearCameras=function(){this.cameras.length=0,this._dirtyCameras=!0},t._calculateSortDistances=function(e,t,i,n){var a,s,r,o,l,h;for(a=0;a<t;a++)(s=e[a]).command||s.layer<=2||(s.calculateSortDistance?s.zdist=s.calculateSortDistance(s,i,n):(o=(r=s.aabb.center).x-i.x,l=r.y-i.y,h=r.z-i.z,s.zdist=o*n.x+l*n.y+h*n.z))},t._sortVisible=function(e,t,i){var n=this.instances,a=e?this.transparentSortMode:this.opaqueSortMode;if(0!==a){var s=e?n.visibleTransparent[i]:n.visibleOpaque[i];5===a?(ta=t.getPosition(),ia=t.forward,this.customCalculateSortValues&&this.customCalculateSortValues(s.list,s.length,ta,ia),s.list.length!==s.length&&(s.list.length=s.length),this.customSortCallback&&s.list.sort(this.customSortCallback)):(3!==a&&4!==a||(ta=t.getPosition(),ia=t.forward,this._calculateSortDistances(s.list,s.length,ta,ia)),s.list.length!==s.length&&(s.list.length=s.length),s.list.sort(aa[a]))}},c(e,[{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e,this._dirtyCameras=!0}},{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&((this._enabled=e)?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.copy(e)}},{key:"clearColorBuffer",get:function(){return this._clearColorBuffer},set:function(e){this._clearColorBuffer=e,this._dirtyCameras=!0}},{key:"clearDepthBuffer",get:function(){return this._clearDepthBuffer},set:function(e){this._clearDepthBuffer=e,this._dirtyCameras=!0}},{key:"clearStencilBuffer",get:function(){return this._clearStencilBuffer},set:function(e){this._clearStencilBuffer=e,this._dirtyCameras=!0}},{key:"clusteredLightsSet",get:function(){return this._clusteredLightsSet}}]),e}(),ya=function(){function e(e){this.application=e,this.device=e.graphicsDevice,this.clearOptions=null,this.layer=null,this.init()}var t=e.prototype;return t.allocateTexture=function(e,t,i){var n=new Kt(e,{format:i,width:e.width,height:e.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return n.name=t,e.scope.resolve("uDepthMap").setValue(n),n},t.allocateRenderTarget=function(e,t,i,n,a){var s=this.allocateTexture(t,i,n);return e?(e.destroyFrameBuffers(),a?e._depthBuffer=s:e._colorBuffer=s):e=new Fm({colorBuffer:a?null:s,depthBuffer:a?s:null,depth:!a,stencil:t.supportsStencil,autoResolve:!1}),e},t.releaseRenderTarget=function(e){e&&(e.destroyTextureBuffers(),e.destroy())},t.initWebGl2=function(){var i=this.application,n=this;this.clearOptions={flags:0},this.layer=new _a({enabled:!1,name:"Depth",id:1,onEnable:function(){this.renderTarget=n.allocateRenderTarget(this.renderTarget,i.graphicsDevice,"rt-depth2",Pe,!0)},onDisable:function(){n.releaseRenderTarget(this.renderTarget),this.renderTarget=null},onPreRenderOpaque:function(e){var t=i.graphicsDevice.gl;this.srcFbo=t.getParameter(t.FRAMEBUFFER_BINDING),this.renderTarget.width===i.graphicsDevice.width&&this.renderTarget.height===i.graphicsDevice.height||this.onEnable(),this.oldClear=this.cameras[e].camera._clearOptions,this.cameras[e].camera._clearOptions=n.clearOptions},onPostRenderOpaque:function(e){if(this.renderTarget){this.cameras[e].camera._clearOptions=this.oldClear,i.graphicsDevice.setRenderTarget(this.renderTarget),i.graphicsDevice.updateBegin();var t=i.graphicsDevice.gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.srcFbo),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),t.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,t.DEPTH_BUFFER_BIT,t.NEAREST)}}})},t.initWebGl1=function(){var g=this.application,t=this;this.clearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:3},this.layer=new _a({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function(){this.renderTarget=t.allocateRenderTarget(this.renderTarget,g.graphicsDevice,"rt-depth1",7,!1)},onDisable:function(){t.releaseRenderTarget(this.renderTarget),this.renderTarget=null},onPostCull:function(e){for(var t=this.instances.visibleOpaque[e],i=t.list,n=g.scene.layers,a=n.subLayerEnabled,s=n.subLayerList,r=g.scene.layers.getLayerById(0).renderTarget,o=this.cameras[e],l=0,h=n.layerList,c=0;c<h.length;c++){var u=h[c];if(u===this)break;if(u.renderTarget===r&&u.enabled&&a[c]){var d=u.cameras.indexOf(o);if(!(d<0)){var p=s[c]?u.instances.visibleTransparent[d]:u.instances.visibleOpaque[d],f=p.length;p=p.list;for(var m=0;m<f;m++){var v=p[m];v.material&&v.material.depthWrite&&!v._noDepthDrawGl1&&(i[l]=v,l++)}}}}t.length=l},onPreRenderOpaque:function(e){this.renderTarget.width===g.graphicsDevice.width&&this.renderTarget.height===g.graphicsDevice.height||this.onEnable(),this.oldClear=this.cameras[e].camera._clearOptions,this.cameras[e].camera._clearOptions=t.clearOptions},onDrawCall:function(){g.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(e){this.renderTarget&&(this.cameras[e].camera._clearOptions=this.oldClear)}})},t.init=function(){this.device.webgl2?this.initWebGl2():this.initWebGl1()},t.patch=function(e){e.onEnable=this.layer.onEnable,e.onDisable=this.layer.onDisable,e.onPreRenderOpaque=this.layer.onPreRenderOpaque,e.onPostRenderOpaque=this.layer.onPostRenderOpaque,e.shaderPass=this.layer.shaderPass,e.onPostCull=this.layer.onPostCull,e.onDrawCall=this.layer.onDrawCall},e}(),ba=new pe,xa=new pe,Ma=new pe,Sa=new pe,wa=new Q,Ca=new pe,Pa=(new pe).setScale(1,-1,1),Ta=new pe,Aa=new pe,Ea=new pe,Ra=new pe,Da=new pe,Ia=new pe,ka=new de,La=new de,Oa=new Q,Fa=new Q,za=new pe,Ba=new pe,Va=new de,Ua=new de,Na=new de,Ga=new ge,Wa=[0,0,0,0],Ha=null,ja=0,Xa=new Set,qa=function(){function d(e){this.device=e;var t=this.device;this._shadowDrawCalls=0,this._forwardDrawCalls=0,this._skinDrawCalls=0,this._camerasRendered=0,this._materialSwitches=0,this._shadowMapUpdates=0,this._shadowMapTime=0,this._depthMapTime=0,this._forwardTime=0,this._cullTime=0,this._sortTime=0,this._skinTime=0,this._morphTime=0,this._instancingTime=0,this._layerCompositionUpdateTime=0,this._lightClustersTime=0,this._lightClusters=0;var i=t.getProgramLibrary();this.library=i,this._shadowRenderer=new na(this);var n=t.scope;this.projId=n.resolve("matrix_projection"),this.projSkyboxId=n.resolve("matrix_projectionSkybox"),this.viewId=n.resolve("matrix_view"),this.viewId3=n.resolve("matrix_view3"),this.viewInvId=n.resolve("matrix_viewInverse"),this.viewProjId=n.resolve("matrix_viewProjection"),this.viewPos=new Float32Array(3),this.viewPosId=n.resolve("view_position"),this.nearClipId=n.resolve("camera_near"),this.farClipId=n.resolve("camera_far"),this.cameraParamsId=n.resolve("camera_params"),this.fogColorId=n.resolve("fog_color"),this.fogStartId=n.resolve("fog_start"),this.fogEndId=n.resolve("fog_end"),this.fogDensityId=n.resolve("fog_density"),this.modelMatrixId=n.resolve("matrix_model"),this.normalMatrixId=n.resolve("matrix_normal"),this.poseMatrixId=n.resolve("matrix_pose[0]"),this.boneTextureId=n.resolve("texture_poseMap"),this.boneTextureSizeId=n.resolve("texture_poseMapSize"),this.morphWeightsA=n.resolve("morph_weights_a"),this.morphWeightsB=n.resolve("morph_weights_b"),this.morphPositionTex=n.resolve("morphPositionTex"),this.morphNormalTex=n.resolve("morphNormalTex"),this.morphTexParams=n.resolve("morph_tex_params"),this.alphaTestId=n.resolve("alpha_ref"),this.opacityMapId=n.resolve("texture_opacityMap"),this.ambientId=n.resolve("light_globalAmbient"),this.exposureId=n.resolve("exposure"),this.skyboxIntensityId=n.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.depthMapId=n.resolve("uDepthMap"),this.screenSizeId=n.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.twoSidedLightingNegScaleFactorId=n.resolve("twoSidedLightingNegScaleFactor"),this.polygonOffsetId=n.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.cameraParams=new Float32Array(4)}var e=d.prototype;return e.destroy=function(){this._shadowRenderer.destroy(),this._shadowRenderer=null},d.getSpotCookieCamera=function(){return this.spotCookieCamera||(this.spotCookieCamera=new Oi,this.spotCookieCamera.projection=0,this.spotCookieCamera.aspectRatio=1,this.spotCookieCamera.node=new mn),this.spotCookieCamera},e.sortCompare=function(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist;if(e.zdist2&&t.zdist2)return e.zdist2-t.zdist2}return t._key[0]-e._key[0]},e.sortCompareMesh=function(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist}return pa=e._key[0],fa=t._key[0],pa===fa&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:fa-pa},e.depthSortCompare=function(e,t){return pa=e._key[1],fa=t._key[1],pa===fa&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:fa-pa},e.lightCompare=function(e,t){return e.key-t.key},e.updateCameraFrustum=function(e){if(e.vrDisplay&&e.vrDisplay.presenting){ra=e.vrDisplay.combinedProj;var t=e._node.parent;t?Sa.copy(t.getWorldTransform()).mul(e.vrDisplay.combinedViewInv).invert():Sa.copy(e.vrDisplay.combinedView),Ma.copy(Sa).invert(),this.viewInvId.setValue(Ma.data),Ca.mul2(ra,Sa),e.frustum.setFromMat4(Ca)}else if(e.xr&&e.xr.views.length){var i=e.xr.views[0];return Ca.mul2(i.projMat,i.viewOffMat),void e.frustum.setFromMat4(Ca)}if(ra=e.projectionMatrix,e.calculateProjection&&e.calculateProjection(ra,0),e.calculateTransform)e.calculateTransform(Ma,0);else{var n=e._node.getPosition(),a=e._node.getRotation();Ma.setTRS(n,a,de.ONE),this.viewInvId.setValue(Ma.data)}Sa.copy(Ma).invert(),Ca.mul2(ra,Sa),e.frustum.setFromMat4(Ca)},e.setCamera=function(e,t,i,n){var a,s,r=e.vrDisplay;if(r&&r.presenting)oa=r.leftProj,la=r.rightProj,ra=r.combinedProj,e.calculateProjection&&(e.calculateProjection(oa,1),e.calculateProjection(la,2),e.calculateProjection(ra,0)),e.calculateTransform?(e.calculateTransform(Ea,1),e.calculateTransform(Ra,2),e.calculateTransform(Ma,0),Da.copy(Ea).invert(),Ia.copy(Ra).invert(),Sa.copy(Ma).invert()):(a=e._node.parent)?(s=a.getWorldTransform(),Ea.mul2(s,r.leftViewInv),Ra.mul2(s,r.rightViewInv),Da.copy(Ea).invert(),Ia.copy(Ra).invert(),Sa.copy(a.getWorldTransform()).mul(r.combinedViewInv).invert()):(Ea.copy(r.leftViewInv),Ra.copy(r.rightViewInv),Da.copy(r.leftView),Ia.copy(r.rightView),Sa.copy(r.combinedView)),Oa.setFromMat4(Da),Fa.setFromMat4(Ia),za.mul2(oa,Da),Ba.mul2(la,Ia),ka.x=Ea.data[12],ka.y=Ea.data[13],ka.z=Ea.data[14],La.x=Ra.data[12],La.y=Ra.data[13],La.z=Ra.data[14],Ca.mul2(ra,Sa),e.frustum.setFromMat4(Ca);else if(e.xr&&e.xr.session){(a=e._node.parent)&&(s=a.getWorldTransform());for(var o=e.xr.views,l=0;l<o.length;l++){var h=o[l];a?(h.viewInvOffMat.mul2(s,h.viewInvMat),h.viewOffMat.copy(h.viewInvOffMat).invert()):(h.viewInvOffMat.copy(h.viewInvMat),h.viewOffMat.copy(h.viewMat)),h.viewMat3.setFromMat4(h.viewOffMat),h.projViewOffMat.mul2(h.projMat,h.viewOffMat),h.position[0]=h.viewInvOffMat.data[12],h.position[1]=h.viewInvOffMat.data[13],h.position[2]=h.viewInvOffMat.data[14],e.frustum.setFromMat4(h.projViewOffMat)}}else{if(ra=e.projectionMatrix,e.calculateProjection&&e.calculateProjection(ra,0),this.projId.setValue(ra.data),this.projSkyboxId.setValue(e.getProjectionMatrixSkybox().data),e.calculateTransform)e.calculateTransform(Ma,0);else{var c=e._node.getPosition(),u=e._node.getRotation();Ma.setTRS(c,u,de.ONE)}this.viewInvId.setValue(Ma.data),Sa.copy(Ma).invert(),this.viewId.setValue(Sa.data),wa.setFromMat4(Sa),this.viewId3.setValue(wa.data),Ca.mul2(ra,Sa),t&&t.flipY?(Ta.mul2(Pa,Ca),Aa.mul2(Pa,e.getProjectionMatrixSkybox()),this.viewProjId.setValue(Ta.data),this.projSkyboxId.setValue(Aa.data)):(this.viewProjId.setValue(Ca.data),this.projSkyboxId.setValue(e.getProjectionMatrixSkybox().data)),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(Ca)}this.nearClipId.setValue(e._nearClip),this.farClipId.setValue(e._farClip);var d=e._nearClip,p=e._farClip;this.cameraParams[0]=1/p,this.cameraParams[1]=p,this.cameraParams[2]=.5*(1-p/d),this.cameraParams[3]=.5*(1+p/d),this.cameraParamsId.setValue(this.cameraParams),this.clearView(e,t,i,!1);var f=this.device,m=t?t.width:f.width,v=t?t.height:f.height,g=e.scissorRect,_=Math.floor(g.x*m),y=Math.floor(g.y*v),b=Math.floor(g.z*m),x=Math.floor(g.w*v);f.setScissor(_,y,b,x),n&&f.setScissor(1,1,m-2,v-2)},e.clearView=function(e,t,i,n,a){var s=this.device;s.setRenderTarget(t),s.updateBegin(),n&&(s.setColorWrite(!0,!0,!0,!0),s.setDepthWrite(!0));var r=e.rect,o=t?t.width:s.width,l=t?t.height:s.height,h=Math.floor(r.x*o),c=Math.floor(r.y*l),u=Math.floor(r.z*o),d=Math.floor(r.w*l);s.setViewport(h,c,u,d),s.setScissor(h,c,u,d),i&&(a||(a=e._clearOptions),s.clear(a||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:(e._clearColorBuffer?1:0)|(e._clearDepthBuffer?2:0)|(e._clearStencilBuffer?4:0),stencil:e._clearStencil}))},e.dispatchGlobalLights=function(e){if(this.ambientColor[0]=e.ambientLight.r,this.ambientColor[1]=e.ambientLight.g,this.ambientColor[2]=e.ambientLight.b,e.gammaCorrection)for(var t=0;t<3;t++)this.ambientColor[t]=Math.pow(this.ambientColor[t],2.2);this.ambientId.setValue(this.ambientColor),this.exposureId.setValue(e.exposure),e.skyboxModel&&this.skyboxIntensityId.setValue(e.skyboxIntensity)},e._resolveLight=function(e,t){var i="light"+t;this.lightColorId[t]=e.resolve(i+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(i+"_direction"),this.lightShadowMapId[t]=e.resolve(i+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(i+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(i+"_shadowParams"),this.lightRadiusId[t]=e.resolve(i+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(i+"_position"),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(i+"_halfWidth"),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(i+"_halfHeight"),this.lightInAngleId[t]=e.resolve(i+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(i+"_outerConeAngle"),this.lightCookieId[t]=e.resolve(i+"_cookie"),this.lightCookieIntId[t]=e.resolve(i+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(i+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(i+"_cookieOffset"),this.shadowMatrixPaletteId[t]=e.resolve(i+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[t]=e.resolve(i+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[t]=e.resolve(i+"_shadowCascadeCount")},e.setLTCDirectionallLight=function(e,t,i,n,a){this.lightPos[t][0]=n.x-i.x*a,this.lightPos[t][1]=n.y-i.y*a,this.lightPos[t][2]=n.z-i.z*a,this.lightPosId[t].setValue(this.lightPos[t]);var s=e.transformVector(new de(-.5,0,0));this.lightWidth[t][0]=s.x*a,this.lightWidth[t][1]=s.y*a,this.lightWidth[t][2]=s.z*a,this.lightWidthId[t].setValue(this.lightWidth[t]);var r=e.transformVector(new de(0,0,.5));this.lightHeight[t][0]=r.x*a,this.lightHeight[t][1]=r.y*a,this.lightHeight[t][2]=r.z*a,this.lightHeightId[t].setValue(this.lightHeight[t])},e.dispatchDirectLights=function(e,t,i,n){var a,s,r,o=e.length,l=0,h=this.device.scope;for(a=0;a<o;a++)if(e[a].mask&i){if(r=(s=e[a])._node.getWorldTransform(),this.lightColorId[l]||this._resolveLight(h,l),this.lightColorId[l].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),r.getY(s._direction).mulScalar(-1),s._direction.normalize(),this.lightDir[l][0]=s._direction.x,this.lightDir[l][1]=s._direction.y,this.lightDir[l][2]=s._direction.z,this.lightDirId[l].setValue(this.lightDir[l]),0!==s.shape&&this.setLTCDirectionallLight(r,l,s._direction,n._node.getPosition(),n.farClip),s.castShadows){var c=s.getRenderData(n,0),u=c.shadowCamera._farClip,d=void 0;s._isVsm?d=-2e-4:(d=s.shadowBias/u*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(d*=-100));var p=s._isVsm?s.vsmBias/(u/7):s._normalOffsetBias;this.lightShadowMapId[l].setValue(c.shadowBuffer),this.lightShadowMatrixId[l].setValue(c.shadowMatrix.data),this.shadowMatrixPaletteId[l].setValue(s._shadowMatrixPalette),this.shadowCascadeDistancesId[l].setValue(s._shadowCascadeDistances),this.shadowCascadeCountId[l].setValue(s.numCascades);var f=s._shadowRenderParams;f.length=3,f[0]=s._shadowResolution,f[1]=p,f[2]=d,this.lightShadowParamsId[l].setValue(f)}l++}return l},e.setLTCPositionalLight=function(e,t){var i=e.transformVector(new de(-.5,0,0));this.lightWidth[t][0]=i.x,this.lightWidth[t][1]=i.y,this.lightWidth[t][2]=i.z,this.lightWidthId[t].setValue(this.lightWidth[t]);var n=e.transformVector(new de(0,0,.5));this.lightHeight[t][0]=n.x,this.lightHeight[t][1]=n.y,this.lightHeight[t][2]=n.z,this.lightHeightId[t].setValue(this.lightHeight[t])},e.dispatchOmniLight=function(e,t,i,n){var a=i._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(t,n),this.lightRadiusId[n].setValue(i.attenuationEnd),this.lightColorId[n].setValue(e.gammaCorrection?i._linearFinalColor:i._finalColor),a.getTranslation(i._position),this.lightPos[n][0]=i._position.x,this.lightPos[n][1]=i._position.y,this.lightPos[n][2]=i._position.z,this.lightPosId[n].setValue(this.lightPos[n]),0!==i.shape&&this.setLTCPositionalLight(a,n),i.castShadows){var s=i.getRenderData(null,0);this.lightShadowMapId[n].setValue(s.shadowBuffer);var r=i._shadowRenderParams;r.length=4,r[0]=i._shadowResolution,r[1]=i._normalOffsetBias,r[2]=i.shadowBias,r[3]=1/i.attenuationEnd,this.lightShadowParamsId[n].setValue(r)}i._cookie&&(this.lightCookieId[n].setValue(i._cookie),this.lightShadowMatrixId[n].setValue(a.data),this.lightCookieIntId[n].setValue(i.cookieIntensity))},e.dispatchSpotLight=function(e,t,i,n){var a,s=i._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(t,n),this.lightInAngleId[n].setValue(i._innerConeAngleCos),this.lightOutAngleId[n].setValue(i._outerConeAngleCos),this.lightRadiusId[n].setValue(i.attenuationEnd),this.lightColorId[n].setValue(e.gammaCorrection?i._linearFinalColor:i._finalColor),s.getTranslation(i._position),this.lightPos[n][0]=i._position.x,this.lightPos[n][1]=i._position.y,this.lightPos[n][2]=i._position.z,this.lightPosId[n].setValue(this.lightPos[n]),0!==i.shape&&this.setLTCPositionalLight(s,n),s.getY(i._direction).mulScalar(-1),i._direction.normalize(),this.lightDir[n][0]=i._direction.x,this.lightDir[n][1]=i._direction.y,this.lightDir[n][2]=i._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),i.castShadows){var r;i._isVsm?r=-2e-4:(r=20*i.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(r*=-100));var o=i._isVsm?i.vsmBias/(i.attenuationEnd/7):i._normalOffsetBias,l=i.getRenderData(null,0);this.lightShadowMapId[n].setValue(l.shadowBuffer),this.lightShadowMatrixId[n].setValue(l.shadowMatrix.data);var h=i._shadowRenderParams;h.length=4,h[0]=i._shadowResolution,h[1]=o,h[2]=r,h[3]=1/i.attenuationEnd,this.lightShadowParamsId[n].setValue(h),a=l.shadowMatrix}if(i._cookie){if(this.lightCookieId[n].setValue(i._cookie),!i.castShadows){var c=d.getSpotCookieCamera();c.fov=2*i._outerConeAngle;var u=c._node;u.setPosition(i._node.getPosition()),u.setRotation(i._node.getRotation()),u.rotateLocal(-90,0,0),ba.setTRS(u.getPosition(),u.getRotation(),de.ONE).invert(),xa.mul2(c.projectionMatrix,ba),(a=i.cookieMatrix).mul2(na.scaleShiftMatrix,xa)}this.lightShadowMatrixId[n].setValue(a.data),this.lightCookieIntId[n].setValue(i.cookieIntensity),i._cookieTransform&&(i._cookieTransformUniform[0]=i._cookieTransform.x,i._cookieTransformUniform[1]=i._cookieTransform.y,i._cookieTransformUniform[2]=i._cookieTransform.z,i._cookieTransformUniform[3]=i._cookieTransform.w,this.lightCookieMatrixId[n].setValue(i._cookieTransformUniform),i._cookieOffsetUniform[0]=i._cookieOffset.x,i._cookieOffsetUniform[1]=i._cookieOffset.y,this.lightCookieOffsetId[n].setValue(i._cookieOffsetUniform))}},e.dispatchLocalLights=function(e,t,i,n,a){var s,r,o,l=e[1],h=e[2],c=n,u=l.length,d=h.length,p=c,f=this.device.scope;for(s=0;s<u;s++)(r=l[s]).mask&i&&(r.isStatic||(this.dispatchOmniLight(t,f,r,p),p++));var m=0;if(a)for(r=a[m];r&&1===r._type;)this.dispatchOmniLight(t,f,r,p),p++,r=a[++m];for(s=0;s<d;s++)(o=h[s]).mask&i&&(o.isStatic||(this.dispatchSpotLight(t,f,o,p),p++));if(a)for(o=a[m];o&&2===o._type;)this.dispatchSpotLight(t,f,o,p),p++,o=a[++m]},e.cull=function(e,t,i,n){var a,s,r,o=0,l=t.length,h=e.cullingMask||4294967295;if(!e.frustumCulling){for(a=0;a<l;a++)((s=t[a]).visible||s.command)&&(s.mask&&0==(s.mask&h)||(i[o]=s,o++,s.visibleThisFrame=!0));return o}for(a=0;a<l;a++)if((s=t[a]).command)i[o]=s,o++,s.visibleThisFrame=!0;else{var c;if(!s.visible)continue;if(r=!0,s.mask&&0==(s.mask&h))continue;!n&&0<(null==(c=s.material)?void 0:c.transmission)?r=!1:s.cull&&(r=s._isVisible(e)),r&&(i[o]=s,o++,s.visibleThisFrame=!0)}return o},e.cullLights=function(e,t){for(var i=0;i<t.length;i++){var n=t[i];!n.visibleThisFrame&&n.enabled&&(0===n._type?n.visibleThisFrame=!0:(n.getBoundingSphere(Ga),(e.frustum.containsSphere(Ga)||n.castShadows&&!n.shadowMap)&&(n.visibleThisFrame=!0)))}},e.updateCpuSkinMatrices=function(e){ja++;var t,i,n=e.length;if(0!==n)for(t=0;t<n;t++)(i=e[t].skinInstance)&&(i.updateMatrices(e[t].node,ja),i._dirty=!0)},e.updateGpuSkinMatrices=function(e){var t,i,n=e.length;for(t=0;t<n;t++)e[t].visibleThisFrame&&(i=e[t].skinInstance)&&i._dirty&&(i.updateMatrixPalette(e[t].node,ja),i._dirty=!1)},e.updateMorphing=function(e){var t,i,n=e.length;for(t=0;t<n;t++)(i=e[t].morphInstance)&&i._dirty&&e[t].visibleThisFrame&&i.update()},e.setBaseConstants=function(e,t){e.setCullMode(t.cull),t.opacityMap&&(this.opacityMapId.setValue(t.opacityMap),this.alphaTestId.setValue(t.alphaTest))},e.setSkinning=function(e,t,i){t.skinInstance&&(this._skinDrawCalls++,e.supportsBoneTextures?(ha=t.skinInstance.boneTexture,this.boneTextureId.setValue(ha),Wa[0]=ha.width,Wa[1]=ha.height,Wa[2]=1/ha.width,Wa[3]=1/ha.height,this.boneTextureSizeId.setValue(Wa)):this.poseMatrixId.setValue(t.skinInstance.matrixPalette))},e.drawInstance=function(e,t,i,n,a){if(ca=t.instancingData){if(0<ca.count&&(this._instancedDrawCalls++,e.setVertexBuffer(ca.vertexBuffer),e.draw(i.primitive[n],ca.count),ca.vertexBuffer===Ha))return this._removedByInstancing+=ca.count,t.instancingData=null,ca.count-1}else ua=t.node.worldTransform,this.modelMatrixId.setValue(ua.data),a&&(da=t.node.normalMatrix,t.node._dirtyNormal&&(ua.invertTo3x3(da),da.transpose(),t.node._dirtyNormal=!1),this.normalMatrixId.setValue(da.data)),e.draw(i.primitive[n]);return 0},e.drawInstance2=function(e,t,i,n){if(ca=t.instancingData){if(0<ca.count&&(this._instancedDrawCalls++,e.draw(i.primitive[n],ca.count,!0),ca.vertexBuffer===Ha))return this._removedByInstancing+=ca.count,t.instancingData=null,ca.count-1}else e.draw(i.primitive[n],void 0,!0);return 0},e.renderShadows=function(e,t){var i=this.device;i.grabPassAvailable=!1;for(var n=0;n<e.length;n++)this._shadowRenderer.render(e[n],t);i.webgl2?i.setDepthBias(!1):i.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)),i.grabPassAvailable=!0},e.updateShader=function(e,t,i,n,a){e.material._scene=this.scene,e.material._dirtyBlend&&(this.scene.layers._dirtyBlend=!0),e.material.updateShader(this.device,this.scene,t,i,n,a),e._shader[n]=e.material.shader},e.setCullMode=function(e,t,i){var n=i.material,a=0;if(e){var s=1;if(0<n.cull&&n.cull<3){i.flipFaces&&(s*=-1),t&&(s*=-1);var r=i.node.worldTransform;r.getX(Va),r.getY(Ua),r.getZ(Na),Va.cross(Va,Ua),Va.dot(Na)<0&&(s*=-1)}a=s<0?2===n.cull?1:2:n.cull}if(this.device.setCullMode(a),0===a&&0===n.cull){var o=i.node.worldTransform;o.getX(Va),o.getY(Ua),o.getZ(Na),Va.cross(Va,Ua),Va.dot(Na)<0?this.twoSidedLightingNegScaleFactorId.setValue(-1):this.twoSidedLightingNegScaleFactorId.setValue(1)}},e.setVertexBuffers=function(e,t){e.setVertexBuffer(t.vertexBuffer)},e.setMorphing=function(e,t){if(t)if(t.morph.useTextureMorph)e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams);else{for(var i,n,a=0;a<t._activeVertexBuffers.length;a++)(i=t._activeVertexBuffers[a])&&(n="ATTR"+(a+8),i.format.elements[0].name=n,i.format.elements[0].scopeId=e.scope.resolve(n),i.format.update(),e.setVertexBuffer(i));this.morphWeightsA.setValue(t._shaderMorphWeightsA),this.morphWeightsB.setValue(t._shaderMorphWeightsB)}},e.dispatchViewPos=function(e){var t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t)},e.renderForward=function(e,t,i,n,a,s,r,o,l){var h,c,u,d,p,f,m,v,g,_,y,b,x,M,S=this.device,w=this.scene,C=e.vrDisplay,P=o?o._lightHash:0,T=1<<a,A=null,E=.5*S.width;for(h=0;h<i;h++)if(c=t[h],!s||!c.mask||s&c.mask)if(c.command)c.command();else{if(u=c.mesh,d=c.material,p=c._shaderDefs,m=c.mask,this.setSkinning(S,c,d),d&&d===A&&p!==_&&(A=null),(c.isStatic||b)&&(A=null),d!==A&&(this._materialSwitches++,d.dirty&&(d.updateUniforms(e),d.dirty=!1),c._shader[a]&&c._shaderDefs===p&&c._lightHash===P||(c.isStatic?this.updateShader(c,p,c._staticLightList,a,n):(f=a+"_"+p+"_"+P,c._shader[a]=d.variants[f],c._shader[a]||(this.updateShader(c,p,null,a,n),d.variants[f]=c._shader[a])),c._shaderDefs=p,c._lightHash=P),c._shader[a].failed||S.setShader(c._shader[a])||(c._shader[a].failed=!0),d.setParameters(S),A&&m===y||(g=this.dispatchDirectLights(n[0],w,m,e),this.dispatchLocalLights(n,w,m,g,c._staticLightList)),this.alphaTestId.setValue(d.alphaTest),S.setBlending(d.blend),d.blend&&(d.separateAlphaBlend?(S.setBlendFunctionSeparate(d.blendSrc,d.blendDst,d.blendSrcAlpha,d.blendDstAlpha),S.setBlendEquationSeparate(d.blendEquation,d.blendAlphaEquation)):(S.setBlendFunction(d.blendSrc,d.blendDst),S.setBlendEquation(d.blendEquation))),S.setColorWrite(d.redWrite,d.greenWrite,d.blueWrite,d.alphaWrite),S.setDepthWrite(d.depthWrite),d.depthWrite&&!d.depthTest?(S.setDepthFunc(7),S.setDepthTest(!0)):(d.depthFunc?S.setDepthFunc(d.depthFunc):S.setDepthFunc(3),S.setDepthTest(d.depthTest)),S.setAlphaToCoverage(d.alphaToCoverage),d.depthBias||d.slopeDepthBias?(S.setDepthBias(!0),S.setDepthBiasValues(d.depthBias,d.slopeDepthBias)):S.setDepthBias(!1)),this.setCullMode(e._cullFaces,l,c),x=c.stencilFront||d.stencilFront,M=c.stencilBack||d.stencilBack,x||M?(S.setStencilTest(!0),x===M?(S.setStencilFunc(x.func,x.ref,x.readMask),S.setStencilOperation(x.fail,x.zfail,x.zpass,x.writeMask)):(x?(S.setStencilFuncFront(x.func,x.ref,x.readMask),S.setStencilOperationFront(x.fail,x.zfail,x.zpass,x.writeMask)):(S.setStencilFuncFront(7,0,255),S.setStencilOperationFront(0,0,0,255)),M?(S.setStencilFuncBack(M.func,M.ref,M.readMask),S.setStencilOperationBack(M.fail,M.zfail,M.zpass,M.writeMask)):(S.setStencilFuncBack(7,0,255),S.setStencilOperationBack(0,0,0,255)))):S.setStencilTest(!1),c.setParameters(S,T),this.setVertexBuffers(S,u),this.setMorphing(S,c.morphInstance),v=c.renderStyle,S.setIndexBuffer(u.indexBuffer[v]),r&&r(c,h),C&&C.presenting)S.setViewport(0,0,E,S.height),this.projId.setValue(oa.data),this.projSkyboxId.setValue(oa.data),this.viewInvId.setValue(Ea.data),this.viewId.setValue(Da.data),this.viewId3.setValue(Oa.data),this.viewProjId.setValue(za.data),this.dispatchViewPos(ka),h+=this.drawInstance(S,c,u,v,!0),this._forwardDrawCalls++,S.setViewport(E,0,E,S.height),this.projId.setValue(la.data),this.projSkyboxId.setValue(la.data),this.viewInvId.setValue(Ra.data),this.viewId.setValue(Ia.data),this.viewId3.setValue(Fa.data),this.viewProjId.setValue(Ba.data),this.dispatchViewPos(La),h+=this.drawInstance2(S,c,u,v),this._forwardDrawCalls++;else if(e.xr&&e.xr.session&&e.xr.views.length)for(var R=e.xr.views,D=0;D<R.length;D++){var I=R[D];S.setViewport(I.viewport.x,I.viewport.y,I.viewport.z,I.viewport.w),this.projId.setValue(I.projMat.data),this.projSkyboxId.setValue(I.projMat.data),this.viewId.setValue(I.viewOffMat.data),this.viewInvId.setValue(I.viewInvOffMat.data),this.viewId3.setValue(I.viewMat3.data),this.viewProjId.setValue(I.projViewOffMat.data),this.viewPosId.setValue(I.position),h+=0===D?this.drawInstance(S,c,u,v,!0):this.drawInstance2(S,c,u,v),this._forwardDrawCalls++}else h+=this.drawInstance(S,c,u,v,!0),this._forwardDrawCalls++;h<i-1&&t[h+1].material===d&&d.setParameters(S,c.parameters),A=d,_=p,y=m,b=c.isStatic}S.updateEnd()},e.setupInstancing=function(e){e.enableAutoInstancing&&(Ha||(Ha=new ht(e,ut.defaultInstancingFormat,e.autoInstancingMaxObjects,1)))},e.revertStaticMeshes=function(e){var t,i,n,a=e,s=a.length,r=[];for(t=0;t<s;t++)(i=a[t])._staticSource?i._staticSource!==n&&(r.push(i._staticSource),n=i._staticSource):r.push(i);for(e.length=r.length,t=0;t<r.length;t++)e[t]=r[t]},e.prepareStaticMeshes=function(e,t){var i,n,a,s,r,o,l=this.device;this.scene;var h,c,u,d,p,f,m,v,g,_,y,b,x,M,S,w,C,P,T,A,E,R,D,I,k,L,O,F,z,B,V,U=e,N=U.length,G=[],W=new de,H=new de,j=new ue,X=new pe,q=[],$=[],Y=[],K=[];for(i=0;i<N;i++)if((h=U[i]).isStatic){for(z=h.aabb,K.length=0,F=1;F<=2;F++)for(n=0;n<t.length;n++)if((c=t[n])._type===F&&c.enabled&&c.mask&h.mask&&c.isStatic){if($[n]||($[n]=new ue,c._node.getWorldTransform(),c.getBoundingSphere(Ga),$[n].center.copy(Ga.center),$[n].halfExtents.x=Ga.radius,$[n].halfExtents.y=Ga.radius,$[n].halfExtents.z=Ga.radius),!$[n].intersects(z))continue;K.push(n)}if(0===K.length){G.push(h);continue}for(I=(u=h.mesh).vertexBuffer,d=2===(D=u.indexBuffer[h.renderStyle]).bytesPerIndex?new Uint16Array(D.lock()):new Uint32Array(D.lock()),f=u.primitive[h.renderStyle].count/3,_=u.primitive[h.renderStyle].base,m=I.format.elements,v=I.format.size/4,p=new Float32Array(I.storage),a=0;a<m.length;a++)m[a].name===Te&&(g=m[a].offset/4);for(q.length=f,a=0;a<f;a++)q[a]=0;for(R=!1,Y.length=6*f,a=0;a<f;a++){for(M=Number.MAX_VALUE,S=Number.MAX_VALUE,w=Number.MAX_VALUE,C=-Number.MAX_VALUE,P=-Number.MAX_VALUE,T=-Number.MAX_VALUE,s=0;s<3;s++)(y=p[o=(o=d[3*a+s+_])*v+g])<M&&(M=y),(b=p[o+1])<S&&(S=b),(x=p[o+2])<w&&(w=x),C<y&&(C=y),P<b&&(P=b),T<x&&(T=x);Y[o=6*a]=M,Y[o+1]=S,Y[o+2]=w,Y[o+3]=C,Y[o+4]=P,Y[o+5]=T}for(r=0;r<K.length;r++)for(c=t[n=K[r]],X.copy(h.node.worldTransform).invert(),j.setFromTransformedAabb($[n],X),A=j.getMin(),E=j.getMax(),B=1<<r,a=0;a<f;a++)Y[o=6*a]<=E.x&&Y[o+3]>=A.x&&Y[o+1]<=E.y&&Y[o+4]>=A.y&&Y[o+2]<=E.z&&Y[o+5]>=A.z&&(q[a]|=B,R=!0);if(R){for(k={},a=0;a<f;a++)n=3*a+_,k[L=q[a]]||(k[L]=[]),(O=k[L]).push(d[n]),O.push(d[n+1]),O.push(d[n+2]);for(L in k){O=k[L];var Z=new qi(l,D.format,O.length,D.usage);for((2===Z.bytesPerIndex?new Uint16Array(Z.lock()):new Uint32Array(Z.lock())).set(O),Z.unlock(),M=Number.MAX_VALUE,S=Number.MAX_VALUE,w=Number.MAX_VALUE,C=-Number.MAX_VALUE,P=-Number.MAX_VALUE,T=-Number.MAX_VALUE,a=0;a<O.length;a++)(y=p[(o=O[a])*v+g])<M&&(M=y),(b=p[o*v+g+1])<S&&(S=b),(x=p[o*v+g+2])<w&&(w=x),C<y&&(C=y),P<b&&(P=b),T<x&&(T=x);W.set(M,S,w),H.set(C,P,T);var Q=new ue;Q.setMinMax(W,H);var J=new Zi(l);J.vertexBuffer=I,J.indexBuffer[0]=Z,J.primitive[0].type=4,J.primitive[0].base=0,J.primitive[0].count=O.length,J.primitive[0].indexed=!0,J.aabb=Q;var ee=new Mn(J,h.material,h.node);for(ee.isStatic=h.isStatic,ee.visible=h.visible,ee.layer=h.layer,ee.castShadow=h.castShadow,ee._receiveShadow=h._receiveShadow,ee.cull=h.cull,ee.pick=h.pick,ee.mask=h.mask,ee.parameters=h.parameters,ee._shaderDefs=h._shaderDefs,(ee._staticSource=h)._staticLightList?ee._staticLightList=h._staticLightList:ee._staticLightList=[],a=0;a<K.length;a++)L&(B=1<<a)&&(V=t[K[a]],ee._staticLightList.indexOf(V)<0&&ee._staticLightList.push(V));ee._staticLightList.sort(this.lightCompare),G.push(ee)}}else G.push(h)}else G.push(h);for(e.length=G.length,i=0;i<G.length;i++)e[i]=G[i]},e.updateShaders=function(e){for(var t,i=e.length,n=0;n<i;n++)(t=e[n].material)&&(Xa.has(t)||(Xa.add(t),t.updateShader!==Ui.prototype.updateShader&&(t.clearVariants(),t.shader=null)));Xa.clear()},e.updateLitShaders=function(e){for(var t,i=e.length,n=0;n<i;n++)(t=e[n].material)&&(Xa.has(t)||(Xa.add(t),t.updateShader!==Ui.prototype.updateShader&&(!t.useLighting||t.emitter&&!t.emitter.lighting||(t.clearVariants(),t.shader=null))));Xa.clear()},e.beginFrame=function(e){var t,i=this.scene,n=e._meshInstances,a=e._lights;i.updateShaders?(this.updateShaders(n),i.updateShaders=!1,i.updateLitShaders=!1,i._shaderVersion++):i.updateLitShaders&&(this.updateLitShaders(n),i.updateLitShaders=!1,i._shaderVersion++),this.updateCpuSkinMatrices(n);var s=n.length;for(t=0;t<s;t++)n[t].visibleThisFrame=!1;for(s=a.length,t=0;t<s;t++)a[t].visibleThisFrame=0===a[t]._type},e.beginLayers=function(e){var t,i,n,a,s=this.scene,r=e.layerList.length,o=this.scene._shaderVersion;for(i=0;i<r;i++)e.layerList[i]._postRenderCounter=0;for(i=0;i<r;i++){for((t=e.layerList[i])._shaderVersion=o,t._preRenderCalledForCameras=0,t._postRenderCalledForCameras=0,a=e.subLayerList[i],t._postRenderCounter|=a?2:1,t._postRenderCounterMax=t._postRenderCounter,n=0;n<t.cameras.length;n++)t.instances.prepare(n);t._needsStaticPrepare&&t._staticLightHash&&(t._staticPrepareDone&&(this.revertStaticMeshes(t.opaqueMeshInstances),this.revertStaticMeshes(t.transparentMeshInstances)),this.prepareStaticMeshes(t.opaqueMeshInstances,t._lights),this.prepareStaticMeshes(t.transparentMeshInstances,t._lights),e._dirty=!0,s.updateShaders=!0,t._needsStaticPrepare=!1,t._staticPrepareDone=!0)}},e.gpuUpdate=function(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e)},e.setSceneConstants=function(){var e,t=this.device,i=this.scene;if(this.dispatchGlobalLights(i),i.fog!==_e){if(this.fogColor[0]=i.fogColor.r,this.fogColor[1]=i.fogColor.g,this.fogColor[2]=i.fogColor.b,i.gammaCorrection)for(e=0;e<3;e++)this.fogColor[e]=Math.pow(this.fogColor[e],2.2);this.fogColorId.setValue(this.fogColor),"linear"===i.fog?(this.fogStartId.setValue(i.fogStart),this.fogEndId.setValue(i.fogEnd)):this.fogDensityId.setValue(i.fogDensity)}this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize)},e.updateLightStats=function(e,t){},e.cullShadowmaps=function(e){for(var t=0;t<e._lights.length;t++){var i=e._lights[t];if(0!==i._type&&i.visibleThisFrame&&i.castShadows&&0!==i.shadowUpdateMode){var n=e._lightCompositionData[t].shadowCastersList;this._shadowRenderer.cullLocal(i,n)}}for(var a=e._renderActions,s=0;s<a.length;s++)for(var r=a[s],o=r.directionalLightsIndices.length,l=0;l<o;l++){var h=r.directionalLightsIndices[l],c=e._lights[h],u=e._lightCompositionData[h].shadowCastersList;this._shadowRenderer.cullDirectional(c,u,r.camera.camera)}},e.cullComposition=function(e,t){for(var i=e._renderActions,n=0;n<i.length;n++){var a=i[n],s=a.layerIndex,r=e.layerList[s];if(r.enabled&&e.subLayerEnabled[s]){var o=e.subLayerList[s],l=a.cameraIndex,h=r.cameras[l];if(h){h.frameBegin(a.renderTarget),a.firstCameraUse&&(this.updateCameraFrustum(h.camera),this._camerasRendered++),this.cullLights(h.camera,r._lights);var c=r.instances,u=o?c.visibleTransparent[l]:c.visibleOpaque[l];if(!u.done){r.onPreCull&&r.onPreCull(l);var d=o?r.transparentMeshInstances:r.opaqueMeshInstances;u.length=this.cull(h.camera,d,u.list,t),u.done=!0,r.onPostCull&&r.onPostCull(l)}h.frameEnd()}}}this.cullShadowmaps(e)},e.updateClusters=function(e){for(var t=0;t<e._worldClusters.length;t++)e._worldClusters[t].update(e._lights,this.scene.gammaCorrection)},e.renderComposition=function(e,t){void 0===t&&(t={});var i,n,a,s,r,o,l=t,h=l.transmissive,c=void 0===h||h,u=l.postprocess,d=void 0===u||u,p=this.device,f=e._renderActions;this.scene.updateSkybox&&(this.scene._updateSkybox(p),this.scene.updateSkybox=!1),this.beginLayers(e);var m=e._update();for(2&m&&(this.scene.updateLitShaders=!0),this.updateLightStats(e,m),this.beginFrame(e),this.setSceneConstants(),this.cullComposition(e,c),this.updateClusters(e),this.gpuUpdate(e._meshInstances),pi.clusteredLightingEnabled||(this.renderShadows(e._splitLights[2]),this.renderShadows(e._splitLights[1])),a=0;a<f.length;a++)if(r=(n=f[a]).layerIndex,s=e.layerList[r],!(o=e.subLayerList[r])||2!==this.oit||this.device.renderTarget||0!==s.id){var v=n.cameraIndex;if(i=s.cameras[v],0<n.directionalLights.length&&this.renderShadows(n.directionalLights,i.camera),s.enabled&&e.subLayerEnabled[r]){if(i&&i.frameBegin(n.renderTarget),!o&&s.onPreRenderOpaque?s.onPreRenderOpaque(v):o&&s.onPreRenderTransparent&&s.onPreRenderTransparent(v),s._preRenderCalledForCameras&1<<v||(s.onPreRender&&s.onPreRender(v),s._preRenderCalledForCameras|=1<<v),i){var g,_;if(n.clearColor||n.clearDepth||n.clearStencil){var y=i.camera._clearColorBuffer,b=i.camera._clearDepthBuffer,x=i.camera._clearStencilBuffer;i.camera._clearColorBuffer=n.clearColor,i.camera._clearDepthBuffer=n.clearDepth,i.camera._clearStencilBuffer=n.clearStencil,this.clearView(i.camera,n.renderTarget,!0,!0),i.camera._clearColorBuffer=y,i.camera._clearDepthBuffer=b,i.camera._clearStencilBuffer=x}s._sortVisible(o,i.camera.node,v);var M=s.instances,S=o?M.visibleTransparent[v]:M.visibleOpaque[v];this.scene._activeCamera=i.camera,this.setCamera(i.camera,n.renderTarget),pi.clusteredLightingEnabled&&n.lightClusters&&n.lightClusters.activate();var w=!!(i.camera._flipFaces^(null==(g=n)||null==(_=g.renderTarget)?void 0:_.flipY)),C=this._forwardDrawCalls;this.renderForward(i.camera,S.list,S.length,s._splitLights,s.shaderPass,s.cullingMask,s.onDrawCall,s,w),s._forwardDrawCalls+=this._forwardDrawCalls-C,p.setColorWrite(!0,!0,!0,!0),p.setStencilTest(!1),p.setAlphaToCoverage(!1),p.setDepthBias(!1),i.frameEnd(),d&&n.triggerPostprocess&&i.onPostprocessing&&i.onPostprocessing(i)}!o&&s.onPostRenderOpaque?s.onPostRenderOpaque(v):o&&s.onPostRenderTransparent&&s.onPostRenderTransparent(v),!s.onPostRender||s._postRenderCalledForCameras&1<<v||(s._postRenderCounter&=~(o?2:1),0===s._postRenderCounter&&(s.onPostRender(v),s._postRenderCalledForCameras|=1<<v,s._postRenderCounter=s._postRenderCounterMax))}}else this.draw&&this.draw(n.renderTarget)},e.generateRTs=function(){var e,t,i=this.scene.layers.getLayerById(0),n=i._dirty;null!=(e=rm.assets)&&null!=(t=e._assets)&&t.filter(function(e){var t;return"material"===e.type&&0<(null==(t=e.resource)?void 0:t.transmission)}).length&&(this.getTransmissionRT(),rm.scene.skyboxModel&&!rm.generatedTransmissionRT&&(rm.fire("app:renderer:transmissionRT",this.transmissionRenderTarget),rm.generatedTransmissionRT=!0)),1===this.oit&&this.getWBOITRT(),i._dirty=n},e.destroyWBRTs=function(){this.transmissionRenderTarget&&(this.transmissionRenderTarget.destroy(),this.transmissionRenderTarget=null),this.transparentRenderTarget&&(this.transparentRenderTarget.destroy(),this.transparentRenderTarget=null)},e.handleCameraRT=function(e){var t;if(e&&"function"==typeof e){var i,n,a,s=[];null!=(t=this.scene.layers.cameras)&&t.filter(function(e){return e.renderTarget}).length&&(s.push.apply(s,null==(i=this.scene.layers.cameras)?void 0:i.map(function(e){return e.renderTarget})),null==(n=this.scene.layers.cameras)||n.forEach(function(e){e.renderTarget=null})),e(),s.length&&(null==(a=this.scene.layers.cameras)||a.forEach(function(e,t){return e.renderTarget=s[t]}))}},e.getTransmissionRT=function(){var t=this,i=this.device,n=new pi(i,"opaqueObjects");if(!this.transmissionRenderTarget){var e=i._width,a=i._height;this.transmissionRenderTarget=new Fm({colorBuffer:new Kt(i,{name:"_transmissionRenderTarget",mipmaps:!0,width:e,height:a,format:we,minFilter:5,magFilter:0,addressU:1,addressV:1}),depthBuffer:new Kt(i,{name:"transmissionDepthTarget",width:e,height:a,format:16,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})})}var s=this.scene.layers.getLayerById(0),r=s.renderTarget;s.renderTarget=this.transmissionRenderTarget,n.pushOpaque(s);var o=this.scene.layers.getLayerById(2),l=o.renderTarget;o.renderTarget=this.transmissionRenderTarget,n.pushOpaque(o),this.handleCameraRT(function(){var e=i.renderTarget;i.setRenderTarget(t.transmissionRenderTarget),i.updateBegin(),i.clear(),t.renderComposition(n,{transmissive:!1,postprocess:!0}),i.updateEnd(),i.setRenderTarget(e)}),s.renderTarget=r,o.renderTarget=l},e.saveState=function(e,t){var i=this;this.blendFunc=[],e.forEach(function(e){e.material.oit=t,i.blendFunc.push({blend:e.material.blend,blendSrc:e.material.blendSrc,blendDst:e.material.blendDst,blendEquation:e.material.blendEquation,separateAlphaBlend:e.material.separateAlphaBlend,blendSrcAlpha:e.material.blendSrcAlpha,blendDstAlpha:e.material.blendDstAlpha,depthWrite:e.material.depthWrite,depthTest:e.material.depthTest})})},e.recoverState=function(e){var i=this;e.forEach(function(e,t){e.material.oit=0,e.material.dirty=!0,e.material.dirtyShader=!0,i.blendFunc[t]&&(e.material.blend=i.blendFunc[t].blend,e.material.blendSrc=i.blendFunc[t].blendSrc,e.material.blendDst=i.blendFunc[t].blendDst,e.material.blendEquation=i.blendFunc[t].blendEquation,e.material.separateAlphaBlend=i.blendFunc[t].separateAlphaBlend,e.material.blendSrcAlpha=i.blendFunc[t].blendSrcAlpha,e.material.blendDstAlpha=i.blendFunc[t].blendDstAlpha,e.material.depthWrite=i.blendFunc[t].depthWrite,e.material.depthTest=i.blendFunc[t].depthTest)})},e.getDPOITRT=function(){var u=this,d=this.device,p=new pi(d,"DPOITRT"),f=this.scene.layers.getLayerById(0);p.pushTransparent(f),this.saveState(f.transparentMeshInstances,2);var m=Ht(d,Rt.fullscreenQuadVS,Rt.DPOITblendBackPS,"DPOITblendBack"),v=Ht(d,Rt.fullscreenQuadVS,Rt.DPOITfinalPS,"DPOITfinal"),g=-99999;this.DPOIT_NUM_PASS=4;var _=d.gl;return function(e){void 0===e&&(e=null),u.initDPBuffers();var t=d.blendSrc,i=d.blendDst,n=d.blendEquation,a=d.cullMode;f.transparentMeshInstances.forEach(function(e,t){e.material.oit=2}),d.setCullMode(0),_.bindFramebuffer(_.DRAW_FRAMEBUFFER,u.blendBackBuffer._glFrameBuffer),_.clearColor(0,0,0,0),_.clear(_.COLOR_BUFFER_BIT),_.bindFramebuffer(_.FRAMEBUFFER,u.depthPeelBuffers[0]._glFrameBuffer),_.drawBuffers([_.COLOR_ATTACHMENT0]),_.clearColor(g,g,0,0),_.clear(_.COLOR_BUFFER_BIT),_.bindFramebuffer(_.DRAW_FRAMEBUFFER,u.depthPeelBuffers[1]._glFrameBuffer),_.clearColor(-0,1,0,0),_.clear(_.COLOR_BUFFER_BIT),_.bindFramebuffer(_.DRAW_FRAMEBUFFER,u.colorBuffers[0]._glFrameBuffer),_.drawBuffers([_.COLOR_ATTACHMENT0,_.COLOR_ATTACHMENT1]),_.clearColor(0,0,0,0),_.clear(_.COLOR_BUFFER_BIT),_.bindFramebuffer(_.DRAW_FRAMEBUFFER,u.colorBuffers[1]._glFrameBuffer),_.clearColor(0,0,0,0),_.clear(_.COLOR_BUFFER_BIT),f.transparentMeshInstances.forEach(function(e){e.material.setParameter("uDepth",u.depthPeelBuffers[1].colorBuffers[0]),e.material.setParameter("uFrontColor",u.depthPeelBuffers[1].colorBuffers[1]),e.material.blendEquation=4,e.material.blend=!0,e.material.depthWrite=!1,e.material.depthTest=!1}),d.setBlendEquation(4);var s=f.renderTarget;f.renderTarget=u.depthPeelBuffers[0];var r,o,l,h=d.renderTarget;d.setRenderTarget(u.depthPeelBuffers[0]),_.drawBuffers([_.COLOR_ATTACHMENT0]),d.updateBegin(),u.renderComposition(p,{postprocess:!1}),d.updateEnd(),d.setRenderTarget(h),f.renderTarget=s;for(var c=0;c<u.DPOIT_NUM_PASS;c++)o=1-(r=c%2),_.bindFramebuffer(_.DRAW_FRAMEBUFFER,u.depthPeelBuffers[o]._glFrameBuffer),_.drawBuffers([_.COLOR_ATTACHMENT0]),_.clearColor(g,g,0,0),_.clear(_.COLOR_BUFFER_BIT),_.bindFramebuffer(_.DRAW_FRAMEBUFFER,u.colorBuffers[o]._glFrameBuffer),_.drawBuffers([_.COLOR_ATTACHMENT0,_.COLOR_ATTACHMENT1]),_.clearColor(0,0,0,0),_.clear(_.COLOR_BUFFER_BIT),f.transparentMeshInstances.forEach(function(e){e.material.setParameter("uDepth",u.depthPeelBuffers[r].colorBuffers[0]),e.material.setParameter("uFrontColor",u.depthPeelBuffers[r].colorBuffers[1]),e.material.blendEquation=4}),d.setBlendEquation(4),_.bindFramebuffer(_.DRAW_FRAMEBUFFER,u.depthPeelBuffers[o]._glFrameBuffer),_.drawBuffers([_.COLOR_ATTACHMENT0,_.COLOR_ATTACHMENT1,_.COLOR_ATTACHMENT2]),u.renderRT(p,f,u.depthPeelBuffers[o]),l=3*o,f.transparentMeshInstances.forEach(function(e){e.material.blendEquation=0}),d.setBlendEquation(0),d.setBlendFunctionSeparate(6,8,1,8),f.transparentMeshInstances.forEach(function(e){e.material.separateAlphaBlend=!0,e.material.blendSrc=6,e.material.blendDst=8,e.material.blendSrcAlpha=1,e.material.blendDstAlpha=8}),d.scope.resolve("uBackColor").setValue(u.depthPeelBuffers[o].colorBuffers[2]),_.drawBuffers([_.COLOR_ATTACHMENT0]),At(d,u.blendBackBuffer,m,null,null,!0);f.transparentMeshInstances.forEach(function(e){e.material.separateAlphaBlend=!1,e.material.blendSrc=1,e.material.blendDst=8}),d.setBlendFunction(1,8),d.scope.resolve("uFrontColor").setValue(u.depthPeelBuffers[l/3].colorBuffers[1]),d.scope.resolve("uBackColor").setValue(u.blendBackBuffer.colorBuffer),At(d,e,v,null,null,!0),d.setBlendFunction(t,i),d.setBlendEquation(n),d.setCullMode(a),u.recoverState(f.transparentMeshInstances)}},e.renderRT=function(e,t,i){var n=this.device,a=t.renderTarget;t.renderTarget=i;var s=n.renderTarget;n.setRenderTarget(this.depthPeelBuffers[0]),this.device.updateBegin(),this.renderComposition(e,{postprocess:!1}),this.device.updateEnd(),n.setRenderTarget(s),t.renderTarget=a},e.initDPBuffers=function(){var e,i=this.device,t={width:i.width,height:i.height,autoResolve:!0,samples:2,_compareFunc:3,format:we},n={addressU:1,addressV:1,magFilter:0,minFilter:0};if(null==(e=this.depthPeelBuffers)||!e.length){var a=new Kt(i,h({name:"frontColor1"},t,n)),s=new Kt(i,h({name:"frontColor2"},t,n)),r=new Kt(i,h({name:"frontColor2"},t,n)),o=new Kt(i,h({name:"frontColor2"},t,n));this.depthPeelBuffers=[new Fm({depth:!1,colorBuffers:[new Kt(i,h({name:"depth1"},t,n,{format:Ce})),a,r]}),new Fm({depth:!1,colorBuffers:[new Kt(i,h({name:"depth2"},t,n,{format:Ce})),s,o]})],this.colorBuffers=[new Fm({depth:!1,colorBuffers:[a,r]}),new Fm({depth:!1,colorBuffers:[s,o]})],this.blendBackBuffer=new Fm({colorBuffer:new Kt(i,h({name:"blendBack",_compareFunc:3},t,n))})}this.depthPeelBuffers.forEach(function(e,t){e._colorBuffer=e.colorBuffers[0],i.initRenderTarget(e)}),this.colorBuffers.forEach(function(e,t){e._colorBuffer=e.colorBuffers[0],i.initRenderTarget(e)}),i.initRenderTarget(this.blendBackBuffer)},e.destroyDPRTS=function(){var e,t;null!=(e=this.depthPeelBuffers)&&e.length&&(this.depthPeelBuffers.forEach(function(e){return e.destroy()}),this.depthPeelBuffers=[]),null!=(t=this.colorBuffers)&&t.length&&(this.colorBuffers.forEach(function(e){return e.destroy()}),this.colorBuffers=[]),this.blendBackBuffer&&(this.blendBackBuffer.destroy(),this.blendBackBuffer=null)},e.getWBOITRT=function(){var e=this,t=this.device,i=new pi(t,"transparentObjects");this.transparentRenderTarget||(this.transparentRenderTarget=new Fm({colorBuffer:new Kt(t,{name:"transparentRenderTarget",width:t.width,height:t.height,format:we}),depth:!0}),this.accumAlphaRenderTarget=new Fm({colorBuffer:new Kt(t,{name:"accumAlphaRenderTarget",width:t.width,height:t.height,format:we}),depth:!0}));var n=this.scene.layers.getLayerById(0),a=n.renderTarget;n.renderTarget=this.transparentRenderTarget,i.pushTransparent(n);var s=[];n.transparentMeshInstances.forEach(function(e){e.material.accumOIT=!0,e.material.setParameter("accumAlpha",!1),s.push({separateAlphaBlend:e.material.separateAlphaBlend,blendDst:e.material.blendDst,blendSrcAlpha:e.material.blendSrcAlpha,blendDstAlpha:e.material.blendDstAlpha,depthWrite:e.material.depthWrite,depthTest:e.material.depthTest}),e.material.depthWrite=!1,e.material.depthTest=!1,e.material.depthFunc=1,e.material.separateAlphaBlend=!0,e.material.blendSrc=1,e.material.blendDst=1,e.material.blendSrcAlpha=0,e.material.blendDstAlpha=8}),this.handleCameraRT(function(){t.updateBegin(),t.clear(),e.renderComposition(i,{transmissive:!1,postprocess:!1}),t.updateEnd(),n.transparentMeshInstances.forEach(function(e){e.material.setParameter("accumAlpha",!0)}),t.setRenderTarget(e.accumAlphaRenderTarget),n.renderTarget=e.accumAlphaRenderTarget,t.updateBegin(),t.clear(),e.renderComposition(i,{transmissive:!1,postprocess:!1}),t.updateEnd()}),n.transparentMeshInstances.forEach(function(e,t){e.material.accumOIT=!1,e.material.dirty=!0,e.material.dirtyShader=!0,e.material.setParameter("accumAlpha",!1),s[t]&&(e.material.separateAlphaBlend=s[t].separateAlphaBlend,e.material.blendSrc=1,e.material.blendDst=8,e.material.blendSrcAlpha=s[t].blendSrcAlpha,e.material.blendDstAlpha=s[t].blendDstAlpha,e.material.depthWrite=s[t].depthWrite,e.material.depthTest=s[t].depthTest,e.material.depthFunc=null)}),n.renderTarget=a},c(d,[{key:"oit",get:function(){return this._oit},set:function(e){var t=this.scene.layers.getLayerById(0);if(e!==this._oit)switch(this._oit){case 1:this.destroyWBRTs();break;case 2:this.draw=null,this.destroyDPRTS()}if(t){switch(e){case 0:t.transparentMeshInstances.forEach(function(e){e.material.oit&&(e.material.oit=0)}),t.transparentSortMode=3;break;case 1:t.transparentMeshInstances.forEach(function(e){e.material.oit=1}),t.transparentSortMode=0;break;case 2:t.transparentSortMode=0,this.draw=this.getDPOITRT();break;case 3:t.transparentMeshInstances.forEach(function(e){e.material.oit&&(e.material.oit=0)}),t.transparentSortMode=2}this._oit=e}}}]),d}();qa.spotCookieCamera=null;var $a,Ya=function(){function v(){}return v.createTexture=function(e,t,i){var n=new Kt(e,{width:i,height:i,format:t,addressU:1,addressV:1,type:Ze,magFilter:1,minFilter:0,anisotropy:1});return n.name="AreaLightLUT",n},v.setUniforms=function(e,t,i){e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(i)},v.createPlaceholder=function(e){var t=v.createTexture(e,7,2);t.lock().fill(0),t.unlock(),v.setUniforms(e,t,t)},v.set=function(e,t){function i(e,t,i){var n=v.createTexture(e,i,64);return n.lock().set(t),n.unlock(),n.upload(),n}function n(e,t,i){for(var n=e.length,a=new Float32Array(n),s=0;s<n;s++){var r=s%4;a[s]=(e[s]+t[r])*i[r]}return a}function a(e){for(var t=e.length,i=new Uint16Array(t),n=Se.float2Half,a=0;a<t;a++)i[a]=n(e[a]);return i}function s(e){for(var t=e.length,i=new Uint8ClampedArray(t),n=0;n<t;n++)i[n]=255*e[n];return i}var r=new Int16Array(t,0,2),o=r[0],l=r[1];if(0!==o||1!==l);else{var h,c,u=new Float32Array(t,4,16384),d=new Float32Array(t,65540,16384),p=e.areaLightLutFormat;p===Ce?(h=u,c=d):p===we?(h=a(u),c=a(d)):(h=s(n(u,[0,.2976,.01381,0],[.999,3.08737,1.6546,.603249])),c=s(n(d,[-.306897,0,0,0],[1.442787,1,1,1])));var f=i(e,h,p),m=i(e,c,p);v.setUniforms(e,f,m)}},v}(),Ka=function(t){function i(){var e;return(e=t.call(this)||this).color=new $(1,1,1,1),e.colorUniform=new Float32Array(4),e.colorMap=null,e.vertexColors=!1,e}u(i,t);var e=i.prototype;return e.clone=function(){var e=new i;return Ui.prototype._cloneInternal.call(this,e),e.color.copy(this.color),e.colorMap=this.colorMap,e.vertexColors=this.vertexColors,e},e.updateUniforms=function(){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},e.updateShader=function(e,t,i,n,a,s){var r={skin:i&&0!=(2&i),screenSpace:i&&0!=(256&i),useInstancing:i&&0!=(32&i),useMorphPosition:i&&0!=(1024&i),useMorphNormal:i&&0!=(2048&i),useMorphTextureBased:i&&0!=(4096&i),vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:a},o=e.getProgramLibrary();this.shader=o.getProgram("basic",r)},i}(Ui),Za=new mn,Qa=function(){function e(){this.numLinesAllocated=128,this.vb=null,this.vbRam=null,this.mesh=null,this.linesUsed=0,this.material=null,this.meshInstance=null,this.meshInstanceArray=[],this.layer=null}var t=e.prototype;return t.init=function(e,t,i,n){for(this.mesh||(this.mesh=new Zi(e),this.mesh.primitive[0].type=1,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new Ka,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=2,this.material.update()),this.layer=i;this.linesUsed+n>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=t,this.vb||(this.vb=new ht(e,t,2*this.numLinesAllocated,1),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(Za.worldTransform=pe.IDENTITY,Za._dirtyWorld=Za._dirtyNormal=!1,this.meshInstance=new Mn(this.mesh,this.material,Za),this.meshInstance.cull=!1))},t.addLines=function(e,t){for(var i,n=!!t.length,a=2*this.linesUsed*this.vertexFormat.size,s=0;s<e.length;s++)this.vbRam.setFloat32(a,e[s].x,!0),a+=4,this.vbRam.setFloat32(a,e[s].y,!0),a+=4,this.vbRam.setFloat32(a,e[s].z,!0),a+=4,i=n?t[s]:t,this.vbRam.setUint8(a,255*i.r),a+=1,this.vbRam.setUint8(a,255*i.g),a+=1,this.vbRam.setUint8(a,255*i.b),a+=1,this.vbRam.setUint8(a,255*i.a),a+=1;this.linesUsed+=e.length/2},t.finalize=function(e){0<this.linesUsed&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,e[0]=this.meshInstance,this.layer.addMeshInstances(e,!0),this.linesUsed=0)},e}(),Ja=function(){function i(e){this.lineVertexFormat=new ut(e,[{semantic:Te,components:3,type:6},{semantic:Ie,components:4,type:1,normalize:!0}]),this.device=e,this.lineBatches=[],this.layers=[],this.layerToBatch={},this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.meshInstanceArray=[],this.usedGraphNodes=[],this.freeGraphNodes=[]}i.getTextureVS=function(){return"\n            attribute vec2 aPosition;\n            uniform mat4 matrix_model;\n            varying vec2 uv0;\n            void main(void) {\n                gl_Position = matrix_model * vec4(aPosition, 0, 1);\n                uv0 = aPosition.xy + 0.5;\n                uv0.y = 1.0 - uv0.y;\n            }\n        "};var e=i.prototype;return e.getTextureShader=function(){if(!this.textureShader){var e={attributes:{aPosition:Te},vshader:i.getTextureVS(),fshader:"\n                    precision lowp float;\n                    varying vec2 uv0;\n                    uniform sampler2D colorMap;\n                    void main (void) {\n                        gl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);\n                    }\n                "};this.textureShader=new Et(this.device,e)}return this.textureShader},e.getDepthTextureShader=function(){if(!this.depthTextureShader){var e=this.device.webgl2?"#define GL2":"",t={attributes:{aPosition:Te},vshader:i.getTextureVS(),fshader:"\n                    precision "+this.device.precision+" float;\n                    "+e+"\n                    "+Dt.screenDepthPS+"\n                    varying vec2 uv0;\n                    void main() {\n                        float depth = getLinearScreenDepth(uv0) * camera_params.x;\n                        gl_FragColor = vec4(vec3(depth), 1.0);\n                    }\n                    "};this.depthTextureShader=new Et(this.device,t)}return this.depthTextureShader},e.getQuadMesh=function(){if(!this.quadMesh){var e=new ut(this.device,[{semantic:Te,components:3,type:6}]),t=new ht(this.device,e,4),i=new Ct(t);i.element.POSITION.set(-.5,-.5,0),i.next(),i.element.POSITION.set(.5,-.5,0),i.next(),i.element.POSITION.set(-.5,.5,0),i.next(),i.element.POSITION.set(.5,.5,0),i.end(),this.quadMesh=new Zi(this.device),this.quadMesh.vertexBuffer=t,this.quadMesh.primitive[0].type=5,this.quadMesh.primitive[0].base=0,this.quadMesh.primitive[0].count=4,this.quadMesh.primitive[0].indexed=!1}return this.quadMesh},e.renderMesh=function(e,t,i,n,a){if(!n){var s=this.getGraphNode(t);(n=new Mn(i,e,s)).cull=!1}this.addLayer(a.layer),a.mask&&(n.mask=a.mask),this.meshInstanceArray[0]=n,a.layer.addMeshInstances(this.meshInstanceArray,!0)},e.renderWireCube=function(e,t,i){if(!this.cubeLocalPos){this.cubeLocalPos=[new de(-.5,-.5,-.5),new de(-.5,.5,-.5),new de(.5,.5,-.5),new de(.5,-.5,-.5),new de(-.5,-.5,.5),new de(-.5,.5,.5),new de(.5,.5,.5),new de(.5,-.5,.5)],this.cubeWorldPos=[new de,new de,new de,new de,new de,new de,new de,new de];var n=this.cubeWorldPos;this.cubePositions=[n[0],n[1],n[1],n[2],n[2],n[3],n[3],n[0],n[4],n[5],n[5],n[6],n[6],n[7],n[7],n[4],n[0],n[4],n[1],n[5],n[2],n[6],n[3],n[7]]}for(var a=this.cubeLocalPos,s=this.cubeWorldPos,r=0;r<8;r++)e.transformPoint(a[r],s[r]);this.prepareLineBatch(i.layer,i.depthTest,void 0,this.cubePositions.length).addLines(this.cubePositions,t)},e.renderWireSphere=function(e,t,i,n){if(!this.spherePoints){this.spherePoints=[];for(var a=0;a<120;a++)this.spherePoints.push(new de)}for(var s=this.spherePoints,r=2*Math.PI/20,o=0,l=0;l<20;l++){var h=Math.sin(o),c=Math.cos(o);o+=r;var u=Math.sin(o),d=Math.cos(o);s[6*l].set(e.x+t*h,e.y,e.z+t*c),s[6*l+1].set(e.x+t*u,e.y,e.z+t*d),s[6*l+2].set(e.x+t*h,e.y+t*c,e.z),s[6*l+3].set(e.x+t*u,e.y+t*d,e.z),s[6*l+4].set(e.x,e.y+t*h,e.z+t*c),s[6*l+5].set(e.x,e.y+t*u,e.z+t*d)}this.prepareLineBatch(n.layer,n.depthTest,void 0,s.length).addLines(s,i)},e.getGraphNode=function(e){var t=null;return t=0<this.freeGraphNodes.length?this.freeGraphNodes.pop():new mn,this.usedGraphNodes.push(t),t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1,t},e.addLayer=function(e){this.layers.indexOf(e)<0&&this.layers.push(e)},e.getLayerIdx=function(e){return this.layerToBatch[e.id]},e.addLayerIdx=function(e,t){this.layerToBatch[t.id]=e},e.finalize=function(){for(var e=0;e<this.lineBatches.length;e++)this.lineBatches[e]&&this.lineBatches[e].finalize(this.meshInstanceArray)},e.clear=function(){for(var e=0;e<this.layers.length;e++)this.layers[e].clearMeshInstances(!0);var t=this.freeGraphNodes;this.freeGraphNodes=this.usedGraphNodes,this.usedGraphNodes=t,this.layers.length=0},e.prepareLineBatch=function(e,t,i,n){this.addLayer(e);var a=this.getLayerIdx(e);if(void 0===a){var s=new Qa;s.init(this.device,this.lineVertexFormat,e,n),s.material.depthTest=t,i&&(s.meshInstance.mask=i),a=this.lineBatches.push(s)-1,this.addLayerIdx(a,e)}else this.lineBatches[a].init(this.device,this.lineVertexFormat,e,n),this.lineBatches[a].material.depthTest=t,i&&(this.lineBatches[a].meshInstance.mask=i);return this.lineBatches[a]},i}(),es=new de,ts=new ge,is=function(e,t){void 0===t&&(t=null),(this.node=e).render?(this.component=e.render,t=t||e.render.meshInstances):(this.component=e.model,t=t||e.model.model.meshInstances),this.castShadows=this.component.castShadows,this.meshInstances=t,this.bounds=null,this.renderTargets=[]},ns=function(){function e(e){this.light=e,this.store(),e.numCascades=1,0!==e.type&&(e._node.getWorldTransform(),e.getBoundingSphere(ts),this.lightBounds=new ue,this.lightBounds.center.copy(ts.center),this.lightBounds.halfExtents.set(ts.radius,ts.radius,ts.radius))}var t=e.prototype;return t.store=function(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.numCascades=this.light.numCascades},t.restore=function(){this.light.mask=this.mask,this.light.shadowUpdateMode=this.shadowUpdateMode,this.light.enabled=this.enabled,this.light.numCascades=this.numCascades},e}(),as=function(){function e(e,t,i,n,a){this.device=e,this.root=t,this.scene=i,this.renderer=n,this.assets=a,this.shadowMapCache=n._shadowRenderer.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.fog="",this.ambientLight=new $,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}var t=e.prototype;return t.destroy=function(){Mn.decRefLightmap(this.blackTex),this.blackTex=null,Mn.destroyLightmapCache(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null},t.initBake=function(e){if(!this._initCalled){this._initCalled=!0,this.dilateShader=Ht(e,Dt.fullscreenQuadVS,Dt.dilatePS,"lmDilate"),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.constantBakeDir=e.scope.resolve("bakeDir"),this.pixelOffset=new Float32Array(2),this.materials=[],this.blackTex=new Kt(this.device,{width:4,height:4,format:7,type:Qe}),this.blackTex.name="lightmapBlack",Mn.incRefLightmap(this.blackTex);var t=new Oi;t.clearColor.set(0,0,0,0),t.clearColorBuffer=!0,t.clearDepthBuffer=!1,t.clearStencilBuffer=!1,t.frustumCulling=!1,t.projection=1,t.aspectRatio=1,t.node=new mn,this.camera=t}},t.finishBake=function(e){function t(e){Mn.decRefLightmap(e.colorBuffer),e.destroy()}this.materials=[],this.renderTargets.forEach(function(e){t(e)}),this.renderTargets.clear(),e.forEach(function(e){e.renderTargets.forEach(function(e){t(e)}),e.renderTargets.lenght=0})},t.createMaterials=function(e,t,i){for(var n="#define UV1LAYOUT\n"+Dt.transformVS,a=Dt.bakeLmEndPS,s=0;s<i;s++)if(!this.passMaterials[s]){var r=new gm;r.chunks.transformVS=n,0===s?(r.chunks.endPS=a,r.ambient=new $(0,0,0),r.ambientTint=!0,r.lightMap=this.blackTex):(r.chunks.basePS=Dt.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",r.chunks.endPS=Dt.bakeDirLmEndPS),r.chunks.outputAlphaPS="\n",r.chunks.outputAlphaOpaquePS="\n",r.chunks.outputAlphaPremulPS="\n",r.cull=0,r.forceUv1=!0,r.update(),r.updateShader(e,t),r.name="lmMaterial"+s,this.passMaterials[s]=r}},t.createTexture=function(e,t,i){var n=new Kt(this.device,{width:e,height:e,format:7,mipmaps:!1,type:t,minFilter:0,magFilter:0});return n.name=i,n},t.collectModels=function(e,t,i){var n,a,s;if(e.enabled){var r;if(null!=(n=e.model)&&n.model&&null!=(a=e.model)&&a.enabled&&(i&&i.push(new is(e)),e.model.lightmapped&&t&&(r=e.model.model.meshInstances)),null!=(s=e.render)&&s.enabled&&(i&&i.push(new is(e)),e.render.lightmapped&&t&&(r=e.render.meshInstances)),r){for(var o=!0,l=0;l<r.length;l++)if(!r[l].mesh.vertexBuffer.format.hasUv1){o=!1;break}if(o){for(var h=[],c=0;c<r.length;c++){var u=r[c].mesh;this._tempSet.has(u)?t.push(new is(e,[r[c]])):h.push(r[c]),this._tempSet.add(u)}this._tempSet.clear(),0<h.length&&t.push(new is(e,h))}}for(var d=0;d<e._children.length;d++)this.collectModels(e._children[d],t,i)}},t.prepareShadowCasters=function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i].component;if(n.castShadows=n.castShadowsLightmap,n.castShadowsLightmap)for(var a=e[i].meshInstances,s=0;s<a.length;s++)a[s].visibleThisFrame=!0,t.push(a[s])}return t},t.updateTransforms=function(e){for(var t=0;t<e.length;t++)for(var i=e[t].meshInstances,n=0;n<i.length;n++)i[n].node.getWorldTransform()},t.calculateLightmapSize=function(e){var t,i,n,a,s=this.scene.lightmapSizeMultiplier||16,r=es;e.model?(a=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data).area&&(n=t.area):e.model._area&&(t=e.model)._area&&(n=t._area)):e.render&&(a=e.render.lightmapSizeMultiplier,"asset"!==e.render.type&&e.render._area&&(t=e.render)._area&&(n=t._area));var o={x:1,y:1,z:1,uv:1};n&&(o.x=n.x,o.y=n.y,o.z=n.z,o.uv=n.uv);var l=a||1;for(o.x*=l,o.y*=l,o.z*=l,r.copy(e.localScale),i=e._parent;i;)r.mul(i.localScale),i=i._parent;r.x=Math.abs(r.x),r.y=Math.abs(r.y),r.z=Math.abs(r.z);var h=o.x*r.y*r.z+o.y*r.x*r.z+o.z*r.x*r.y;return h/=o.uv,h=Math.sqrt(h),Math.min(Se.nextPowerOfTwo(h*s),this.scene.lightmapMaxResolution||2048)},t.setLightmaping=function(e,t,i,n){for(var a=0;a<e.length;a++)for(var s=e[a],r=s.meshInstances,o=0;o<r.length;o++){var l=r[o];if(l.setLightmapped(t),t){n&&(l._shaderDefs|=n),l.mask=2;for(var h=0;h<i;h++){var c=s.renderTargets[h].colorBuffer;c.minFilter=1,c.magFilter=1,l.setRealtimeLightmap(Mn.lightmapParamNames[h],c)}}}},t.bake=function(e,t){void 0===t&&(t=1);var i=this.device,n=W();this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;var a=i._shaderStats.linked,s=i._renderTargetCreationTime,r=i._shaderStats.compileTime,o=[],l=[];if(e){for(var h=0;h<e.length;h++)this.collectModels(e[h],o,null);this.collectModels(this.root,null,l)}else this.collectModels(this.root,o,l);if(0<o.length){var c=1===t?2:1;this.setLightmaping(o,!1,c),this.initBake(i),this.bakeInternal(c,o,l);var u=1===t?192:64;this.setLightmaping(o,!0,c,u),this.finishBake(o)}var d=W();this.stats.totalRenderTime=d-n,this.stats.shadersLinked=i._shaderStats.linked-a,this.stats.compileTime=i._shaderStats.compileTime-r,this.stats.fboTime=i._renderTargetCreationTime-s,this.stats.lightmapCount=o.length},t.allocateTextures=function(e,t){for(var i=0;i<e.length;i++){for(var n=e[i],a=this.calculateLightmapSize(n.node),s=0;s<t;s++){var r=this.createTexture(a,Ze,"lightmapper_lightmap_"+i);Mn.incRefLightmap(r),n.renderTargets[s]=new Fm({colorBuffer:r,depth:!1})}if(!this.renderTargets.has(a)){var o=this.createTexture(a,Ze,"lightmapper_temp_lightmap_"+a);Mn.incRefLightmap(o),this.renderTargets.set(a,new Fm({colorBuffer:o,depth:!1}))}}},t.prepareLightsToBake=function(e,t,i){for(var n=e._lights,a=0;a<n.length;a++){var s=n[a],r=new ns(s);t.push(r),s.enabled&&0!=(4&s.mask)&&(s.isStatic=!1,s.mask=4294967295,s.shadowUpdateMode=0===s.type?2:1,i.push(r))}i.sort()},t.restoreLights=function(e){for(var t=0;t<e.length;t++)e[t].restore()},t.setupScene=function(){this.revertStatic=!1,this.scene._needsStaticPrepare&&(this.scene._needsStaticPrepare=!1,this.revertStatic=!0),this.fog=this.scene.fog,this.ambientLight.copy(this.scene.ambientLight),this.scene.fog=_e,this.scene.ambientLight.set(0,0,0)},t.restoreScene=function(){this.scene.fog=this.fog,this.scene.ambientLight.copy(this.ambientLight),this.revertStatic&&(this.scene._needsStaticPrepare=!0)},t.computeNodeBounds=function(e){for(var t=new ue,i=0;i<e.length;i++){var n=e[i].meshInstances;if(0<n.length){t.copy(n[0].aabb);for(var a=1;a<n.length;a++)t.add(n[a].aabb)}e[i].bounds=t.clone()}},t.computeBounds=function(e){for(var t=new ue,i=0;i<e.length;i++){t.copy(e[0].aabb);for(var n=1;n<e.length;n++)t.add(e[n].aabb)}return t},t.backupMaterials=function(e){for(var t=0;t<e.length;t++)this.materials[t]=e[t].material},t.restoreMaterials=function(e){for(var t=0;t<e.length;t++)e[t].material=this.materials[t]},t.lightCameraPrepare=function(e,t){var i,n=t.light;return 2===n.type&&((i=n.getRenderData(null,0).shadowCamera)._node.setPosition(n._node.getPosition()),i._node.setRotation(n._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=0,i.nearClip=n.attenuationEnd/1e3,i.farClip=n.attenuationEnd,i.aspectRatio=1,i.fov=2*n._outerConeAngle,this.renderer.updateCameraFrustum(i)),i},t.lightCameraPrepareAndCull=function(e,t,i,n){var a=e.light,s=!0;if(0===a.type){es.copy(n.center),es.y+=n.halfExtents.y,this.camera.node.setPosition(es),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*n.halfExtents.y;var r=Math.max(n.halfExtents.x,n.halfExtents.z);this.camera.orthoHeight=r}else e.lightBounds.intersects(t.bounds)||(s=!1);if(2===a.type){for(var o=!1,l=t.meshInstances,h=0;h<l.length;h++)if(l[h]._isVisible(i)){o=!0;break}o||(s=!1)}return s},t.setupLightArray=function(e,t){e[0].length=0,e[1].length=0,e[2].length=0,e[t.type][0]=t},t.renderShadowMap=function(e,t,i,n){var a=n.light;return!e&&a.castShadows&&(a.shadowMap=this.shadowMapCache.get(this.device,a),0===a.type?this.renderer._shadowRenderer.cullDirectional(a,t,this.camera):this.renderer._shadowRenderer.cullLocal(a,t),this.renderer.renderShadows(i[a.type],this.camera)),!0},t.dilateTextures=function(e,t,i){for(var n=this.pixelOffset,a=this.dilateShader,s=this.constantTexSource,r=this.constantPixelOffset,o=0;o<t.length;o++)for(var l=t[o],h=0;h<i;h++){var c=l.renderTargets[h],u=c.colorBuffer,d=this.renderTargets.get(u.width),p=d.colorBuffer;n[0]=1/u.width,n[1]=1/u.height,r.setValue(n);for(var f=0;f<4;f++)s.setValue(u),At(e,d,a),s.setValue(p),At(e,c,a)}},t.bakeInternal=function(e,t,i){var n=this.scene,a=this.device;this.createMaterials(a,n,e),this.setupScene(),n.layers._update(),this.allocateTextures(t,e);var s=[],r=[];this.prepareLightsToBake(n.layers,s,r),this.updateTransforms(i);var o=this.prepareShadowCasters(i);this.renderer.updateMorphing(o),this.renderer.updateCpuSkinMatrices(o),this.renderer.gpuUpdate(o),this.computeNodeBounds(t);var l,h,c,u,d=this.computeBounds(o);for(l=0;l<t.length;l++)for(c=t[l].meshInstances,h=0;h<c.length;h++)(u=c[h]).setLightmapped(!1),u.mask=4,u.setRealtimeLightmap(Mn.lightmapParamNames[0],u.material.lightMap?u.material.lightMap:this.blackTex),u.setRealtimeLightmap(Mn.lightmapParamNames[1],this.blackTex);for(h=0;h<r.length;h++)r[h].light.enabled=!1;var p,f,m=[[],[],[]],v=!1;for(l=0;l<r.length;l++){var g,_=r[l],y=!(_.light.enabled=!0),b=this.lightCameraPrepare(a,_);for(f=0;f<t.length;f++){var x=t[f];if(c=x.meshInstances,this.lightCameraPrepareAndCull(_,x,b,d)){for(this.setupLightArray(m,_.light),y=this.renderShadowMap(y,o,m,_),this.backupMaterials(c),p=0;p<e;p++){var M=x.renderTargets[p],S=x.renderTargets[p].colorBuffer.width,w=this.renderTargets.get(S),C=w.colorBuffer;for(0===p?v=n.updateShaders:v&&(n.updateShaders=!0),h=0;h<c.length;h++)c[h].material=this.passMaterials[p];for(this.renderer.updateShaders(c),this.renderer.setCamera(this.camera,w,!0),1===p&&this.constantBakeDir.setValue(_.light.bakeDir?1:0),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,c,c.length,m,1),x.renderTargets[p]=w,this.renderTargets.set(S,M),h=0;h<c.length;h++)(u=c[h]).setRealtimeLightmap(Mn.lightmapParamNames[p],C),u._shaderDefs|=64}this.restoreMaterials(c)}}_.light.enabled=!1,null!=(g=_.light.shadowMap)&&g.cached&&(this.shadowMapCache.add(_.light,_.light.shadowMap),_.light.shadowMap=null)}for(this.shadowMapCache.clear(),this.dilateTextures(a,t,e),f=0;f<i.length;f++)i[f].component.castShadows=i[f].castShadows;this.restoreLights(s),this.restoreScene()},e}(),ss=1,rs=new pe,os=new pe,ls=new de,hs=new de,cs=new de,us=new de,ds=new de,ps=new de,fs=new de,ms=new de,vs=new de,gs=new de,_s=new de,ys=new de,bs=new de;function xs(e){return e-Math.floor(e)}function Ms(e,t){return e-t*Math.floor(e/t)}function Ss(e){var t=xs(e),i=xs(255*e);return[t-=i/255,i-=i/255]}var ws=function(){function e(e){this._emitter=e}var t=e.prototype;return t.calcSpawnPosition=function(e,t,i,n,a){var s,r,o,l,h,c,u=this._emitter,d=Math.random(),p=Math.random(),f=Math.random(),m=Math.random();if(u.useCpu&&(e[4*a+0+2*u.numParticlesPot*4]=d,e[4*a+1+2*u.numParticlesPot*4]=p,e[4*a+2+2*u.numParticlesPot*4]=f),hs.x=d-.5,hs.y=p-.5,hs.z=f-.5,0===u.emitterShape){var v=Math.max(Math.abs(hs.x),Math.max(Math.abs(hs.y),Math.abs(hs.z))),g=v+(.5-v)*i[0],_=v+(.5-v)*i[1],y=v+(.5-v)*i[2];hs.x=g*(v===Math.abs(hs.x)?Math.sign(hs.x):2*hs.x),hs.y=_*(v===Math.abs(hs.y)?Math.sign(hs.y):2*hs.y),hs.z=y*(v===Math.abs(hs.z)?Math.sign(hs.z):2*hs.z),u.localSpace?ls.copy(t.transformPoint(hs)):ls.copy(n).add(t.transformPoint(hs))}else{hs.normalize();var b=0===u.emitterRadius?0:u.emitterRadiusInner/u.emitterRadius,x=m*(1-b)+b;u.localSpace?ls.copy(hs.mulScalar(x*u.emitterRadius)):ls.copy(n).add(hs.mulScalar(x*u.emitterRadius))}if(s=-Se.lerp(u.rate,u.rate2,d)*a,u.pack8){var M=(ls.x-u.worldBounds.center.x)/u.worldBoundsSize.x+.5,S=(ls.y-u.worldBounds.center.y)/u.worldBoundsSize.y+.5,w=(ls.z-u.worldBounds.center.z)/u.worldBoundsSize.z+.5,C=Se.lerp(u.startAngle*Se.DEG_TO_RAD,u.startAngle2*Se.DEG_TO_RAD,d);C=C%(2*Math.PI)/(2*Math.PI);var P=Ss(M);e[4*a]=P[0],e[4*a+1]=P[1];var T=Ss(S);e[4*a+2]=T[0],e[4*a+3]=T[1];var A=Ss(w);e[4*a+0+4*u.numParticlesPot]=A[0],e[4*a+1+4*u.numParticlesPot]=A[1];var E=Ss(C);e[4*a+2+4*u.numParticlesPot]=E[0],e[4*a+3+4*u.numParticlesPot]=E[1],e[4*a+3+4*u.numParticlesPot*2]=1;var R=Math.max(u.lifetime,(u.numParticles-1)*Math.max(u.rate,u.rate2)),D=(o=xs(r=s=(s+R)/(R+(u.lifetime+1))),[o-=(l=xs(255*r))/255,l-=(h=xs(65025*r))/255,h-=(c=xs(160581375*r))/255,c-=c/255]);e[4*a+0+4*u.numParticlesPot*3]=D[0],e[4*a+1+4*u.numParticlesPot*3]=D[1],e[4*a+2+4*u.numParticlesPot*3]=D[2],e[4*a+3+4*u.numParticlesPot*3]=D[3]}else e[4*a]=ls.x,e[4*a+1]=ls.y,e[4*a+2]=ls.z,e[4*a+3]=Se.lerp(u.startAngle*Se.DEG_TO_RAD,u.startAngle2*Se.DEG_TO_RAD,d),e[4*a+3+4*u.numParticlesPot]=s},t.update=function(e,t,i,n,a,s,r,o){var l,h,c,u,d,p=this._emitter;if(p.meshInstance.node){var f=p.meshInstance.node.worldTransform;for(d=0;d<12;d++)rs.data[d]=f.data[d];os.copy(rs),os.invert(),$a=p.meshInstance.node.localScale,ss=Math.max(Math.max($a.x,$a.y),$a.z)}s=null===p.meshInstance.node||p.localSpace?de.ZERO:p.meshInstance.node.getPosition();var m,v,g,_,y,b,x,M,S,w=p.camera?p.camera._node.getPosition():de.ZERO,C=p.useMesh?17:15,P=p.precision-1;for(u=0;u<p.numParticles;u++){var T=Math.floor(p.vbCPU[u*p.numParticleVerts*(p.useMesh?6:4)+3]),A=i[4*T+0+2*p.numParticlesPot*4];cs.x=A,cs.y=i[4*T+1+2*p.numParticlesPot*4],cs.z=i[4*T+2+2*p.numParticlesPot*4];var E=p.rate+(p.rate2-p.rate)*A,R=p.lifetime,D=i[4*T+3+4*p.numParticlesPot]+r,I=(S=D/R,Math.max(Math.min(S,1),0)),k=0,L=0;(D-r<=0||R<=D)&&this.calcSpawnPosition(i,n,a,s,T);var O=0<D&&D<R;O&&(c=I*P,m=Math.floor(c),v=Math.ceil(c),c%=1,g=(l=p.qRotSpeed[m])+((h=p.qRotSpeed[v])-l)*c,_=(l=p.qRotSpeed2[m])+((h=p.qRotSpeed2[v])-l)*c,k=(l=p.qScale[m])+((h=p.qScale[v])-l)*c,y=(l=p.qScale2[m])+((h=p.qScale2[v])-l)*c,b=(l=p.qAlpha[m])+((h=p.qAlpha[v])-l)*c,x=(l=p.qAlpha2[m])+((h=p.qAlpha2[v])-l)*c,M=(l=p.qRadialSpeed[m])+((h=p.qRadialSpeed[v])-l)*c,M+=100*A%1*((l=p.qRadialSpeed2[m])+((h=p.qRadialSpeed2[v])-l)*c-M),us.x=i[4*T],us.y=i[4*T+1],us.z=i[4*T+2],p.localSpace?vs.copy(us):vs.copy(us).sub(s),vs.normalize().mulScalar(M),m*=3,v*=3,l=p.qLocalVelocity[m],h=p.qLocalVelocity[v],ps.x=l+(h-l)*c,l=p.qLocalVelocity[m+1],h=p.qLocalVelocity[v+1],ps.y=l+(h-l)*c,l=p.qLocalVelocity[m+2],h=p.qLocalVelocity[v+2],ps.z=l+(h-l)*c,l=p.qLocalVelocity2[m],h=p.qLocalVelocity2[v],ms.x=l+(h-l)*c,l=p.qLocalVelocity2[m+1],h=p.qLocalVelocity2[v+1],ms.y=l+(h-l)*c,l=p.qLocalVelocity2[m+2],h=p.qLocalVelocity2[v+2],ms.z=l+(h-l)*c,l=p.qVelocity[m],h=p.qVelocity[v],ds.x=l+(h-l)*c,l=p.qVelocity[m+1],h=p.qVelocity[v+1],ds.y=l+(h-l)*c,l=p.qVelocity[m+2],h=p.qVelocity[v+2],ds.z=l+(h-l)*c,l=p.qVelocity2[m],h=p.qVelocity2[v],fs.x=l+(h-l)*c,l=p.qVelocity2[m+1],h=p.qVelocity2[v+1],fs.y=l+(h-l)*c,l=p.qVelocity2[m+2],h=p.qVelocity2[v+2],fs.z=l+(h-l)*c,ps.x+=(ms.x-ps.x)*cs.x,ps.y+=(ms.y-ps.y)*cs.y,ps.z+=(ms.z-ps.z)*cs.z,0<p.initialVelocity&&(1===p.emitterShape?(hs.copy(cs).mulScalar(2).sub(de.ONE).normalize(),ps.add(hs.mulScalar(p.initialVelocity))):ps.add(de.FORWARD.mulScalar(p.initialVelocity))),ds.x+=(fs.x-ds.x)*cs.x,ds.y+=(fs.y-ds.y)*cs.y,ds.z+=(fs.z-ds.z)*cs.z,g+=(_-g)*cs.y,k=(k+1e4*A%1*(y-k))*ss,L=1e3*A%1*(x-b),p.meshInstance.node&&(p.localSpace?(ps.x/=$a.x,ps.y/=$a.y,ps.z/=$a.z):rs.transformPoint(ps,ps)),p.localSpace?(os.transformPoint(ds,ds),ps.add(ds).add(vs)):(ps.add(ds.mul($a)),ps.add(vs.mul($a))),ys.copy(ps),gs.copy(us).add(ps.mulScalar(r)),_s.copy(gs),i[4*T]=_s.x,i[4*T+1]=_s.y,i[4*T+2]=_s.z,i[4*T+3]+=g*r,p.wrap&&p.wrapBounds&&(p.localSpace||_s.sub(s),_s.x=Ms(_s.x,p.wrapBounds.x)-.5*p.wrapBounds.x,_s.y=Ms(_s.y,p.wrapBounds.y)-.5*p.wrapBounds.y,_s.z=Ms(_s.z,p.wrapBounds.z)-.5*p.wrapBounds.z,p.localSpace||_s.add(s)),0<p.sort&&(1===p.sort?(bs.copy(_s).sub(w),p.particleDistance[T]=-(bs.x*bs.x+bs.y*bs.y+bs.z*bs.z)):2===p.sort?p.particleDistance[T]=D:3===p.sort&&(p.particleDistance[T]=-D))),o?D<0&&(i[4*T+3+2*p.numParticlesPot*4]=-1):(R<=D&&(D-=Math.max(R,(p.numParticles-1)*E),i[4*T+3+2*p.numParticlesPot*4]=p.loop?1:-1),D<0&&p.loop&&(i[4*T+3+2*p.numParticlesPot*4]=1)),i[4*T+3+2*p.numParticlesPot*4]<0&&(O=!1),i[4*T+3+4*p.numParticlesPot]=D;for(var F=0;F<p.numParticleVerts;F++){var z=(u*p.numParticleVerts+F)*(p.useMesh?6:4),B=p.vbCPU[z],V=p.vbCPU[z+1],U=p.vbCPU[z+2];O||(B=V=U=0);var N=u*p.numParticleVerts*C+F*C;e[N]=_s.x,e[N+1]=_s.y,e[N+2]=_s.z,e[N+3]=I,e[N+4]=p.alignToMotion?0:i[4*T+3],e[N+5]=k,e[N+6]=L,e[N+7]=ys.x,e[N+8]=B,e[N+9]=V,e[N+10]=U,e[N+11]=ys.y,e[N+12]=T,e[N+13]=ys.z,e[N+14]=p.vbCPU[z+3],p.useMesh&&(e[N+15]=p.vbCPU[z+4],e[N+16]=p.vbCPU[z+5])}}if(0<p.sort&&p.camera){var G=p.useMesh?6:4,W=p.particleDistance;for(u=0;u<p.numParticles;u++)t[u][0]=u,t[u][1]=W[Math.floor(p.vbCPU[u*p.numParticleVerts*G+3])];for(p.vbOld.set(p.vbCPU),t.sort(function(e,t){return e[1]-t[1]}),u=0;u<p.numParticles;u++){var H=t[u][0]*p.numParticleVerts*G,j=u*p.numParticleVerts*G;for(d=0;d<p.numParticleVerts*G;d++)p.vbCPU[j+d]=p.vbOld[H+d]}}},e}(),Cs=new Q,Ps=new Q,Ts=new Q,As=function(){function e(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm")}var t=e.prototype;return t._setInputBounds=function(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)},t.randomize=function(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()},t.update=function(e,t,i,n,a){var s=this._emitter;e.setBlending(!1),e.setColorWrite(!0,!0,!0,!0),e.setCullMode(0),e.setDepthTest(!1),e.setDepthWrite(!1),this.randomize(),this.constantGraphSampleSize.setValue(1/s.precision),this.constantGraphNumSamples.setValue(s.precision),this.constantNumParticles.setValue(s.numParticles),this.constantNumParticlesPot.setValue(s.numParticlesPot),this.constantInternalTex0.setValue(s.internalTex0),this.constantInternalTex1.setValue(s.internalTex1),this.constantInternalTex2.setValue(s.internalTex2),this.constantInternalTex3.setValue(s.internalTex3);var r=s.meshInstance.node,o=null===r?de.ONE:r.localScale;if(s.pack8){this.worldBoundsMulUniform[0]=s.worldBoundsMul.x,this.worldBoundsMulUniform[1]=s.worldBoundsMul.y,this.worldBoundsMulUniform[2]=s.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=s.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=s.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=s.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();var l=s.maxVel*Math.max(Math.max(o.x,o.y),o.z);l=Math.max(l,1),this.constantMaxVel.setValue(l)}var h=null===r||s.localSpace?de.ZERO:r.getPosition(),c=null===r?pe.IDENTITY:r.getWorldTransform();0===s.emitterShape?(Cs.setFromMat4(t),this.constantSpawnBounds.setValue(Cs.data),this.constantSpawnPosInnerRatio.setValue(i)):(this.constantSpawnBoundsSphere.setValue(s.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===s.emitterRadius?0:s.emitterRadiusInner/s.emitterRadius)),this.constantInitialVelocity.setValue(s.initialVelocity),Ps.setFromMat4(c),c.invertTo3x3(Ts),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(n),this.constantRate.setValue(s.rate),this.constantRateDiv.setValue(s.rate2-s.rate),this.constantStartAngle.setValue(s.startAngle*Se.DEG_TO_RAD),this.constantStartAngle2.setValue(s.startAngle2*Se.DEG_TO_RAD),this.constantSeed.setValue(s.seed),this.constantLifetime.setValue(s.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(Ps.data),this.constantEmitterMatrixInv.setValue(Ts.data),this.constantLocalVelocityDivMult.setValue(s.localVelocityUMax),this.constantVelocityDivMult.setValue(s.velocityUMax),this.constantRotSpeedDivMult.setValue(s.rotSpeedUMax[0]);var u=s.swapTex?s.particleTexOUT:s.particleTexIN;u=s.beenReset?s.particleTexStart:u;var d=s.swapTex?s.particleTexIN:s.particleTexOUT;this.constantParticleTexIN.setValue(u),At(e,s.swapTex?s.rtParticleTexIN:s.rtParticleTexOUT,a?s.shaderParticleUpdateOnStop:s.loop?s.shaderParticleUpdateRespawn:s.shaderParticleUpdateNoRespawn),s.material.setParameter("particleTexOUT",u),s.material.setParameter("particleTexIN",d),s.beenReset=!1,s.swapTex=!s.swapTex,e.setDepthTest(!0),e.setDepthWrite(!0),s.prevWorldBoundsSize.copy(s.worldBoundsSize),s.prevWorldBoundsCenter.copy(s.worldBounds.center),s.pack8&&this._setInputBounds()},e}(),Es=[[-1,-1],[1,-1],[1,1],[-1,1]];function Rs(e,t,i,n,a,s,r){void 0===a&&(a=Ce);var o=0;r&&7===a&&(o=1);var l=new Kt(e,{width:t,height:i,format:a,cubemap:!1,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1});l.name="PSTexture";var h=l.lock();if(7===a){for(var c=new Uint8Array(n.length),u=0;u<n.length;u++)c[u]=n[u]*s*255;n=c}return h.set(n),l.unlock(),l}function Ds(e){return Math.max(Math.min(e,1),0)}var Is,ks,Ls=new K([0,0,1,0]),Os=new K([0,1,1,1]),Fs=new Z([0,0,1,0],[0,0,1,0],[0,0,1,0]),zs=new Z([0,1,1,1],[0,1,1,1],[0,1,1,1]),Bs=2,Vs=new Float32Array(3),Us=new pe,Ns=new de,Gs=new de,Ws=new de;function Hs(e,t){void 0!==ks[e]&&null!==ks[e]?Is[e]=ks[e]:Is[e]=t}function js(e,t,i){return(255*e<<16|255*t<<8|255*i)/(1<<24)}function Xs(e,t){for(var i=e.length/3,n=new Array(4*i),a=0;a<i;a++)n[4*a]=e[3*a],n[4*a+1]=e[3*a+1],n[4*a+2]=e[3*a+2],n[4*a+3]=js(t[3*a],t[3*a+1],t[3*a+2]);return n}function qs(e,t){var i,n,a=t.length,s=e.length/a;for(i=0;i<s;i++)for(n=0;n<a;n++){var r=Math.abs(e[i*a+n]);t[n]=Math.max(t[n],r)}}function $s(e,t,i){var n=function(e,t){for(var i=new Float32Array(e.length),n=0;n<e.length;n++)i[n]=e[n]-t[n];return i}(t,e);return qs(n,i),function(e,t){var i,n,a=t.length,s=e.length/a;for(i=0;i<s;i++)for(n=0;n<a;n++)e[i*a+n]/=0===t[n]?1:t[n],e[i*a+n]*=.5,e[i*a+n]+=.5}(n,i),n}var Ys=function(){function u(e,t){var i=this.graphicsDevice=e;if(this.precision=32,this._addTimeTime=0,!u.DEFAULT_PARAM_TEXTURE){var n,a,s,r,o,l,h=new Float32Array(1024);for(a=0;a<16;a++)for(n=0;n<16;n++)s=n+1-8.5,r=a+1-8.5,l=Ds(1-Ds(Math.sqrt(s*s+r*r)/16)-.5),h[4*(o=16*a+n)]=1,h[4*o+1]=1,h[4*o+2]=1,h[4*o+3]=l;(u.DEFAULT_PARAM_TEXTURE=Rs(i,16,16,h,7,1,!0)).minFilter=1,u.DEFAULT_PARAM_TEXTURE.magFilter=1}Is=this,ks=t,Hs("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),Hs("rate",1),Hs("rate2",this.rate),Hs("lifetime",50),Hs("emitterExtents",new de(0,0,0)),Hs("emitterExtentsInner",new de(0,0,0)),Hs("emitterRadius",0),Hs("emitterRadiusInner",0),Hs("emitterShape",0),Hs("initialVelocity",1),Hs("wrap",!1),Hs("localSpace",!1),Hs("screenSpace",!1),Hs("wrapBounds",null),Hs("colorMap",u.DEFAULT_PARAM_TEXTURE),Hs("normalMap",null),Hs("loop",!0),Hs("preWarm",!1),Hs("sort",0),Hs("mode",0),Hs("scene",null),Hs("lighting",!1),Hs("halfLambert",!1),Hs("intensity",1),Hs("stretch",0),Hs("alignToMotion",!1),Hs("depthSoftening",0),Hs("mesh",null),Hs("particleNormal",new de(0,1,0)),Hs("orientation",0),Hs("depthWrite",!1),Hs("noFog",!1),Hs("blendType",2),Hs("node",null),Hs("startAngle",0),Hs("startAngle2",this.startAngle),Hs("animTilesX",1),Hs("animTilesY",1),Hs("animStartFrame",0),Hs("animNumFrames",1),Hs("animNumAnimations",1),Hs("animIndex",0),Hs("randomizeAnimIndex",!1),Hs("animSpeed",1),Hs("animLoop",!0),this._gpuUpdater=new As(this,i),this._cpuUpdater=new ws(this),this.constantLightCube=i.scope.resolve("lightCube[0]"),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),Hs("colorGraph",zs),Hs("colorGraph2",this.colorGraph),Hs("scaleGraph",Os),Hs("scaleGraph2",this.scaleGraph),Hs("alphaGraph",Os),Hs("alphaGraph2",this.alphaGraph),Hs("localVelocityGraph",Fs),Hs("localVelocityGraph2",this.localVelocityGraph),Hs("velocityGraph",Fs),Hs("velocityGraph2",this.velocityGraph),Hs("rotationSpeedGraph",Ls),Hs("rotationSpeedGraph2",this.rotationSpeedGraph),Hs("radialSpeedGraph",Ls),Hs("radialSpeedGraph2",this.radialSpeedGraph),this.lightCube=new Float32Array(18),this.lightCubeDir=new Array(6),this.lightCubeDir[0]=new de(-1,0,0),this.lightCubeDir[1]=new de(1,0,0),this.lightCubeDir[2]=new de(0,-1,0),this.lightCubeDir[3]=new de(0,1,0),this.lightCubeDir[4]=new de(0,0,-1),this.lightCubeDir[5]=new de(0,0,1),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!1,this.pack8=!0,this.localBounds=new ue,this.worldBoundsNoTrail=new ue,this.worldBoundsTrail=[new ue,new ue],this.worldBounds=new ue,this.worldBoundsSize=new de,this.prevWorldBoundsSize=new de,this.prevWorldBoundsCenter=new de,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new de,this.worldBoundsAdd=new de,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}var e=u.prototype;return e.onChangeCamera=function(){this.regenShader(),this.resetMaterial()},e.calculateBoundsMad=function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5},e.calculateWorldBounds=function(){if(this.node){this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.useCpu||(0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius!==this.prevEmitterRadius)&&this.calculateLocalBounds();var e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}},e.resetWorldBounds=function(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?pe.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)},e.calculateLocalBounds=function(){var e,t,i,n,a,s,r=Number.MAX_VALUE,o=Number.MAX_VALUE,l=Number.MAX_VALUE,h=-Number.MAX_VALUE,c=-Number.MAX_VALUE,u=-Number.MAX_VALUE,d=0,p=0,f=this.lifetime/this.precision,m=[this.qVelocity,this.qVelocity2],v=[this.qLocalVelocity,this.qLocalVelocity2],g=[0,0],_=[0,0],y=[0,0],b=[0,0],x=[0,0];for(e=0;e<this.precision+1;e++){for(i=Math.min(e,this.precision-1),t=0;t<2;t++)n=v[t][3*i+0]*f+g[t],a=v[t][3*i+1]*f+_[t],s=v[t][3*i+2]*f+y[t],r=Math.min(n,r),o=Math.min(a,o),l=Math.min(s,l),h=Math.max(n,h),c=Math.max(a,c),u=Math.max(s,u),g[t]=n,_[t]=a,y[t]=s;for(t=0;t<2;t++)x[t]+=f*Math.sqrt(m[t][3*i+0]*m[t][3*i+0]+m[t][3*i+1]*m[t][3*i+1]+m[t][3*i+2]*m[t][3*i+2]);b[0]+=this.qRadialSpeed[i]*f,b[1]+=this.qRadialSpeed2[i]*f,d=Math.max(d,Math.max(Math.abs(b[0]),Math.abs(b[1]))),p=Math.max(p,this.qScale[i])}0===this.emitterShape?(n=.5*this.emitterExtents.x,a=.5*this.emitterExtents.y,s=.5*this.emitterExtents.z):(n=this.emitterRadius,a=this.emitterRadius,s=this.emitterRadius);var M=Math.max(x[0],x[1]);Gs.x=r-p-n-d-M,Gs.y=o-p-a-d-M,Gs.z=l-p-s-d-M,Ws.x=h+p+n+d+M,Ws.y=c+p+a+d+M,Ws.z=u+p+s+d+M,this.localBounds.setMinMax(Gs,Ws)},e.rebuild=function(){var e,t=this.graphicsDevice;null===this.colorMap&&(this.colorMap=u.DEFAULT_PARAM_TEXTURE),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||0<this.sort||t.maxVertexTextures<=1||t.fragmentUniformsCount<64||t.forceCpuParticles||!t.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!t.textureFloatRenderable)&&!this.useCpu,Bs=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices||(this.useMesh=!0)),this.numParticlesPot=Se.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?pe.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(var i=0;i<this.numParticles;i++)this.vbToSort[i]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*Bs*4);var n=null===this.node||this.localSpace?de.ZERO:this.node.getPosition();for(0===this.emitterShape&&(null===this.node||this.localSpace?Us.setTRS(de.ZERO,fe.IDENTITY,this.spawnBounds):Us.setTRS(de.ZERO,this.node.getRotation(),Ns.copy(this.spawnBounds).mul(this.node.localScale)),Vs[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Vs[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Vs[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0),e=0;e<this.numParticles;e++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Us,Vs,n,e),this.useCpu&&(this.particleTex[4*e+3+2*this.numParticlesPot*4]=1);for(this.particleTexStart=new Float32Array(this.numParticlesPot*Bs*4),e=0;e<this.particleTexStart.length;e++)this.particleTexStart[e]=this.particleTex[e];this.useCpu||(this.pack8?(this.particleTexIN=Rs(t,this.numParticlesPot,Bs,this.particleTex,7,1,!1),this.particleTexOUT=Rs(t,this.numParticlesPot,Bs,this.particleTex,7,1,!1),this.particleTexStart=Rs(t,this.numParticlesPot,Bs,this.particleTexStart,7,1,!1)):(this.particleTexIN=Rs(t,this.numParticlesPot,Bs,this.particleTex),this.particleTexOUT=Rs(t,this.numParticlesPot,Bs,this.particleTex),this.particleTexStart=Rs(t,this.numParticlesPot,Bs,this.particleTexStart)),this.rtParticleTexIN=new Fm({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new Fm({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);var a=(this.localSpace?"#define LOCAL_SPACE\n":"")+Dt.particleUpdaterInitPS+(this.pack8?Dt.particleInputRgba8PS+Dt.particleOutputRgba8PS:Dt.particleInputFloatPS+Dt.particleOutputFloatPS)+(0===this.emitterShape?Dt.particleUpdaterAABBPS:Dt.particleUpdaterSpherePS)+Dt.particleUpdaterStartPS,s=a+Dt.particleUpdaterRespawnPS+Dt.particleUpdaterEndPS,r=a+Dt.particleUpdaterNoRespawnPS+Dt.particleUpdaterEndPS,o=a+Dt.particleUpdaterOnStopPS+Dt.particleUpdaterEndPS,l=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=Ht(t,Dt.fullscreenQuadVS,s,"fsQuad0"+l),this.shaderParticleUpdateNoRespawn=Ht(t,Dt.fullscreenQuadVS,r,"fsQuad1"+l),this.shaderParticleUpdateOnStop=Ht(t,Dt.fullscreenQuadVS,o,"fsQuad2"+l),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);var h=new Zi(t);h.vertexBuffer=this.vertexBuffer,h.indexBuffer[0]=this.indexBuffer,h.primitive[0].type=4,h.primitive[0].base=0,h.primitive[0].count=this.numParticles*this.numParticleIndices,h.primitive[0].indexed=!0,this.material=new Ui,this.material.name=this.node.name,this.material.cull=0,this.material.alphaWrite=!1,this.material.blend=!0,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,(this.material.emitter=this).regenShader(),this.resetMaterial();var c=!this.meshInstance||this.meshInstance.visible;this.meshInstance=new Mn(h,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.meshInstance._noDepthDrawGl1=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=c,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)},e._isAnimated=function(){return 1<=this.animNumFrames&&(1<this.animTilesX||1<this.animTilesY)&&(this.colorMap&&this.colorMap!==u.DEFAULT_PARAM_TEXTURE||this.normalMap)},e.rebuildGraphs=function(){var e,t=this.precision,i=this.graphicsDevice;for(this.qLocalVelocity=this.localVelocityGraph.quantize(t),this.qVelocity=this.velocityGraph.quantize(t),this.qColor=this.colorGraph.quantizeClamped(t,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(t),this.qScale=this.scaleGraph.quantize(t),this.qAlpha=this.alphaGraph.quantize(t),this.qRadialSpeed=this.radialSpeedGraph.quantize(t),this.qLocalVelocity2=this.localVelocityGraph2.quantize(t),this.qVelocity2=this.velocityGraph2.quantize(t),this.qColor2=this.colorGraph2.quantizeClamped(t,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(t),this.qScale2=this.scaleGraph2.quantize(t),this.qAlpha2=this.alphaGraph2.quantize(t),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(t),e=0;e<t;e++)this.qRotSpeed[e]*=Se.DEG_TO_RAD,this.qRotSpeed2[e]*=Se.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=$s(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=$s(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=$s(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=$s(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=$s(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=$s(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=$s(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){var n=[0,0,0];qs(this.qVelocity,n);var a=[0,0,0];qs(this.qVelocity2,a);var s=[0,0,0];qs(this.qLocalVelocity,s);var r=[0,0,0];qs(this.qLocalVelocity2,r);var o=[0];qs(this.qRadialSpeed,o);var l=[0];qs(this.qRadialSpeed2,l);var h=Math.max(n[0],a[0]);h=Math.max(h,n[1]),h=Math.max(h,a[1]),h=Math.max(h,n[2]),h=Math.max(h,a[2]);var c=Math.max(s[0],r[0]);c=Math.max(c,s[1]),c=Math.max(c,r[1]),c=Math.max(c,s[2]),c=Math.max(c,r[2]);var u=Math.max(o[0],l[0]);this.maxVel=h+c+u}this.useCpu||(this.internalTex0=Rs(i,t,1,Xs(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=Rs(i,t,1,Xs(this.qVelocity,this.qVelocityDiv)),this.internalTex2=Rs(i,t,1,function(e,t,i,n,a){for(var s=new Array(4*e.length),r=0;r<e.length;r++)s[4*r]=e[r],s[4*r+1]=t[r],s[4*r+2]=0,s[4*r+3]=js(i[r],n[r],a[r]);return s}(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=Rs(i,t,1,function(e,t){for(var i=new Array(4*e.length),n=0;n<e.length;n++)i[4*n]=e[n],i[4*n+1]=t[n],i[4*n+2]=0,i[4*n+3]=0;return i}(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=Rs(i,t,1,function(e,t){for(var i=new Array(4*t.length),n=0;n<t.length;n++)i[4*n]=e[3*n],i[4*n+1]=e[3*n+1],i[4*n+2]=e[3*n+2],i[4*n+3]=t[n];return i}(this.qColor,this.qAlpha),7,1,!0)},e._initializeTextures=function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))},e.regenShader=function(){var i=this.graphicsDevice.getProgramLibrary(),e=null!==this.normalMap;this.normalOption=0,this.lighting&&(this.normalOption=e?2:1),this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!==this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());var e=this.emitter.inTools,t=i.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!e&&this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!==this.emitter.orientation});this.shader=t},this.material.updateShader()},e.resetMaterial=function(){var e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&e.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&e.setParameter("normalMap",this.normalMap),0<this.depthSoftening&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),0<this.stretch&&(e.cull=0),this._compParticleFaceParams()},e._compParticleFaceParams=function(){var e,t;if(0===this.orientation)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else{var i;i=1===this.orientation?this.particleNormal.normalize():(null===this.node?pe.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();var n=new de(1,0,0);1===Math.abs(n.dot(i))&&n.set(0,0,1);var a=(new de).cross(i,n).normalize();n.cross(a,i).normalize(),e=new Float32Array([n.x,n.y,n.z]),t=new Float32Array([a.x,a.y,a.z])}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t)},e._allocate=function(e){var t,i,n,a=e*this.numParticleVerts,s=e*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==a){this.useCpu?t=[{semantic:Ge,components:4,type:6},{semantic:"ATTR1",components:4,type:6},{semantic:"ATTR2",components:4,type:6},{semantic:"ATTR3",components:1,type:6},{semantic:"ATTR4",components:this.useMesh?4:2,type:6}]:(t=[{semantic:Ge,components:4,type:6}],this.useMesh&&t.push({semantic:"ATTR1",components:2,type:6})),i=new ut(this.graphicsDevice,t),this.vertexBuffer=new ht(this.graphicsDevice,i,a,1),this.indexBuffer=new qi(this.graphicsDevice,1,s);var r,o,l,h,c=new Float32Array(this.vertexBuffer.lock());if(this.useMesh){o=(r=new Float32Array(this.mesh.vertexBuffer.lock())).length/this.mesh.vertexBuffer.numVertices;for(var u=0;u<this.mesh.vertexBuffer.format.elements.length;u++)if(this.mesh.vertexBuffer.format.elements[u].name===Le){l=this.mesh.vertexBuffer.format.elements[u].offset/4;break}}for(n=0;n<a;n++)if(h=Math.floor(n/this.numParticleVerts),this.useMesh){var d=n%this.numParticleVerts;c[6*n]=r[d*o],c[6*n+1]=r[d*o+1],c[6*n+2]=r[d*o+2],c[6*n+3]=h,c[6*n+4]=r[d*o+l+0],c[6*n+5]=r[d*o+l+1]}else{var p=n%4;c[4*n]=Es[p][0],c[4*n+1]=Es[p][1],c[4*n+2]=0,c[4*n+3]=h}this.useCpu&&(this.vbCPU=new Float32Array(c),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();var f=0,m=new Uint16Array(this.indexBuffer.lock());for(this.useMesh&&(r=new Uint16Array(this.mesh.indexBuffer[0].lock())),n=0;n<e;n++)if(this.useMesh)for(var v=0;v<this.numParticleIndices;v++)m[n*this.numParticleIndices+v]=r[v]+n*this.numParticleVerts;else{var g=4*n;m[f++]=g,m[f++]=g+1,m[f++]=g+2,m[f++]=g,m[f++]=g+2,m[f++]=g+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}},e.reset=function(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(var e=0;e<this.particleTexStart.length;e++)this.particleTex[e]=this.particleTexStart[e];else this._initializeTextures();this.resetWorldBounds(),this.resetTime();var t=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=t,this.preWarm&&this.prewarm(this.lifetime)},e.prewarm=function(e){for(var t=e/this.lifetime,i=Math.min(Math.floor(t*this.precision),this.precision),n=e/i,a=0;a<i;a++)this.addTime(n,!1)},e.resetTime=function(){var e;this.endTime=(this,e=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime,Date.now()+1e3*e)},e.finishFrame=function(){this.useCpu&&this.vertexBuffer.unlock()},e.addTime=function(e,t){var i,n=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){var a=this.animTilesParams;a[0]=1/this.animTilesX,a[1]=1/this.animTilesY;var s=this.animParams;s[0]=this.animStartFrame,s[1]=this.animNumFrames*this.animSpeed,s[2]=this.animNumFrames-1,s[3]=this.animNumAnimations-1;var r=this.animIndexParams;r[0]=this.animIndex,r[1]=this.randomizeAnimIndex}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(Vs[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Vs[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Vs[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?Us.setTRS(de.ZERO,fe.IDENTITY,this.emitterExtents):Us.setTRS(de.ZERO,this.meshInstance.node.getRotation(),Ns.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));var o=null===this.meshInstance.node?de.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){var l=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(l,this.vbToSort,this.particleTex,Us,Vs,i,e,t)}else this._gpuUpdater.update(n,Us,Vs,e,t);this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)},e._destroyResources=function(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)},e.destroy=function(){this.camera=null,this._destroyResources()},u}(),Ks=4/64,Zs=.875,Qs=[];function Js(e,t,i){var n=new Zi(e);return n.setPositions(t),i&&(i.normals&&n.setNormals(i.normals),i.tangents&&n.setVertexStream(Ee,i.tangents,4),i.colors&&n.setColors32(i.colors),i.uvs&&n.setUvs(0,i.uvs),i.uvs1&&n.setUvs(1,i.uvs1),i.blendIndices&&n.setVertexStream(De,i.blendIndices,4,1),i.blendWeights&&n.setVertexStream(Re,i.blendWeights,4),i.indices&&n.setIndices(i.indices)),n.update(),n}function er(e,t,i,n,a,s){var r,o,l,h,c,u,d,p,f,m,v,g,_,y,b,x,M,S,w,C,P=new de,T=new de,A=new de,E=[],R=[],D=[],I=[],k=[];if(0<i)for(r=0;r<=n;r++)for(o=0;o<=a;o++){v=o/a*2*Math.PI-Math.PI,_=Math.sin(v),g=Math.cos(v),f=new de(_*e,-i/2,g*e),p=new de(_*t,i/2,g*t),P.lerp(f,p,r/n),T.sub2(p,f).normalize(),m=new de(g,0,-_),A.cross(m,T).normalize(),E.push(P.x,P.y,P.z),R.push(A.x,A.y,A.z),u=o/a,d=r/n,D.push(u,1-d);var L=d;d=u,u=L,u=(u/=3)*Zs+Ks,d=d*Zs+Ks,I.push(u,1-d),r<n&&o<a&&(x=r*(a+1)+o,M=r*(a+1)+(o+1),S=(r+1)*(a+1)+o,w=(r+1)*(a+1)+(o+1),k.push(x,M,S),k.push(M,w,S))}if(s){var O,F,z=Math.floor(a/2),B=a,V=i/2;for(O=0;O<=z;O++)for(v=O*Math.PI*.5/z,_=Math.sin(v),g=Math.cos(v),F=0;F<=B;F++)y=2*F*Math.PI/B-Math.PI/2,b=Math.sin(y),l=Math.cos(y)*_,h=g,c=b*_,u=1-F/B,d=1-O/z,E.push(l*t,h*t+V,c*t),R.push(l,h,c),D.push(u,1-d),u=(u/=3)*Zs+Ks,d=(d/=3)*Zs+Ks,u+=1/3,I.push(u,1-d);for(C=(n+1)*(a+1),O=0;O<z;++O)for(F=0;F<B;++F)M=(x=O*(B+1)+F)+B+1,k.push(C+x+1,C+M,C+x),k.push(C+x+1,C+M+1,C+M);for(O=0;O<=z;O++)for(v=.5*Math.PI+O*Math.PI*.5/z,_=Math.sin(v),g=Math.cos(v),F=0;F<=B;F++)y=2*F*Math.PI/B-Math.PI/2,b=Math.sin(y),l=Math.cos(y)*_,h=g,c=b*_,u=1-F/B,d=1-O/z,E.push(l*t,h*t-V,c*t),R.push(l,h,c),D.push(u,1-d),u=(u/=3)*Zs+Ks,d=(d/=3)*Zs+Ks,u+=2/3,I.push(u,1-d);for(C=(n+1)*(a+1)+(B+1)*(z+1),O=0;O<z;++O)for(F=0;F<B;++F)M=(x=O*(B+1)+F)+B+1,k.push(C+x+1,C+M,C+x),k.push(C+x+1,C+M+1,C+M)}else{if(C=(n+1)*(a+1),0<e)for(r=0;r<a;r++)v=r/a*2*Math.PI,h=-i/2,u=1-((l=Math.sin(v))+1)/2,d=((c=Math.cos(v))+1)/2,E.push(l*e,h,c*e),R.push(0,-1,0),D.push(u,1-d),u=(u/=3)*Zs+Ks,d=(d/=3)*Zs+Ks,u+=1/3,I.push(u,1-d),1<r&&k.push(C,C+r,C+r-1);if(C+=a,0<t)for(r=0;r<a;r++)v=r/a*2*Math.PI,h=i/2,u=1-((l=Math.sin(v))+1)/2,d=((c=Math.cos(v))+1)/2,E.push(l*t,h,c*t),R.push(0,1,0),D.push(u,1-d),u=(u/=3)*Zs+Ks,d=(d/=3)*Zs+Ks,u+=2/3,I.push(u,1-d),1<r&&k.push(C,C+r-1,C+r)}return{positions:E,normals:R,uvs:D,uvs1:I,indices:k}}function tr(e,t){var i,n,a,s,r,o,l,h,c,u,d,p,f,m,v=t&&void 0!==t.radius?t.radius:.5,g=t&&void 0!==t.latitudeBands?t.latitudeBands:16,_=t&&void 0!==t.longitudeBands?t.longitudeBands:16,y=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,b=[],x=[],M=[],S=[];for(n=0;n<=g;n++)for(a=n*Math.PI/g,s=Math.sin(a),r=Math.cos(a),i=0;i<=_;i++)o=2*i*Math.PI/_-Math.PI/2,l=Math.sin(o),u=Math.cos(o)*s,d=r,p=l*s,f=1-i/_,m=1-n/g,b.push(u*v,d*v,p*v),x.push(u,d,p),M.push(f,1-m);for(n=0;n<g;++n)for(i=0;i<_;++i)c=(h=n*(_+1)+i)+_+1,S.push(h+1,c,h),S.push(h+1,c+1,c);var w={normals:x,uvs:M,uvs1:M,indices:S};return y&&(w.tangents=y(b,x,M,S)),Js(e,b,w)}function ir(e,t){var i=t&&void 0!==t.halfExtents?t.halfExtents:new de(.5,.5,.5),n=t&&void 0!==t.widthSegments?t.widthSegments:1,a=t&&void 0!==t.lengthSegments?t.lengthSegments:1,s=t&&void 0!==t.heightSegments?t.heightSegments:1,r=!(!t||void 0===t.calculateTangents)&&t.calculateTangents,u=[new de(-i.x,-i.y,i.z),new de(i.x,-i.y,i.z),new de(i.x,i.y,i.z),new de(-i.x,i.y,i.z),new de(i.x,-i.y,-i.z),new de(-i.x,-i.y,-i.z),new de(-i.x,i.y,-i.z),new de(i.x,i.y,-i.z)],d=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],p=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],f=[],m=[],v=[],g=[],_=[],y=0,o=function(e,t,i){var n,a,s,r;for(s=0;s<=t;s++)for(r=0;r<=i;r++){var o=new de,l=new de,h=new de,c=new de;o.lerp(u[d[e][0]],u[d[e][1]],s/t),l.lerp(u[d[e][0]],u[d[e][2]],r/i),h.sub2(l,u[d[e][0]]),c.add2(o,h),n=s/t,a=r/i,f.push(c.x,c.y,c.z),m.push(p[e][0],p[e][1],p[e][2]),v.push(n,1-a),n=(n/=3)*Zs+Ks,a=(a/=3)*Zs+Ks,n+=e%3/3,a+=Math.floor(e/3)/3,g.push(n,1-a),s<t&&r<i&&(_.push(y+i+1,y+1,y),_.push(y+i+1,y+i+2,y+1)),y++}};o(0,n,s),o(1,n,s),o(2,n,a),o(3,n,a),o(4,a,s),o(5,a,s);var l={normals:m,uvs:v,uvs1:g,indices:_};return r&&(l.tangents=r(f,m,v,_)),Js(e,f,l)}function nr(e,t){for(var i=null,n=0;n<Qs.length;n++)Qs[n].type===t&&Qs[n].device===e&&(i=Qs[n].primData);if(!i){var a,s;switch(t){case"box":a=ir(e,{halfExtents:new de(.5,.5,.5)}),s={x:2,y:2,z:2,uv:2/3};break;case"capsule":m=e,_=!(void 0===(v={radius:.5,height:2}).calculateTangents)&&v.calculateTangents,y=er(g=void 0!==v.radius?v.radius:.3,g,(void 0!==v.height?v.height:1)-2*g,void 0!==v.heightSegments?v.heightSegments:1,void 0!==v.sides?v.sides:20,!0),_&&(y.tangents=_(y.positions,y.normals,y.uvs,y.indices)),a=Js(m,y.positions,y),s={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":u=e,p=!(void 0===(d={baseRadius:.5,peakRadius:0,height:1}).calculateTangents)&&d.calculateTangents,f=er(void 0!==d.baseRadius?d.baseRadius:.5,void 0!==d.peakRadius?d.peakRadius:0,void 0!==d.height?d.height:1,void 0!==d.heightSegments?d.heightSegments:5,void 0!==d.capSegments?d.capSegments:18,!1),p&&(f.tangents=p(f.positions,f.normals,f.uvs,f.indices)),a=Js(u,f.positions,f),s={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":r=e,h=!(void 0===(o={radius:.5,height:1}).calculateTangents)&&o.calculateTangents,c=er(l=void 0!==(l=o.radius||o.baseRadius)?l:.5,l,void 0!==o.height?o.height:1,void 0!==o.heightSegments?o.heightSegments:5,void 0!==o.capSegments?o.capSegments:20,!1),h&&(c.tangents=h(c.positions,c.normals,c.uvs,c.indices)),a=Js(r,c.positions,c),s={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":a=function(e,t){var i,n,a,s,r,o,l=void 0!==t.halfExtents?t.halfExtents:new J(.5,.5),h=void 0!==t.widthSegments?t.widthSegments:5,c=void 0!==t.lengthSegments?t.lengthSegments:5,u=!(void 0===t.calculateTangents)&&t.calculateTangents,d=[],p=[],f=[],m=[],v=0;for(i=0;i<=h;i++)for(n=0;n<=c;n++)a=-l.x+2*l.x*i/h,s=-(-l.y+2*l.y*n/c),r=i/h,o=n/c,d.push(a,0,s),p.push(0,1,0),f.push(r,1-o),i<h&&n<c&&(m.push(v+c+1,v+1,v),m.push(v+c+1,v+c+2,v+1)),v++;var g={normals:p,uvs:f,uvs1:f,indices:m};return u&&(g.tangents=u(d,p,f,m)),Js(e,d,g)}(e,{halfExtents:new J(.5,.5),widthSegments:1,lengthSegments:1}),s={x:0,y:1,z:0,uv:1};break;case"sphere":a=tr(e,{radius:.5}),s={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw new Error("Invalid primitive type: "+t)}a.incRefCount(),i={mesh:a,area:s},Qs.push({type:t,device:e,primData:i})}var r,o,l,h,c,u,d,p,f,m,v,g,_,y;return i}var ar=function(n){function M(e,t){var i;return(i=n.call(this)||this).device=t||hi().graphicsDevice,i._targets=e,i.device.supportsMorphTargetTexturesCore&&(i.device.extTextureHalfFloat&&i.device.textureHalfFloatRenderable?i._renderTextureFormat=M.FORMAT_HALF_FLOAT:i.device.extTextureFloat&&i.device.textureFloatRenderable&&(i._renderTextureFormat=M.FORMAT_FLOAT),i.device.extTextureHalfFloat&&i.device.textureHalfFloatUpdatable?i._textureFormat=M.FORMAT_HALF_FLOAT:i.device.extTextureFloat&&(i._textureFormat=M.FORMAT_FLOAT),void 0!==i._renderTextureFormat&&void 0!==i._textureFormat&&(i._useTextureMorph=!0)),i._init(),i._updateMorphFlags(),i._calculateAabb(),i}u(M,n);var e=M.prototype;return e._init=function(){var e;if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(e=0;e<this._targets.length;e++)this._targets[e]._initVertexBuffers(this.device);for(e=0;e<this._targets.length;e++)this._targets[e]._postInit()},e._initTextureBased=function(){var e,t,i,n=[],a=[];for(t=0;t<this._targets.length;t++)(e=this._targets[t]).options.deltaPositions&&(n.push(e.options.deltaPositions),a.push({target:e,name:"texturePositions"})),e.options.deltaNormals&&(n.push(e.options.deltaNormals),a.push({target:e,name:"textureNormals"}));var s,r,o=[],l=[],h=1,c=n[0].length;for(i=0;i<c;i+=3){for(s=!1,t=0;t<n.length;t++)if(0!==(r=n[t])[i]||0!==r[i+1]||0!==r[i+2]){s=!0;break}s?(o.push(h),l.push(i/3),h++):o.push(0)}var u=Math.min(this.device.maxTextureSize,4096),d=Math.ceil(Math.sqrt(h));d=Math.min(d,u);var p=Math.ceil(h/d);if(u<p)return!1;this.morphTextureWidth=d,this.morphTextureHeight=p;var f=!1,m=3,v=Se.float2Half;this._textureFormat===M.FORMAT_HALF_FLOAT&&(f=!0,m=4);var g=this.morphTextureWidth*this.morphTextureHeight*m,_=f?new Uint16Array(g):new Float32Array(g);for(t=0;t<n.length;t++){for(r=n[t],i=0;i<l.length;i++){var y=l[i];f?(_[i*m+m]=v(r[3*y]),_[i*m+m+1]=v(r[3*y+1]),_[i*m+m+2]=v(r[3*y+2])):(_[i*m+m]=r[3*y],_[i*m+m+1]=r[3*y+1],_[i*m+m+2]=r[3*y+2])}e=a[t].target;var b=this._textureFormat===M.FORMAT_FLOAT?13:we;e._setTexture(a[t].name,this._createTexture("MorphTarget",b,_))}var x=[{semantic:Ke,components:1,type:6}];return this.vertexBufferIds=new ht(this.device,new ut(this.device,x),o.length,0,new Float32Array(o)),!0},e.destroy=function(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),this.vertexBufferIds=null);for(var e=0;e<this._targets.length;e++)this._targets[e].destroy();this._targets.length=0},e._updateMorphFlags=function(){var e;this._morphPositions=!1,this._morphNormals=!1;for(var t=0;t<this._targets.length;t++)(e=this._targets[t]).morphPositions&&(this._morphPositions=!0),e.morphNormals&&(this._morphNormals=!0)},e._calculateAabb=function(){var e;this.aabb=new ue(new de(0,0,0),new de(0,0,0));for(var t=0;t<this._targets.length;t++)e=this._targets[t],this.aabb._expand(e.aabb.getMin(),e.aabb.getMax())},e._createTexture=function(e,t,i){var n=new Kt(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return n.name=e,i&&(n.lock().set(i),n.unlock()),n},c(M,[{key:"morphPositions",get:function(){return this._morphPositions}},{key:"morphNormals",get:function(){return this._morphNormals}},{key:"maxActiveTargets",get:function(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}},{key:"useTextureMorph",get:function(){return this._useTextureMorph}},{key:"targets",get:function(){return this._targets}}]),M}(Xi);ar.FORMAT_FLOAT=0,ar.FORMAT_HALF_FLOAT=1;var sr=function(){function e(n){(this.morph=n).incRefCount(),this.device=n.device,this.meshInstance=null,this._weights=[];for(var e=0;e<n._targets.length;e++)this.setWeight(e,n._targets[e].defaultWeight);if(this._activeTargets=[],n.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);var t=function(e,t){var i=n._renderTextureFormat===ar.FORMAT_FLOAT?Ce:we;return this[t]=n._createTexture(e,i),new Fm({colorBuffer:this[t],depth:!1})}.bind(this);n.morphPositions&&(this.rtPositions=t("MorphRTPos","texturePositions")),n.morphNormals&&(this.rtNormals=t("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([n.morphTextureWidth,n.morphTextureHeight,1/n.morphTextureWidth,1/n.morphTextureHeight]);for(var i=0;i<this.maxSubmitCount;i++)this["morphBlendTex"+i]=this.device.scope.resolve("morphBlendTex"+i);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}var t=e.prototype;return t.destroy=function(){this.meshInstance=null,this.shader=null;var e=this.morph;e&&(this.morph=null,e.decRefCount(),e.getRefCount()<1&&e.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)},t.clone=function(){return new e(this.morph)},t.getWeight=function(e){return this._weights[e]},t.setWeight=function(e,t){this._weights[e]=t,this._dirty=!0},t._getFragmentShader=function(e){var t,i="";for(0<e&&(i+="varying vec2 uv0;\nuniform highp float morphFactor["+e+"];\n"),t=0;t<e;t++)i+="uniform highp sampler2D morphBlendTex"+t+";\n";for(i+="void main (void) {\n    highp vec4 color = vec4(0, 0, 0, 1);\n",t=0;t<e;t++)i+="    color.xyz += morphFactor["+t+"] * texture2D(morphBlendTex"+t+", uv0).xyz;\n";return i+"    gl_FragColor = color;\n}\n"},t._getShader=function(e){var t=this.shaderCache[e];if(!t){var i=this._getFragmentShader(e);t=Ht(this.device,"attribute vec2 vertex_position;\nvarying vec2 uv0;\nvoid main(void) {\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    uv0 = vertex_position.xy * 0.5 + 0.5;\n}\n",i,"textureMorph"+e),this.shaderCache[e]=t}return t},t._updateTextureRenderTarget=function(n,e){for(var a=this.device,t=function(e,t){this.morphFactor.setValue(this._shaderMorphWeights),a.setBlending(t),t&&(a.setBlendFunction(1,1),a.setBlendEquation(0));var i=this._getShader(e);At(a,n,i,void 0,void 0,t)}.bind(this),i=0,s=!1,r=this._activeTargets.length,o=0;o<r;o++){var l=this._activeTargets[o],h=l.target[e];h&&(this["morphBlendTex"+i].setValue(h),this._shaderMorphWeights[i]=l.weight,++i>=this.maxSubmitCount&&(t(i,s),s=!(i=0)))}(0<i||0===r&&!this.zeroTextures)&&t(i,s)},t._updateTextureMorph=function(){this.device,(0<this._activeTargets.length||!this.zeroTextures)&&(this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=0===this._activeTargets.length)},t._updateVertexMorph=function(){var e,t=this.maxSubmitCount;for(e=0;e<t;e++)this._shaderMorphWeights[e]=0,this._activeVertexBuffers[e]=null;var i,n=0,a=this.morph.morphPositions?4:0;for(e=0;e<this._activeTargets.length;e++)(i=this._activeTargets[e].target)._vertexBufferPositions&&(this._activeVertexBuffers[n]=i._vertexBufferPositions,this._shaderMorphWeights[n]=this._activeTargets[e].weight,n++),i._vertexBufferNormals&&(this._activeVertexBuffers[a]=i._vertexBufferNormals,this._shaderMorphWeights[a]=this._activeTargets[e].weight,a++)},t.update=function(){this._dirty=!1;var e,t,i,n=this.morph._targets,a=0;for(t=0;t<n.length;t++)1e-5<(i=Math.abs(this.getWeight(t)))&&(this._activeTargets.length<=a&&(this._activeTargets[a]={}),(e=this._activeTargets[a++]).absWeight=i,e.weight=this.getWeight(t),e.target=n[t]);this._activeTargets.length=a;var s=this.morph.maxActiveTargets;this._activeTargets.length>s&&(this._activeTargets.sort(function(e,t){return e.absWeight<t.absWeight?1:t.absWeight<e.absWeight?-1:0}),this._activeTargets.length=s),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()},e}(),rr=function(){function x(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}var e=x.prototype;return e.getGraph=function(){return this.graph},e.setGraph=function(e){this.graph=e},e.getCameras=function(){return this.cameras},e.setCameras=function(e){this.cameras=e},e.getLights=function(){return this.lights},e.setLights=function(e){this.lights=e},e.getMaterials=function(){var e,t=[];for(e=0;e<this.meshInstances.length;e++){var i=this.meshInstances[e];-1===t.indexOf(i.material)&&t.push(i.material)}return t},e.clone=function(){var e,t,a=[],s=[],i=function e(t){var i=t.clone();a.push(t),s.push(i);for(var n=0;n<t._children.length;n++)i.addChild(e(t._children[n]));return i}(this.graph),n=[],r=[],o=[];for(e=0;e<this.skinInstances.length;e++){var l=this.skinInstances[e].skin,h=new Tn(l),c=[];for(t=0;t<l.boneNames.length;t++){var u=l.boneNames[t],d=i.findByName(u);c.push(d)}h.bones=c,r.push(h)}for(e=0;e<this.morphInstances.length;e++){var p=this.morphInstances[e].morph,f=new sr(p);o.push(f)}for(e=0;e<this.meshInstances.length;e++){var m=this.meshInstances[e],v=a.indexOf(m.node),g=new Mn(m.mesh,m.material,s[v]);if(g.index=m.index,m.skinInstance){var _=this.skinInstances.indexOf(m.skinInstance);g.skinInstance=r[_]}if(m.morphInstance){var y=this.morphInstances.indexOf(m.morphInstance);g.morphInstance=o[y]}n.push(g)}var b=new x;return b.graph=i,b.meshInstances=n,b.skinInstances=r,b.morphInstances=o,b.getGraph().syncHierarchy(),b},e.destroy=function(){for(var e=this.meshInstances,t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0},e.generateWireframe=function(){Mn._prepareRenderStyleForArray(this.meshInstances,1)},x}();function or(e){switch(e.type){case Qe:return"RGBM";case Je:return"RGBE";default:switch(e.format){case 11:case 13:case we:case Ce:return"Linear";default:return"Gamma"}}}function lr(e){switch(e===tt&&(e=nt),e){case it:return"Cubemap";case nt:return"Equirect";case"octahedral":return"Octahedral"}}(new pe).setLookAt(new de(0,0,0),new de(1,0,0),new de(0,-1,0)),(new pe).setLookAt(new de(0,0,0),new de(-1,0,0),new de(0,-1,0)),(new pe).setLookAt(new de(0,0,0),new de(0,-1,0),new de(0,0,-1)),(new pe).setLookAt(new de(0,0,0),new de(0,1,0),new de(0,0,1)),(new pe).setLookAt(new de(0,0,0),new de(0,0,1),new de(0,-1,0)),(new pe).setLookAt(new de(0,0,0),new de(0,0,-1),new de(0,-1,0)),new pe;var hr=function(t){function e(){var e;return(e=t.call(this)||this).image=new Image,e.image.src="//realicloud-staging.oss-cn-shenzhen.aliyuncs.com/skyboxes/grocery/right.png",e.root=null,e._gravity=new de(0,-9.8,0),e._layers=null,e._fog=_e,e.fogColor=new $(0,0,0),e.fogStart=1,e.fogEnd=1e3,e.fogDensity=0,e.ambientLight=new $(0,0,0),e._gammaCorrection=0,e._toneMapping=0,e.exposure=1,e._skyboxPrefiltered=[null,null,null,null,null,null],e._skyboxCubeMap=null,e.skyboxModel=null,e._skyboxTransparent=!1,e._skyboxIntensity=1,e._skyboxMip=0,e._skyboxRotation=new fe,e._skyboxRotationMat3=null,e._skyboxRotationMat4=null,e._skyboxIsRenderTarget=!1,e.lightmapSizeMultiplier=1,e.lightmapMaxResolution=2048,e.lightmapMode=1,e._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},e.updateShaders=!0,e.updateSkybox=!0,e._shaderVersion=0,e._statsUpdated=!1,e._models=[],e.defaultMaterial=new gm,e.defaultMaterial.name="Default Material",e.defaultMaterial.shadingModel=1,e}u(e,t);var i=e.prototype;return i.destroy=function(){this._resetSkyboxModel(),this.root=null,this.defaultMaterial.destroy(),this.defaultMaterial=null,this.off()},i.applySettings=function(e){this._gravity.set(e.physics.gravity[0],e.physics.gravity[1],e.physics.gravity[2]),this.ambientLight.set(e.render.global_ambient[0],e.render.global_ambient[1],e.render.global_ambient[2]),this._fog=e.render.fog,this.fogColor.set(e.render.fog_color[0],e.render.fog_color[1],e.render.fog_color[2]),this.fogStart=e.render.fog_start,this.fogEnd=e.render.fog_end,this.fogDensity=e.render.fog_density,this._gammaCorrection=e.render.gamma_correction,this._toneMapping=e.render.tonemapping,this.lightmapSizeMultiplier=e.render.lightmapSizeMultiplier,this.lightmapMaxResolution=e.render.lightmapMaxResolution,this.lightmapMode=e.render.lightmapMode,this.exposure=e.render.exposure,this._skyboxIntensity=void 0===e.render.skyboxIntensity?1:e.render.skyboxIntensity,this._skyboxMip=void 0===e.render.skyboxMip?0:e.render.skyboxMip,e.render.skyboxRotation&&this._skyboxRotation.setFromEulerAngles(e.render.skyboxRotation[0],e.render.skyboxRotation[1],e.render.skyboxRotation[2]),this._resetSkyboxModel(),this.updateShaders=!0},i.generatePBRMaps=function(e,t){var i,n;this.irradianceMap=(i=t,n=new Kt(e,{cubemap:!0,name:"irradianceMap",width:32,height:32,type:Qe,addressU:1,addressV:1,mipmaps:!1,format:we}),function(e,t,i){void 0===i&&(i={}),e instanceof Lm&&(e=arguments[1],t=arguments[2],i={specularPower:void 0===arguments[3]?1:arguments[3],numSamples:void 0===arguments[4]?1024:arguments[4]});var n=e.device,a=i.hasOwnProperty("specularPower")?i.specularPower:1,s=i.roughness,r=i.hasOwnProperty("numSamples")?i.numSamples:1024,o=i.hasOwnProperty("face")?i.face:null,l=i.processFunc||(1===a?"reproject":"prefilter"),h="decode"+or(e),c="encode"+or(t),u="sample"+lr(e.projection),d="getDirection"+lr(t.projection),p=Ht(n,Rt.fullscreenQuadVS,"#define PROCESS_FUNC "+l+"\n#define DECODE_FUNC "+h+"\n#define ENCODE_FUNC "+c+"\n#define SOURCE_FUNC "+u+"\n#define TARGET_FUNC "+d+"\n#define NUM_SAMPLES "+r+"\n#define NUM_SAMPLES_SQRT "+Math.round(Math.sqrt(r)).toFixed(1)+"\n\n"+(i.reprojectRotation?"#define REPROJECT_CUBEMAP_ROTATION 1\n":"")+Rt.reprojectPS,l+h+c+u+d,null,n.webgl2?"":"#extension GL_OES_standard_derivatives: enable\n");if(n.scope.resolve(e.cubemap?"sourceCube":"sourceTex").setValue(e),i.reprojectRotation){var f=n.scope.resolve("reprojectCubeMapRotationMatrix"),m=new pe;m.setFromEulerAngles.apply(m,i.reprojectRotation);var v=new Q;m.invertTo3x3(v),f.setValue(v.data)}for(var g=n.scope.resolve("params"),_=n.scope.resolve("roughness"),y=n.scope.resolve("up"),b=[[0,1,0],[0,1,0],[1,0,0],[1,0,0],[0,1,0],[0,1,0]],x=[0,a,1-(e.fixCubemapSeams?1/e.width:0),1-(t.fixCubemapSeams?1/t.width:0)],M=0;M<(t.cubemap?6:1);M++)if(null===o||M===o){var S=new Fm({colorBuffer:t,face:M,depth:!1});x[0]=M,g.setValue(x),_.setValue(s),y.setValue(b[M]),At(n,S,p),S.destroy()}}(i,n,{processFunc:"irradiance"}),n),e.PBRMapsLoaded=!0},i._updateSkybox=function(r){if(!this.skyboxModel){var o=this._skyboxMip?this._skyboxPrefiltered[[0,1,3,4,5,6][this._skyboxMip]]||this._skyboxPrefiltered[0]||this._skyboxCubeMap:this._skyboxCubeMap||this._skyboxPrefiltered[0];if(!o)return;o._isRenderTarget?this._skyboxIsRenderTarget=!0:this._skyboxIsRenderTarget=!1;var e=new Ui,l=this;e.updateShader=function(e,t,i,n,a){var s=r.getProgramLibrary().getProgram("skybox",{rgbm:o.type===Qe,hdr:o.type===Qe||o.format===Ce,useIntensity:1!==l.skyboxIntensity,useCubeMapRotation:!l.skyboxRotation.equals(fe.IDENTITY),useRightHandedCubeMap:l._skyboxIsRenderTarget,mip:o.fixCubemapSeams?l.skyboxMip:0,fixSeams:o.fixCubemapSeams,gamma:1===a?l.gammaCorrection?3:0:l.gammaCorrection,toneMapping:1===a?0:l.toneMapping});this.shader=s},e.updateShader(),e.setParameter("texture_cubeMap",o),this.skyboxRotation.equals(fe.IDENTITY)||(this._skyboxRotationMat4||(this._skyboxRotationMat4=new pe),this._skyboxRotationMat3||(this._skyboxRotationMat3=new Q),this._skyboxRotationMat4.setTRS(de.ZERO,this._skyboxRotation,de.ONE),this._skyboxRotationMat4.invertTo3x3(this._skyboxRotationMat3),e.setParameter("cubeMapRotationMatrix",this._skyboxRotationMat3.data)),e.cull=2,e.depthWrite=!1;var t=this.layers.getLayerById(2);if(t){var i=new mn("Skybox"),n=ir(r),a=new Mn(n,e,i);a.cull=!1,a._noDepthDrawGl1=!0;var s=new rr;s.graph=i,s.meshInstances=[a],this.skyboxModel=s,this._skyboxTransparent||t.addMeshInstances(s.meshInstances),this.skyLayer=t,this.fire("set:skybox",o)}}},i._resetSkyboxModel=function(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyboxModel.destroy()),this.skyboxModel=null,this.updateSkybox=!0},i.setSkybox=function(e){var t;e||(e=[null,null,null,null,null,null,null]);var i=!1;if(this._skyboxCubeMap!==e[0]&&(i=!0),!i)for(t=0;t<6&&!i;t++)this._skyboxPrefiltered[t]!==e[t+1]&&(i=!0);if(i){for(t=0;t<6;t++)this._skyboxPrefiltered[t]=e[t+1];this.skybox=e[0],(this.skybox||this._skyboxPrefiltered[0])&&this.generatePBRMaps(rm.graphicsDevice,this.skybox||this._skyboxPrefiltered[0])}},i.addModel=function(e){if(!this.containsModel(e)){var t=this.layers.getLayerById(0);t&&(t.addMeshInstances(e.meshInstances),this._models.push(e))}},i.addShadowCaster=function(e){var t=this.layers.getLayerById(0);t&&t.addShadowCasters(e.meshInstances)},i.removeModel=function(e){var t=this._models.indexOf(e);if(-1!==t){var i=this.layers.getLayerById(0);if(!i)return;i.removeMeshInstances(e.meshInstances),this._models.splice(t,1)}},i.removeShadowCasters=function(e){var t=this.layers.getLayerById(0);t&&t.removeShadowCasters(e.meshInstances)},i.containsModel=function(e){return 0<=this._models.indexOf(e)},i.getModels=function(e){return this._models},c(e,[{key:"fog",get:function(){return this._fog},set:function(e){e!==this._fog&&(this._fog=e,this.updateShaders=!0)}},{key:"gammaCorrection",get:function(){return this._gammaCorrection},set:function(e){e!==this._gammaCorrection&&(this._gammaCorrection=e,this.updateShaders=!0)}},{key:"toneMapping",get:function(){return this._toneMapping},set:function(e){e!==this._toneMapping&&(this._toneMapping=e,this.updateShaders=!0)}},{key:"skybox",get:function(){return this._skyboxCubeMap},set:function(e){this._skyboxCubeMap=e,this._resetSkyboxModel(),this.updateShaders=!0}},{key:"skyboxTransparent",get:function(){return this._skyboxTransparent},set:function(e){this._skyboxTransparent=e,this._resetSkyboxModel(),this.updateShaders=!0}},{key:"skyboxIntensity",get:function(){return this._skyboxIntensity},set:function(e){this._skyboxIntensity=e,this._resetSkyboxModel(),this.updateShaders=!0}},{key:"skyboxRotation",get:function(){return this._skyboxRotation},set:function(e){this._skyboxRotation.equals(e)||(this._skyboxRotation.copy(e),this._resetSkyboxModel(),this.updateShaders=!0)}},{key:"skyboxMip",get:function(){return this._skyboxMip},set:function(e){this._skyboxMip=e,this._resetSkyboxModel(),this.updateShaders=!0}},{key:"skyboxPrefiltered128",get:function(){return this._skyboxPrefiltered[0]},set:function(e){this._skyboxPrefiltered[0]!==e&&(this._skyboxPrefiltered[0]=e,this.updateShaders=!0)}},{key:"skyboxPrefiltered64",get:function(){return this._skyboxPrefiltered[1]},set:function(e){this._skyboxPrefiltered[1]!==e&&(this._skyboxPrefiltered[1]=e,this.updateShaders=!0)}},{key:"skyboxPrefiltered32",get:function(){return this._skyboxPrefiltered[2]},set:function(e){this._skyboxPrefiltered[2]!==e&&(this._skyboxPrefiltered[2]=e,this.updateShaders=!0)}},{key:"skyboxPrefiltered16",get:function(){return this._skyboxPrefiltered[3]},set:function(e){this._skyboxPrefiltered[3]!==e&&(this._skyboxPrefiltered[3]=e,this.updateShaders=!0)}},{key:"skyboxPrefiltered8",get:function(){return this._skyboxPrefiltered[4]},set:function(e){this._skyboxPrefiltered[4]!==e&&(this._skyboxPrefiltered[4]=e,this.updateShaders=!0)}},{key:"skyboxPrefiltered4",get:function(){return this._skyboxPrefiltered[5]},set:function(e){this._skyboxPrefiltered[5]!==e&&(this._skyboxPrefiltered[5]=e,this.updateShaders=!0)}},{key:"drawCalls",get:function(){var e=this.layers._meshInstances;return e.length||(this.layers._update(),e=this.layers._meshInstances),e},set:function(e){}},{key:"layers",get:function(){return this._layers},set:function(e){var t=this._layers;this._layers=e,this.fire("set:layers",t,e)}},{key:"defaultMaterial",get:function(){return Ui.defaultMaterial},set:function(e){Ui.defaultMaterial=e}}]),e}(p);function cr(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}var ur=function(){function e(e,t,i){if(void 0===i&&(i={}),this.volume=void 0===i.volume?1:i.volume,this.loop=void 0!==i.loop&&i.loop,this.pitch=void 0===i.pitch?1:i.pitch,this.sound=t,this.paused=!1,this.suspended=!1,this.manager=e,this.source=null,cr()){this.startTime=0,this.startOffset=0;var n=e.context;this.gain=n.createGain()}else t.audio&&(this.source=t.audio.cloneNode(!1),this.source.pause())}var t=e.prototype;return t.getVolume=function(){return this.volume},t.getLoop=function(){return this.loop},t.setLoop=function(e){this.loop=e,this.source&&(this.source.loop=e)},t.getPitch=function(){return this.pitch},t.onManagerVolumeChange=function(){this.setVolume(this.getVolume())},t.onManagerSuspend=function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},t.onManagerResume=function(){this.suspended&&(this.suspended=!1,this.unpause())},e}();cr()?Object.assign(ur.prototype,{play:function(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){!this.source&&this.paused&&(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(e){e=Se.clamp(e,0,1),this.volume=e,this.gain&&(this.gain.gain.value=e*this.manager.volume)},setPitch:function(e){this.pitch=e,this.source&&(this.source.playbackRate.value=e)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){var e=this.manager.context;this.sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}):Object.assign(ur.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(e){e=Se.clamp(e,0,1),this.volume=e,this.source&&(this.source.volume=e*this.manager.volume)},setPitch:function(e){this.pitch=e,this.source&&(this.source.playbackRate=e)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});var dr="linear",pr="inverse",fr="exponential",mr=function(a){function e(e,t,i){var n;return(n=a.call(this,e,t,i)||this).position=new de,n.velocity=new de,cr()?n.panner=e.context.createPanner():(n.maxDistance=1e4,n.minDistance=1,n.rollOffFactor=1,n.distanceModel=pr),n}u(e,a);var t=e.prototype;return t.getPosition=function(){return this.position},t.getVelocity=function(){return this.velocity},e}(ur);if(cr())Object.assign(mr.prototype,{setPosition:function(e){this.position.copy(e),this.panner.setPosition(e.x,e.y,e.z)},setVelocity:function(e){this.velocity.copy(e),this.panner.setVelocity(e.x,e.y,e.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){this.panner.maxDistance=e},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(e){this.panner.refDistance=e},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(e){this.panner.rolloffFactor=e},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(e){this.panner.distanceModel=e},_createSource:function(){var e=this.manager.context;this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this))}});else{var vr=new de;Object.assign(mr.prototype,{setPosition:function(e){if(this.position.copy(e),this.source){var t=function(e,t,i,n,a,s){var r=(vr=vr.sub2(e,t)).length();if(r<i)return 1;if(n<r)return 0;var o=0;return s===dr?o=1-a*(r-i)/(n-i):s===pr?o=i/(i+a*(r-i)):s===fr&&(o=Math.pow(r/i,-a)),Se.clamp(o,0,1)}(this.manager.listener.getPosition(),this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.getVolume();this.source.volume=i*t}},setVelocity:function(e){this.velocity.copy(e)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(e){this.maxDistance=e},getMinDistance:function(){return this.minDistance},setMinDistance:function(e){this.minDistance=e},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(e){this.rollOffFactor=e},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(e){this.distanceModel=e}})}var gr=function(){function e(e){this._manager=e,this.position=new de,this.velocity=new de,this.orientation=new pe}var t=e.prototype;return t.getPosition=function(){return this.position},t.setPosition=function(e){this.position.copy(e);var t=this.listener;t&&t.setPosition(e.x,e.y,e.z)},t.getVelocity=function(){return this.velocity},t.setVelocity=function(e){this.velocity.copy(e);var t=this.listener;t&&t.setPosition(e.x,e.y,e.z)},t.setOrientation=function(e){this.orientation.copy(e);var t=this.listener;t&&t.setOrientation(-e.data[8],-e.data[9],-e.data[10],e.data[4],e.data[5],e.data[6])},t.getOrientation=function(){return this.orientation},c(e,[{key:"listener",get:function(){var e=this._manager.context;return e?e.listener:null}}]),e}(),_r=function(t){function e(e){var n;return(n=t.call(this)||this)._context=null,n._forceWebAudioApi=e.forceWebAudioApi,n._resumeContext=null,n._unlock=null,(cr()||n._forceWebAudioApi)&&(n._resumeContext=function(){window.removeEventListener("mousedown",n._resumeContext),window.removeEventListener("touchend",n._resumeContext),n.context&&n.context.resume()},window.addEventListener("mousedown",n._resumeContext),window.addEventListener("touchend",n._resumeContext),S&&(n._unlock=function(){window.removeEventListener("touchend",n._unlock);var e=n.context;if(e){var t=e.createBuffer(1,1,44100),i=e.createBufferSource();i.buffer=t,i.connect(e.destination),i.start(0),i.disconnect()}},window.addEventListener("touchend",n._unlock))),n.listener=new gr(g(n)),n._volume=1,n.suspended=!1,n}u(e,t);var i=e.prototype;return i.suspend=function(){this.suspended=!0,this.fire("suspend")},i.resume=function(){this.suspended=!1,this.fire("resume")},i.destroy=function(){this._resumeContext&&(window.removeEventListener("mousedown",this._resumeContext),window.removeEventListener("touchend",this._resumeContext)),this._unlock&&window.removeEventListener("touchend",this._unlock),this.fire("destroy"),this._context&&this._context.close&&(this._context.close(),this._context=null)},i.playSound=function(e,t){t=t||{};var i=null;return ur&&(i=new ur(this,e,t)).play(),i},i.playSound3d=function(e,t,i){i=i||{};var n=null;return mr&&((n=new mr(this,e,i)).setPosition(t),i.volume&&n.setVolume(i.volume),i.loop&&n.setLoop(i.loop),i.maxDistance&&n.setMaxDistance(i.maxDistance),i.minDistance&&n.setMinDistance(i.minDistance),i.rollOffFactor&&n.setRollOffFactor(i.rollOffFactor),i.distanceModel&&n.setDistanceModel(i.distanceModel),n.play()),n},c(e,[{key:"volume",get:function(){return this._volume},set:function(e){e=Se.clamp(e,0,1),this._volume=e,this.fire("volumechange",e)}},{key:"context",get:function(){return this._context||(cr()||this._forceWebAudioApi)&&("undefined"!=typeof AudioContext?this._context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this._context=new webkitAudioContext)),this._context}}]),e}(p),yr=function(e,t,i,n){this.time=e,this.position=t,this.rotation=i,this.scale=n},br=function(){this._name="",this._keys=[]},xr=function(){function e(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}var t=e.prototype;return t.getNode=function(e){return this._nodeDict[e]},t.addNode=function(e){this._nodes.push(e),this._nodeDict[e._name]=e},c(e,[{key:"nodes",get:function(){return this._nodes}}]),e}(),Mr=function(){function e(e){2===arguments.length&&(e=arguments[1]),this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this.aabb=e.aabb,this.aabb||(this.aabb=new ue,e.deltaPositions&&this.aabb.compute(e.deltaPositions)),this.deltaPositions=e.deltaPositions}var t=e.prototype;return t._postInit=function(){this.options=null},t._initVertexBuffers=function(e){var t=this.options;this._vertexBufferPositions=this._createVertexBuffer(e,t.deltaPositions,t.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(e,t.deltaNormals,t.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())},t._createVertexBuffer=function(e,t,i){return void 0===i&&(i=6),t?new ht(e,new ut(e,[{semantic:Ge,components:3,type:i}]),t.length/3,0,t):null},t._setTexture=function(e,t){this[e]=t},t.destroy=function(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null),this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)},c(e,[{key:"name",get:function(){return this._name}},{key:"defaultWeight",get:function(){return this._defaultWeight}},{key:"morphPositions",get:function(){return!!this._vertexBufferPositions||!!this.texturePositions}},{key:"morphNormals",get:function(){return!!this._vertexBufferNormals||!!this.textureNormals}}]),e}(),Sr=function(e,t,i){this.device=e,this.inverseBindPose=t,this.boneNames=i},wr=function(t){function e(){var e;return(e=t.call(this)||this)._meshes=null,e}u(e,t);var i=e.prototype;return i.destroy=function(){this.meshes=null},i.decRefMeshes=function(){if(this._meshes)for(var e=this._meshes.length,t=0;t<e;t++){var i=this._meshes[t];i&&(i.decRefCount(),i.getRefCount()<1&&(i.destroy(),this._meshes[t]=null))}},i.incRefMeshes=function(){if(this._meshes)for(var e=this._meshes.length,t=0;t<e;t++)this._meshes[t]&&this._meshes[t].incRefCount()},c(e,[{key:"meshes",get:function(){return this._meshes},set:function(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}}]),e}(p),Cr=function(r){function o(e,t){var i;if(i=r.call(this,e)||this,e instanceof om&&(t=e),i._batchHandle=null,i.c={},!(i._app=t)&&(i._app=om.getApplication(),!i._app))throw new Error("Couldn't find current application");return i._guid=null,i._destroying=!1,i._template=!1,i}u(o,r);var e=o.prototype;return e.addComponent=function(e,t){var i=this._app.systems[e];return i?this.c[e]?null:i.addComponent(this,t):null},e.removeComponent=function(e){var t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)},e.findComponent=function(t){var e=this.findOne(function(e){return e.c&&e.c[t]});return e&&e.c[t]},e.findComponents=function(t){return this.find(function(e){return e.c&&e.c[t]}).map(function(e){return e.c[t]})},e.getGuid=function(){return this._guid||this.setGuid(B()),this._guid},e.setGuid=function(e){var t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this},e._notifyHierarchyStateChanged=function(e,t){var i,n,a=!1;e===this&&0===this._app._enableList.length&&(a=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&this._app._enableList.push(e);var s=e._children;for(i=0,n=s.length;i<n;i++)s[i]._enabled&&this._notifyHierarchyStateChanged(s[i],t);if(e._beingEnabled=!1,a){for(i=0;i<this._app._enableList.length;i++)this._app._enableList[i]._onHierarchyStatePostChanged();this._app._enableList.length=0}},e._onHierarchyStateChanged=function(e){var t;r.prototype._onHierarchyStateChanged.call(this,e);var i=this.c;for(var n in i)i.hasOwnProperty(n)&&(t=i[n]).enabled&&(e?t.onEnable():t.onDisable())},e._onHierarchyStatePostChanged=function(){var e=this.c;for(var t in e)e.hasOwnProperty(t)&&e[t].onPostStateChange()},e.findByGuid=function(e){if(this._guid===e)return this;var t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null},e.destroy=function(){var e;for(e in this._destroying=!0,this.c)this.c[e].enabled=!1;for(e in this.c)this.c[e].system.removeComponent(this);this._parent&&this._parent.removeChild(this);for(var t=this._children,i=t.shift();i;)i instanceof o&&i.destroy(),i._parent=null,i=t.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1},e.clone=function(){var e={},t=this._cloneRecursively(e);return function e(t,i,n,a){var s,r;if(i instanceof Cr){var o=i.c;for(var l in o){var h=o[l],c=h.system.getPropertiesOfType("entity");for(s=0,r=c.length;s<r;s++){var u=c[s].name,d=h[u];if(t.findByGuid(d)){var p=a[d].getGuid();p&&(n.c[l][u]=p)}}}o.script&&!n._app.useLegacyScriptAttributeCloning&&n.script.resolveDuplicatedEntityReferenceProperties(o.script,a);var f=i.children.filter(function(e){return e instanceof Cr}),m=n.children.filter(function(e){return e instanceof Cr});for(s=0,r=f.length;s<r;s++)e(t,f[s],m[s],a)}}(this,this,e[this.getGuid()]=t,e),t},e._cloneRecursively=function(e){var t,i=new o(this._app);for(var n in r.prototype._cloneInternal.call(this,i),this.c)this.c[n].system.cloneComponent(this,i);for(t=0;t<this._children.length;t++){var a=this._children[t];if(a instanceof o){var s=a._cloneRecursively(e);i.addChild(s),e[a.getGuid()]=s}}return i},o}(mn);var Pr=function(){function e(e,t,i,n){this._paths=e,this._input=t,this._output=i,this._interpolation=n}return c(e,[{key:"paths",get:function(){return this._paths}},{key:"input",get:function(){return this._input}},{key:"output",get:function(){return this._output}},{key:"interpolation",get:function(){return this._interpolation}}]),e}(),Tr=function(){function e(e,t){this._components=e,this._data=t}return c(e,[{key:"components",get:function(){return this._components}},{key:"data",get:function(){return this._data}}]),e}(),Ar=function(){function e(e){this._events=[].concat(e),this._events.sort(function(e,t){return e.time-t.time})}return c(e,[{key:"events",get:function(){return this._events}}]),e}(),Er=function(){function e(e,t,i,n,a,s){void 0===s&&(s=new Ar([])),this._name=e,this._duration=t,this._inputs=i,this._outputs=n,this._curves=a,this._animEvents=s}return e.prototype.eval=function(e,t){t._time=e;var i,n=this._inputs,a=this._outputs,s=this._curves,r=t._cache,o=t._results;for(i=0;i<n.length;++i)r[i].update(e,n[i]._data);for(i=0;i<s.length;++i){var l=s[i],h=a[l._output],c=o[i];r[l._input].eval(c,l._interpolation,h)}},c(e,[{key:"name",get:function(){return this._name}},{key:"duration",get:function(){return this._duration}},{key:"inputs",get:function(){return this._inputs}},{key:"outputs",get:function(){return this._outputs}},{key:"curves",get:function(){return this._curves}},{key:"events",get:function(){return this._animEvents.events},set:function(e){this._animEvents=e}}]),e}(),Rr=function(){function e(){}e.joinPath=function(e,t){return t=t||".",e.map(function(e){return e.replace(/\\/g,"\\\\").replace(new RegExp("\\"+t,"g"),"\\"+t)}).join(t)},e.splitPath=function(e,t){t=t||".";for(var i=[],n="",a=0;a<e.length;){var s=e[a++];"\\"===s&&a<e.length?n+="\\"===(s=e[a++])||s===t?s:"\\"+s:s===t?(i.push(n),n=""):n+=s}return 0<n.length&&i.push(n),i},e.encode=function(e,t,i){return(Array.isArray(e)?e.join("/"):e)+"/"+t+"/"+(Array.isArray(i)?i.join("/"):i)};var t=e.prototype;return t.resolve=function(e){return null},t.unresolve=function(e){},t.update=function(e){},e}(),Dr="en-US",Ir={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},kr={};function Lr(e,t){for(var i=0,n=e.length;i<n;i++)kr[e[i]]=t}function Or(e){var t=e.indexOf("-");return-1!==t?e.substring(0,t):e}function Fr(e,t){if(t[e])return e;var i=Ir[e];if(i&&t[i])return i;var n=Or(e);return t[i=Ir[n]]?i:t[n]?n:Dr}Lr(["ja","ko","th","vi","zh","id"],function(e){return 0}),Lr(["fa","hi"],function(e){return 0<=e&&e<=1?0:1}),Lr(["fr","pt"],function(e){return 0<=e&&e<2?0:1}),Lr(["da"],function(e){return 1===e||!Number.isInteger(e)&&0<=e&&e<=1?0:1}),Lr(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],function(e){return 1===e?0:1}),Lr(["ru","uk"],function(e){if(Number.isInteger(e)){var t=e%10,i=e%100;if(1===t&&11!==i)return 0;if(2<=t&&t<=4&&(i<12||14<i))return 1;if(0===t||5<=t&&t<=9||11<=i&&i<=14)return 2}return 3}),Lr(["pl"],function(e){if(Number.isInteger(e)){if(1===e)return 0;var t=e%10,i=e%100;if(2<=t&&t<=4&&(i<12||14<i))return 1;if(0<=t&&t<=1||5<=t&&t<=9||12<=i&&i<=14)return 2}return 3}),Lr(["ar"],function(e){if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){var t=e%100;if(3<=t&&t<=10)return 3;if(11<=t&&t<=99)return 4}return 5});var zr=kr[Or(Dr)];function Br(e){return kr[e]||zr}var Vr=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i"),Ur=".glb",Nr=".rbx",Gr=".r3d",Wr=[],Hr=function(){function e(e){this.asset=e}return e.prototype.clear=function(){for(var e=0;e<Wr.length;e++)this[Wr[e]]=null},e}();function jr(e){var t="_"+e;Wr.push(t),Object.defineProperty(Hr.prototype,e,{get:function(){return this[t]||null},set:function(e){(!!this[t]!=!!e||this[t]&&e&&this[t].hash!==e.hash)&&(this[t]=e?{url:e.url,filename:e.filename,size:e.size,hash:e.hash,opt:e.opt||0}:null,this.asset.file&&(this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file),this.asset.reload()))}})}jr("dxt"),jr("pvr"),jr("etc1"),jr("etc2"),jr("basis");var Xr,qr=-1,$r={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},Yr=["pvr","dxt","etc2","etc1","basis"],Kr=function(r){function e(e,t,i,n,a){var s;return(s=r.call(this)||this)._id=qr--,s.name=e||"",s.type=t,s.tags=new G(g(s)),s._preload=!1,s.variants=new Hr(g(s)),s._file=null,s._data=n||{},s.options=a||{},s._resources=[],s._i18n={},s.loaded=!1,s.loading=!1,s.registry=null,i&&(s.file=i),s}u(e,r);var t=e.prototype;return t.getFileUrl=function(){var e=this.getPreferredFile();if(!e||!e.url)return null;var t=e.url;if(this.registry&&this.registry.prefix&&!Vr.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){var i=-1!==t.indexOf("?")?"&":"?";t+=i+"t="+e.hash}return t},t.getPreferredFile=function(){if(!this.file)return null;if("texture"===this.type||"textureatlas"===this.type||"bundle"===this.type){var e,t,i=(null==(e=this.registry)||null==(t=e._loader)?void 0:t._app)||hi(),n=null==i?void 0:i.graphicsDevice;if(n)for(var a=0,s=Yr.length;a<s;a++){var r=Yr[a];if(n[$r[r]]){if(this.file.variants[r])return this.file.variants[r];if(i.enableBundles){var o=i.bundles.listBundlesForAsset(this);if(!o)continue;for(var l=0,h=o.length;l<h;l++)if(o[l].file&&o[l].file.variants&&o[l].file.variants[r])return this.file}}}}return this.file},t.getAbsoluteUrl=function(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;var t=C.getDirectory(this.file.url);return C.join(t,e)},t.getLocalizedAssetId=function(e){return e=Fr(e,this._i18n),this._i18n[e]||null},t.addLocalizedAssetId=function(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)},t.removeLocalizedAssetId=function(e){var t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))},t.ready=function(t,i){i=i||this,this.resource?t.call(i,this):this.once("load",function(e){t.call(i,e)})},t.reload=function(){this.loaded&&(this.loaded=!1,this.registry.load(this))},t.unload=function(){if(this.loaded||0!==this._resources.length){this.fire("unload",this),this.registry.fire("unload:"+this.id,this);var e=this._resources;this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(var t=0;t<e.length;++t){var i=e[t];i&&i.destroy&&i.destroy()}}},c(e,[{key:"id",get:function(){return this._id},set:function(e){this._id=e}},{key:"file",get:function(){return this._file},set:function(e){var t;if(!!e!=!!this._file||e&&this._file&&e.hash!==this._file)if(e){if(this._file||(this._file={}),this._file.url=e.url,this._file.filename=e.filename,this._file.hash=e.hash,this._file.size=e.size,this._file.variants=this.variants,this._file.contents=e.contents,e.hasOwnProperty("variants")&&(this.variants.clear(),e.variants))for(t in e.variants)e.variants[t]&&(this.variants[t]=e.variants[t]);this.hasOwnProperty("_handlerState")&&(this._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]}),this.fire("change",this,"file",this._file,this._file),this.reload()}else this._file=null,this.variants.clear();else if(e&&this._file&&e.hasOwnProperty("variants")&&(this.variants.clear(),e.variants))for(t in e.variants)e.variants[t]&&(this.variants[t]=e.variants[t])}},{key:"data",get:function(){return this._data},set:function(e){var t=this._data;(this._data=e)!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}},{key:"resource",get:function(){return this._resources[0]},set:function(e){var t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}},{key:"resources",get:function(){return this._resources},set:function(e){var t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}},{key:"preload",get:function(){return this._preload},set:function(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}},{key:"loadFaces",get:function(){return this._loadFaces},set:function(e){e=!!e,this.hasOwnProperty("_loadFaces")&&e===this._loadFaces||(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}}]),e}(p),Zr=function(){function e(e){this.gltf=e,this.nodes=null,this.scenes=null,this.animations=null,this.textures=null,this.materials=null,this.renders=null,this.skins=null,this.lights=null}return e.prototype.destroy=function(){this.renders&&this.renders.forEach(function(e){e.meshes=null})},e}(),Qr=function(e){return/^data:.*,.*$/i.test(e)},Jr=function(e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 3}},eo=function(e){switch(e){case 5120:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6;default:return 0}},to=function(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},io={POSITION:Te,NORMAL:Ae,TANGENT:Ee,COLOR_0:Ie,JOINTS_0:De,WEIGHTS_0:Re,TEXCOORD_0:Le,TEXCOORD_1:Oe},no=function e(t,i){var n,a=Jr(t.type),s=function(e){switch(t.componentType){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}}();if(!s)return null;if(t.sparse){var r=t.sparse,o={count:r.count,type:"SCALAR"},l=e(Object.assign(o,r.indices),i),h={count:r.count,type:t.scalar,componentType:t.componentType},c=e(Object.assign(h,r.values),i);n=t.hasOwnProperty("bufferView")?e({bufferView:t.bufferView,byteOffset:t.byteOffset,componentType:t.componentType,count:t.count,type:t.type},i).slice():new s(t.count*a);for(var u=0;u<r.count;++u)for(var d=l[u],p=0;p<a;++p)n[d*a+p]=c[u*a+p]}else{var f=i[t.bufferView];n=new s(f.buffer,f.byteOffset+(t.byteOffset||0),t.count*a)}return n},ao=function(e,t){var i=e.POSITION;if(i&&3===i.components){var n;if(i.size!==i.stride){var a=i.stride/st[i.type],s=new at[i.type](i.buffer,i.offset,i.count*a);n=new at[i.type](3*i.count);for(var r=0;r<i.count;++r)n[3*r+0]=s[r*a+0],n[3*r+1]=s[r*a+1],n[3*r+2]=s[r*a+2]}else n=new at[i.type](i.buffer,i.offset,3*i.count);var o=i.count;t||(t=function(e){for(var t=new Uint16Array(e),i=0;i<e;i++)t[i]=i;return t}(o));var l=function(e,t){var i,n,a,s,r=t.length/3,o=e.length/3,l=new de,h=new de,c=new de,u=new de,d=new de,p=new de,f=[];for(s=0;s<e.length;s++)f[s]=0;for(s=0;s<r;s++)i=t[3*s],n=t[3*s+1],a=t[3*s+2],l.set(e[3*i],e[3*i+1],e[3*i+2]),h.set(e[3*n],e[3*n+1],e[3*n+2]),c.set(e[3*a],e[3*a+1],e[3*a+2]),u.sub2(h,l),d.sub2(c,l),p.cross(u,d).normalize(),f[3*i]+=p.x,f[3*i+1]+=p.y,f[3*i+2]+=p.z,f[3*n]+=p.x,f[3*n+1]+=p.y,f[3*n+2]+=p.z,f[3*a]+=p.x,f[3*a+1]+=p.y,f[3*a+2]+=p.z;for(s=0;s<o;s++){var m=f[3*s],v=f[3*s+1],g=f[3*s+2],_=1/Math.sqrt(m*m+v*v+g*g);f[3*s]*=_,f[3*s+1]*=_,f[3*s+2]*=_}return f}(n,t),h=new Float32Array(l.length);h.set(l),e.NORMAL={buffer:h.buffer,size:12,offset:0,stride:12,count:o,components:3,type:6}}},so=function(e,t,i){var n=t.POSITION;if(!n)return null;var a=n.count,s=[];for(var r in t)t.hasOwnProperty(r)&&s.push({semantic:r,components:t[r].components,type:t[r].type,normalize:!!t[r].normalize});var o,l,h,c,u,d,p=[Te,Ae,Ee,Ie,De,Re,Le,Oe];s.sort(function(e,t){var i=p.indexOf(e.semantic),n=p.indexOf(t.semantic);return i<n?-1:n<i?1:0});var f=new ut(e,s),m=!0;for(o=0;o<f.elements.length;++o)if(d=(c=t[(u=f.elements[o]).name]).offset-n.offset,c.buffer!==n.buffer||c.stride!==u.stride||c.size!==u.size||d!==u.offset){m=!1;break}var v,g,_,y=new ht(e,f,a,0),b=y.lock(),x=new Uint32Array(b);if(m)v=new Uint32Array(n.buffer,n.offset,a*y.format.size/4),x.set(v);else for(o=0;o<y.format.elements.length;++o){g=(u=y.format.elements[o]).stride/4,_=(c=t[u.name]).stride/4,v=new Uint32Array(c.buffer,c.offset,(c.count-1)*_+c.size/4);var M=0,S=u.offset/4,w=Math.floor((c.size+3)/4);for(l=0;l<a;++l){for(h=0;h<w;++h)x[S+h]=v[M+h];M+=_,S+=g}}return i||function(r){var o,l,e=[],t=[],i=[];for(o=0;o<r.format.elements.length;++o){var n=r.format.elements[o];if(n.name===Le||n.name===Oe)switch(n.dataType){case 6:e.push({offset:n.offset/4+1,stride:n.stride/4});break;case 3:t.push({offset:n.offset/2+1,stride:n.stride/2});break;case 1:i.push({offset:n.offset+1,stride:n.stride})}}var a=function(e,t,i){var n=new t(r.storage);for(o=0;o<e.length;++o){var a=e[o].offset,s=e[o].stride;for(l=0;l<r.numVertices;++l)n[a]=i-n[a],a+=s}};0<e.length&&a(e,Float32Array,1),0<t.length&&a(t,Uint16Array,65535),0<i.length&&a(i,Uint8Array,255)}(y),y.unlock(),y},ro=new pe,oo=new de,lo=function(e,t,h){var i,n,a=["#ifdef MAPFLOAT","uniform float material_shininess;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_glossMap;","#endif","","void getGlossiness() {","    dGlossiness = 1.0;","","#ifdef MAPFLOAT","    dGlossiness *= material_shininess;","#endif","","#ifdef MAPTEXTURE","    dGlossiness *= texture2D(texture_glossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","    dGlossiness *= saturate(vVertexColor.$VC);","#endif","","    dGlossiness = 1.0 - dGlossiness;","","    dGlossiness += 0.0000001;","}"].join("\n"),s=["#ifdef MAPCOLOR","uniform vec3 material_specular;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_specularMap;","#endif","","void getSpecularity() {","    dSpecularity = vec3(1.0);","","    #ifdef MAPCOLOR","        dSpecularity *= material_specular;","    #endif","","    #ifdef MAPTEXTURE","        vec3 srgb = texture2D(texture_specularMap, $UV).$CH;","        dSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));","    #endif","","    #ifdef MAPVERTEX","        dSpecularity *= saturate(vVertexColor.$VC);","    #endif","}"].join("\n"),r=["#ifdef MAPFLOAT","uniform float material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_clearCoatGlossMap;","#endif","","void getClearCoatGlossiness() {","    ccGlossiness = 1.0;","","#ifdef MAPFLOAT","    ccGlossiness *= material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","    ccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","    ccGlossiness *= saturate(vVertexColor.$VC);","#endif","","    ccGlossiness = 1.0 - ccGlossiness;","","    ccGlossiness += 0.0000001;","}"].join("\n"),c=[1,1],u=[0,0],o=function(e,t,i){var n,a=e.texCoord;if(a)for(n=0;n<i.length;++n)t[i[n]+"MapUv"]=a;var s=c,r=u,o=e.extensions;if(o){var l=o.KHR_texture_transform;l&&(l.scale&&(s=l.scale),l.offset&&(r=l.offset))}for(n=0;n<i.length;++n)t[i[n]+"MapTiling"]=new J(s[0],s[1]),t[i[n]+"MapOffset"]=new J(r[0],h?1-s[1]-r[1]:r[1])},l=new gm;if(l.occludeSpecular=!0,l.diffuseTint=!0,l.diffuseVertexColor=!0,l.specularTint=!0,l.specularVertexColor=!0,e.hasOwnProperty("name")&&(l.name=e.name),e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){var d=e.extensions.KHR_materials_pbrSpecularGlossiness;if(d.hasOwnProperty("diffuseFactor")?(i=d.diffuseFactor,l.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),l.opacity=i[3]):(l.diffuse.set(1,1,1),l.opacity=1),d.hasOwnProperty("diffuseTexture")){var p=d.diffuseTexture;n=t[p.index],l.diffuseMap=n,l.diffuseMapChannel="rgb",l.opacityMap=n,l.opacityMapChannel="a",o(p,l,["diffuse","opacity"])}if(l.useMetalness=!1,d.hasOwnProperty("specularFactor")?(i=d.specularFactor,l.specular.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))):l.specular.set(1,1,1),d.hasOwnProperty("glossinessFactor")?l.shininess=100*d.glossinessFactor:l.shininess=100,d.hasOwnProperty("specularGlossinessTexture")){var f=d.specularGlossinessTexture;l.specularMap=l.glossMap=t[f.index],l.specularMapChannel="rgb",l.glossMapChannel="a",o(f,l,["gloss","metalness"])}l.chunks.specularPS=s}else if(e.hasOwnProperty("pbrMetallicRoughness")){var m=e.pbrMetallicRoughness;if(m.hasOwnProperty("baseColorFactor")?(i=m.baseColorFactor,l.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),l.opacity=i[3]):(l.diffuse.set(1,1,1),l.opacity=1),m.hasOwnProperty("baseColorTexture")){var v=m.baseColorTexture;n=t[v.index],l.diffuseMap=n,l.diffuseMapChannel="rgb",l.opacityMap=n,l.opacityMapChannel="a",o(v,l,["diffuse","opacity"])}if(l.useMetalness=!0,m.hasOwnProperty("metallicFactor")?l.metalness=m.metallicFactor:l.metalness=1,m.hasOwnProperty("roughnessFactor")?l.shininess=100*m.roughnessFactor:l.shininess=100,m.hasOwnProperty("metallicRoughnessTexture")){var g=m.metallicRoughnessTexture;l.metalnessMap=l.glossMap=t[g.index],l.metalnessMapChannel="b",l.glossMapChannel="g",o(g,l,["gloss","metalness"])}l.chunks.glossPS=a}if(e.hasOwnProperty("normalTexture")){var _=e.normalTexture;l.normalMap=t[_.index],o(_,l,["normal"]),_.hasOwnProperty("scale")&&(l.bumpiness=_.scale)}if(e.hasOwnProperty("occlusionTexture")){var y=e.occlusionTexture;l.aoMap=t[y.index],l.aoMapChannel="r",o(y,l,["ao"])}if(e.hasOwnProperty("emissiveFactor")?(i=e.emissiveFactor,l.emissive.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),l.emissiveTint=!0):(l.emissive.set(0,0,0),l.emissiveTint=!1),e.hasOwnProperty("emissiveTexture")){var b=e.emissiveTexture;l.emissiveMap=t[b.index],o(b,l,["emissive"])}if(e.hasOwnProperty("alphaMode"))switch(e.alphaMode){case"MASK":l.blendType=3,e.hasOwnProperty("alphaCutoff")?l.alphaTest=e.alphaCutoff:l.alphaTest=.5;break;case"BLEND":l.blendType=2;break;default:case"OPAQUE":l.blendType=3}else l.blendType=3;if(e.hasOwnProperty("doubleSided")?(l.twoSidedLighting=e.doubleSided,l.cull=e.doubleSided?0:1):(l.twoSidedLighting=!1,l.cull=1),e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_materials_clearcoat")){var x=e.extensions.KHR_materials_clearcoat;if(x.hasOwnProperty("clearcoatFactor")?l.clearCoat=.25*x.clearcoatFactor:l.clearCoat=0,x.hasOwnProperty("clearcoatTexture")){var M=x.clearcoatTexture;l.clearCoatMap=t[M.index],l.clearCoatMapChannel="r",o(M,l,["clearCoat"])}if(x.hasOwnProperty("clearcoatRoughnessFactor")?l.clearCoatGlossiness=x.clearcoatRoughnessFactor:l.clearCoatGlossiness=0,x.hasOwnProperty("clearcoatRoughnessTexture")){var S=x.clearcoatRoughnessTexture;l.clearCoatGlossMap=t[S.index],l.clearCoatGlossMapChannel="g",o(S,l,["clearCoatGloss"])}if(x.hasOwnProperty("clearcoatNormalTexture")){var w=x.clearcoatNormalTexture;l.clearCoatNormalMap=t[w.index],o(w,l,["clearCoatNormal"]),w.hasOwnProperty("scale")&&(l.clearCoatBumpiness=w.scale)}l.chunks.clearCoatGlossPS=r}return e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_materials_unlit")&&(l.useLighting=!1,l.emissive.copy(l.diffuse),l.emissiveTint=l.diffuseTint,l.emissiveMap=l.diffuseMap,l.emissiveMapUv=l.diffuseMapUv,l.emissiveMapTiling.copy(l.diffuseMapTiling),l.emissiveMapOffset.copy(l.diffuseMapOffset),l.emissiveMapChannel=l.diffuseMapChannel,l.emissiveVertexColor=l.diffuseVertexColor,l.emissiveVertexColorChannel=l.diffuseVertexColorChannel,l.diffuse.set(0,0,0),l.diffuseTint=!1,l.diffuseMap=null,l.diffuseVertexColor=!1),l.update(),l},ho=function(e,t){var i=new mn;if(e.hasOwnProperty("name")&&0<e.name.length?i.name=e.name:i.name="node_"+t,e.hasOwnProperty("matrix")&&(ro.data.set(e.matrix),ro.getTranslation(oo),i.setLocalPosition(oo),ro.getEulerAngles(oo),i.setLocalEulerAngles(oo),ro.getScale(oo),i.setLocalScale(oo)),e.hasOwnProperty("rotation")){var n=e.rotation;i.setLocalRotation(n[0],n[1],n[2],n[3])}if(e.hasOwnProperty("translation")){var a=e.translation;i.setLocalPosition(a[0],a[1],a[2])}if(e.hasOwnProperty("scale")){var s=e.scale;i.setLocalScale(s[0],s[1],s[2])}return i},co=function(e,t){var i={type:"point"===e.type?"omni":e.type,color:e.hasOwnProperty("color")?new $(e.color):$.WHITE,range:e.hasOwnProperty("range")?e.range:Number.MAX_VALUE,falloffMode:1,intensity:e.hasOwnProperty("intensity")?Se.clamp(e.intensity,0,2):1};e.hasOwnProperty("spot")&&(i.innerConeAngle=e.spot.hasOwnProperty("innerConeAngle")?e.spot.innerConeAngle*Se.RAD_TO_DEG:0,i.outerConeAngle=e.spot.hasOwnProperty("outerConeAngle")?e.spot.outerConeAngle*Se.RAD_TO_DEG:Math.PI/4);var n=new Cr(t.name);return n.rotateLocal(90,0,0),n.addComponent("light",i),n},uo=function(e,t,i,n,a,s){var r,o,l=a&&a.global&&a.global.preprocess,h=a&&a.global&&a.global.postprocess;l&&l(t);for(var c=function(e,t){if(!e.hasOwnProperty("nodes")||0===e.nodes.length)return[];for(var n=t&&t.node&&t.node.preprocess,a=t&&t.node&&t.node.process||ho,s=t&&t.node&&t.node.postprocess,i=e.nodes.map(function(e,t){n&&n(e);var i=a(e,t);return s&&s(e,i),i}),r=0;r<e.nodes.length;++r){var o=e.nodes[r];if(o.hasOwnProperty("children"))for(var l=0;l<o.children.length;++l){var h=i[r],c=i[o.children[l]];c.parent||h.addChild(c)}}return i}(t,a),u=function(e,t){var i=[],n=e.scenes.length;if(1===n&&1===e.scenes[0].nodes.length){var a=e.scenes[0].nodes[0];i.push(t[a])}else for(var s=0;s<n;s++){for(var r=e.scenes[s],o=new mn(r.name),l=0;l<r.nodes.length;l++){var h=t[r.nodes[l]];o.addChild(h)}i.push(o)}return i}(t,c),d=function(e,s,t){var r=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("lights")){var o=e.extensions.KHR_lights_punctual.lights;if(o.length){var l=t&&t.light&&t.light.preprocess,h=t&&t.light&&t.light.process||co,c=t&&t.light&&t.light.postprocess;e.nodes.forEach(function(e,t){if(e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("light")){var i=e.extensions.KHR_lights_punctual.light,n=o[i];if(n){l&&l(n);var a=h(n,s[t]);c&&c(n,a),a&&(r||(r=new Map),r.set(e,a))}}})}}return r}(t,c,a),p=function(n,a,s,e){if(!n.hasOwnProperty("animations")||0===n.animations.length)return[];var r=e&&e.animation&&e.animation.preprocess,o=e&&e.animation&&e.animation.postprocess;return n.animations.map(function(e,t){r&&r(e);var i=function(e,t,i,n,a){var s,r=function(e){var t=no(e,n);return new Tr(Jr(e.type),new t.constructor(t))},o={STEP:0,LINEAR:1,CUBICSPLINE:2},l={},h=[],c={},u=[],d=[];for(s=0;s<e.samplers.length;++s){var p=e.samplers[s];l.hasOwnProperty(p.input)||(l[p.input]=h.length,h.push(r(i[p.input]))),c.hasOwnProperty(p.output)||(c[p.output]=u.length,u.push(r(i[p.output])));var f=p.hasOwnProperty("interpolation")&&o.hasOwnProperty(p.interpolation)?o[p.interpolation]:1;d.push(new Pr([],l[p.input],c[p.output],f))}var m=[],v={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"};for(s=0;s<e.channels.length;++s){var g=e.channels[s],_=g.target,y=d[g.sampler],b=a[_.node],x=[a[0].name].concat(Rr.splitPath(b.path,"/"));y._paths.push({entityPath:x,component:"graph",propertyPath:[v[_.path]]}),_.path.startsWith("rotation")&&2!==y.interpolation?m.push(y.output):_.path.startsWith("weights")&&(u[y.output]._components=u[y.output].data.length/h[y.input].data.length)}m.sort();var M,S=null;for(s=0;s<m.length;++s){var w=m[s];if(0===s||w!==S){if(4===(M=u[w]).components)for(var C=M.data,P=C.length-4,T=0;T<P;T+=4)C[T+0]*C[T+4]+C[T+1]*C[T+5]+C[T+2]*C[T+6]+C[T+3]*C[T+7]<0&&(C[T+4]*=-1,C[T+5]*=-1,C[T+6]*=-1,C[T+7]*=-1);S=w}}var A=0;for(s=0;s<h.length;s++)M=h[s]._data,A=Math.max(A,0===M.length?0:M[M.length-1]);return new Er(e.hasOwnProperty("name")?e.name:"animation_"+t,A,h,u,d)}(e,t,n.accessors,s,a);return o&&o(e,i),i})}(t,c,i,a),f=function(e,i,t,n){if(!e.hasOwnProperty("materials")||0===e.materials.length)return[];var a=t&&t.material&&t.material.preprocess,s=t&&t.material&&t.material.process||lo,r=t&&t.material&&t.material.postprocess;return e.materials.map(function(e){a&&a(e);var t=s(e,i,!1);return r&&r(e,t),t})}(t,n.map(function(e){return e.resource}),a),m=function(t,i,n,a,e){if(!i.hasOwnProperty("meshes")||0===i.meshes.length||!i.hasOwnProperty("accessors")||0===i.accessors.length||!i.hasOwnProperty("bufferViews")||0===i.bufferViews.length)return[];var s={};return i.meshes.map(function(e){return T=t,A=e,E=i.accessors,R=n,D=a,I=!1,k=s,L=[],A.primitives.forEach(function(e){var t,i,n,a=null,s=!0;if(e.hasOwnProperty("extensions")){var r=e.extensions;if(r.hasOwnProperty("KHR_draco_mesh_compression")){var o=window.DracoDecoderModule;if(o){var l=r.KHR_draco_mesh_compression;if(l.hasOwnProperty("attributes")){var h=R[l.bufferView],c=new o.DecoderBuffer;c.Init(h,h.length);var u,d,p=new o.Decoder,f=p.GetEncodedGeometryType(c);switch(f){case o.POINT_CLOUD:t=0,u=new o.PointCloud,d=p.DecodeBufferToPointCloud(c,u);break;case o.TRIANGULAR_MESH:t=4,u=new o.Mesh,d=p.DecodeBufferToMesh(c,u);break;case o.INVALID_GEOMETRY_TYPE:}if(!d||!d.ok()||0==u.ptr)return void D("Failed to decode draco compressed asset: "+(d?d.error_msg():"Mesh asset - invalid draco compressed geometry type: "+f));var m=u.num_faces();if(f===o.TRIANGULAR_MESH){var v=65535<u.num_points(),g=(n=3*m)*(v?4:2),_=o._malloc(g);v?(p.GetTrianglesUInt32Array(u,g,_),a=new Uint32Array(o.HEAPU32.buffer,_,n).slice()):(p.GetTrianglesUInt16Array(u,g,_),a=new Uint16Array(o.HEAPU16.buffer,_,n).slice()),o._free(_)}i=function(e,o,t,l,h,i,n){var c=o.num_points(),a=function(e){var t,i,n,a,s=l.GetAttributeByUniqueId(o,e),r=c*s.num_components();switch(s.data_type()){case h.DT_UINT8:n=a=1,t=h._malloc(r*n),l.GetAttributeDataArrayForAllPoints(o,s,h.DT_UINT8,r*n,t),i=new Uint8Array(h.HEAPU8.buffer,t,r).slice();break;case h.DT_UINT16:a=3,n=2,t=h._malloc(r*n),l.GetAttributeDataArrayForAllPoints(o,s,h.DT_UINT16,r*n,t),i=new Uint16Array(h.HEAPU16.buffer,t,r).slice();break;case h.DT_FLOAT32:default:a=6,n=4,t=h._malloc(r*n),l.GetAttributeDataArrayForAllPoints(o,s,h.DT_FLOAT32,r*n,t),i=new Float32Array(h.HEAPF32.buffer,t,r).slice()}return h._free(t),{values:i,numComponents:s.num_components(),componentSizeInBytes:n,storageType:a,normalized:s.normalized()}},s={},r=t.attributes;for(var u in r)if(r.hasOwnProperty(u)&&io.hasOwnProperty(u)){var d=io[u],p=a(r[u]),f=p.numComponents*p.componentSizeInBytes;s[d]={values:p.values,buffer:p.values.buffer,size:f,offset:0,stride:f,count:c,components:p.numComponents,type:p.storageType,normalize:p.normalized}}return s.hasOwnProperty(Ae)||ao(s,i),so(e,s,n)}(T,u,l,p,o,a,I),o.destroy(u),o.destroy(p),o.destroy(c),s=!1}}}}i||(a=e.hasOwnProperty("indices")?no(E[e.indices],R):null,i=function(e,t,i,n,a,s,r){var o={},l=[];for(var h in t)t.hasOwnProperty(h)&&io.hasOwnProperty(h)&&(o[h]=t[h],l.push(h+":"+t[h]));l.sort();var c=l.join(),u=r[c];if(!u){var d={};for(var p in o){var f=n[t[p]],m=no(f,a),v=a[f.bufferView],g=io[p],_=Jr(f.type)*to(f.componentType),y=v.hasOwnProperty("byteStride")?v.byteStride:_;d[g]={buffer:m.buffer,size:_,offset:m.byteOffset,stride:y,count:f.count,components:Jr(f.type),type:eo(f.componentType),normalize:f.normalized}}d.hasOwnProperty(Ae)||ao(d,i),u=so(e,d,s),r[c]=u}return u}(T,e.attributes,a,E,R,I,k),t=function(e){if(!e.hasOwnProperty("mode"))return 4;switch(e.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6;default:return 4}}(e));var y=null;if(i){if((y=new Zi(T)).vertexBuffer=i,y.primitive[0].type=t,y.primitive[0].base=0,y.primitive[0].indexed=null!==a,null!==a){var b;2!=(b=a instanceof Uint8Array?0:a instanceof Uint16Array?1:2)||T.extUintElement||(b=1,a=new Uint16Array(a));var x=new qi(T,b,a.length,0,a);y.indexBuffer[0]=x,y.primitive[0].count=a.length}else y.primitive[0].count=i.numVertices;y.materialIndex=e.material;var M=E[e.attributes.POSITION],S=M.min,w=M.max,C=new ue(new de((w[0]+S[0])/2,(w[1]+S[1])/2,(w[2]+S[2])/2),new de((w[0]-S[0])/2,(w[1]-S[1])/2,(w[2]-S[2])/2));if(y.aabb=C,s&&e.hasOwnProperty("targets")){var P=[];e.targets.forEach(function(e,t){var i={};e.hasOwnProperty("POSITION")&&(M=E[e.POSITION],i.deltaPositions=no(M,R),i.deltaPositionsType=eo(M.componentType),M.hasOwnProperty("min")&&M.hasOwnProperty("max")&&(i.aabb=new ue,i.aabb.setMinMax(new de(M.min),new de(M.max)))),e.hasOwnProperty("NORMAL")&&(M=E[e.NORMAL],i.deltaNormals=no(M,R),i.deltaNormalsType=eo(M.componentType)),A.hasOwnProperty("extras")&&A.extras.hasOwnProperty("targetNames")?i.name=A.extras.targetNames[t]:i.name=t.toString(10),A.hasOwnProperty("weights")&&(i.defaultWeight=A.weights[t]),P.push(new Mr(i))}),y.morph=new ar(P,T)}}L.push(y)}),L;var T,A,E,R,D,I,k,L})}(e,t,i,s),v=function(t,i,n,a){if(!i.hasOwnProperty("skins")||0===i.skins.length)return[];var s=new Map;return i.skins.map(function(e){return function(e,t,i,n,a,s){var r,o,l,h=t.joints,c=h.length,u=[];if(t.hasOwnProperty("inverseBindMatrices")){var d=t.inverseBindMatrices,p=no(i[d],n),f=[];for(r=0;r<c;r++){for(o=0;o<16;o++)f[o]=p[16*r+o];(l=new pe).set(f),u.push(l)}}else for(r=0;r<c;r++)l=new pe,u.push(l);var m=[];for(r=0;r<c;r++)m[r]=a[h[r]].name;var v=m.join("#"),g=s.get(v);return g||(g=new Sr(e,u,m),s.set(v,g)),g}(t,e,i.accessors,a,n,s)})}(e,t,c,i),g=[],_=0;_<m.length;_++)g[_]=new wr,g[_].meshes=m[_];r=g,o=v,t.nodes.forEach(function(t){t.hasOwnProperty("mesh")&&t.hasOwnProperty("skin")&&r[t.mesh].meshes.forEach(function(e){e.skin=o[t.skin]})});var y=new Zr(t);y.nodes=c,y.scenes=u,y.animations=p,y.textures=n,y.materials=f,y.renders=g,y.skins=v,y.lights=d,h&&h(t,y),s(null,y)},po=function(e,n,t){var i=JSON.parse(function(e){if("undefined"!=typeof TextDecoder)return n?fo((new TextDecoder).decode(e)):(new TextDecoder).decode(e);for(var t="",i=0;i<e.length;i++)t+=String.fromCharCode(e[i]);return n?fo(decodeURIComponent(escape(t))):decodeURIComponent(escape(t))}(e));i.asset&&i.asset.version&&parseFloat(i.asset.version)<2?t("Invalid gltf version. Expected version 2.0 or above but found version '"+i.asset.version+"'."):t(null,i)},fo=function(e){var t=window.atob(e);return t=escape(t),decodeURIComponent(t)},mo=function(e,t,i){e&&C.getExtension(e).toLowerCase()===Ur?function(e,t){var i=new DataView(e),n=i.getUint32(0,!0),a=i.getUint32(4,!0),s=i.getUint32(8,!0);if(1179937895===n)if(2===a)if(s<=0||s>e.byteLength)t("Invalid length found in glb header. Found "+s);else{for(var r=[],o=12;o<s;){var l=i.getUint32(o,!0);if(o+l+8>e.byteLength)throw new Error("Invalid chunk length found in glb. Found "+l);var h=i.getUint32(o+4,!0),c=new Uint8Array(e,o+8,l);r.push({length:l,type:h,data:c}),o+=l+8}1===r.length||2===r.length?1313821514===r[0].type?1<r.length&&5130562!==r[1].type?t("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+r[1].type.toString(16)):t(null,{gltfChunk:r[0].data,gltfDecode:!1,binaryChunk:2===r.length?r[1].data:null}):t("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+r[0].type.toString(16)):t("Invalid number of chunks found in glb file.")}else t("Invalid version number found in glb header. Expected 2, found "+a);else t("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+n.toString(16))}(t,i):e&&C.getExtension(e).toLowerCase()===Nr?function(e,t){var i=new DataView(e),n=i.getUint32(0,!0),a=i.getUint32(4,!0),s=i.getUint32(8,!0),r=i.getUint32(12,!0);if(1818322258===n||2020565609===a)if(1===s)if(r<=0||r>e.byteLength)t("Invalid length found in glb header. Found "+r);else{for(var o=[],l=16;l<r;){var h=i.getUint32(l,!0);if(l+h+8>e.byteLength)throw new Error("Invalid chunk length found in glb. Found "+h);var c=i.getUint32(l+4,!0),u=new Uint8Array(e,l+8,h);o.push({length:h,type:c,data:u}),l+=h+8}1===o.length||2===o.length?1313821514===o[0].type?1<o.length&&5130562!==o[1].type?t("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+o[1].type.toString(16)):t(null,{gltfChunk:o[0].data,gltfDecode:!0,binaryChunk:2===o.length?o[1].data:null}):t("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+o[0].type.toString(16)):t("Invalid number of chunks found in glb file.")}else t("Invalid version number found in glb header. Expected 2, found "+s)}(t,i):i(null,{gltfChunk:t,gltfDecode:!1,binaryChunk:null})},vo=function(n,r,e,o){var a=[],t=e&&e.bufferView&&e.bufferView.preprocess,i=e&&e.bufferView&&e.bufferView.processAsync||function(e,t,i){i(null,null)},s=e&&e.bufferView&&e.bufferView.postprocess,l=n.bufferViews?n.bufferViews.length:0;if(l)for(var h=function(e,t){var i=n.bufferViews[e];i.hasOwnProperty("byteStride")&&(t.byteStride=i.byteStride),a[e]=t,s&&s(i,t),0==--l&&o(null,a)},c=0;c<n.bufferViews.length;++c){var u=n.bufferViews[c];t&&t(u),i(u,r,function(e,t,i,n){if(i)o(i);else if(n)h(e,n);else{var a=r[t.buffer],s=new Uint8Array(a.buffer,a.byteOffset+(t.byteOffset||0),t.byteLength);h(e,s)}}.bind(null,c,u))}else o(null,null)},go=function(){function e(){}return e.parseAsync=function(e,a,t,s,r,o,l){mo(e,t,function(e,t){e?l(e):po(t.gltfChunk,t.gltfDecode,function(e,n){e?l(e):function(i,o,l,e,h){var n=[];if(i.buffers&&0!==i.buffers.length)for(var t=e&&e.buffer&&e.buffer.preprocess,a=e&&e.buffer&&e.buffer.processAsync||function(e,t){t(null,null)},s=e&&e.buffer&&e.buffer.postprocess,r=i.buffers.length,c=function(e,t){n[e]=t,s&&s(i.buffers[e],t),0==--r&&h(null,n)},u=0;u<i.buffers.length;++u){var d=i.buffers[u];t&&t(d),a(d,function(e,t,i,n){if(i)h(i);else if(n)c(e,new Uint8Array(n));else if(t.hasOwnProperty("uri"))if(Qr(t.uri)){for(var a=atob(t.uri.split(",")[1]),s=new Uint8Array(a.length),r=0;r<a.length;r++)s[r]=a.charCodeAt(r);c(e,s)}else q.get(C.join(l,t.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(e,t,i){t?h(t):c(e,new Uint8Array(i))}.bind(null,e));else c(e,o)}.bind(null,u,d))}else h(null,n)}(n,t.binaryChunk,a,o,function(e,t){e?l(e):vo(n,t,o,function(e,i){e?l(e):function(g,_,y,b,x,M){if(g.hasOwnProperty("images")&&0!==g.images.length&&g.hasOwnProperty("textures")&&0!==g.textures.length)for(var e=x&&x.texture&&x.texture.preprocess,t=x&&x.texture&&x.texture.processAsync||function(e,t,i){i(null,null)},p=x&&x.texture&&x.texture.postprocess,S=[],i=[],n=g.textures.length,w=function(e,t){if(i[t]||(i[t]=[]),i[t].push(e),0==--n){var d=[];i.forEach(function(e,u){e.forEach(function(e,t){var i,n,a,s,r,o,l,h,c=0===t?S[u]:(r=S[u],(h=new Kr(r.name+"_clone",r.type,r.file,r.data,r.options)).loaded=!0,h.resource=(o=r.resource,(l=new Kt(o.device,o))._levels=function(e){for(var t=[],i=0;i<e._levels.length;++i){var n=[];if(e.cubemap)for(var a=0;a<6;++a)n.push(e._levels[i][a]);else n=e._levels[i];t.push(n)}return t}(o),l),r.registry.add(h),h);i=c.resource,n=(g.samplers||[])[g.textures[e].sampler],a=function(e,t){switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return t}},s=function(e,t){switch(e){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return t}},i&&(n=n||{},i.minFilter=a(n.minFilter,5),i.magFilter=a(n.magFilter,1),i.addressU=s(n.wrapS,0),i.addressV=s(n.wrapT,0)),d[e]=c,p&&p(g.textures[e],c)})}),M(null,d)}},a=0;a<g.textures.length;++a){var s=g.textures[a];e&&e(s),t(s,g.images,function(i,e,t,n){if(t)M(t);else if(null==n&&(n=e.source),S[n])w(i,n);else{var a=g.images[n];s=a,o=i,r=_,l=y,h=b,u=function(e,t){e?M(e):(S[n]=t,w(i,n))},d=(c=x)&&c.image&&c.image.preprocess,p=c&&c.image&&c.image.processAsync||function(e,t){t(null,null)},f=c&&c.image&&c.image.postprocess,m=function(e){f&&f(s,e),u(null,e)},v=function(e,t,i,n){var a={url:e};if(t){var s={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/vnd-ms.dds":"dds"}[t];s&&(a.filename="glb-texture-"+o+"."+s)}var r=new Kr("texture_"+o,"texture",a,null,{crossOrigin:i});r.on("load",function(){n&&URL.revokeObjectURL(e),m(r)}),r.on("error",function(e,t){u(e)}),h.add(r),h.load(r)},d&&d(s),p(s,function(e,t){if(e)u(e);else if(t)m(t);else if(s.hasOwnProperty("uri"))Qr(s.uri)?v(s.uri,(n=s.uri).substring(n.indexOf(":")+1,n.indexOf(";"))):v(C.join(l,s.uri),null,"anonymous");else if(s.hasOwnProperty("bufferView")&&s.hasOwnProperty("mimeType")){var i=new Blob([r[s.bufferView]],{type:s.mimeType});v(URL.createObjectURL(i),s.mimeType,null,!0)}else u("Invalid image found in gltf (neither uri or bufferView found). index="+o);var n})}var s,o,r,l,h,c,u,d,p,f,m,v}.bind(null,a,s))}else M(null,[])}(n,i,a,r,o,function(e,t){e?l(e):uo(s,n,i,t,o,l)})})})})})},e.parse=function(e,t,n,a){var s=null;return a=a||{},mo(e,t,function(e,t){e||po(t.gltfChunk,t.gltfDecode,function(e,i){e||vo(i,[t.binaryChunk],a,function(e,t){e||uo(n,i,t,[],a,function(e,t){e||(s=t)})})})}),s},e}(),_o=function(){function e(){this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i});var e={retry:0<this.maxRetries,maxRetries:this.maxRetries};(i.load.startsWith("blob:")||i.load.startsWith("data:"))&&(".glb"===C.getExtension(i.original).toLowerCase()?e.responseType=X.ResponseType.ARRAY_BUFFER:e.responseType=X.ResponseType.JSON),q.get(i.load,e,function(e,t){e?n("Error loading animation resource: "+i.original+" ["+e+"]"):n(null,t)})},t.open=function(e,t){if(".glb"===C.getExtension(e).toLowerCase()){var i=go.parse("filename.glb",t,null);if(i){var n=i.animations;return i.destroy(),n}return null}return this["_parseAnimationV"+t.animation.version](t)},t._parseAnimationV3=function(e){var t=e.animation,i=new xr;i.name=t.name,i.duration=t.duration;for(var n=0;n<t.nodes.length;n++){var a=new br,s=t.nodes[n];a._name=s.name;for(var r=0;r<s.keys.length;r++){var o=s.keys[r],l=o.time,h=o.pos,c=o.rot,u=o.scale,d=new de(h[0],h[1],h[2]),p=(new fe).setFromEulerAngles(c[0],c[1],c[2]),f=new de(u[0],u[1],u[2]),m=new yr(l,d,p,f);a._keys.push(m)}i.addNode(a)}return i},t._parseAnimationV4=function(e){var t=e.animation,i=new xr;i.name=t.name,i.duration=t.duration;for(var n=0;n<t.nodes.length;n++){var a=new br,s=t.nodes[n];a._name=s.name;for(var r=s.defaults.p,o=s.defaults.r,l=s.defaults.s,h=0;h<s.keys.length;h++){var c=s.keys[h],u=c.t,d=r||c.p,p=o||c.r,f=l||c.s,m=new de(d[0],d[1],d[2]),v=(new fe).setFromEulerAngles(p[0],p[1],p[2]),g=new de(f[0],f[1],f[2]),_=new yr(u,m,v,g);a._keys.push(_)}i.addNode(a)}return i},e}(),yo=function(){function e(){this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i});var e={retry:0<this.maxRetries,maxRetries:this.maxRetries};i.load.startsWith("blob:")&&(e.responseType=X.ResponseType.JSON),q.get(i.load,e,function(e,t){e?n("Error loading animation clip resource: "+i.original+" ["+e+"]"):n(null,t)})},t.open=function(e,t){var i=t.name,n=t.duration,a=t.inputs.map(function(e){return new Tr(1,e)}),s=t.outputs.map(function(e){return new Tr(e.components,e.data)}),r=t.curves.map(function(e){return new Pr([e.path],e.inputIndex,e.outputIndex,e.interpolation)});return new Er(i,n,a,s,r)},e}(),bo=function(){function e(e){var t;if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(var i in e.layers){var n=e.layers[i],a={name:n.name,states:[],transitions:[]};for(t=0;t<n.states.length;t++)a.states.push(e.states[n.states[t]]);for(t=0;t<n.transitions.length;t++){var s=e.transitions[n.transitions[t]];if(s.conditions&&!Array.isArray(s.conditions)){for(var r=Object.keys(s.conditions),o=[],l=0;l<r.length;l++){var h=s.conditions[r[l]];h.parameterName&&o.push(h)}s.conditions=o}Number.isInteger(s.from)&&(s.from=e.states[s.from].name),Number.isInteger(s.to)&&(s.to=e.states[s.to].name),a.transitions.push(s)}this._layers.push(a)}for(var c in e.parameters){var u=e.parameters[c];this._parameters[u.name]={type:u.type,value:u.value}}}return c(e,[{key:"parameters",get:function(){return Object.assign({},this._parameters)}},{key:"layers",get:function(){return this._layers}}]),e}(),xo=function(){function e(){this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i});var e={retry:0<this.maxRetries,maxRetries:this.maxRetries};i.load.startsWith("blob:")&&(e.responseType=X.ResponseType.JSON),q.get(i.load,e,function(e,t){e?n("Error loading animation state graph resource: "+i.original+" ["+e+"]"):n(null,t)})},t.open=function(e,t){return new bo(t)},e}(),Mo=function(){function e(e){e instanceof Audio?this.audio=e:this.buffer=e}return c(e,[{key:"duration",get:function(){var e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}}]),e}(),So=function(){if("undefined"==typeof window)return!1;var e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(0<t)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(0<e.indexOf("Trident/")){var i=e.indexOf("rv:");return parseInt(e.substring(i+3,e.indexOf(".",i)),10)}return!1}(),wo={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"},Co=function(){function e(e){this.manager=e,this.maxRetries=0}var t=e.prototype;return t._isSupported=function(e){var t=C.getExtension(e);return!!wo[t]},t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i});var e=function(e){var t="Error loading audio url: "+i.original;e&&(t+=": "+(e.message||e)),n(t)};if(this._createSound){if(!this._isSupported(i.original))return void e("Audio format for "+i.original+" not supported");this._createSound(i.load,function(e){n(null,new Mo(e))},e)}else e(null)},t.open=function(e,t){return t},t._createSound=function(e,i,n){if(cr()){var a=this.manager;if(!a.context)return void n("Audio manager has no audio context");var t={retry:0<this.maxRetries,maxRetries:this.maxRetries};(e.startsWith("blob:")||e.startsWith("data:"))&&(t.responseType=X.ResponseType.ARRAY_BUFFER),q.get(e,t,function(e,t){e?n(e):a.context.decodeAudioData(t,i,n)})}else{var s=null;try{s=new Audio}catch(e){return void n("No support for Audio element")}So&&document.body.appendChild(s),s.onerror=function(){s.onerror=null,So&&document.body.removeChild(s),n()},s.addEventListener("canplaythrough",function e(){s.removeEventListener("canplaythrough",e),So&&document.body.removeChild(s),i(s)}),s.src=e}},e}(),Po=function(){function e(){this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i}),q.get(i.load,{responseType:X.ResponseType.ARRAY_BUFFER,retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,t){e?n("Error loading binary resource: "+i.original+" ["+e+"]"):n(null,t)})},t.open=function(e,t){return t},t.patch=function(e,t){},e}(),To=function(){function e(e){this._blobUrls={};for(var t=0,i=e.length;t<i;t++)e[t].url&&(this._blobUrls[e[t].name]=e[t].url)}var t=e.prototype;return t.hasBlobUrl=function(e){return!!this._blobUrls[e]},t.getBlobUrl=function(e){return this._blobUrls[e]},t.destroy=function(){for(var e in this._blobUrls)URL.revokeObjectURL(this._blobUrls[e]);this._blobUrls=null},e}();function Ao(p){var h,f;function m(e){this._fields=e}function n(e){this._arrayBuffer=e||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._globalPaxHeader=null,this._paxHeader=null,this._bytesRead=0}"undefined"!=typeof TextDecoder&&(h=new TextDecoder("utf-8"),f=new TextDecoder("windows-1252")),m.parse=function(e,t,i){for(var n=new Uint8Array(e,t,i),a=0,s=[];a<i;){var r=void 0;for(r=a;r<i&&32!==n[r];r++);if(i<=r)throw new Error("Invalid PAX header data format.");var o=parseInt(h.decode(new Uint8Array(e,t+a,r-a)),10),l=h.decode(new Uint8Array(e,t+r+1,o-(r-a)-2)).split("=");if(2!==l.length)throw new Error("Invalid PAX header data format.");0===l[1].length&&(l[1]=null),s.push({name:l[0],value:l[1]}),a+=o}return new m(s)},m.prototype.applyHeader=function(e){for(var t=0;t<this._fields.length;t++){var i=this._fields[t].name,n=this._fields[t].value;"path"===i&&(i="name"),null===n?delete e[i]:e[i]=n}},p||(Xr=n),n.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)},n.prototype._readNextFile=function(){var e=new DataView(this._arrayBuffer,this._bytesRead,512),t=f.decode(e);this._bytesRead+=512;var i=t.substr(0,100).replace(/\0/g,""),n=t.substr(257,6),a=parseInt(t.substr(124,12),8),s=t.substr(156,1),r=this._bytesRead,o=null,l=!1;switch(s){case"0":case"":if(l=!0,!p){var h=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+a)]);o=URL.createObjectURL(h)}break;case"g":this._globalPaxHeader=m.parse(this._arrayBuffer,this._bytesRead,a);break;case"x":this._paxHeader=m.parse(this._arrayBuffer,this._bytesRead,a)}this._bytesRead+=a;var c=a%512;if(0!==c&&(this._bytesRead+=512-c),!l)return null;if(-1!==n.indexOf("ustar")){var u=t.substr(345,155).replace(/\0/g,"");0<u.length&&(i=u.trim()+i.trim())}var d={name:i,start:r,size:a,url:o};return this._globalPaxHeader&&this._globalPaxHeader.applyHeader(d),this._paxHeader&&(this._paxHeader.applyHeader(d),this._paxHeader=null),d},n.prototype.untar=function(e){if(!h)return[];for(var t=[];this._hasNext();){var i=this._readNextFile();i&&(e&&i.name&&(i.name=e+i.name),t.push(i))}return t},p&&(self.onmessage=function(e){var t=e.data.id;try{var i=new n(e.data.arrayBuffer).untar(e.data.prefix);postMessage({id:t,files:i,arrayBuffer:e.data.arrayBuffer},[e.data.arrayBuffer])}catch(e){postMessage({id:t,error:e.toString()})}})}var Eo=null,Ro=function(){function e(e){this._requestId=0,this._pendingRequests={},this._filenamePrefix=e,this._worker=new Worker(function(){if(!Eo){var e="("+Ao.toString()+")(true)\n\n",t=new Blob([e],{type:"application/javascript"});Eo=URL.createObjectURL(t)}return Eo}()),this._worker.addEventListener("message",this._onMessage.bind(this))}var t=e.prototype;return t._onMessage=function(e){var t=e.data.id;if(this._pendingRequests[t]){var i=this._pendingRequests[t];if(delete this._pendingRequests[t],e.data.error)i(e.data.error);else{for(var n=e.data.arrayBuffer,a=0,s=e.data.files.length;a<s;a++){var r=e.data.files[a],o=new Blob([n.slice(r.start,r.start+r.size)]);r.url=URL.createObjectURL(o)}i(null,e.data.files)}}},t.untar=function(e,t){var i=this._requestId++;this._pendingRequests[i]=t,this._worker.postMessage({id:i,prefix:this._filenamePrefix,arrayBuffer:e},[e])},t.hasPendingRequests=function(){for(var e in this._pendingRequests)return!0;return!1},t.destroy=function(){this._worker&&(this._worker.terminate(),this._worker=null,this._pendingRequests=null)},e}();Ao();var Do=function(){function e(e){this._assets=e,this._worker=null,this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i});var a=this;q.get(i.load,{responseType:X.ResponseType.ARRAY_BUFFER,retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,t){if(e)n("Error loading bundle resource "+i.original+": "+e);else try{a._untar(t,n)}catch(e){n("Error loading bundle resource "+i.original+": "+e)}})},t._untar=function(e,i){var n=this;if(P)n._worker||(n._worker=new Ro(n._assets.prefix)),n._worker.untar(e,function(e,t){i(e,t),n._worker.hasPendingRequests()||(n._worker.destroy(),n._worker=null)});else{var t=new Xr(e).untar(n._assets.prefix);i(null,t)}},t.open=function(e,t){return new To(t)},t.patch=function(e,t){},e}(),Io=function(n){function e(e,t){var i;return(i=n.call(this)||this).skin=e,i.skinInstance=t,i}return u(e,n),e}(Xi),ko=function(){function s(){}return s.createCachedSkinedInstance=function(e,t,i){var n=s.getCachedSkinInstance(e,t);return n||((n=new Tn(e)).resolve(t,i),s.addCachedSkinInstance(e,t,n)),n},s.getCachedSkinInstance=function(t,e){var i=null,n=s._skinInstanceCache.get(e);if(n){var a=n.find(function(e){return e.skin===t});a&&(a.incRefCount(),i=a.skinInstance)}return i},s.addCachedSkinInstance=function(t,e,i){var n=s._skinInstanceCache.get(e);n||(n=[],s._skinInstanceCache.set(e,n));var a=n.find(function(e){return e.skin===t});a||(a=new Io(t,i),n.push(a)),a.incRefCount()},s.removeCachedSkinInstance=function(t){if(t){var e=t.rootBone;if(e){var i=s._skinInstanceCache.get(e);if(i){var n=i.findIndex(function(e){return e.skinInstance===t});if(0<=n){var a=i[n];a.decRefCount(),0===a.getRefCount()&&(i.splice(n,1),i.length||s._skinInstanceCache.delete(e),t&&(t.destroy(),a.skinInstance=null))}}}}},s}();ko._skinInstanceCache=new Map;var Lo=function(){function m(e){this.data=e,this._model=null,this.renders=[],this.materials=[],this.textures=[],this.animations=[],this.registry=null,this._defaultMaterial=null,this._assetName=null,this._assets=null}m.createAsset=function(e,t,i,n){var a=new Kr(e+"/"+t+"/"+n,t,{url:""});return a.resource=i,a.loaded=!0,a};var e=m.prototype;return e.instantiateModelEntity=function(e){var t=new Cr;return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t},e.instantiateRenderEntity=function(S){for(var e,w=this._defaultMaterial,C=[],t=function e(t,i,n){var a,s,r,o,l,h,c,u=new Cr;i._cloneInternal(u),t||(t=u);for(var d=null,p=0;p<n.nodes.length;p++)if(n.nodes[p]===i){var f=n.gltf.nodes[p];if(f.hasOwnProperty("mesh"))for(var m=n.renders[f.mesh].meshes,v=0;v<m.length;v++){var g=m[v];if(g){var _=(a=t,s=u,r=g,o=n.materials,n.skins,l=f,h=(c=void 0)===r.materialIndex?w:o[r.materialIndex],c=new Mn(r,h),r.morph&&(c.morphInstance=new sr(r.morph)),l.hasOwnProperty("skin")&&C.push({meshInstance:c,rootBone:a,entity:s}),c);d||(d=[]),d.push(_)}}if(n.lights){var y=n.lights.get(f);y&&u.addChild(y.clone())}}d&&u.addComponent("render",Object.assign({type:"asset",meshInstances:d},S));for(var b=i.children,x=0;x<b.length;x++){var M=e(t,b[x],n);u.addChild(M)}return u},i=[],n=_(this.data.scenes);!(e=n()).done;){var a=e.value;i.push(t(null,a,this.data))}return C.forEach(function(e){e.meshInstance.skinInstance=ko.createCachedSkinedInstance(e.meshInstance.mesh.skin,e.rootBone,e.entity)}),m.createSceneHierarchy(i,"Entity")},m.createSceneHierarchy=function(e,t){var i=null;if(1===e.length)i=e[0];else{i=new t("SceneGroup");for(var n,a=_(e);!(n=a()).done;){var s=n.value;i.addChild(s)}}return i},m.createModel=function(e,p){for(var t,i=function(e,t,i,n,a,s,r){var o=void 0===t.materialIndex?p:a[t.materialIndex],l=new Mn(t,o,s);if(l.index=e.meshInstances.length,t.morph){var h=new sr(t.morph);l.morphInstance=h,e.morphInstances.push(h)}if(r.hasOwnProperty("skin")){var c=r.skin,u=i[c];t.skin=u;var d=n[c];l.skinInstance=d,e.skinInstances.push(d)}e.meshInstances.push(l)},n=new rr,a=[],s=_(e.skins);!(t=s()).done;){var r=t.value,o=new Tn(r);o.bones=r.bones,a.push(o)}n.graph=m.createSceneHierarchy(e.scenes,"GraphNode");for(var l=0;l<e.nodes.length;l++){var h=e.nodes[l];if(h.root===n.graph){var c=e.gltf.nodes[l];if(c.hasOwnProperty("mesh"))for(var u=e.renders[c.mesh].meshes,d=0;d<u.length;d++){var f=u[d];f&&i(n,f,e.skins,a,e.materials,h,c)}}}return n},e.destroy=function(){var t=this.registry,i=function(e){t.remove(e),e.unload()},e=function(e){e.forEach(function(e){i(e)})};this.animations&&(e(this.animations),this.animations=null),this.textures&&(e(this.textures),this.textures=null),this.materials&&(e(this.materials),this.materials=null),this.renders&&(e(this.renders),this.renders=null),this._model&&(i(this._model),this._model=null),this.data=null,this.assets=null},c(m,[{key:"model",get:function(){if(!this._model){var e=m.createModel(this.data,this._defaultMaterial),t=m.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t}return this._model}}]),m}(),Oo=function(){function e(e,t){this._device=e,this._defaultMaterial=t,this.maxRetries=0}var t=e.prototype;return t._getUrlWithoutParams=function(e){return 0<=e.indexOf("?")?e.split("?")[0]:e},t.load=function(i,n,t){"string"==typeof i&&(i={load:i,original:i});var e={responseType:X.ResponseType.ARRAY_BUFFER,retry:0<this.maxRetries,maxRetries:this.maxRetries},a=this,s=function(e){go.parseAsync(a._getUrlWithoutParams(i.original),C.extractPath(i.load),e,a._device,t.registry,t.options,function(e,t){e?n(e):n(null,new Lo(t))})};t&&t.file&&t.file.contents?s(t.file.contents):q.get(i.load,e,function(e,t){n&&(e?n("Error loading model: "+i.original+" ["+e+"]"):s(t))})},t.open=function(e,t,i){return t},t.patch=function(a,s){var e=a.resource,t=e&&e.data;if(t){var i,n=function(e,t,i){var n=Lo.createAsset(a.name,e,t,i);return s.add(n),n},r=[];for(i=0;i<t.renders.length;++i)r.push(n("render",t.renders[i],i));var o=[];for(i=0;i<t.materials.length;++i)o.push(n("material",t.materials[i],i));var l=[];for(i=0;i<t.animations.length;++i)l.push(n("animation",t.animations[i],i));e._assetName=a.name,e._assets=s,e.renders=r,e.materials=o,e.textures=t.textures,e.animations=l,e.registry=s,e._defaultMaterial=this._defaultMaterial}},e}(),Fo=function(){function e(){this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i}),q.get(i.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,t){e?n("Error loading css resource: "+i.original+" ["+e+"]"):n(null,t)})},t.open=function(e,t){return t},t.patch=function(e,t){},e}(),zo=function(){function e(e,t,i){this._device=e,this._registry=t,this._loader=i}var t=e.prototype;return t.load=function(e,t,i){this.loadAssets(i,t)},t.open=function(e,t,i){return i?i.resource:null},t.patch=function(i,n){this.loadAssets(i,function(e,t){e?(n.fire("error",i),n.fire("error:"+i.id,e,i),i.fire("error",i)):(n.fire("change",i),n.fire("change:"+i.id,i),i.fire("change",i))})},t.getAssetIds=function(e){var t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(var i=0;i<6;++i)t[i+1]=e.data.textures[i];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t},t.compareAssetIds=function(e,t){return e&&t?parseInt(e,10)===e||"string"==typeof e?e===t:e.url===t.url:null!==e==(null!==t)},t.update=function(e,t,i){var n,a,s,r=e.data||{},o=e._handlerState.assets,l=e._resources,h=[null,null,null,null,null,null,null],c=function(){return r.hasOwnProperty("type")?r.type:r.hasOwnProperty("rgbm")?r.rgbm?Qe:Ze:null};if(e.loaded&&i[0]===o[0])h[1]=l[1]||null,h[2]=l[2]||null,h[3]=l[3]||null,h[4]=l[4]||null,h[5]=l[5]||null,h[6]=l[6]||null;else if(i[0])for(n=i[0].resource,s=0;s<6;++s){var u=[n._levels[s]];if(0===s&&this._device.useTexCubeLod)for(a=1;a<n._levels.length;++a)u[a]=n._levels[a];var d=new Kt(this._device,{name:e.name+"_prelitCubemap"+(n.width>>s),cubemap:!0,type:c()||n.type,width:n.width>>s,height:n.height>>s,format:n.format,levels:u,fixCubemapSeams:!0,addressU:1,addressV:1});h[s+1]=d}var p=i.slice(1);if(e.loaded&&this.cmpArrays(p,o.slice(1)))h[0]=l[0]||null;else if(-1===p.indexOf(null)){var f=p.map(function(e){return e.resource}),m=[];for(a=0;a<f[0]._levels.length;++a)m.push(f.map(function(e){return e._levels[a]}));var v=new Kt(this._device,{name:e.name+"_faces",cubemap:!0,type:c()||f[0].type,width:f[0].width,height:f[0].height,format:f[0].format,levels:m,minFilter:r.hasOwnProperty("minFilter")?r.minFilter:f[0].minFilter,magFilter:r.hasOwnProperty("magFilter")?r.magFilter:f[0].magFilter,addressU:1,addressV:1,fixCubemapSeams:!!i[0]});h[0]=v}if(!this.cmpArrays(h,l))for(e.resources=h,e._handlerState.assetIds=t,e._handlerState.assets=i,s=0;s<l.length;++s)null!==l[s]&&-1===h.indexOf(l[s])&&l[s].destroy();for(s=0;s<o.length;++s)null!==o[s]&&-1===i.indexOf(o[s])&&o[s].unload()},t.cmpArrays=function(e,t){if(e.length!==t.length)return!1;for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0},t.resolveId=function(e){var t=parseInt(e,10);return t===e||t.toString()===e?t:e},t.loadAssets=function(i,n){i.hasOwnProperty("_handlerState")||(i._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});for(var e,a=this,s=a.getAssetIds(i),r=[null,null,null,null,null,null,null],t=i._handlerState.assetIds,o=i._handlerState.assets,l=a._registry,h=7,c=function(e,t){r[e]=t,0==--h&&(a.update(i,s,r),n(null,i.resources))},u=function(e,t,i){n(t)},d=function(e,t){t.loaded?c(e,t):(l.once("load:"+t.id,c.bind(a,e)),l.once("error:"+t.id,u.bind(a,e)),t.loading||l.load(t))},p=0;p<7;++p){var f=this.resolveId(s[p]);if(f)if(a.compareAssetIds(f,t[p]))c(p,o[p]);else if(parseInt(f,10)===f)(e=l.get(f))?d(p,e):setTimeout(function(e,t){var i=l.get(t);i?d(e,i):u(0,"failed to find dependent cubemap asset="+t)}.bind(null,p,f));else{var m="string"==typeof f?{url:f,filename:f}:f;e=new Kr(i.name+"_part_"+p,"texture",m),l.add(e),l.once("load:"+e.id,c.bind(a,p)),l.once("error:"+e.id,u.bind(a,p)),l.load(e)}else c(p,null)}},e}(),Bo=function(){function e(){}var t=e.prototype;return t.load=function(e,t){t(null,null)},t.open=function(e,t){return t},e}(),Vo="msdf",Uo=function(){function e(e,t){this.type=t&&t.type||Vo,this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t}return c(e,[{key:"data",get:function(){return this._data},set:function(e){if((this._data=e)&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(var t in this._data.chars)this._data.chars[t].map=0}}]),e}();function No(a){return a.version<3&&(a.version<2&&(a.info.maps=a.info.maps||[{width:a.info.width,height:a.info.height}]),a.chars=Object.keys(a.chars||{}).reduce(function(e,t){var i=a.chars[t],n=void 0!==i.letter?i.letter:Me.fromCodePoint(t);return a.version<2&&(i.map=i.map||0),e[n]=i,e},{}),a.version=3),a}var Go=function(){function e(e){this._loader=e,this.maxRetries=0}var t=e.prototype;return t.load=function(n,a,e){"string"==typeof n&&(n={load:n,original:n});var s=this;".json"===C.getExtension(n.original)?q.get(n.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,t){if(e)a("Error loading font resource: "+n.original+" ["+e+"]");else{var i=No(t);s._loadTextures(n.load.replace(".json",".png"),i,function(e,t){if(e)return a(e);a(null,{data:i,textures:t})})}}):(e&&e.data&&(e.data=No(e.data)),this._loadTextures(n.load,e&&e.data,a))},t._loadTextures=function(t,e,n){for(var a=e.info.maps.length,s=0,r=null,o=new Array(a),l=this._loader,i=function(i){var e=function(e,t){if(!r){if(e)return n(r=e);t.flipY=!1,t.upload(),o[i]=t,++s===a&&n(null,o)}};0===i?l.load(t,"texture",e):l.load(t.replace(".png",i+".png"),"texture",e)},h=0;h<a;h++)i(h)},t.open=function(e,t,i){return t.textures?new Uo(t.textures,t.data):new Uo(t,null)},t.patch=function(e,t){var i=e.resource;!i.data&&e.data?i.data=e.data:!e.data&&i.data&&(e.data=i.data),e.data&&(e.data=No(e.data))},e}(),Wo=function(){function r(e,t){this._node=e,this._data=t}var e=r.prototype;return e.run=function(){var e=Object.prototype.toString.call(this._node);return"[object Object]"===e?this._handleMap():"[object Array]"===e?this._handleArray():this._result=this._node,this._result},e._handleMap=function(){this._result={},Object.keys(this._node).forEach(this._handleKey,this)},e._handleKey=function(e){var t,i,n,a=e,s=e.length;1===s?(t=e,i=this._data,n=t.charCodeAt(0)-i.fieldFirstCode,a=i.fieldArray[n]):2===s&&(a=function(e,t){for(var i=0,n=0;n<e.length;n++)i=i*t.fieldCodeBase+e.charCodeAt(n)-t.fieldFirstCode;return t.fieldArray[i]}(e,this._data)),this._result[a]=new r(this._node[e],this._data).run()},e._handleArray=function(){this._result=[],this._node.forEach(this._handleArElt,this)},e._handleArElt=function(e){var t=new r(e,this._data).run();this._result.push(t)},r}(),Ho=function(){function e(e,t){this._app=e,this._isTemplate=t}var t=e.prototype;return t.parse=function(e){var t={},i=null,n=e.compressedFormat;for(var a in n&&!e.entDecompressed&&(e.entDecompressed=!0,e.entities=new Wo(e.entities,n).run()),e.entities){var s=e.entities[a],r=this._createEntity(s,n);t[a]=r,null===s.parent&&(i=r)}for(var o in e.entities)for(var l=t[o],h=e.entities[o].children,c=h.length,u=0;u<c;u++){var d=t[h[u]];d&&l.addChild(d)}return this._openComponentData(i,e.entities),i},t._createEntity=function(e,t){var i=new Cr;if(i.name=e.name,i.setGuid(e.resource_id),this._setPosRotScale(i,e,t),i._enabled=void 0===e.enabled||e.enabled,this._isTemplate?i._template=!0:i._enabledInHierarchy=i._enabled,i.template=e.template,e.tags)for(var n=0;n<e.tags.length;n++)i.tags.add(e.tags[n]);return e.labels&&e.labels.forEach(function(e){i.addLabel(e)}),i},t._setPosRotScale=function(e,t,i){if(i)!function(e,t,i){var n,a,s=i.singleVecs,r=t.___1;r||(n=i.tripleVecs,a=t.___2);var o=r?r[0]:n[a];e.setLocalPosition(s[o],s[o+1],s[o+2]),o=r?r[1]:n[a+1],e.setLocalEulerAngles(s[o],s[o+1],s[o+2]),o=r?r[2]:n[a+2],e.setLocalScale(s[o],s[o+1],s[o+2])}(e,t,i);else{var n=t.position,a=t.rotation,s=t.scale;e.setLocalPosition(n[0],n[1],n[2]),e.setLocalEulerAngles(a[0],a[1],a[2]),e.setLocalScale(s[0],s[1],s[2])}},t._openComponentData=function(e,t){for(var i=this._app.systems.list,n=i.length,a=t[e.getGuid()],s=0;s<n;s++){var r=i[s],o=a.components[r.id];o&&r.addComponent(e,o)}n=a.children.length;for(var l=e._children,h=0;h<n;h++)l[h]=this._openComponentData(l[h],t);return e},e}(),jo={load:function(n,a){"string"==typeof n&&(n={load:n,original:n}),q.get(n.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,t){if(e){var i="Error while loading scene JSON "+n.original;e.message?(i+=": "+e.message,e.stack&&(i+="\n"+e.stack)):i+=": "+e,a(i)}else a(e,t)})}},Xo=function(){function e(e){this._app=e,this.maxRetries=0}var t=e.prototype;return t.load=function(e,t){jo.load(e,t)},t.open=function(e,t){this._app.systems.script.preloading=!0;var i=new Ho(this._app,!1).parse(t);return this._app.systems.script.preloading=!1,i},e}(),qo=function(){function e(){this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i}),q.get(i.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,t){e?n("Error loading html resource: "+i.original+" ["+e+"]"):n(null,t)})},t.open=function(e,t){return t},t.patch=function(e,t){},e}(),$o=function(){function e(){this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i});var e={retry:0<this.maxRetries,maxRetries:this.maxRetries};i.load.startsWith("blob:")&&(e.responseType=X.ResponseType.JSON),q.get(i.load,e,function(e,t){e?n("Error loading JSON resource: "+i.original+" ["+e+"]"):n(null,t)})},t.open=function(e,t){return t},t.patch=function(e,t){},e}(),Yo=function(){function e(e,t,i,n,a){this.propertyName=e,this.parent=t,this._scope=a,this._registry=i,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=n.load,this._onAssetAdd=n.add,this._onAssetRemove=n.remove,this._onAssetUnload=n.unload}var t=e.prototype;return t._bind=function(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))},t._unbind=function(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))},t._onLoad=function(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)},t._onAdd=function(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)},t._onRemove=function(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null},t._onUnload=function(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e)},t.destroy=function(){this.id=null,this.url=null,this.asset=null,this.propertyName=null,this.parent=null,this._scope=null,this._registry=null},c(e,[{key:"id",get:function(){return this._id},set:function(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}},{key:"url",get:function(){return this._url},set:function(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}}]),e}();function Ko(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),shadingModel:this._createEnumValidator([0,1,2]),textureMappingType:this._createEnumValidator([2,3,5,4,0,1,6,7]),textureMappingReverseMode:this._createEnumValidator([0,1,2,3]),textureMappingTilingMode:this._createEnumValidator([0,1,2,3])}}Ko.prototype.setInvalid=function(e,t){this.valid=!1,this.removeInvalid&&delete t[e]},Ko.prototype.validate=function(e){var t,i,n=Wi,a="path"===e.mappingFormat;for(var s in e)if(t=n[s]){if(t.startsWith("enum")){var r=t.split(":")[1];this.enumValidators[r]&&(this.enumValidators[r](e[s])||this.setInvalid(s,e))}else if("number"===t)"number"!=typeof e[s]&&this.setInvalid(s,e);else if("boolean"===t)"boolean"!=typeof e[s]&&this.setInvalid(s,e);else if("string"===t)"string"!=typeof e[s]&&this.setInvalid(s,e);else if("vec2"===t)e[s]instanceof Array&&2===e[s].length&&"number"==typeof e[s][0]&&"number"==typeof e[s][1]||this.setInvalid(s,e);else if("vec3"===t)e[s]instanceof Array&&3===e[s].length&&"number"==typeof e[s][0]&&"number"==typeof e[s][1]&&"number"==typeof e[s][2]||this.setInvalid(s,e);else if("rgb"===t)e[s]instanceof Array&&3===e[s].length&&"number"==typeof e[s][0]&&"number"==typeof e[s][1]&&"number"==typeof e[s][2]||this.setInvalid(s,e);else if("texture"===t)a?"string"==typeof e[s]||e[null===s]||e[s]instanceof Kt||this.setInvalid(s,e):"number"!=typeof e[s]&&"string"!=typeof e[s]&&null!==e[s]&&(e[s]instanceof Kt||this.setInvalid(s,e));else if("boundingbox"===t)e[s].center&&e[s].center instanceof Array&&3===e[s].center.length||this.setInvalid(s,e),e[s].halfExtents&&e[s].halfExtents instanceof Array&&3===e[s].halfExtents.length||this.setInvalid(s,e);else if("cubemap"===t)"number"!=typeof e[s]&&"string"!=typeof e[s]&&null!==e[s]&&void 0!==e[s]&&(e[s]instanceof Kt&&e[s].cubemap||this.setInvalid(s,e));else if("chunks"===t)if(e[s]instanceof Object){var o=Object.keys(e[s]);for(i=0;i<o.length;i++)"string"!=typeof e[s][o[i]]&&this.setInvalid(o[i],e[s])}else this.setInvalid(s,e)}else this.valid=!1;return e.validated=!0,this.valid},Ko.prototype._createEnumValidator=function(t){return function(e){return 0<=t.indexOf(e)}};var Zo=function(){function e(){this._validator=null}var t=e.prototype;return t.parse=function(e){var t=this.migrate(e),i=this._validate(t),n=new gm;return this.initialize(n,i),n},t.initialize=function(e,t){for(var i in t.validated||(t=this._validate(t)),t.chunks&&e.chunks.copy(t.chunks),t){var n=Wi[i],a=t[i];if("vec2"===n)e[i]=new J(a[0],a[1]);else if("vec3"===n)e[i]=new de(a[0],a[1],a[2]);else if("rgb"===n)e[i]=new $(a[0],a[1],a[2]);else if("texture"===n)a instanceof Kt?e[i]=a:e[i]instanceof Kt&&"number"==typeof a&&a<0||(e[i]=null);else if("cubemap"===n)a instanceof Kt?e[i]=a:e[i]instanceof Kt&&"number"==typeof a&&a<0||(e[i]=null);else if("boundingbox"===n){var s=new de(a.center[0],a.center[1],a.center[2]),r=new de(a.halfExtents[0],a.halfExtents[1],a.halfExtents[2]);e[i]=new ue(s,r)}else e[i]=t[i]}e.update()},t.migrate=function(e){var t;void 0===e.shadingModel&&("blinn"===e.shader?e.shadingModel=1:e.shadingModel=0),e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);var i=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(t=0;t<i.length;t++){var n=i[t][0],a=i[t][1];void 0!==e[n]&&void 0===e[a]&&(e[a]=e[n],delete e[n])}var s=["fresnelFactor","shadowSampleType"];for(t=0;t<s.length;t++){var r=s[t];e.hasOwnProperty(r)&&delete e[r]}return e},t._validate=function(e){return e.validated||(this._validator||(this._validator=new Ko),this._validator.validate(e)),e},e}(),Qo={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white",uClearCoatMap:"gray"},Jo=function(){function e(e){this._assets=e.assets,this._device=e.graphicsDevice,this._placeholderTextures=null,this._parser=new Zo,this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i}),q.get(i.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,t){e?n&&n("Error loading material: "+i.original+" ["+e+"]"):n&&(t._engine=!0,n(null,t))})},t.open=function(e,t){var i=this._parser.parse(t);return t._engine&&delete(i._data=t)._engine,i},t._createPlaceholders=function(){this._placeholderTextures={};var e={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(var t in e)if(e.hasOwnProperty(t)){this._placeholderTextures[t]=new Kt(this._device,{width:2,height:2,format:7}),this._placeholderTextures[t].name="placeholder";for(var i=this._placeholderTextures[t].lock(),n=0;n<4;n++)for(var a=0;a<4;a++)i[4*n+a]=e[t][a];this._placeholderTextures[t].unlock()}},t.patch=function(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this)},t._onAssetUnload=function(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name},t._assignTexture=function(e,t,i){t.resource[e]=i,t.fire("assign","texture",e)},t._getPlaceholderTexture=function(e){this._placeholderTextures||this._createPlaceholders();var t=Qo[e];return this._placeholderTextures[t]},t._assignPlaceholderTexture=function(e,t){t.resource[e]=this._getPlaceholderTexture(e,t)},t._onTextureLoad=function(e,t,i){this._assignTexture(e,t,i.resource),t.resource.update()},t._onTextureAdd=function(e,t,i){this._assets.load(i)},t._onTextureRemoveOrUnload=function(e,t,i){var n=t.resource;n&&t.resource[e]===i.resource&&(this._assignPlaceholderTexture(e,t),n.update())},t._assignCubemap=function(e,t,i){t.resource[e]=i[0],7===i.length&&(t.resource.prefilteredCubeMap128=i[1],t.resource.prefilteredCubeMap64=i[2],t.resource.prefilteredCubeMap32=i[3],t.resource.prefilteredCubeMap16=i[4],t.resource.prefilteredCubeMap8=i[5],t.resource.prefilteredCubeMap4=i[6]),t.fire("assign","cubemap",e)},t._onCubemapLoad=function(e,t,i){this._assignCubemap(e,t,i.resources),this._parser.initialize(t.resource,t.data)},t._onCubemapAdd=function(e,t,i){0===t.data.shadingModel&&(t.loadFaces=!0),this._assets.load(i)},t._onCubemapRemoveOrUnload=function(e,t,i){var n=t.resource;t.data.prefilteredCubeMap128===i.resources[1]&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),n.update())},t._bindAndAssignAssets=function(e,t){var i,n,a,s=this._parser.migrate(e.data),r=e.resource,o="path"===s.mappingFormat,l=Hi;for(i=0;i<l.length;i++){n=l[i],a=r._assetReferences[n];var h=s[n],c=r[n],u=c===this._getPlaceholderTexture(n,e),d=s.validated;!h||c&&d&&!u?a&&(o?a.url=null:a.id=null):(a||(a=new Yo(n,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),r._assetReferences[n]=a),o?a.url=e.getAbsoluteUrl(h):a.id=h,a.asset&&(a.asset.resource?this._assignTexture(n,e,a.asset.resource):this._assignPlaceholderTexture(n,e),t.load(a.asset)))}var p=ji;for(i=0;i<p.length;i++)n=p[i],a=r._assetReferences[n],s[n]&&!e.data.prefilteredCubeMap128&&(a||(a=new Yo(n,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),r._assetReferences[n]=a),o?a.url=s[n]:a.id=s[n],a.asset&&(a.asset.loaded&&this._assignCubemap(n,e,a.asset.resources),t.load(a.asset)));this._parser.initialize(r,s)},e}(),el=function(){function e(e){this._device=e}return e.prototype.parse=function(e,t){var i=go.parse(t||"filename.glb",e,this._device);if(i){var n=Lo.createModel(i,Ui.defaultMaterial);return i.destroy(),n}return null},e}(),tl=function(){this.index=0,this.boneIndices=[0,0,0,0]},il=function(){function e(){this.partition=0,this.vertexStart=0,this.vertexCount=0,this.indexStart=0,this.indexCount=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={},this.originalMesh=null}var t=e.prototype;return t.addVertex=function(e,t,i){var n=-1;if(void 0!==this.indexMap[t])n=this.indexMap[t],this.indices.push(n);else{for(var a=0;a<4;a++)if(0!==i.blendWeight.data[4*t+a]){var s=i.blendIndices.data[4*e.index+a];e.boneIndices[a]=this.getBoneRemap(s)}n=this.vertices.length,this.indices.push(n),this.vertices.push(e),this.indexMap[t]=n}},t.addPrimitive=function(e,t,i,n){var a,s,r=[],o=0,l=e.length;for(a=0;a<l;a++)for(var h=e[a].index,c=0;c<4;c++)if(0<i.blendWeight.data[4*h+c]){var u=i.blendIndices.data[4*h+c],d=!0;for(s=0;s<o;s++)if(r[s]===u){d=!1;break}d&&(r[o]=u,o+=-1===this.getBoneRemap(u)?1:0)}if(this.boneIndices.length+o>n)return!1;for(a=0;a<o;a++)this.boneIndices.push(r[a]);for(a=0;a<l;a++)this.addVertex(e[a],t[a],i);return!0},t.getBoneRemap=function(e){for(var t=0;t<this.boneIndices.length;t++)if(this.boneIndices[t]===e)return t;return-1},e}(),nl={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},al={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6},sl=function(){function e(e){this._device=e}var t=e.prototype;return t.parse=function(e){var t=e.model;if(!t)return null;if(t.version<=1)return null;var i=this._parseNodes(e),n=this._parseSkins(e,i),a=this._parseVertexBuffers(e),s=this._parseIndexBuffers(e,a),r=this._parseMorphs(e,i,a),o=this._parseMeshes(e,n.skins,r.morphs,a,s.buffer,s.data),l=this._parseMeshInstances(e,i,o,n.skins,n.instances,r.morphs,r.instances),h=new rr;return h.graph=i[0],h.meshInstances=l,h.skinInstances=n.instances,h.morphInstances=r.instances,h.getGraph().syncHierarchy(),h},t._parseNodes=function(e){var t,i=e.model,n=[];for(t=0;t<i.nodes.length;t++){var a=i.nodes[t],s=new mn(a.name);s.setLocalPosition(a.position[0],a.position[1],a.position[2]),s.setLocalEulerAngles(a.rotation[0],a.rotation[1],a.rotation[2]),s.setLocalScale(a.scale[0],a.scale[1],a.scale[2]),s.scaleCompensation=!!a.scaleCompensation,n.push(s)}for(t=1;t<i.parents.length;t++)n[i.parents[t]].addChild(n[t]);return n},t._parseSkins=function(e,t){var i,n,a=e.model,s=[],r=[];for(!this._device.supportsBoneTextures&&0<a.skins.length&&function(e,t,i){var n,a,s,r;!function(e){var t,i=e.vertices,n=e.skins,a=e.meshes,s=e.meshInstances;for(t=0;t<a.length;t++)a[t].vertices=i[a[t].vertices],void 0!==a[t].skin&&(a[t].skin=n[a[t].skin]);for(t=0;t<s.length;t++)s[t].mesh=a[s[t].mesh]}(e);var o,l=e.vertices,h=e.skins,c=e.meshes,u=e.meshInstances,d=function(e){var t=new tl;return t.index=e,t};for(n=h.length-1;0<=n;n--)if(h[n].boneNames.length>i){var p=h.splice(n,1)[0],f=[];for(a=0;a<c.length;a++)c[a].skin===p&&f.push(c[a]);for(a=0;a<f.length;a++)-1!==(r=c.indexOf(f[a]))&&c.splice(r,1);if(0===f.length)throw new Error("partitionSkin: There should be at least one mesh that references a skin");var m,v=f[0].vertices;for(a=1;a<f.length;a++)if(f[a].vertices!==v)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var g=[],_=[],y=[],b=0;for(a=0;a<f.length;a++){for(var x=(o=f[a]).indices,M=o.base;M<o.base+o.count;){r=x[M++],_[0]=d(r),y[0]=r,r=x[M++],_[1]=d(r),y[1]=r,r=x[M++],_[2]=d(r),y[2]=r;for(var S=!1,w=b;w<g.length;w++)if((m=g[w]).addPrimitive(_,y,v,i)){S=!0;break}S||((m=new il).originalMesh=o,m.addPrimitive(_,y,v,i),g.push(m))}b=g.length}var C=[],P=[];for(a=0;a<g.length;a++)if((m=g[a]).vertices.length&&m.indices.length){var T,A,E=C.length,R=m.vertices.length,D=P.length,I=m.indices.length;for(m.partition=a,m.vertexStart=E,m.vertexCount=R,m.indexStart=D,m.indexCount=I,T=0,A=E;T<R;)C[A++]=m.vertices[T++];for(T=0,A=D;T<I;)P[A++]=m.indices[T++]+E}var k,L,O,F,z=[];for(a=0;a<g.length;a++){m=g[a];var B=[],V=[];for(s=0;s<m.boneIndices.length;s++)B.push(p.inverseBindMatrices[m.boneIndices[s]]),V.push(p.boneNames[m.boneIndices[s]]);var U={inverseBindMatrices:B,boneNames:V};z.push(U),h.push(U)}var N={};for(L in v)N[L]={components:v[L].components,data:[],type:v[L].type};for(L in v)if("blendIndices"===L){var G=N[L].data;for(a=0;a<C.length;a++){var W=C[a].boneIndices;G.push(W[0],W[1],W[2],W[3])}}else for(O=(k=v[L]).data,F=k.components,a=0;a<C.length;a++)for(r=C[a].index,s=0;s<F;s++)N[L].data.push(O[r*F+s]);for(l[l.indexOf(v)]=N,a=0;a<g.length;a++)for(m=g[a],o={aabb:{min:[0,0,0],max:[0,0,0]},vertices:N,skin:z[a],indices:P.splice(0,m.indexCount),type:"triangles",base:0,count:m.indexCount},c.push(o),s=u.length-1;0<=s;s--)u[s].mesh===m.originalMesh&&u.push({mesh:o,node:u[s].node});for(a=0;a<g.length;a++)for(m=g[a],s=u.length-1;0<=s;s--)u[s].mesh===m.originalMesh&&u.splice(s,1)}!function(e){var t,i=e.vertices,n=e.skins,a=e.meshes,s=e.meshInstances;for(t=0;t<a.length;t++)a[t].vertices=i.indexOf(a[t].vertices),void 0!==a[t].skin&&(a[t].skin=n.indexOf(a[t].skin));for(t=0;t<s.length;t++)s[t].mesh=a.indexOf(s[t].mesh)}(e)}(a,0,this._device.getBoneLimit()),i=0;i<a.skins.length;i++){var o=a.skins[i],l=[];for(n=0;n<o.inverseBindMatrices.length;n++){var h=o.inverseBindMatrices[n];l[n]=(new pe).set(h)}var c=new Sr(this._device,l,o.boneNames);s.push(c);var u=new Tn(c),d=[];for(n=0;n<c.boneNames.length;n++){var p=c.boneNames[n],f=t[0].findByName(p);d.push(f)}u.bones=d,r.push(u)}return{skins:s,instances:r}},t._getMorphVertexCount=function(e,t,i){for(var n=0;n<e.meshes.length;n++){var a=e.meshes[n];if(a.morph===t)return i[a.vertices].numVertices}},t._parseMorphs=function(e,t,i){var n,a,s,r,o,l,h=e.model,c=[],u=[];if(h.morphs){var d=function(e,t,i){for(var n=new Float32Array(3*i),a=0;a<t.length;a++){var s=3*t[a];n[s]=e[3*a],n[s+1]=e[3*a+1],n[s+2]=e[3*a+2]}return n};for(n=0;n<h.morphs.length;n++){for(r=h.morphs[n].targets,l=[],s=this._getMorphVertexCount(h,n,i),a=0;a<r.length;a++){var p=r[a].aabb,f=p.min,m=p.max,v=new ue(new de(.5*(m[0]+f[0]),.5*(m[1]+f[1]),.5*(m[2]+f[2])),new de(.5*(m[0]-f[0]),.5*(m[1]-f[1]),.5*(m[2]-f[2]))),g=r[a].indices,_=r[a].deltaPositions,y=r[a].deltaNormals;g&&(_=d(_,g,s),y=d(y,g,s)),o=new Mr({deltaPositions:_,deltaNormals:y,name:r[a].name,aabb:v}),l.push(o)}var b=new ar(l,this._device);c.push(b);var x=new sr(b);u.push(x)}}return{morphs:c,instances:u}},t._parseVertexBuffers=function(e){for(var t=e.model,i=[],n={position:Te,normal:Ae,tangent:Ee,blendWeight:Re,blendIndices:De,color:Ie,texCoord0:Le,texCoord1:Oe,texCoord2:Fe,texCoord3:ze,texCoord4:Be,texCoord5:Ve,texCoord6:Ue,texCoord7:Ne},a=0;a<t.vertices.length;a++){var s=t.vertices[a],r=[];for(var o in s){var l=s[o];r.push({semantic:n[o],components:l.components,type:al[l.type],normalize:n[o]===Ie})}for(var h=new ut(this._device,r),c=s.position.data.length/s.position.components,u=new ht(this._device,h,c),d=new Ct(u),p=0;p<c;p++){for(var f in s){var m=s[f];switch(m.components){case 1:d.element[n[f]].set(m.data[p]);break;case 2:d.element[n[f]].set(m.data[2*p],1-m.data[2*p+1]);break;case 3:d.element[n[f]].set(m.data[3*p],m.data[3*p+1],m.data[3*p+2]);break;case 4:d.element[n[f]].set(m.data[4*p],m.data[4*p+1],m.data[4*p+2],m.data[4*p+3])}}d.next()}d.end(),i.push(u)}return i},t._parseIndexBuffers=function(e,t){var i,n=e.model,a=null,s=null,r=0;for(i=0;i<n.meshes.length;i++){var o=n.meshes[i];void 0!==o.indices&&(r+=o.indices.length)}var l=0;for(i=0;i<t.length;i++)l=Math.max(l,t[i].numVertices);return 0<r&&(65535<l&&this._device.extUintElement?(a=new qi(this._device,2,r),s=new Uint32Array(a.lock())):(a=new qi(this._device,1,r),s=new Uint16Array(a.lock()))),{buffer:a,data:s}},t._parseMeshes=function(e,t,i,n,a,s){for(var r=e.model,o=[],l=0,h=0;h<r.meshes.length;h++){var c=r.meshes[h],u=c.aabb,d=u.min,p=u.max,f=new ue(new de(.5*(p[0]+d[0]),.5*(p[1]+d[1]),.5*(p[2]+d[2])),new de(.5*(p[0]-d[0]),.5*(p[1]-d[1]),.5*(p[2]-d[2]))),m=void 0!==c.indices,v=new Zi(this._device);v.vertexBuffer=n[c.vertices],v.indexBuffer[0]=m?a:null,v.primitive[0].type=nl[c.type],v.primitive[0].base=m?c.base+l:c.base,v.primitive[0].count=c.count,v.primitive[0].indexed=m,v.skin=void 0!==c.skin?t[c.skin]:null,v.morph=void 0!==c.morph?i[c.morph]:null,v.aabb=f,m&&(s.set(c.indices,l),l+=c.indices.length),o.push(v)}return null!==a&&a.unlock(),o},t._parseMeshInstances=function(e,t,i,n,a,s,r){var o,l=e.model,h=[];for(o=0;o<l.meshInstances.length;o++){var c=l.meshInstances[o],u=t[c.node],d=i[c.mesh],p=new Mn(d,Ui.defaultMaterial,u);if(d.skin){var f=n.indexOf(d.skin);p.skinInstance=a[f]}if(d.morph){var m=s.indexOf(d.morph);p.morphInstance=r[m]}h.push(p)}return h},e}();function rl(e){this._device=e,this.parser=new sl(this._device)}var ol="function"==typeof TextDecoder?new TextDecoder:null;Object.assign(rl.prototype,{parse:function(e){return this.parser.parse(this._decrypt(e))},_decrypt:function(e){var t=["z","f","o"].map(function(e){return e.charCodeAt(0)}),i=t.length,n=new Uint8Array(e),a=n.length;[0,1,2].forEach(function(e){var t=n[e],i=Math.floor(a/2+e);n[e]=n[i],n[i]=t});for(var s=Math.floor(a/3),r=0;r<s;r++){var o=r-i*Math.floor(r/3);n[3*r]=n[3*r]^t[o]}return JSON.parse(this._decode(n))},_decode:function(e){return ol?ol.decode(e):this._utf8ArrayToStr(e)},_utf8ArrayToStr:function(e){for(var t,i=0,n=e.length,a="";i<n;)t=Array.prototype.slice.call(e,i,i+32768),a+=String.fromCharCode.apply(null,t),i+=32768;return a}});var ll=function(){function e(e,t){this._device=e,this._parsers=[],this._defaultMaterial=t,this.maxRetries=0,this.addParser(new sl(this._device),function(e,t){return".json"===C.getExtension(e)}),this.addParser(new el(this._device),function(e,t){return C.getExtension(e)===Ur||C.getExtension(e)===Nr}),this.addParser(new rl(this._device),function(e,t){return C.getExtension(e)===Gr})}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i});var e={retry:0<this.maxRetries,maxRetries:this.maxRetries};i.load.startsWith("blob:")||i.load.startsWith("data:")?C.getExtension(i.original).toLowerCase()===Ur||C.getExtension(i.original).toLowerCase()===Nr||C.getExtension(i.original).toLowerCase()===Gr?e.responseType=X.ResponseType.ARRAY_BUFFER:e.responseType=X.ResponseType.JSON:C.getExtension(i.original).toLowerCase()!==Nr&&C.getExtension(i.original).toLowerCase()!==Gr||(e.responseType=X.ResponseType.ARRAY_BUFFER),q.get(i.load,e,function(e,t){n&&(e?n("Error loading model: "+i.original+" ["+e+"]"):n(null,t))})},t.open=function(e,t){for(var i=0;i<this._parsers.length;i++){var n=this._parsers[i];if(n.decider(e,t))return n.parser.parse(t,e)}return null},t.patch=function(o,l){if(o.resource){var h=o.data,c=this;o.resource.meshInstances.forEach(function(i,e){if(h.mapping){var t=function e(t){t.resource?i.material=t.resource:(t.once("load",e),l.load(t)),t.once("remove",function(e){i.material===e.resource&&(i.material=c._defaultMaterial)})};if(!h.mapping[e])return void(i.material=c._defaultMaterial);var n,a=h.mapping[e].material,s=h.mapping[e].path;if(void 0!==a)a?(n=l.get(a))?t(n):l.once("add:"+a,t):i.material=c._defaultMaterial;else if(s){var r=o.getAbsoluteUrl(h.mapping[e].path);(n=l.getByUrl(r))?t(n):l.once("add:url:"+r,t)}}})}},t.addParser=function(e,t){this._parsers.push({parser:e,decider:t})},e}();function hl(e){if(this.resource){var t=e.resource,i=t.renders&&t.renders[this.data.renderIndex];i&&(this.resource.meshes=i.resource.meshes)}}function cl(e){var t=this;t.registry.off("load:"+e.id,hl,t),t.registry.on("load:"+e.id,hl,t),t.registry.off("remove:"+e.id,ul,t),t.registry.once("remove:"+e.id,ul,t),e.resource?hl.call(t,e):t.registry.load(e)}function ul(e){this.registry.off("load:"+e.id,hl,this),this.resource&&this.resource.destroy()}var dl=function(){function e(e){this._registry=e}var t=e.prototype;return t.load=function(e,t,i){},t.open=function(e,t){return new wr},t.patch=function(e,t){if(e.data.containerAsset){var i=t.get(e.data.containerAsset);i?cl.call(e,i):t.once("add:"+e.data.containerAsset,cl,e)}},e}(),pl=function(){function e(e){this._handlers={},this._requests={},this._cache={},this._app=e}var t=e.prototype;return t.addHandler=function(e,t){(this._handlers[e]=t)._loader=this},t.removeHandler=function(e){delete this._handlers[e]},t.getHandler=function(e){return this._handlers[e]},t.load=function(e,t,i,a){var s=this._handlers[t];if(s)if(e){var r=e+t;if(void 0!==this._cache[r])i(null,this._cache[r]);else if(this._requests[r])this._requests[r].push(i);else{this._requests[r]=[i];var o=this,n=function(e,n){e?o._onFailure(r,e):s.load(n,function(e,t,i){if(o._requests[r])if(e)o._onFailure(r,e);else try{o._onSuccess(r,s.open(n.original,t,a),i)}catch(e){o._onFailure(r,e)}},a)},l=e.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(l)){if(!this._app.bundles.canLoadUrl(l))return void n("Bundle for "+e+" not loaded yet");this._app.bundles.loadUrl(l,function(e,t){n(e,{load:t,original:l})})}else n(null,{load:e,original:a&&a.getPreferredFile().filename||e})}}else this._loadNull(s,i,a);else i("No handler for asset type: "+t)},t._loadNull=function(n,a,s){n.load(null,function(e,t,i){if(e)a(e);else try{a(null,n.open(null,t,s),i)}catch(e){a(e)}},s)},t._onSuccess=function(e,t,i){this._cache[e]=t;for(var n=0;n<this._requests[e].length;n++)this._requests[e][n](null,t,i);delete this._requests[e]},t._onFailure=function(e,t){if(this._requests[e]){for(var i=0;i<this._requests[e].length;i++)this._requests[e][i](t);delete this._requests[e]}},t.open=function(e,t){var i=this._handlers[e];return i?i.open(null,t):t},t.patch=function(e,t){var i=this._handlers[e.type];i&&i.patch&&i.patch(e,t)},t.clearCache=function(e,t){delete this._cache[e+t]},t.getFromCache=function(e,t){if(this._cache[e+t])return this._cache[e+t]},t.enableRetry=function(e){for(var t in void 0===e&&(e=5),e=Math.max(0,e)||0,this._handlers)this._handlers[t].maxRetries=e},t.disableRetry=function(){for(var e in this._handlers)this._handlers[e].maxRetries=0},t.destroy=function(){this._handlers={},this._requests={},this._cache={}},e}(),fl=function(){function e(e){this._app=e,this.maxRetries=0}var t=e.prototype;return t.load=function(e,t){jo.load(e,t)},t.open=function(e,t){this._app.systems.script.preloading=!0;var i=new Ho(this._app,!1).parse(t),n=this._app.scene;return n.root=i,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=!1,n},t.patch=function(e,t){},e}(),ml=!1,vl=!1,gl={app:null,create:function(e,t){if(ml){var i=t(gl.app);i._pcScriptName=e,_l._push(i),this.fire("created",e,t)}},attribute:function(e,t,i,n){},createLoadingScreen:function(e){vl||(vl=!0,e(hi()))}};Object.defineProperty(gl,"legacy",{get:function(){return ml},set:function(e){ml=e}}),f.attach(gl);var _l=function(){function l(e){this._app=e,this._scripts={},this._cache={}}l._push=function(e){gl.legacy&&0<l._types.length||l._types.push(e)};var e=l.prototype;return e.load=function(e,r){"string"==typeof e&&(e={load:e,original:e});var o=this;gl.app=this._app,this._loadScript(e.load,function(e,t,i){if(e)r(e);else if(gl.legacy){var n=null;l._types.length&&(n=l._types.pop()),n?this._scripts[t]=n:n=null,r(null,n,i)}else{for(var a={},s=0;s<l._types.length;s++)a[l._types[s].name]=l._types[s];l._types.length=0,r(null,a,i),delete o._loader._cache[t+"script"]}}.bind(this))},e.open=function(e,t){return t},e.patch=function(e,t){},e._loadScript=function(e,t){var i=document.head,n=document.createElement("script");(this._cache[e]=n).async=!1,n.addEventListener("error",function(e){t("Script: "+e.target.src+" failed to load")},!1);var a=!1;n.onload=n.onreadystatechange=function(){a||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(a=!0,t(null,e,n))},n.src=e,i.appendChild(n)},l}();_l._types=[];var yl=function(){function e(){this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i}),q.get(i.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,t){e?n("Error loading shader resource: "+i.original+" ["+e+"]"):n(null,t)})},t.open=function(e,t){return t},t.patch=function(e,t){},e}(),bl=[0,0,1,0,0,1,0,0,1,0,0,1],xl=[0,1,3,2,3,1],Ml=function(n){function e(e,t){var i;return(i=n.call(this)||this)._device=e,i._pixelsPerUnit=t&&void 0!==t.pixelsPerUnit?t.pixelsPerUnit:1,i._renderMode=t&&void 0!==t.renderMode?t.renderMode:0,i._atlas=t&&void 0!==t.atlas?t.atlas:null,i._frameKeys=t&&void 0!==t.frameKeys?t.frameKeys:null,i._meshes=[],i._updatingProperties=!1,i._meshesDirty=!1,i._atlas&&i._frameKeys&&i._createMeshes(),i}u(e,n);var t=e.prototype;return t._createMeshes=function(){var e,t;for(e=0,t=this._meshes.length;e<t;e++){var i=this._meshes[e];i&&i.destroy()}var n=this._frameKeys.length;this._meshes=new Array(n);var a=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh;for(e=0;e<n;e++){var s=this._atlas.frames[this._frameKeys[e]];this._meshes[e]=s?a.call(this,s):null}this.fire("set:meshes")},t._createSimpleMesh=function(e){var t=e.rect,i=this._atlas.texture.width,n=this._atlas.texture.height,a=t.z/this._pixelsPerUnit,s=t.w/this._pixelsPerUnit,r=e.pivot.x,o=e.pivot.y,l=[-r*a,-o*s,0,(1-r)*a,-o*s,0,(1-r)*a,(1-o)*s,0,-r*a,(1-o)*s,0],h=t.x/i,c=1-t.y/n,u=(t.x+t.z)/i,d=1-(t.y+t.w)/n,p=[h,c,u,c,u,d,h,d];return Js(this._device,l,{uvs:p,normals:bl,indices:xl})},t._create9SliceMesh=function(){var e,t,i,n,a,s,r=J.ONE,o=[],l=[],h=[],c=[],u=0;for(e=0;e<=3;e++)for(a=0===e||3===e?0:1,t=0;t<=3;t++)i=-r.x+2*r.x*(e<=1?0:3)/3,n=-(-r.y+2*r.y*(t<=1?0:3)/3),s=0===t||3===t?0:1,o.push(-i,0,n),l.push(0,1,0),h.push(a,s),e<3&&t<3&&(c.push(u+3+1,u+1,u),c.push(u+3+1,u+3+2,u+1)),u++;var d={normals:l,uvs:h,indices:c};return Js(this._device,o,d)},t._onSetFrames=function(e){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()},t._onFrameChanged=function(e,t){var i=this._frameKeys.indexOf(e);i<0||(t?0===this.renderMode&&(this._meshes[i]=this._createSimpleMesh(t)):this._meshes[i]=null,this.fire("set:meshes"))},t._onFrameRemoved=function(e){var t=this._frameKeys.indexOf(e);t<0||(this._meshes[t]=null,this.fire("set:meshes"))},t.startUpdate=function(){this._updatingProperties=!0,this._meshesDirty=!1},t.endUpdate=function(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1},t.destroy=function(){for(var e,t=_(this._meshes);!(e=t()).done;){var i=e.value;i&&i.destroy()}this._meshes.length=0},c(e,[{key:"frameKeys",get:function(){return this._frameKeys},set:function(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",e)}},{key:"atlas",get:function(){return this._atlas},set:function(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=e,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",e))}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),0!==t&&0!==e||this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}},{key:"meshes",get:function(){return this._meshes}}]),e}(p);function Sl(e){this.resource&&(this.resource.atlas=e.resource)}function wl(e){this.registry.load(e)}var Cl=function(){function e(e,t){this._assets=e,this._device=t,this.maxRetries=0}var t=e.prototype;return t.load=function(e,i){"string"==typeof e&&(e={load:e,original:e}),".json"===C.getExtension(e.original)&&q.get(e.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,t){e?i(e):i(null,t)})},t.open=function(e,t){var i=new Ml(this._device);return e&&(i.__data=t),i},t.patch=function(e,t){var i=e.resource;if(i.__data&&(e.data.pixelsPerUnit=i.__data.pixelsPerUnit,e.data.renderMode=i.__data.renderMode,e.data.frameKeys=i.__data.frameKeys,i.__data.textureAtlasAsset)){var n=t.getByUrl(i.__data.textureAtlasAsset);n&&(e.data.textureAtlasAsset=n.id)}i.startUpdate(),i.renderMode=e.data.renderMode,i.pixelsPerUnit=e.data.pixelsPerUnit,i.frameKeys=e.data.frameKeys,this._updateAtlas(e),i.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)},t._updateAtlas=function(e){var t=e.resource;if(e.data.textureAtlasAsset){this._assets.off("load:"+e.data.textureAtlasAsset,Sl,e),this._assets.on("load:"+e.data.textureAtlasAsset,Sl,e);var i=this._assets.get(e.data.textureAtlasAsset);i&&i.resource?t.atlas=i.resource:i?this._assets.load(i):(this._assets.off("add:"+e.data.textureAtlasAsset,wl,e),this._assets.on("add:"+e.data.textureAtlasAsset,wl,e))}else t.atlas=null},t._onAssetChange=function(e,t,i,n){"data"===t&&i&&i.textureAtlasAsset&&n&&i.textureAtlasAsset!==n.textureAtlasAsset&&(this._assets.off("load:"+n.textureAtlasAsset,Sl,e),this._assets.off("add:"+n.textureAtlasAsset,wl,e))},e}(),Pl=function(){function e(e,t){this._app=e,this._data=t,this._templateRoot=null}var t=e.prototype;return t.instantiate=function(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()},t._parseTemplate=function(){var e=new Ho(this._app,!0);this._templateRoot=e.parse(this._data)},e}(),Tl=function(){function e(e){this._app=e}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i}),q.get(i.load,{},function(e,t){e?n("Error requesting template: "+i.original):n(e,t)})},t.open=function(e,t){return new Pl(this._app,t)},e}(),Al=function(){function e(){this.maxRetries=0}var t=e.prototype;return t.load=function(i,n){"string"==typeof i&&(i={load:i,original:i}),q.get(i.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,t){e?n("Error loading text resource: "+i.original+" ["+e+"]"):n(null,t)})},t.open=function(e,t){return t},t.patch=function(e,t){},e}(),El=function(t){function e(){var e;return(e=t.call(this)||this)._texture=null,e._frames=null,e}u(e,t);var i=e.prototype;return i.setFrame=function(e,t){var i=this._frames[e];i?(i.rect.copy(t.rect),i.pivot.copy(t.pivot),i.border.copy(t.border)):(i={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=i),this.fire("set:frame",e.toString(),i)},i.removeFrame=function(e){var t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t))},i.destroy=function(){this._texture&&this._texture.destroy()},c(e,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this.fire("set:texture",e)}},{key:"frames",get:function(){return this._frames},set:function(e){this._frames=e,this.fire("set:frames",e)}}]),e}(p),Rl={repeat:0,clamp:1,mirror:2},Dl={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Il=/^data\.frames\.(\d+)$/,kl=function(){function e(e){this._loader=e,this.maxRetries=0}var t=e.prototype;return t.load=function(n,a){"string"==typeof n&&(n={load:n,original:n});var s=this,e=this._loader.getHandler("texture");if(".json"!==C.getExtension(n.original))return e.load(n,a);q.get(n.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,i){if(e)a(e);else{var t=n.original.replace(".json",".png");s._loader.load(t,"texture",function(e,t){e?a(e):a(null,{data:i,texture:t})})}})},t.open=function(e,t){var i=new El;if(t.texture&&t.data)i.texture=t.texture,i.__data=t.data;else{var n=this._loader.getHandler("texture").open(e,t);if(!n)return null;i.texture=n}return i},t.patch=function(e,t){e.resource.__data&&(void 0!==e.resource.__data.minfilter&&(e.data.minfilter=e.resource.__data.minfilter),void 0!==e.resource.__data.magfilter&&(e.data.magfilter=e.resource.__data.magfilter),void 0!==e.resource.__data.addressu&&(e.data.addressu=e.resource.__data.addressu),void 0!==e.resource.__data.addressv&&(e.data.addressv=e.resource.__data.addressv),void 0!==e.resource.__data.mipmaps&&(e.data.mipmaps=e.resource.__data.mipmaps),void 0!==e.resource.__data.anisotropy&&(e.data.anisotropy=e.resource.__data.anisotropy),void 0!==e.resource.__data.rgbm&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data);var i=e.resource.texture;if(i&&(i.name=e.name,e.data.hasOwnProperty("minfilter")&&i.minFilter!==Dl[e.data.minfilter]&&(i.minFilter=Dl[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&i.magFilter!==Dl[e.data.magfilter]&&(i.magFilter=Dl[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&i.addressU!==Rl[e.data.addressu]&&(i.addressU=Rl[e.data.addressu]),e.data.hasOwnProperty("addressv")&&i.addressV!==Rl[e.data.addressv]&&(i.addressV=Rl[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&i.mipmaps!==e.data.mipmaps&&(i.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&i.anisotropy!==e.data.anisotropy&&(i.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){var n=e.data.rgbm?Qe:Ze;i.type!==n&&(i.type=n)}e.resource.texture=i;var a={};for(var s in e.data.frames){var r=e.data.frames[s];a[s]={rect:new ee(r.rect),pivot:new J(r.pivot),border:new ee(r.border)}}e.resource.frames=a,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)},t._onAssetChange=function(e,t,i){var n;if("data"===t||"data.frames"===t){var a={};for(var s in i.frames)n=i.frames[s],a[s]={rect:new ee(n.rect),pivot:new J(n.pivot),border:new ee(n.border)};e.resource.frames=a}else{var r=t.match(Il);if(r){var o=r[1];i?(e.resource.frames[o]?((n=e.resource.frames[o]).rect.set(i.rect[0],i.rect[1],i.rect[2],i.rect[3]),n.pivot.set(i.pivot[0],i.pivot[1]),n.border.set(i.border[0],i.border[1],i.border[2],i.border[3])):e.resource.frames[o]={rect:new ee(i.rect),pivot:new J(i.pivot),border:new ee(i.border)},e.resource.fire("set:frame",o,e.resource.frames[o])):e.resource.frames[o]&&(delete e.resource.frames[o],e.resource.fire("remove:frame",o))}}},e}();function Ll(){var M,S,w,C={astc:10,dxt:2,etc1:0,etc2:0,pvr:8,atc:11,none:14},P={astc:10,dxt:3,etc1:16,etc2:1,pvr:9,atc:12,none:16},T=function(e){for(var t=0;t<e.length;t+=4){var i=e[t+3],n=e[t+1];e[t+0]=i,e[t+2]=(void 0,a=i*(2/255)-1,s=n*(2/255)-1,r=Math.sqrt(1-Math.min(1,a*a+s*s)),Math.max(0,Math.min(255,Math.floor(.5*(r+1)*255)))),e[t+3]=255}var a,s,r;return e},A=function(e){for(var t=new Uint16Array(e.length/4),i=0;i<e.length;i+=4){var n=e[i+0],a=e[i+1],s=e[i+2];t[i/4]=(248&n)<<8|(252&a)<<3|s>>3}return t},E=function(){return"undefined"!=typeof performance?performance.now():0},a=function(e,t,i){try{var n=function(e,t,i){var n=E(),a=new M.BasisFile(new Uint8Array(t)),s=a.getImageWidth(0,0),r=a.getImageHeight(0,0),o=a.getNumImages(),l=a.getNumLevels(0),h=!!a.getHasAlpha(),c=a.isUASTC&&a.isUASTC();if(!(s&&r&&o&&l))throw a.close(),a.delete(),new Error("Invalid image dimensions url="+e+" width="+s+" height="+r+" images="+o+" levels="+l);var u,d,p=function(n,e,t){if(c){if(n.formats.astc)return"astc"}else if(e){if(n.formats.etc2)return"etc2"}else if(n.formats.etc1||n.formats.etc2)return"etc1";return function(e){for(var t=0;t<e.length;++t){var i=e[t];if(n.formats[i])return i}return"none"}(e?w:S)}(i.deviceDetails,h),f=!!i.isGGGR&&"pvr"===p;if(f)u=13;else{var m=0!=(s&s-1)||0!=(r&r-1);((8===(u=h?P[p]:C[p])||9===u)&&(m||s!==r)||!i.deviceDetails.webgl2&&m)&&(u=h?13:14)}if(!a.startTranscoding())throw a.close(),a.delete(),new Error("Failed to start transcoding url="+e);for(var v=[],g=0;g<l;++g){var _=a.getImageTranscodedSizeInBytes(0,g,u),y=new Uint8Array(_);if(!a.transcodeImage(y,0,g,u,1,0))throw a.close(),a.delete(),new Error("Failed to transcode image url="+e);var b=14===u||16===u;v.push(b?new Uint16Array(y.buffer):y)}if(a.close(),a.delete(),f)for(u=14,d=0;d<v.length;++d)v[d]=A(T(v[d]));var x=13!==u&&14!==u&&16!==u;return{format:function(e,t){switch(e){case 0:return t.formats.etc1?21:22;case 1:return 23;case 2:return 8;case 3:return 10;case 8:return 26;case 9:return 27;case 10:return 28;case 11:return 29;case 12:return 30;case 13:return 7;case 14:return 3;case 16:return 5}}(u,i.deviceDetails),width:x?s+3&-4:s,height:x?r+3&-4:r,levels:v,cubemap:!1,mipmaps:!0,transcodeTime:E()-n,url:e,unswizzledGGGR:f}}(e,t,i);n.levels=n.levels.map(function(e){return e.buffer}),self.postMessage({url:e,data:n},n.levels)}catch(t){self.postMessage({url:e,err:t})}},s=[];self.onmessage=function(e){var i,t,n=e.data;switch(n.type){case"init":i=n.config,t=function(){for(var e=0;e<s.length;++e)a(s[e].url,s[e].data,s[e].options);s.length=0},self.importScripts(i.basisUrl),self.BASIS(i.module?{instantiateWasm:function(e,t){return WebAssembly.instantiate(i.module,e).then(function(e){t(e)}).catch(function(e){}),{}}}:null).then(function(e){e.initializeBasis(),M=e,S=i.rgbPriority,w=i.rgbaPriority,t()});break;case"transcode":M?a(n.url,n.data,n.options):s.push(n)}}}var Ol=function(){function e(){this.callbacks={},this.queue=[],this.clients=[]}var t=e.prototype;return t.enqueueJob=function(e,t,i,n){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(i);else{this.callbacks[e]=[i];var a={url:e,data:t,options:n};0<this.clients.length?this.clients.shift().run(a):this.queue.push(a)}},t.enqueueClient=function(e){0<this.queue.length?e.run(this.queue.shift()):this.clients.push(e)},t.handleResponse=function(e,t,i){var n=this.callbacks[e];if(t)for(var a=0;a<n.length;++a)n[a](t);else{3===i.format||5===i.format?i.levels=i.levels.map(function(e){return new Uint16Array(e)}):i.levels=i.levels.map(function(e){return new Uint8Array(e)});for(var s=0;s<n.length;++s)n[s](null,i)}delete this.callbacks[e]},e}(),Fl=function(){function e(e,t,i){var n=this;this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",function(e){var t=e.data;n.queue.handleResponse(t.url,t.err,t.data),n.eager||n.queue.enqueueClient(n)}),this.worker.postMessage({type:"init",config:t}),this.eager=i}return e.prototype.run=function(e){this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},[e.data]),this.eager&&this.queue.enqueueClient(this)},e}(),zl=["etc1","etc2","astc","dxt","pvr","atc"],Bl=["astc","dxt","etc2","pvr","atc"],Vl=new Ol,Ul=null,Nl=!1;var Gl=null,Wl=function(){function e(e,t){this.device=t,this.maxRetries=0}var t=e.prototype;return t.load=function(u,d,p){var f=this.device,e={cache:!0,responseType:"arraybuffer",retry:0<this.maxRetries,maxRetries:this.maxRetries};q.get(u.load,e,function(e,t){var i,n,a,s,r,o,l,h,c;e?d(e,t):(s=f,r=u.load,o=t,l=d,h={isGGGR:0!=(8&(null==p||null==(i=p.file)||null==(n=i.variants)||null==(a=n.basis)?void 0:a.opt))},function(e){if(!Nl){if(e){if(e.lazyInit)return Ul=e}else e=Ul||{};if(!e.glueUrl||!e.wasmUrl||!e.fallbackUrl){var t=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find(function(e){return"BASIS"===e.moduleName});if(t){var i=window.ASSET_PREFIX||"";e.glueUrl||(e.glueUrl=i+t.glueUrl),e.wasmUrl||(e.wasmUrl=i+t.wasmUrl),e.fallbackUrl||(e.fallbackUrl=i+t.fallbackUrl)}}if(e.glueUrl||e.wasmUrl||e.fallbackUrl){Nl=!0;var n=Math.max(1,Math.min(16,e.numWorkers||1)),a=1===e.numWorkers||!e.hasOwnProperty("eagerWorkers")||e.eagerWorkers;e.rgbPriority=e.rgbPriority||zl,e.rgbaPriority=e.rgbaPriority||Bl,function(n,a){var i=function(e,t){var i;a(null,{workerUrl:URL.createObjectURL((i="("+Ll.toString()+")()\n\n",new File([i],"basis_worker.js",{type:"application/javascript"}))),basisUrl:URL.createObjectURL(e),module:t,rgbPriority:n.rgbPriority,rgbaPriority:n.rgbaPriority})};if(n.glueUrl&&n.wasmUrl&&function(){try{if("object"==("undefined"==typeof WebAssembly?"undefined":dx(WebAssembly))&&"function"==typeof WebAssembly.instantiate){var e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1}()){var s=null,r=null;q.get(n.glueUrl,{responseType:"blob"},function(e,t){e?a(e):r?i(t,r):s=t});var e=fetch(n.wasmUrl),t=function(){e.then(function(e){return e.arrayBuffer()}).then(function(e){return WebAssembly.compile(e)}).then(function(e){s?i(s,e):r=e}).catch(function(e){a(e,null)})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(e).then(function(e){s?i(s,e):r=e}).catch(function(e){t()}):t()}else q.get(n.fallbackUrl,{responseType:"blob"},function(e,t){e?a(e,null):i(t,null)})}(e,function(e,t){if(e);else for(var i=0;i<n;++i)Vl.enqueueClient(new Fl(Vl,t,a))})}}}(),Gl||(Gl={webgl2:s.webgl2,formats:(c=s,{astc:!!c.extCompressedTextureASTC,atc:!!c.extCompressedTextureATC,dxt:!!c.extCompressedTextureS3TC,etc1:!!c.extCompressedTextureETC1,etc2:!!c.extCompressedTextureETC,pvr:!!c.extCompressedTexturePVRTC})}),Vl.enqueueJob(r,o,l,{deviceDetails:Gl,isGGGR:!(null==h||!h.isGGGR)}),Nl||d('Basis module not found. Asset "'+p.name+'" basis texture variant will not be loaded.'))})},t.open=function(e,t,i){var n=new Kt(i,{name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:t.format,cubemap:t.cubemap,levels:t.levels});return n.upload(),n},e}(),Hl=function(){function e(e){this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0,this.useImageBitmap=!1}var t=e.prototype;return t.load=function(e,t,i){var n;i&&i.options&&i.options.hasOwnProperty("crossOrigin")?n=i.options.crossOrigin:Vr.test(e.load)&&(n=this.crossOrigin),this.useImageBitmap?this._loadImageBitmap(e.load,e.original,n,t):this._loadImage(e.load,e.original,n,t)},t.open=function(e,t,i){var n=C.getExtension(e).toLowerCase(),a=".jpg"===n||".jpeg"===n?6:7,s=new Kt(i,{name:e,width:t.width,height:t.height,format:a});return s.setSource(t),s},t._loadImage=function(i,n,e,a){var s=new Image;e&&(s.crossOrigin=e);var r,o=0,l=this.maxRetries;s.onload=function(){a(null,s)},s.onerror=function(){if(!r)if(0<l&&++o<=l){var e=100*Math.pow(2,o),t=0<=i.indexOf("?")?"&":"?";r=setTimeout(function(){s.src=i+t+"retry="+Date.now(),r=null},e)}else a("Error loading Texture from: '"+n+"'")},s.src=i},t._loadImageBitmap=function(e,t,i,n){var a={cache:!0,responseType:"blob",retry:0<this.maxRetries,maxRetries:this.maxRetries};q.get(e,a,function(e,t){e?n(e):createImageBitmap(t,{premultiplyAlpha:"none"}).then(function(e){n(null,e)}).catch(function(e){n(e)})})},e}(),jl=[1481919403,3140563232,169478669],Xl={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:we},ql=function(){function e(e){this.maxRetries=0}var t=e.prototype;return t.load=function(e,t,i){var n={cache:!0,responseType:"arraybuffer",retry:0<this.maxRetries,maxRetries:this.maxRetries};q.get(e.load,n,t)},t.open=function(e,t,i){var n=this.parse(t);if(!n)return null;var a=new Kt(i,{name:e,addressU:n.cubemap?1:0,addressV:n.cubemap?1:0,width:n.width,height:n.height,format:n.format,cubemap:n.cubemap,levels:n.levels});return a.upload(),a},t.parse=function(e){var t=new Uint32Array(e);if(jl[0]!==t[0]||jl[1]!==t[1]||jl[2]!==t[2])return null;var i={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(1<i.pixelDepth)return null;if(0!==i.numberOfArrayElements)return null;var n=Xl[i.glInternalFormat];if(void 0===n)return null;for(var a,s,r,o=16+i.bytesOfKeyValueData/4,l=1<i.numberOfFaces,h=[],c=0;c<(i.numberOfMipmapLevels||1);c++){var u=t[o++];l&&h.push([]);for(var d=l?h[c]:h,p=0;p<(l?6:1);++p)d.push((a=e,s=4*o,r=u,18===n?new Uint32Array(a,s,r/4):new Uint8Array(a,s,r))),o+=u+3>>2}return{format:n,width:i.pixelWidth,height:i.pixelHeight,levels:h,cubemap:l}},e}(),$l=function(){function e(e){this.maxRetries=0}var t=e.prototype;return t.load=function(e,t,i){var n={cache:!0,responseType:"arraybuffer",retry:0<this.maxRetries,maxRetries:this.maxRetries};q.get(e.load,n,t)},t.open=function(e,t,i){var n,a=new Uint32Array(t,0,32),s=a[4],r=a[3],o=Math.max(a[7],1),l=4===a[20],h=a[21],c=a[22],u=65024===a[28],d=!1,p=!1,f=!1,m=!1,v=!1,g=null;if(l?827611204===h?(g=8,d=!0):894720068===h?(g=10,d=!0):116===h?(g=Ce,p=!0):826496069===h?(g=21,f=d=!0):825438800===h||825504336===h?(g=825438800===h?24:25,m=d=!0):825439312!==h&&825504848!==h||(g=825439312===h?26:27,v=d=!0):32===c&&(g=7),!g)return(n=new Kt(i,{width:4,height:4,format:6})).name="dds-legacy-empty",n;n=new Kt(i,{name:e,addressU:u?1:0,addressV:u?1:0,width:s,height:r,format:g,cubemap:u});for(var _,y=128,b=u?6:1,x=827611204===h?8:16,M=0;M<b;M++)for(var S=s,w=r,C=0;C<o;C++){_=d?f?Math.floor((S+3)/4)*Math.floor((w+3)/4)*8:m?Math.max(S,16)*Math.max(w,8)/4:v?Math.max(S,8)*Math.max(w,8)/2:Math.floor((S+4-1)/4)*Math.floor((w+4-1)/4)*x:S*w*4;var P=p?new Float32Array(t,y,_):new Uint8Array(t,y,_);u?(n._levels[C]||(n._levels[C]=[]),n._levels[C][M]=P):n._levels[C]=P,y+=p?4*_:_,S=Math.max(.5*S,1),w=Math.max(.5*w,1)}return n.upload(),n},e}(),Yl=function(){function e(e){this.view=new DataView(e),this.offset=0}var t=e.prototype;return t.readLine=function(){for(var e=this.view,t="";!(this.offset>=e.byteLength);){var i=String.fromCharCode(this.readUint8());if("\n"===i)break;t+=i}return t},t.readUint8=function(){return this.view.getUint8(this.offset++)},t.readUint8s=function(e){for(var t=this.view,i=0;i<e.length;++i)e[i]=t.getUint8(this.offset++)},t.peekUint8s=function(e){for(var t=this.view,i=0;i<e.length;++i)e[i]=t.getUint8(this.offset+i)},e}(),Kl=function(){function e(e){this.maxRetries=0}var t=e.prototype;return t.load=function(e,t,i){var n={cache:!0,responseType:"arraybuffer",retry:0<this.maxRetries,maxRetries:this.maxRetries};q.get(e.load,n,t)},t.open=function(e,t,i){var n=this.parse(t);if(!n)return null;var a=new Kt(i,{name:e,addressU:0,addressV:1,minFilter:2,magFilter:0,width:n.width,height:n.height,levels:n.levels,format:7,type:Je,mipmaps:!1});return a.upload(),a},t.parse=function(e){var t=new Yl(e),i=t.readLine();if(!i.startsWith("#?RADIANCE")&&!i.startsWith("#?RGBE"))return this._error("radiance header has invalid magic"),null;for(var n={};;){var a=t.readLine();if(0===a.length)break;var s=a.split("=");2===s.length&&(n[s[0]]=s[1])}if(!n.hasOwnProperty("FORMAT"))return this._error("radiance header missing FORMAT variable"),null;var r=t.readLine().split(" ");if(4!==r.length)return this._error("radiance header has invalid resolution"),null;var o=parseInt(r[1],10),l=parseInt(r[3],10),h=this._readPixels(t,l,o,"-Y"===r[0]);return h?{width:l,height:o,levels:[h]}:null},t._readPixels=function(e,t,i,n){if(t<8||32767<t)return this._readPixelsFlat(e,t,i);var a=[0,0,0,0];if(e.peekUint8s(a),2!==a[0]||2!==a[1]||0!=(128&a[2]))return this._readPixelsFlat(e,t,i);var s,r,o,l,h,c,u=new ArrayBuffer(t*i*4),d=new Uint8Array(u),p=n?4*t*(i-1):0;for(r=0;r<i;++r){if(e.readUint8s(a),(a[2]<<8)+a[3]!==t)return this._error("radiance has invalid scanline width"),null;for(l=0;l<4;++l)for(s=0;s<t;)if(128<(h=e.readUint8())){if(s+(h-=128)>t)return this._error("radiance has invalid scanline data"),null;for(c=e.readUint8(),o=0;o<h;++o)d[p+l+4*s++]=c}else{if(0===h||t<s+h)return this._error("radiance has invalid scanline data"),null;for(o=0;o<h;++o)d[p+l+4*s++]=e.readUint8()}p+=4*t*(n?-1:1)}return d},t._readPixelsFlat=function(e,t,i){return e.view.buffer.byteLength-e.offset==t*i*4?new Uint8Array(e.view.buffer,e.offset):null},t._error=function(e){},e}(),Zl={repeat:0,clamp:1,mirror:2},Ql={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Jl={default:Ze,rgbm:Qe,rgbe:Je,swizzleGGGR:et},eh=function(){function e(e,t,i){this._device=e,this._assets=t,this._loader=i,this.imgParser=new Hl(t),this.parsers={dds:new $l(t),ktx:new ql(t),basis:new Wl(t,e),hdr:new Kl(t)}}var t=e.prototype;return t._getUrlWithoutParams=function(e){return 0<=e.indexOf("?")?e.split("?")[0]:e},t._getParser=function(e){var t=C.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser},t.load=function(e,t,i){null===e&&(e=""),"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,i)},t.open=function(e,t,i){if(e){var n=this._getParser(e).open(e,t,this._device);return null===n?n=new Kt(this._device,{width:4,height:4,format:6}):(function(e){var t=Math.log2(Math.max(e._width,e._height))+1;if(!(7!==e._format&&e._format!==Ce||e._volume||e._compressed||1===e._levels.length||e._levels.length===t||((i=e._cubemap?e._levels[0][0]:e._levels[0])instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof HTMLVideoElement))){for(var i,n=function(e,t,i){for(var n=Math.max(1,e>>1),a=Math.max(1,t>>1),s=new i.constructor(n*a*4),r=Math.floor(e/n),o=Math.floor(t/a),l=r*o,h=0;h<a;++h)for(var c=0;c<n;++c)for(var u=0;u<4;++u){for(var d=0,p=0;p<o;++p)for(var f=0;f<r;++f)d+=i[4*(c*r+f+(h*o+p)*e)+u];s[4*(c+h*n)+u]=d/l}return s},a=e._levels.length;a<t;++a){var s=Math.max(1,e._width>>a-1),r=Math.max(1,e._height>>a-1);if(e._cubemap){for(var o=[],l=0;l<6;++l)o.push(n(s,r,e._levels[a-1][l]));e._levels.push(o)}else e._levels.push(n(s,r,e._levels[a-1]))}e._levelsUpdated=e._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}}(n),t.unswizzledGGGR&&(i.file.variants.basis.opt&=-9)),n}},t.patch=function(e,t){var i=e.resource;if(i){e.id&&(i.id=e.id),e.name&&0<e.name.length&&(i.name=e.name);var n=e.data;if(n.hasOwnProperty("minfilter")&&(i.minFilter=Ql[n.minfilter]),n.hasOwnProperty("magfilter")&&(i.magFilter=Ql[n.magfilter]),i.cubemap||(n.hasOwnProperty("addressu")&&(i.addressU=Zl[n.addressu]),n.hasOwnProperty("addressv")&&(i.addressV=Zl[n.addressv])),n.hasOwnProperty("mipmaps")&&(i.mipmaps=n.mipmaps),n.hasOwnProperty("anisotropy")&&(i.anisotropy=n.anisotropy),n.hasOwnProperty("flipY")&&(i.flipY=!!n.flipY),n.hasOwnProperty("type"))i.type=Jl[n.type];else if(n.hasOwnProperty("rgbm")&&n.rgbm)i.type=Qe;else if(e.file&&e.getPreferredFile){var a=e.getPreferredFile();a&&a.opt&&0!=(8&a.opt)&&(i.type=et)}}},c(e,[{key:"crossOrigin",get:function(){return this.imgParser.crossOrigin},set:function(e){this.imgParser.crossOrigin=e}},{key:"maxRetries",get:function(){return this.imgParser.maxRetries},set:function(e){for(var t in this.imgParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}}]),e}(),th=function(){function e(e){void 0===e&&(e=null),this._index={},this._key=e}var t=e.prototype;return t.addItem=function(e){for(var t,i=_(e.tags._list);!(t=i()).done;){var n=t.value;this.add(n,e)}},t.removeItem=function(e){for(var t,i=_(e.tags._list);!(t=i()).done;){var n=t.value;this.remove(n,e)}},t.add=function(e,t){this._index[e]&&-1!==this._index[e].list.indexOf(t)||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))},t.remove=function(e,t){if(this._index[e]&&(!this._key||this._index[e].keys[t[this._key]])){var i=this._index[e].list.indexOf(t);-1!==i&&(this._index[e].list.splice(i,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e])}},t.find=function(e){for(var t,i,n,a,s,r=this,o={},l=[],h=function(e,t){return r._index[e].list.length-r._index[t].list.length},c=0;c<e.length;c++){if((i=e[c])instanceof Array){if(0===i.length)continue;if(1!==i.length){s=!1;for(var u=0;u<i.length;u++)if(!this._index[i[u]]){s=!0;break}if(s)continue;1===(a=(n=i.slice(0).sort(h)).slice(1)).length&&(a=a[0]);for(var d=0;d<this._index[n[0]].list.length;d++)t=this._index[n[0]].list[d],(this._key?!o[t[this._key]]:-1===l.indexOf(t))&&t.tags.has(a)&&(this._key&&(o[t[this._key]]=!0),l.push(t));continue}i=i[0]}if(i&&"string"==typeof i&&this._index[i])for(var p=0;p<this._index[i].list.length;p++)t=this._index[i].list[p],this._key?o[t[this._key]]||(o[t[this._key]]=!0,l.push(t)):-1===l.indexOf(t)&&l.push(t)}return l},e}(),ih=function(i){function e(e){var t;return(t=i.call(this)||this)._loader=e,t._assets=[],t._cache={},t._names={},t._tags=new th("_id"),t._urls={},t.prefix=null,t}u(e,i);var t=e.prototype;return t.list=function(i){return i=i||{},this._assets.filter(function(e){var t=!0;return void 0!==i.preload&&(t=e.preload===i.preload),t})},t.add=function(e){var t,i=this._assets.push(e)-1;this._cache[e.id]=i,this._names[e.name]||(this._names[e.name]=[]),this._names[e.name].push(i),e.file&&(t=e.file.url,this._urls[t]=i),(e.registry=this)._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),t&&this.fire("add:url:"+t,e),e.preload&&this.load(e)},t.remove=function(e){var t=this._cache[e.id],i=e.file?e.file.url:null;if(void 0!==t){this._assets.splice(t,1),delete this._cache[e.id],this._names={},this._urls=[];for(var n=0,a=this._assets.length;n<a;n++){var s=this._assets[n];this._cache[s.id]=n,this._names[s.name]||(this._names[s.name]=[]),this._names[s.name].push(n),s.file&&(this._urls[s.file.url]=n)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),i&&this.fire("remove:url:"+i,e),!0}return!1},t.get=function(e){var t=this._cache[e];return this._assets[t]},t.getByUrl=function(e){var t=this._urls[e];return this._assets[t]},t.load=function(a){if(!a.loading&&!a.loaded){var s=this,t=a.getPreferredFile(),r=function(e){e instanceof Array?a.resources=e:a.resource=e,s._loader.patch(a,s),s.fire("load",a),s.fire("load:"+a.id,a),t&&t.url&&s.fire("load:url:"+t.url,a),a.fire("load",a)};if(t||"cubemap"===a.type)this.fire("load:start",a),this.fire("load:"+a.id+":start",a),a.loading=!0,s._loader.load(a.getFileUrl(),a.type,function(e,t,i){if(a.loaded=!0,a.loading=!1,e)s.fire("error",e,a),s.fire("error:"+a.id,e,a),a.fire("error",e,a);else{if(!gl.legacy&&"script"===a.type){var n=s._loader.getHandler("script");n._cache[a.id]&&n._cache[a.id].parentNode===document.head&&document.head.removeChild(n._cache[a.id]),n._cache[a.id]=i}r(t)}},a);else{var e=s._loader.open(a.type,a.data);a.loaded=!0,r(e)}}},t.loadFromUrl=function(e,t,i){this.loadFromUrlAndFilename(e,null,t,i)},t.loadFromUrlAndFilename=function(e,t,n,a){var s=this,i=C.getBasename(t||e),r={filename:t||i,url:e},o=s.getByUrl(e);if(o){if(o.loaded)return void a(o.loadFromUrlError||null,o)}else o=new Kr(i,n,r),s.add(o);var l=function(t){t.once("load",function(i){"material"===n?s._loadTextures(i,function(e,t){a(e,i)}):a(null,i)}),t.once("error",function(e){e&&(this.loadFromUrlError=e),a(e,t)}),s.load(t)};o.resource?a(null,o):"model"===n?s._loadModel(o,l):l(o)},t._loadModel=function(n,a){var t=this,e=n.getFileUrl(),i=C.getExtension(e);if(".json"===i||".glb"===i){var s=C.getDirectory(e),r=C.getBasename(e),o=C.join(s,r.replace(i,".mapping.json"));this._loader.load(o,"json",function(e,i){e?(n.data={mapping:[]},a(n)):t._loadMaterials(n,i,function(e,t){n.data=i,a(n)})})}else a(n)},t._loadMaterials=function(e,t,n){for(var a=this,s=[],r=0,i=function(e,i){a._loadTextures(i,function(e,t){s.push(i),s.length===r&&n(null,s)})},o=0;o<t.mapping.length;o++){var l=t.mapping[o].path;l&&(r++,a.loadFromUrl(e.getAbsoluteUrl(l),"material",i))}0===r&&n(null,s)},t._loadTextures=function(e,i){var n=[],a=0,t=e.data;if("path"===t.mappingFormat){for(var s=function(e,t){n.push(t),n.length===a&&i(null,n)},r=Hi,o=0;o<r.length;o++){var l=t[r[o]];l&&"string"==typeof l&&(a++,this.loadFromUrl(e.getAbsoluteUrl(l),"texture",s))}0===a&&i(null,n)}else i(null,n)},t.findAll=function(e,t){var i=this,n=this._names[e];if(n){var a=n.map(function(e){return i._assets[e]});return t?a.filter(function(e){return e.type===t}):a}return[]},t._onTagAdd=function(e,t){this._tags.add(e,t)},t._onTagRemove=function(e,t){this._tags.remove(e,t)},t.findByTag=function(){return this._tags.find(arguments)},t.filter=function(e){for(var t=[],i=0,n=this._assets.length;i<n;i++)e(this._assets[i])&&t.push(this._assets[i]);return t},t.find=function(e,t){var i=this.findAll(e,t);return 0<i.length?i[0]:null},e}(p),nh=function(){function e(e){this._assets=e,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)}var t=e.prototype;return t._onAssetAdded=function(e){if("bundle"===e.type){this._bundleAssets[e.id]=e,this._registerBundleEventListeners(e.id);for(var t=0,i=e.data.assets.length;t<i;t++)this._indexAssetInBundle(e.data.assets[t],e)}else this._assetsInBundles[e.id]&&this._indexAssetFileUrls(e)},t._registerBundleEventListeners=function(e){this._assets.on("load:"+e,this._onBundleLoaded,this),this._assets.on("error:"+e,this._onBundleError,this)},t._unregisterBundleEventListeners=function(e){this._assets.off("load:"+e,this._onBundleLoaded,this),this._assets.off("error:"+e,this._onBundleError,this)},t._indexAssetInBundle=function(e,t){if(this._assetsInBundles[e]){var i=this._assetsInBundles[e];-1===i.indexOf(t)&&i.push(t)}else this._assetsInBundles[e]=[t];var n=this._assets.get(e);n&&this._indexAssetFileUrls(n)},t._indexAssetFileUrls=function(e){var t=this._getAssetFileUrls(e);if(t)for(var i=0,n=t.length;i<n;i++){var a=t[i];this._urlsInBundles[a]=this._assetsInBundles[e.id]}},t._getAssetFileUrls=function(e){var t=e.getFileUrl();if(!t)return null;var i=[t=this._normalizeUrl(t)];if("font"===e.type)for(var n=e.data.info.maps.length,a=1;a<n;a++)i.push(t.replace(".png",a+".png"));return i},t._normalizeUrl=function(e){return e&&e.split("?")[0]},t._onAssetRemoved=function(e){if("bundle"===e.type){var t,i;for(i in delete this._bundleAssets[e.id],this._unregisterBundleEventListeners(e.id),this._assetsInBundles){var n=this._assetsInBundles[i];if(-1!==(t=n.indexOf(e))&&(n.splice(t,1),!n.length))for(var a in delete this._assetsInBundles[i],this._urlsInBundles)this._urlsInBundles[a]===n&&delete this._urlsInBundles[a]}this._onBundleError("Bundle "+e.id+" was removed",e)}else if(this._assetsInBundles[e.id]){delete this._assetsInBundles[e.id];for(var s=this._getAssetFileUrls(e),r=0,o=s.length;r<o;r++)delete this._urlsInBundles[s[r]]}},t._onBundleLoaded=function(o){o.resource?requestAnimationFrame(function(){if(this._fileRequests)for(var e in this._fileRequests){var t=this._urlsInBundles[e];if(t&&-1!==t.indexOf(o)){var i=decodeURIComponent(e),n=null;o.resource.hasBlobUrl(i)||(n="Bundle "+o.id+" does not contain URL "+e);for(var a=this._fileRequests[e],s=0,r=a.length;s<r;s++)n?a[s](n):a[s](null,o.resource.getBlobUrl(i));delete this._fileRequests[e]}}}.bind(this)):this._onBundleError("Bundle "+o.id+" failed to load",o)},t._onBundleError=function(e,t){for(var i in this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(i)){for(var n=this._fileRequests[i],a=0,s=n.length;a<s;a++)n[a](e);delete this._fileRequests[i]}},t._findLoadedOrLoadingBundleForUrl=function(e){var t=this._urlsInBundles[e];if(!t)return null;var i,n=t.length;for(i=0;i<n;i++)if(t[i].loaded&&t[i].resource)return t[i];for(i=0;i<n;i++)if(t[i].loading)return t[i];return null},t.listBundlesForAsset=function(e){return this._assetsInBundles[e.id]||null},t.list=function(){var e=[];for(var t in this._bundleAssets)e.push(this._bundleAssets[t]);return e},t.hasUrl=function(e){return!!this._urlsInBundles[e]},t.canLoadUrl=function(e){return!!this._findLoadedOrLoadingBundleForUrl(e)},t.loadUrl=function(e,t){var i=this._findLoadedOrLoadingBundleForUrl(e);if(i)if(i.loaded){var n=decodeURIComponent(e);if(!i.resource.hasBlobUrl(n))return void t("Bundle "+i.id+" does not contain URL "+e);t(null,i.resource.getBlobUrl(n))}else this._fileRequests.hasOwnProperty(e)?this._fileRequests[e].push(t):this._fileRequests[e]=[t];else t("URL "+e+" not found in any bundles")},t.destroy=function(){for(var e in this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this),this._bundleAssets)this._unregisterBundleEventListeners(e);this._assets=null,this._bundleAssets=null,this._assetsInBundles=null,this._urlsInBundles=null,this._fileRequests=null},e}(),ah=function(i){function e(e){var t;return(t=i.call(this)||this).app=e,t._scripts={},t._list=[],t}u(e,i);var t=e.prototype;return t.destroy=function(){this.app=null,this.off()},t.add=function(i){var o=this,l=i.__name;return this._scripts.hasOwnProperty(l)?(setTimeout(function(){if(i.prototype.swap){var e=o._scripts[l],t=o._list.indexOf(e);o._list[t]=i,o._scripts[l]=i,o.fire("swap",l,i),o.fire("swap:"+l,i)}}),!1):(this._scripts[l]=i,this._list.push(i),this.fire("add",l,i),this.fire("add:"+l,i),setTimeout(function(){if(o._scripts.hasOwnProperty(l)&&o.app&&o.app.systems&&o.app.systems.script){var e,t,i,n=o.app.systems.script._components,a=[],s=[];for(n.loopIndex=0;n.loopIndex<n.length;n.loopIndex++){var r=n.items[n.loopIndex];r._scriptsIndex[l]&&r._scriptsIndex[l].awaiting&&(r._scriptsData&&r._scriptsData[l]&&(i=r._scriptsData[l].attributes),(t=r.create(l,{preloading:!0,ind:r._scriptsIndex[l].ind,attributes:i}))&&a.push(t))}for(e=0;e<a.length;e++)a[e].__initializeAttributes();for(e=0;e<a.length;e++)a[e].enabled&&(a[e]._initialized=!0,s.push(a[e]),a[e].initialize&&a[e].initialize());for(e=0;e<s.length;e++)s[e].enabled&&!s[e]._postInitialized&&(s[e]._postInitialized=!0,s[e].postInitialize&&s[e].postInitialize())}}),!0)},t.remove=function(e){var t=e,i=e;if("string"!=typeof i?i=t.__name:t=this.get(i),this.get(i)!==t)return!1;delete this._scripts[i];var n=this._list.indexOf(t);return this._list.splice(n,1),this.fire("remove",i,t),this.fire("remove:"+i,t),!0},t.get=function(e){return this._scripts[e]||null},t.has=function(e){if("string"==typeof e)return this._scripts.hasOwnProperty(e);if(!e)return!1;var t=e.__name;return this._scripts[t]===e},t.list=function(){return this._list},e}(p),sh=function(){function e(){}var t=e.prototype;return t._validate=function(e){if(!e.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!e.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(e.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(var t=0,i=e.data.length;t<i;t++){var n=e.data[t];if(!n.info)throw new Error('pc.I18n#addData: missing "data['+t+'].info" field');if(!n.info.locale)throw new Error('pc.I18n#addData: missing "data['+t+'].info.locale" field');if("string"!=typeof n.info.locale)throw new Error('pc.I18n#addData: "data['+t+'].info.locale" must be a string');if(!n.messages)throw new Error('pc.I18n#addData: missing "data['+t+'].messages" field')}},t.parse=function(e){return e.data},e}(),rh=function(i){function e(e){var t;return(t=i.call(this)||this).locale=Dr,t._translations={},t._availableLangs={},t._app=e,t._assets=[],t._parser=new sh,t}u(e,i),e.findAvailableLocale=function(e,t){return Fr(e,t)};var t=e.prototype;return t.findAvailableLocale=function(e){if(this._translations[e])return e;var t=Or(e);return this._findFallbackLocale(e,t)},t.getText=function(e,t){var i,n=e;t||(t=this._locale,i=this._lang);var a=this._translations[t];return a||(i||(i=Or(t)),t=this._findFallbackLocale(t,i),a=this._translations[t]),a&&a.hasOwnProperty(e)&&(n=a[e],Array.isArray(n)&&(n=n[0]),null==n&&(n=e)),n},t.getPluralText=function(e,t,i){var n,a,s=e;i?n=Br(a=Or(i)):(i=this._locale,a=this._lang,n=this._pluralFn);var r=this._translations[i];if(r||(n=Br(a=Or(i=this._findFallbackLocale(i,a))),r=this._translations[i]),r&&r[e]&&n){var o=n(t);null==(s=r[e][o])&&(s=e)}return s},t.addData=function(e){var t;try{t=this._parser.parse(e)}catch(e){return}for(var i=0,n=t.length;i<n;i++){var a=t[i],s=a.info.locale,r=a.messages;if(!this._translations[s]){this._translations[s]={};var o=Or(s);this._availableLangs[o]||(this._availableLangs[o]=s)}Object.assign(this._translations[s],r),this.fire("data:add",s,r)}},t.removeData=function(e){var t,i;try{t=this._parser.parse(e)}catch(e){return}for(var n=0,a=t.length;n<a;n++){var s=t[n],r=s.info.locale,o=this._translations[r];if(o){var l=s.messages;for(i in l)delete o[i];var h=!1;for(i in o){h=!0;break}h||(delete this._translations[r],delete this._availableLangs[Or(r)]),this.fire("data:remove",r,l)}}},t.destroy=function(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()},t._findFallbackLocale=function(e,t){var i=Ir[e];return i&&this._translations[i]||(i=Ir[t])&&this._translations[i]||(i=this._availableLangs[t])&&this._translations[i]?i:Dr},t._onAssetAdd=function(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)},t._onAssetLoad=function(e){this.addData(e.resource)},t._onAssetChange=function(e){e.resource&&this.addData(e.resource)},t._onAssetRemove=function(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this)},t._onAssetUnload=function(e){e.resource&&this.removeData(e.resource)},c(e,[{key:"locale",get:function(){return this._locale},set:function(e){if(this._locale!==e){var t=Or(e);if("in"!==t||(n=t="id",e=-1!==(a=(i=e).indexOf("-"))?n+i.substring(a):n,this._locale!==e)){var i,n,a,s=this._locale;this._locale=e,this._lang=t,this._pluralFn=Br(this._lang),this.fire("set:locale",e,s)}}}},{key:"assets",get:function(){return this._assets},set:function(e){var t,i,n,a,s={};for(t=0,i=e.length;t<i;t++)s[n=e[t]instanceof Kr?e[t].id:e[t]]=!0;for(t=this._assets.length;t--;)s[n=this._assets[t]]||(this._app.assets.off("add:"+n,this._onAssetAdd,this),(a=this._app.assets.get(n))&&this._onAssetRemove(a),this._assets.splice(t,1));for(n in s)n=parseInt(n,10),-1===this._assets.indexOf(n)&&(this._assets.push(n),(a=this._app.assets.get(n))?this._onAssetAdd(a):this._app.assets.once("add:"+n,this._onAssetAdd,this))}}]),e}(p),oh="FILL_WINDOW",lh="KEEP_ASPECT",hh="AUTO",ch=function(n){function e(e,t){var i,s=g(i=n.call(this)||this);return i._app=e,i._device=e.graphicsDevice,i.id=t.displayId,i._frameData=null,window.VRFrameData&&(i._frameData=new window.VRFrameData),i.display=t,i._camera=null,i.sitToStandInv=new pe,i.leftView=new pe,i.leftProj=new pe,i.leftViewInv=new pe,i.leftPos=new de,i.rightView=new pe,i.rightProj=new pe,i.rightViewInv=new pe,i.rightPos=new de,i.combinedPos=new de,i.combinedView=new pe,i.combinedProj=new pe,i.combinedViewInv=new pe,i.combinedFov=0,i.combinedAspect=0,i.presenting=!1,s._presentChange=function(e){if((e.display?e.display:e.detail&&e.detail.display?e.detail.display:e.detail&&e.detail.vrdisplay?e.detail.vrdisplay:s.display)===s.display){if(s.presenting=s.display&&s.display.isPresenting,s.presenting){var t=s.display.getEyeParameters("left"),i=s.display.getEyeParameters("right"),n=2*Math.max(t.renderWidth,i.renderWidth),a=Math.max(t.renderHeight,i.renderHeight);s._app.graphicsDevice.setResolution(n,a),s._app._allowResize=!1}else s._app.setCanvasResolution(hh),s._app._allowResize=!0;s.fire("beforepresentchange",s),s.fire("presentchange",s)}},window.addEventListener("vrdisplaypresentchange",s._presentChange,!1),i}u(e,n);var t=e.prototype;return t.destroy=function(){window.removeEventListener("vrdisplaypresentchange",self._presentChange),this._camera&&(this._camera.vrDisplay=null),this._camera=null},t.poll=function(){if(this.display){this.display.getFrameData(this._frameData),this.leftProj.data=this._frameData.leftProjectionMatrix,this.rightProj.data=this._frameData.rightProjectionMatrix;var e=this.display.stageParameters;e?(this.sitToStandInv.set(e.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));var t=this.leftProj.data[3]+this.leftProj.data[0],i=this.leftProj.data[11]+this.leftProj.data[8],n=1/Math.sqrt(t*t+i*i);t*=n,i*=n;var a=-Math.atan2(i,t);t=this.rightProj.data[3]+this.rightProj.data[0],i=this.rightProj.data[11]+this.rightProj.data[8],t*=n=1/Math.sqrt(t*t+i*i),i*=n,a=Math.max(a,-Math.atan2(i,t)),a*=2,this.combinedFov=a;var s=this.rightProj.data[5]/this.rightProj.data[0];this.combinedAspect=s;var r=this.combinedView;r.copy(this.leftView),r.invert(),this.leftViewInv.copy(r);var o=this.combinedPos;o.x=this.leftPos.x=r.data[12],o.y=this.leftPos.y=r.data[13],o.z=this.leftPos.z=r.data[14],r.copy(this.rightView),r.invert(),this.rightViewInv.copy(r);var l=o.x-r.data[12],h=o.y-r.data[13],c=o.z-r.data[14],u=Math.sqrt(l*l+h*h+c*c);this.rightPos.x=r.data[12],this.rightPos.y=r.data[13],this.rightPos.z=r.data[14],o.x+=r.data[12],o.y+=r.data[13],o.z+=r.data[14],o.x*=.5,o.y*=.5,o.z*=.5;var d=.5*Math.PI,p=.5*a,f=Math.PI-(d+p),m=.5*u*Math.sin(f),v=r.data[8],g=r.data[9],_=r.data[10];r.data[12]=o.x+v*m,r.data[13]=o.y+g*m,r.data[14]=o.z+_*m,this.combinedViewInv.copy(r),r.invert(),this.combinedProj.setPerspective(a*Se.RAD_TO_DEG,s,this.display.depthNear+m,this.display.depthFar+m,!0)}},t.requestPresent=function(t){this.display?this.presenting?t&&t(new Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then(function(){t&&t()},function(e){t&&t(e)}):t&&t(new Error("No VrDisplay to requestPresent"))},t.exitPresent=function(e){this.display||e&&e(new Error("No VrDisplay to exitPresent")),this.presenting?this.display.exitPresent().then(function(){e&&e()},function(){e&&e(new Error("exitPresent failed"))}):e&&e(new Error("VrDisplay not presenting"))},t.requestAnimationFrame=function(e){this.display&&this.display.requestAnimationFrame(e)},t.submitFrame=function(){this.display&&this.display.submitFrame()},t.reset=function(){this.display&&this.display.resetPose()},t.setClipPlanes=function(e,t){this.display&&(this.display.depthNear=e,this.display.depthFar=t)},t.getFrameData=function(){if(this.display)return this._frameData},c(e,[{key:"capabilities",get:function(){return this.display?this.display.capabilities:{}}}]),e}(p),uh=function(i){function a(e){var t,n=g(t=i.call(this)||this);return t.isSupported=a.isSupported,t._index={},t.displays=[],t.display=null,t._app=e,t._onDisplayConnect=t._onDisplayConnect.bind(g(t)),t._onDisplayDisconnect=t._onDisplayDisconnect.bind(g(t)),n._attach(),t._getDisplays(function(e,t){if(e)n.fire("error",e);else{for(var i=0;i<t.length;i++)n._addDisplay(t[i]);n.fire("ready",n.displays)}}),t}u(a,i);var e=a.prototype;return e._attach=function(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect),window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},e._detach=function(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect),window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},e.destroy=function(){this._detach()},e.poll=function(){var e=this.displays.length;if(e)for(var t=0;t<e;t++)this.displays[t]._camera&&this.displays[t].poll()},e._getDisplays=function(t){navigator.getVRDisplays?navigator.getVRDisplays().then(function(e){t&&t(null,e)}):t&&t(new Error("WebVR not supported"))},e._addDisplay=function(e){if(!this._index[e.displayId]){var t=new ch(this._app,e);this._index[t.id]=t,this.displays.push(t),this.display||(this.display=t),this.fire("displayconnect",t)}},e._onDisplayConnect=function(e){e.detail&&e.detail.display?this._addDisplay(e.detail.display):this._addDisplay(e.display)},e._onDisplayDisconnect=function(e){var t;t=e.detail&&e.detail.display?e.detail.display.displayId:e.display.displayId;var i=this._index[t];if(i){i.destroy(),delete this._index[i.id];var n=this.displays.indexOf(i);this.displays.splice(n,1),this.display===i&&(this.displays.length?this.display=this.displays[0]:this.display=null),this.fire("displaydisconnect",i)}},a}(p);uh.isSupported="undefined"!=typeof navigator&&!!navigator.getVRDisplays;for(var dh="immersive-vr",ph="immersive-ar",fh="cpu-optimized",mh=[],vh=[],gh=function(a){function e(e,t,i){var n;return(n=a.call(this)||this).manager=e,n._xrHitTestSource=t,n._transient=i,n}u(e,a);var t=e.prototype;return t.remove=function(){if(this._xrHitTestSource){var e=this.manager.hitTest.sources,t=e.indexOf(this);-1!==t&&e.splice(t,1),this.onStop()}},t.onStop=function(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)},t.update=function(e){if(this._transient)for(var t=e.getHitTestResultsForTransientInput(this._xrHitTestSource),i=0;i<t.length;i++){var n=t[i],a=void 0;n.inputSource&&(a=this.manager.input._getByInputSource(n.inputSource)),this.updateHitResults(n.results,a)}else this.updateHitResults(e.getHitTestResults(this._xrHitTestSource))},t.updateHitResults=function(e,t){for(var i=0;i<e.length;i++){var n=e[i].getPose(this.manager._referenceSpace),a=mh.pop();a||(a=new de),a.copy(n.transform.position);var s=vh.pop();s||(s=new fe),s.copy(n.transform.orientation),this.fire("result",a,s,t),this.manager.hitTest.fire("result",this,a,s,t),mh.push(a),vh.push(s)}},e}(p),_h=function(i){function e(e){var t;return(t=i.call(this)||this).manager=e,t._supported=!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),t._session=null,t.sources=[],t._supported&&(t.manager.on("start",t._onSessionStart,g(t)),t.manager.on("end",t._onSessionEnd,g(t))),t}u(e,i);var t=e.prototype;return t._onSessionStart=function(){this.manager.type===ph&&(this._session=this.manager.session)},t._onSessionEnd=function(){if(this._session){this._session=null;for(var e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[]}},t.isAvailable=function(e,t){var i;return this._supported||(i=new Error("XR HitTest is not supported")),this._session||(i=new Error("XR Session is not started (1)")),this.manager.type!==ph&&(i=new Error("XR HitTest is available only for AR")),!i||(e&&e(i),t&&t.fire("error",i),!1)},t.start=function(i){var n=this;if(i=i||{},this.isAvailable(i.callback,this)){var a;i.profile||i.spaceType||(i.spaceType="viewer");var e=i.offsetRay;e&&(a=new XRRay(new DOMPoint(e.origin.x,e.origin.y,e.origin.z),new DOMPoint(e.direction.x,e.direction.y,e.direction.z)));var s=i.callback;i.spaceType?this._session.requestReferenceSpace(i.spaceType).then(function(e){if(!n._session){var t=new Error("XR Session is not started (2)");return s&&s(t),void n.fire("error",t)}n._session.requestHitTestSource({space:e,entityTypes:i.entityTypes||void 0,offsetRay:a}).then(function(e){n._onHitTestSource(e,!1,s)}).catch(function(e){s&&s(e),n.fire("error",e)})}).catch(function(e){s&&s(e),n.fire("error",e)}):this._session.requestHitTestSourceForTransientInput({profile:i.profile,entityTypes:i.entityTypes||void 0,offsetRay:a}).then(function(e){n._onHitTestSource(e,!0,s)}).catch(function(e){s&&s(e),n.fire("error",e)})}},t._onHitTestSource=function(e,t,i){if(!this._session){e.cancel();var n=new Error("XR Session is not started (3)");return i&&i(n),void this.fire("error",n)}var a=new gh(this.manager,e,t);this.sources.push(a),i&&i(null,a),this.fire("add",a)},t.update=function(e){for(var t=0;t<this.sources.length;t++)this.sources[t].update(e)},c(e,[{key:"supported",get:function(){return this._supported}}]),e}(p),yh=function(){function e(e,t){this._index=e,this._hand=t,this._hand._fingers.push(this),this._joints=[],this._tip=null}return c(e,[{key:"index",get:function(){return this._index}},{key:"hand",get:function(){return this._hand}},{key:"joints",get:function(){return this._joints}},{key:"tip",get:function(){return this._tip}}]),e}(),bh=window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],xh={},Mh=0;Mh<bh.length;Mh++)xh[bh[Mh]]=!0;var Sh=function(){function e(e,t,i,n){void 0===n&&(n=null),this._index=e,this._id=t,this._hand=i,this._finger=n,this._wrist="wrist"===t,this._tip=this._finger&&!!xh[t],this._radius=null,this._localTransform=new pe,this._worldTransform=new pe,this._localPosition=new de,this._localRotation=new fe,this._position=new de,this._rotation=new fe,this._dirtyLocal=!0}var t=e.prototype;return t.update=function(e){this._dirtyLocal=!0,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation)},t._updateTransforms=function(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,de.ONE));var e=this._hand._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)},t.getPosition=function(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position},t.getRotation=function(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation},c(e,[{key:"index",get:function(){return this._index}},{key:"hand",get:function(){return this._hand}},{key:"finger",get:function(){return this._finger}},{key:"wrist",get:function(){return this._wrist}},{key:"tip",get:function(){return this._tip}},{key:"radius",get:function(){return this._radius||.005}}]),e}(),wh=[],Ch=new de,Ph=new de,Th=new de;window.XRHand&&(wh=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);var Ah=function(h){function e(e){var t;t=h.call(this)||this;var i=e._xrInputSource.hand;if(t._manager=e._manager,t._inputSource=e,t._tracking=!1,t._fingers=[],t._joints=[],t._jointsById={},t._tips=[],t._wrist=null,i.get("wrist")){var n=new Sh(0,"wrist",g(t),null);t._wrist=n,t._joints.push(n),t._jointsById.wrist=n}for(var a=0;a<wh.length;a++)for(var s=new yh(a,g(t)),r=0;r<wh[a].length;r++){var o=wh[a][r];if(i.get(o)){var l=new Sh(r,o,g(t),s);t._joints.push(l),(t._jointsById[o]=l).tip&&(t._tips.push(l),s._tip=l),s._joints.push(l)}}return t}u(e,h);var t=e.prototype;return t.update=function(e){for(var t=this._inputSource._xrInputSource,i=0;i<this._joints.length;i++){var n=this._joints[i],a=t.hand.get(n._id);if(a){var s=void 0;if("hidden"!==e.session.visibilityState&&(s=e.getJointPose(a,this._manager._referenceSpace)),s)n.update(s),n.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(n.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}var r=this._jointsById["thumb-metacarpal"],o=this._jointsById["thumb-tip"],l=this._jointsById["index-finger-phalanx-proximal"],h=this._jointsById["index-finger-tip"],c=this._jointsById["ring-finger-phalanx-proximal"],u=this._jointsById["pinky-finger-phalanx-proximal"];if(r&&o&&l&&h&&c&&u){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(o._localPosition,h._localPosition,.5);var d=r,p=u;if("left"===this._inputSource.handedness){var f=d;d=p,p=f}Ch.sub2(d._localPosition,this._wrist._localPosition),Ph.sub2(p._localPosition,this._wrist._localPosition),Th.cross(Ch,Ph).normalize(),Ch.lerp(l._localPosition,c._localPosition,.5),Ch.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(Th,Ch,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))},t._fingerIsClosed=function(e){var t=this._fingers[e];return Ch.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),Ph.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),Ch.dot(Ph)<-.8},t.getJointById=function(e){return this._jointsById[e]||null},c(e,[{key:"fingers",get:function(){return this._fingers}},{key:"joints",get:function(){return this._joints}},{key:"tips",get:function(){return this._tips}},{key:"wrist",get:function(){return this._wrist}},{key:"tracking",get:function(){return this._tracking}}]),e}(p),Eh=new fe,Rh=0,Dh=function(n){function e(e,t){var i;return(i=n.call(this)||this)._id=++Rh,i._manager=e,i._xrInputSource=t,i._ray=new xe,i._rayLocal=new xe,i._grip=!1,i._hand=null,t.hand&&(i._hand=new Ah(g(i))),i._localTransform=null,i._worldTransform=null,i._position=new de,i._rotation=new fe,i._localPosition=null,i._localRotation=null,i._dirtyLocal=!0,i._selecting=!1,i._squeezing=!1,i._elementInput=!0,i._elementEntity=null,i._hitTestSources=[],i}u(e,n);var t=e.prototype;return t.update=function(e){if(this._hand)this._hand.update(e);else{if(this._xrInputSource.gripSpace){var t=e.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);t&&(this._grip||(this._grip=!0,this._localTransform=new pe,this._worldTransform=new pe,this._localPosition=new de,this._localRotation=new fe),this._dirtyLocal=!0,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation))}var i=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);i&&(this._dirtyRay=!0,this._rayLocal.origin.copy(i.transform.position),this._rayLocal.direction.set(0,0,-1),Eh.copy(i.transform.orientation),Eh.transformVector(this._rayLocal.direction,this._rayLocal.direction))}},t._updateTransforms=function(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,de.ONE));var e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)},t._updateRayTransforms=function(){var e=this._dirtyRay;if(this._dirtyRay=!1,this._manager.camera.parent){var t=this._manager.camera.parent.getWorldTransform();t.getTranslation(this._position),this._rotation.setFromMat4(t),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))},t.getPosition=function(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null},t.getLocalPosition=function(){return this._localPosition},t.getRotation=function(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null},t.getLocalRotation=function(){return this._localRotation},t.getOrigin=function(){return this._updateRayTransforms(),this._ray.origin},t.getDirection=function(){return this._updateRayTransforms(),this._ray.direction},t.hitTestStart=function(e){var i=this;void 0===e&&(e={}),e.profile=this._xrInputSource.profiles[0];var n=e.callback;e.callback=function(e,t){t&&i.onHitTestSourceAdd(t),n&&n(e,t)},this._manager.hitTest.start(e)},t.onHitTestSourceAdd=function(n){this._hitTestSources.push(n),this.fire("hittest:add",n),n.on("result",function(e,t,i){i===this&&this.fire("hittest:result",n,e,t)},this),n.once("remove",function(){this.onHitTestSourceRemove(n),this.fire("hittest:remove",n)},this)},t.onHitTestSourceRemove=function(e){var t=this._hitTestSources.indexOf(e);-1!==t&&this._hitTestSources.splice(t,1)},c(e,[{key:"id",get:function(){return this._id}},{key:"inputSource",get:function(){return this._xrInputSource}},{key:"targetRayMode",get:function(){return this._xrInputSource.targetRayMode}},{key:"handedness",get:function(){return this._xrInputSource.handedness}},{key:"profiles",get:function(){return this._xrInputSource.profiles}},{key:"grip",get:function(){return this._grip}},{key:"hand",get:function(){return this._hand}},{key:"gamepad",get:function(){return this._xrInputSource.gamepad||null}},{key:"selecting",get:function(){return this._selecting}},{key:"squeezing",get:function(){return this._squeezing}},{key:"elementInput",get:function(){return this._elementInput},set:function(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}},{key:"elementEntity",get:function(){return this._elementEntity}},{key:"hitTestSources",get:function(){return this._hitTestSources}}]),e}(p),Ih=function(i){function e(e){var t;return(t=i.call(this)||this).manager=e,t._session=null,t._inputSources=[],t._onInputSourcesChangeEvt=function(e){t._onInputSourcesChange(e)},t.manager.on("start",t._onSessionStart,g(t)),t.manager.on("end",t._onSessionEnd,g(t)),t}u(e,i);var t=e.prototype;return t._onSessionStart=function(){var i=this;this._session=this.manager.session,this._session.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),this._session.addEventListener("select",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame),t.fire("select",e),i.fire("select",t,e)}),this._session.addEventListener("selectstart",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=!0,t.fire("selectstart",e),i.fire("selectstart",t,e)}),this._session.addEventListener("selectend",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=!1,t.fire("selectend",e),i.fire("selectend",t,e)}),this._session.addEventListener("squeeze",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame),t.fire("squeeze",e),i.fire("squeeze",t,e)}),this._session.addEventListener("squeezestart",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=!0,t.fire("squeezestart",e),i.fire("squeezestart",t,e)}),this._session.addEventListener("squeezeend",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=!1,t.fire("squeezeend",e),i.fire("squeezeend",t,e)});for(var e=this._session.inputSources,t=0;t<e.length;t++)this._addInputSource(e[t])},t._onSessionEnd=function(){for(var e=this._inputSources.length;e--;){var t=this._inputSources[e];this._inputSources.splice(e,1),t.fire("remove"),this.fire("remove",t)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt),this._session=null},t._onInputSourcesChange=function(e){for(var t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(var i=0;i<e.added.length;i++)this._addInputSource(e.added[i])},t._getByInputSource=function(e){for(var t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null},t._addInputSource=function(e){if(!this._getByInputSource(e)){var t=new Dh(this.manager,e);this._inputSources.push(t),this.fire("add",t)}},t._removeInputSource=function(e){for(var t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e){var i=this._inputSources[t];this._inputSources.splice(t,1);for(var n=i.hitTestSources.length;n--;)i.hitTestSources[n].remove();return i.fire("remove"),void this.fire("remove",i)}},t.update=function(e){for(var t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e)},c(e,[{key:"inputSources",get:function(){return this._inputSources}}]),e}(p),kh=new de,Lh=new de,Oh=new pe,Fh=new pe,zh=function(i){function e(e){var t;return(t=i.call(this)||this)._manager=e,t._supported=!1,t._available=!1,t._lightProbeRequested=!1,t._lightProbe=null,t._intensity=0,t._rotation=new fe,t._color=new $,t._sphericalHarmonics=new Float32Array(27),t._manager.on("start",t._onSessionStart,g(t)),t._manager.on("end",t._onSessionEnd,g(t)),t}u(e,i);var t=e.prototype;return t._onSessionStart=function(){this._manager.session.requestLightProbe&&(this._supported=!0)},t._onSessionEnd=function(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null},t.start=function(){var e,i=this;this._manager.session||(e=new Error("XR session is not running")),e||this._manager.type===ph||(e=new Error("XR session type is not AR")),e||this._supported||(e=new Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=new Error("light estimation is already requested")),e?this.fire("error",e):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then(function(e){var t=i._lightProbeRequested;i._lightProbeRequested=!1,i._manager.active?t&&(i._lightProbe=e):i.fire("error",new Error("XR session is not active"))}).catch(function(e){i._lightProbeRequested=!1,i.fire("error",e)}))},t.end=function(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1},t.update=function(e){if(this._lightProbe){var t=e.getLightEstimate(this._lightProbe);if(t){this._available||(this._available=!0,this.fire("available"));var i=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(i.x,Math.max(i.y,i.z))),kh.copy(i).mulScalar(1/this._intensity),this._color.set(kh.x,kh.y,kh.z),kh.set(0,0,0),Lh.copy(t.primaryLightDirection),Oh.setLookAt(Lh,kh,de.UP),Fh.setFromAxisAngle(de.RIGHT,90),Oh.mul(Fh),this._rotation.setFromMat4(Oh),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients)}}},c(e,[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"intensity",get:function(){return this._available?this._intensity:null}},{key:"color",get:function(){return this._available?this._color:null}},{key:"rotation",get:function(){return this._available?this._rotation:null}},{key:"sphericalHarmonics",get:function(){return this._available?this._sphericalHarmonics:null}}]),e}(p),Bh=function(n){function e(e,t){var i;return(i=n.call(this)||this)._image=e,i._bitmap=null,i._width=t,i._measuredWidth=0,i._trackable=!1,i._tracking=!1,i._emulated=!1,i._pose=null,i._position=new de,i._rotation=new fe,i}u(e,n);var t=e.prototype;return t.prepare=function(){var t=this;return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(function(e){return t._bitmap=e,{image:t._bitmap,widthInMeters:t._width}})},t.destroy=function(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)},t.getPosition=function(){return this._pose&&this._position.copy(this._pose.transform.position),this._position},t.getRotation=function(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation},c(e,[{key:"image",get:function(){return this._image}},{key:"width",get:function(){return this._width},set:function(e){this._width=e}},{key:"trackable",get:function(){return this._trackable}},{key:"tracking",get:function(){return this._tracking}},{key:"emulated",get:function(){return this._emulated}}]),e}(p),Vh=function(i){function e(e){var t;return(t=i.call(this)||this)._manager=e,t._supported=!!window.XRImageTrackingResult,t._available=!1,t._images=[],t._supported&&(t._manager.on("start",t._onSessionStart,g(t)),t._manager.on("end",t._onSessionEnd,g(t))),t}u(e,i);var t=e.prototype;return t.add=function(e,t){if(!this._supported||this._manager.active)return null;var i=new Bh(e,t);return this._images.push(i),i},t.remove=function(e){if(!this._manager.active){var t=this._images.indexOf(e);-1!==t&&(e.destroy(),this._images.splice(t,1))}},t._onSessionStart=function(){var i=this;this._manager.session.getTrackedImageScores().then(function(e){i._available=!0;for(var t=0;t<e.length;t++)i._images[t]._trackable="trackable"===e[t]}).catch(function(e){i._available=!1,i.fire("error",e)})},t._onSessionEnd=function(){this._available=!1;for(var e=0;e<this._images.length;e++)this._images[e]._pose=null,this._images[e]._measuredWidth=0,this._images[e]._tracking&&(this._images[e]._tracking=!1,this._images[e].fire("untracked"))},t.prepareImages=function(t){this._images.length?Promise.all(this._images.map(function(e){return e.prepare()})).then(function(e){t(null,e)}).catch(function(e){t(e,null)}):t(null,null)},t.update=function(e){if(this._available){for(var t=e.getImageTrackingResults(),i={},n=0;n<t.length;n++){i[t[n].index]=t[n];var a=this._images[t[n].index];a._emulated="emulated"===t[n].trackingState,a._measuredWidth=t[n].measuredWidthInMeters,a._dirtyTransform=!0,a._pose=e.getPose(t[n].imageSpace,this._manager._referenceSpace)}for(var s=0;s<this._images.length;s++)this._images[s]._tracking&&!i[s]?(this._images[s]._tracking=!1,this._images[s].fire("untracked")):!this._images[s]._tracking&&i[s]&&(this._images[s]._tracking=!0,this._images[s].fire("tracked"))}},c(e,[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"images",get:function(){return this._images}}]),e}(p),Uh=function(){function e(e){this._manager=e,this._supported=!!window.XRDOMOverlayState,this._root=null}return c(e,[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}},{key:"state",get:function(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}},{key:"root",get:function(){return this._root},set:function(e){this._supported&&!this._manager.active&&(this._root=e)}}]),e}(),Nh=function(i){function e(e){var t;return(t=i.call(this)||this)._manager=e,t._available=!1,t._depthInfoCpu=null,t._depthInfoGpu=null,t._usage=null,t._dataFormat=null,t._matrixDirty=!1,t._matrix=new pe,t._emptyBuffer=new Uint8Array(32),t._depthBuffer=null,t._texture=new Kt(t._manager.app.graphicsDevice,{format:2,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1}),t.supported&&(t._manager.on("start",t._onSessionStart,g(t)),t._manager.on("end",t._onSessionEnd,g(t))),t}u(e,i);var t=e.prototype;return t._onSessionStart=function(){var e=this._manager.session;try{this._usage=e.depthUsage,this._dataFormat=e.depthDataFormat}catch(e){this._usage=null,this._dataFormat=null,this._available=!1,this.fire("error",e)}},t._onSessionEnd=function(){this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._available&&(this._available=!1,this.fire("unavailable")),this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload()},t._updateTexture=function(){var e=this._depthInfoCpu||this._depthInfoGpu;if(e){var t=!1;if(e.width===this._texture.width&&e.height===this._texture.height||(this._texture._width=e.width,this._texture._height=e.height,t=this._matrixDirty=!0),this._depthInfoCpu){var i=this._depthInfoCpu.data;this._depthBuffer=new Uint8Array(i),this._texture._levels[0]=this._depthBuffer,this._texture.upload()}else this._depthInfoGpu&&(this._texture._levels[0]=this._depthInfoGpu.texture,this._texture.upload());t&&this.fire("resize",e.width,e.height)}else this._depthBuffer&&(this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload())},t.update=function(e,t){if(this._usage){var i=null,n=null;if(this._usage===fh&&t?i=e.getDepthInformation(t):"gpu-optimized"===this._usage&&t&&(n=e.getDepthInformation(t)),(this._depthInfoCpu&&!i||!this._depthInfoCpu&&i||this.depthInfoGpu&&!n||!this._depthInfoGpu&&n)&&(this._matrixDirty=!0),this._depthInfoCpu=i,this._depthInfoGpu=n,this._updateTexture(),this._matrixDirty){this._matrixDirty=!1;var a=this._depthInfoCpu||this._depthInfoGpu;a?this._matrix.data.set(a.normDepthBufferFromNormView.matrix):this._matrix.setIdentity()}!this._depthInfoCpu&&!this._depthInfoGpu||this._available?this._depthInfoCpu||this._depthInfoGpu||!this._available||(this._available=!1,this.fire("unavailable")):(this._available=!0,this.fire("available"))}},t.getDepth=function(e,t){return this._depthInfoCpu?this._depthInfoCpu.getDepthInMeters(e,t):null},c(e,[{key:"supported",get:function(){return!!window.XRDepthInformation}},{key:"available",get:function(){return this._available}},{key:"usage",get:function(){return this._usage}},{key:"dataFormat",get:function(){return this._dataFormat}},{key:"width",get:function(){var e=this._depthInfoCpu||this._depthInfoGpu;return e&&e.width||0}},{key:"height",get:function(){var e=this._depthInfoCpu||this._depthInfoGpu;return e&&e.height||0}},{key:"texture",get:function(){return this._texture}},{key:"uvMatrix",get:function(){return this._matrix}},{key:"rawValueToMeters",get:function(){var e=this._depthInfoCpu||this._depthInfoGpu;return e&&e.rawValueToMeters||0}}]),e}(p),Gh=0,Wh=function(n){function e(e,t){var i;return(i=n.call(this)||this)._id=++Gh,i._planeDetection=e,i._manager=i._planeDetection._manager,i._xrPlane=t,i._lastChangedTime=i._xrPlane.lastChangedTime,i._orientation=i._xrPlane.orientation,i._position=new de,i._rotation=new fe,i}u(e,n);var t=e.prototype;return t.destroy=function(){this.fire("remove")},t.update=function(e){var t=e.getPose(this._xrPlane.planeSpace,this._manager._referenceSpace);t&&(this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))},t.getPosition=function(){return this._position},t.getRotation=function(){return this._rotation},c(e,[{key:"id",get:function(){return this.id}},{key:"orientation",get:function(){return this._orientation}},{key:"points",get:function(){return this._xrPlane.polygon}}]),e}(p),Hh=function(i){function e(e){var t;return(t=i.call(this)||this)._manager=e,t._supported=!!window.XRPlane,t._available=!1,t._planesIndex=new Map,t._planes=null,t._supported&&t._manager.on("end",t._onSessionEnd,g(t)),t}u(e,i);var t=e.prototype;return t._onSessionEnd=function(){if(this._planes)for(var e=0;e<this._planes.length;e++)this._planes[e].destroy();this._planesIndex.clear(),this._planes=null,this._available&&(this._available=!1,this.fire("unavailable"))},t.update=function(e){var t;if(this._available)t=e.detectedPlanes;else try{t=e.detectedPlanes,this._planes=[],this._available=!0,this.fire("available")}catch(e){return}for(var i,n=_(this._planesIndex);!(i=n()).done;){var a=i.value,s=a[0],r=a[1];t.has(s)||(this._planesIndex.delete(s),this._planes.splice(this._planes.indexOf(r),1),r.destroy(),this.fire("remove",r))}for(var o,l=_(t);!(o=l()).done;){var h=o.value,c=this._planesIndex.get(h);c?c.update(e):(c=new Wh(this,h),this._planesIndex.set(h,c),this._planes.push(c),c.update(e),this.fire("add",c))}},c(e,[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"planes",get:function(){return this._planes}}]),e}(p),jh=function(i){function e(e){var t;return(t=i.call(this)||this).app=e,t._supported=!!navigator.xr,t._available={},t._available.inline=!1,t._available[dh]=!1,t._available[ph]=!1,t._type=null,t._spaceType=null,t._session=null,t._baseLayer=null,t._referenceSpace=null,t.depthSensing=new Nh(g(t)),t.domOverlay=new Uh(g(t)),t.hitTest=new _h(g(t)),t.imageTracking=new Vh(g(t)),t.planeDetection=new Hh(g(t)),t.input=new Ih(g(t)),t.lightEstimation=new zh(g(t)),t._camera=null,t.views=[],t.viewsPool=[],t._localPosition=new de,t._localRotation=new fe,t._depthNear=.1,t._depthFar=1e3,t._width=0,t._height=0,t._supported&&(navigator.xr.addEventListener("devicechange",function(){t._deviceAvailabilityCheck()}),t._deviceAvailabilityCheck()),t}u(e,i);var t=e.prototype;return t.start=function(e,i,n,t){var a=this,s=t;if("object"==(void 0===t?"undefined":dx(t))&&(s=t.callback),this._available[i])if(this._session)s&&s(new Error("XR session is already started"));else{this._camera=e,(this._camera.camera.xr=this)._type=i,this._spaceType=n,this._setClipPlanes(e.nearClip,e.farClip);var r={requiredFeatures:[n],optionalFeatures:[]};if(i===ph){if(r.optionalFeatures.push("light-estimation"),r.optionalFeatures.push("hit-test"),t&&(t.imageTracking&&this.imageTracking.supported&&r.optionalFeatures.push("image-tracking"),t.planeDetection&&r.optionalFeatures.push("plane-detection")),this.domOverlay.supported&&this.domOverlay.root&&(r.optionalFeatures.push("dom-overlay"),r.domOverlay={root:this.domOverlay.root}),t&&t.depthSensing&&this.depthSensing.supported){r.optionalFeatures.push("depth-sensing");var o=[fh],l=["luminance-alpha"];if(t.depthSensing.usagePreference){var h=o.indexOf(t.depthSensing.usagePreference);-1!==h&&o.splice(h,1),o.unshift(t.depthSensing.usagePreference)}if(t.depthSensing.dataFormatPreference){var c=l.indexOf(t.depthSensing.dataFormatPreference);-1!==c&&l.splice(c,1),l.unshift(t.depthSensing.dataFormatPreference)}r.depthSensing={usagePreference:o,dataFormatPreference:l}}}else i===dh&&r.optionalFeatures.push("hand-tracking");t&&t.optionalFeatures&&(r.optionalFeatures=r.optionalFeatures.concat(t.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(function(e,t){if(e)return s&&s(e),void a.fire("error",e);null!==t&&(r.trackedImages=t),a._onStartOptionsReady(i,n,r,s)}):this._onStartOptionsReady(i,n,r,s)}else s&&s(new Error("XR is not available"))},t._onStartOptionsReady=function(e,t,i,n){var a=this;navigator.xr.requestSession(e,i).then(function(e){a._onSessionStart(e,t,n)}).catch(function(e){a._camera.camera.xr=null,a._camera=null,a._type=null,a._spaceType=null,n&&n(e),a.fire("error",e)})},t.end=function(e){this._session?(e&&this.once("end",e),this._session.end()):e&&e(new Error("XR Session is not initialized"))},t.isAvailable=function(e){return this._available[e]},t._deviceAvailabilityCheck=function(){for(var e in this._available)this._sessionSupportCheck(e)},t._sessionSupportCheck=function(t){var i=this;navigator.xr.isSessionSupported(t).then(function(e){i._available[t]!==e&&(i._available[t]=e,i.fire("available",t,e),i.fire("available:"+t,e))}).catch(function(e){i.fire("error",e)})},t._onSessionStart=function(t,e,i){var n=this,a=!1;this._session=t;var s=function(){n.fire("visibility:change",t.visibilityState)},r=function(){n._setClipPlanes(n._camera.nearClip,n._camera.farClip)};t.addEventListener("end",function e(){n._session=null,n._referenceSpace=null,n.views=[],n._width=0,n._height=0,n._type=null,n._spaceType=null,n._camera&&(n._camera.off("set_nearClip",r),n._camera.off("set_farClip",r),n._camera.camera.xr=null,n._camera=null),t.removeEventListener("end",e),t.removeEventListener("visibilitychange",s),a||n.fire("end"),n.app.tick()}),t.addEventListener("visibilitychange",s),this._camera.on("set_nearClip",r),this._camera.on("set_farClip",r),this._baseLayer=new XRWebGLLayer(t,this.app.graphicsDevice.gl),t.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}),t.requestReferenceSpace(e).then(function(e){n._referenceSpace=e,n.app.tick(),i&&i(null),n.fire("start")}).catch(function(e){a=!0,t.end(),i&&i(e),n.fire("error",e)})},t._setClipPlanes=function(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))},t.update=function(e){if(this._session){var t=e.session.renderState.baseLayer.framebufferWidth,i=e.session.renderState.baseLayer.framebufferHeight;this._width===t&&this._height===i||(this._width=t,this._height=i,this.app.graphicsDevice.setResolution(t,i));var n=e.getViewerPose(this._referenceSpace),a=n?n.views.length:0;if(a>this.views.length)for(var s=0;s<=a-this.views.length;s++){var r=this.viewsPool.pop();r||(r={viewport:new ee,projMat:new pe,viewMat:new pe,viewOffMat:new pe,viewInvMat:new pe,viewInvOffMat:new pe,projViewOffMat:new pe,viewMat3:new Q,position:new Float32Array(3),rotation:new fe}),this.views.push(r)}else if(a<=this.views.length)for(var o=0;o<this.views.length-a;o++)this.viewsPool.push(this.views.pop());if(n){var l=n.transform.position,h=n.transform.orientation;this._localPosition.set(l.x,l.y,l.z),this._localRotation.set(h.x,h.y,h.z,h.w);for(var c=e.session.renderState.baseLayer,u=0;u<n.views.length;u++){var d=n.views[u],p=this.views[u],f=c.getViewport(d);p.viewport.x=f.x,p.viewport.y=f.y,p.viewport.z=f.width,p.viewport.w=f.height,p.projMat.set(d.projectionMatrix),p.viewMat.set(d.transform.inverse.matrix),p.viewInvMat.set(d.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===ph&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.depthSensing.supported&&this.depthSensing.update(e,n&&n.views[0]),this.imageTracking.supported&&this.imageTracking.update(e),this.planeDetection.supported&&this.planeDetection.update(e)),this.fire("update",e)}},c(e,[{key:"supported",get:function(){return this._supported}},{key:"active",get:function(){return!!this._session}},{key:"type",get:function(){return this._type}},{key:"spaceType",get:function(){return this._spaceType}},{key:"session",get:function(){return this._session}},{key:"visibilityState",get:function(){return this._session?this._session.visibilityState:null}},{key:"camera",get:function(){return this._camera?this._camera.entity:null}}]),e}(p),Xh=function(n){function t(e,t){var i;return(i=n.call(this)||this).system=e,i.entity=t,i.system.schema&&!i._accessorsBuilt&&i.buildAccessors(i.system.schema),i.on("set",function(e,t,i){this.fire("set_"+e,e,t,i)}),i.on("set_enabled",i.onSetEnabled,g(i)),i}u(t,n),t._buildAccessors=function(t,e){e.forEach(function(e){var n="object"==(void 0===e?"undefined":dx(e))?e.name:e;Object.defineProperty(t,n,{get:function(){return this.data[n]},set:function(e){var t=this.data,i=t[n];t[n]=e,this.fire("set",n,i,e)},configurable:!0})}),t._accessorsBuilt=!0};var e=t.prototype;return e.buildAccessors=function(e){t._buildAccessors(this,e)},e.onSetEnabled=function(e,t,i){t!==i&&this.entity.enabled&&(i?this.onEnable():this.onDisable())},e.onEnable=function(){},e.onDisable=function(){},e.onPostStateChange=function(){},c(t,[{key:"data",get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}}]),t}(p),qh=function(i){function e(e){var t;return(t=i.call(this)||this).app=e,t.store={},t.schema=[],t}u(e,i),e._helper=function(e,t){for(var i=0,n=e.length;i<n;i++)e[i].f.call(e[i].s,t)},e.initialize=function(e){this._helper(this._init,e)},e.postInitialize=function(e){this._helper(this._postInit,e),this.fire("postinitialize",e)},e.update=function(e,t){this._helper(t?this._toolsUpdate:this._update,e)},e.animationUpdate=function(e,t){this._helper(this._animationUpdate,e)},e.fixedUpdate=function(e,t){this._helper(this._fixedUpdate,e)},e.postUpdate=function(e,t){this._helper(this._postUpdate,e)},e.bind=function(e,t,i){switch(e){case"initialize":this._init.push({f:t,s:i});break;case"postInitialize":this._postInit.push({f:t,s:i});break;case"update":this._update.push({f:t,s:i});break;case"animationUpdate":this._animationUpdate.push({f:t,s:i});break;case"postUpdate":this._postUpdate.push({f:t,s:i});break;case"fixedUpdate":this._fixedUpdate.push({f:t,s:i});break;case"toolsUpdate":this._toolsUpdate.push({f:t,s:i})}},e._erase=function(e,t,i){for(var n=0;n<e.length;n++)e[n].f===t&&e[n].s===i&&e.splice(n--,1)},e.unbind=function(e,t,i){switch(e){case"initialize":this._erase(this._init,t,i);break;case"postInitialize":this._erase(this._postInit,t,i);break;case"update":this._erase(this._update,t,i);break;case"animationUpdate":this._erase(this._animationUpdate,t,i);break;case"postUpdate":this._erase(this._postUpdate,t,i);break;case"fixedUpdate":this._erase(this._fixedUpdate,t,i);break;case"toolsUpdate":this._erase(this._toolsUpdate,t,i)}};var t=e.prototype;return t.addComponent=function(e,t){var i=new this.ComponentType(this,e),n=new this.DataType;return t=t||{},this.store[e.getGuid()]={entity:e,data:n},e[this.id]=i,e.c[this.id]=i,this.initializeComponentData(i,t,[]),this.fire("add",e,i),i},t.removeComponent=function(e){var t=this.store[e.getGuid()],i=e.c[this.id];this.fire("beforeremove",e,i),delete this.store[e.getGuid()],delete e[this.id],delete e.c[this.id],this.fire("remove",e,t.data)},t.cloneComponent=function(e,t){var i=this.store[e.getGuid()];return this.addComponent(t,i.data)},t.initializeComponentData=function(e,t,i){var n,a,s,r;void 0===t&&(t={});for(var o=0,l=i.length;o<l;o++)"object"==dx(n=i[o])?(a=n.name,s=n.type):(a=n,s=void 0),void 0!==(r=t[a])?(void 0!==s&&(r=$h(r,s)),e[a]=r):e[a]=e.data[a];e.enabled&&e.entity.enabled&&e.onEnable()},t.getPropertiesOfType=function(t){var i=[];return(this.schema||[]).forEach(function(e){e&&"object"==(void 0===e?"undefined":dx(e))&&e.type===t&&i.push(e)}),i},t.destroy=function(){this.off()},e}(p);function $h(e,t){if(!e)return e;switch(t){case"rgb":return e instanceof $?e.clone():new $(e[0],e[1],e[2]);case"rgba":return e instanceof $?e.clone():new $(e[0],e[1],e[2],e[3]);case"vec2":return e instanceof J?e.clone():new J(e[0],e[1]);case"vec3":return e instanceof de?e.clone():new de(e[0],e[1],e[2]);case"vec4":return e instanceof ee?e.clone():new ee(e[0],e[1],e[2],e[3]);case"boolean":case"number":case"string":case"entity":return e;default:throw new Error("Could not convert unhandled type: "+t)}}qh._init=[],qh._postInit=[],qh._toolsUpdate=[],qh._update=[],qh._animationUpdate=[],qh._fixedUpdate=[],qh._postUpdate=[],f.attach(qh),qh.destroy=function(){qh.off("initialize"),qh.off("postInitialize"),qh.off("toolsUpdate"),qh.off("update"),qh.off("animationUpdate"),qh.off("fixedUpdate"),qh.off("postUpdate"),qh._init=[],qh._postInit=[],qh._toolsUpdate=[],qh._update=[],qh._animationUpdate=[],qh._fixedUpdate=[],qh._postUpdate=[]};var Yh=function(){function e(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}var t=e.prototype;return t.update=function(e,t){if(e<this._left||e>=this._right){var i=t.length;if(i)if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[i-1])this._left=t[i-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=i-1;else{var n=this._findKey(e,t);this._left=t[n],this._right=t[n+1],this._len=this._right-this._left;var a=1/this._len;this._recip=isFinite(a)?a:0,this._p0=n,this._p1=n+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(e-this._left)*this._recip,this._hermite.valid=!1},t._findKey=function(e,t){for(var i=0;e>=t[i+1];)i++;return i},t.eval=function(e,t,i){var n,a=i._data,s=i._components,r=this._p0*s;if(0===t)for(n=0;n<s;++n)e[n]=a[r+n];else{var o=this._t,l=this._p1*s;switch(t){case 1:for(n=0;n<s;++n)e[n]=Se.lerp(a[r+n],a[l+n],o);break;case 2:var h=this._hermite;if(!h.valid){var c=o*o,u=o+o,d=1-o,p=d*d;h.valid=!0,h.p0=(1+u)*p,h.m0=o*p,h.p1=c*(3-u),h.m1=c*(o-1)}var f=(3*this._p0+1)*s,m=(3*this._p0+2)*s,v=(3*this._p1+1)*s,g=(3*this._p1+0)*s;for(n=0;n<s;++n)e[n]=h.p0*a[f+n]+h.m0*a[m+n]*this._len+h.p1*a[v+n]+h.m1*a[g+n]*this._len}}},e}(),Kh=function(e){var t;for(this._name=e.name+"Snapshot",this._time=-1,this._cache=[],this._results=[],t=0;t<e._inputs.length;++t)this._cache[t]=new Yh;var i=e._curves,n=e._outputs;for(t=0;t<i.length;++t){for(var a=n[i[t]._output],s=[],r=0;r<a._components;++r)s[r]=0;this._results[t]=s}},Zh=function(){function e(e,t,i,n,a,s){for(this._name=e.name,this._track=e,this._snapshot=new Kh(e),this._playing=n,this._time=t,this._speed=i,this._loop=a,this._blendWeight=1,this._blendOrder=0,this._eventHandler=s,this._eventCursor=0;this._track.events[this._eventCursor]&&this._track.events[this._eventCursor].time<this.time;)this._eventCursor++}var t=e.prototype;return t.activeEventsForFrame=function(e,t){var i;for(0===e&&(this.eventCursor=0),t>this.track.duration&&(i=t-this.track.duration,t=this.track.duration);this.track.events[this.eventCursor]&&this.track.events[this.eventCursor].time>=e&&(t===this.track.duration?this.track.events[this.eventCursor].time<=t:this.track.events[this.eventCursor].time<t);){var n=this.track.events[this.eventCursor];this._eventHandler.fire(n.name,h({track:this.track},n)),this.eventCursor++}Number.isFinite(i)&&this.activeEventsForFrame(0,i)},t._update=function(e){if(this._playing){var t=this._time,i=this._track.duration,n=this._speed,a=this._loop;0<this._track.events.length&&0<i&&this.activeEventsForFrame(t,t+n*e),t+=n*e,0<=n?i<t&&(a?t=t%i||0:(t=this._track.duration,this.pause())):t<0&&(a?t=i+(t%i||0):(t=0,this.pause())),this._time=t}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)},t.play=function(){this._playing=!0,this._time=0},t.stop=function(){this._playing=!1,this._time=0},t.pause=function(){this._playing=!1},t.resume=function(){this._playing=!0},t.reset=function(){this._time=0},c(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"track",get:function(){return this._track}},{key:"snapshot",get:function(){return this._snapshot}},{key:"time",get:function(){return this._time},set:function(e){this._time=e}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e}},{key:"blendWeight",get:function(){return this._blendWeight},set:function(e){this._blendWeight=e}},{key:"blendOrder",get:function(){return this._blendOrder},set:function(e){this._blendOrder=e}},{key:"eventCursor",get:function(){return this._eventCursor},set:function(e){this._eventCursor=e}}]),e}(),Qh=function(){function v(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}v._dot=function(e,t){for(var i=e.length,n=0,a=0;a<i;++a)n+=e[a]*t[a];return n},v._normalize=function(e){var t=v._dot(e,e);if(0<t){t=1/Math.sqrt(t);for(var i=e.length,n=0;n<i;++n)e[n]*=t}},v._set=function(e,t,i){var n,a=e.length;if("quaternion"===i){var s=v._dot(t,t);for(0<s&&(s=1/Math.sqrt(s)),n=0;n<a;++n)e[n]=t[n]*s}else for(n=0;n<a;++n)e[n]=t[n]},v._blendVec=function(e,t,i){for(var n=1-i,a=e.length,s=0;s<a;++s)e[s]=e[s]*n+t[s]*i},v._blendQuat=function(e,t,i){var n=e.length,a=1-i;v._dot(e,t)<0&&(i=-i);for(var s=0;s<n;++s)e[s]=e[s]*a+t[s]*i;v._normalize(e)},v._blend=function(e,t,i,n){"quaternion"===n?v._blendQuat(e,t,i):v._blendVec(e,t,i)},v._stableSort=function(e,t){for(var i=e.length,n=0;n<i-1;++n)for(var a=n+1;a<i;++a)if(t(e[a],e[n])){var s=e[n];e[n]=e[a],e[a]=s}};var e=v.prototype;return e.addClip=function(e){for(var t=this._targets,i=e.track.curves,n=e.snapshot,a=[],s=[],r=0;r<i.length;++r)for(var o=i[r].paths,l=0;l<o.length;++l){var h=o[l],c=this._binder.resolve(h),u=t[c&&c.targetPath||null];if(!u&&c){u={target:c,value:[],curves:0,blendCounter:0};for(var d=0;d<u.target.components;++d)u.value.push(0);t[c.targetPath]=u}u&&(u.curves++,a.push(n._results[r]),s.push(u))}this._clips.push(e),this._inputs.push(a),this._outputs.push(s)},e.removeClip=function(e){for(var t=this._targets,i=this._clips,n=i[e].track.curves,a=0;a<n.length;++a)for(var s=n[a].paths,r=0;r<s.length;++r){var o=s[r],l=this._binder.resolve(o);l&&(l.curves--,0===l.curves&&(this._binder.unresolve(o),delete t[l.targetPath]))}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)},e.removeClips=function(){for(;0<this._clips.length;)this.removeClip(0)},e.findClip=function(e){for(var t=this._clips,i=0;i<t.length;++i){var n=t[i];if(n.name===e)return n}return null},e.rebind=function(){var t=this;this._binder.rebind(),this._targets={};var e=[].concat(this.clips);this.removeClips(),e.forEach(function(e){t.addClip(e)})},e.update=function(e){var t,i,n=this._clips,a=n.map(function(e,t){return t});for(v._stableSort(a,function(e,t){return n[e].blendOrder<n[t].blendOrder}),t=0;t<a.length;++t){var s,r,o,l=a[t],h=n[l],c=this._inputs[l],u=this._outputs[l],d=h.blendWeight;if(0<d&&h._update(e),1<=d)for(i=0;i<c.length;++i)s=c[i],o=(r=u[i]).value,v._set(o,s,r.target.type),r.blendCounter++;else if(0<d)for(i=0;i<c.length;++i)s=c[i],o=(r=u[i]).value,0===r.blendCounter?v._set(o,s,r.target.type):v._blend(o,s,d,r.target.type),r.blendCounter++}var p=this._targets;for(var f in p)if(p.hasOwnProperty(f)){var m=p[f];m.target.func(m.value),m.blendCounter=0}this._binder.update(e)},c(v,[{key:"clips",get:function(){return this._clips}}]),v}(),Jh=function(){function e(e,t,i,n){this._func=e,this._type=t,this._components=i,this._targetPath=n}return c(e,[{key:"func",get:function(){return this._func}},{key:"type",get:function(){return this._type}},{key:"components",get:function(){return this._components}},{key:"targetPath",get:function(){return this._targetPath}}]),e}(),ec=function(){function o(e){if(this.graph=e){var n={};!function e(t){n[t.name]=t;for(var i=0;i<t.children.length;++i)e(t.children[i])}(e),this.nodes=n,this.targetCache={};var r=function(e){for(var t,i=e;i&&!(i instanceof Cr);)i=i.parent;return i&&(i.render?t=i.render.meshInstances:i.model&&(t=i.model.meshInstances)),t};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(e){var t=e.localPosition;return o.createAnimTarget(function(e){t.set.apply(t,e)},"vector",3,e,"localPosition")},localRotation:function(e){var t=e.localRotation;return o.createAnimTarget(function(e){t.set.apply(t,e)},"quaternion",4,e,"localRotation")},localScale:function(e){var t=e.localScale;return o.createAnimTarget(function(e){t.set.apply(t,e)},"vector",3,e,"localScale")},weights:function(e){var t=r(e);if(t){for(var n=[],i=0;i<t.length;++i)t[i].node.name===e.name&&t[i].morphInstance&&n.push(t[i].morphInstance);if(0<n.length)return o.createAnimTarget(function(e){for(var t=0;t<e.length;++t)for(var i=0;i<n.length;i++)n[i].setWeight(t,e[t])},"vector",n[0].morph._targets.length,e,"weights")}return null},materialTexture:function(e,i){var t=r(e);if(t){for(var n,a=0;a<t.length;++a)if(t[a].node.name===e.name){n=t[a];break}if(n){var s=function(e){var t=this.animComponent.system.app.assets.get(e[0]);t&&t.resource&&"texture"===t.type&&(n.material[i]=t.resource,n.material.update())}.bind(this);return o.createAnimTarget(s,"vector",1,e,"materialTexture","material")}}return null}.bind(this)}}}var e=o.prototype;return e.findNode=function(e){var t;return this.graph&&(t=this.graph.findByPath(e.entityPath)),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t},o.createAnimTarget=function(e,t,i,n,a,s){var r=Rr.encode(n.path,s||"entity",a);return new Jh(e,t,i,r)},e.resolve=function(e){var t=Rr.encode(e.entityPath,e.component,e.propertyPath),i=this.targetCache[t];if(i)return i;var n=this.findNode(e);if(!n)return null;var a=this.handlers[e.propertyPath];return a&&(i=a(n))?(this.targetCache[t]=i,this.nodeCounts[n.path]?this.nodeCounts[n.path]++:(this.activeNodes.push(n),this.nodeCounts[n.path]=1),i):null},e.unresolve=function(e){if("graph"===e.component){var t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,0===this.nodeCounts[t.path]){var i=this.activeNodes,n=i.indexOf(t.node),a=i.length;n<a-1&&(i[n]=i[a-1]),i.pop()}}},e.update=function(e){for(var t=this.activeNodes,i=0;i<t.length;++i)t[i]._dirtifyLocal()},o}(),tc=function(){function e(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new fe,this._pos=new de,this._scale=new de,this._targetNode=null}var t=e.prototype;return t.getTarget=function(){return this._targetNode},t.setTarget=function(e){this._targetNode=e},e}(),ic=function(){function e(e){this._animation=null,this._time=0,this.looping=!0,this.lerping=!0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;var a=this;!function e(t){var i=new tc;i._name=t.name,a._interpolatedKeys.push(i),a._interpolatedKeyDict[t.name]=i;for(var n=a._currKeyIndices[t.name]=0;n<t._children.length;n++)e(t._children[n])}(e)}var t=e.prototype;return t.addTime=function(e){if(null!==this._animation){var t,i,n,a,s,r,o,l,h=this._animation._nodes,c=this._animation.duration;if(this._time===c&&!this.looping)return;if(this._time+=e,this._time>c)for(this._time=this.looping?0:c,t=0;t<h.length;t++)n=(i=h[t])._name,this._currKeyIndices[n]=0;else if(this._time<0)for(this._time=this.looping?c:0,t=0;t<h.length;t++)n=(i=h[t])._name,this._currKeyIndices[n]=i._keys.length-2;var u,d=0<=e?1:-1;for(t=0;t<h.length;t++)if(n=(i=h[t])._name,a=i._keys,void 0!==(s=this._interpolatedKeyDict[n])){if(u=!1,1!==a.length)for(var p=this._currKeyIndices[n];p<a.length-1&&0<=p;p+=d)if(r=a[p],o=a[p+1],r.time<=this._time&&o.time>=this._time){l=(this._time-r.time)/(o.time-r.time),l=this.lerping?l:.5<=l?1:0,s._pos.lerp(r.position,o.position,l),s._quat.slerp(r.rotation,o.rotation,l),s._scale.lerp(r.scale,o.scale,l),s._written=!0,this._currKeyIndices[n]=p,u=!0;break}(1===a.length||!u&&0===this._time&&this.looping)&&(s._pos.copy(a[0].position),s._quat.copy(a[0].rotation),s._scale.copy(a[0].scale),s._written=!0)}}},t.blend=function(e,t,i){for(var n=this._interpolatedKeys.length,a=0;a<n;a++){var s=e._interpolatedKeys[a],r=t._interpolatedKeys[a],o=this._interpolatedKeys[a];s._written&&r._written?(o._quat.slerp(s._quat,t._interpolatedKeys[a]._quat,i),o._pos.lerp(s._pos,t._interpolatedKeys[a]._pos,i),o._scale.lerp(s._scale,r._scale,i),o._written=!0):s._written?(o._quat.copy(s._quat),o._pos.copy(s._pos),o._scale.copy(s._scale),o._written=!0):r._written&&(o._quat.copy(r._quat),o._pos.copy(r._pos),o._scale.copy(r._scale),o._written=!0)}},t.setGraph=function(e){var t;if(this.graph=e)for(t=0;t<this._interpolatedKeys.length;t++){var i=this._interpolatedKeys[t],n=e.findByName(i._name);this._interpolatedKeys[t].setTarget(n)}else for(t=0;t<this._interpolatedKeys.length;t++)this._interpolatedKeys[t].setTarget(null)},t.updateGraph=function(){if(this.graph)for(var e=0;e<this._interpolatedKeys.length;e++){var t=this._interpolatedKeys[e];if(t._written){var i=t.getTarget();i.localPosition.copy(t._pos),i.localRotation.copy(t._quat),i.localScale.copy(t._scale),i._dirtyLocal||i._dirtifyLocal(),t._written=!1}}},c(e,[{key:"animation",get:function(){return this._animation},set:function(e){this._animation=e,this.currentTime=0}},{key:"currentTime",get:function(){return this._time},set:function(e){this._time=e;for(var t=this._interpolatedKeys.length,i=0;i<t;i++){var n=this._interpolatedKeys[i]._name;this._currKeyIndices[n]=0}this.addTime(0),this.updateGraph()}},{key:"numNodes",get:function(){return this._interpolatedKeys.length}}]),e}(),nc=function(o){function e(e,t){var i;return(i=o.call(this,e,t)||this).animationsIndex={},i.on("set_animations",i.onSetAnimations,g(i)),i.on("set_assets",i.onSetAssets,g(i)),i.on("set_loop",i.onSetLoop,g(i)),i.on("set_lerp",i.onSetLerp,g(i)),i}u(e,o);var t=e.prototype;return t.play=function(e,t){if(this.enabled&&this.entity.enabled){var i=this.data;if(i.animations[e]){if(t=t||0,i.prevAnim=i.currAnim,i.currAnim=e,i.model){i.skeleton||i.animEvaluator||this._createAnimationController();var n=i.animations[i.prevAnim],a=i.animations[i.currAnim];if(i.blending=0<t&&i.prevAnim,i.blending&&(i.blend=0,i.blendSpeed=1/t),i.skeleton&&(i.blending?(i.fromSkel.animation=n,i.fromSkel.addTime(i.skeleton._time),i.toSkel.animation=a):i.skeleton.animation=a),i.animEvaluator){var s=i.animEvaluator;if(i.blending)for(;1<s.clips.length;)s.removeClip(0);else i.animEvaluator.removeClips();var r=new Zh(i.animations[i.currAnim],0,1,!0,i.loop);r.name=i.currAnim,r.blendWeight=i.blending?0:1,r.reset(),i.animEvaluator.addClip(r)}}i.playing=!0}}},t.getAnimation=function(e){return this.data.animations[e]},t.setModel=function(e){var t=this.data;e!==t.model&&(this._resetAnimationController(),t.model=e,t.animations&&t.currAnim&&t.animations[t.currAnim]&&this.play(t.currAnim))},t._resetAnimationController=function(){var e=this.data;e.skeleton=null,e.fromSkel=null,e.toSkel=null,e.animEvaluator=null},t._createAnimationController=function(){var e=this.data,t=e.model,i=e.animations,n=!1,a=!1;for(var s in i)i.hasOwnProperty(s)&&(i[s].constructor===Er?a=!0:n=!0);var r=t.getGraph();n?(e.fromSkel=new ic(r),e.toSkel=new ic(r),e.skeleton=new ic(r),e.skeleton.looping=e.loop,e.skeleton.lerping=e.lerp,e.skeleton.setGraph(r)):a&&(e.animEvaluator=new Qh(new ec(this.entity)))},t.loadAnimationAssets=function(e){if(e&&e.length){var t,i=this,n=this.system.app.assets,a=e.length,s=function(e){if(1<e.resources.length)for(var t=0;t<e.resources.length;t++)i.animations[e.resources[t].name]=e.resources[t],i.animationsIndex[e.id]=e.resources[t].name;else i.animations[e.name]=e.resource,i.animationsIndex[e.id]=e.name;i.animations=i.animations},r=function(e){e.off("change",i.onAssetChanged,i),e.on("change",i.onAssetChanged,i),e.off("remove",i.onAssetRemoved,i),e.on("remove",i.onAssetRemoved,i),e.resource?s(e):(e.once("load",s,i),i.enabled&&i.entity.enabled&&n.load(e))};for(t=0;t<a;t++){var o=n.get(e[t]);o?r(o):n.on("add:"+e[t],r)}}},t.onAssetChanged=function(e,t,i,n){var a;if("resource"===t||"resources"===t)if("resources"===t&&i&&0===i.length&&(i=null),i){var s=!1;if(1<i.length){if(n&&1<n.length)for(a=0;a<n.length;a++)delete this.animations[n[a].name];else delete this.animations[e.name];for(s=!1,a=0;a<i.length;a++)this.animations[i[a].name]=i[a],s||this.data.currAnim!==i[a].name||this.data.playing&&this.data.enabled&&this.entity.enabled&&(s=!0,this.play(i[a].name,0));s||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(n&&1<n.length)for(a=0;a<n.length;a++)delete this.animations[n[a].name];this.animations[e.name]=i[0]||i,s=!1,this.data.currAnim===e.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(s=!0,this.play(e.name,0)),s||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[e.id]=e.name}else{if(1<n.length)for(a=0;a<n.length;a++)delete this.animations[n[a].name],this.data.currAnim===n[a].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.data.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}},t.onAssetRemoved=function(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(1<e.resources.length)for(var t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.data.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.data.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}},t._stopCurrentAnimation=function(){var e=this.data;if(e.currAnim=null,e.playing=!1,e.skeleton&&(e.skeleton.currentTime=0,e.skeleton.animation=null),e.animEvaluator){for(var t=0;t<e.animEvaluator.clips.length;++t)e.animEvaluator.clips[t].stop();e.animEvaluator.update(0),e.animEvaluator.removeClips()}},t.onSetAnimations=function(e,t,i){var n=this.data,a=this.entity.model;if(a){var s=a.model;s&&s!==n.model&&this.setModel(s)}if(!n.currAnim&&n.activate&&n.enabled&&this.entity.enabled)for(var r in n.animations){this.play(r,0);break}},t.onSetAssets=function(e,t,i){if(t&&t.length)for(var n=0;n<t.length;n++)if(t[n]){var a=this.system.app.assets.get(t[n]);if(a){a.off("change",this.onAssetChanged,this),a.off("remove",this.onAssetRemoved,this);var s=this.animationsIndex[a.id];this.data.currAnim===s&&this._stopCurrentAnimation(),delete this.animations[s],delete this.animationsIndex[a.id]}}var r=i.map(function(e){return e instanceof Kr?e.id:e});this.loadAnimationAssets(r)},t.onSetLoop=function(e,t,i){var n=this.data;if(n.skeleton&&(n.skeleton.looping=n.loop),n.animEvaluator)for(var a=0;a<n.animEvaluator.clips.length;++a)n.animEvaluator.clips[a].loop=n.loop},t.onSetLerp=function(e,t,i){this.data.skeleton&&(this.data.skeleton.lerping=this.data.lerp)},t.onSetCurrentTime=function(e,t,i){var n=this.data;if(n.skeleton){var a=n.skeleton;a.currentTime=i,a.addTime(0),a.updateGraph()}if(n.animEvaluator)for(var s=n.animEvaluator,r=0;r<s.clips.length;++r)s.clips[r].time=i},t.onEnable=function(){o.prototype.onEnable.call(this);var e=this.data,t=e.assets,i=this.system.app.assets;if(t)for(var n=0,a=t.length;n<a;n++){var s=t[n];s instanceof Kr||(s=i.get(s)),s&&!s.resource&&i.load(s)}if(e.activate&&!e.currAnim)for(var r in e.animations){this.play(r,0);break}},t.onBeforeRemove=function(){for(var e=0;e<this.assets.length;e++){var t=this.assets[e];"number"==typeof t&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this))}var i=this.data;delete i.animation,delete i.skeleton,delete i.fromSkel,delete i.toSkel,delete i.animEvaluator},c(e,[{key:"currentTime",get:function(){var e=this.data;if(e.skeleton)return this.data.skeleton._time;if(e.animEvaluator){var t=e.animEvaluator.clips;if(0<t.length)return t[t.length-1].time}return 0},set:function(e){var t=this.data;if(t.skeleton){var i=t.skeleton;i.currentTime=e,i.addTime(0),i.updateGraph()}if(t.animEvaluator)for(var n=t.animEvaluator,a=0;a<n.clips.length;++a)n.clips[a].time=e}},{key:"duration",get:function(){return this.data.animations[this.data.currAnim].duration}}]),e}(Xh),ac=function(){this.assets=[],this.speed=1,this.loop=!0,this.lerp=!0,this.activate=!0,this.enabled=!0,this.animations={},this.model=null,this.prevAnim=null,this.currAnim=null,this.blending=!1,this.blend=0,this.blendSpeed=0,this.playing=!1,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null},sc=["enabled","assets","speed","loop","lerp","activate","animations","skeleton","model","prevAnim","currAnim","fromSkel","toSkel","blending","blendTimeRemaining","playing"],rc=function(n){function e(e){var t;return(t=n.call(this,e)||this).id="animation",t.ComponentType=nc,t.DataType=ac,t.schema=sc,t.on("beforeremove",t.onBeforeRemove,g(t)),t.on("update",t.onUpdate,g(t)),qh.bind("update",t.onUpdate,g(t)),t}u(e,n);var t=e.prototype;return t.initializeComponentData=function(e,t,i){i=["activate","enabled","loop","lerp","speed","assets"],n.prototype.initializeComponentData.call(this,e,t,i)},t.cloneComponent=function(e,t){var i;this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.data.speed=e.animation.speed,t.animation.data.loop=e.animation.loop,t.animation.data.activate=e.animation.activate,t.animation.data.enabled=e.animation.enabled;var n={},a=e.animation.animations;for(i in a)a.hasOwnProperty(i)&&(n[i]=a[i]);t.animation.animations=n;var s={},r=e.animation.animationsIndex;for(i in r)r.hasOwnProperty(i)&&(s[i]=r[i]);t.animation.animationsIndex=s},t.onBeforeRemove=function(e,t){t.onBeforeRemove()},t.onUpdate=function(e){var t=this.store;for(var i in t)if(t.hasOwnProperty(i)){var n=t[i],a=n.data;if(a.enabled&&n.entity.enabled){if(a.blending&&(a.blend+=e*a.blendSpeed,1<=a.blend&&(a.blend=1)),a.playing){var s=a.skeleton;if(null!==s&&null!==a.model){if(a.blending)s.blend(a.fromSkel,a.toSkel,a.blend);else{var r=e*a.speed;s.addTime(r),(0<a.speed&&s._time===s._animation.duration&&!a.loop||a.speed<0&&0===s._time&&!a.loop)&&(a.playing=!1,this.fire("stop"))}a.blending&&1===a.blend&&(s.animation=a.toSkel._animation),s.updateGraph()}}var o=a.animEvaluator;if(o){for(var l=0;l<o.clips.length;++l){var h=o.clips[l];h.speed=a.speed,a.playing?h.resume():h.pause()}a.blending&&(o.clips[1].blendWeight=a.blend),o.update(e)}a.blending&&1===a.blend&&(a.blending=!1)}}},e}(qh);Xh._buildAccessors(nc.prototype,sc);var oc=function(){function e(e,t,i,n,a){void 0===a&&(a=1),this._state=e,this._parent=t,this._name=i,Array.isArray(n)?(this._point=new J(n[0],n[1]),this._pointLength=this._point.length()):(this._point=n,this._pointLength=n),this._speed=a,this._weightedSpeed=1,this._weight=1,this._animTrack=null}return c(e,[{key:"parent",get:function(){return this._parent}},{key:"name",get:function(){return this._name}},{key:"path",get:function(){return this._parent?this._parent.path+"."+this._name:this._name}},{key:"point",get:function(){return this._point}},{key:"pointLength",get:function(){return this._pointLength}},{key:"weight",get:function(){return this._parent?this._parent.weight*this._weight:this._weight},set:function(e){this._weight=e}},{key:"normalizedWeight",get:function(){var e=this._state.totalWeight;return 0===e?0:this.weight/e}},{key:"speed",get:function(){return this._weightedSpeed*this._speed}},{key:"absoluteSpeed",get:function(){return Math.abs(this._speed)}},{key:"weightedSpeed",get:function(){return this._weightedSpeed},set:function(e){this._weightedSpeed=e}},{key:"animTrack",get:function(){return this._animTrack},set:function(e){this._animTrack=e}}]),e}(),lc=function(d){function i(e,t,i,n,a,s,r,o,l){var h;(h=d.call(this,e,t,i,n)||this)._parameters=a,h._parameterValues=new Array(a.length),h._children=[],h._findParameter=l,h._syncAnimations=!1!==r,h._pointCache={};for(var c=0;c<s.length;c++){var u=s[c];u.children?h._children.push(o(u.type,g(h),null,i,1,u.parameter?[u.parameter]:u.parameters,u.children,o,l)):h._children.push(new oc(e,g(h),u.name,u.point,u.speed))}return h}u(i,d);var e=i.prototype;return e.getChild=function(e){for(var t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null},e.updateParameterValues=function(){for(var e=!0,t=0;t<this._parameterValues.length;t++){var i=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==i&&(this._parameterValues[t]=i,e=!1)}return e},e.getNodeWeightedDuration=function(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight},e.getNodeCount=function(){for(var e=0,t=0;t<this._children.length;t++)this._children[t].constructor===i?e+=this._children[t].getNodeCount():e++;return e},c(i,[{key:"weight",get:function(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}},{key:"syncAnimations",get:function(){return this._syncAnimations}}]),i}(oc),hc=function(h){function e(e,t,i,n,a,s,r,o,l){return s.sort(function(e,t){return e.point-t.point}),h.call(this,e,t,i,n,a,s,r,o,l)||this}return u(e,h),e.prototype.calculateWeights=function(){if(!this.updateParameterValues()){var e,t=0;for(e=this._children[0].weight=0;e<this._children.length;e++){var i=this._children[e];if(e!==this._children.length-1){var n=this._children[e+1];if(i.point===n.point)i.weight=.5,n.weight=.5;else if(Se.between(this._parameterValues[0],i.point,n.point,!0)){var a=Math.abs(i.point-n.point),s=(a-Math.abs(i.point-this._parameterValues[0]))/a;i.weight=s,n.weight=1-s}else n.weight=0}this._syncAnimations&&(t+=i.animTrack.duration/i.absoluteSpeed*i.weight)}if(this._syncAnimations)for(e=0;e<this._children.length;e++){var r=this._children[e];r.weightedSpeed=r.animTrack.duration/r.absoluteSpeed/t}}},e}(lc),cc=function(e){function d(){return e.apply(this,arguments)||this}u(d,e);var t=d.prototype;return t.pointDistanceCache=function(e,t){var i=""+e+t;return this._pointCache[i]||(this._pointCache[i]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[i]},t.calculateWeights=function(){var e;if(!this.updateParameterValues()){var t,i,n,a,s,r,o,l;for((e=d._p).set.apply(e,this._parameterValues),t=l=o=0;t<this._children.length;t++){var h,c=this._children[t];for(n=c.point,(h=d._pip).set.apply(h,d._p.data).sub(n),s=Number.MAX_VALUE,i=0;i<this._children.length;i++)t!==i&&(a=this.pointDistanceCache(t,i),(r=Se.clamp(1-d._pip.dot(a)/a.lengthSq(),0,1))<s&&(s=r));o+=c.weight=s,this._syncAnimations&&(l+=c.animTrack.duration/c.absoluteSpeed*c.weight)}for(t=0;t<this._children.length;t++){var u=this._children[t];u.weight=u._weight/o,this._syncAnimations&&(u.weightedSpeed=u.animTrack.duration/u.absoluteSpeed/l)}}},d}(lc);cc._p=new J,cc._pip=new J;var uc=function(e){function m(){return e.apply(this,arguments)||this}u(m,e);var t=m.prototype;return t.pointCache=function(e,t){var i=""+e+t;return this._pointCache[i]||(this._pointCache[i]=new J((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),2*J.angleRad(this._children[e].point,this._children[t].point))),this._pointCache[i]},t.calculateWeights=function(){var e;if(!this.updateParameterValues()){var t,i,n,a,s,r,o,l;(e=m._p).set.apply(e,this._parameterValues);var h=m._p.length();for(t=l=o=0;t<this._children.length;t++){var c=this._children[t];n=c.point;var u=c.pointLength;for(s=Number.MAX_VALUE,i=0;i<this._children.length;i++)if(t!==i){var d=this._children[i].pointLength;a=this.pointCache(t,i),m._pip.set((h-u)/((d+u)/2),2*J.angleRad(n,m._p)),(r=Se.clamp(1-Math.abs(m._pip.dot(a)/a.lengthSq()),0,1))<s&&(s=r)}o+=c.weight=s,this._syncAnimations&&(l+=c.animTrack.duration/c.absoluteSpeed*c.weight)}for(t=0;t<this._children.length;t++){var p=this._children[t];if(p.weight=p._weight/o,this._syncAnimations){var f=p.animTrack.duration/l*o;p.weightedSpeed=p.absoluteSpeed*f}}}},m}(lc);uc._p=new J,uc._pip=new J;var dc=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t.prototype.calculateWeights=function(){if(!this.updateParameterValues()){var e,t=0,i=0;for(e=0;e<this._children.length;e++)if(t+=Math.max(this._parameterValues[e],0),this._syncAnimations){var n=this._children[e];i+=n.animTrack.duration/n.absoluteSpeed*n.weight}for(e=0;e<this._children.length;e++){var a=this._children[e];a.weight=Math.max(this._parameterValues[e],0)/t,this._syncAnimations&&(a.weightedSpeed=a.animTrack.duration/a.absoluteSpeed/i)}}},t}(lc),fc="INTEGER",mc="BOOLEAN",vc="TRIGGER",gc="START",_c="END",yc="ANY",bc=[gc,_c,yc],xc=function(){function e(e,t,i,n,a){this._controller=e,this._name=t,this._animations={},this._animationList=[],this._speed=i||1,this._loop=void 0===n||n;var s=this._controller.findParameter.bind(this._controller);this._blendTree=a?this._createTree(a.type,this,null,t,1,a.parameter?[a.parameter]:a.parameters,a.children,a.syncAnimations,this._createTree,s):new oc(this,null,t,1,i)}var t=e.prototype;return t._createTree=function(e,t,i,n,a,s,r,o,l,h){switch(e){case"1D":return new hc(t,i,n,a,s,r,o,l,h);case"2D_CARTESIAN":return new cc(t,i,n,a,s,r,o,l,h);case"2D_DIRECTIONAL":return new uc(t,i,n,a,s,r,o,l,h);case"DIRECT":return new dc(t,i,n,a,s,r,o,l,h)}},t._getNodeFromPath=function(e){for(var t=this._blendTree,i=1;i<e.length;i++)t=t.getChild(e[i]);return t},t.addAnimation=function(e,t){var i=e.join("."),n=this._animationList.findIndex(function(e){return e.path===i});if(0<=n)this._animationList[n].animTrack=t;else{var a=this._getNodeFromPath(e);a.animTrack=t,this._animationList.push(a)}},c(e,[{key:"name",get:function(){return this._name}},{key:"animations",get:function(){return this._animationList},set:function(e){this._animationList=e}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e}},{key:"nodeCount",get:function(){return this._blendTree&&this._blendTree.constructor!==oc?this._blendTree.getNodeCount():1}},{key:"playable",get:function(){return-1!==bc.indexOf(this.name)||this.animations.length===this.nodeCount}},{key:"looping",get:function(){if(0<this.animations.length){var e=this.name+"."+this.animations[0].animTrack.name,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return!1}},{key:"totalWeight",get:function(){var e,t=0;for(e=0;e<this.animations.length;e++)t+=this.animations[e].weight;return t}},{key:"timelineDuration",get:function(){var e,t=0;for(e=0;e<this.animations.length;e++){var i=this.animations[e];i.animTrack.duration>t&&(t=i.animTrack.duration)}return t}}]),e}(),Mc=function(){function e(e){var t=e.from,i=e.to,n=e.time,a=void 0===n?0:n,s=e.priority,r=void 0===s?0:s,o=e.conditions,l=void 0===o?[]:o,h=e.exitTime,c=void 0===h?null:h,u=e.transitionOffset,d=void 0===u?null:u,p=e.interruptionSource,f=void 0===p?"NONE":p;this._from=t,this._to=i,this._time=a,this._priority=r,this._conditions=l,this._exitTime=c,this._transitionOffset=d,this._interruptionSource=f}return c(e,[{key:"from",get:function(){return this._from}},{key:"to",get:function(){return this._to},set:function(e){this._to=e}},{key:"time",get:function(){return this._time}},{key:"priority",get:function(){return this._priority}},{key:"conditions",get:function(){return this._conditions}},{key:"exitTime",get:function(){return this._exitTime}},{key:"transitionOffset",get:function(){return this._transitionOffset}},{key:"interruptionSource",get:function(){return this._interruptionSource}},{key:"hasExitTime",get:function(){return!!this.exitTime}}]),e}(),Sc=function(){function e(e,t,i,n,a,s){this._animEvaluator=e,this._states={},this._stateNames=[],this._eventHandler=s;for(var r=0;r<t.length;r++)this._states[t[r].name]=new xc(this,t[r].name,t[r].speed,t[r].loop,t[r].blendTree),this._stateNames.push(t[r].name);this._transitions=i.map(function(e){return new Mc(h({},e))}),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._parameters=n,this._previousStateName=null,this._activeStateName=gc,this._playing=!1,this._activate=a,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource="NONE",this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}var t=e.prototype;return t._findState=function(e){return this._states[e]},t._getActiveStateProgressForTime=function(e){if(this.activeStateName===gc||this.activeStateName===_c||this.activeStateName===yc)return 1;var t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?e/t.track.duration:null},t._findTransitionsFromState=function(t){var e=this._findTransitionsFromStateCache[t];return e||((e=this._transitions.filter(function(e){return e.from===t})).sort(function(e,t){return e.priority<t.priority}),this._findTransitionsFromStateCache[t]=e),e},t._findTransitionsBetweenStates=function(t,i){var e=this._findTransitionsBetweenStatesCache[t+"->"+i];return e||((e=this._transitions.filter(function(e){return e.from===t&&e.to===i})).sort(function(e,t){return e.priority<t.priority}),this._findTransitionsBetweenStatesCache[t+"->"+i]=e),e},t._transitionHasConditionsMet=function(e){for(var t=!0,i=0;i<e.conditions.length;i++){var n=e.conditions[i],a=this.findParameter(n.parameterName);switch(n.predicate){case"GREATER_THAN":t=t&&a.value>n.value;break;case"LESS_THAN":t=t&&a.value<n.value;break;case"GREATER_THAN_EQUAL_TO":t=t&&a.value>=n.value;break;case"LESS_THAN_EQUAL_TO":t=t&&a.value<=n.value;break;case"EQUAL_TO":t=t&&a.value===n.value;break;case"NOT_EQUAL_TO":t=t&&a.value!==n.value}if(!t)return t}return t},t._findTransition=function(e,t){var i=[];if(e&&t)i.concat(this._findTransitionsBetweenStates(e,t));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(yc));break;case"NEXT_STATE":i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(yc));break;case"PREV_STATE_NEXT_STATE":i=(i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(yc));break;case"NEXT_STATE_PREV_STATE":i=(i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(yc))}else i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(yc));if(0<(i=i.filter(function(e){if(e.to===this.activeStateName)return!1;if(e.hasExitTime){var t=this._getActiveStateProgressForTime(this._timeInStateBefore),i=this._getActiveStateProgressForTime(this._timeInState);if(e.exitTime<1&&this.activeState.loop&&(t-=Math.floor(t),i-=Math.floor(i)),!(e.exitTime>t&&e.exitTime<=i))return null}return this._transitionHasConditionsMet(e)}.bind(this))).length){var n=i[0];if(n.to===_c){var a=this._findTransitionsFromState(gc)[0];n.to=a.to}return n}return null},t.updateStateFromTransition=function(e){var t,i,n;this.previousState=e.from,this.activeState=e.to;for(var a=0;a<e.conditions.length;a++){var s=e.conditions[a],r=this.findParameter(s.parameterName);r.type===vc&&(r.value=!1)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});for(var o=Math.min(this._currTransitionTime/this._totalTransitionTime,1),l=0;l<this._transitionPreviousStates.length;l++){this._isTransitioning?l!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[l].weight*=1-o:this._transitionPreviousStates[l].weight=o:this._transitionPreviousStates[l].weight=1,t=this._findState(this._transitionPreviousStates[l].name);for(var h=0;h<t.animations.length;h++)i=t.animations[h],(n=this._animEvaluator.findClip(i.name+".previous."+l))||((n=this._animEvaluator.findClip(i.name)).name=i.name+".previous."+l),l!==this._transitionPreviousStates.length-1&&n.pause()}}this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;var c=this.activeState,u=e.transitionOffset&&0<e.transitionOffset&&e.transitionOffset<1,d=0,p=0;if(u){var f=c.timelineDuration*e.transitionOffset;p=d=f}this._timeInState=d,this._timeInStateBefore=p;for(var m=0;m<c.animations.length;m++){if(n=this._animEvaluator.findClip(c.animations[m].name))n.reset();else{var v=Number.isFinite(c.animations[m].speed)?c.animations[m].speed:c.speed;(n=new Zh(c.animations[m].animTrack,this._timeInState,v,!0,c.loop,this._eventHandler)).name=c.animations[m].name,this._animEvaluator.addClip(n)}if(0<e.time?n.blendWeight=0:n.blendWeight=c.animations[m].normalizedWeight,n.play(),u)n.time=c.timelineDuration*e.transitionOffset;else{var g=0<=c.speed?0:this.activeStateDuration;n.time=g}}},t._transitionToState=function(e){if(this._findState(e)){var t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new Mc({from:null,to:e})),this.updateStateFromTransition(t)}},t.assignAnimation=function(e,t,i,n){var a=e.split("."),s=this._findState(a[0]);s||(s=new xc(this,a[0],1),this._states[a[0]]=s,this._stateNames.push(a[0])),s.addAnimation(a,t),void 0!==i&&(s.speed=i),void 0!==n&&(s.loop=n),!this._playing&&this._activate&&this.playable&&this.play()},t.removeNodeAnimations=function(e){if(-1===bc.indexOf(e)){var t=this._findState(e);if(t)return t.animations=[],!0}},t.play=function(e){e&&this._transitionToState(e),this._playing=!0},t.pause=function(){this._playing=!1},t.reset=function(){this._previousStateName=null,this._activeStateName=gc,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()},t.rebind=function(){this._animEvaluator.rebind()},t.update=function(e){if(this._playing){var t,i,n;this._timeInStateBefore=this._timeInState,this._timeInState+=e;var a=this._findTransition(this._activeStateName);if(a&&this.updateStateFromTransition(a),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){for(var s=this._currTransitionTime/this._totalTransitionTime,r=0;r<this._transitionPreviousStates.length;r++){t=this._findState(this._transitionPreviousStates[r].name);for(var o=this._transitionPreviousStates[r].weight,l=0;l<t.animations.length;l++)i=t.animations[l],(n=this._animEvaluator.findClip(i.name+".previous."+r))&&(n.blendWeight=(1-s)*i.normalizedWeight*o)}t=this.activeState;for(var h=0;h<t.animations.length;h++)i=t.animations[h],this._animEvaluator.findClip(i.name).blendWeight=s*i.normalizedWeight}else{this._isTransitioning=!1;for(var c=this.activeStateAnimations.length,u=this._animEvaluator.clips.length,d=0;d<u-c;d++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(var p=0;p<t.animations.length;p++)i=t.animations[p],(n=this._animEvaluator.findClip(i.name))&&(n.blendWeight=i.normalizedWeight)}else if(this.activeState._blendTree.constructor!==oc){t=this.activeState;for(var f=0;f<t.animations.length;f++)i=t.animations[f],(n=this._animEvaluator.findClip(i.name))&&(n.blendWeight=i.normalizedWeight,i.parent.syncAnimations&&(n.speed=i.speed))}this._animEvaluator.update(e)}},t.findParameter=function(e){return this._parameters[e]},c(e,[{key:"animEvaluator",get:function(){return this._animEvaluator}},{key:"activeState",get:function(){return this._findState(this._activeStateName)},set:function(e){this._activeStateName=e}},{key:"activeStateName",get:function(){return this._activeStateName}},{key:"activeStateAnimations",get:function(){return this.activeState.animations}},{key:"previousState",get:function(){return this._findState(this._previousStateName)},set:function(e){this._previousStateName=e}},{key:"previousStateName",get:function(){return this._previousStateName}},{key:"playable",get:function(){for(var e=!0,t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}},{key:"playing",get:function(){return this._playing},set:function(e){this._playing=e}},{key:"activeStateProgress",get:function(){return this._getActiveStateProgressForTime(this._timeInState)}},{key:"activeStateDuration",get:function(){if(this.activeStateName===gc||this.activeStateName===_c)return 0;for(var e=0,t=0;t<this.activeStateAnimations.length;t++){var i=this._animEvaluator.findClip(this.activeStateAnimations[t].name);i&&(e=Math.max(e,i.track.duration))}return e}},{key:"activeStateCurrentTime",get:function(){return this._timeInState},set:function(e){this._timeInStateBefore=e,this._timeInState=e;for(var t=0;t<this.activeStateAnimations.length;t++){var i=this.animEvaluator.findClip(this.activeStateAnimations[t].name);i&&(i.time=e)}}},{key:"transitioning",get:function(){return this._isTransitioning}},{key:"transitionProgress",get:function(){return this._currTransitionTime/this._totalTransitionTime}},{key:"states",get:function(){return this._stateNames}}]),e}(),wc=new J,Cc=new de,Pc=new ee,Tc=new $,Ac=new fe,Ec=function(n){function l(e,t){var i;return(i=n.call(this,t)||this).animComponent=e,i}u(l,n),l._packFloat=function(e){return e[0]},l._packBoolean=function(e){return!!e[0]},l._packVec2=function(e){return wc.x=e[0],wc.y=e[1],wc},l._packVec3=function(e){return Cc.x=e[0],Cc.y=e[1],Cc.z=e[2],Cc},l._packVec4=function(e){return Pc.x=e[0],Pc.y=e[1],Pc.z=e[2],Pc.w=e[3],Pc},l._packColor=function(e){return Tc.r=e[0],Tc.g=e[1],Tc.b=e[2],Tc.a=e[3],Tc},l._packQuat=function(e){return Ac.x=e[0],Ac.y=e[1],Ac.z=e[2],Ac.w=e[3],Ac};var e=l.prototype;return e.resolve=function(e){var t,i,n,a=Rr.encode(e.entityPath,e.component,e.propertyPath),s=this.targetCache[a];if(s)return s;switch(e.component){case"entity":t=this._getEntityFromHierarchy(e.entityPath),n=Rr.encode(t.path,"entity",e.propertyPath),i=t;break;case"graph":if(!(i=this.findNode(e)))return null;n=Rr.encode(i.path,"graph",e.propertyPath);break;default:if(!(i=(t=this._getEntityFromHierarchy(e.entityPath)).findComponent(e.component)))return null;n=Rr.encode(t.path,e.component,e.propertyPath)}return s=this._createAnimTargetForProperty(i,e.propertyPath,n),this.targetCache[a]=s},e.update=function(e){var t=this.activeNodes;if(t)for(var i=0;i<t.length;i++)t[i]._dirtifyLocal()},e._getEntityFromHierarchy=function(e){if(!this.animComponent.entity.name===e[0])return null;var t=this.animComponent.entity;return 1===e.length?t:t._parent.findByPath(e)},e._resolvePath=function(e,t,i){for(var n=t.length-(i?0:1),a=0;a<n;a++)e=e[t[a]];return e},e._setter=function(e,t,i){var n=this._resolvePath(e,t),a=t[t.length-1],s="set"+a.substring(0,1).toUpperCase()+a.substring(1);if(n[s]){var r=n[s].bind(n);return function(e){r(i(e))}}var o=n[a];if("object"==(void 0===o?"undefined":dx(o))&&o.hasOwnProperty("copy"))return function(e){o.copy(i(e))};if(-1!==[J,de,ee,$,fe].indexOf(n.constructor)&&1<t.length){var l=2<t.length?this._resolvePath(e,t.slice(0,-1)):e,h=t[t.length-2];return function(e){n[a]=i(e),l[h]=n}}return function(e){n[a]=i(e)}},e._createAnimTargetForProperty=function(t,e,i){if(this.handlers&&"weights"===e[0])return this.handlers.weights(t);if(this.handlers&&"material"===e[0]&&2===e.length){var n=e[1];if(n.indexOf("Map")===n.length-3)return this.handlers.materialTexture(t,n)}var a,s,r,o=this._resolvePath(t,e,!0);if(void 0===o)return null;if("number"==typeof o)a=this._setter(t,e,l._packFloat),s="vector",r=1;else if("boolean"==typeof o)a=this._setter(t,e,l._packBoolean),s="vector",r=1;else if("object"==(void 0===o?"undefined":dx(o)))switch(o.constructor){case J:a=this._setter(t,e,l._packVec2),s="vector",r=2;break;case de:a=this._setter(t,e,l._packVec3),s="vector",r=3;break;case ee:a=this._setter(t,e,l._packVec4),s="vector",r=4;break;case $:a=this._setter(t,e,l._packColor),s="vector",r=4;break;case fe:a=this._setter(t,e,l._packQuat),s="quaternion",r=4;break;default:return null}return-1!==e.indexOf("material")?new Jh(function(e){a(e),t.material.update()},s,r,i):new Jh(a,s,r,i)},e.rebind=function(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;var n={};!function e(t){n[t.name]=t;for(var i=0;i<t.children.length;++i)e(t.children[i])}(this.graph),this.nodes=n},l}(ec),Rc=function(){function e(e,t,i){this._name=e,this._controller=t,this._component=i}var t=e.prototype;return t.play=function(e){this._controller.play(e)},t.pause=function(){this._controller.pause()},t.reset=function(){this._controller.reset()},t.rebind=function(){this._controller.rebind()},t.update=function(e){this._controller.update(e)},t.assignAnimation=function(e,t,i,n){t.constructor===Er&&(this._controller.assignAnimation(e,t,i,n),this._component.activate&&this._component.playable&&(this._component.playing=!0))},t.removeNodeAnimations=function(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=!1)},t.transition=function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=null),this._controller.updateStateFromTransition(new Mc({from:this._controller.activeStateName,to:e,time:t,transitionOffset:i}))},c(e,[{key:"name",get:function(){return this._name}},{key:"playing",get:function(){return this._controller.playing},set:function(e){this._controller.playing=e}},{key:"playable",get:function(){return this._controller.playable}},{key:"activeState",get:function(){return this._controller.activeStateName}},{key:"previousState",get:function(){return this._controller.previousStateName}},{key:"activeStateProgress",get:function(){return this._controller.activeStateProgress}},{key:"activeStateDuration",get:function(){return this._controller.activeStateDuration}},{key:"activeStateCurrentTime",get:function(){return this._controller.activeStateCurrentTime},set:function(e){this._controller.activeStateCurrentTime=e}},{key:"transitioning",get:function(){return this._controller.transitioning}},{key:"transitionProgress",get:function(){return this.transitioning?this._controller.transitionProgress:null}},{key:"states",get:function(){return this._controller.states}}]),e}(),Dc=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._onStateGraphAssetChangeEvent=function(e){i._stateGraph=new bo(e._data),i.loadStateGraph(i._stateGraph)},i._stateGraphAsset=null,i._animationAssets={},i._speed=1,i._activate=!0,i._playing=!1,i._rootBone=null,i._stateGraph=null,i._layers=[],i._layerIndices={},i._parameters={},i}u(e,n);var t=e.prototype;return t._addLayer=function(e,t,i,n){var a;a=this.rootBone?this.rootBone:this.entity;var s=new Ec(this,a),r=new Qh(s),o=new Sc(r,t,i,this._parameters,this._activate,this);this._layers.push(new Rc(e,o,this)),this._layerIndices[e]=n},t.addLayer=function(e){var t=this.findAnimationLayer(e);if(t)return t;this._addLayer(e,[{name:"START",speed:1}],[],this._layers.length)},t.loadStateGraph=function(e){this._stateGraph=e,this._parameters={};for(var t=Object.keys(e.parameters),i=0;i<t.length;i++){var n=t[i];this._parameters[n]={type:e.parameters[n].type,value:e.parameters[n].value}}this._layers=[];for(var a=0;a<e.layers.length;a++){var s=e.layers[a];this._addLayer.bind(this)(s.name,s.states,s.transitions,a)}this.setupAnimationAssets()},t.setupAnimationAssets=function(){for(var e=0;e<this._layers.length;e++)for(var t=this._layers[e],i=t.name,n=0;n<t.states.length;n++){var a=t.states[n];if(-1===bc.indexOf(a)){var s=i+":"+a;this._animationAssets[s]||(this._animationAssets[s]={asset:null})}}this.loadAnimationAssets()},t.loadAnimationAssets=function(){for(var e=0;e<this._layers.length;e++)for(var t=this._layers[e],i=0;i<t.states.length;i++){var n=t.states[i];if(-1===bc.indexOf(n)){var a=this._animationAssets[t.name+":"+n];if(a&&a.asset){var s=a.asset,r=this.system.app.assets.get(s);if(r)if(r.resource){var o=r.resource;r.data.events&&(o.events=new Ar(Object.values(r.data.events))),this.findAnimationLayer(t.name).assignAnimation(n,o)}else r.once("load",function(t,i){return function(e){this.findAnimationLayer(t).assignAnimation(i,e.resource)}.bind(this)}.bind(this)(t.name,n)),this.system.app.assets.load(r)}else this.removeNodeAnimations(n,t.name)}}},t.removeStateGraph=function(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1},t.resetStateGraph=function(){if(this.stateGraphAsset){var e=this.system.app.assets.get(this.stateGraphAsset).resource;this.loadStateGraph(e)}else this.removeStateGraph()},t.reset=function(){this._parameters=Object.assign({},this._stateGraph.parameters);for(var e=0;e<this._layers.length;e++){var t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t}},t.rebind=function(){for(var e=0;e<this._layers.length;e++)this._layers[e].rebind()},t.findAnimationLayer=function(e){var t=this._layerIndices[e];return this._layers[t]||null},t.addAnimationState=function(e,t,i,n,a){void 0===i&&(i=1),void 0===n&&(n=!0),void 0===a&&(a="Base"),this._stateGraph||this.loadStateGraph(new bo({layers:[{name:a,states:[{name:"START",speed:1},{name:e,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));var s,r=this.findAnimationLayer(a);r?r.assignAnimation(e,t,i,n):null==(s=this.addLayer(a))||s.assignAnimation(e,t,i,n)},t.assignAnimation=function(e,t,i,n,a){if(void 0===n&&(n=1),void 0===a&&(a=!0),!this._stateGraph)return this.loadStateGraph(new bo({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:n,loop:a,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),void this.baseLayer.assignAnimation(e,t);var s=i?this.findAnimationLayer(i):this.baseLayer;s&&s.assignAnimation(e,t,n,a)},t.removeNodeAnimations=function(e,t){var i=t?this.findAnimationLayer(t):this.baseLayer;i&&i.removeNodeAnimations(e)},t.getParameterValue=function(e,t){var i=this._parameters[e];if(i&&i.type===t)return i.value},t.setParameterValue=function(e,t,i){var n=this._parameters[e];n&&n.type===t&&(n.value=i)},t.getFloat=function(e){return this.getParameterValue(e,"FLOAT")},t.setFloat=function(e,t){this.setParameterValue(e,"FLOAT",t)},t.getInteger=function(e){return this.getParameterValue(e,fc)},t.setInteger=function(e,t){"number"==typeof t&&t%1==0&&this.setParameterValue(e,fc,t)},t.getBoolean=function(e){return this.getParameterValue(e,mc)},t.setBoolean=function(e,t){this.setParameterValue(e,mc,!!t)},t.getTrigger=function(e){return this.getParameterValue(e,vc)},t.setTrigger=function(e){this.setParameterValue(e,vc,!0)},t.resetTrigger=function(e){this.setParameterValue(e,vc,!1)},t.onBeforeRemove=function(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent)},c(e,[{key:"stateGraphAsset",get:function(){return this._stateGraphAsset},set:function(e){var t,i,n=this;null!==e?(this._stateGraphAsset&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent),e instanceof Kr?(t=e.id,(i=this.system.app.assets.get(t))||(this.system.app.assets.add(e),i=this.system.app.assets.get(t))):(t=e,i=this.system.app.assets.get(t)),i&&this._stateGraphAsset!==t&&(i.resource?(this._stateGraph=i.resource,this.loadStateGraph(this._stateGraph),i.on("change",this._onStateGraphAssetChangeEvent)):(i.once("load",function(e){n._stateGraph=e.resource,n.loadStateGraph(n._stateGraph)}),i.on("change",this._onStateGraphAssetChangeEvent),this.system.app.assets.load(i)),this._stateGraphAsset=t)):this.removeStateGraph()}},{key:"animationAssets",get:function(){return this._animationAssets},set:function(e){this._animationAssets=e,this.loadAnimationAssets()}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"activate",get:function(){return this._activate},set:function(e){this._activate=e}},{key:"playing",get:function(){return this._playing},set:function(e){this._playing=e}},{key:"rootBone",get:function(){return this._rootBone},set:function(e){if("string"==typeof e){var t=this.entity.root.findByGuid(e);this._rootBone=t}else"Entity"===(null==e?void 0:e.constructor.name)?this._rootBone=e:this._rootBone=null;this.rebind()}},{key:"stateGraph",get:function(){return this._stateGraph},set:function(e){this._stateGraph=e}},{key:"layers",get:function(){return this._layers},set:function(e){this._layers=e}},{key:"layerIndicies",get:function(){return this._layerIndicies},set:function(e){this._layerIndicies=e}},{key:"parameters",get:function(){return this._parameters},set:function(e){this._parameters=e}},{key:"playable",get:function(){for(var e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}},{key:"baseLayer",get:function(){return 0<this._layers.length?this._layers[0]:null}}]),e}(Xh),Ic=function(){this.enabled=!0},kc=["enabled"],Lc=function(a){function e(e){var t;return(t=a.call(this,e)||this).id="anim",t.ComponentType=Dc,t.DataType=Ic,t.schema=kc,t.on("beforeremove",t.onBeforeRemove,g(t)),qh.bind("animationUpdate",t.onAnimationUpdate,g(t)),t}u(e,a);var t=e.prototype;return t.initializeComponentData=function(n,t,e){a.prototype.initializeComponentData.call(this,n,t,kc);var i=["animationAssets","stateGraph","layers"];Object.keys(t).forEach(function(e){i.includes(e)||(n[e]=t[e])}),t.stateGraph&&(n.stateGraph=t.stateGraph,n.loadStateGraph(n.stateGraph)),t.layers?t.layers.forEach(function(t,i){t._controller.states.forEach(function(e){t._controller._states[e]._animationList.forEach(function(e){n.layers[i].assignAnimation(e.name,e.animTrack)})})}):t.animationAssets&&(n.animationAssets=Object.assign(n.animationAssets,t.animationAssets))},t.onAnimationUpdate=function(e){var t=this.store;for(var i in t)if(t.hasOwnProperty(i)){var n=t[i].entity.anim;if(n.data.enabled&&n.entity.enabled&&n.playing)for(var a=0;a<n.layers.length;a++)n.layers[a].update(e*n.speed)}},t.cloneComponent=function(e,t){var i={stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters};this.addComponent(t,i)},t.onBeforeRemove=function(e,t){t.onBeforeRemove()},e}(qh);Xh._buildAccessors(Dc.prototype,kc);var Oc=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var i=t.prototype;return i.setCurrentListener=function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var e=this.system.current.getPosition();this.system.manager.listener.setPosition(e)}},i.onEnable=function(){this.setCurrentListener()},i.onDisable=function(){this.system.current===this.entity&&(this.system.current=null)},t}(Xh),Fc=function(){this.enabled=!0},zc=["enabled"],Bc=function(n){function e(e,t){var i;return(i=n.call(this,e)||this).id="audiolistener",i.ComponentType=Oc,i.DataType=Fc,i.schema=zc,i.manager=t,i.current=null,qh.bind("update",i.onUpdate,g(i)),i}u(e,n);var t=e.prototype;return t.initializeComponentData=function(e,t,i){i=["enabled"],n.prototype.initializeComponentData.call(this,e,t,i)},t.onUpdate=function(e){if(this.current){var t=this.current.getPosition();this.manager.listener.setPosition(t);var i=this.current.getWorldTransform();this.manager.listener.setOrientation(i)}},e}(qh);Xh._buildAccessors(Oc.prototype,zc);var Vc=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this).on("set_assets",i.onSetAssets,g(i)),i.on("set_loop",i.onSetLoop,g(i)),i.on("set_volume",i.onSetVolume,g(i)),i.on("set_pitch",i.onSetPitch,g(i)),i.on("set_minDistance",i.onSetMinDistance,g(i)),i.on("set_maxDistance",i.onSetMaxDistance,g(i)),i.on("set_rollOffFactor",i.onSetRollOffFactor,g(i)),i.on("set_distanceModel",i.onSetDistanceModel,g(i)),i.on("set_3d",i.onSet3d,g(i)),i}u(e,n);var t=e.prototype;return t.play=function(e){if(this.enabled&&this.entity.enabled){var t;this.channel&&this.stop();var i=this.data;if(i.sources[e])if(i["3d"]){var n=this.entity.getPosition();t=this.system.manager.playSound3d(i.sources[e],n,i),i.currentSource=e,i.channel=t}else t=this.system.manager.playSound(i.sources[e],i),i.currentSource=e,i.channel=t}},t.pause=function(){this.channel&&this.channel.pause()},t.unpause=function(){this.channel&&this.channel.paused&&this.channel.unpause()},t.stop=function(){this.channel&&(this.channel.stop(),this.channel=null)},t.onSetAssets=function(e,t,i){var n,a=[],s=i.length;if(t&&t.length)for(n=0;n<t.length;n++)if(t[n]){var r=this.system.app.assets.get(t[n]);r&&(r.off("change",this.onAssetChanged,this),r.off("remove",this.onAssetRemoved,this),this.currentSource===r.name&&this.stop())}if(s)for(n=0;n<s;n++)t.indexOf(i[n])<0&&(i[n]instanceof Kr?a.push(i[n].id):a.push(i[n]));!this.system._inTools&&a.length&&this.loadAudioSourceAssets(a)},t.onAssetChanged=function(e,t,i,n){"resource"===t&&this.data.sources&&(this.data.sources[e.name]=i,this.data.currentSource===e.name&&this.channel&&(this.channel.paused?(this.play(e.name),this.pause()):this.play(e.name)))},t.onAssetRemoved=function(e){e.off("remove",this.onAssetRemoved,this),this.data.sources[e.name]&&(delete this.data.sources[e.name],this.data.currentSource===e.name&&(this.stop(),this.data.currentSource=null))},t.onSetLoop=function(e,t,i){t!==i&&this.channel&&this.channel.setLoop(i)},t.onSetVolume=function(e,t,i){t!==i&&this.channel&&this.channel.setVolume(i)},t.onSetPitch=function(e,t,i){t!==i&&this.channel&&this.channel.setPitch(i)},t.onSetMaxDistance=function(e,t,i){t!==i&&this.channel instanceof mr&&this.channel.setMaxDistance(i)},t.onSetMinDistance=function(e,t,i){t!==i&&this.channel instanceof mr&&this.channel.setMinDistance(i)},t.onSetRollOffFactor=function(e,t,i){t!==i&&this.channel instanceof mr&&this.channel.setRollOffFactor(i)},t.onSetDistanceModel=function(e,t,i){t!==i&&this.channel instanceof mr&&this.channel.setDistanceModel(i)},t.onSet3d=function(e,t,i){if(t!==i&&this.system.initialized&&this.currentSource){var n=!1,a=!1;this.channel&&(n=this.channel.paused,a=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=n,this.channel.suspended=a)}},t.onEnable=function(){var e=this.data.assets;if(e)for(var t=this.system.app.assets,i=0,n=e.length;i<n;i++){var a=e[i];a instanceof Kr||(a=t.get(a)),a&&!a.resource&&t.load(a)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},t.onDisable=function(){this.pause()},t.loadAudioSourceAssets=function(i){var n=this,e=i.map(function(e){return this.system.app.assets.get(e)},this),a={},s=null,r=e.length,o=function(e){r--},l=function(){this.data.sources=a,this.data.currentSource=s,this.enabled&&this.activate&&s&&this.onEnable()}.bind(this);e.forEach(function(e,t){e?(s=s||e.name,e.off("change",this.onAssetChanged,this),e.on("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this),e.off("error",o,this),e.on("error",o,this),e.ready(function(e){a[e.name]=e.resource,0==--r&&l()}),!e.resource&&n.enabled&&n.entity.enabled&&this.system.app.assets.load(e)):(0==--r&&l(),this.system.app.assets.on("add:"+i[t],function(e){e.ready(function(e){n.data.sources[e.name]=e.resource}),e.resource||n.system.app.assets.load(e)}))},this)},e}(Xh),Uc=function(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=pr,this.paused=!0,this.sources={},this.currentSource=null,this.channel=null},Nc=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"],Gc=function(n){function e(e,t){var i;return(i=n.call(this,e)||this).id="audiosource",i.ComponentType=Vc,i.DataType=Uc,i.schema=Nc,i.manager=t,i.initialized=!1,qh.bind("initialize",i.onInitialize,g(i)),qh.bind("update",i.onUpdate,g(i)),i.on("remove",i.onRemove,g(i)),i}u(e,n);var t=e.prototype;return t.initializeComponentData=function(e,t,i){i=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],n.prototype.initializeComponentData.call(this,e,t,i),e.paused=!(e.enabled&&e.activate)},t.onInitialize=function(e){e.audiosource&&e.enabled&&e.audiosource.enabled&&e.audiosource.activate&&e.audiosource.play(e.audiosource.currentSource);var t,i=e._children,n=i.length;for(t=0;t<n;t++)i[t]instanceof Cr&&this.onInitialize(i[t]);this.initialized=!0},t.onUpdate=function(e){var t=this.store;for(var i in t)if(t.hasOwnProperty(i)){var n=t[i],a=n.entity,s=n.data;if(s.enabled&&a.enabled&&s.channel instanceof mr){var r=a.getPosition();s.channel.setPosition(r)}}},t.onRemove=function(e,t){t.channel&&(t.channel.stop(),t.channel=null)},t.setVolume=function(e){this.manager.setVolume(e)},e}(qh);Xh._buildAccessors(Vc.prototype,Nc);var Wc,Hc=function(a){function e(e,t,i){var n;if(n=a.call(this)||this,!(e&&e instanceof Xh))throw new Error("The parentComponent argument is required and must be a Component");if(!t||"string"!=typeof t)throw new Error("The propertyName argument is required and must be a string");if(i&&"object"!=(void 0===i?"undefined":dx(i)))throw new Error("If provided, the eventConfig argument must be an object");return n._parentComponent=e,n._entityPropertyName=t,n._entity=null,n._app=e.system.app,n._configureEventListeners(i||{},{"entity#destroy":n._onEntityDestroy}),n._toggleLifecycleListeners("on"),n}u(e,a);var t=e.prototype;return t._configureEventListeners=function(e,t){var i=this._parseEventListenerConfig(e,"external",this._parentComponent),n=this._parseEventListenerConfig(t,"internal",this);this._eventListenerConfigs=i.concat(n),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}},t._parseEventListenerConfig=function(r,o,l){return Object.keys(r).map(function(e,t){var i=e.split("#"),n=i[0],a=i[1],s=r[e];if(2!==i.length||"string"!=typeof n||0===n.length||"string"!=typeof a||0===a.length)throw new Error("Invalid event listener description: `"+e+"`");if("function"!=typeof s)throw new Error("Invalid or missing callback for event listener `"+e+"`");return{id:o+"_"+t+"_"+e,sourceName:n,eventName:a,callback:s,scope:l}},this)},t._toggleLifecycleListeners=function(e){this._parentComponent[e]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[e]("beforeremove",this._onParentComponentRemove,this),qh[e]("postinitialize",this._onPostInitialize,this),this._app[e]("tools:sceneloaded",this._onSceneLoaded,this);for(var t=[],i=0;i<this._eventListenerConfigs.length;++i){var n=this._eventListenerConfigs[i],a=this._app.systems[n.sourceName];a&&(-1===t.indexOf(a)&&t.push(a),a&&"gain"===n.eventName&&(this._gainListeners[n.sourceName]=n),a&&"lose"===n.eventName&&(this._loseListeners[n.sourceName]=n))}for(var s=0;s<t.length;++s)t[s][e]("add",this._onComponentAdd,this),t[s][e]("beforeremove",this._onComponentRemove,this)},t._onSetEntity=function(e,t,i){if(i instanceof Cr)this._updateEntityReference();else{if(null!=i&&"string"!=typeof i)return;t!==i&&this._updateEntityReference()}},t._onPostInitialize=function(){this._updateEntityReference()},t.onParentComponentEnable=function(){this._entity||this._updateEntityReference()},t._onSceneLoaded=function(){this._updateEntityReference()},t._updateEntityReference=function(){var e,t=this._parentComponent.data[this._entityPropertyName];if(t instanceof Cr)t=(e=t).getGuid(),this._parentComponent.data[this._entityPropertyName]=t;else{var i=this._parentComponent.system.app.root;e=this._parentComponent.entity.isDescendantOf(i)&&t?i.findByGuid(t):null}this._entity!==e&&(this._entity&&this._onBeforeEntityChange(),this._entity=e,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))},t._onBeforeEntityChange=function(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)},t._onAfterEntityChange=function(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)},t._onComponentAdd=function(e,t){var i=t.system.id;e===this._entity&&(this._callGainOrLoseListener(i,this._gainListeners),this._toggleComponentListeners("on",i))},t._onComponentRemove=function(e,t){var i=t.system.id;e===this._entity&&(this._callGainOrLoseListener(i,this._loseListeners),this._toggleComponentListeners("off",i,!0))},t._callAllGainOrLoseListeners=function(e){for(var t in this._entity.c)this._callGainOrLoseListener(t,e)},t._callGainOrLoseListener=function(e,t){if(this._entity.c.hasOwnProperty(e)&&t[e]){var i=t[e];i.callback.call(i.scope)}},t._toggleEntityListeners=function(e,t){if(this._entity)for(var i=0;i<this._eventListenerConfigs.length;++i)this._safeToggleListener(e,this._eventListenerConfigs[i],t)},t._toggleComponentListeners=function(e,t,i){for(var n=0;n<this._eventListenerConfigs.length;++n){var a=this._eventListenerConfigs[n];a.sourceName===t&&this._safeToggleListener(e,a,i)}},t._safeToggleListener=function(e,t,i){var n="on"===e;if(!n||!this._listenerStatusFlags[t.id]){var a=this._getEventSource(t.sourceName,i);a&&(a[e](t.eventName,t.callback,t.scope),this._listenerStatusFlags[t.id]=n)}},t._getEventSource=function(e,t){return"entity"===e?this._entity:this._entity[e]||null},t._onEntityDestroy=function(e){this._entity===e&&(this._toggleEntityListeners("off",!0),this._entity=null)},t._onParentComponentRemove=function(e,t){t===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))},t.hasComponent=function(e){return!(!this._entity||!this._entity.c||!this._entity.c[e])},c(e,[{key:"entity",get:function(){return this._entity}}]),e}(p),jc="DEFAULT",Xc="HOVER",qc="PRESSED",$c="INACTIVE",Yc={DEFAULT:"_defaultTint",HOVER:"hoverTint",PRESSED:"pressedTint",INACTIVE:"inactiveTint"},Kc={DEFAULT:"_defaultSpriteAsset",HOVER:"hoverSpriteAsset",PRESSED:"pressedSpriteAsset",INACTIVE:"inactiveSpriteAsset"},Zc={DEFAULT:"_defaultSpriteFrame",HOVER:"hoverSpriteFrame",PRESSED:"pressedSpriteFrame",INACTIVE:"inactiveSpriteFrame"},Qc=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._visualState=jc,i._isHovering=!1,i._hoveringCounter=0,i._isPressed=!1,i._defaultTint=new $(1,1,1,1),i._defaultSpriteAsset=null,i._defaultSpriteFrame=0,i._imageReference=new Hc(g(i),"imageEntity",{"element#gain":i._onImageElementGain,"element#lose":i._onImageElementLose,"element#set:color":i._onSetColor,"element#set:opacity":i._onSetOpacity,"element#set:spriteAsset":i._onSetSpriteAsset,"element#set:spriteFrame":i._onSetSpriteFrame}),i._toggleLifecycleListeners("on",e),i}u(e,n);var t=e.prototype;return t._toggleLifecycleListeners=function(e,t){this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)},t._onSetActive=function(e,t,i){t!==i&&this._updateVisualState()},t._onSetTransitionMode=function(e,t,i){t!==i&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState())},t._onSetTransitionValue=function(e,t,i){t!==i&&this._forceReapplyVisualState()},t._onElementComponentRemove=function(e){this.entity===e&&this._toggleHitElementListeners("off")},t._onElementComponentAdd=function(e){this.entity===e&&this._toggleHitElementListeners("on")},t._onImageElementLose=function(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)},t._onImageElementGain=function(){this._storeDefaultVisualState(),this._forceReapplyVisualState()},t._toggleHitElementListeners=function(e){if(this.entity.element){var t="on"===e;if(t&&this._hasHitElementListeners)return;this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t}},t._storeDefaultVisualState=function(){this._imageReference.hasComponent("element")&&(this._storeDefaultColor(this._imageReference.entity.element.color),this._storeDefaultOpacity(this._imageReference.entity.element.opacity),this._storeDefaultSpriteAsset(this._imageReference.entity.element.spriteAsset),this._storeDefaultSpriteFrame(this._imageReference.entity.element.spriteFrame))},t._storeDefaultColor=function(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b},t._storeDefaultOpacity=function(e){this._defaultTint.a=e},t._storeDefaultSpriteAsset=function(e){this._defaultSpriteAsset=e},t._storeDefaultSpriteFrame=function(e){this._defaultSpriteFrame=e},t._onSetColor=function(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())},t._onSetOpacity=function(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())},t._onSetSpriteAsset=function(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())},t._onSetSpriteFrame=function(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())},t._onMouseEnter=function(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)},t._onMouseLeave=function(e){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)},t._onMouseDown=function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)},t._onMouseUp=function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)},t._onTouchStart=function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)},t._onTouchEnd=function(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)},t._onTouchLeave=function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)},t._onTouchCancel=function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)},t._onSelectStart=function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",e)},t._onSelectEnd=function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",e)},t._onSelectEnter=function(e){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",e)},t._onSelectLeave=function(e){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",e)},t._onClick=function(e){this._fireIfActive("click",e)},t._fireIfActive=function(e,t){this.data.active&&this.fire(e,t)},t._updateVisualState=function(e){var t=this._visualState,i=this._determineVisualState();if((t!==i||e)&&this.enabled)switch(this._visualState=i,t===Xc&&this._fireIfActive("hoverend"),t===qc&&this._fireIfActive("pressedend"),i===Xc&&this._fireIfActive("hoverstart"),i===qc&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:var n=this[Yc[this._visualState]];this._applyTint(n);break;case 1:var a=Kc[this._visualState],s=Zc[this._visualState],r=this[a],o=this[s];this._applySprite(r,o)}},t._forceReapplyVisualState=function(){this._updateVisualState(!0)},t._resetToDefaultVisualState=function(e){if(this._imageReference.hasComponent("element"))switch(e){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}},t._determineVisualState=function(){return this.active?this._isPressed?qc:this._isHovering?Xc:jc:$c},t._applySprite=function(e,t){t=t||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset=e,this._imageReference.entity.element.spriteFrame=t,this._isApplyingSprite=!1)},t._applyTint=function(e){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(e):this._applyTintWithTween(e)},t._applyTintImmediately=function(e){var t;this._imageReference.hasComponent("element")&&e&&(this._isApplyingTint=!0,this._imageReference.entity.element.color=new $((t=e).r,t.g,t.b),this._imageReference.entity.element.opacity=e.a,this._isApplyingTint=!1)},t._applyTintWithTween=function(e){if(this._imageReference.hasComponent("element")&&e){var t=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;this._tweenInfo={startTime:W(),from:new $(t.r,t.g,t.b,i),to:e.clone(),lerpColor:new $}}},t._updateTintTween=function(){var e=W()-this._tweenInfo.startTime,t=0===this.fadeDuration?1:e/this.fadeDuration;if(t=Se.clamp(t,0,1),1e-5<Math.abs(t-1)){var i=this._tweenInfo.lerpColor;i.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new $(i.r,i.g,i.b,i.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()},t._cancelTween=function(){delete this._tweenInfo},t.onUpdate=function(){this._tweenInfo&&this._updateTintTween()},t.onEnable=function(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()},t.onDisable=function(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)},t.onRemove=function(){this._toggleLifecycleListeners("off",this.system),this.onDisable()},e}(Xh),Jc=function(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new ee,this.transitionMode=0,this.hoverTint=new $(.75,.75,.75),this.pressedTint=new $(.5,.5,.5),this.inactiveTint=new $(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0},eu=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"],tu=function(n){function e(e){var t;return(t=n.call(this,e)||this).id="button",t.ComponentType=Qc,t.DataType=Jc,t.schema=eu,t.on("beforeremove",t._onRemoveComponent,g(t)),qh.bind("update",t.onUpdate,g(t)),t}u(e,n);var t=e.prototype;return t.initializeComponentData=function(e,t,i){n.prototype.initializeComponentData.call(this,e,t,eu)},t.onUpdate=function(e){var t=this.store;for(var i in t){var n=t[i].entity,a=n.button;a.enabled&&n.enabled&&a.onUpdate()}},t._onRemoveComponent=function(e,t){t.onRemove()},e}(qh);Xh._buildAccessors(Qc.prototype,eu);var iu=function(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name},nu=function(){function e(e,t){var i=this;this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=function(){i.resizeRenderTargets()},t.on("set:rect",this.onCameraRectChanged,this)}var t=e.prototype;return t._allocateColorBuffer=function(e,t){var i=this.camera.rect,n=Math.floor(i.z*this.app.graphicsDevice.width*this.renderTargetScale),a=Math.floor(i.w*this.app.graphicsDevice.height*this.renderTargetScale),s=new Kt(this.app.graphicsDevice,{format:e,width:n,height:a,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return s.name=t,s},t._createOffscreenTarget=function(e,t){var i=this.app.graphicsDevice,n=t?i.getHdrFormat():7,a=this.camera.entity.name+"-posteffect-"+this.effects.length,s=this._allocateColorBuffer(n,a),r=this.app.graphicsDevice.supportsStencil,o=e?i.samples:1;return new Fm({colorBuffer:s,depth:e,stencil:r,samples:o})},t._resizeOffscreenTarget=function(e){var t=e.colorBuffer.format,i=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,i)},t._destroyOffscreenTarget=function(e){e.destroyTextureBuffers(),e.destroy()},t.setRenderTargetScale=function(e){this.renderTargetScale=e,this.resizeRenderTargets()},t.addEffect=function(e){var t=this.effects,i=0===t.length,n=this._createOffscreenTarget(i,e.hdr),a=new iu(e,n);t.push(a),this._sourceTarget=a.inputTarget,1<t.length&&(t[t.length-2].outputTarget=a.inputTarget),(this._newPostEffect=e).needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0},t.removeEffect=function(e){var t,i,n=-1;for(t=0,i=this.effects.length;t<i;t++)if(this.effects[t].effect===e){n=t;break}0<=n&&(0<n?this.effects[n-1].outputTarget=n+1<this.effects.length?this.effects[n+1].inputTarget:null:1<this.effects.length&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[n].inputTarget),this.effects.splice(n,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()},t._requestDepthMaps=function(){for(var e=0,t=this.effects.length;e<t;e++){var i=this.effects[e].effect;this._newPostEffect!==i&&i.needsDepthBuffer&&this._requestDepthMap()}},t._releaseDepthMaps=function(){for(var e=0,t=this.effects.length;e<t;e++)this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()},t._requestDepthMap=function(){Wc||(Wc=this.app.scene.layers.getLayerById(1)),Wc&&Wc.incrementCounter()},t._releaseDepthMap=function(){Wc&&Wc.decrementCounter()},t.destroy=function(){for(var e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()},t.enable=function(){if(!this.enabled&&this.effects.length){var e,t;this.enabled=!0;var r=this;this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,null==(e=this.app)||null==(t=e.backgroundRenderer)||t.setRenderTarget(this.camera.renderTarget),this.camera.onPostprocessing=function(e){if(r.enabled){var t=null,i=r.effects.length;if(i)for(var n=0;n<i;n++){var a=r.effects[n],s=a.outputTarget;n===i-1&&(t=r.camera.rect,r.destinationRenderTarget&&(s=r.destinationRenderTarget)),a.effect.render(a.inputTarget,s,t)}}}}},t.disable=function(){var e,t;this.enabled&&(this.enabled=!1,null==(e=this.app)||null==(t=e.backgroundRenderer)||t.setRenderTarget(null),this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)},t._onCanvasResized=function(e,t){var i=this.camera.rect,n=this.app.graphicsDevice;this.camera.camera.aspectRatio=n.width*i.z/(n.height*i.w),this.resizeTimeout||(100<W()-this.resizeLast?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))},t.resizeRenderTargets=function(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=W();for(var e=this.camera.rect,t=Math.floor(e.z*this.app.graphicsDevice.width*this.renderTargetScale),i=Math.floor(e.w*this.app.graphicsDevice.height*this.renderTargetScale),n=this.effects,a=0,s=n.length;a<s;a++){var r=n[a];r.inputTarget.width===t&&r.inputTarget.height===i||this._resizeOffscreenTarget(r.inputTarget)}},t.onCameraRectChanged=function(e,t,i){this.enabled&&this.resizeRenderTargets()},e}(),au=[{name:"aspectRatio",readonly:!1},{name:"aspectRatioMode",readonly:!1},{name:"calculateProjection",readonly:!1},{name:"calculateTransform",readonly:!1},{name:"clearColor",readonly:!1},{name:"cullFaces",readonly:!1},{name:"farClip",readonly:!1},{name:"flipFaces",readonly:!1},{name:"fov",readonly:!1},{name:"frustum",readonly:!0},{name:"frustumCulling",readonly:!1},{name:"horizontalFov",readonly:!1},{name:"nearClip",readonly:!1},{name:"orthoHeight",readonly:!1},{name:"projection",readonly:!1},{name:"projectionMatrix",readonly:!0},{name:"scissorRect",readonly:!1},{name:"viewMatrix",readonly:!0},{name:"vrDisplay",readonly:!1}],su=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._camera=new Oi,i._camera.node=t,i._priority=0,i.onPostprocessing=null,i._disablePostEffectsLayer=4,i._postEffects=new nu(e.app,g(i)),i}u(e,n);var t=e.prototype;return t.dirtyLayerCompositionCameras=function(){this.system.app.scene.layers._dirtyCameras=!0},t.screenToWorld=function(e,t,i,n){var a=this.system.app.graphicsDevice,s=a.clientRect.width,r=a.clientRect.height;return this._camera.screenToWorld(e,t,i,s,r,n)},t.worldToScreen=function(e,t){var i=this.system.app.graphicsDevice,n=i.clientRect.width,a=i.clientRect.height;return this._camera.worldToScreen(e,n,a,t)},t.onAppPrerender=function(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0},t.addCameraToLayers=function(){for(var e=this.layers,t=0;t<e.length;t++){var i=this.system.app.scene.layers.getLayerById(e[t]);i&&i.addCamera(this)}},t.removeCameraFromLayers=function(){for(var e=this.layers,t=0;t<e.length;t++){var i=this.system.app.scene.layers.getLayerById(e[t]);i&&i.removeCamera(this)}},t.onLayersChanged=function(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){this.layers.indexOf(e.id)<0||e.addCamera(this)},t.onLayerRemoved=function(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)},t.onEnable=function(){var e=this.system,t=e.app.scene,i=t.layers;e.addCamera(this),t.on("set:layers",this.onLayersChanged,this),i&&(i.on("add",this.onLayerAdded,this),i.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()},t.onDisable=function(){var e=this.system,t=e.app.scene,i=t.layers;this.postEffects.disable(),this.removeCameraFromLayers(),t.off("set:layers",this.onLayersChanged,this),i&&(i.off("add",this.onLayerAdded,this),i.off("remove",this.onLayerRemoved,this)),e.removeCamera(this)},t.onRemove=function(){this.onDisable(),this.off()},t.calculateAspectRatio=function(e){var t=e||this.system.app.graphicsDevice,i=this.rect;return t.width*i.z/(t.height*i.w)},t.frameBegin=function(e){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(e))},t.frameEnd=function(){},t.enterVr=function(t,i){if(t instanceof Function&&!i&&(i=t,t=null),this.system.app.vr)if(t||(t=this.system.app.vr.display),t){var n=this;t.capabilities.canPresent?t.requestPresent(function(e){e||(n.vrDisplay=t,n.vrDisplay.once("beforepresentchange",function(e){e.presenting||(n.vrDisplay=null)})),i(e)}):(n.vrDisplay=t,i())}else i("No pc.VrDisplay to present");else i("VrManager not created. Enable VR in project settings.")},t.exitVr=function(e){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var t=this.vrDisplay;this.vrDisplay=null,t.exitPresent(e)}else this.vrDisplay=null,e();else e("Not presenting VR")},t.startXr=function(e,t,i){this.system.app.xr.start(this,e,t,i)},t.endXr=function(e){this._camera.xr?this._camera.xr.end(e):e&&e(new Error("Camera is not in XR"))},t.copy=function(i){var n=this;au.forEach(function(e){if(!e.readonly){var t=e.name;n[t]=i[t]}}),this.clearColorBuffer=i.clearColorBuffer,this.clearDepthBuffer=i.clearDepthBuffer,this.clearStencilBuffer=i.clearStencilBuffer,this.disablePostEffectsLayer=i.disablePostEffectsLayer,this.layers=i.layers,this.priority=i.priority,this.renderTarget=i.renderTarget,this.rect=i.rect},c(e,[{key:"camera",get:function(){return this._camera}},{key:"disablePostEffectsLayer",get:function(){return this._disablePostEffectsLayer},set:function(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}},{key:"postEffectsEnabled",get:function(){return this._postEffects.enabled}},{key:"layers",get:function(){return this._camera.layers},set:function(e){var t,i,n=this._camera.layers;for(t=0;t<n.length;t++)(i=this.system.app.scene.layers.getLayerById(n[t]))&&i.removeCamera(this);if(this._camera.layers=e,this.enabled&&this.entity.enabled)for(t=0;t<e.length;t++)(i=this.system.app.scene.layers.getLayerById(e[t]))&&i.addCamera(this)}},{key:"postEffects",get:function(){return this._postEffects}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this.dirtyLayerCompositionCameras()}},{key:"rect",get:function(){return this._camera.rect},set:function(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}},{key:"clearColorBuffer",get:function(){return this._camera.clearColorBuffer},set:function(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}},{key:"clearDepthBuffer",get:function(){return this._camera.clearDepthBuffer},set:function(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}},{key:"clearStencilBuffer",get:function(){return this._camera.clearStencilBuffer},set:function(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}},{key:"renderTarget",get:function(){return this._camera.renderTarget},set:function(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}}]),e}(Xh);au.forEach(function(e){var t=e.name,i={get:function(){return this._camera[t]}};e.readonly||(i.set=function(e){this._camera[t]=e}),Object.defineProperty(su.prototype,t,i)});var ru=function(){this.enabled=!0},ou=["enabled"],lu=function(r){function e(e){var t;return(t=r.call(this,e)||this).id="camera",t.ComponentType=su,t.DataType=ru,t.schema=ou,t.cameras=[],t.on("beforeremove",t.onBeforeRemove,g(t)),t.app.on("prerender",t.onAppPrerender,g(t)),qh.bind("update",t.onUpdate,g(t)),t}u(e,r);var t=e.prototype;return t.initializeComponentData=function(e,t,i){i=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect"];for(var n=0;n<i.length;n++){var a=i[n];if(t.hasOwnProperty(a)){var s=t[a];switch(a){case"rect":case"scissorRect":Array.isArray(s)?e[a]=new ee(s[0],s[1],s[2],s[3]):e[a]=s;break;case"clearColor":Array.isArray(s)?e[a]=new $(s[0],s[1],s[2],s[3]):e[a]=s;break;default:e[a]=s}}}r.prototype.initializeComponentData.call(this,e,t,["enabled"])},t.cloneComponent=function(e,t){var i=e.camera;this.addComponent(t,{aspectRatio:i.aspectRatio,aspectRatioMode:i.aspectRatioMode,calculateProjection:i.calculateProjection,calculateTransform:i.calculateTransform,clearColor:i.clearColor,clearColorBuffer:i.clearColorBuffer,clearDepthBuffer:i.clearDepthBuffer,clearStencilBuffer:i.clearStencilBuffer,cullFaces:i.cullFaces,farClip:i.farClip,flipFaces:i.flipFaces,fov:i.fov,frustumCulling:i.frustumCulling,horizontalFov:i.horizontalFov,layers:i.layers,renderTarget:i.renderTarget,nearClip:i.nearClip,orthoHeight:i.orthoHeight,projection:i.projection,priority:i.priority,rect:i.rect,scissorRect:i.scissorRect})},t.onBeforeRemove=function(e,t){this.removeCamera(t)},t.onUpdate=function(e){if(this.app.vr){var t=this.store;for(var i in t){var n=t[i];if(n.data.enabled&&n.entity.enabled){var a=n.entity.camera,s=a.vrDisplay;s&&(s.setClipPlanes(a.nearClip,a.farClip),n.entity&&(n.entity.localTransform.copy(s.combinedViewInv),n.entity._dirtyLocal=!1,n.entity._dirtifyWorld()))}}}},t.onAppPrerender=function(){for(var e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender()},t.addCamera=function(e){this.cameras.push(e),this.sortCamerasByPriority()},t.removeCamera=function(e){var t=this.cameras.indexOf(e);0<=t&&(this.cameras.splice(t,1),this.sortCamerasByPriority())},t.sortCamerasByPriority=function(){this.cameras.sort(function(e,t){return e.priority-t.priority})},e}(qh);Xh._buildAccessors(su.prototype,ou);var hu,cu,uu,du=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._compoundParent=null,i.entity.on("insert",i._onInsert,g(i)),i.on("set_type",i.onSetType,g(i)),i.on("set_halfExtents",i.onSetHalfExtents,g(i)),i.on("set_radius",i.onSetRadius,g(i)),i.on("set_height",i.onSetHeight,g(i)),i.on("set_axis",i.onSetAxis,g(i)),i.on("set_asset",i.onSetAsset,g(i)),i.on("set_renderAsset",i.onSetRenderAsset,g(i)),i.on("set_model",i.onSetModel,g(i)),i.on("set_render",i.onSetRender,g(i)),i}u(e,n);var t=e.prototype;return t.onSetType=function(e,t,i){t!==i&&this.system.changeType(this,t,i)},t.onSetHalfExtents=function(e,t,i){var n=this.data.type;this.data.initialized&&"box"===n&&this.system.recreatePhysicalShapes(this)},t.onSetRadius=function(e,t,i){var n=this.data.type;!this.data.initialized||"sphere"!==n&&"capsule"!==n&&"cylinder"!==n&&"cone"!==n||this.system.recreatePhysicalShapes(this)},t.onSetHeight=function(e,t,i){var n=this.data.type;!this.data.initialized||"capsule"!==n&&"cylinder"!==n&&"cone"!==n||this.system.recreatePhysicalShapes(this)},t.onSetAxis=function(e,t,i){var n=this.data.type;!this.data.initialized||"capsule"!==n&&"cylinder"!==n&&"cone"!==n||this.system.recreatePhysicalShapes(this)},t.onSetAsset=function(e,t,i){var n,a=this.system.app.assets;t&&(n=a.get(t))&&n.off("remove",this.onAssetRemoved,this),i&&(i instanceof Kr&&(this.data.asset=i.id),(n=a.get(this.data.asset))&&(n.off("remove",this.onAssetRemoved,this),n.on("remove",this.onAssetRemoved,this))),this.data.initialized&&"mesh"===this.data.type&&(i||(this.data.model=null),this.system.recreatePhysicalShapes(this))},t.onSetRenderAsset=function(e,t,i){var n,a=this.system.app.assets;t&&(n=a.get(t))&&n.off("remove",this.onRenderAssetRemoved,this),i&&(i instanceof Kr&&(this.data.renderAsset=i.id),(n=a.get(this.data.renderAsset))&&(n.off("remove",this.onRenderAssetRemoved,this),n.on("remove",this.onRenderAssetRemoved,this))),this.data.initialized&&"mesh"===this.data.type&&(i||(this.data.render=null),this.system.recreatePhysicalShapes(this))},t.onSetModel=function(e,t,i){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},t.onSetRender=function(e,t,i){this.onSetModel(e,t,i)},t.onAssetRemoved=function(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null)},t.onRenderAssetRemoved=function(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null)},t._getCompoundChildShapeIndex=function(e){for(var t=this.data.shape,i=t.getNumChildShapes(),n=0;n<i;n++)if(t.getChildShape(n).ptr===e.ptr)return n;return null},t._onInsert=function(e){if("undefined"!=typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody)for(var t=this.entity.parent;t;){if(t.collision&&"compound"===t.collision.type){0===t.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(t.collision):this.system.recreatePhysicalShapes(this);break}t=t.parent}},t._updateCompound=function(){var e=this.entity;if(e._dirtyWorld){for(var t=e._dirtyLocal,i=e;i&&!t&&(!i.collision||i.collision!==this._compoundParent);)i._dirtyLocal&&(t=!0),i=i.parent;if(t){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);var n=this._compoundParent.entity.rigidbody;n&&n.activate()}}},t.onEnable=function(){if("mesh"===this.data.type&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){var e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(0===this._compoundParent.shape.getNumChildShapes())this.system.recreatePhysicalShapes(this._compoundParent);else{var t=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(t,this.data.shape),Ammo.destroy(t),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()},t.onDisable=function(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()},t.onBeforeRemove=function(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()},e}(Xh),pu=function(){this.enabled=!0,this.type="box",this.halfExtents=new de(.5,.5,.5),this.radius=.5,this.axis=1,this.height=2,this.asset=null,this.renderAsset=null,this.shape=null,this.model=null,this.render=null,this.initialized=!1},fu="static",mu="dynamic",vu="kinematic",gu=function(){function e(e,t,i){this.entity=t.entity,this.component=t,this.app=e,"undefined"==typeof Ammo||hu||(hu=new Ammo.btVector3,cu=new Ammo.btQuaternion,uu=new Ammo.btTransform),this.initialize(i)}var t=e.prototype;return t.initialize=function(e){var t=this.entity,i=e.shape;if(i&&"undefined"!=typeof Ammo){t.trigger&&t.trigger.destroy();var n=t.getPosition(),a=t.getRotation();hu.setValue(n.x,n.y,n.z),cu.setValue(a.x,a.y,a.z,a.w),uu.setOrigin(hu),uu.setRotation(cu);var s=this.app.systems.rigidbody.createBody(1,i,uu);s.setRestitution(0),s.setFriction(0),s.setDamping(0,0),hu.setValue(0,0,0),s.setLinearFactor(hu),s.setAngularFactor(hu),s.setCollisionFlags(4|s.getCollisionFlags()),s.entity=t,this.body=s,this.component.enabled&&t.enabled&&this.enable()}},t.destroy=function(){var e=this.body;e&&(this.disable(),this.app.systems.rigidbody.destroyBody(e))},t._getEntityTransform=function(e){var t=this.entity.getPosition(),i=this.entity.getRotation();hu.setValue(t.x,t.y,t.z),cu.setValue(i.x,i.y,i.z,i.w),e.setOrigin(hu),e.setRotation(cu)},t.updateTransform=function(){this._getEntityTransform(uu);var e=this.body;e.setWorldTransform(uu),e.activate()},t.enable=function(){var e=this.body;if(e){var t=this.app.systems;t.rigidbody.addBody(e,16,65517),t.rigidbody._triggers.push(this),e.forceActivationState(1),this.updateTransform()}},t.disable=function(){var e=this.body;if(e){var t=this.app.systems,i=t.rigidbody._triggers.indexOf(this);-1<i&&t.rigidbody._triggers.splice(i,1),t.rigidbody.removeBody(e),e.forceActivationState(5)}},e}(),_u=new pe,yu=new de,bu=new fe,xu=new mn,Mu=["enabled","type","halfExtents","radius","axis","height","asset","renderAsset","shape","model","render"],Su=function(){function e(e){this.system=e}var t=e.prototype;return t.beforeInitialize=function(e,t){t.shape=null,t.model=new rr,t.model.graph=new mn},t.afterInitialize=function(e,t){this.recreatePhysicalShapes(e),e.data.initialized=!0},t.reset=function(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t)},t.recreatePhysicalShapes=function(e){var t=e.entity,i=e.data;if("undefined"!=typeof Ammo){t.trigger&&(t.trigger.destroy(),delete t.trigger),i.shape&&(e._compoundParent&&(this.system._removeCompoundChild(e._compoundParent,i.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),Ammo.destroy(i.shape),i.shape=null),i.shape=this.createPhysicalShape(e.entity,i);var n=!e._compoundParent;if("compound"!==i.type||e._compoundParent&&e!==e._compoundParent){if("compound"!==i.type&&(e._compoundParent&&e===e._compoundParent&&t.forEach(this.system.implementations.compound._updateEachDescendant,e),!e.rigidbody)){e._compoundParent=null;for(var a=t.parent;a;){if(a.collision&&"compound"===a.collision.type){e._compoundParent=a.collision;break}a=a.parent}}}else e._compoundParent=e,t.forEach(this._addEachDescendant,e);e._compoundParent&&e!==e._compoundParent&&(n&&0===e._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(i):t.trigger=new gu(this.system.app,e,i))}},t.createPhysicalShape=function(e,t){},t.updateTransform=function(e,t,i,n){e.entity.trigger&&e.entity.trigger.updateTransform()},t.beforeRemove=function(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,Ammo.destroy(t.data.shape),t.data.shape=null)},t.remove=function(e,t){var i=this.system.app;e.rigidbody&&e.rigidbody.body&&e.rigidbody.disableSimulation(),e.trigger&&(e.trigger.destroy(),delete e.trigger),i.scene.containsModel(t.model)&&(i.root.removeChild(t.model.graph),i.scene.removeModel(t.model))},t.clone=function(e,t){var i=this.system.store[e.getGuid()],n={enabled:i.data.enabled,type:i.data.type,halfExtents:[i.data.halfExtents.x,i.data.halfExtents.y,i.data.halfExtents.z],radius:i.data.radius,axis:i.data.axis,height:i.data.height,asset:i.data.asset,renderAsset:i.data.renderAsset,model:i.data.model,render:i.data.render};return this.system.addComponent(t,n)},e}(),wu=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t.prototype.createPhysicalShape=function(e,t){if("undefined"!=typeof Ammo){var i=t.halfExtents,n=new Ammo.btVector3(i?i.x:.5,i?i.y:.5,i?i.z:.5),a=new Ammo.btBoxShape(n);return Ammo.destroy(n),a}},t}(Su),Cu=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t.prototype.createPhysicalShape=function(e,t){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(t.radius)},t}(Su),Pu=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t.prototype.createPhysicalShape=function(e,t){var i=null,n=void 0!==t.axis?t.axis:1,a=t.radius||.5,s=Math.max((t.height||2)-2*a,0);if("undefined"!=typeof Ammo)switch(n){case 0:i=new Ammo.btCapsuleShapeX(a,s);break;case 1:i=new Ammo.btCapsuleShape(a,s);break;case 2:i=new Ammo.btCapsuleShapeZ(a,s)}return i},t}(Su),Tu=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t.prototype.createPhysicalShape=function(e,t){var i=null,n=null,a=void 0!==t.axis?t.axis:1,s=void 0!==t.radius?t.radius:.5,r=void 0!==t.height?t.height:1;if("undefined"!=typeof Ammo)switch(a){case 0:i=new Ammo.btVector3(.5*r,s,s),n=new Ammo.btCylinderShapeX(i);break;case 1:i=new Ammo.btVector3(s,.5*r,s),n=new Ammo.btCylinderShape(i);break;case 2:i=new Ammo.btVector3(s,s,.5*r),n=new Ammo.btCylinderShapeZ(i)}return i&&Ammo.destroy(i),n},t}(Su),Au=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t.prototype.createPhysicalShape=function(e,t){var i=null,n=void 0!==t.axis?t.axis:1,a=void 0!==t.radius?t.radius:.5,s=void 0!==t.height?t.height:1;if("undefined"!=typeof Ammo)switch(n){case 0:i=new Ammo.btConeShapeX(a,s);break;case 1:i=new Ammo.btConeShape(a,s);break;case 2:i=new Ammo.btConeShapeZ(a,s)}return i},t}(Su),Eu=function(r){function e(){return r.apply(this,arguments)||this}u(e,r);var t=e.prototype;return t.beforeInitialize=function(e,t){},t.createAmmoMesh=function(e,t,i){var n,a;if(this.system._triMeshCache[e.id])n=this.system._triMeshCache[e.id];else{var s,r,o=e.vertexBuffer,l=o.getFormat();for(a=0;a<l.elements.length;a++){var h=l.elements[a];if(h.name===Te){r=new Float32Array(o.lock(),h.offset),s=h.stride/4;break}}var c=[];e.getIndices(c);var u,d,p,f=e.primitive[0].count/3,m=new Ammo.btVector3,v=new Ammo.btVector3,g=new Ammo.btVector3,_=e.primitive[0].base;for(n=new Ammo.btTriangleMesh,this.system._triMeshCache[e.id]=n,a=0;a<f;a++)u=c[_+3*a]*s,d=c[_+3*a+1]*s,p=c[_+3*a+2]*s,m.setValue(r[u],r[u+1],r[u+2]),v.setValue(r[d],r[d+1],r[d+2]),g.setValue(r[p],r[p+1],r[p+2]),n.addTriangle(m,v,g,!0);Ammo.destroy(m),Ammo.destroy(v),Ammo.destroy(g)}var y=new Ammo.btBvhTriangleMeshShape(n,!0),b=this.system._getNodeScaling(t);y.setLocalScaling(b),Ammo.destroy(b);var x=this.system._getNodeTransform(t);i.addChildShape(x,y),Ammo.destroy(x)},t.createPhysicalShape=function(e,t){if("undefined"!=typeof Ammo&&(t.model||t.render)){var i=new Ammo.btCompoundShape;if(t.model)for(var n=t.model.meshInstances,a=0;a<n.length;a++)this.createAmmoMesh(n[a].mesh,n[a].node,i);else if(t.render)for(var s=t.render.meshes,r=0;r<s.length;r++)this.createAmmoMesh(s[r],xu,i);var o=e.getWorldTransform().getScale(),l=new Ammo.btVector3(o.x,o.y,o.z);return i.setLocalScaling(l),Ammo.destroy(l),i}},t.recreatePhysicalShapes=function(e){var t=e.data;(t.renderAsset||t.asset)&&e.enabled&&e.entity.enabled?this.loadAsset(e,t.renderAsset||t.asset,t.renderAsset?"render":"model"):this.doRecreatePhysicalShape(e)},t.loadAsset=function(t,e,i){var n=this,a=t.data,s=this.system.app.assets,r=s.get(e);r?(r.ready(function(e){a[i]=e.resource,n.doRecreatePhysicalShape(t)}),s.load(r)):s.once("add:"+e,function(e){e.ready(function(e){a[i]=e.resource,n.doRecreatePhysicalShape(t)}),s.load(e)})},t.doRecreatePhysicalShape=function(e){var t=e.entity,i=e.data;i.model||i.render?(this.destroyShape(i),i.shape=this.createPhysicalShape(t,i),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(i):t.trigger=new gu(this.system.app,e,i)):(this.beforeRemove(t,e),this.remove(t,i))},t.updateTransform=function(e,t,i,n){if(e.shape){var a=e.entity.getWorldTransform().getScale(),s=e.shape.getLocalScaling();a.x===s.x()&&a.y===s.y()&&a.z===s.z()||this.doRecreatePhysicalShape(e)}r.prototype.updateTransform.call(this,e,t,i,n)},t.destroyShape=function(e){if(e.shape){for(var t=e.shape.getNumChildShapes(),i=0;i<t;i++){var n=e.shape.getChildShape(i);Ammo.destroy(n)}Ammo.destroy(e.shape),e.shape=null}},t.remove=function(e,t){this.destroyShape(t),r.prototype.remove.call(this,e,t)},e}(Su),Ru=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var i=t.prototype;return i.createPhysicalShape=function(e,t){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape},i._addEachDescendant=function(e){e.collision&&!e.rigidbody&&(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision))},i._updateEachDescendant=function(e){e.collision&&e.collision._compoundParent===this&&(e.collision._compoundParent=null,e===this.entity||e.rigidbody||e.collision.system.recreatePhysicalShapes(e.collision))},i._updateEachDescendantTransform=function(e){e.collision&&e.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(e)},t}(Su),Du=function(h){function e(e){var t;return(t=h.call(this,e)||this).id="collision",t.ComponentType=du,t.DataType=pu,t.schema=Mu,t.implementations={},t._triMeshCache={},t.on("beforeremove",t.onBeforeRemove,g(t)),t.on("remove",t.onRemove,g(t)),t}u(e,h);var t=e.prototype;return t.initializeComponentData=function(e,t,i){for(var n,a={},s=0,r=(i=["type","halfExtents","radius","axis","height","shape","model","asset","render","renderAsset","enabled"]).length;s<r;s++){var o=i[s];a[o]=t[o]}t.hasOwnProperty("asset")?(-1!==(n=i.indexOf("model"))&&i.splice(n,1),-1!==(n=i.indexOf("render"))&&i.splice(n,1)):t.hasOwnProperty("model")&&-1!==(n=i.indexOf("asset"))&&i.splice(n,1),a.type||(a.type=e.data.type),e.data.type=a.type,a.halfExtents&&Array.isArray(a.halfExtents)&&(a.halfExtents=new de(a.halfExtents[0],a.halfExtents[1],a.halfExtents[2]));var l=this._createImplementation(a.type);l.beforeInitialize(e,a),h.prototype.initializeComponentData.call(this,e,a,i),l.afterInitialize(e,a)},t._createImplementation=function(e){if(void 0===this.implementations[e]){var t;switch(e){case"box":t=new wu(this);break;case"sphere":t=new Cu(this);break;case"capsule":t=new Pu(this);break;case"cylinder":t=new Tu(this);break;case"cone":t=new Au(this);break;case"mesh":t=new Eu(this);break;case"compound":t=new Ru(this)}this.implementations[e]=t}return this.implementations[e]},t._getImplementation=function(e){return this.implementations[e.collision.data.type]},t.cloneComponent=function(e,t){return this._getImplementation(e).clone(e,t)},t.onBeforeRemove=function(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove()},t.onRemove=function(e,t){this.implementations[t.type].remove(e,t)},t.updateCompoundChildTransform=function(e){if(this._removeCompoundChild(e.collision._compoundParent,e.collision.data.shape),e.enabled&&e.collision.enabled){var t=this._getNodeTransform(e,e.collision._compoundParent.entity);e.collision._compoundParent.shape.addChildShape(t,e.collision.data.shape),Ammo.destroy(t)}},t._removeCompoundChild=function(e,t){if(e.shape.removeChildShape)e.shape.removeChildShape(t);else{var i=e._getCompoundChildShapeIndex(t);null!==i&&e.shape.removeChildShapeByIndex(i)}},t.onTransformChanged=function(e,t,i,n){this.implementations[e.data.type].updateTransform(e,t,i,n)},t.changeType=function(e,t,i){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(i).reset(e,e.data)},t.recreatePhysicalShapes=function(e){this.implementations[e.data.type].recreatePhysicalShapes(e)},t._calculateNodeRelativeTransform=function(e,t){if(e===t){var i=e.getWorldTransform().getScale();_u.setScale(i.x,i.y,i.z)}else this._calculateNodeRelativeTransform(e.parent,t),_u.mul(e.getLocalTransform())},t._getNodeScaling=function(e){var t=e.getWorldTransform().getScale();return new Ammo.btVector3(t.x,t.y,t.z)},t._getNodeTransform=function(e,t){var i,n;t?(this._calculateNodeRelativeTransform(e,t),i=yu,n=bu,_u.getTranslation(i),n.setFromMat4(_u)):(i=e.getPosition(),n=e.getRotation());var a=new Ammo.btTransform;a.setIdentity();var s=a.getOrigin();s.setValue(i.x,i.y,i.z);var r=new Ammo.btQuaternion;return r.setValue(n.x,n.y,n.z,n.w),a.setRotation(r),Ammo.destroy(r),Ammo.destroy(s),a},t.destroy=function(){for(var e in this._triMeshCache)Ammo.destroy(this._triMeshCache[e]);this._triMeshCache=null,h.prototype.destroy.call(this)},e}(qh);Xh._buildAccessors(du.prototype,Mu);var Iu=function(){function e(){this.list=[]}var t=e.prototype;return t.add=function(e){var t=e.id;if(this[t])throw new Error("ComponentSystem name '"+t+"' already registered or not allowed");this[t]=e,this.list.push(e)},t.remove=function(e){var t=e.id;if(!this[t])throw new Error("No ComponentSystem named '"+t+"' registered");delete this[t];var i=this.list.indexOf(this[t]);-1!==i&&this.list.splice(i,1)},e}(),ku="image",Lu="text",Ou=function(){function e(e){this.func=void 0===e.func?7:e.func,this.ref=e.ref||0,this.readMask=void 0===e.readMask?255:e.readMask,this.writeMask=void 0===e.writeMask?255:e.writeMask,this.fail=e.fail||0,this.zfail=e.zfail||0,this.zpass=e.zpass||0}return e.prototype.clone=function(){return new e({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})},e}(),Fu=function(){function e(e,t,i){this._entity=e,this._element=e.element,this.model=new rr,this.node=new mn,this.model.graph=this.node,this.mesh=t,this.meshInstance=new Mn(this.mesh,i,this.node),this.meshInstance.name="ImageElement: "+e.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}var t=e.prototype;return t.destroy=function(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance=null,this._entity=null,this._element=null},t.setMesh=function(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb())},t.setMask=function(e){if(this.meshInstance){if(e)for(var t in this.unmaskMeshInstance=new Mn(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance),this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data);else{var i=this.model.meshInstances.indexOf(this.unmaskMeshInstance);0<=i&&this.model.meshInstances.splice(i,1),this.unmaskMeshInstance=null}this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}},t.setMaterial=function(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e))},t.setParameter=function(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t))},t.deleteParameter=function(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e))},t.setUnmaskDrawOrder=function(){if(this.meshInstance&&this.unmaskMeshInstance){var e=function e(t){var i,n=t.children,a=n.length;if(a){for(var s=0;s<a;s++)n[s].element&&(i=n[s]);return i?e(i)||i:null}return null}(this._entity);e&&e.element?this.unmaskMeshInstance.drawOrder=e.element.drawOrder+e.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}},t.setDrawOrder=function(e){this.meshInstance&&(this.meshInstance.drawOrder=e)},t.setCull=function(e){if(this.meshInstance){var t=this._element,i=null;e&&t._isScreenCulled()&&(i=function(e){return t.isVisibleForCamera(e)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=i,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=i)}},t.setScreenSpace=function(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e))},t.setLayer=function(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e))},t.forceUpdateAabb=function(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))},t.setAabbFunc=function(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e))},e}(),zu=function(){function e(e){this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._rect=new ee(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new J,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new ee,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new ee,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new Fu(this._entity,this._defaultMesh,this._material),this._color=new $(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}var t=e.prototype;return t.destroy=function(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)},t._onResolutionChange=function(e){},t._onParentResizeOrPivotChange=function(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)},t._onScreenSpaceChange=function(e){this._updateMaterial(e)},t._onScreenChange=function(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)},t._onDrawOrderChange=function(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)},t._hasUserMaterial=function(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)},t._use9Slicing=function(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)},t._updateMaterial=function(e){var t=!!this._mask,i=!(!this.sprite||1!==this.sprite.renderMode),n=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,i,n)),this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(e?0:15))},t._createMesh=function(){var e=this._element,t=e.calculatedWidth,i=e.calculatedHeight,n=this._rect,a=new ArrayBuffer(128),s=new Float32Array(a);s[5]=1,s[6]=n.x,s[7]=1-n.y,s[8]=t,s[13]=1,s[14]=n.x+n.z,s[15]=1-n.y,s[16]=t,s[17]=i,s[21]=1,s[22]=n.x+n.z,s[23]=1-(n.y+n.w),s[25]=i,s[29]=1,s[30]=n.x,s[31]=1-(n.y+n.w);var r=[{semantic:Te,components:3,type:6},{semantic:Ae,components:3,type:6},{semantic:Le,components:2,type:6}],o=this._system.app.graphicsDevice,l=new ut(o,r),h=new ht(o,l,4,0,a),c=new Zi(o);return c.vertexBuffer=h,c.primitive[0].type=6,c.primitive[0].base=0,c.primitive[0].count=4,c.primitive[0].indexed=!1,c.aabb.setMinMax(de.ZERO,new de(t,i,0)),this._updateMesh(c),c},t._updateMesh=function(e){var t=this._element,i=t.calculatedWidth,n=t.calculatedHeight,a=t._isScreenSpace();if(this._updateMaterial(a),this._renderable&&this._renderable.forceUpdateAabb(),!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){var s=e.vertexBuffer,r=new Float32Array(s.lock()),o=t.pivot.x,l=t.pivot.y;r[0]=0-o*i,r[1]=0-l*n,r[8]=i-o*i,r[9]=0-l*n,r[16]=i-o*i,r[17]=n-l*n,r[24]=0-o*i,r[25]=n-l*n;var h=1,c=1,u=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var d=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];d&&(u=d.rect,h=this._sprite.atlas.texture.width,c=this._sprite.atlas.texture.height)}r[6]=u.x/h,r[7]=1-u.y/c,r[14]=(u.x+u.z)/h,r[15]=1-u.y/c,r[22]=(u.x+u.z)/h,r[23]=1-(u.y+u.w)/c,r[30]=u.x/h,r[31]=1-(u.y+u.w)/c,s.unlock();var p=new de(0-o*i,0-l*n,0),f=new de(i-o*i,n-l*n,0);e.aabb.setMinMax(p,f),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else{var m=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],v=2/m.rect.z,g=2/m.rect.w;this._innerOffset.set(m.border.x*v,m.border.y*g,m.border.z*v,m.border.w*g);var _=this.sprite.atlas.texture;this._atlasRect.set(m.rect.x/_.width,m.rect.y/_.height,m.rect.z/_.width,m.rect.w/_.height);var y=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,b=m.rect.z/y,x=m.rect.w/y;this._outerScale.set(Math.max(i,this._innerOffset.x*b),Math.max(n,this._innerOffset.y*x));var M=b,S=x;this._outerScale.x/=b,this._outerScale.y/=x,M*=Se.clamp(i/(this._innerOffset.x*b),1e-4,1),S*=Se.clamp(n/(this._innerOffset.y*x),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(M,S,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*i,(.5-t.pivot.y)*n,0))}this._meshDirty=!1},t._updateSprite=function(){var e=!1,t=null;this._sprite&&this._sprite.atlas&&(t=this._sprite.meshes[this.spriteFrame],e=1===this._sprite.renderMode||2===this._sprite.renderMode),this.mesh=e?t:this._defaultMesh,this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))},t._updateAabb=function(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e},t._toggleMask=function(){this._element._dirtifyMask();var e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask)},t._onMaterialLoad=function(e){this.material=e.resource},t._onMaterialAdded=function(e){this._system.app.assets.off("add:"+e.id,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)},t._bindMaterialAsset=function(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e))},t._unbindMaterialAsset=function(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)},t._onMaterialChange=function(){},t._onMaterialRemove=function(){},t._onTextureAdded=function(e){this._system.app.assets.off("add:"+e.id,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e)},t._bindTextureAsset=function(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e))},t._unbindTextureAsset=function(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)},t._onTextureLoad=function(e){this.texture=e.resource},t._onTextureChange=function(e){},t._onTextureRemove=function(e){},t._onSpriteAssetAdded=function(e){this._system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)},t._bindSpriteAsset=function(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e))},t._unbindSpriteAsset=function(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},t._onSpriteAssetLoad=function(e){if(e&&e.resource)if(e.resource.atlas)this.sprite=e.resource;else{var t=e.data.textureAtlasAsset;if(t){var i=this._system.app.assets;i.off("load:"+t,this._onTextureAtlasLoad,this),i.once("load:"+t,this._onTextureAtlasLoad,this)}}else this.sprite=null},t._onSpriteAssetChange=function(e){this._onSpriteAssetLoad(e)},t._onSpriteAssetRemove=function(e){},t._bindSprite=function(e){e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this)},t._unbindSprite=function(e){e.off("set:meshes",this._onSpriteMeshesChange,this),e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this)},t._onSpriteMeshesChange=function(){this._sprite&&(this._spriteFrame=Se.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()},t._onSpritePpuChange=function(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()},t._onAtlasTextureChange=function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))},t._onTextureAtlasLoad=function(e){var t=this._spriteAsset;t instanceof Kr?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t))},t.onEnable=function(){var e;this._materialAsset&&(e=this._system.app.assets.get(this._materialAsset))&&e.resource!==this._material&&this._bindMaterialAsset(e),this._textureAsset&&(e=this._system.app.assets.get(this._textureAsset))&&e.resource!==this._texture&&this._bindTextureAsset(e),this._spriteAsset&&(e=this._system.app.assets.get(this._spriteAsset))&&e.resource!==this._sprite&&this._bindSpriteAsset(e),this._element.addModelToLayers(this._renderable.model)},t.onDisable=function(){this._element.removeModelFromLayers(this._renderable.model)},t._setStencil=function(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e;var t=0;if(this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){var i=new Ou({ref:t+1,func:2,zpass:5});this._renderable.unmaskMeshInstance.stencilFront=i,this._renderable.unmaskMeshInstance.stencilBack=i}},c(e,[{key:"color",get:function(){return this._color},set:function(e){var t=e.r,i=e.g,n=e.b;this._color.r===t&&this._color.g===i&&this._color.b===n||(this._color.r=t,this._color.g=i,this._color.b=n,this._colorUniform[0]=t,this._colorUniform[1]=i,this._colorUniform[2]=n,this._renderable.setParameter("material_emissive",this._colorUniform),this._element&&this._element.fire("set:color",this._color))}},{key:"opacity",get:function(){return this._color.a},set:function(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e),this._element&&this._element.fire("set:opacity",e))}},{key:"rect",get:function(){return this._rect},set:function(e){var t,i,n,a;e instanceof ee?(t=e.x,i=e.y,n=e.z,a=e.w):(t=e[0],i=e[1],n=e[2],a=e[3]),t===this._rect.x&&i===this._rect.y&&n===this._rect.z&&a===this._rect.w||(this._rect.set(t,i,n,a),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}},{key:"material",get:function(){return this._material},set:function(e){if(this._material!==e){if(!e){var t=this._element._isScreenSpace();e=this.mask?t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}(this._material=e)&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}},{key:"materialAsset",get:function(){return this._materialAsset},set:function(e){var t=this._system.app.assets,i=e;if(e instanceof Kr&&(i=e.id),this._materialAsset!==i){if(this._materialAsset){t.off("add:"+this._materialAsset,this._onMaterialAdded,this);var n=t.get(this._materialAsset);n&&(n.off("load",this._onMaterialLoad,this),n.off("change",this._onMaterialChange,this),n.off("remove",this._onMaterialRemove,this))}if(this._materialAsset=i,this._materialAsset){var a=t.get(this._materialAsset);a?this._bindMaterialAsset(a):(this.material=null,t.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this.material=null}}},{key:"texture",get:function(){return this._texture},set:function(e){if(this._texture!==e){if(this._textureAsset){var t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null)}(this._texture=e)?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}},{key:"textureAsset",get:function(){return this._textureAsset},set:function(e){var t=this._system.app.assets,i=e;if(e instanceof Kr&&(i=e.id),this._textureAsset!==i){if(this._textureAsset){t.off("add:"+this._textureAsset,this._onTextureAdded,this);var n=t.get(this._textureAsset);n&&(n.off("load",this._onTextureLoad,this),n.off("change",this._onTextureChange,this),n.off("remove",this._onTextureRemove,this))}if(this._textureAsset=i,this._textureAsset){var a=t.get(this._textureAsset);a?this._bindTextureAsset(a):(this.texture=null,t.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}},{key:"spriteAsset",get:function(){return this._spriteAsset},set:function(e){var t=this._system.app.assets,i=e;if(e instanceof Kr&&(i=e.id),this._spriteAsset!==i){if(this._spriteAsset){t.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);var n=t.get(this._spriteAsset);n&&this._unbindSpriteAsset(n)}if(this._spriteAsset=i,this._spriteAsset){var a=t.get(this._spriteAsset);a?this._bindSpriteAsset(a):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null;this._element&&this._element.fire("set:spriteAsset",i)}}},{key:"sprite",get:function(){return this._sprite},set:function(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){var t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null)}this._sprite=e,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=Se.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){var t=this._spriteFrame;this._sprite?this._spriteFrame=Se.clamp(e,0,this._sprite.frameKeys.length-1):this._spriteFrame=e,this._spriteFrame!==t&&(this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e))}},{key:"mesh",get:function(){return this._renderable.mesh},set:function(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}},{key:"mask",get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this._toggleMask())}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}},{key:"aabb",get:function(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}]),e}(),Bu=function(i){function e(e){var t;return((t=i.call(this)||this)._app=e).i18n.on("set:locale",t._onSetLocale,g(t)),t._autoLoad=!1,t._disableLocalization=!1,t._defaultAsset=null,t._localizedAsset=null,t}u(e,i);var t=e.prototype;return t._bindDefaultAsset=function(){var e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)},t._unbindDefaultAsset=function(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this))}},t._onDefaultAssetAdd=function(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this))},t._onDefaultAssetRemove=function(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))},t._bindLocalizedAsset=function(){if(this._autoLoad){var e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e))}},t._unbindLocalizedAsset=function(){var e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this))},t._onLocalizedAssetAdd=function(e){this._localizedAsset===e.id&&this._bindLocalizedAsset()},t._onLocalizedAssetLoad=function(e){this.fire("load",e)},t._onLocalizedAssetChange=function(e,t,i,n){this.fire("change",e,t,i,n)},t._onLocalizedAssetRemove=function(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e)},t._onLocaleAdd=function(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)},t._onLocaleRemove=function(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)},t._onSetLocale=function(e){if(this._defaultAsset){var t=this._app.assets.get(this._defaultAsset);if(t&&!this._disableLocalization){var i=t.getLocalizedAssetId(e);this.localizedAsset=i||this._defaultAsset}else this.localizedAsset=this._defaultAsset}else this.localizedAsset=null},t.destroy=function(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()},c(e,[{key:"defaultAsset",get:function(){return this._defaultAsset},set:function(e){var t=e instanceof Kr?e.id:e;this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=t,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}},{key:"localizedAsset",get:function(){return this._localizedAsset},set:function(e){var t=e instanceof Kr?e.id:e;this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=t,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)))}},{key:"autoLoad",get:function(){return this._autoLoad},set:function(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}},{key:"disableLocalization",get:function(){return this._disableLocalization},set:function(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale))}}]),e}(p),Vu=/[A-Z|a-z|0-9|_|-|/]/,Uu=function(){function e(e){this._symbols=e,this._index=0,this._last=0,this._cur=0<this._symbols.length?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}var t=e.prototype;return t.read=function(){for(var e=this._read();8===e;)e=this._read();return 0!==e&&1!==e&&(this._last=this._index),e},t.buf=function(){return this._buf},t.last=function(){return this._last},t.error=function(){return this._error},t.debugPrint=function(){for(var e=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"],t=this.read(),i="";i+=(0<i.length?"\n":"")+e[t]+" '"+this.buf().join("")+"'",0!==t&&1!==t;)t=this.read();return i},t._read=function(){return this._buf=[],this._eof()?0:"text"===this._mode?this._text():this._tag()},t._text=function(){for(;;)switch(this._cur){case null:return 0<this._buf.length?2:0;case"[":return this._mode="tag",0<this._buf.length?2:this._tag();case"\\":switch(this._next(),this._cur){case"[":this._store();break;default:this._output("\\")}break;default:this._store()}},t._tag=function(){for(;;)switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case"[":return this._store(),3;case"]":return this._store(),this._mode="text",4;case"=":return this._store(),5;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",1)}},t._whitespace=function(){for(this._store();-1!==" \t\n\r\v\f".indexOf(this._cur);)this._store();return 8},t._string=function(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case'"':return this._next(),6;default:this._store()}},t._identifier=function(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return 7},t._isIdentifierSymbol=function(e){return 1===e.length&&null!==e.match(Vu)},t._eof=function(){return null===this._cur},t._next=function(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur},t._store=function(){return this._buf.push(this._cur),this._next()},t._output=function(e){this._buf.push(e)},e}(),Nu=function(){function e(e){this._scanner=new Uu(e),this._error=null}var t=e.prototype;return t.parse=function(e,t){for(;;)switch(this._scanner.read()){case 0:return!0;case 1:return!1;case 2:Array.prototype.push.apply(e,this._scanner.buf());break;case 3:if(!this._parseTag(e,t))return!1;break;default:return!1}},t.error=function(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"},t._parseTag=function(e,t){var i=this._scanner.read();if(7!==i)return!(this._error="expected identifier");var n=this._scanner.buf().join("");if("/"===n[0]){for(var a=t.length-1;0<=a;--a)if(n==="/"+t[a].name&&null===t[a].end)return t[a].end=e.length,4===(i=this._scanner.read())||!(this._error="expected close bracket");return!(this._error="failed to find matching tag")}var s={name:n,value:null,attributes:{},start:e.length,end:null};if(5===(i=this._scanner.read())){if(6!==(i=this._scanner.read()))return!(this._error="expected string");s.value=this._scanner.buf().join(""),i=this._scanner.read()}for(;;){switch(i){case 4:return t.push(s),!0;case 7:var r=this._scanner.buf().join("");if(5!==(i=this._scanner.read()))return!(this._error="expected equals");if(6!==(i=this._scanner.read()))return!(this._error="expected string");var o=this._scanner.buf().join("");s.attributes[r]=o;break;default:return!(this._error="expected close bracket or identifier")}i=this._scanner.read()}},e}();function Gu(e,t){for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];n instanceof Object?(e.hasOwnProperty(i)||(e[i]={}),Gu(e[i],t[i])):e[i]=n}}function Wu(e){if(0===e.length)return null;for(var t={},i=0;i<e.length;++i){var n=e[i],a={};a[n.name]={value:n.value,attributes:n.attributes},Gu(t,a)}return t}var Hu=function(){function e(){}return e.evaluate=function(e){return function(e){var t=new Nu(e),i=[],n=[];if(!t.parse(i,n))return{symbols:e,tags:null};var a=n.find(function(e){return null===e.end});return a?{symbols:e,tags:null}:{symbols:i,tags:function(e,t){var i;if(0===e.length)return null;var n={};for(i=0;i<e.length;++i){var a=e[i];n.hasOwnProperty(a.start)?null===n[a.start].open?n[a.start].open=[a]:n[a.start].open.push(a):n[a.start]={open:[a],close:null},n.hasOwnProperty(a.end)?null===n[a.end].close?n[a.end].close=[a]:n[a.end].close.push(a):n[a.end]={open:null,close:[a]}}var s=[];function r(e){s=s.filter(function(t){return void 0===e.find(function(e){return e===t})})}function o(e){for(var t=0;t<e.length;++t)s.push(e[t])}var l=Object.keys(n).sort(function(e,t){return e-t}),h=[];for(i=0;i<l.length;++i){var c=n[l[i]];null!==c.close&&r(c.close),null!==c.open&&o(c.open),h.push({start:l[i],tags:Wu(s)})}var u=[],d=null;for(i=0;i<h.length;++i){for(var p=h[i];u.length<p.start;)u.push(d?d.tags:null);d=p}for(;u.length<t;)u.push(null);return u}(n,i.length)}}(e)},e}(),ju=function(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.meshInstance=null},Xu=/^[\r\n]$/,qu=/^[ \t]$/,$u=/^[ \t\-]|[\u200b]$/,Yu=/^[a-z0-9]$/i,Ku=/^[\u1100-\u11ff]|[\u3000-\u9fff]|[\ua960-\ua97f]|[\uac00-\ud7ff]$/,Zu=/^[〕〉》」』】〙〗〟ヽヾーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿ々〻]$/,Qu=["​","؜","‎","‏","‪","‫","‬","‭","‮","⁦","⁧","⁨","⁩"],Ju={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},ed=function(){function e(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._symbolColors=null,this._i18nKey=null,this._fontAsset=new Bu(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new $(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new J(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new mn,this._model=new rr,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new ue,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new $(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new $(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new J(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}var t=e.prototype;return t.destroy=function(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)},t._onParentResize=function(e,t){this._noResize||this._font&&this._updateText()},t._onScreenChange=function(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)},t._onScreenSpaceChange=function(e){this._updateMaterial(e)},t._onDrawOrderChange=function(e){var t,i;if(this._drawOrder=e,this._model)for(t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].drawOrder=e},t._onPivotChange=function(e){this._font&&this._updateText()},t._onLocaleSet=function(e){if(this._i18nKey){if(this.fontAsset){var t=this._system.app.assets.get(this.fontAsset);t&&t.resource&&t.resource===this._font||(this.font=null)}this._resetLocalizedText()}},t._onLocalizationData=function(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText()},t._resetLocalizedText=function(){this._setText(this._system.app.i18n.getText(this._i18nKey))},t._setText=function(e){if(this.unicodeConverter){var t=this._system.getUnicodeConverter();t&&(e=t(e))}this._text!==e&&(this._font&&this._updateText(e),this._text=e)},t._updateText=function(e){var t,i,n,a;if(void 0===e&&(e=this._text),this._symbols=Me.getSymbols(e.normalize?e.normalize("NFC"):e),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup&&(n=Hu.evaluate(this._symbols),this._symbols=n.symbols,a=n.tags),this._rtlReorder){var s=this._system.app.systems.element.getRtlReorder();s&&(n=s(this._symbols),this._rtl=n.rtl,this._symbols=n.mapping.map(function(e){return this._symbols[e]},this),a&&(a=n.mapping.map(function(e){return a[e]})))}else this._rtl=!1;if(a){var r={};for(this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._symbolColors=[],t=r[this._color.toString(!1).toLowerCase()]=0,i=this._symbols.length;t<i;++t){var o=a[t],l=0;if(o&&o.color&&o.color.value){var h=o.color.value;if(7===h.length&&"#"===h[0]){var c=h.substring(1).toLowerCase();r.hasOwnProperty(c)?l=r[c]:/^([0-9a-f]{2}){3}$/.test(c)&&(l=this._colorPalette.length/3,r[c]=l,this._colorPalette.push(parseInt(c.substring(0,2),16)),this._colorPalette.push(parseInt(c.substring(2,4),16)),this._colorPalette.push(parseInt(c.substring(4,6),16)))}}this._symbolColors.push(l)}}else this._colorPalette=[],this._symbolColors=null;var u=this._calculateCharsPerTexture(),d=!1,p=this._element,f=p._isScreenSpace(),m=p._isScreenCulled(),v=function(e){return p.isVisibleForCamera(e)};for(t=0,i=this._meshInfo.length;t<i;t++){var g=u[t]||0,_=this._meshInfo[t];if(_.count!==g){if(d||(p.removeModelFromLayers(this._model),d=!0),_.count=g,_.positions.length=_.normals.length=3*g*4,_.indices.length=3*g*2,_.uvs.length=2*g*4,_.colors.length=4*g*4,_.meshInstance&&this._removeMeshInstance(_.meshInstance),0===g){_.meshInstance=null;continue}for(var y=0;y<g;y++)_.indices[3*y*2+0]=4*y,_.indices[3*y*2+1]=4*y+1,_.indices[3*y*2+2]=4*y+3,_.indices[3*y*2+3]=4*y+2,_.indices[3*y*2+4]=4*y+3,_.indices[3*y*2+5]=4*y+1,_.normals[4*y*3+0]=0,_.normals[4*y*3+1]=0,_.normals[4*y*3+2]=-1,_.normals[4*y*3+3]=0,_.normals[4*y*3+4]=0,_.normals[4*y*3+5]=-1,_.normals[4*y*3+6]=0,_.normals[4*y*3+7]=0,_.normals[4*y*3+8]=-1,_.normals[4*y*3+9]=0,_.normals[4*y*3+10]=0,_.normals[4*y*3+11]=-1;var b=Js(this._system.app.graphicsDevice,_.positions,{uvs:_.uvs,normals:_.normals,colors:_.colors,indices:_.indices}),x=new Mn(b,this._material,this._node);x.name="Text Element: "+this._entity.name,x.castShadow=!1,x.receiveShadow=!1,x.cull=!f,x.screenSpace=f,x.drawOrder=this._drawOrder,m&&(x.cull=!0,x.isVisibleFunc=v),this._setTextureParams(x,this._font.textures[t]),this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b),x.setParameter("material_emissive",this._colorUniform),x.setParameter("material_opacity",this._color.a),x.setParameter("font_sdfIntensity",this._font.intensity),x.setParameter("font_pxrange",this._getPxRange(this._font)),x.setParameter("font_textureWidth",this._font.data.info.maps[t].width),this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,x.setParameter("outline_color",this._outlineColorUniform),x.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,x.setParameter("shadow_color",this._shadowColorUniform);var M=-this._font.data.info.maps[t].width/this._font.data.info.maps[t].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=M*this._shadowOffsetScale*this._shadowOffset.y,x.setParameter("shadow_offset",this._shadowOffsetUniform),_.meshInstance=x,this._model.meshInstances.push(x)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),d&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()},t._removeMeshInstance=function(e){e.material=null;var t=e.mesh;t&&t.destroy();var i=this._model.meshInstances.indexOf(e);-1!==i&&this._model.meshInstances.splice(i,1)},t._setMaterial=function(e){var t,i;if(this._material=e,this._model)for(t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].material=e},t._updateMaterial=function(e){var t=this._element,i=t._isScreenCulled(),n=function(e){return t.isVisibleForCamera(e)},a=this._font&&this._font.type===Vo;if(this._material=this._system.getTextElementMaterial(e,a),this._model)for(var s=0,r=this._model.meshInstances.length;s<r;s++){var o=this._model.meshInstances[s];o.cull=!e,o.material=this._material,o.screenSpace=e,i?(o.cull=!0,o.isVisibleFunc=n):o.isVisibleFunc=null}},t._isWordBoundary=function(e){return $u.test(e)},t._isValidNextChar=function(e){return null!==e&&!Zu.test(e)},t._isNextCJKBoundary=function(e,t){return Ku.test(e)&&($u.test(t)||Yu.test(t))},t._isNextCJKWholeWord=function(e){return Ku.test(e)},t._updateMeshes=function(){var e=this._font.data,o=this,t=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,n=this._shouldAutoFit();n&&(this._fontSize=this._maxFontSize);var a=this._symbols.length,l=0,h=0,s=0,r=0,c=1,u=0,d=0,p=0,f=0,m=0,v=0,g=1e-4<=Math.abs(this._element.anchor.x-this._element.anchor.z),_=this._element.calculatedWidth;(this.autoWidth&&!g||!this._wrapLines)&&(_=Number.POSITIVE_INFINITY);var y,b,x,M,S,w,C=0,P=0,T=1;function A(e,t,i){o._lineWidths.push(Math.abs(i));var n=t<p?t+1:p,a=t<p?p+1:t,s=e.slice(n,a);if(v)for(var r=s.length;r--&&0<v;)Xu.test(s[r])&&(s.splice(r,1),v--);o._lineContents.push(s.join("")),l=0,h-=o._scaledLineHeight,c++,u=v=m=f=0,p=t}for(var E=!0;E;){for(E=!1,this._scaledLineHeight=n?this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],c=1,v=m=f=p=d=u=r=s=h=l=0,T=this._fontSize/32,C=this._fontMinY*T,P=this._fontMaxY*T,x=0;x<this._meshInfo.length;x++)this._meshInfo[x].quad=0,this._meshInfo[x].lines={};var R=255,D=255,I=255;for(x=0;x<a;x++)if(y=this._symbols[x],w=a<=x+1?null:this._symbols[x+1],Xu.test(y))v++,(!this._wrapLines||this._maxLines<0||c<this._maxLines)&&(A(this._symbols,x,r),p=d=x+1);else{var k,L=0,O=0,F=0,z=1;if(!(b=e.chars[y]))if(-1!==Qu.indexOf(y))b=Ju;else if(e.chars[" "])b=e.chars[" "];else for(var B in e.chars){b=e.chars[B];break}if(b){var V=0;if(0<m){var U=this._font.data.kerning;if(U){var N=U[Me.getCodePoint(this._symbols[x-1])||0];N&&(V=N[Me.getCodePoint(this._symbols[x])||0]||0)}}k=b.scale||1,z=T*((b.width+b.height)/2)/k,F=(b.xadvance+V)*T,L=(b.xoffset-V)*T,O=b.yoffset*T}var G=qu.test(y),W=this._meshInfo[b&&b.map||0],H=l+this._spacing*F;if(_<H&&0<m&&!G&&(this._maxLines<0||c<this._maxLines)){if(0!==f){var j=Math.max(x-d,0);if(this._meshInfo.length<=1)W.lines[c-1]-=j,W.quad-=j;else{var X=x;for(M=d;M<X;M++){var q=this._symbols[M],$=e.chars[q],Y=this._meshInfo[$&&$.map||0];Y.lines[c-1]-=1,Y.quad-=1}}x-=j+1,A(this._symbols,d,u);continue}d=x,A(this._symbols,x,r)}S=W.quad,W.lines[c-1]=S;var K,Z=l-L,Q=Z+z,J=h-O,ee=J+z;if(this._rtl){var te=z-L-this._spacing*F-L;Z-=te,Q-=te}if(W.positions[4*S*3+0]=Z,W.positions[4*S*3+1]=J,W.positions[4*S*3+2]=s,W.positions[4*S*3+3]=Q,W.positions[4*S*3+4]=J,W.positions[4*S*3+5]=s,W.positions[4*S*3+6]=Q,W.positions[4*S*3+7]=ee,W.positions[4*S*3+8]=s,W.positions[4*S*3+9]=Z,W.positions[4*S*3+10]=ee,W.positions[4*S*3+11]=s,this.width=Math.max(this.width,H),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(K=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),(K=Se.clamp(K,t,i))!==this._element.fontSize)){this._fontSize=K,E=!0;break}if(this.height=Math.max(this.height,P-(h+C)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(K=Se.clamp(this._fontSize-1,t,i))!==this._element.fontSize){this._fontSize=K,E=!0;break}l+=this._spacing*F,G||(r=l),(this._isWordBoundary(y)||this._isValidNextChar(w)&&(this._isNextCJKBoundary(y,w)||this._isNextCJKWholeWord(w)))&&(f++,u=r,d=x+1),m++;var ie=this._getUv(y);if(W.uvs[4*S*2+0]=ie[0],W.uvs[4*S*2+1]=1-ie[1],W.uvs[4*S*2+2]=ie[2],W.uvs[4*S*2+3]=1-ie[1],W.uvs[4*S*2+4]=ie[2],W.uvs[4*S*2+5]=1-ie[3],W.uvs[4*S*2+6]=ie[0],W.uvs[4*S*2+7]=1-ie[3],this._symbolColors){var ne=3*this._symbolColors[x];R=this._colorPalette[ne],D=this._colorPalette[ne+1],I=this._colorPalette[ne+2]}W.colors[4*S*4+0]=R,W.colors[4*S*4+1]=D,W.colors[4*S*4+2]=I,W.colors[4*S*4+3]=255,W.colors[4*S*4+4]=R,W.colors[4*S*4+5]=D,W.colors[4*S*4+6]=I,W.colors[4*S*4+7]=255,W.colors[4*S*4+8]=R,W.colors[4*S*4+9]=D,W.colors[4*S*4+10]=I,W.colors[4*S*4+11]=255,W.colors[4*S*4+12]=R,W.colors[4*S*4+13]=D,W.colors[4*S*4+14]=I,W.colors[4*S*4+15]=255,W.quad++}E||p<a&&A(this._symbols,a,l)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;var ae=this._element.pivot.x,se=this._element.pivot.y,re=this._alignment.x,oe=this._alignment.y;for(x=0;x<this._meshInfo.length;x++)if(0!==this._meshInfo[x].count){var le=0;for(var he in this._meshInfo[x].lines){var ce=this._meshInfo[x].lines[he],ue=this._lineWidths[parseInt(he,10)],de=-ae*this._element.calculatedWidth+re*(this._element.calculatedWidth-ue)*(this._rtl?-1:1),pe=(1-se)*this._element.calculatedHeight-P-(1-oe)*(this._element.calculatedHeight-this.height);for(S=le;S<=ce;S++)this._meshInfo[x].positions[4*S*3]+=de,this._meshInfo[x].positions[4*S*3+3]+=de,this._meshInfo[x].positions[4*S*3+6]+=de,this._meshInfo[x].positions[4*S*3+9]+=de,this._meshInfo[x].positions[4*S*3+1]+=pe,this._meshInfo[x].positions[4*S*3+4]+=pe,this._meshInfo[x].positions[4*S*3+7]+=pe,this._meshInfo[x].positions[4*S*3+10]+=pe;if(this._rtl)for(S=le;S<=ce;S++){for(var fe=4*S*3,me=0;me<4;++me)this._meshInfo[x].positions[fe+3*me]=this._element.calculatedWidth-this._meshInfo[x].positions[fe+3*me]+2*de;var ve=this._meshInfo[x].positions[fe+3],ge=this._meshInfo[x].positions[fe+6];this._meshInfo[x].positions[fe+3]=this._meshInfo[x].positions[fe+0],this._meshInfo[x].positions[fe+6]=this._meshInfo[x].positions[fe+9],this._meshInfo[x].positions[fe+0]=ve,this._meshInfo[x].positions[fe+9]=ge}le=ce+1}for(var _e=4*this._meshInfo[x].count,ye=4*this._meshInfo[x].quad,be=new Ct(this._meshInfo[x].meshInstance.mesh.vertexBuffer),xe=0;xe<_e;xe++)ye<=xe?(be.element.POSITION.set(0,0,0),be.element.TEXCOORD0.set(0,0),be.element.COLOR.set(0,0,0,0)):(be.element.POSITION.set(this._meshInfo[x].positions[3*xe+0],this._meshInfo[x].positions[3*xe+1],this._meshInfo[x].positions[3*xe+2]),be.element.TEXCOORD0.set(this._meshInfo[x].uvs[2*xe+0],this._meshInfo[x].uvs[2*xe+1]),be.element.COLOR.set(this._meshInfo[x].colors[4*xe+0],this._meshInfo[x].colors[4*xe+1],this._meshInfo[x].colors[4*xe+2],this._meshInfo[x].colors[4*xe+3])),be.next();be.end(),this._meshInfo[x].meshInstance.mesh.aabb.compute(this._meshInfo[x].positions),this._meshInfo[x].meshInstance._aabbVer=-1}this._aabbDirty=!0},t._onFontRender=function(){this.font=this._font},t._onFontLoad=function(e){this.font!==e.resource&&(this.font=e.resource)},t._onFontChange=function(e,t,i,n){if("data"===t){this._font.data=i;for(var a=this._font.data.info.maps.length,s=0;s<a;s++)if(this._meshInfo[s]){var r=this._meshInfo[s].meshInstance;r&&(r.setParameter("font_sdfIntensity",this._font.intensity),r.setParameter("font_pxrange",this._getPxRange(this._font)),r.setParameter("font_textureWidth",this._font.data.info.maps[s].width))}}},t._onFontRemove=function(e){},t._setTextureParams=function(e,t){this._font&&(this._font.type===Vo?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):"bitmap"===this._font.type&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)))},t._getPxRange=function(e){for(var t=Object.keys(this._font.data.chars),i=0;i<t.length;i++){var n=this._font.data.chars[t[i]];if(n.range)return(n.scale||1)*n.range}return 2},t._getUv=function(e){var t=this._font.data;if(!t.chars[e])return t.chars[" "]?this._getUv(" "):[0,0,0,0];var i=t.chars[e].map,n=t.info.maps[i].width,a=t.info.maps[i].height,s=t.chars[e].x,r=t.chars[e].y,o=s,l=r,h=s+t.chars[e].width,c=r-t.chars[e].height,u=1-t.chars[e].height/a;return[o/n,u-l/a,h/n,u-c/a]},t.onEnable=function(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)},t.onDisable=function(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)},t._setStencil=function(e){if(this._model)for(var t=this._model.meshInstances,i=0;i<t.length;i++)t[i].stencilFront=e,t[i].stencilBack=e},t._shouldAutoFitWidth=function(){return this._autoFitWidth&&!this._autoWidth},t._shouldAutoFitHeight=function(){return this._autoFitHeight&&!this._autoHeight},t._shouldAutoFit=function(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight},t._calculateCharsPerTexture=function(e){var t,i,n,a,s,r={};for(void 0===e&&(e=this._symbols.length),t=0,i=e;t<i;t++)n=this._symbols[t],(a=this._font.data.chars[n])||(a=this._font.data.chars[" "])||(a=this._font.data.chars[Object.keys(this._font.data.chars)[0]]),r[s=a.map]?r[s]++:r[s]=1;return r},t._updateRenderRange=function(){var e,t,i=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),n=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd);for(e=0,t=this._meshInfo.length;e<t;e++){var a=i[e]||0,s=n[e]||0,r=this._meshInfo[e].meshInstance;if(r){var o=r.mesh;o&&(o.primitive[0].base=3*a*2,o.primitive[0].count=3*(s-a)*2)}}},c(e,[{key:"text",get:function(){return this._text},set:function(e){var t=(this._i18nKey=null)!=e&&e.toString()||"";this._setText(t)}},{key:"key",get:function(){return this._i18nKey},set:function(e){var t=null!==e?e.toString():null;this._i18nKey!==t&&((this._i18nKey=t)?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}},{key:"color",get:function(){return this._color},set:function(e){var t=e.r,i=e.g,n=e.b;if(this._color.r!==t||this._color.g!==i||this._color.b!==n)if(this._color.r=t,this._color.g=i,this._color.b=n,this._symbolColors)this._font&&this._updateText();else{this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b;for(var a=0,s=this._model.meshInstances.length;a<s;a++)this._model.meshInstances[a].setParameter("material_emissive",this._colorUniform)}}},{key:"opacity",get:function(){return this._color.a},set:function(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(var t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("material_opacity",e)}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){var t=this._lineHeight;this._lineHeight=e,t!==(this._scaledLineHeight=e)&&this._font&&this._updateText()}},{key:"wrapLines",get:function(){return this._wrapLines},set:function(e){this._wrapLines!==(this._wrapLines=e)&&this._font&&this._updateText()}},{key:"lines",get:function(){return this._lineContents}},{key:"spacing",get:function(){return this._spacing},set:function(e){this._spacing!==(this._spacing=e)&&this._font&&this._updateText()}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){var t=this._fontSize;this._fontSize=e,t!==(this._originalFontSize=e)&&this._font&&this._updateText()}},{key:"fontAsset",get:function(){return this._fontAsset.localizedAsset},set:function(e){this._fontAsset.defaultAsset=e}},{key:"font",get:function(){return this._font},set:function(e){var t,i,n;if(this._font&&(n=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMinY=0,this._fontMaxY=0,e){var a=this._font.data;for(var s in a.chars){var r=a.chars[s];r.bounds&&(this._fontMinY=Math.min(this._fontMinY,r.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,r.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),e.type!==n){var o=this._element._isScreenSpace();this._updateMaterial(o)}for(t=0,i=this._font.textures.length;t<i;t++)if(this._meshInfo[t]){var l=this._meshInfo[t].meshInstance;l&&(l.setParameter("font_sdfIntensity",this._font.intensity),l.setParameter("font_pxrange",this._getPxRange(this._font)),l.setParameter("font_textureWidth",this._font.data.info.maps[t].width),this._setTextureParams(l,this._font.textures[t]))}else this._meshInfo[t]=new ju;var h=!1;for(t=this._font.textures.length;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(h||(this._element.removeModelFromLayers(this._model),h=!0),this._removeMeshInstance(this._meshInfo[t].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}}},{key:"alignment",get:function(){return this._alignment},set:function(e){e instanceof J?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText()}},{key:"autoWidth",get:function(){return this._autoWidth},set:function(e){var t=this._autoWidth;if((this._autoWidth=e)&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),t!==e){var i=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;i!==this._fontSize&&(this._fontSize=i,this._font&&this._updateText())}}},{key:"autoHeight",get:function(){return this._autoHeight},set:function(e){var t=this._autoHeight;if((this._autoHeight=e)&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),t!==e){var i=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;i!==this._fontSize&&(this._fontSize=i,this._font&&this._updateText())}}},{key:"rtlReorder",get:function(){return this._rtlReorder},set:function(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText())}},{key:"unicodeConverter",get:function(){return this._unicodeConverter},set:function(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text))}},{key:"aabb",get:function(){if(this._aabbDirty){for(var e=!1,t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=!0));this._aabbDirty=!1}return this._aabb}},{key:"outlineColor",get:function(){return this._outlineColor},set:function(e){var t=e instanceof $?e.r:e[0],i=e instanceof $?e.g:e[1],n=e instanceof $?e.b:e[2],a=e instanceof $?e.a:e[3];if((this._outlineColor.r!==t||this._outlineColor.g!==i||this._outlineColor.b!==n||this._outlineColor.a!==a)&&(this._outlineColor.r=t,this._outlineColor.g=i,this._outlineColor.b=n,this._outlineColor.a=a,this._model)){this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a;for(var s=0,r=this._model.meshInstances.length;s<r;s++)this._model.meshInstances[s].setParameter("outline_color",this._outlineColorUniform)}}},{key:"outlineThickness",get:function(){return this._outlineThickness},set:function(e){if(this._outlineThickness!==(this._outlineThickness=e)&&this._font&&this._model)for(var t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){var t=e instanceof $?e.r:e[0],i=e instanceof $?e.g:e[1],n=e instanceof $?e.b:e[2],a=e instanceof $?e.a:e[3];if((this._shadowColor.r!==t||this._shadowColor.g!==i||this._shadowColor.b!==n||this._shadowColor.a!==a)&&(this._shadowColor.r=t,this._shadowColor.g=i,this._shadowColor.b=n,this._shadowColor.a=a,this._model)){this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a;for(var s=0,r=this._model.meshInstances.length;s<r;s++)this._model.meshInstances[s].setParameter("shadow_color",this._shadowColorUniform)}}},{key:"shadowOffset",get:function(){return this._shadowOffset},set:function(e){var t=e instanceof J?e.x:e[0],i=e instanceof J?e.y:e[1];if((this._shadowOffset.x!==t||this._shadowOffset.y!==i)&&(this._shadowOffset.set(t,i),this._font&&this._model))for(var n=0,a=this._model.meshInstances.length;n<a;n++){var s=-this._font.data.info.maps[n].width/this._font.data.info.maps[n].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=s*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[n].setParameter("shadow_offset",this._shadowOffsetUniform)}}},{key:"minFontSize",get:function(){return this._minFontSize},set:function(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}},{key:"maxFontSize",get:function(){return this._maxFontSize},set:function(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}},{key:"autoFitWidth",get:function(){return this._autoFitWidth},set:function(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}},{key:"autoFitHeight",get:function(){return this._autoFitHeight},set:function(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}},{key:"maxLines",get:function(){return this._maxLines},set:function(e){this._maxLines!==e&&(null===e&&-1===this._maxLines||(this._maxLines=null===e?-1:e,this.font&&this._wrapLines&&this._updateText()))}},{key:"enableMarkup",get:function(){return this._enableMarkup},set:function(e){e=!!e,this._enableMarkup!==e&&(this._enableMarkup=e,this.font&&this._updateText())}},{key:"symbols",get:function(){return this._symbols}},{key:"symbolColors",get:function(){return null===this._symbolColors?null:this._symbolColors.map(function(e){return this._colorPalette.slice(3*e,3*e+3)},this)}},{key:"rtl",get:function(){return this._rtl}},{key:"rangeStart",get:function(){return this._rangeStart},set:function(e){(e=Math.max(0,Math.min(e,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange())}},{key:"rangeEnd",get:function(){return this._rangeEnd},set:function(e){(e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange())}}]),e}(),td=new de,id=new pe,nd=new de,ad=new de,sd=new pe,rd=new pe,od=new pe,ld=new pe,hd=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._beingInitialized=!1,i._anchor=new ee,i._localAnchor=new ee,i._pivot=new J,i._width=i._calculatedWidth=32,i._height=i._calculatedHeight=32,i._margin=new ee(0,0,-32,-32),i._modelTransform=new pe,i._screenToWorld=new pe,i._anchorTransform=new pe,i._anchorDirty=!0,i._parentWorldTransform=new pe,i._screenTransform=new pe,i._screenCorners=[new de,new de,new de,new de],i._canvasCorners=[new J,new J,new J,new J],i._worldCorners=[new de,new de,new de,new de],i._cornersDirty=!0,i._canvasCornersDirty=!0,i._worldCornersDirty=!0,i.entity.on("insert",i._onInsert,g(i)),i._patch(),i.screen=null,i._type="group",i._image=null,i._text=null,i._group=null,i._drawOrder=0,i._useInput=!1,i._layers=[4],i._addedModels=[],i._batchGroupId=-1,i._offsetReadAt=0,i._maskOffset=.5,i._maskedBy=null,i}u(e,n);var t=e.prototype;return t._patch=function(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition},t._unpatch=function(){this.entity._sync=Cr.prototype._sync,this.entity.setPosition=Cr.prototype.setPosition,this.entity.setLocalPosition=Cr.prototype.setLocalPosition},t._setPosition=function(e,t,i){if(!this.element.screen)return Cr.prototype.setPosition.call(this,e,t,i);e instanceof de?td.copy(e):td.set(e,t,i),this.getWorldTransform(),id.copy(this.element._screenToWorld).invert(),id.transformPoint(td,this.localPosition),this._dirtyLocal||this._dirtifyLocal()},t._setLocalPosition=function(e,t,i){e instanceof de?this.localPosition.copy(e):this.localPosition.set(e,t,i);var n=this.element,a=this.localPosition,s=n._pivot;n._margin.x=a.x-n._calculatedWidth*s.x,n._margin.z=n._localAnchor.z-n._localAnchor.x-n._calculatedWidth-n._margin.x,n._margin.y=a.y-n._calculatedHeight*s.y,n._margin.w=n._localAnchor.w-n._localAnchor.y-n._calculatedHeight-n._margin.y,this._dirtyLocal||this._dirtifyLocal()},t._sync=function(){var e=this.element,t=e.screen;if(t){if(e._anchorDirty){var i=0,n=0,a=0,s=1;if(this._parent&&this._parent.element)i=this._parent.element.calculatedWidth,n=this._parent.element.calculatedHeight,a=this._parent.element.pivot.x,s=this._parent.element.pivot.y;else{var r=t.screen.resolution;i=r.x/t.screen.scale,n=r.y/t.screen.scale}e._anchorTransform.setTranslate(i*(e.anchor.x-a),-n*(s-e.anchor.y),0),e._anchorDirty=!1,e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);var o=this.localPosition,l=e._pivot;e._margin.x=o.x-e._calculatedWidth*l.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=o.y-e._calculatedHeight*l.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=!1}if(!t)return this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),Cr.prototype._sync.call(this);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t){e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);var h=e._parentWorldTransform;h.setIdentity();var c=this._parent;c&&c.element&&c!==t&&(sd.setTRS(de.ZERO,c.getLocalRotation(),c.getLocalScale()),h.mul2(c.element._parentWorldTransform,sd));var u=nd;u.set(0,0,this.localPosition.z);var d=ad;d.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),sd.setTranslate(-d.x,-d.y,-d.z),rd.setTRS(u,this.getLocalRotation(),this.getLocalScale()),od.setTranslate(d.x,d.y,d.z),e._screenTransform.mul2(e._parentWorldTransform,od).mul(rd).mul(sd),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=!1}},t._onInsert=function(e){var t=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask()},t._dirtifyMask=function(){for(var e=this.entity;e;){var t=e.parent;if((null===t||t.screen)&&e.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var i=this.system._prerender.indexOf(this.entity);0<=i&&this.system._prerender.splice(i,1),this.system._prerender.indexOf(e)<0&&this.system._prerender.push(e)}e=t}},t._onPrerender=function(){for(var e=0;e<this.system._prerender.length;e++){var t=this.system._prerender[e];t.element&&t.element.syncMask(1)}this.system._prerender.length=0},t._bindScreen=function(e){e._bindElement(this)},t._unbindScreen=function(e){e._unbindElement(this)},t._updateScreen=function(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);var t=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=!0;for(var i=this.entity.children,n=0,a=i.length;n<a;n++)i[n].element&&i[n].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder()},t.syncMask=function(e){var t=this._parseUpToScreen();this._updateMask(t.mask,e)},t._setMaskedBy=function(e){var t=this._image||this._text;if(e){var i=e.element._image._maskRef,n=new Ou({ref:i,func:2});t&&t._setStencil&&t._setStencil(n),this._maskedBy=e}else t&&t._setStencil&&t._setStencil(null),this._maskedBy=null},t._updateMask=function(e,t){var i,n,a,s;if(e){if(this._setMaskedBy(e),this.mask){var r=e.element._image._maskRef;a=new Ou({ref:r,func:2,zpass:3}),this._image._setStencil(a),this._image._maskRef=t,t++,e=this.entity}for(i=0,n=(s=this.entity.children).length;i<n;i++)s[i].element&&s[i].element._updateMask(e,t);this.mask&&t--}else{for(this._setMaskedBy(null),this.mask&&(a=new Ou({ref:t,func:7,zpass:2}),this._image._setStencil(a),this._image._maskRef=t,t++,e=this.entity),i=0,n=(s=this.entity.children).length;i<n;i++)s[i].element&&s[i].element._updateMask(e,t);this.mask&&t--}},t._parseUpToScreen=function(){for(var e={screen:null,mask:null},t=this.entity._parent;t&&!t.screen;)t.element&&t.element.mask&&(e.mask||(e.mask=t)),t=t.parent;return t&&t.screen&&(e.screen=t),e},t._onScreenResize=function(e){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e)},t._onScreenSpaceChange=function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)},t._onScreenRemove=function(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))},t._calculateLocalAnchors=function(){var e=1e3,t=1e3,i=this.entity._parent;if(i&&i.element)e=i.element.calculatedWidth,t=i.element.calculatedHeight;else if(this.screen){var n=this.screen.screen.resolution,a=this.screen.screen.scale;e=n.x/a,t=n.y/a}this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t)},t.getOffsetPosition=function(e,t){var i=this.entity.getLocalPosition().clone();return i.x+=e,i.y+=t,this._screenToWorld.transformPoint(i,i),i},t.onLayersChanged=function(e,t){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){this.layers.indexOf(e.id)<0||(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances))},t.onLayerRemoved=function(e){this.layers.indexOf(e.id)<0||(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances))},t.onEnable=function(){this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),0<=this._batchGroupId&&this.system.app.batcher.insert(Cn.ELEMENT,this.batchGroupId,this.entity),this.fire("enableelement")},t.onDisable=function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),0<=this._batchGroupId&&this.system.app.batcher.remove(Cn.ELEMENT,this.batchGroupId,this.entity),this.fire("disableelement")},t.onRemove=function(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()},t._calculateSize=function(e,t){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var i=this._absRight-this._absLeft,n=this._absTop-this._absBottom;e?this._setWidth(i):this._setCalculatedWidth(i,!1),t?this._setHeight(n):this._setCalculatedHeight(n,!1);var a=this.entity.getLocalPosition();a.x=this._margin.x+this._calculatedWidth*this._pivot.x,a.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(a),this._sizeDirty=!1}},t._setWidth=function(e){this._width=e,this._setCalculatedWidth(e,!1),this.fire("set:width",this._width)},t._setHeight=function(e){this._height=e,this._setCalculatedHeight(e,!1),this.fire("set:height",this._height)},t._setCalculatedWidth=function(e,t){if(!(Math.abs(e-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){var i=this.entity.getLocalPosition(),n=this._pivot;this._margin.x=i.x-this._calculatedWidth*n.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}},t._setCalculatedHeight=function(e,t){if(!(Math.abs(e-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){var i=this.entity.getLocalPosition(),n=this._pivot;this._margin.y=i.y-this._calculatedHeight*n.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}},t._flagChildrenAsDirty=function(){var e,t,i=this.entity._children;for(e=0,t=i.length;e<t;e++)i[e].element&&(i[e].element._anchorDirty=!0,i[e].element._sizeDirty=!0)},t.addModelToLayers=function(e){var t;this._addedModels.push(e);for(var i=0;i<this.layers.length;i++)(t=this.system.app.scene.layers.getLayerById(this.layers[i]))&&t.addMeshInstances(e.meshInstances)},t.removeModelFromLayers=function(e){var t,i=this._addedModels.indexOf(e);0<=i&&this._addedModels.splice(i,1);for(var n=0;n<this.layers.length;n++)(t=this.system.app.scene.layers.getLayerById(this.layers[n]))&&t.removeMeshInstances(e.meshInstances)},t.getMaskOffset=function(){var e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);var t=this._maskOffset;return this._maskOffset-=.001,t},t.isVisibleForCamera=function(e){var t,i,n,a;if(this.maskedBy){var s=this.maskedBy.element.screenCorners;t=Math.min(Math.min(s[0].x,s[1].x),Math.min(s[2].x,s[3].x)),i=Math.max(Math.max(s[0].x,s[1].x),Math.max(s[2].x,s[3].x)),a=Math.min(Math.min(s[0].y,s[1].y),Math.min(s[2].y,s[3].y)),n=Math.max(Math.max(s[0].y,s[1].y),Math.max(s[2].y,s[3].y))}else{var r=this.system.app.graphicsDevice.width,o=this.system.app.graphicsDevice.height,l=e._rect.z*r,h=e._rect.w*o;i=(t=e._rect.x*r)+l,a=(n=(1-e._rect.y)*o)-h}var c=this.screenCorners,u=Math.min(Math.min(c[0].x,c[1].x),Math.min(c[2].x,c[3].x)),d=Math.max(Math.max(c[0].x,c[1].x),Math.max(c[2].x,c[3].x)),p=Math.min(Math.min(c[0].y,c[1].y),Math.min(c[2].y,c[3].y)),f=Math.max(Math.max(c[0].y,c[1].y),Math.max(c[2].y,c[3].y));return!(d<t||i<u||n<p||f<a)},t._isScreenSpace=function(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.screenSpace},t._isScreenCulled=function(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.cull},e}(Xh);Object.defineProperty(hd.prototype,"type",{get:function(){return this._type},set:function(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),e===ku?this._image=new zu(this):e===Lu&&(this._text=new ed(this)))}}),Object.defineProperty(hd.prototype,"layers",{get:function(){return this._layers},set:function(e){var t,i,n;if(this._addedModels.length)for(t=0;t<this._layers.length;t++)if(n=this.system.app.scene.layers.getLayerById(this._layers[t]))for(i=0;i<this._addedModels.length;i++)n.removeMeshInstances(this._addedModels[i].meshInstances);if(this._layers=e,this.enabled&&this.entity.enabled&&this._addedModels.length)for(t=0;t<this._layers.length;t++)if(n=this.system.app.scene.layers.getLayerById(this._layers[t]))for(i=0;i<this._addedModels.length;i++)n.addMeshInstances(this._addedModels[i].meshInstances)}}),Object.defineProperty(hd.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(e){var t=0;this.screen&&(t=this.screen.screen.priority),16777215<e&&(e=16777215),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder)}}),Object.defineProperty(hd.prototype,"_absLeft",{get:function(){return this._localAnchor.x+this._margin.x}}),Object.defineProperty(hd.prototype,"_absRight",{get:function(){return this._localAnchor.z-this._margin.z}}),Object.defineProperty(hd.prototype,"_absTop",{get:function(){return this._localAnchor.w-this._margin.w}}),Object.defineProperty(hd.prototype,"_absBottom",{get:function(){return this._localAnchor.y+this._margin.y}}),Object.defineProperty(hd.prototype,"margin",{get:function(){return this._margin},set:function(e){this._margin.copy(e),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}}),Object.defineProperty(hd.prototype,"left",{get:function(){return this._margin.x},set:function(e){this._margin.x=e;var t=this.entity.getLocalPosition(),i=this._absRight,n=this._localAnchor.x+e;this._setWidth(i-n),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t)}}),Object.defineProperty(hd.prototype,"right",{get:function(){return this._margin.z},set:function(e){this._margin.z=e;var t=this.entity.getLocalPosition(),i=this._absLeft,n=this._localAnchor.z-e;this._setWidth(n-i),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t)}}),Object.defineProperty(hd.prototype,"top",{get:function(){return this._margin.w},set:function(e){this._margin.w=e;var t=this.entity.getLocalPosition(),i=this._absBottom,n=this._localAnchor.w-e;this._setHeight(n-i),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t)}}),Object.defineProperty(hd.prototype,"bottom",{get:function(){return this._margin.y},set:function(e){this._margin.y=e;var t=this.entity.getLocalPosition(),i=this._absTop,n=this._localAnchor.y+e;this._setHeight(i-n),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t)}}),Object.defineProperty(hd.prototype,"width",{get:function(){return this._width},set:function(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,!0),this.fire("set:width",this._width)}}),Object.defineProperty(hd.prototype,"height",{get:function(){return this._height},set:function(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,!0),this.fire("set:height",this._height)}}),Object.defineProperty(hd.prototype,"calculatedWidth",{get:function(){return this._calculatedWidth},set:function(e){this._setCalculatedWidth(e,!0)}}),Object.defineProperty(hd.prototype,"calculatedHeight",{get:function(){return this._calculatedHeight},set:function(e){this._setCalculatedHeight(e,!0)}}),Object.defineProperty(hd.prototype,"pivot",{get:function(){return this._pivot},set:function(e){var t=this._pivot.x,i=this._pivot.y;e instanceof J?this._pivot.set(e.x,e.y):this._pivot.set(e[0],e[1]);var n=this._margin.x+this._margin.z,a=this._pivot.x-t;this._margin.x+=n*a,this._margin.z-=n*a;var s=this._margin.y+this._margin.w,r=this._pivot.y-i;this._margin.y+=s*r,this._margin.w-=s*r,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",this._pivot)}}),Object.defineProperty(hd.prototype,"anchor",{get:function(){return this._anchor},set:function(e){e instanceof ee?this._anchor.set(e.x,e.y,e.z,e.w):this._anchor.set(e[0],e[1],e[2],e[3]),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}}),Object.defineProperty(hd.prototype,"_hasSplitAnchorsX",{get:function(){return.001<Math.abs(this._anchor.x-this._anchor.z)}}),Object.defineProperty(hd.prototype,"_hasSplitAnchorsY",{get:function(){return.001<Math.abs(this._anchor.y-this._anchor.w)}}),Object.defineProperty(hd.prototype,"aabb",{get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:null}}),Object.defineProperty(hd.prototype,"screenCorners",{get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var t=this.screen.screen.screenSpace,i=0;i<4;i++)this._screenTransform.transformPoint(this._screenCorners[i],this._screenCorners[i]),t&&this._screenCorners[i].mulScalar(this.screen.screen.scale),e&&this._screenCorners[i].add(e);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}}),Object.defineProperty(hd.prototype,"canvasCorners",{get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var e=this.system.app.graphicsDevice,t=this.screenCorners,i=e.canvas.clientWidth/e.width,n=e.canvas.clientHeight/e.height,a=0;a<4;a++)this._canvasCorners[a].set(t[a].x*i,(e.height-t[a].y)*n);return this._canvasCornersDirty=!1,this._canvasCorners}}),Object.defineProperty(hd.prototype,"worldCorners",{get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var e=this.screenCorners;if(!this.screen.screen.screenSpace){sd.copy(this.screen.screen._screenMatrix),sd.data[13]=-sd.data[13],sd.mul2(this.screen.getWorldTransform(),sd);for(var t=0;t<4;t++)sd.transformPoint(e[t],this._worldCorners[t])}}else{var i=this.entity.getLocalPosition();sd.setTranslate(-i.x,-i.y,-i.z),rd.setTRS(de.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),od.setTranslate(i.x,i.y,i.z);var n=this.entity.parent?this.entity.parent:this.entity;ld.copy(n.getWorldTransform()),ld.mul(od).mul(rd).mul(sd),nd.set(i.x-this.pivot.x*this.calculatedWidth,i.y-this.pivot.y*this.calculatedHeight,i.z),ld.transformPoint(nd,this._worldCorners[0]),nd.set(i.x+(1-this.pivot.x)*this.calculatedWidth,i.y-this.pivot.y*this.calculatedHeight,i.z),ld.transformPoint(nd,this._worldCorners[1]),nd.set(i.x+(1-this.pivot.x)*this.calculatedWidth,i.y+(1-this.pivot.y)*this.calculatedHeight,i.z),ld.transformPoint(nd,this._worldCorners[2]),nd.set(i.x-this.pivot.x*this.calculatedWidth,i.y+(1-this.pivot.y)*this.calculatedHeight,i.z),ld.transformPoint(nd,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}}),Object.defineProperty(hd.prototype,"textWidth",{get:function(){return this._text?this._text.width:0}}),Object.defineProperty(hd.prototype,"textHeight",{get:function(){return this._text?this._text.height:0}}),Object.defineProperty(hd.prototype,"useInput",{get:function(){return this._useInput},set:function(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e))}}),Object.defineProperty(hd.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(e){this._batchGroupId!==e&&(this.entity.enabled&&0<=this._batchGroupId&&this.system.app.batcher.remove(Cn.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&0<=e&&this.system.app.batcher.insert(Cn.ELEMENT,e,this.entity),e<0&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e)}}),Object.defineProperty(hd.prototype,"maskedBy",{get:function(){return this._maskedBy}});var cd=function(t){Object.defineProperty(hd.prototype,t,{get:function(){return this._text?this._text[t]:this._image?this._image[t]:null},set:function(e){this._text?this._text[t]=e:this._image&&(this._image[t]=e)}})};cd("fontSize"),cd("minFontSize"),cd("maxFontSize"),cd("maxLines"),cd("autoFitWidth"),cd("autoFitHeight"),cd("color"),cd("font"),cd("fontAsset"),cd("spacing"),cd("lineHeight"),cd("wrapLines"),cd("lines"),cd("alignment"),cd("autoWidth"),cd("autoHeight"),cd("rtlReorder"),cd("unicodeConverter"),cd("text"),cd("key"),cd("texture"),cd("textureAsset"),cd("material"),cd("materialAsset"),cd("sprite"),cd("spriteAsset"),cd("spriteFrame"),cd("pixelsPerUnit"),cd("opacity"),cd("rect"),cd("mask"),cd("outlineColor"),cd("outlineThickness"),cd("shadowColor"),cd("shadowOffset"),cd("enableMarkup"),cd("rangeStart"),cd("rangeEnd");var ud=function(){this.enabled=!0},dd=["enabled"],pd=function(h){function e(e){var t;(t=h.call(this,e)||this).id="element",t.ComponentType=hd,t.DataType=ud,t.schema=dd,t._unicodeConverter=null,t._rtlReorder=null,t._defaultTexture=new Kt(e.graphicsDevice,{width:1,height:1,format:7}),t._defaultTexture.name="element-system";var i=t._defaultTexture.lock(),n=new Uint8Array(4);return n[0]=255,n[1]=255,n[2]=255,n[3]=255,i.set(n),t._defaultTexture.unlock(),t.defaultImageMaterial=null,t.defaultImage9SlicedMaterial=null,t.defaultImage9TiledMaterial=null,t.defaultImageMaskMaterial=null,t.defaultImage9SlicedMaskMaterial=null,t.defaultImage9TiledMaskMaterial=null,t.defaultScreenSpaceImageMaterial=null,t.defaultScreenSpaceImage9SlicedMaterial=null,t.defaultScreenSpaceImage9TiledMaterial=null,t.defaultScreenSpaceImageMask9SlicedMaterial=null,t.defaultScreenSpaceImageMask9TiledMaterial=null,t.defaultScreenSpaceImageMaskMaterial=null,t.defaultTextMaterial=null,t.defaultBitmapTextMaterial=null,t.defaultScreenSpaceTextMaterial=null,t.defaultScreenSpaceBitmapTextMaterial=null,t.defaultImageMaterials=[],t.on("beforeremove",t.onRemoveComponent,g(t)),t}u(e,h);var t=e.prototype;return t.destroy=function(){this._defaultTexture.destroy()},t.initializeComponentData=function(e,t,i){e._beingInitialized=!0,void 0!==t.anchor&&(t.anchor instanceof ee?e.anchor.copy(t.anchor):e.anchor.set(t.anchor[0],t.anchor[1],t.anchor[2],t.anchor[3])),void 0!==t.pivot&&(t.pivot instanceof J?e.pivot.copy(t.pivot):e.pivot.set(t.pivot[0],t.pivot[1]));var n,a=.001<Math.abs(e.anchor.x-e.anchor.z),s=.001<Math.abs(e.anchor.y-e.anchor.w),r=!1;void 0!==t.margin&&(t.margin instanceof ee?e.margin.copy(t.margin):e._margin.set(t.margin[0],t.margin[1],t.margin[2],t.margin[3]),r=!0),void 0!==t.left&&(e._margin.x=t.left,r=!0),void 0!==t.bottom&&(e._margin.y=t.bottom,r=!0),void 0!==t.right&&(e._margin.z=t.right,r=!0),void 0!==t.top&&(e._margin.w=t.top,r=!0),r&&(e.margin=e._margin);var o=!1;void 0===t.width||a?a&&(o=!0):e.width=t.width,void 0===t.height||s?s&&(o=!0):e.height=t.height,o&&(e.anchor=e.anchor),void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.useInput&&(e.useInput=t.useInput),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),void 0!==t.type&&(e.type=t.type),e.type===ku?(void 0!==t.rect&&(e.rect=t.rect),void 0!==t.color&&((n=t.color)instanceof $||(n=new $(t.color[0],t.color[1],t.color[2])),e.color=n),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.textureAsset&&(e.textureAsset=t.textureAsset),t.texture&&(e.texture=t.texture),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.spriteFrame&&(e.spriteFrame=t.spriteFrame),void 0!==t.pixelsPerUnit&&null!==t.pixelsPerUnit&&(e.pixelsPerUnit=t.pixelsPerUnit),void 0!==t.materialAsset&&(e.materialAsset=t.materialAsset),t.material&&(e.material=t.material),void 0!==t.mask&&(e.mask=t.mask)):e.type===Lu&&(void 0!==t.autoWidth&&(e.autoWidth=t.autoWidth),void 0!==t.autoHeight&&(e.autoHeight=t.autoHeight),void 0!==t.rtlReorder&&(e.rtlReorder=t.rtlReorder),void 0!==t.unicodeConverter&&(e.unicodeConverter=t.unicodeConverter),null!==t.text&&void 0!==t.text?e.text=t.text:null!==t.key&&void 0!==t.key&&(e.key=t.key),void 0!==t.color&&((n=t.color)instanceof $||(n=new $(n[0],n[1],n[2])),e.color=n),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.spacing&&(e.spacing=t.spacing),void 0!==t.fontSize&&(e.fontSize=t.fontSize,t.lineHeight||(e.lineHeight=t.fontSize)),void 0!==t.lineHeight&&(e.lineHeight=t.lineHeight),void 0!==t.maxLines&&(e.maxLines=t.maxLines),void 0!==t.wrapLines&&(e.wrapLines=t.wrapLines),void 0!==t.minFontSize&&(e.minFontSize=t.minFontSize),void 0!==t.maxFontSize&&(e.maxFontSize=t.maxFontSize),t.autoFitWidth&&(e.autoFitWidth=t.autoFitWidth),t.autoFitHeight&&(e.autoFitHeight=t.autoFitHeight),void 0!==t.fontAsset&&(e.fontAsset=t.fontAsset),void 0!==t.font&&(e.font=t.font),void 0!==t.alignment&&(e.alignment=t.alignment),void 0!==t.outlineColor&&(e.outlineColor=t.outlineColor),void 0!==t.outlineThickness&&(e.outlineThickness=t.outlineThickness),void 0!==t.shadowColor&&(e.shadowColor=t.shadowColor),void 0!==t.shadowOffset&&(e.shadowOffset=t.shadowOffset),void 0!==t.enableMarkup&&(e.enableMarkup=t.enableMarkup));var l=e._parseUpToScreen();l.screen&&e._updateScreen(l.screen),h.prototype.initializeComponentData.call(this,e,t,i),e._beingInitialized=!1,e.type===ku&&e._image._meshDirty&&e._image._updateMesh(e._image.mesh)},t.onRemoveComponent=function(e,t){t.onRemove()},t.cloneComponent=function(e,t){var i=e.element,n={enabled:i.enabled,width:i.width,height:i.height,anchor:i.anchor.clone(),pivot:i.pivot.clone(),margin:i.margin.clone(),alignment:i.alignment&&i.alignment.clone()||i.alignment,autoWidth:i.autoWidth,autoHeight:i.autoHeight,type:i.type,rect:i.rect&&i.rect.clone()||i.rect,rtlReorder:i.rtlReorder,unicodeConverter:i.unicodeConverter,materialAsset:i.materialAsset,material:i.material,color:i.color&&i.color.clone()||i.color,opacity:i.opacity,textureAsset:i.textureAsset,texture:i.texture,spriteAsset:i.spriteAsset,sprite:i.sprite,spriteFrame:i.spriteFrame,pixelsPerUnit:i.pixelsPerUnit,spacing:i.spacing,lineHeight:i.lineHeight,wrapLines:i.wrapLines,layers:i.layers,fontSize:i.fontSize,minFontSize:i.minFontSize,maxFontSize:i.maxFontSize,autoFitWidth:i.autoFitWidth,autoFitHeight:i.autoFitHeight,maxLines:i.maxLines,fontAsset:i.fontAsset,font:i.font,useInput:i.useInput,batchGroupId:i.batchGroupId,mask:i.mask,outlineColor:i.outlineColor&&i.outlineColor.clone()||i.outlineColor,outlineThickness:i.outlineThickness,shadowColor:i.shadowColor&&i.shadowColor.clone()||i.shadowColor,shadowOffset:i.shadowOffset&&i.shadowOffset.clone()||i.shadowOffset,enableMarkup:i.enableMarkup};return void 0!==i.key&&null!==i.key?n.key=i.key:n.text=i.text,this.addComponent(t,n)},t.getTextElementMaterial=function(e,t){return e?t?(this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new gm,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=4,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial):(this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new gm,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=4,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update()),this.defaultScreenSpaceBitmapTextMaterial):t?(this.defaultTextMaterial||(this.defaultTextMaterial=new gm,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=4,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial):(this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new gm,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=4,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update()),this.defaultBitmapTextMaterial)},t._createBaseImageMaterial=function(){var e=new gm;return e.diffuse.set(0,0,0),e.emissive.set(.5,.5,.5),e.emissiveMap=this._defaultTexture,e.emissiveTint=!0,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.opacityTint=!0,e.opacity=0,e.useLighting=!1,e.useGammaTonemap=!1,e.useFog=!1,e.useSkybox=!1,e.blendType=4,e.depthWrite=!1,e},t.getImageElementMaterial=function(e,t,i,n){return e?t?i?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):n?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):i?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):n?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):t?i?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):n?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):i?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):n?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)},t.registerUnicodeConverter=function(e){this._unicodeConverter=e},t.registerRtlReorder=function(e){this._rtlReorder=e},t.getUnicodeConverter=function(){return this._unicodeConverter},t.getRtlReorder=function(){return this._rtlReorder},e}(qh);Xh._buildAccessors(hd.prototype,dd);var fd="free",md="limited",vd="locked",gd=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"],_d=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._constraint=null,i._entityA=null,i._entityB=null,i._breakForce=34e37,i._enableCollision=!0,i._linearMotionX=vd,i._linearLimitsX=new J(0,0),i._linearSpringX=!1,i._linearStiffnessX=0,i._linearDampingX=1,i._linearEquilibriumX=0,i._linearMotionY=vd,i._linearLimitsY=new J(0,0),i._linearSpringY=!1,i._linearStiffnessY=0,i._linearDampingY=1,i._linearEquilibriumY=0,i._linearMotionZ=vd,i._linearLimitsZ=new J(0,0),i._linearSpringZ=!1,i._linearStiffnessZ=0,i._linearDampingZ=1,i._linearEquilibriumZ=0,i._angularMotionX=vd,i._angularLimitsX=new J(0,0),i._angularSpringX=!1,i._angularStiffnessX=0,i._angularDampingX=1,i._angularEquilibriumX=0,i._angularMotionY=vd,i._angularLimitsY=new J(0,0),i._angularSpringY=!1,i._angularStiffnessY=0,i._angularDampingY=1,i._angularEquilibriumY=0,i._angularMotionZ=vd,i._angularLimitsZ=new J(0,0),i._angularSpringZ=!1,i._angularEquilibriumZ=0,i._angularDampingZ=1,i._angularStiffnessZ=0,i.on("set_enabled",i._onSetEnabled,g(i)),i}u(e,n);var t=e.prototype;return t._convertTransform=function(e,t){var i=e.getTranslation(),n=new fe;n.setFromMat4(e);var a=new Ammo.btVector3(i.x,i.y,i.z),s=new Ammo.btQuaternion(n.x,n.y,n.z,n.w);t.setOrigin(a),t.setRotation(s),Ammo.destroy(a),Ammo.destroy(s)},t._updateAngularLimits=function(){var e=this._constraint;if(e){var t,i,n,a,s,r;this._angularMotionX===md?(t=this._angularLimitsX.x*Se.DEG_TO_RAD,a=this._angularLimitsX.y*Se.DEG_TO_RAD):this._angularMotionX===fd?(t=1,a=0):t=a=0,this._angularMotionY===md?(i=this._angularLimitsY.x*Se.DEG_TO_RAD,s=this._angularLimitsY.y*Se.DEG_TO_RAD):this._angularMotionY===fd?(i=1,s=0):i=s=0,this._angularMotionZ===md?(n=this._angularLimitsZ.x*Se.DEG_TO_RAD,r=this._angularLimitsZ.y*Se.DEG_TO_RAD):this._angularMotionZ===fd?(n=1,r=0):n=r=0;var o=new Ammo.btVector3(t,i,n);e.setAngularLowerLimit(o),o.setValue(a,s,r),e.setAngularUpperLimit(o),Ammo.destroy(o)}},t._updateLinearLimits=function(){var e=this._constraint;if(e){var t,i,n,a,s,r;this._linearMotionX===md?(t=this._linearLimitsX.x,a=this._linearLimitsX.y):this._linearMotionX===fd?(t=1,a=0):t=a=0,this._linearMotionY===md?(i=this._linearLimitsY.x,s=this._linearLimitsY.y):this._linearMotionY===fd?(i=1,s=0):i=s=0,this._linearMotionZ===md?(n=this._linearLimitsZ.x,r=this._linearLimitsZ.y):this._linearMotionZ===fd?(n=1,r=0):n=r=0;var o=new Ammo.btVector3(t,i,n);e.setLinearLowerLimit(o),o.setValue(a,s,r),e.setLinearUpperLimit(o),Ammo.destroy(o)}},t._createConstraint=function(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();var e=new pe,t=this._entityA.rigidbody.body;t.activate();var i=this.entity.getWorldTransform(),n=this._entityA.getWorldTransform().clone().invert();e.mul2(n,i);var a=new Ammo.btTransform;if(this._convertTransform(e,a),this._entityB&&this._entityB.rigidbody){var s=this._entityB.rigidbody.body;s.activate();var r=this._entityB.getWorldTransform().clone().invert();e.mul2(r,i);var o=new Ammo.btTransform;this._convertTransform(e,o),this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,s,a,o,!this._enableCollision),Ammo.destroy(o)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,a,!this._enableCollision);Ammo.destroy(a);for(var l=["X","Y","Z","X","Y","Z"],h=0;h<6;h++){var c=h<3?"_linear":"_angular";this._constraint.enableSpring(h,this[c+"Spring"+l[h]]),this._constraint.setDamping(h,this[c+"Damping"+l[h]]),this._constraint.setEquilibriumPoint(h,this[c+"Equilibrium"+l[h]]),this._constraint.setStiffness(h,this[c+"Stiffness"+l[h]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}},t._destroyConstraint=function(){this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null)},t.initFromData=function(e){for(var t,i=_(gd);!(t=i()).done;){var n=t.value;e.hasOwnProperty(n)&&(e[n]instanceof J?this["_"+n].copy(e[n]):this["_"+n]=e[n])}this._createConstraint()},t.onEnable=function(){this._createConstraint()},t.onDisable=function(){this._destroyConstraint()},t._onSetEnabled=function(e,t,i){},t._onBeforeRemove=function(){this.fire("remove")},c(e,[{key:"entityA",get:function(){return this._entityA},set:function(e){this._destroyConstraint(),this._entityA=e,this._createConstraint()}},{key:"entityB",get:function(){return this._entityB},set:function(e){this._destroyConstraint(),this._entityB=e,this._createConstraint()}},{key:"breakForce",get:function(){return this._breakForce},set:function(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e)}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint()}},{key:"angularLimitsX",get:function(){return this._angularLimitsX},set:function(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits())}},{key:"angularMotionX",get:function(){return this._angularMotionX},set:function(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits())}},{key:"angularLimitsY",get:function(){return this._angularLimitsY},set:function(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits())}},{key:"angularMotionY",get:function(){return this._angularMotionY},set:function(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits())}},{key:"angularLimitsZ",get:function(){return this._angularLimitsZ},set:function(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits())}},{key:"angularMotionZ",get:function(){return this._angularMotionZ},set:function(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits())}},{key:"linearLimitsX",get:function(){return this._linearLimitsX},set:function(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits())}},{key:"linearMotionX",get:function(){return this._linearMotionX},set:function(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits())}},{key:"linearLimitsY",get:function(){return this._linearLimitsY},set:function(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits())}},{key:"linearMotionY",get:function(){return this._linearMotionY},set:function(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits())}},{key:"linearLimitsZ",get:function(){return this._linearLimitsZ},set:function(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits())}},{key:"linearMotionZ",get:function(){return this._linearMotionZ},set:function(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits())}}]),e}(Xh),yd={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach(function(s){["Damping","Equilibrium","Spring","Stiffness"].forEach(function(a){["X","Y","Z"].forEach(function(e){var t=s+a+e,i="_"+t,n="linear"===s?0:3;"Y"===e&&(n+=1),"Z"===e&&(n+=2),Object.defineProperty(_d.prototype,t,{get:function(){return this[i]},set:function(e){this[i]!==e&&(this[i]=e,this._constraint[yd[a]](n,e))}})})})});var bd=function(){this.enabled=!0},xd=["enabled"],Md=function(i){function e(e){var t;return(t=i.call(this,e)||this).id="joint",t.app=e,t.ComponentType=_d,t.DataType=bd,t.schema=xd,t}return u(e,i),e.prototype.initializeComponentData=function(e,t,i){e.initFromData(t)},e}(qh);Xh._buildAccessors(_d.prototype,xd);var Sd=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._minWidth=0,i._minHeight=0,i._maxWidth=null,i._maxHeight=null,i._fitWidthProportion=0,i._fitHeightProportion=0,i._excludeFromLayout=!1,i}return u(e,n),e}(Xh);function wd(e){var t="_"+e;Object.defineProperty(Sd.prototype,e,{get:function(){return this[t]},set:function(e){this[t]!==e&&(this[t]=e,this.fire("resize"))}})}wd("minWidth"),wd("minHeight"),wd("maxWidth"),wd("maxHeight"),wd("fitWidthProportion"),wd("fitHeightProportion"),wd("excludeFromLayout");var Cd=function(){this.enabled=!0},Pd=["enabled"],Td=function(n){function e(e){var t;return(t=n.call(this,e)||this).id="layoutchild",t.ComponentType=Sd,t.DataType=Cd,t.schema=Pd,t}u(e,n);var t=e.prototype;return t.initializeComponentData=function(e,t,i){void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.minWidth&&(e.minWidth=t.minWidth),void 0!==t.minHeight&&(e.minHeight=t.minHeight),void 0!==t.maxWidth&&(e.maxWidth=t.maxWidth),void 0!==t.maxHeight&&(e.maxHeight=t.maxHeight),void 0!==t.fitWidthProportion&&(e.fitWidthProportion=t.fitWidthProportion),void 0!==t.fitHeightProportion&&(e.fitHeightProportion=t.fitHeightProportion),void 0!==t.excludeFromLayout&&(e.excludeFromLayout=t.excludeFromLayout),n.prototype.initializeComponentData.call(this,e,t,i)},t.cloneComponent=function(e,t){var i=e.layoutchild;return this.addComponent(t,{enabled:i.enabled,minWidth:i.minWidth,minHeight:i.minHeight,maxWidth:i.maxWidth,maxHeight:i.maxHeight,fitWidthProportion:i.fitWidthProportion,fitHeightProportion:i.fitHeightProportion,excludeFromLayout:i.excludeFromLayout})},e}(qh);Xh._buildAccessors(Sd.prototype,Pd);var Ad={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},Ed={0:1,1:0},Rd={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},Dd="NONE",Id="APPLY_STRETCHING",kd="APPLY_SHRINKING",Ld=new J;function Od(e){var m,v=Ad[e],g=Ad[Ed[e]];function p(e,t){return-t[g.size]*e.pivot[g.axis]}function c(e){var t=e.entity.layoutchild;return!t||!t.enabled||!t.excludeFromLayout}function f(e,t,i){switch(e){case 0:return Dd;case 1:return t<i?Id:Dd;case 2:return i<=t?kd:Dd;case 3:return t<i?Id:i<=t?kd:Dd;default:throw new Error("Unrecognized fitting mode: "+e)}}function _(e,t){return r(e,t.size)+(e.length-1)*m.spacing[t.axis]}function y(e,t,i){for(var n=w(e,i.maxSize),a=S(e,i.fittingProportion),s=C(a,n),r=Ld[i.axis]-t,o=0;o<e.length;++o){var l=n[o],h=x(l,r,a,s),c=e[l][i.size]+h,u=e[l][i.maxSize],d=Math.min(c,u);e[l][i.size]=d,r-=h-Math.max(c-d,0)}}function b(e,t,i){for(var n=w(e,i.minSize,!0),a=function(e){if(1===e.length)return[1];for(var t=[],i=e.length,n=0;n<i;++n)t.push((1-e[n])/(i-1));return t}(S(e,i.fittingProportion)),s=C(a,n),r=t-Ld[i.axis],o=0;o<e.length;++o){var l=n[o],h=x(l,r,a,s),c=e[l][i.size]-h,u=e[l][i.minSize],d=Math.max(c,u);e[l][i.size]=d,r-=h-Math.max(d-c,0)}}function x(e,t,i,n){var a=i[e],s=n[e];return Math.abs(a)<1e-5&&Math.abs(s)<1e-5?t:t*a/s}function u(e){for(var t=[],i=0;i<e.length;++i){var n=e[i],a=Math.max(d(n,"minWidth"),0),s=Math.max(d(n,"minHeight"),0),r=Math.max(d(n,"maxWidth"),a),o=Math.max(d(n,"maxHeight"),s),l=M(d(n,"width"),a,r),h=M(d(n,"height"),s,o),c=d(n,"fitWidthProportion"),u=d(n,"fitHeightProportion");t.push({minWidth:a,minHeight:s,maxWidth:r,maxHeight:o,width:l,height:h,fitWidthProportion:c,fitHeightProportion:u})}return t}function d(e,t){var i=e.entity.layoutchild;return i&&i.enabled&&void 0!==i[t]&&null!==i[t]?i[t]:void 0!==e[t]?e[t]:Rd[t]}function M(e,t,i){return Math.min(Math.max(e,t),i)}function r(e,i){return e.reduce(function(e,t){return e+t[i]},0)}function S(e,t){var i,n=r(e,t),a=[],s=e.length;if(0===n)for(i=0;i<s;++i)a.push(1/s);else for(i=0;i<s;++i)a.push(e[i][t]/n);return a}function w(e,i,n){return e.forEach(t),e.slice().sort(function(e,t){return n?t[i]-e[i]:e[i]-t[i]}).map(a)}function t(e,t){e.index=t}function a(e){return e.index}function C(e,t){var i=[];i[t[e.length-1]]=e[t[e.length-1]];for(var n=e.length-2;0<=n;--n)i[t[n]]=i[t[n+1]]+e[t[n]];return i}return function(e,t){e=e.filter(c),m=t,Ld.x=m.containerSize.x-m.padding.x-m.padding.z,Ld.y=m.containerSize.y-m.padding.y-m.padding.w,function(e){for(var t=0;t<e.length;++t){var i=e[t],n=i.anchor;0===n.x&&0===n.y&&0===n.z&&0===n.w||(i.anchor=ee.ZERO)}}(e);var i,n,a,s,r,o=function(e){var t=0===m.orientation&&m.reverseX||1===m.orientation&&m.reverseY,i=0===m.orientation&&m.reverseY||1===m.orientation&&m.reverseX;if(t)for(var n=0;n<e.length;++n)t&&e[n].reverse();return i&&e.reverse(),e}(function(e){if(!m.wrap)return[e];for(var t=[[]],i=u(e),n=0,a=2===m[v.fitting],s=0;s<e.length;++s){0<t[t.length-1].length&&(n+=m.spacing[v.axis]);var r=i[s][v.size];n+=r,!a&&n>Ld[v.axis]&&0!==t[t.length-1].length&&(n=r,t.push([])),t[t.length-1].push(e[s]),a&&n>Ld[v.axis]&&s!==e.length-1&&(n=0,t.push([]))}return t}(e)),l=function(e,t){var i,n,a,s=[],r=[];for(n=0;n<e.length;++n){for((a=e[n]).largestElement=null,a.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY},i=0;i<a.length;++i){var o=t[n][i];o[g.size]>a.largestSize[g.size]&&(a.largestElement=a[i],a.largestSize=o)}s.push(a.largestElement),r.push(a.largestSize)}var l=_(r,g),h=f(m[g.fitting],l,Ld[g.axis]);for(h===Id?y(r,l,g):h===kd&&b(r,l,g),n=0;n<e.length;++n)for(a=e[n],i=0;i<a.length;++i){var c=t[n][i],u=c[g.size],d=1===e.length?Ld[g.axis]:a.largestSize[g.size],p=f(m[g.fitting],u,d);p===Id?c[g.size]=Math.min(d,c[g.maxSize]):p===kd&&(c[g.size]=Math.max(d,c[g.minSize]))}return t}(o,function(e){for(var t=[],i=0;i<e.length;++i){var n=u(e[i]),a=_(n,v),s=f(m[v.fitting],a,Ld[v.axis]);s===Id?y(n,a,v):s===kd&&b(n,a,v),t.push(n)}return t}(o)),h=function(e,t){var i,n,a={};a[v.axis]=0,a[g.axis]=0,e[v.size]=Number.NEGATIVE_INFINITY;for(var s=[],r=0;r<e.length;++r){var o=e[r];if(0===o.length)return;for(var l=[],h=t[r],c=0;c<o.length;++c){var u=o[c],d=h[c];a[g.axis]-=p(u,d),a[v.axis]-=(n=u,-d[v.size]*n.pivot[v.axis]),l[c]={},l[c][v.axis]=a[v.axis],l[c][g.axis]=a[g.axis],a[g.axis]+=p(u,d),a[v.axis]+=(i=u,d[v.size]*(1-i.pivot[v.axis])+m.spacing[v.axis])}o[v.size]=a[v.axis]-m.spacing[v.axis],o[g.size]=o.largestSize[g.size],e[v.size]=Math.max(e[v.size],o[v.size]),a[v.axis]=0,a[g.axis]+=o[g.size]+m.spacing[g.axis],s.push(l)}return e[g.size]=a[g.axis]-m.spacing[g.axis],s}(o,l);return function(e,t,i){for(var n=m.alignment[v.axis],a=m.alignment[g.axis],s=m.padding[v.axis],r=m.padding[g.axis],o=0;o<e.length;++o)for(var l=e[o],h=t[o],c=i[o],u=(Ld[v.axis]-l[v.size])*n+s,d=(Ld[g.axis]-e[g.size])*a+r,p=0;p<l.length;++p){var f=(l[g.size]-h[p][g.size])*m.alignment[g.axis];c[p][v.axis]+=u,c[p][g.axis]+=d+f}}(o,l,h),function(e,t,i){for(var n=0;n<e.length;++n)for(var a=e[n],s=t[n],r=i[n],o=0;o<a.length;++o){var l=a[o];l[v.calculatedSize]=s[o][v.size],l[g.calculatedSize]=s[o][g.size],0===m.orientation?l.entity.setLocalPosition(r[o][v.axis],r[o][g.axis],l.entity.getLocalPosition().z):l.entity.setLocalPosition(r[o][g.axis],r[o][v.axis],l.entity.getLocalPosition().z)}}(o,l,h),n=(i=o).width,a=i.height,s=(Ld.x-n)*m.alignment.x+m.padding.x,r=(Ld.y-a)*m.alignment.y+m.padding.y,{bounds:new ee(s,r,n,a)}}}var Fd={};Fd[0]=Od(0),Fd[1]=Od(1);var zd=function(){function e(){}return e.prototype.calculateLayout=function(e,t){var i=Fd[t.orientation];if(i)return i(e,t);throw new Error("Unrecognized orientation value: "+t.orientation)},e}();function Bd(e){return e.element}function Vd(e){return e.enabled&&e.element&&e.element.enabled}var Ud=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._orientation=0,i._reverseX=!1,i._reverseY=!0,i._alignment=new J(0,1),i._padding=new ee,i._spacing=new J,i._widthFitting=0,i._heightFitting=0,i._wrap=!1,i._layoutCalculator=new zd,i._listenForReflowEvents(i.entity,"on"),i.entity.children.forEach(function(e){this._listenForReflowEvents(e,"on")}.bind(g(i))),i.entity.on("childinsert",i._onChildInsert,g(i)),i.entity.on("childremove",i._onChildRemove,g(i)),e.app.systems.element.on("add",i._onElementOrLayoutComponentAdd,g(i)),e.app.systems.element.on("beforeremove",i._onElementOrLayoutComponentRemove,g(i)),e.app.systems.layoutchild.on("add",i._onElementOrLayoutComponentAdd,g(i)),e.app.systems.layoutchild.on("beforeremove",i._onElementOrLayoutComponentRemove,g(i)),i}u(e,n);var t=e.prototype;return t._isSelfOrChild=function(e){return e===this.entity||-1!==this.entity.children.indexOf(e)},t._listenForReflowEvents=function(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this))},t._onElementOrLayoutComponentAdd=function(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow())},t._onElementOrLayoutComponentRemove=function(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow())},t._onChildInsert=function(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow()},t._onChildRemove=function(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow()},t._scheduleReflow=function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)},t.reflow=function(){var e=Bd(this.entity),t=this.entity.children.filter(Vd).map(Bd);if(e&&0!==t.length){var i=Math.max(e.calculatedWidth,0),n=Math.max(e.calculatedHeight,0),a={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new J(i,n)};this._isPerformingReflow=!0;var s=this._layoutCalculator.calculateLayout(t,a);this._isPerformingReflow=!1,this.fire("reflow",s)}},t.onEnable=function(){this._scheduleReflow()},t.onRemove=function(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(function(e){this._listenForReflowEvents(e,"off")}.bind(this)),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)},e}(Xh);function Nd(e){var t="_"+e;Object.defineProperty(Ud.prototype,e,{get:function(){return this[t]},set:function(e){this[t]!==e&&(this[t]=e,this._scheduleReflow())}})}Nd("orientation"),Nd("reverseX"),Nd("reverseY"),Nd("alignment"),Nd("padding"),Nd("spacing"),Nd("widthFitting"),Nd("heightFitting"),Nd("wrap");var Gd=function(){this.enabled=!0},Wd=["enabled"],Hd=function(n){function e(e){var t;return(t=n.call(this,e)||this).id="layoutgroup",t.ComponentType=Ud,t.DataType=Gd,t.schema=Wd,t._reflowQueue=[],t.on("beforeremove",t._onRemoveComponent,g(t)),qh.bind("postUpdate",t._onPostUpdate,g(t)),t}u(e,n);var t=e.prototype;return t.initializeComponentData=function(e,t,i){void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.orientation&&(e.orientation=t.orientation),void 0!==t.reverseX&&(e.reverseX=t.reverseX),void 0!==t.reverseY&&(e.reverseY=t.reverseY),void 0!==t.alignment&&(t.alignment instanceof J?e.alignment.copy(t.alignment):e.alignment.set(t.alignment[0],t.alignment[1]),e.alignment=e.alignment),void 0!==t.padding&&(t.padding instanceof ee?e.padding.copy(t.padding):e.padding.set(t.padding[0],t.padding[1],t.padding[2],t.padding[3]),e.padding=e.padding),void 0!==t.spacing&&(t.spacing instanceof J?e.spacing.copy(t.spacing):e.spacing.set(t.spacing[0],t.spacing[1]),e.spacing=e.spacing),void 0!==t.widthFitting&&(e.widthFitting=t.widthFitting),void 0!==t.heightFitting&&(e.heightFitting=t.heightFitting),void 0!==t.wrap&&(e.wrap=t.wrap),n.prototype.initializeComponentData.call(this,e,t,i)},t.cloneComponent=function(e,t){var i=e.layoutgroup;return this.addComponent(t,{enabled:i.enabled,orientation:i.orientation,reverseX:i.reverseX,reverseY:i.reverseY,alignment:i.alignment,padding:i.padding,spacing:i.spacing,widthFitting:i.widthFitting,heightFitting:i.heightFitting,wrap:i.wrap})},t.scheduleReflow=function(e){-1===this._reflowQueue.indexOf(e)&&this._reflowQueue.push(e)},t._onPostUpdate=function(){this._processReflowQueue()},t._processReflowQueue=function(){if(0!==this._reflowQueue.length)for(var e=0;0<this._reflowQueue.length;){var t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort(function(e,t){return e.entity.graphDepth-t.entity.graphDepth});for(var i=0;i<t.length;++i)t[i].reflow();if(100<=++e)break}},t._onRemoveComponent=function(e,t){t.onRemove()},e}(qh);Xh._buildAccessors(Ud.prototype,Wd);var jd=new de,Xd=new de,qd=new de,$d={r:0,g:1,b:2,a:3},Yd=[[new ee(0,0,1,1)],[new ee(0,0,.5,.5),new ee(0,.5,.5,.5)],[new ee(0,0,.5,.5),new ee(0,.5,.5,.5),new ee(.5,0,.5,.5)],[new ee(0,0,.5,.5),new ee(0,.5,.5,.5),new ee(.5,0,.5,.5),new ee(.5,.5,.5,.5)]],Kd=function(){function e(e,t,i,n){this.light=n,this.camera=t,this.shadowCamera=na.createShadowCamera(e,n._shadowType,n._type,i),this.shadowMatrix=new pe,this.face=i,this.visibleCasters=[]}return c(e,[{key:"shadowBuffer",get:function(){var e=this.shadowCamera.renderTarget;if(e){var t=this.light;return 1===t._type?e.colorBuffer:t._isPcf&&t.device.webgl2?e.depthBuffer:e.colorBuffer}return null}}]),e}(),Zd=function(){function t(e){this.device=e,this._type=0,this._color=new $(.8,.8,.8),this._intensity=1,this._castShadows=!1,this._enabled=!1,this.mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=0,this._finalColor=new Float32Array([.8,.8,.8]);var t=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([t,t,t]),this._position=new de(0,0,0),this._direction=new de(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowMap=null,this._shadowRenderParams=[],this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=2,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._scene=null,this._node=null,this._renderData=[],this.visibleThisFrame=!1}var e=t.prototype;return e.destroy=function(){this._destroyShadowMap(),this._renderData=null},e._destroyShadowMap=function(){this._renderData&&(this._renderData.length=0),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)},e.getRenderData=function(e,t){for(var i=0;i<this._renderData.length;i++){var n=this._renderData[i];if(n.camera===e&&n.face===t)return n}var a=new Kd(this.device,e,t,this);return this._renderData.push(a),a},e.clone=function(){var e=new t(this.device);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.shape=this._shape,e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e},e.getColor=function(){return this._color},e.getBoundingSphere=function(e){if(2===this._type){var t=this.attenuationEnd,i=this._outerConeAngle,n=Math.cos(i*Se.DEG_TO_RAD),a=this._node;jd.copy(a.up),jd.mulScalar(.5*-t*n),jd.add(a.getPosition()),e.center=jd,Xd.copy(a.up),Xd.mulScalar(-t),qd.copy(a.right),qd.mulScalar(Math.sin(i*Se.DEG_TO_RAD)*t),Xd.add(qd),e.radius=.5*Xd.length()}else 1===this._type&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)},e.getBoundingBox=function(e){if(2===this._type){var t=this.attenuationEnd,i=this._outerConeAngle,n=this._node,a=Math.abs(Math.sin(i*Se.DEG_TO_RAD)*t);e.center.set(0,.5*-t,0),e.halfExtents.set(a,.5*t,a),e.setFromTransformedAabb(e,n.getWorldTransform())}else 1===this._type&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))},e._updateFinalColor=function(){var e=this._color,t=e.r,i=e.g,n=e.b,a=this._intensity,s=this._finalColor,r=this._linearFinalColor;s[0]=t*a,s[1]=i*a,s[2]=n*a,1<=a?(r[0]=Math.pow(t,2.2)*a,r[1]=Math.pow(i,2.2)*a,r[2]=Math.pow(n,2.2)*a):(r[0]=Math.pow(s[0],2.2),r[1]=Math.pow(s[1],2.2),r[2]=Math.pow(s[2],2.2))},e.setColor=function(){var e,t,i;1===arguments.length?(e=arguments[0].r,t=arguments[0].g,i=arguments[0].b):3===arguments.length&&(e=arguments[0],t=arguments[1],i=arguments[2]),this._color.set(e,t,i),this._updateFinalColor()},e.updateShadow=function(){2!==this.shadowUpdateMode&&(this.shadowUpdateMode=1)},e.layersDirty=function(){var e;null!=(e=this._scene)&&e.layers&&(this._scene.layers._dirtyLights=!0)},e.updateKey=function(){var e=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|$d[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8;3===this._cookieChannel.length&&(e|=$d[this._cookieChannel.charAt(1)]<<16,e|=$d[this._cookieChannel.charAt(2)]<<14),e!==this.key&&null!==this._scene&&this.layersDirty(),this.key=e},c(t,[{key:"numCascades",get:function(){return this.cascades.length},set:function(e){this.cascades&&this.numCascades==e||(this.cascades=Yd[e-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}},{key:"shadowMap",get:function(){return this._shadowMap},set:function(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e)}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e){this._type=e,this._destroyShadowMap(),this.updateKey();var t=this._shadowType;this._shadowType=null,this.shadowType=t}}},{key:"shape",get:function(){return this._shape},set:function(e){if(this._shape!==e){this._shape=e,this._destroyShadowMap(),this.updateKey();var t=this._shadowType;this._shadowType=null,this.shadowType=t}}},{key:"shadowType",get:function(){return this._shadowType},set:function(e){if(this._shadowType!==e){var t=this.device;1===this._type&&(e=0),4!==e||t.webgl2||(e=0),3!==e||t.textureFloatRenderable||(e=2),2!==e||t.textureHalfFloatRenderable||(e=1),this._isVsm=1<=e&&e<=3,this._isPcf=4===e||0===e,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this.layersDirty())}},{key:"castShadows",get:function(){return this._castShadows&&4!==this.mask&&0!==this.mask},set:function(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}},{key:"shadowResolution",get:function(){return this._shadowResolution},set:function(e){this._shadowResolution!==e&&(e=1===this._type?Math.min(e,this.device.maxCubeMapSize):Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap())}},{key:"vsmBlurSize",get:function(){return this._vsmBlurSize},set:function(e){this._vsmBlurSize!==e&&(e%2==0&&e++,this._vsmBlurSize=e)}},{key:"normalOffsetBias",get:function(){return this._normalOffsetBias},set:function(e){this._normalOffsetBias!==e&&((!this._normalOffsetBias&&e||this._normalOffsetBias&&!e)&&this.updateKey(),this._normalOffsetBias=e)}},{key:"falloffMode",get:function(){return this._falloffMode},set:function(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey())}},{key:"innerConeAngle",get:function(){return this._innerConeAngle},set:function(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180))}},{key:"outerConeAngle",get:function(){return this._outerConeAngle},set:function(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._outerConeAngleCos=Math.cos(e*Math.PI/180))}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity!==e&&(this._intensity=e,this._updateFinalColor())}},{key:"cookieMatrix",get:function(){return this._cookieMatrix||(this._cookieMatrix=new pe),this._cookieMatrix}},{key:"cookie",get:function(){return this._cookie},set:function(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}},{key:"cookieFalloff",get:function(){return this._cookieFalloff},set:function(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}},{key:"cookieChannel",get:function(){return this._cookieChannel},set:function(e){if(this._cookieChannel!==e){if(e.length<3)for(var t=e.charAt(e.length-1),i=3-e.length,n=0;n<i;n++)e+=t;this._cookieChannel=e,this.updateKey()}}},{key:"cookieTransform",get:function(){return this._cookieTransform},set:function(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new J,this._cookieOffsetSet=!1),this.updateKey())}},{key:"cookieOffset",get:function(){return this._cookieOffset},set:function(e){this._cookieOffset!==e&&((this._cookieTransformSet||e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new ee(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}}]),t}(),Qd=[],Jd=[],ep=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._cookieAsset=null,i._cookieAssetId=null,i._cookieAssetAdd=!1,i._cookieMatrix=null,i}u(e,n);var t=e.prototype;return t.addLightToLayers=function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.addLight(this)},t.removeLightFromLayers=function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.removeLight(this)},t.onLayersChanged=function(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){0<=this.layers.indexOf(e.id)&&this.enabled&&this.entity.enabled&&e.addLight(this)},t.onLayerRemoved=function(e){0<=this.layers.indexOf(e.id)&&e.removeLight(this)},t.refreshProperties=function(){for(var e,t=0;t<Qd.length;t++)this[e=Qd[t]]=this[e];this.enabled&&this.entity.enabled&&this.onEnable()},t.updateShadow=function(){this.light.updateShadow()},t.onCookieAssetSet=function(){var e=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(e=this._cookieAsset.loadFaces=!0),this._cookieAsset.resource&&!e||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()},t.onCookieAssetAdd=function(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))},t.onCookieAssetLoad=function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},t.onCookieAssetRemove=function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},t.onEnable=function(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()},t.onDisable=function(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()},t.onRemove=function(){this.onDisable(),this.light.destroy(),this.cookieAsset=null},e}(Xh);function tp(n,e,a,s){var t=ep.prototype;Qd.push(n),Jd.push(e),Object.defineProperty(t,n,{get:function(){return this.data[n]},set:function(e){var t=this.data,i=t[n];(s||i!==e)&&(t[n]=e,a&&a.call(this,e,i))},configurable:!0})}tp("enabled",!0,function(e,t){this.onSetEnabled(null,t,e)}),tp("light",null),tp("type","directional",function(e,t){this.system.changeType(this,t,e),this.refreshProperties()}),tp("color",new $(1,1,1),function(e,t){this.light.setColor(e)},!0),tp("intensity",1,function(e,t){this.light.intensity=e}),tp("shape",0,function(e,t){this.light.shape=e}),tp("castShadows",!1,function(e,t){this.light.castShadows=e}),tp("shadowDistance",40,function(e,t){this.light.shadowDistance=e}),tp("shadowResolution",1024,function(e,t){this.light.shadowResolution=e}),tp("shadowBias",.05,function(e,t){this.light.shadowBias=-.01*e}),tp("numCascades",1,function(e,t){this.light.numCascades=Se.clamp(Math.floor(e),1,4)}),tp("cascadeDistribution",.5,function(e,t){this.light.cascadeDistribution=Se.clamp(e,0,1)}),tp("normalOffsetBias",0,function(e,t){this.light.normalOffsetBias=e}),tp("range",10,function(e,t){this.light.attenuationEnd=e}),tp("innerConeAngle",40,function(e,t){this.light.innerConeAngle=e}),tp("outerConeAngle",45,function(e,t){this.light.outerConeAngle=e}),tp("falloffMode",0,function(e,t){this.light.falloffMode=e}),tp("shadowType",0,function(e,t){this.light.shadowType=e}),tp("vsmBlurSize",11,function(e,t){this.light.vsmBlurSize=e}),tp("vsmBlurMode",1,function(e,t){this.light.vsmBlurMode=e}),tp("vsmBias",.0025,function(e,t){this.light.vsmBias=e}),tp("cookieAsset",null,function(e,t){if(!this._cookieAssetId||!(e instanceof Kr&&e.id===this._cookieAssetId||e===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,e instanceof Kr)this.data.cookieAsset=e.id,this._cookieAssetId=e.id,this.onCookieAssetAdd(e);else if("number"==typeof e){this._cookieAssetId=e;var i=this.system.app.assets.get(e);i?this.onCookieAssetAdd(i):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}}),tp("cookie",null,function(e,t){this.light.cookie=e}),tp("cookieIntensity",1,function(e,t){this.light.cookieIntensity=e}),tp("cookieFalloff",!0,function(e,t){this.light.cookieFalloff=e}),tp("cookieChannel","rgb",function(e,t){this.light.cookieChannel=e}),tp("cookieAngle",0,function(e,t){if(0!==e||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new ee);var i=1,n=1;this.cookieScale&&(i=this.cookieScale.x,n=this.cookieScale.y);var a=Math.cos(e*Se.DEG_TO_RAD),s=Math.sin(e*Se.DEG_TO_RAD);this._cookieMatrix.set(a/i,-s/i,s/n,a/n),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),tp("cookieScale",null,function(e,t){if(null!==e||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new ee);var i=e.x,n=e.y,a=Math.cos(this.cookieAngle*Se.DEG_TO_RAD),s=Math.sin(this.cookieAngle*Se.DEG_TO_RAD);this._cookieMatrix.set(a/i,-s/i,s/n,a/n),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0),tp("cookieOffset",null,function(e,t){this.light.cookieOffset=e},!0),tp("shadowUpdateMode",2,function(e,t){this.light.shadowUpdateMode=e}),tp("mask",1,function(e,t){this.light.mask=e}),tp("affectDynamic",!0,function(e,t){e?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()}),tp("affectLightmapped",!1,function(e,t){e?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))}),tp("bake",!1,function(e,t){e?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2))}),tp("bakeDir",!0,function(e,t){this.light.bakeDir=e}),tp("isStatic",!1,function(e,t){this.light.isStatic=e}),tp("layers",[0],function(e,t){var i,n;for(i=0;i<t.length;i++)(n=this.system.app.scene.layers.getLayerById(t[i]))&&n.removeLight(this);for(i=0;i<e.length;i++)(n=this.system.app.scene.layers.getLayerById(e[i]))&&this.enabled&&this.entity.enabled&&n.addLight(this)});var ip=function(){for(var e,t=Qd,i=Jd,n=0;n<t.length;n++)(e=i[n])&&e.clone?this[t[n]]=e.clone():this[t[n]]=e},np={directional:0,omni:1,point:1,spot:2},ap=function(l){function e(e){var t;return(t=l.call(this,e)||this).id="light",t.ComponentType=ep,t.DataType=ip,t.on("beforeremove",t._onRemoveComponent,g(t)),t}u(e,l);var t=e.prototype;return t.initializeComponentData=function(e,t){for(var i=Qd,n={},a=0,s=i.length;a<s;a++){var r=i[a];n[r]=t[r]}n.type||(n.type=e.data.type),e.data.type=n.type,n.layers&&Array.isArray(n.layers)&&(n.layers=n.layers.slice(0)),n.color&&Array.isArray(n.color)&&(n.color=new $(n.color[0],n.color[1],n.color[2])),n.cookieOffset&&n.cookieOffset instanceof Array&&(n.cookieOffset=new J(n.cookieOffset[0],n.cookieOffset[1])),n.cookieScale&&n.cookieScale instanceof Array&&(n.cookieScale=new J(n.cookieScale[0],n.cookieScale[1])),n.enable&&(n.enabled=n.enable),n.shape||(n.shape=0);var o=new Zd(this.app.graphicsDevice);o.type=np[n.type],o._node=e.entity,o._scene=this.app.scene,e.data.light=o,l.prototype.initializeComponentData.call(this,e,n,i)},t._onRemoveComponent=function(e,t){t.onRemove()},t.cloneComponent=function(e,t){for(var i,n=e.light,a=[],s=Qd,r=0;r<s.length;r++)"light"!==(i=s[r])&&(n[i]&&n[i].clone?a[i]=n[i].clone():a[i]=n[i]);this.addComponent(t,a)},t.changeType=function(e,t,i){t!==i&&(e.light.type=np[i])},e}(qh),sp=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._type="asset",i._asset=null,i._model=null,i._mapping={},i._castShadows=!0,i._receiveShadows=!0,i._materialAsset=null,i._material=e.defaultMaterial,i._castShadowsLightmap=!0,i._lightmapped=!1,i._lightmapSizeMultiplier=1,i._isStatic=!1,i._layers=[0],i._batchGroupId=-1,i._customAabb=null,i._area=null,i._assetOld=0,i._materialEvents=null,i._dirtyModelAsset=!1,i._dirtyMaterialAsset=!1,i._clonedModel=!1,t.on("remove",i.onRemoveChild,g(i)),t.on("insert",i.onInsertChild,g(i)),i}u(e,n);var t=e.prototype;return t.addModelToLayers=function(){for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var i=e.getLayerById(this._layers[t]);i&&i.addMeshInstances(this.meshInstances)}},t.removeModelFromLayers=function(){for(var e,t=this.system.app.scene.layers,i=0;i<this._layers.length;i++)(e=t.getLayerById(this._layers[i]))&&e.removeMeshInstances(this.meshInstances)},t.onRemoveChild=function(){this._model&&this.removeModelFromLayers()},t.onInsertChild=function(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()},t.onRemove=function(){"asset"===this.type?this.asset=null:this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)},t.onLayersChanged=function(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this.meshInstances)},t.onLayerRemoved=function(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.meshInstances)},t._setMaterialEvent=function(e,t,i,n){var a=t+":"+i;this.system.app.assets.on(a,n,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][a]={id:i,handler:n}},t._unsetMaterialEvents=function(){var e=this.system.app.assets,t=this._materialEvents;if(t){for(var i=0,n=t.length;i<n;i++)if(t[i]){var a=t[i];for(var s in a)e.off(s,a[s].handler,this)}this._materialEvents=null}},t._getAssetByIdOrPath=function(e){var t=null;if(isNaN(parseInt(e,10))){if(this.asset){var i=this._getMaterialAssetUrl(e);i&&(t=this.system.app.assets.getByUrl(i))}}else t=this.system.app.assets.get(e);return t},t._getMaterialAssetUrl=function(e){if(!this.asset)return null;var t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null},t._loadAndSetMeshInstanceMaterial=function(t,i,n){var e=this.system.app.assets;t&&(t.resource?(i.material=t.resource,this._setMaterialEvent(n,"remove",t.id,function(){i.material=this.system.defaultMaterial})):(this._setMaterialEvent(n,"load",t.id,function(e){i.material=e.resource,this._setMaterialEvent(n,"remove",t.id,function(){i.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&e.load(t)))},t.onEnable=function(){var e=this.system.app,t=e.scene;t.on("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.on("add",this.onLayerAdded,this),t.layers.on("remove",this.onLayerRemoved,this));var i,n="asset"===this._type;if(this._model?this.addModelToLayers():n&&this._asset&&(i=e.assets.get(this._asset))&&i.resource!==this._model&&this._bindModelAsset(i),this._materialAsset&&(i=e.assets.get(this._materialAsset))&&i.resource!==this._material&&this._bindMaterialAsset(i),n&&this._mapping)for(var a in this._mapping)this._mapping[a]&&(i=this._getAssetByIdOrPath(this._mapping[a]))&&!i.resource&&e.assets.load(i);0<=this._batchGroupId&&e.batcher.insert(Cn.MODEL,this.batchGroupId,this.entity)},t.onDisable=function(){var e=this.system.app,t=e.scene;t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),0<=this._batchGroupId&&e.batcher.remove(Cn.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers()},t.hide=function(){if(this._model){var e,t,i=this._model.meshInstances;for(e=0,t=i.length;e<t;e++)i[e].visible=!1}},t.show=function(){if(this._model){var e,t,i=this._model.meshInstances;for(e=0,t=i.length;e<t;e++)i[e].visible=!0}},t._bindMaterialAsset=function(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindMaterialAsset=function(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)},t._onMaterialAssetAdd=function(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)},t._onMaterialAssetLoad=function(e){this._setMaterial(e.resource)},t._onMaterialAssetUnload=function(e){this._setMaterial(this.system.defaultMaterial)},t._onMaterialAssetRemove=function(e){this._onMaterialAssetUnload(e)},t._onMaterialAssetChange=function(e){},t._bindModelAsset=function(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindModelAsset=function(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)},t._onModelAssetAdded=function(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e)},t._onModelAssetLoad=function(e){this.model=e.resource.clone(),this._clonedModel=!0,this.fire("cloned")},t._onModelAssetUnload=function(e){this.model=null},t._onModelAssetChange=function(e,t,i,n){"data"===t&&(this.mapping=this._mapping)},t._onModelAssetRemove=function(e){this.model=null},t._setMaterial=function(e){if(this._material!==e){this._material=e;var t=this._model;if(t&&"asset"!==this._type)for(var i=t.meshInstances,n=0,a=i.length;n<a;n++)i[n].material=e}},c(e,[{key:"meshInstances",get:function(){return this._model?this._model.meshInstances:null},set:function(e){this._model&&(this._model.meshInstances=e)}},{key:"customAabb",get:function(){return this._customAabb},set:function(e){if(this._customAabb=e,this._model){var t=this._model.meshInstances;if(t)for(var i=0;i<t.length;i++)t[i].setCustomAabb(this._customAabb)}}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e)if(this._area=null,"asset"===(this._type=e))null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{var t=nr(this.system.app.graphicsDevice,e);this._area=t.area;var i=t.mesh,n=new mn,a=new rr;a.graph=n,a.meshInstances=[new Mn(i,this._material,n)],this.model=a,this._asset=null}}},{key:"asset",get:function(){return this._asset},set:function(e){var t=this.system.app.assets,i=e;if(e instanceof Kr&&(i=e.id),this._asset!==i){if(this._asset){t.off("add:"+this._asset,this._onModelAssetAdded,this);var n=t.get(this._asset);n&&this._unbindModelAsset(n)}if(this._asset=i,this._asset){var a=t.get(this._asset);a?this._bindModelAsset(a):(this.model=null,t.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}},{key:"model",get:function(){return this._model},set:function(e){var t;if(this._model!==e&&(!e||!e._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e,this._model)){this._model._immutable=!0;var i=this._model.meshInstances;for(t=0;t<i.length;t++)i[t].castShadow=this._castShadows,i[t].receiveShadow=this._receiveShadows,i[t].isStatic=this._isStatic,i[t].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&(this.entity.anim.playing?this.entity.anim.rebind():this.entity.anim.resetStateGraph()),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}},{key:"lightmapped",get:function(){return this._lightmapped},set:function(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model))for(var t=this._model.meshInstances,i=0;i<t.length;i++)t[i].setLightmapped(e)}},{key:"castShadows",get:function(){return this._castShadows},set:function(e){if(this._castShadows!==e){var t,i,n=this._model;if(n){var a=this.layers,s=this.system.app.scene;if(this._castShadows&&!e)for(i=0;i<a.length;i++)(t=this.system.app.scene.layers.getLayerById(this.layers[i]))&&t.removeShadowCasters(n.meshInstances);var r=n.meshInstances;for(i=0;i<r.length;i++)r[i].castShadow=e;if(!this._castShadows&&e)for(i=0;i<a.length;i++)(t=s.layers.getLayerById(a[i]))&&t.addShadowCasters(n.meshInstances)}this._castShadows=e}}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model))for(var t=this._model.meshInstances,i=0,n=t.length;i<n;i++)t[i].receiveShadow=e}},{key:"castShadowsLightmap",get:function(){return this._castShadowsLightmap},set:function(e){this._castShadowsLightmap=e}},{key:"lightmapSizeMultiplier",get:function(){return this._lightmapSizeMultiplier},set:function(e){this._lightmapSizeMultiplier=e}},{key:"isStatic",get:function(){return this._isStatic},set:function(e){var t;if(this._isStatic!==e&&(this._isStatic=e,this._model)){var i=this._model.meshInstances;for(t=0;t<i.length;t++)i[t].isStatic=e}}},{key:"layers",get:function(){return this._layers},set:function(e){var t,i,n=this.system.app.scene.layers;if(this.meshInstances)for(t=0;t<this._layers.length;t++)(i=n.getLayerById(this._layers[t]))&&i.removeMeshInstances(this.meshInstances);for(t=this._layers.length=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(t=0;t<this._layers.length;t++)(i=n.getLayerById(this._layers[t]))&&i.addMeshInstances(this.meshInstances)}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var t=this.system.app.batcher;this.entity.enabled&&0<=this._batchGroupId&&t.remove(Cn.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&0<=e&&t.insert(Cn.MODEL,e,this.entity),e<0&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e}}},{key:"materialAsset",get:function(){return this._materialAsset},set:function(e){var t=e;e instanceof Kr&&(t=e.id);var i=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){i.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var n=i.get(this._materialAsset);n&&this._unbindMaterialAsset(n)}if(this._materialAsset=t,this._materialAsset){var a=i.get(this._materialAsset);a?this._bindMaterialAsset(a):(this._setMaterial(this.system.defaultMaterial),i.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}},{key:"material",get:function(){return this._material},set:function(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e))}},{key:"mapping",get:function(){return this._mapping},set:function(e){if("asset"===this._type&&(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,this._model))for(var t=this._model.meshInstances,i=this.asset?this.system.app.assets.get(this.asset):null,n=i?i.data.mapping:null,a=null,s=0,r=t.length;s<r;s++)if(void 0!==e[s])e[s]?(a=this.system.app.assets.get(e[s]),this._loadAndSetMeshInstanceMaterial(a,t[s],s)):t[s].material=this.system.defaultMaterial;else if(n)if(n[s]&&(n[s].material||n[s].path)){if(void 0!==n[s].material)a=this.system.app.assets.get(n[s].material);else if(void 0!==n[s].path){var o=this._getMaterialAssetUrl(n[s].path);o&&(a=this.system.app.assets.getByUrl(o))}this._loadAndSetMeshInstanceMaterial(a,t[s],s)}else t[s].material=this.system.defaultMaterial}}]),e}(Xh),rp=function(){this.enabled=!0},op=["enabled"],lp=function(a){function e(e){var t;return(t=a.call(this,e)||this).id="model",t.ComponentType=sp,t.DataType=rp,t.schema=op,t.defaultMaterial=e.scene.defaultMaterial,t.on("beforeremove",t.onRemove,g(t)),t}u(e,a);var t=e.prototype;return t.initializeComponentData=function(e,t,i){i=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],null!==t.batchGroupId&&void 0!==t.batchGroupId||(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(var n=0;n<i.length;n++)t.hasOwnProperty(i[n])&&(e[i[n]]=t[i[n]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new ue(new de(t.aabbCenter),new de(t.aabbHalfExtents))),a.prototype.initializeComponentData.call(this,e,t,["enabled"])},t.cloneComponent=function(e,t){var i={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:v({},e.model.mapping)},n=e.model.materialAsset;n instanceof Kr||null==n||(n=this.app.assets.get(n));var a=e.model.material;a&&a!==this.defaultMaterial&&n&&a!==n.resource||(i.materialAsset=n);var s=this.addComponent(t,i);if(e.model.model&&"asset"===e.model.type&&!e.model.asset&&(s.model=e.model.model.clone(),s._clonedModel=!0),i.materialAsset||(s.material=a),e.model.model)for(var r=e.model.model.meshInstances,o=s.model.meshInstances,l=0;l<r.length;l++)o[l].mask=r[l].mask,o[l].material=r[l].material,o[l].layer=r[l].layer,o[l].receiveShadow=r[l].receiveShadow;e.model.customAabb&&(s.customAabb=e.model.aabb.clone())},t.onRemove=function(e,t){t.onRemove()},e}(qh);Xh._buildAccessors(sp.prototype,op);var hp=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._type="asset",i._castShadows=!0,i._receiveShadows=!0,i._castShadowsLightmap=!0,i._lightmapped=!1,i._lightmapSizeMultiplier=1,i._isStatic=!1,i._batchGroupId=-1,i._meshInstances=[],i._layers=[0],i._renderStyle=0,i._customAabb=null,i._area=null,i._rootBone=new Hc(g(i),"rootBone"),i._rootBone.on("set:entity",i._onSetRootBone,g(i)),i._assetReference=new Yo("asset",g(i),e.app.assets,{add:i._onRenderAssetAdded,load:i._onRenderAssetLoad,remove:i._onRenderAssetRemove,unload:i._onRenderAssetUnload},g(i)),i._material=e.defaultMaterial,i._materialReferences=[],t.on("remove",i.onRemoveChild,g(i)),t.on("insert",i.onInsertChild,g(i)),i}u(e,n);var t=e.prototype;return t._onSetRootBone=function(e){e&&this._onRootBoneChanged()},t._onRootBoneChanged=function(){this._clearSkinInstances(),this._cloneSkinInstances()},t.destroyMeshInstances=function(){var e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(var t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0}},t.addToLayers=function(){for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var i=e.getLayerById(this._layers[t]);i&&i.addMeshInstances(this._meshInstances)}},t.removeFromLayers=function(){if(this._meshInstances&&this._meshInstances.length)for(var e,t=this.system.app.scene.layers,i=0;i<this._layers.length;i++)(e=t.getLayerById(this._layers[i]))&&e.removeMeshInstances(this._meshInstances)},t.onRemoveChild=function(){this.removeFromLayers()},t.onInsertChild=function(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()},t.onRemove=function(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)},t.onLayersChanged=function(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this._meshInstances)},t.onLayerRemoved=function(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this._meshInstances)},t.onEnable=function(){var e=this.system.app,t=e.scene;this._rootBone.onParentComponentEnable(),t.on("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.on("add",this.onLayerAdded,this),t.layers.on("remove",this.onLayerRemoved,this));var i="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():i&&this.asset&&this._onRenderAssetAdded();for(var n=0;n<this._materialReferences.length;n++)this._materialReferences[n].asset&&this.system.app.assets.load(this._materialReferences[n].asset);0<=this._batchGroupId&&e.batcher.insert(Cn.RENDER,this.batchGroupId,this.entity)},t.onDisable=function(){var e=this.system.app,t=e.scene;t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),0<=this._batchGroupId&&e.batcher.remove(Cn.RENDER,this.batchGroupId,this.entity),this.removeFromLayers()},t.hide=function(){if(this._meshInstances)for(var e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1},t.show=function(){if(this._meshInstances)for(var e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0},t._onRenderAssetAdded=function(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))},t._onRenderAssetLoad=function(){if(this.destroyMeshInstances(),this._assetReference.asset){var e=this._assetReference.asset.resource;e.off("set:meshes",this._onSetMeshes,this),e.on("set:meshes",this._onSetMeshes,this),e.meshes&&this._onSetMeshes(e.meshes)}},t._onSetMeshes=function(e){this._cloneMeshes(e)},t._clearSkinInstances=function(){for(var e=0;e<this._meshInstances.length;e++){var t=this._meshInstances[e];ko.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null}},t._cloneSkinInstances=function(){if(this._meshInstances.length&&this._rootBone.entity instanceof mn)for(var e=0;e<this._meshInstances.length;e++){var t=this._meshInstances[e],i=t.mesh;i.skin&&!i.skinInstance&&(t.skinInstance=ko.createCachedSkinedInstance(i.skin,this._rootBone.entity,this.entity))}},t._cloneMeshes=function(e){if(e&&e.length){for(var t=[],i=0;i<e.length;i++){var n=e[i],a=this._materialReferences[i]&&this._materialReferences[i].asset&&this._materialReferences[i].asset.resource,s=new Mn(n,a||this.system.defaultMaterial,this.entity);t.push(s),n.morph&&(s.morphInstance=new sr(n.morph))}this.meshInstances=t,this._cloneSkinInstances()}},t._onRenderAssetUnload=function(){"asset"===this._type&&this.destroyMeshInstances()},t._onRenderAssetRemove=function(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()},t._onMaterialAdded=function(e,t,i){i.resource?this._onMaterialLoad(e,t,i):this.enabled&&this.entity.enabled&&this.system.app.assets.load(i)},t._onMaterialLoad=function(e,t,i){this._meshInstances[e]&&(this._meshInstances[e].material=i.resource)},t._onMaterialRemove=function(e,t,i){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial)},t._onMaterialUnload=function(e,t,i){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial)},c(e,[{key:"renderStyle",get:function(){return this._renderStyle},set:function(e){this._renderStyle!==e&&(this._renderStyle=e,Mn._prepareRenderStyleForArray(this._meshInstances,e))}},{key:"customAabb",get:function(){return this._customAabb},set:function(e){this._customAabb=e;var t=this._meshInstances;if(t)for(var i=0;i<t.length;i++)t[i].setCustomAabb(this._customAabb)}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),"asset"!==e)){var t=this._material;t&&t!==this.system.defaultMaterial||(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);var i=nr(this.system.app.graphicsDevice,e);this._area=i.area,this.meshInstances=[new Mn(i.mesh,t||this.system.defaultMaterial,this.entity)]}}},{key:"meshInstances",get:function(){return this._meshInstances},set:function(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){for(var t=this._meshInstances,i=0;i<t.length;i++)t[i].node||(t[i].node=this.entity),t[i].castShadow=this._castShadows,t[i].receiveShadow=this._receiveShadows,t[i].isStatic=this._isStatic,t[i].renderStyle=this._renderStyle,t[i].setLightmapped(this._lightmapped),t[i].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}},{key:"lightmapped",get:function(){return this._lightmapped},set:function(e){if(e!==this._lightmapped){this._lightmapped=e;var t=this._meshInstances;if(t)for(var i=0;i<t.length;i++)t[i].setLightmapped(e)}}},{key:"castShadows",get:function(){return this._castShadows},set:function(e){if(this._castShadows!==e){var t,i,n=this._meshInstances;if(n){var a=this.layers,s=this.system.app.scene;if(this._castShadows&&!e)for(t=0;t<a.length;t++)(i=s.layers.getLayerById(this.layers[t]))&&i.removeShadowCasters(n);for(t=0;t<n.length;t++)n[t].castShadow=e;if(!this._castShadows&&e)for(t=0;t<a.length;t++)(i=s.layers.getLayerById(a[t]))&&i.addShadowCasters(n)}this._castShadows=e}}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){if(this._receiveShadows!==e){this._receiveShadows=e;var t=this._meshInstances;if(t)for(var i=0;i<t.length;i++)t[i].receiveShadow=e}}},{key:"castShadowsLightmap",get:function(){return this._castShadowsLightmap},set:function(e){this._castShadowsLightmap=e}},{key:"lightmapSizeMultiplier",get:function(){return this._lightmapSizeMultiplier},set:function(e){this._lightmapSizeMultiplier=e}},{key:"isStatic",get:function(){return this._isStatic},set:function(e){if(this._isStatic!==e){this._isStatic=e;var t=this._meshInstances;if(t)for(var i=0;i<t.length;i++)t[i].isStatic=e}}},{key:"layers",get:function(){return this._layers},set:function(e){var t,i,n=this.system.app.scene.layers;if(this._meshInstances)for(t=0;t<this._layers.length;t++)(i=n.getLayerById(this._layers[t]))&&i.removeMeshInstances(this._meshInstances);for(t=this._layers.length=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(t=0;t<this._layers.length;t++)(i=n.getLayerById(this._layers[t]))&&i.addMeshInstances(this._meshInstances)}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var t=this.system.app.batcher;this.entity.enabled&&0<=this._batchGroupId&&t.remove(Cn.RENDER,this.batchGroupId,this.entity),this.entity.enabled&&0<=e&&t.insert(Cn.RENDER,e,this.entity),e<0&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e}}},{key:"material",get:function(){return this._material},set:function(e){if(this._material!==e&&(this._material=e,this._meshInstances&&"asset"!==this._type))for(var t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e}},{key:"materialAssets",get:function(){return this._materialReferences.map(function(e){return e.id})},set:function(e){var t;if(e=e||[],this._materialReferences.length>e.length){for(t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length}for(t=0;t<e.length;t++)if(this._materialReferences[t]||this._materialReferences.push(new Yo(t,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[t]){var i=e[t]instanceof Kr?e[t].id:e[t];this._materialReferences[t].id!==i&&(this._materialReferences[t].id=i),this._materialReferences[t].asset&&this._onMaterialAdded(t,this,this._materialReferences[t].asset)}else this._materialReferences[t].id=null,this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial)}},{key:"asset",get:function(){return this._assetReference.id},set:function(e){var t=e instanceof Kr?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded())}}]),e}(Xh),cp=function(){this.enabled=!0,this.rootBone=null},up=[{name:"rootBone",type:"entity"},"enabled"],dp=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"],pp=function(a){function e(e){var t;return(t=a.call(this,e)||this).id="render",t.ComponentType=hp,t.DataType=cp,t.schema=up,t.defaultMaterial=e.scene.defaultMaterial,t.on("beforeremove",t.onRemove,g(t)),t}u(e,a);var t=e.prototype;return t.initializeComponentData=function(e,t,i){null!==t.batchGroupId&&void 0!==t.batchGroupId||(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(var n=0;n<dp.length;n++)t.hasOwnProperty(dp[n])&&(e[dp[n]]=t[dp[n]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new ue(new de(t.aabbCenter),new de(t.aabbHalfExtents))),a.prototype.initializeComponentData.call(this,e,t,up)},t.cloneComponent=function(e,t){for(var i={},n=0;n<dp.length;n++)i[dp[n]]=e.render[dp[n]];delete i.meshInstances;var a=this.addComponent(t,i),s=e.render.meshInstances,r=s.map(function(e){return e.mesh});a._onSetMeshes(r);for(var o=0;o<s.length;o++)a.meshInstances[o].material=s[o].material;e.render.customAabb&&(a.customAabb=e.render.customAabb.clone())},t.onRemove=function(e,t){t.onRemove()},e}(qh);Xh._buildAccessors(hp.prototype,up);var fp,mp=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],vp=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],gp=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],_p=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"],yp=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this).on("set_colorMapAsset",i.onSetColorMapAsset,g(i)),i.on("set_normalMapAsset",i.onSetNormalMapAsset,g(i)),i.on("set_meshAsset",i.onSetMeshAsset,g(i)),i.on("set_mesh",i.onSetMesh,g(i)),i.on("set_renderAsset",i.onSetRenderAsset,g(i)),i.on("set_loop",i.onSetLoop,g(i)),i.on("set_blendType",i.onSetBlendType,g(i)),i.on("set_depthSoftening",i.onSetDepthSoftening,g(i)),i.on("set_layers",i.onSetLayers,g(i)),mp.forEach(function(e){this.on("set_"+e,this.onSetSimpleProperty,this)}.bind(g(i))),vp.forEach(function(e){this.on("set_"+e,this.onSetComplexProperty,this)}.bind(g(i))),gp.forEach(function(e){this.on("set_"+e,this.onSetGraphProperty,this)}.bind(g(i))),i._requestedDepth=!1,i._drawOrder=0,i}u(e,n);var t=e.prototype;return t.addModelToLayers=function(){if(this.data.model)for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&(e.addMeshInstances(this.data.model.meshInstances),this.emitter._layer=e)},t.removeModelFromLayers=function(e){if(this.data.model)for(var t,i=0;i<this.layers.length;i++)(t=this.system.app.scene.layers.getLayerById(this.layers[i]))&&t.removeMeshInstances(this.data.model.meshInstances)},t.onSetLayers=function(e,t,i){if(this.data.model){var n,a;for(n=0;n<t.length;n++)(a=this.system.app.scene.layers.getLayerById(t[n]))&&a.removeMeshInstances(this.data.model.meshInstances);if(this.enabled&&this.entity.enabled)for(n=0;n<i.length;n++)(a=this.system.app.scene.layers.getLayerById(i[n]))&&a.addMeshInstances(this.data.model.meshInstances)}},t.onLayersChanged=function(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},t.onLayerAdded=function(e){this.data.model&&(this.layers.indexOf(e.id)<0||e.addMeshInstances(this.data.model.meshInstances))},t.onLayerRemoved=function(e){this.data.model&&(this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.data.model.meshInstances))},t._bindColorMapAsset=function(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindColorMapAsset=function(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this)},t._onColorMapAssetLoad=function(e){this.colorMap=e.resource},t._onColorMapAssetUnload=function(e){this.colorMap=null},t._onColorMapAssetRemove=function(e){this._onColorMapAssetUnload(e)},t._onColorMapAssetChange=function(e){},t.onSetColorMapAsset=function(e,t,i){var n,a=this,s=this.system.app.assets;t&&(n=s.get(t))&&this._unbindColorMapAsset(n),i?(i instanceof Kr&&(this.data.colorMapAsset=i.id,i=i.id),(n=s.get(i))?a._bindColorMapAsset(n):s.once("add:"+i,function(e){a._bindColorMapAsset(e)})):this.colorMap=null},t._bindNormalMapAsset=function(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindNormalMapAsset=function(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this)},t._onNormalMapAssetLoad=function(e){this.normalMap=e.resource},t._onNormalMapAssetUnload=function(e){this.normalMap=null},t._onNormalMapAssetRemove=function(e){this._onNormalMapAssetUnload(e)},t._onNormalMapAssetChange=function(e){},t.onSetNormalMapAsset=function(e,t,i){var n,a=this,s=this.system.app.assets;t&&(n=s.get(t))&&this._unbindNormalMapAsset(n),i?(i instanceof Kr&&(this.data.normalMapAsset=i.id,i=i.id),(n=s.get(i))?a._bindNormalMapAsset(n):s.once("add:"+i,function(e){a._bindNormalMapAsset(e)})):this.normalMap=null},t._bindMeshAsset=function(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindMeshAsset=function(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this)},t._onMeshAssetLoad=function(e){this._onMeshChanged(e.resource)},t._onMeshAssetUnload=function(e){this.mesh=null},t._onMeshAssetRemove=function(e){this._onMeshAssetUnload(e)},t._onMeshAssetChange=function(e){},t.onSetMeshAsset=function(e,t,i){var n,a=this.system.app.assets;t&&(n=a.get(t))&&this._unbindMeshAsset(n),i?(i instanceof Kr&&(this.data.meshAsset=i.id,i=i.id),(n=a.get(i))&&this._bindMeshAsset(n)):this._onMeshChanged(null)},t.onSetMesh=function(e,t,i){!i||i instanceof Kr||"number"==typeof i?this.meshAsset=i:this._onMeshChanged(i)},t._onMeshChanged=function(e){!e||e instanceof Zi||(e=e.meshInstances[0]?e.meshInstances[0].mesh:null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild())},t.onSetRenderAsset=function(e,t,i){var n,a=this.system.app.assets;t&&(n=a.get(t))&&this._unbindRenderAsset(n),i?(i instanceof Kr&&(this.data.renderAsset=i.id,i=i.id),(n=a.get(i))&&this._bindRenderAsset(n)):this._onRenderChanged(null)},t._bindRenderAsset=function(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}},t._unbindRenderAsset=function(e){e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),e.resource&&e.resource.off("set:meshes",this._onRenderSetMeshes,this)},t._onRenderAssetLoad=function(e){this._onRenderChanged(e.resource)},t._onRenderAssetUnload=function(e){this._onRenderChanged(null)},t._onRenderAssetRemove=function(e){this._onRenderAssetUnload(e)},t._onRenderChanged=function(e){e?(e.off("set:meshes",this._onRenderSetMeshes,this),e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes)):this._onMeshChanged(null)},t._onRenderSetMeshes=function(e){this._onMeshChanged(e&&e[0])},t.onSetLoop=function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetTime())},t.onSetBlendType=function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.material.blendType=i,this.emitter.resetMaterial(),this.rebuild())},t._requestDepth=function(){this._requestedDepth||(fp||(fp=this.system.app.scene.layers.getLayerById(1)),fp&&(fp.incrementCounter(),this._requestedDepth=!0))},t._releaseDepth=function(){this._requestedDepth&&fp&&(fp.decrementCounter(),this._requestedDepth=!1)},t.onSetDepthSoftening=function(e,t,i){t!==i&&(i?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=i),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))},t.onSetSimpleProperty=function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetMaterial())},t.onSetComplexProperty=function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetMaterial(),this.rebuild(),this.reset())},t.onSetGraphProperty=function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},t.onEnable=function(){for(var e=this.data,t=0,i=_p.length;t<i;t++){var n=e[_p[t]];if(n){if(!(n instanceof Kr)){if(!(0<=parseInt(n,10)))continue;n=this.system.app.assets.get(n)}n&&!n.resource&&this.system.app.assets.load(n)}}if(!this.emitter){var a=e.mesh;a instanceof Zi||(a=null),this.emitter=new Ys(this.system.app.graphicsDevice,{numParticles:e.numParticles,emitterExtents:e.emitterExtents,emitterExtentsInner:e.emitterExtentsInner,emitterRadius:e.emitterRadius,emitterRadiusInner:e.emitterRadiusInner,emitterShape:e.emitterShape,initialVelocity:e.initialVelocity,wrap:e.wrap,localSpace:e.localSpace,screenSpace:e.screenSpace,wrapBounds:e.wrapBounds,lifetime:e.lifetime,rate:e.rate,rate2:e.rate2,orientation:e.orientation,particleNormal:e.particleNormal,animTilesX:e.animTilesX,animTilesY:e.animTilesY,animStartFrame:e.animStartFrame,animNumFrames:e.animNumFrames,animNumAnimations:e.animNumAnimations,animIndex:e.animIndex,randomizeAnimIndex:e.randomizeAnimIndex,animSpeed:e.animSpeed,animLoop:e.animLoop,startAngle:e.startAngle,startAngle2:e.startAngle2,scaleGraph:e.scaleGraph,scaleGraph2:e.scaleGraph2,colorGraph:e.colorGraph,colorGraph2:e.colorGraph2,alphaGraph:e.alphaGraph,alphaGraph2:e.alphaGraph2,localVelocityGraph:e.localVelocityGraph,localVelocityGraph2:e.localVelocityGraph2,velocityGraph:e.velocityGraph,velocityGraph2:e.velocityGraph2,rotationSpeedGraph:e.rotationSpeedGraph,rotationSpeedGraph2:e.rotationSpeedGraph2,radialSpeedGraph:e.radialSpeedGraph,radialSpeedGraph2:e.radialSpeedGraph2,colorMap:e.colorMap,normalMap:e.normalMap,loop:e.loop,preWarm:e.preWarm,sort:e.sort,stretch:e.stretch,alignToMotion:e.alignToMotion,lighting:e.lighting,halfLambert:e.halfLambert,intensity:e.intensity,depthSoftening:e.depthSoftening,scene:this.system.app.scene,mesh:a,depthWrite:e.depthWrite,noFog:e.noFog,node:this.entity,blendType:e.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,this.psys=new rr,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],e.model=this.psys,this.emitter.psys=this.psys,e.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}e.model&&this.emitter.colorMap&&this.addModelToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&e.depthSoftening&&this._requestDepth()},t.onDisable=function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth()),this.emitter&&(this.emitter.camera=null)},t.onBeforeRemove=function(){this.enabled&&(this.enabled=!1);var e=this.data;e.model&&(this.entity.removeChild(e.model.getGraph()),e.model.destroy(),e.model=null),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(var t=0;t<_p.length;t++){var i=_p[t];e[i]&&(this[i]=null)}this.off()},t.reset=function(){this.emitter&&this.emitter.reset()},t.stop=function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},t.pause=function(){this.data.paused=!0},t.unpause=function(){this.data.paused=!1},t.play=function(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())},t.isPlaying=function(){return!this.data.paused&&(!(!this.emitter||!this.emitter.loop)||Date.now()<=this.emitter.endTime)},t.rebuild=function(){var e=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]),this.enabled=e},c(e,[{key:"drawOrder",get:function(){return this._drawOrder},set:function(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e)}}]),e}(Xh),bp=function(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new de,this.emitterExtentsInner=new de,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=0,this.initialVelocity=0,this.wrapBounds=new de,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=0,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=0,this.particleNormal=new de(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=2,this.model=null,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[0]},xp=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"],Mp=function(o){function e(e){var t;return(t=o.call(this,e)||this).id="particlesystem",t.ComponentType=yp,t.DataType=bp,t.schema=xp,t.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},t.on("beforeremove",t.onBeforeRemove,g(t)),qh.bind("update",t.onUpdate,g(t)),t}u(e,o);var t=e.prototype;return t.initializeComponentData=function(e,t,i){var n={};i=[];var a,s=this.propertyTypes;for(var r in(t.mesh instanceof Kr||"number"==typeof t.mesh)&&(t.meshAsset=t.mesh,delete t.mesh),t)t.hasOwnProperty(r)&&(i.push(r),n[r]=t[r]),"vec3"===s[r]?Array.isArray(n[r])&&(n[r]=new de(n[r][0],n[r][1],n[r][2])):"curve"===s[r]?n[r]instanceof K||(a=n[r].type,n[r]=new K(n[r].keys),n[r].type=a):"curveset"===s[r]&&(n[r]instanceof Z||(a=n[r].type,n[r]=new Z(n[r].keys),n[r].type=a)),n.layers&&Array.isArray(n.layers)&&(n.layers=n.layers.slice(0));o.prototype.initializeComponentData.call(this,e,n,i)},t.cloneComponent=function(e,t){for(var i=e.particlesystem.data,n=this.schema,a={},s=0,r=n.length;s<r;s++){var o=n[s],l=i[o];l instanceof de||l instanceof K||l instanceof Z?(l=l.clone(),a[o]=l):"layers"===o?a.layers=i.layers.slice(0):null!=l&&(a[o]=l)}return this.addComponent(t,a)},t.onUpdate=function(e){var t,i,n,a,s=this.store,r=this.app.stats.particles;for(var o in s)if(s.hasOwnProperty(o)){var l=(a=s[o]).entity,h=a.data;if(h.enabled&&l.enabled){var c=h.model.emitter;if(!c.meshInstance.visible)continue;if(c.lighting){var u,d,p=h.layers;for(i=0;i<p.length;i++)if(u=this.app.scene.layers.getLayerById(p[i])){for(u._lightCube||(u._lightCube=new Float32Array(18)),d=u._lightCube,i=0;i<6;i++)d[3*i]=this.app.scene.ambientLight.r,d[3*i+1]=this.app.scene.ambientLight.g,d[3*i+2]=this.app.scene.ambientLight.b;var f=u._splitLights[0];for(n=0;n<f.length;n++)for(a=0;a<6;a++){var m=Math.max(c.lightCubeDir[a].dot(f[n]._direction),0)*f[n]._intensity;d[3*a]+=f[n]._color.r*m,d[3*a+1]+=f[n]._color.g*m,d[3*a+2]+=f[n]._color.b*m}}c.constantLightCube.setValue(d)}if(!h.paused){if(c.simTime+=e,c.simTime>c.fixedTimeStep&&(t=Math.floor(c.simTime/c.fixedTimeStep),c.simTime-=t*c.fixedTimeStep),t){for(t=Math.min(t,c.maxSubSteps),i=0;i<t;i++)c.addTime(c.fixedTimeStep,!1);r._updatesPerFrame+=t,r._frameTime+=c._addTimeTime,c._addTimeTime=0}c.finishFrame()}}}},t.onBeforeRemove=function(e,t){t.onBeforeRemove()},e}(qh);Xh._buildAccessors(yp.prototype,xp);var Sp,wp,Cp,Pp,Tp,Ap,Ep,Rp=function(){function e(e,t){this._constructor=e,this._pool=[],this._count=0,this._resize(t)}var t=e.prototype;return t._resize=function(e){if(e>this._pool.length)for(var t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor},t.allocate=function(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]},t.freeAll=function(){this._count=0},e}(),Dp=function(n){function e(e,t){var i;return i=n.call(this,e,t)||this,"undefined"==typeof Ammo||Sp||(Sp=new Ammo.btTransform,wp=new Ammo.btVector3,Cp=new Ammo.btVector3,Pp=new Ammo.btQuaternion,Tp=new Ammo.btVector3(0,0,0)),i._angularDamping=0,i._angularFactor=new de(1,1,1),i._angularVelocity=new de,i._body=null,i._friction=.5,i._group=2,i._linearDamping=0,i._linearFactor=new de(1,1,1),i._linearVelocity=new de,i._mask=65533,i._mass=1,i._restitution=0,i._rollingFriction=0,i._simulationEnabled=!1,i._type=fu,i}u(e,n);var t=e.prototype;return t.createBody=function(){var e,t=this.entity;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&this.system.onRemove(t,this);var i=this._type===mu?this._mass:0;this._getEntityTransform(Sp);var n=this.system.createBody(i,e,Sp);if(n.setRestitution(this._restitution),n.setFriction(this._friction),n.setRollingFriction(this._rollingFriction),n.setDamping(this._linearDamping,this._angularDamping),this._type===mu){var a=this._linearFactor;wp.setValue(a.x,a.y,a.z),n.setLinearFactor(wp);var s=this._angularFactor;wp.setValue(s.x,s.y,s.z),n.setAngularFactor(wp)}else this._type===vu&&(n.setCollisionFlags(2|n.getCollisionFlags()),n.setActivationState(4));n.entity=t,this.body=n,this.enabled&&t.enabled&&this.enableSimulation()}},t.isActive=function(){return!!this._body&&this._body.isActive()},t.activate=function(){this._body&&this._body.activate()},t.enableSimulation=function(){var e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){var t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case mu:this.system._dynamic.push(this),t.forceActivationState(1),this.syncEntityToBody();break;case vu:this.system._kinematic.push(this),t.forceActivationState(4);break;case fu:t.forceActivationState(1),this.syncEntityToBody()}"compound"===e.collision.type&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=!0}}},t.disableSimulation=function(){var e=this._body;if(e&&this._simulationEnabled){var t=this.system,i=t._compounds.indexOf(this.entity.collision);-1<i&&t._compounds.splice(i,1),-1<(i=t._dynamic.indexOf(this))&&t._dynamic.splice(i,1),-1<(i=t._kinematic.indexOf(this))&&t._kinematic.splice(i,1),t.removeBody(e),e.forceActivationState(5),this._simulationEnabled=!1}},t.applyForce=function(){var e,t,i,n,a,s;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 2:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z,n=arguments[1].x,a=arguments[1].y,s=arguments[1].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;case 6:e=arguments[0],t=arguments[1],i=arguments[2],n=arguments[3],a=arguments[4],s=arguments[5]}var r=this._body;r&&(r.activate(),wp.setValue(e,t,i),void 0!==n?(Cp.setValue(n,a,s),r.applyForce(wp,Cp)):r.applyForce(wp,Tp))},t.applyTorque=function(){var e,t,i;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;default:return}var n=this._body;n&&(n.activate(),wp.setValue(e,t,i),n.applyTorque(wp))},t.applyImpulse=function(){var e,t,i,n,a,s;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 2:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z,n=arguments[1].x,a=arguments[1].y,s=arguments[1].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;case 6:e=arguments[0],t=arguments[1],i=arguments[2],n=arguments[3],a=arguments[4],s=arguments[5];break;default:return}var r=this._body;r&&(r.activate(),wp.setValue(e,t,i),void 0!==n?(Cp.setValue(n,a,s),r.applyImpulse(wp,Cp)):r.applyImpulse(wp,Tp))},t.applyTorqueImpulse=function(){var e,t,i;switch(arguments.length){case 1:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;default:return}var n=this._body;n&&(n.activate(),wp.setValue(e,t,i),n.applyTorqueImpulse(wp))},t.isStatic=function(){return this._type===fu},t.isStaticOrKinematic=function(){return this._type===fu||this._type===vu},t.isKinematic=function(){return this._type===vu},t._getEntityTransform=function(e){var t=this.entity,i=t.getPosition(),n=t.getRotation();wp.setValue(i.x,i.y,i.z),Pp.setValue(n.x,n.y,n.z,n.w),e.setOrigin(wp),e.setRotation(Pp)},t.syncEntityToBody=function(){var e=this._body;if(e){if(this._getEntityTransform(Sp),e.setWorldTransform(Sp),this._type===vu){var t=e.getMotionState();t&&t.setWorldTransform(Sp)}e.activate()}},t._updateDynamic=function(){var e=this._body;if(e.isActive()){var t=e.getMotionState();if(t){t.getWorldTransform(Sp);var i=Sp.getOrigin(),n=Sp.getRotation();this.entity.setPosition(i.x(),i.y(),i.z()),this.entity.setRotation(n.x(),n.y(),n.z(),n.w())}}},t._updateKinematic=function(){var e=this._body.getMotionState();e&&(this._getEntityTransform(Sp),e.setWorldTransform(Sp))},t.teleport=function(){arguments.length<3?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof fe?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2])),this.syncEntityToBody()},t.onEnable=function(){this._body||this.createBody(),this.enableSimulation()},t.onDisable=function(){this.disableSimulation()},c(e,[{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e))}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){this._angularFactor.equals(e)||(this._angularFactor.copy(e),this._body&&this._type===mu&&(wp.setValue(e.x,e.y,e.z),this._body.setAngularFactor(wp)))}},{key:"angularVelocity",get:function(){if(this._body&&this._type===mu){var e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z())}return this._angularVelocity},set:function(e){this._body&&this._type===mu&&(this._body.activate(),wp.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(wp),this._angularVelocity.copy(e))}},{key:"body",get:function(){return this._body},set:function(e){this._body!==e&&((this._body=e)&&this._simulationEnabled&&e.activate())}},{key:"friction",get:function(){return this._friction},set:function(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e))}},{key:"group",get:function(){return this._group},set:function(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping))}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){this._linearFactor.equals(e)||(this._linearFactor.copy(e),this._body&&this._type===mu&&(wp.setValue(e.x,e.y,e.z),this._body.setLinearFactor(wp)))}},{key:"linearVelocity",get:function(){if(this._body&&this._type===mu){var e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z())}return this._linearVelocity},set:function(e){this._body&&this._type===mu&&(this._body.activate(),wp.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(wp),this._linearVelocity.copy(e))}},{key:"mask",get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}},{key:"mass",get:function(){return this._mass},set:function(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===mu)){var t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,wp),this._body.setMassProps(e,wp),this._body.updateInertiaTensor(),t&&this.enableSimulation()}}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e))}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e))}},{key:"type",get:function(){return this._type},set:function(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case mu:this._group=1,this._mask=65535;break;case vu:this._group=4,this._mask=65535;break;case fu:default:this._group=2,this._mask=65533}this.createBody()}}}]),e}(Xh),Ip=function(){this.enabled=!0},kp={},Lp={},Op=function(e,t,i){this.entity=e,this.point=t,this.normal=i},Fp=function(e,t,i){0===arguments.length?(this.a=null,this.b=null,this.localPointA=new de,this.localPointB=new de,this.pointA=new de,this.pointB=new de,this.normal=new de):(this.a=e,this.b=t,this.localPointA=i.localPoint,this.localPointB=i.localPointOther,this.pointA=i.point,this.pointB=i.pointOther,this.normal=i.normal)},zp=function(e,t,i,n,a){void 0===e&&(e=new de),void 0===t&&(t=new de),void 0===i&&(i=new de),void 0===n&&(n=new de),void 0===a&&(a=new de),this.localPoint=e,this.localPointOther=t,this.point=i,this.pointOther=n,this.normal=a},Bp=function(e,t){this.other=e,this.contacts=t},Vp=["enabled"],Up=function(o){function e(e){var t;return(t=o.call(this,e)||this).id="rigidbody",t._stats=e.stats.frame,t.ComponentType=Dp,t.DataType=Ip,t.contactPointPool=null,t.contactResultPool=null,t.singleContactResultPool=null,t.schema=Vp,t.maxSubSteps=10,t.fixedTimeStep=1/60,t.gravity=new de(0,-9.81,0),t._dynamic=[],t._kinematic=[],t._triggers=[],t._compounds=[],t.on("beforeremove",t.onBeforeRemove,g(t)),t.on("remove",t.onRemove,g(t)),t}u(e,o);var t=e.prototype;return t.onLibraryLoaded=function(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){var e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e)}Ap=new Ammo.btVector3,Ep=new Ammo.btVector3,this.contactPointPool=new Rp(zp,1),this.contactResultPool=new Rp(Bp,1),this.singleContactResultPool=new Rp(Fp,1),qh.bind("update",this.onUpdate,this)}else qh.unbind("update",this.onUpdate,this)},t.initializeComponentData=function(e,t,i){for(var n=0,a=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];n<a.length;n++){var s=a[n];if(t.hasOwnProperty(s)){var r=t[s];Array.isArray(r)?e[s]=new de(r[0],r[1],r[2]):e[s]=r}}o.prototype.initializeComponentData.call(this,e,t,["enabled"])},t.cloneComponent=function(e,t){var i=e.rigidbody,n={enabled:i.enabled,mass:i.mass,linearDamping:i.linearDamping,angularDamping:i.angularDamping,linearFactor:[i.linearFactor.x,i.linearFactor.y,i.linearFactor.z],angularFactor:[i.angularFactor.x,i.angularFactor.y,i.angularFactor.z],friction:i.friction,rollingFriction:i.rollingFriction,restitution:i.restitution,type:i.type,group:i.group,mask:i.mask};this.addComponent(t,n)},t.onBeforeRemove=function(e,t){t.enabled&&(t.enabled=!1)},t.onRemove=function(e,t){var i=t.body;i&&(this.removeBody(i),this.destroyBody(i),t.body=null)},t.addBody=function(e,t,i){void 0!==t&&void 0!==i?this.dynamicsWorld.addRigidBody(e,t,i):this.dynamicsWorld.addRigidBody(e)},t.removeBody=function(e){this.dynamicsWorld.removeRigidBody(e)},t.createBody=function(e,t,i){var n=new Ammo.btVector3(0,0,0);0!==e&&t.calculateLocalInertia(e,n);var a=new Ammo.btDefaultMotionState(i),s=new Ammo.btRigidBodyConstructionInfo(e,a,t,n),r=new Ammo.btRigidBody(s);return Ammo.destroy(s),Ammo.destroy(n),r},t.destroyBody=function(e){var t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e)},t.raycastFirst=function(e,t){var i=null;Ap.setValue(e.x,e.y,e.z),Ep.setValue(t.x,t.y,t.z);var n=new Ammo.ClosestRayResultCallback(Ap,Ep);if(this.dynamicsWorld.rayTest(Ap,Ep,n),n.hasHit()){var a=n.get_m_collisionObject(),s=Ammo.castObject(a,Ammo.btRigidBody);if(s){var r=n.get_m_hitPointWorld(),o=n.get_m_hitNormalWorld();if(i=new Op(s.entity,new de(r.x(),r.y(),r.z()),new de(o.x(),o.y(),o.z())),2<arguments.length)(0,arguments[2])(i)}}return Ammo.destroy(n),i},t.raycastAll=function(e,t){var i=[];Ap.setValue(e.x,e.y,e.z),Ep.setValue(t.x,t.y,t.z);var n=new Ammo.AllHitsRayResultCallback(Ap,Ep);if(this.dynamicsWorld.rayTest(Ap,Ep,n),n.hasHit())for(var a=n.get_m_collisionObjects(),s=n.get_m_hitPointWorld(),r=n.get_m_hitNormalWorld(),o=a.size(),l=0;l<o;l++){var h=Ammo.castObject(a.at(l),Ammo.btRigidBody);if(h){var c=s.at(l),u=r.at(l),d=new Op(h.entity,new de(c.x(),c.y(),c.z()),new de(u.x(),u.y(),u.z()));i.push(d)}}return Ammo.destroy(n),i},t._storeCollision=function(e,t){var i=!1,n=e.getGuid();return kp[n]=kp[n]||{others:[],entity:e},kp[n].others.indexOf(t)<0&&(kp[n].others.push(t),i=!0),Lp[n]=Lp[n]||{others:[],entity:e},Lp[n].others.push(t),i},t._createContactPointFromAmmo=function(e){var t=e.get_m_localPointA(),i=e.get_m_localPointB(),n=e.getPositionWorldOnA(),a=e.getPositionWorldOnB(),s=e.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPoint.set(t.x(),t.y(),t.z()),r.localPointOther.set(i.x(),i.y(),i.z()),r.point.set(n.x(),n.y(),n.z()),r.pointOther.set(a.x(),a.y(),a.z()),r.normal.set(s.x(),s.y(),s.z()),r},t._createReverseContactPointFromAmmo=function(e){var t=e.get_m_localPointA(),i=e.get_m_localPointB(),n=e.getPositionWorldOnA(),a=e.getPositionWorldOnB(),s=e.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPointOther.set(t.x(),t.y(),t.z()),r.localPoint.set(i.x(),i.y(),i.z()),r.pointOther.set(n.x(),n.y(),n.z()),r.point.set(a.x(),a.y(),a.z()),r.normal.set(s.x(),s.y(),s.z()),r},t._createSingleContactResult=function(e,t,i){var n=this.singleContactResultPool.allocate();return n.a=e,n.b=t,n.localPointA=i.localPoint,n.localPointB=i.localPointOther,n.pointA=i.point,n.pointB=i.pointOther,n.normal=i.normal,n},t._createContactResult=function(e,t){var i=this.contactResultPool.allocate();return i.other=e,i.contacts=t,i},t._cleanOldCollisions=function(){for(var e in kp)if(kp.hasOwnProperty(e)){for(var t=Lp[e],i=kp[e],n=i.entity,a=n.collision,s=n.rigidbody,r=i.others,o=r.length;o--;){var l=r[o];(!t||t.others.indexOf(l)<0)&&(r.splice(o,1),n.trigger?(a&&a.fire("triggerleave",l),l.rigidbody&&l.rigidbody.fire("triggerleave",n)):l.trigger||(s&&s.fire("collisionend",l),a&&a.fire("collisionend",l)))}0===r.length&&delete kp[e]}},t._hasContactEvent=function(e){var t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return!0;var i=e.rigidbody;return i&&(i.hasEvent("collisionstart")||i.hasEvent("collisionend")||i.hasEvent("contact"))},t._checkForCollisions=function(e,t){var i=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),n=i.getNumManifolds();Lp={};for(var a=0;a<n;a++){var s=i.getManifoldByIndexInternal(a),r=s.getBody0(),o=s.getBody1(),l=Ammo.castObject(r,Ammo.btRigidBody),h=Ammo.castObject(o,Ammo.btRigidBody),c=l.entity,u=h.entity;if(c&&u){var d=l.getCollisionFlags(),p=h.getCollisionFlags(),f=s.getNumContacts(),m=[],v=[],g=void 0;if(0<f)if(4&d||4&p){var _=c.collision&&(c.collision.hasEvent("triggerenter")||c.collision.hasEvent("triggerleave")),y=u.collision&&(u.collision.hasEvent("triggerenter")||u.collision.hasEvent("triggerleave")),b=c.rigidbody&&(c.rigidbody.hasEvent("triggerenter")||c.rigidbody.hasEvent("triggerleave")),x=u.rigidbody&&(u.rigidbody.hasEvent("triggerenter")||u.rigidbody.hasEvent("triggerleave"));_&&(!(g=this._storeCollision(c,u))||4&p||c.collision.fire("triggerenter",u)),y&&(!(g=this._storeCollision(u,c))||4&d||u.collision.fire("triggerenter",c)),b&&(g||(g=this._storeCollision(u,c)),g&&c.rigidbody.fire("triggerenter",u)),x&&(g||(g=this._storeCollision(c,u)),g&&u.rigidbody.fire("triggerenter",c))}else{var M=this._hasContactEvent(c),S=this._hasContactEvent(u),w=this.hasEvent("contact");if(w||M||S){for(var C=0;C<f;C++){var P=s.getContactPoint(C),T=this._createContactPointFromAmmo(P);if(M||S){m.push(T);var A=this._createReverseContactPointFromAmmo(P);v.push(A)}if(w){var E=this._createSingleContactResult(c,u,T);this.fire("contact",E)}}if(M){var R=this._createContactResult(u,m);g=this._storeCollision(c,u),c.collision&&(c.collision.fire("contact",R),g&&c.collision.fire("collisionstart",R)),c.rigidbody&&(c.rigidbody.fire("contact",R),g&&c.rigidbody.fire("collisionstart",R))}if(S){var D=this._createContactResult(c,v);g=this._storeCollision(u,c),u.collision&&(u.collision.fire("contact",D),g&&u.collision.fire("collisionstart",D)),u.rigidbody&&(u.rigidbody.fire("contact",D),g&&u.rigidbody.fire("collisionstart",D))}}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()},t.onUpdate=function(e){var t,i,n=this.dynamicsWorld.getGravity();n.x()===this.gravity.x&&n.y()===this.gravity.y&&n.z()===this.gravity.z||(n.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(n));var a=this._triggers;for(t=0,i=a.length;t<i;t++)a[t].updateTransform();var s=this._compounds;for(t=0,i=s.length;t<i;t++)s[t]._updateCompound();var r=this._kinematic;for(t=0,i=r.length;t<i;t++)r[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);var o=this._dynamic;for(t=0,i=o.length;t<i;t++)o[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e)},t.destroy=function(){"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null)},e}(qh);Xh._buildAccessors(Dp.prototype,Vp);var Np="none",Gp=new pe,Wp=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._resolution=new J(640,320),i._referenceResolution=new J(640,320),i._scaleMode=Np,i.scale=1,i._scaleBlend=.5,i._priority=0,i._screenSpace=!1,i.cull=i._screenSpace,i._screenMatrix=new pe,i._elements=new Set,e.app.graphicsDevice.on("resizecanvas",i._onResize,g(i)),i}u(e,n);var t=e.prototype;return t.syncDrawOrder=function(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)},t._recurseDrawOrderSync=function(e,t){if(!(e instanceof Cr))return t;if(e.element){var i=e.element.drawOrder;e.element.drawOrder=t++,0<=e.element._batchGroupId&&i!==e.element.drawOrder&&this.system.app.batcher.markGroupDirty(e.element._batchGroupId)}e.particlesystem&&(e.particlesystem.drawOrder=t++);for(var n=e.children,a=0;a<n.length;a++)t=this._recurseDrawOrderSync(n[a],t);return t},t._processDrawOrderSync=function(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")},t._calcProjectionMatrix=function(){var e,t,i=this._resolution.x/this.scale,n=this._resolution.y/this.scale;e=i,t=-n,this._screenMatrix.setOrtho(0,e,t,0,1,-1),this._screenSpace||(Gp.setScale(.5*i,.5*n,1),this._screenMatrix.mul2(Gp,this._screenMatrix))},t._updateScale=function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},t._calcScale=function(e,t){var i=Math.log2(e.x/t.x),n=Math.log2(e.y/t.y);return Math.pow(2,i*(1-this._scaleBlend)+n*this._scaleBlend)},t._onResize=function(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution)},t._bindElement=function(e){this._elements.add(e)},t._unbindElement=function(e){this._elements.delete(e)},t.onRemove=function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach(function(e){return e._onScreenRemove()}),this._elements.clear(),this.off()},c(e,[{key:"resolution",get:function(){return this._resolution},set:function(e){var t=this;this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach(function(e){return e._onScreenResize(t._resolution)})}},{key:"referenceResolution",get:function(){return this._scaleMode===Np?this._resolution:this._referenceResolution},set:function(e){var t=this;this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach(function(e){return e._onScreenResize(t._resolution)})}},{key:"screenSpace",get:function(){return this._screenSpace},set:function(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach(function(e){return e._onScreenSpaceChange()})}},{key:"scaleMode",get:function(){return this._scaleMode},set:function(e){e!==Np&&"blend"!==e&&(e=Np),this._screenSpace||e===Np||(e=Np),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}},{key:"scaleBlend",get:function(){return this._scaleBlend},set:function(e){var t=this;this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach(function(e){return e._onScreenResize(t._resolution)})}},{key:"priority",get:function(){return this._priority},set:function(e){255<e&&(e=255),this._priority=e}}]),e}(Xh),Hp=function(){this.enabled=!0},jp=["enabled"],Xp=function(n){function e(e){var t;return(t=n.call(this,e)||this).id="screen",t.ComponentType=Wp,t.DataType=Hp,t.schema=jp,t.windowResolution=new J,t._drawOrderSyncQueue=new U,t.app.graphicsDevice.on("resizecanvas",t._onResize,g(t)),qh.bind("update",t._onUpdate,g(t)),t.on("beforeremove",t.onRemoveComponent,g(t)),t}u(e,n);var t=e.prototype;return t.initializeComponentData=function(e,t,i){void 0!==t.priority&&(e.priority=t.priority),void 0!==t.screenSpace&&(e.screenSpace=t.screenSpace),e.cull=e.screenSpace,void 0!==t.scaleMode&&(e.scaleMode=t.scaleMode),void 0!==t.scaleBlend&&(e.scaleBlend=t.scaleBlend),void 0!==t.resolution&&(t.resolution instanceof J?e._resolution.copy(t.resolution):e._resolution.set(t.resolution[0],t.resolution[1]),e.resolution=e._resolution),void 0!==t.referenceResolution&&(t.referenceResolution instanceof J?e._referenceResolution.copy(t.referenceResolution):e._referenceResolution.set(t.referenceResolution[0],t.referenceResolution[1]),e.referenceResolution=e._referenceResolution),e.syncDrawOrder(),n.prototype.initializeComponentData.call(this,e,t,i)},t.destroy=function(){this.off(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this)},t._onUpdate=function(e){var t=this.store;for(var i in t)t[i].entity.screen.update&&t[i].entity.screen.update(e)},t._onResize=function(e,t){this.windowResolution.x=e,this.windowResolution.y=t},t.cloneComponent=function(e,t){var i=e.screen;return this.addComponent(t,{enabled:i.enabled,screenSpace:i.screenSpace,scaleMode:i.scaleMode,resolution:i.resolution.clone(),referenceResolution:i.referenceResolution.clone()})},t.onRemoveComponent=function(e,t){t.onRemove()},t.processDrawOrderSyncQueue=function(){for(var e=this._drawOrderSyncQueue.list(),t=0;t<e.length;t++){var i=e[t];i.callback.call(i.scope)}this._drawOrderSyncQueue.clear()},t.queueDrawOrderSync=function(e,t,i){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:i})},e}(qh);Xh._buildAccessors(Wp.prototype,jp);var qp=["x","y","z","w"],$p=[void 0,void 0,J,de,ee];function Yp(e,t,i,n){var a,s;switch(t.type){case"boolean":return!!i;case"number":if("number"==typeof i)return i;if("string"==typeof i){var r=parseInt(i,10);return isNaN(r)?null:r}return"boolean"==typeof i?0+i:null;case"json":var o={};if(Array.isArray(t.schema))for(i&&"object"==(void 0===i?"undefined":dx(i))||(i={}),a=0;a<t.schema.length;a++){var l=t.schema[a];if(l.name)if(l.array){o[l.name]=[];var h=Array.isArray(i[l.name])?i[l.name]:[];for(s=0;s<h.length;s++)o[l.name].push(Yp(e,l,h[s]))}else{var c=i.hasOwnProperty(l.name)?i[l.name]:l.default;o[l.name]=Yp(e,l,c)}}return o;case"asset":return i instanceof Kr?i:"number"==typeof i?e.assets.get(i)||null:"string"==typeof i&&e.assets.get(parseInt(i,10))||null;case"entity":return i instanceof mn?i:"string"==typeof i?e.getEntityFromIndex(i):null;case"rgb":case"rgba":if(i instanceof $)return n instanceof $?(n.copy(i),n):i.clone();if(i instanceof Array&&3<=i.length&&i.length<=4){for(a=0;a<i.length;a++)if("number"!=typeof i[a])return null;return n||(n=new $),n.r=i[0],n.g=i[1],n.b=i[2],n.a=3===i.length?1:i[3],n}return"string"==typeof i&&/#([0-9abcdef]{2}){3,4}/i.test(i)?(n||(n=new $),n.fromString(i),n):null;case"vec2":case"vec3":case"vec4":var u=parseInt(t.type.slice(3),10),d=$p[u];if(i instanceof d)return n instanceof d?(n.copy(i),n):i.clone();if(i instanceof Array&&i.length===u){for(a=0;a<i.length;a++)if("number"!=typeof i[a])return null;for(n||(n=new d),a=0;a<u;a++)n[qp[a]]=i[a];return n}return null;case"curve":var p;if(i)return i instanceof K||i instanceof Z?p=i.clone():(p=new(i.keys[0]instanceof Array?Z:K)(i.keys)).type=i.type,p}return i}var Kp=function(){function e(e){this.scriptType=e,this.index={}}var t=e.prototype;return t.add=function(r,o){this.index[r]||e.reservedNames.has(r)||(this.index[r]=o,Object.defineProperty(this.scriptType.prototype,r,{get:function(){return this.__attributes[r]},set:function(e){var t,i,n="attr:"+r,a=this.__attributes[r],s=a;if(a&&"json"!==o.type&&a.clone&&(this._callbacks.attr||this._callbacks[n])&&(s=a.clone()),o.array){if(this.__attributes[r]=[],e)for(t=0,i=e.length;t<i;t++)this.__attributes[r].push(Yp(this.app,o,e[t],a?a[t]:null))}else this.__attributes[r]=Yp(this.app,o,e,a);this.fire("attr",r,this.__attributes[r],s),this.fire(n,this.__attributes[r],s)}}))},t.remove=function(e){return!!this.index[e]&&(delete this.index[e],delete this.scriptType.prototype[e],!0)},t.has=function(e){return!!this.index[e]},t.get=function(e){return this.index[e]||null},e}();Kp.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","has","get","on","off","fire","once","hasEvent"]);var Zp=function(n){function l(e,t){var i;return(i=n.call(this,e,t)||this)._scripts=[],i._updateList=new N({sortBy:"__executionOrder"}),i._postUpdateList=new N({sortBy:"__executionOrder"}),i._scriptsIndex={},i._destroyedScripts=[],i._destroyed=!1,i._scriptsData=null,i._oldState=!0,i._enabled=!0,i._beingEnabled=!1,i._isLoopingThroughScripts=!1,i._executionOrder=-1,i.on("set_enabled",i._onSetEnabled,g(i)),i}u(l,n);var e=l.prototype;return e.onEnable=function(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1},e.onDisable=function(){this._checkState()},e.onPostStateChange=function(){for(var e,t=this._beginLooping(),i=0,n=this.scripts.length;i<n;i++)(e=this.scripts[i])._initialized&&!e._postInitialized&&e.enabled&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,l.scriptMethods.postInitialize));this._endLooping(t)},e._beginLooping=function(){var e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e},e._endLooping=function(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts()},e._onSetEnabled=function(e,t,i){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1},e._checkState=function(){var e=this.enabled&&this.entity.enabled;if(e!==this._oldState){this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);for(var t,i=this._beginLooping(),n=0,a=this.scripts.length;n<a;n++)(t=this.scripts[n]).enabled=t._enabled;this._endLooping(i)}},e._onBeforeRemove=function(){this.fire("remove");for(var e=this._beginLooping(),t=0;t<this.scripts.length;t++){var i=this.scripts[t];i&&this.destroy(i.__scriptType.__name)}this._endLooping(e)},e._removeDestroyedScripts=function(){var e=this._destroyedScripts.length;if(e){var t;for(t=0;t<e;t++){var i=this._destroyedScripts[t];this._removeScriptInstance(i)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}},e._onInitializeAttributes=function(){for(var e=0,t=this.scripts.length;e<t;e++)this.scripts[e].__initializeAttributes()},e._scriptMethod=function(e,t,i){e[t](i)},e._onInitialize=function(){for(var e,t=this._scripts,i=this._beginLooping(),n=0,a=t.length;n<a;n++)!(e=t[n])._initialized&&e.enabled&&(e._initialized=!0,e.initialize&&this._scriptMethod(e,l.scriptMethods.initialize));this._endLooping(i)},e._onPostInitialize=function(){this.onPostStateChange()},e._onUpdate=function(e){var t=this._updateList;if(t.length){var i,n=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)(i=t.items[t.loopIndex]).enabled&&this._scriptMethod(i,l.scriptMethods.update,e);this._endLooping(n)}},e._onPostUpdate=function(e){var t=this._postUpdateList;if(t.length){var i,n=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)(i=t.items[t.loopIndex]).enabled&&this._scriptMethod(i,l.scriptMethods.postUpdate,e);this._endLooping(n)}},e._insertScriptInstance=function(e,t,i){-1===t?(this._scripts.push(e),e.__executionOrder=i,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,i+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))},e._removeScriptInstance=function(e){var t=this._scripts.indexOf(e);return-1===t||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t},e._resetExecutionOrder=function(e,t){for(var i=e;i<t;i++)this._scripts[i].__executionOrder=i},e._resolveEntityScriptAttribute=function(e,t,i,n,a,s){if(e.array){var r=i.length;if(!r)return;for(var o=i.slice(),l=0;l<r;l++){var h=o[l]instanceof Cr?o[l].getGuid():o[l];s[h]&&(o[l]=n?s[h].getGuid():s[h])}a[t]=o}else{if(i instanceof Cr)i=i.getGuid();else if("string"!=typeof i)return;s[i]&&(a[t]=s[i])}},e.has=function(e){if("string"==typeof e)return!!this._scriptsIndex[e];if(!e)return!1;var t=e,i=t.__name,n=this._scriptsIndex[i];return(n&&n.instance)instanceof t},e.get=function(e){if("string"==typeof e){var t=this._scriptsIndex[e];return t?t.instance:null}if(!e)return null;var i=e,n=i.__name,a=this._scriptsIndex[n],s=a&&a.instance;return s instanceof i?s:null},e.create=function(e,t){void 0===t&&(t={});var i=this,n=e,a=e;if("string"==typeof n?n=this.system.app.scripts.get(n):n&&(a=n.__name),n){if(!this._scriptsIndex[a]||!this._scriptsIndex[a].instance){var s=new n({app:this.system.app,entity:this.entity,enabled:!t.hasOwnProperty("enabled")||t.enabled,attributes:t.attributes}),r=this._scripts.length,o=-1;return"number"==typeof t.ind&&-1!==t.ind&&r>t.ind&&(o=t.ind),this._insertScriptInstance(s,o,r),this._scriptsIndex[a]={instance:s,onSwap:function(){i.swap(a)}},this[a]=s,t.preloading||s.__initializeAttributes(),this.fire("create",a,s),this.fire("create:"+a,s),this.system.app.scripts.on("swap:"+a,this._scriptsIndex[a].onSwap),t.preloading||(s.enabled&&!s._initialized&&(s._initialized=!0,s.initialize&&this._scriptMethod(s,l.scriptMethods.initialize)),s.enabled&&!s._postInitialized&&(s._postInitialized=!0,s.postInitialize&&this._scriptMethod(s,l.scriptMethods.postInitialize))),s}}else this._scriptsIndex[a]={awaiting:!0,ind:this._scripts.length};return null},e.destroy=function(e){var t=e,i=e;"string"==typeof i?i=this.system.app.scripts.get(i):i&&(t=i.__name);var n=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!n)return!1;var a=n.instance;if(a&&!a._destroyed)if(a.enabled=!1,a._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(a);else{var s=this._removeScriptInstance(a);0<=s&&this._resetExecutionOrder(s,this._scripts.length)}return this.system.app.scripts.off("swap:"+t,n.onSwap),delete this[t],this.fire("destroy",t,a||null),this.fire("destroy:"+t,a||null),a&&a.fire("destroy"),!0},e.swap=function(e){var t=e,i=e;"string"==typeof i?i=this.system.app.scripts.get(i):i&&(t=i.__name);var n=this._scriptsIndex[t];if(!n||!n.instance)return!1;var a=n.instance,s=this._scripts.indexOf(a),r=new i({app:this.system.app,entity:this.entity,enabled:a.enabled,attributes:a.__attributes});return!!r.swap&&(r.__initializeAttributes(),this._scripts[s]=r,this._scriptsIndex[t].instance=r,(this[t]=r).__executionOrder=s,a.update&&this._updateList.remove(a),a.postUpdate&&this._postUpdateList.remove(a),r.update&&this._updateList.insert(r),r.postUpdate&&this._postUpdateList.insert(r),this._scriptMethod(r,l.scriptMethods.swap,a),this.fire("swap",t,r),this.fire("swap:"+t,r),!0)},e.resolveDuplicatedEntityReferenceProperties=function(e,t){var i,n,a=this.entity.script;for(var s in e._scriptsIndex){var r=this.system.app.scripts.get(s);if(r){var o=e._scriptsIndex[s];if(o&&o.instance){var l=a[s].__attributesRaw,h=a[s].__attributes;if(l||h){var c=!!l,u=o.instance.__attributes;for(var d in u)if(u[d]){var p=r.attributes.get(d);if(p)if("entity"===p.type)this._resolveEntityScriptAttribute(p,d,u[d],c,l||h,t);else if("json"===p.type&&Array.isArray(p.schema)){var f=u[d],m=l?l[d]:h[d];for(i=0;i<p.schema.length;i++){var v=p.schema[i];if("entity"===v.type)if(p.array)for(n=0;n<f.length;n++)this._resolveEntityScriptAttribute(v,v.name,f[n][v.name],c,m[n],t);else this._resolveEntityScriptAttribute(v,v.name,f[v.name],c,m,t)}}}}}}}},e.move=function(e,t){var i=this._scripts.length;if(i<=t||t<0)return!1;var n=e,a=e;"string"!=typeof a?a=e.__name:n=null;var s=this._scriptsIndex[a];if(!s||!s.instance)return!1;var r=s.instance;if(n&&!(r instanceof n))return!1;var o=this._scripts.indexOf(r);return-1!==o&&o!==t&&(this._scripts.splice(t,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,i),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",a,r,t,o),this.fire("move:"+a,r,t,o),!0)},c(l,[{key:"enabled",get:function(){return this._enabled},set:function(e){var t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}},{key:"scripts",get:function(){return this._scripts},set:function(e){for(var t in this._scriptsData=e)if(e.hasOwnProperty(t)){var i=this._scriptsIndex[t];if(i&&("boolean"==typeof e[t].enabled&&(i.enabled=!!e[t].enabled),"object"==dx(e[t].attributes)))for(var n in e[t].attributes)if(!Kp.reservedNames.has(n)){if(!i.__attributes.hasOwnProperty(n)){var a=this.system.app.scripts.get(t);a&&a.attributes.add(n,{})}i[n]=e[t].attributes[n]}}}}]),l}(Xh);Zp.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};var Qp=function(){this.enabled=!0},Jp=0,ef=function(i){function e(e){var t;return(t=i.call(this,e)||this).id="script",t.ComponentType=Zp,t.DataType=Qp,t._components=new N({sortBy:"_executionOrder"}),t._enabledComponents=new N({sortBy:"_executionOrder"}),t.preloading=!0,t.on("beforeremove",t._onBeforeRemove,g(t)),qh.bind("initialize",t._onInitialize,g(t)),qh.bind("postInitialize",t._onPostInitialize,g(t)),qh.bind("update",t._onUpdate,g(t)),qh.bind("postUpdate",t._onPostUpdate,g(t)),t}u(e,i);var t=e.prototype;return t.initializeComponentData=function(e,t){if(e._executionOrder=Jp++,this._components.append(e),Jp>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(var i=0;i<t.order.length;i++)e.create(t.order[i],{enabled:t.scripts[t.order[i]].enabled,attributes:t.scripts[t.order[i]].attributes,preloading:this.preloading})}},t.cloneComponent=function(e,t){var i,n,a=[],s={};for(i=0;i<e.script._scripts.length;i++){var r=e.script._scripts[i],o=r.__scriptType.__name;a.push(o);var l={};for(n in r.__attributes)l[n]=r.__attributes[n];s[o]={enabled:r._enabled,attributes:l}}for(n in e.script._scriptsIndex)n.awaiting&&a.splice(n.ind,0,n);var h={enabled:e.script.enabled,order:a,scripts:s};return this.addComponent(t,h)},t._resetExecutionOrder=function(){for(var e=Jp=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=Jp++},t._callComponentMethod=function(e,t,i){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](i)},t._onInitialize=function(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")},t._onPostInitialize=function(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")},t._onUpdate=function(e){this._callComponentMethod(this._enabledComponents,"_onUpdate",e)},t._onPostUpdate=function(e){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",e)},t._addComponentToEnabled=function(e){this._enabledComponents.insert(e)},t._removeComponentFromEnabled=function(e){this._enabledComponents.remove(e)},t._onBeforeRemove=function(e,t){0<=this._components.items.indexOf(t)&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t)},e}(qh),tf=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this).on("set_scripts",i.onSetScripts,g(i)),i}u(e,n);var t=e.prototype;return t.send=function(e,t){var i,n=Array.prototype.slice.call(arguments,2),a=this.entity.script.instances;if(a&&a[e]&&(i=a[e].instance[t]))return i.apply(a[e].instance,n)},t.onEnable=function(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},t.onDisable=function(){this.system._disableScriptComponent(this)},t.onSetScripts=function(e,t,i){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(t,i))return;this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1;var n=i.map(function(e){return e.url});if(this._loadFromCache(n))return;this._loadScripts(n)}},t._updateScriptAttributes=function(e,t){var i=!0;if(e.length!==t.length)i=!1;else{var n,a=t.length;for(n=0;n<a;n++)if(e[n].url!==t[n].url){i=!1;break}}if(i)for(var s in this.instances)this.instances.hasOwnProperty(s)&&this.system._updateAccessors(this.entity,this.instances[s]);return i},t._loadFromCache=function(e){var t,i,n=[],a=this.system.app._scriptPrefix||"",s=/^http(s)?:\/\//i;for(t=0,i=e.length;t<i;t++){var r=e[t];s.test(r)||(r=C.join(a,r));var o=this.system.app.loader.getFromCache(r,"script");if(!o)return!1;n.push(o)}for(t=0,i=n.length;t<i;t++){var l=n[t];if(!0!==l&&l&&this.entity.script&&!this.entity.script.instances[l._pcScriptName]){var h=new l(this.entity);this.system._preRegisterInstance(this.entity,e[t],l._pcScriptName,h)}}return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0},t._loadScripts=function(e){var a=e.length,i=this.system.app._scriptPrefix||"";e.forEach(function(e){var t=null,n=null;e.toLowerCase().startsWith("http://")||e.toLowerCase().startsWith("https://")?t=n=e:(n=e,t=C.join(i,e)),this.system.app.loader.load(t,"script",function(e,t){if(a--,e);else if(t&&this.entity.script&&!this.entity.script.instances[t._pcScriptName]){var i=new t(this.entity);this.system._preRegisterInstance(this.entity,n,t._pcScriptName,i)}0===a&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))},e}(Xh),nf=function(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.initialized=!1,this.postInitialized=!1,this.areScriptsLoaded=!1},af=["enabled","scripts","instances","runInTools"],sf="initialize",rf="postInitialize",of="postUpdate",lf="fixedUpdate",hf="toolsUpdate",cf=function(n){function e(e){var t;return(t=n.call(this,e)||this).id="script",t.ComponentType=tf,t.DataType=nf,t.schema=af,t.preloading=!1,t.instancesWithUpdate=[],t.instancesWithFixedUpdate=[],t.instancesWithPostUpdate=[],t.instancesWithToolsUpdate=[],t.on("beforeremove",t.onBeforeRemove,g(t)),qh.bind(sf,t.onInitialize,g(t)),qh.bind(rf,t.onPostInitialize,g(t)),qh.bind("update",t.onUpdate,g(t)),qh.bind(lf,t.onFixedUpdate,g(t)),qh.bind(of,t.onPostUpdate,g(t)),qh.bind(hf,t.onToolsUpdate,g(t)),t}u(e,n);var t=e.prototype;return t.initializeComponentData=function(e,t,i){i=["runInTools","enabled","scripts"],t.scripts&&t.scripts.length&&t.scripts.forEach(function(e){if(e.attributes&&Array.isArray(e.attributes)){for(var t={},i=0;i<e.attributes.length;i++)t[e.attributes[i].name]=e.attributes[i];e.attributes=t}}),n.prototype.initializeComponentData.call(this,e,t,i)},t.cloneComponent=function(e,t){for(var i=this.store[e.getGuid()],n={runInTools:i.data.runInTools,scripts:[],enabled:i.data.enabled},a=i.data.scripts,s=0,r=a.length;s<r;s++){var o=a[s].attributes;o&&delete a[s].attributes,n.scripts.push(v({},a[s])),o&&(n.scripts[s].attributes=this._cloneAttributes(o),a[s].attributes=o)}return this.addComponent(t,n)},t.onBeforeRemove=function(e,t){t.enabled&&this._disableScriptComponent(t),this._destroyScriptComponent(t)},t.onInitialize=function(e){if(this._registerInstances(e),e.enabled){e.script&&e.script.enabled&&this._initializeScriptComponent(e.script);var t,i=e._children,n=i.length;for(t=0;t<n;t++)i[t]instanceof Cr&&this.onInitialize(i[t])}},t.onPostInitialize=function(e){if(e.enabled){e.script&&e.script.enabled&&this._postInitializeScriptComponent(e.script);var t,i=e._children,n=i.length;for(t=0;t<n;t++)i[t]instanceof Cr&&this.onPostInitialize(i[t])}},t._callInstancesMethod=function(e,t){var i=e.data.instances;for(var n in i)if(i.hasOwnProperty(n)){var a=i[n].instance;a[t]&&a[t]()}},t._initializeScriptComponent=function(e){this._callInstancesMethod(e,sf),e.data.initialized=!0,e.enabled&&e.entity.enabled&&this._enableScriptComponent(e)},t._enableScriptComponent=function(e){this._callInstancesMethod(e,"onEnable")},t._disableScriptComponent=function(e){this._callInstancesMethod(e,"onDisable")},t._destroyScriptComponent=function(e){var t,i=e.data.instances;for(var n in i)if(i.hasOwnProperty(n)){var a=i[n].instance;a.destroy&&a.destroy(),a.update&&0<=(t=this.instancesWithUpdate.indexOf(a))&&this.instancesWithUpdate.splice(t,1),a.fixedUpdate&&0<=(t=this.instancesWithFixedUpdate.indexOf(a))&&this.instancesWithFixedUpdate.splice(t,1),a.postUpdate&&0<=(t=this.instancesWithPostUpdate.indexOf(a))&&this.instancesWithPostUpdate.splice(t,1),a.toolsUpdate&&0<=(t=this.instancesWithToolsUpdate.indexOf(a))&&this.instancesWithToolsUpdate.splice(t,1),e.instances[n].instance===e[n]&&delete e[n],delete e.instances[n]}},t._postInitializeScriptComponent=function(e){this._callInstancesMethod(e,rf),e.data.postInitialized=!0},t._updateInstances=function(e,t,i){for(var n,a=0,s=t.length;a<s;a++)(n=t[a])&&n.entity&&n.entity.enabled&&n.entity.script.enabled&&n[e](i)},t.onUpdate=function(e){this._updateInstances("update",this.instancesWithUpdate,e)},t.onFixedUpdate=function(e){this._updateInstances(lf,this.instancesWithFixedUpdate,e)},t.onPostUpdate=function(e){this._updateInstances(of,this.instancesWithPostUpdate,e)},t.onToolsUpdate=function(e){this._updateInstances(hf,this.instancesWithToolsUpdate,e)},t.broadcast=function(e,t){var i,n,a,s=Array.prototype.slice.call(arguments,2),r=this.store;for(i in r)r.hasOwnProperty(i)&&(n=r[i].data).instances[e]&&(a=n.instances[e].instance[t])&&a.apply(n.instances[e].instance,s)},t._preRegisterInstance=function(e,t,i,n){if(e.script){if(e.script.data._instances=e.script.data._instances||{},e.script.data._instances[i])throw Error("Script name collision '"+i+"'. Scripts from '"+t+"' and '"+e.script.data._instances[i].url+"' {"+e.getGuid()+"}");e.script.data._instances[i]={url:t,name:i,instance:n}}},t._registerInstances=function(e){var t,i,n;if(e.script&&e.script.data._instances){for(n in e.script.instances=e.script.data._instances,e.script.instances){if(i=(t=e.script.instances[n]).instance,f.attach(i),i.update&&this.instancesWithUpdate.push(i),i.fixedUpdate&&this.instancesWithFixedUpdate.push(i),i.postUpdate&&this.instancesWithPostUpdate.push(i),i.toolsUpdate&&this.instancesWithToolsUpdate.push(i),e.script.scripts&&this._createAccessors(e,t),e.script[n])throw Error("Script with name '"+n+"' is already attached to Script Component");e.script[n]=i}delete e.script.data._instances}var a,s=e._children,r=s.length;for(a=0;a<r;a++)s[a]instanceof Cr&&this._registerInstances(s[a])},t._cloneAttributes=function(e){var t={};for(var i in e)if(e.hasOwnProperty(i))if("entity"!==e[i].type)t[i]=v({},e[i]);else{var n=e[i].value;delete e[i].value,t[i]=v({},e[i]),t[i].value=n,e[i].value=n}return t},t._createAccessors=function(e,t){var i,n=e.script.scripts.length,a=t.url;for(i=0;i<n;i++){var s=e.script.scripts[i];if(s.url===a){var r=s.attributes;if(s.name&&r){for(var o in r)r.hasOwnProperty(o)&&this._createAccessor(r[o],t);e.script.data.attributes[s.name]=this._cloneAttributes(r)}break}}},t._createAccessor=function(i,n){var a=this;i={name:i.name,value:i.value,type:i.type},a._convertAttributeValue(i),Object.defineProperty(n.instance,i.name,{get:function(){return i.value},set:function(e){var t=i.value;i.value=e,a._convertAttributeValue(i),n.instance.fire("set",i.name,t,i.value)},configurable:!0})},t._updateAccessors=function(e,t){var i,n,a,s,r,o,l,h,c=e.script.scripts.length,u=t.url;for(i=0;i<c;i++)if((s=(a=e.script).scripts[i]).url===u){if(r=s.name,o=s.attributes,r){if(o)for(n in o)o.hasOwnProperty(n)&&this._createAccessor(o[n],t);if(l=a.data.attributes[r])for(n in l)h=l[n],n in o?o[n].value!==h.value&&t.instance.onAttributeChanged&&t.instance.onAttributeChanged(h.name,h.value,o[n].value):delete t.instance[h.name];o?a.data.attributes[r]=this._cloneAttributes(o):delete a.data.attributes[r]}break}},t._convertAttributeValue=function(e){if("rgb"===e.type||"rgba"===e.type)Array.isArray(e.value)&&(e.value=3===e.value.length?new $(e.value[0],e.value[1],e.value[2]):new $(e.value[0],e.value[1],e.value[2],e.value[3]));else if("vec2"===e.type)Array.isArray(e.value)&&(e.value=new J(e.value[0],e.value[1]));else if("vec3"===e.type||"vector"===e.type)Array.isArray(e.value)&&(e.value=new de(e.value[0],e.value[1],e.value[2]));else if("vec4"===e.type)Array.isArray(e.value)&&(e.value=new ee(e.value[0],e.value[1],e.value[2],e.value[3]));else if("entity"===e.type)null!==e.value&&"string"==typeof e.value&&(e.value=this.app.root.findByGuid(e.value));else if("curve"===e.type||"colorcurve"===e.type){var t=e.value.keys[0]instanceof Array?Z:K;e.value=new t(e.value.keys),e.value.type=e.value.type}},e}(qh);Xh._buildAccessors(tf.prototype,af);var uf=new J,df=new de,pf=new de,ff=new de,mf=new de,vf=new de,gf=new fe,_f={x:"y",y:"x"},yf=function(n){function e(e,t){var i;if(i=n.call(this)||this,!(e&&e instanceof hd))throw new Error("Element was null or not an ElementComponent");if(t&&"x"!==t&&"y"!==t)throw new Error("Unrecognized axis: "+t);return i._element=e,i._app=e.system.app,i._axis=t||null,i._enabled=!0,i._dragScale=new de,i._dragStartMousePosition=new de,i._dragStartHandlePosition=new de,i._deltaMousePosition=new de,i._deltaHandlePosition=new de,i._isDragging=!1,i._toggleLifecycleListeners("on"),i}u(e,n);var t=e.prototype;return t._toggleLifecycleListeners=function(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this)},t._toggleDragListeners=function(e){var t="on"===e,i=t?"addEventListener":"removeEventListener";this._hasDragListeners&&t||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[e]("mousemove",this._onMove,this),window[i]("mouseup",this._handleMouseUpOrTouchEnd,!1)),w&&(this._app.touch[e]("touchmove",this._onMove,this),window[i]("touchend",this._handleMouseUpOrTouchEnd,!1),window[i]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=t)},t._onMouseDownOrTouchStart=function(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();var t=this._screenToLocal(e);t&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}},t._onMouseUpOrTouchEnd=function(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))},t._screenToLocal=function(e){this._determineInputPosition(e),this._chooseRayOriginAndDirection(),mf.copy(this._element.entity.getPosition()),vf.copy(this._element.entity.forward).mulScalar(-1);var t=vf.dot(ff);if(0<Math.abs(t)){var i=mf.sub(pf).dot(vf)/t,n=pf.add(ff.mulScalar(i));return gf.copy(this._element.entity.getRotation()).invert().transformVector(n,n),n.mul(this._dragScale),n}return null},t._determineInputPosition=function(e){var t=this._app.graphicsDevice.maxPixelRatio;void 0!==e.x&&void 0!==e.y?(uf.x=e.x*t,uf.y=e.y*t):e.changedTouches&&(uf.x=e.changedTouches[0].x*t,uf.y=e.changedTouches[0].y*t)},t._chooseRayOriginAndDirection=function(){this._element.screen&&this._element.screen.screen.screenSpace?(pf.set(uf.x,-uf.y,0),ff.set(0,0,-1)):(df.copy(this._dragCamera.screenToWorld(uf.x,uf.y,1)),pf.copy(this._dragCamera.entity.getPosition()),ff.copy(df).sub(pf).normalize())},t._calculateDragScale=function(){var e=this._element.entity.parent,t=this._element.screen&&this._element.screen.screen,i=t&&t.screenSpace,n=i?t.scale:1,a=this._dragScale;for(a.set(n,n,n);e&&(a.mul(e.getLocalScale()),e=e.parent,!i||!e.screen););a.x=1/a.x,a.y=1/a.y,a.z=1/a.z},t._onMove=function(e){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled){var t=this._screenToLocal(e);if(this._dragStartMousePosition&&t){if(this._deltaMousePosition.copy(t).sub(this._dragStartMousePosition),this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition),this._axis){var i=this._element.entity.getLocalPosition(),n=_f[this._axis];this._deltaHandlePosition[n]=i[n]}this._element.entity.setLocalPosition(this._deltaHandlePosition),this.fire("drag:move",this._deltaHandlePosition)}}},t.destroy=function(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"isDragging",get:function(){return this._isDragging}}]),e}(p),bf=new J,xf=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._viewportReference=new Hc(g(i),"viewportEntity",{"element#gain":i._onViewportElementGain,"element#resize":i._onSetContentOrViewportSize}),i._contentReference=new Hc(g(i),"contentEntity",{"element#gain":i._onContentElementGain,"element#lose":i._onContentElementLose,"element#resize":i._onSetContentOrViewportSize}),i._scrollbarUpdateFlags={},i._scrollbarReferences={},i._scrollbarReferences[0]=new Hc(g(i),"horizontalScrollbarEntity",{"scrollbar#set:value":i._onSetHorizontalScrollbarValue,"scrollbar#gain":i._onHorizontalScrollbarGain}),i._scrollbarReferences[1]=new Hc(g(i),"verticalScrollbarEntity",{"scrollbar#set:value":i._onSetVerticalScrollbarValue,"scrollbar#gain":i._onVerticalScrollbarGain}),i._prevContentSizes={},i._prevContentSizes[0]=null,i._prevContentSizes[1]=null,i._scroll=new J,i._velocity=new de,i._dragStartPosition=new de,i._disabledContentInput=!1,i._disabledContentInputEntities=[],i._toggleLifecycleListeners("on",e),i._toggleElementListeners("on"),i}u(e,n);var t=e.prototype;return t._toggleLifecycleListeners=function(e,t){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)},t._toggleElementListeners=function(e){if(this.entity.element){if("on"===e&&this._hasElementListeners)return;this.entity.element[e]("resize",this._onSetContentOrViewportSize,this),this._hasElementListeners="on"===e}},t._onElementComponentAdd=function(e){this.entity===e&&this._toggleElementListeners("on")},t._onElementComponentRemove=function(e){this.entity===e&&this._toggleElementListeners("off")},t._onViewportElementGain=function(){this._syncAll()},t._onContentElementGain=function(){this._destroyDragHelper(),this._contentDragHelper=new yf(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll()},t._onContentElementLose=function(){this._destroyDragHelper()},t._onContentDragStart=function(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())},t._onContentDragEnd=function(){this._prevContentDragPosition=null,this._enableContentInput()},t._onContentDragMove=function(e){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){var t=e.x-this._dragStartPosition.x,i=e.y-this._dragStartPosition.y;(Math.abs(t)>this.dragThreshold||Math.abs(i)>this.dragThreshold)&&this._disableContentInput()}},t._onSetContentOrViewportSize=function(){this._syncAll()},t._onSetHorizontalScrollbarValue=function(e){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null)},t._onSetVerticalScrollbarValue=function(e){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e)},t._onSetHorizontalScrollingEnabled=function(){this._syncScrollbarEnabledState(0)},t._onSetVerticalScrollingEnabled=function(){this._syncScrollbarEnabledState(1)},t._onHorizontalScrollbarGain=function(){this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0)},t._onVerticalScrollbarGain=function(){this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1)},t._onSetScroll=function(e,t,i){!1!==i&&this._velocity.set(0,0,0);var n=!1;n|=this._updateAxis(e,"x",0),(n|=this._updateAxis(t,"y",1))&&this.fire("set:scroll",this._scroll)},t._updateAxis=function(e,t,i){var n=null!==e&&1e-5<Math.abs(e-this._scroll[t]);return(n||this._isDragging()||0===e)&&(this._scroll[t]=this._determineNewScrollValue(e,t,i),this._syncContentPosition(i),this._syncScrollbarPosition(i)),n},t._determineNewScrollValue=function(e,t,i){if(!this._getScrollingEnabled(i))return this._scroll[t];switch(this.scrollMode){case 0:return Se.clamp(e,0,this._getMaxScrollValue(i));case 1:return this._setVelocityFromOvershoot(e,t,i),e;case 2:default:return e}},t._syncAll=function(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1)},t._syncContentPosition=function(e){var t=this._getAxis(e),i=this._getSign(e),n=this._contentReference.entity;if(n){var a=this._prevContentSizes[e],s=this._getContentSize(e);if(null!==a&&1e-4<Math.abs(a-s)){var r=this._getMaxOffset(e,a),o=this._getMaxOffset(e,s);this._scroll[t]=0===o?1:Se.clamp(this._scroll[t]*r/o,0,1)}var l=this._scroll[t]*this._getMaxOffset(e),h=n.getLocalPosition();h[t]=l*i,n.setLocalPosition(h),this._prevContentSizes[e]=s}},t._syncScrollbarPosition=function(e){var t=this._getAxis(e),i=this._scrollbarReferences[e].entity;i&&i.scrollbar&&(this._scrollbarUpdateFlags[e]=!0,i.scrollbar.value=this._scroll[t],i.scrollbar.handleSize=this._getScrollbarHandleSize(t,e),this._scrollbarUpdateFlags[e]=!1)},t._syncScrollbarEnabledState=function(e){var t=this._scrollbarReferences[e].entity;if(t){var i=this._getScrollingEnabled(e),n=this._getScrollbarVisibility(e);switch(n){case 0:return void(t.enabled=i);case 1:return void(t.enabled=i&&this._contentIsLargerThanViewport(e));default:t.enabled=i}}},t._contentIsLargerThanViewport=function(e){return this._getContentSize(e)>this._getViewportSize(e)},t._contentPositionToScrollValue=function(e){var t=this._getMaxOffset(0),i=this._getMaxOffset(1);return bf.x=0===t?0:e.x/t,bf.y=0===i?0:e.y/-i,bf},t._getMaxOffset=function(e,t){t=void 0===t?this._getContentSize(e):t;var i=this._getViewportSize(e);return t<i?-this._getViewportSize(e):i-t},t._getMaxScrollValue=function(e){return this._contentIsLargerThanViewport(e)?1:0},t._getScrollbarHandleSize=function(e,t){var i=this._getViewportSize(t),n=this._getContentSize(t);if(Math.abs(n)<.001)return 1;var a=Math.min(i/n,1),s=this._toOvershoot(this._scroll[e],t);return 0===s?a:a/(1+Math.abs(s))},t._getViewportSize=function(e){return this._getSize(e,this._viewportReference)},t._getContentSize=function(e){return this._getSize(e,this._contentReference)},t._getSize=function(e,t){return t.entity&&t.entity.element?t.entity.element[this._getCalculatedDimension(e)]:0},t._getScrollingEnabled=function(e){return 0===e?this.horizontal:1===e?this.vertical:void 0},t._getScrollbarVisibility=function(e){return 0===e?this.horizontalScrollbarVisibility:1===e?this.verticalScrollbarVisibility:void 0},t._getSign=function(e){return 0===e?1:-1},t._getAxis=function(e){return 0===e?"x":"y"},t._getCalculatedDimension=function(e){return 0===e?"calculatedWidth":"calculatedHeight"},t._destroyDragHelper=function(){this._contentDragHelper&&this._contentDragHelper.destroy()},t.onUpdate=function(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))},t._updateVelocity=function(){if(!this._isDragging()&&(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction,1e-4<Math.abs(this._velocity.x)||1e-4<Math.abs(this._velocity.y))){var e=this._contentReference.entity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(e),this._setScrollFromContentPosition(e)}},t._hasOvershoot=function(e,t){return.001<Math.abs(this._toOvershoot(this.scroll[e],t))},t._toOvershoot=function(e,t){var i=this._getMaxScrollValue(t);return e<0?e:i<e?e-i:0},t._setVelocityFromOvershoot=function(e,t,i){var n=this._toOvershoot(e,i)*this._getMaxOffset(i)*this._getSign(i);0<Math.abs(n)&&(this._velocity[t]=-n/(50*this.bounceAmount+1))},t._setVelocityFromContentPositionDelta=function(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone())},t._setScrollFromContentPosition=function(e){var t=this._contentPositionToScrollValue(e);this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,!1)},t._applyScrollValueTension=function(e){var t,i;return t=this._getMaxScrollValue(0),0<(i=this._toOvershoot(e.x,0))?e.x=t+1*Math.log10(1+i):i<0&&(e.x=-1*Math.log10(1-i)),t=this._getMaxScrollValue(1),0<(i=this._toOvershoot(e.y,1))?e.y=t+1*Math.log10(1+i):i<0&&(e.y=-1*Math.log10(1-i)),e},t._isDragging=function(){return this._contentDragHelper&&this._contentDragHelper.isDragging},t._setScrollbarComponentsEnabled=function(e){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=e),this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=e)},t._setContentDraggingEnabled=function(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e)},t._enableContentInput=function(){for(;this._disabledContentInputEntities.length;){var e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1},t._disableContentInput=function(){var s=this,e=function e(t){t.element&&t.element.useInput&&(s._disabledContentInputEntities.push(t),t.element.useInput=!1);var i,n,a=t.children;for(i=0,n=a.length;i<n;i++)e(a[i])},t=this._contentReference.entity;if(t){var i,n=t.children,a=n.length;for(i=0;i<a;i++)e(n[i])}this._disabledContentInput=!0},t.onEnable=function(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[0].onParentComponentEnable(),this._scrollbarReferences[1].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()},t.onDisable=function(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)},t.onRemove=function(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()},c(e,[{key:"scroll",get:function(){return this._scroll},set:function(e){this._onSetScroll(e.x,e.y)}}]),e}(Xh),Mf=function(){this.enabled=!0},Sf=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],wf=function(n){function e(e){var t;return(t=n.call(this,e)||this).id="scrollview",t.ComponentType=xf,t.DataType=Mf,t.schema=Sf,t.on("beforeremove",t._onRemoveComponent,g(t)),qh.bind("update",t.onUpdate,g(t)),t}u(e,n);var t=e.prototype;return t.initializeComponentData=function(e,t,i){void 0===t.dragThreshold&&(t.dragThreshold=10),n.prototype.initializeComponentData.call(this,e,t,Sf)},t.onUpdate=function(e){var t=this.store;for(var i in t){var n=t[i].entity,a=n.scrollview;a.enabled&&n.enabled&&a.onUpdate()}},t._onRemoveComponent=function(e,t){t.onRemove()},e}(qh);Xh._buildAccessors(xf.prototype,Sf);var Cf=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._app=e.app,i._handleReference=new Hc(g(i),"handleEntity",{"element#gain":i._onHandleElementGain,"element#lose":i._onHandleElementLose,"element#set:anchor":i._onSetHandleAlignment,"element#set:margin":i._onSetHandleAlignment,"element#set:pivot":i._onSetHandleAlignment}),i._toggleLifecycleListeners("on"),i}u(e,n);var t=e.prototype;return t._toggleLifecycleListeners=function(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this)},t._onHandleElementGain=function(){this._destroyDragHelper(),this._handleDragHelper=new yf(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()},t._onHandleElementLose=function(){this._destroyDragHelper()},t._onHandleDrag=function(e){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]))},t._onSetValue=function(e,t,i){1e-5<Math.abs(i-t)&&(this.data.value=Se.clamp(i,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))},t._onSetHandleSize=function(e,t,i){1e-5<Math.abs(i-t)&&(this.data.handleSize=Se.clamp(i,0,1),this._updateHandlePositionAndSize())},t._onSetHandleAlignment=function(){this._updateHandlePositionAndSize()},t._onSetOrientation=function(e,t,i){i!==t&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)},t._updateHandlePositionAndSize=function(){var e=this._handleReference.entity,t=e&&e.element;if(e){var i=e.getLocalPosition();i[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(i)}t&&(t[this._getDimension()]=this._getHandleLength())},t._handlePositionToScrollValue=function(e){return e*this._getSign()/this._getUsableTrackLength()},t._scrollValueToHandlePosition=function(e){return e*this._getSign()*this._getUsableTrackLength()},t._getUsableTrackLength=function(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)},t._getTrackLength=function(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0},t._getHandleLength=function(){return this._getTrackLength()*this.handleSize},t._getHandlePosition=function(){return this._scrollValueToHandlePosition(this.value)},t._getSign=function(){return 0===this.orientation?1:-1},t._getAxis=function(){return 0===this.orientation?"x":"y"},t._getDimension=function(){return 0===this.orientation?"width":"height"},t._getOppositeDimension=function(){return 0===this.orientation?"height":"width"},t._destroyDragHelper=function(){this._handleDragHelper&&this._handleDragHelper.destroy()},t._setHandleDraggingEnabled=function(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e)},t.onEnable=function(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)},t.onDisable=function(){this._setHandleDraggingEnabled(!1)},t.onRemove=function(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")},e}(Xh),Pf=function(){this.enabled=!0},Tf=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}],Af=function(n){function e(e){var t;return(t=n.call(this,e)||this).id="scrollbar",t.ComponentType=Cf,t.DataType=Pf,t.schema=Tf,t.on("beforeremove",t._onRemoveComponent,g(t)),t}u(e,n);var t=e.prototype;return t.initializeComponentData=function(e,t,i){n.prototype.initializeComponentData.call(this,e,t,Tf)},t._onRemoveComponent=function(e,t){t.onRemove()},e}(qh);function Ef(e,t){return e%t||0}Xh._buildAccessors(Cf.prototype,Tf);var Rf=function(a){function e(e,t,i){var n;return(n=a.call(this)||this)._manager=e,n._volume=void 0!==i.volume?Se.clamp(Number(i.volume)||0,0,1):1,n._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,n._loop=!(void 0===i.loop||!i.loop),n._sound=t,n._state=2,n._suspended=!1,n._suspendEndEvent=!1,n._suspendInstanceEvents=!1,n._playWhenLoaded=!0,n._startTime=Math.max(0,Number(i.startTime)||0),n._duration=Math.max(0,Number(i.duration)||0),n._startOffset=null,n.source=null,n._onPlayCallback=i.onPlay,n._onPauseCallback=i.onPause,n._onResumeCallback=i.onResume,n._onStopCallback=i.onStop,n._onEndCallback=i.onEnd,cr()?(n._startedAt=0,n._currentTime=0,n._currentOffset=0,n._inputNode=null,n._connectorNode=null,n._firstNode=null,n._lastNode=null,n._initializeNodes(),n._endedHandler=n._onEnded.bind(g(n))):(n._isReady=!1,n._loadedMetadataHandler=n._onLoadedMetadata.bind(g(n)),n._timeUpdateHandler=n._onTimeUpdate.bind(g(n)),n._endedHandler=n._onEnded.bind(g(n)),n._createSource()),n}u(e,a);var t=e.prototype;return t._onPlay=function(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)},t._onPause=function(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)},t._onResume=function(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)},t._onStop=function(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)},t._onEnded=function(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())},t._onManagerVolumeChange=function(){this.volume=this._volume},t._onManagerSuspend=function(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())},t._onManagerResume=function(){this._suspended&&(this._suspended=!1,this.resume())},c(e,[{key:"loop",get:function(){return this._loop},set:function(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}},{key:"startTime",get:function(){return this._startTime},set:function(e){this._startTime=Math.max(0,Number(e)||0);var t=0===this._state;this.stop(),t&&this.play()}},{key:"duration",get:function(){return this._sound?this._duration?Ef(this._duration,this._sound.duration):this._sound.duration:0},set:function(e){this._duration=Math.max(0,Number(e)||0);var t=0===this._state;this.stop(),t&&this.play()}},{key:"isPlaying",get:function(){return 0===this._state}},{key:"isPaused",get:function(){return 1===this._state}},{key:"isStopped",get:function(){return 2===this._state}},{key:"isSuspended",get:function(){return this._suspended}}]),e}(p);cr()?(Object.assign(Rf.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&this.stop(),this.source||this._createSource();var e=Ef(this._startOffset,this.duration);return e=Ef(this._startTime+e,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this._state=0,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0},pause:function(){return this._playWhenLoaded=!1,!(0!==this._state||!this.source||(this._updateCurrentTime(),this._state=1,this._suspendEndEvent=!0,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),0))},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();var e=this.currentTime;return null!==this._startOffset&&(e=Ef(this._startOffset,this.duration),e=Ef(this._startTime+e,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._state=0,this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0},stop:function(){return this._playWhenLoaded=!1,!(2===this._state||!this.source||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent=!0,0===this._state&&this.source.stop(0),this.source=null,this._state=2,this._suspendInstanceEvents||this._onStop(),0))},setExternalNodes:function(e,t){if(e){t||(t=e);var i=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(i),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(i),this._lastNode=t,this._lastNode.connect(i))}},clearExternalNodes:function(){var e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;var e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=Ef(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,Ef(this._startTime+this._duration,this.source.buffer.duration)))),this.source},_updateCurrentTime:function(){this._currentTime=Ef((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(Rf.prototype,"volume",{get:function(){return this._volume},set:function(e){e=Se.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume)}}),Object.defineProperty(Rf.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(Rf.prototype,"sound",{get:function(){return this._sound},set:function(e){this._sound=e,2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(Rf.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function(e){if(!(e<0))if(0===this._state){var t=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=t}else this._startOffset=e,this._currentTime=e}})):(Object.assign(Rf.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource()||(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),0))},pause:function(){return!(!this.source||0!==this._state||(this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),0))},resume:function(){return!(!this.source||1!==this._state||(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),0))},stop:function(){return!(!this.source||2===this._state||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),0))},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;var e=Ef(this._startOffset,this.duration);e=Ef(this._startTime+e,this._sound.duration),this._startOffset=null,this.source.currentTime=e},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>Ef(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=Ef(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(Rf.prototype,"volume",{get:function(){return this._volume},set:function(e){e=Se.clamp(e,0,1),this._volume=e,this.source&&(this.source.volume=e*this._manager.volume)}}),Object.defineProperty(Rf.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(Rf.prototype,"sound",{get:function(){return this._sound},set:function(e){this.stop(),this._sound=e}}),Object.defineProperty(Rf.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(e){e<0||(this._startOffset=e,this.source&&this._isReady&&(this.source.currentTime=Ef(this._startTime+Ef(e,this.duration),this._sound.duration),this._startOffset=null))}}));var Df=function(a){function e(e,t,i){var n;return n=a.call(this,e,t,i)||this,i=i||{},n._position=new de,i.position&&(n.position=i.position),n._velocity=new de,i.velocity&&(n.velocity=i.velocity),n.maxDistance=void 0!==i.maxDistance?Number(i.maxDistance):1e4,n.refDistance=void 0!==i.refDistance?Number(i.refDistance):1,n.rollOffFactor=void 0!==i.rollOffFactor?Number(i.rollOffFactor):1,n.distanceModel=void 0!==i.distanceModel?i.distanceModel:dr,n}return u(e,a),e}(Rf);if(cr())Object.assign(Df.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(Df.prototype,"position",{get:function(){return this._position},set:function(e){this._position.copy(e),this.panner.setPosition(e.x,e.y,e.z)}}),Object.defineProperty(Df.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity.copy(e),this.panner.setVelocity(e.x,e.y,e.z)}}),Object.defineProperty(Df.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(e){this.panner.maxDistance=e}}),Object.defineProperty(Df.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(e){this.panner.refDistance=e}}),Object.defineProperty(Df.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(e){this.panner.rolloffFactor=e}}),Object.defineProperty(Df.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(e){this.panner.distanceModel=e}});else{var If=new de;Object.defineProperty(Df.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copy(e),this.source){var t=function(e,t,i,n,a,s){var r=(If=If.sub2(e,t)).length();if(r<i)return 1;if(n<r)return 0;var o=0;return s===dr?o=1-a*(r-i)/(n-i):s===pr?o=i/(i+a*(r-i)):s===fr&&(o=Math.pow(r/i,-a)),Se.clamp(o,0,1)}(this._manager.listener.getPosition(),this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.volume;this.source.volume=i*t*this._manager.volume}}}),Object.defineProperty(Df.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity.copy(e)}}),Object.defineProperty(Df.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e}}),Object.defineProperty(Df.prototype,"refDistance",{get:function(){return this._refDistance},set:function(e){this._refDistance=e}}),Object.defineProperty(Df.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e}}),Object.defineProperty(Df.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(e){this._distanceModel=e}})}var kf={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new de,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},Lf=function(a){function e(e,t,i){var n;return(n=a.call(this)||this)._component=e,n._assets=e.system.app.assets,n._manager=e.system.manager,n.name=t||"Untitled",i=i||{},n._volume=void 0!==i.volume?Se.clamp(Number(i.volume)||0,0,1):1,n._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,n._loop=!(void 0===i.loop||!i.loop),n._duration=0<i.duration?i.duration:null,n._startTime=Math.max(0,Number(i.startTime)||0),n._overlap=!!i.overlap,n._autoPlay=!!i.autoPlay,n._firstNode=null,n._lastNode=null,n._asset=i.asset,n._asset instanceof Kr&&(n._asset=n._asset.id),n._onInstancePlayHandler=n._onInstancePlay.bind(g(n)),n._onInstancePauseHandler=n._onInstancePause.bind(g(n)),n._onInstanceResumeHandler=n._onInstanceResume.bind(g(n)),n._onInstanceStopHandler=n._onInstanceStop.bind(g(n)),n._onInstanceEndHandler=n._onInstanceEnd.bind(g(n)),n.instances=[],n}u(e,a);var t=e.prototype;return t.play=function(){if(this.overlap||this.stop(),this.isLoaded||this._hasAsset()){var i=this._createInstance();if(this.instances.push(i),this.isLoaded)i.play();else{var e=function(e){var t=i._playWhenLoaded;i.sound=e,t&&i.play()};this.off("load",e),this.once("load",e),this.load()}return i}},t.pause=function(){for(var e=!1,t=this.instances,i=0,n=t.length;i<n;i++)t[i].pause()&&(e=!0);return e},t.resume=function(){for(var e=!1,t=this.instances,i=0,n=t.length;i<n;i++)t[i].resume()&&(e=!0);return e},t.stop=function(){for(var e=!1,t=this.instances,i=t.length;i--;)t[i].stop(),e=!0;return t.length=0,e},t.load=function(){if(this._hasAsset()){var e=this._assets.get(this._asset);if(!e)return this._assets.off("add:"+this._asset,this._onAssetAdd,this),void this._assets.once("add:"+this._asset,this._onAssetAdd,this);if(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),!e.resource)return e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),void this._assets.load(e);this.fire("load",e.resource)}},t.setExternalNodes=function(e,t){if(e&&(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap))for(var i=this.instances,n=0,a=i.length;n<a;n++)i[n].setExternalNodes(e,t)},t.clearExternalNodes=function(){if(this._firstNode=null,this._lastNode=null,!this._overlap)for(var e=this.instances,t=0,i=e.length;t<i;t++)e[t].clearExternalNodes()},t.getExternalNodes=function(){return[this._firstNode,this._lastNode]},t._hasAsset=function(){return null!=this._asset},t._createInstance=function(){var e=null,t=this._component,i=null;if(this._hasAsset()){var n=this._assets.get(this._asset);n&&(i=n.resource)}var a=kf;return a.volume=this._volume*t.volume,a.pitch=this._pitch*t.pitch,a.loop=this._loop,a.startTime=this._startTime,a.duration=this._duration,a.onPlay=this._onInstancePlayHandler,a.onPause=this._onInstancePauseHandler,a.onResume=this._onInstanceResumeHandler,a.onStop=this._onInstanceStopHandler,a.onEnd=this._onInstanceEndHandler,t.positional?(a.position.copy(t.entity.getPosition()),a.maxDistance=t.maxDistance,a.refDistance=t.refDistance,a.rollOffFactor=t.rollOffFactor,a.distanceModel=t.distanceModel,e=new Df(this._manager,i,a)):e=new Rf(this._manager,i,a),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e},t._onInstancePlay=function(e){this.fire("play",e),this._component.fire("play",this,e)},t._onInstancePause=function(e){this.fire("pause",e),this._component.fire("pause",this,e)},t._onInstanceResume=function(e){this.fire("resume",e),this._component.fire("resume",this,e)},t._onInstanceStop=function(e){var t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e)},t._onInstanceEnd=function(e){var t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e)},t._onAssetAdd=function(e){this.load()},t._onAssetLoad=function(e){this.load()},t._onAssetRemoved=function(e){e.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+e.id,this._onAssetAdd,this),this.stop()},t.updatePosition=function(e){for(var t=this.instances,i=0,n=t.length;i<n;i++)t[i].position=e},c(e,[{key:"volume",get:function(){return this._volume},set:function(e){if(this._volume=Se.clamp(Number(e)||0,0,1),!this._overlap)for(var t=this.instances,i=0,n=t.length;i<n;i++)t[i].volume=this._volume*this._component.volume}},{key:"pitch",get:function(){return this._pitch},set:function(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap)for(var t=this.instances,i=0,n=t.length;i<n;i++)t[i].pitch=this.pitch*this._component.pitch}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=!!e;for(var t=this.instances,i=0,n=t.length;i<n;i++)t[i].loop=this._loop}},{key:"autoPlay",get:function(){return this._autoPlay},set:function(e){this._autoPlay=!!e}},{key:"overlap",get:function(){return this._overlap},set:function(e){this._overlap=!!e}},{key:"startTime",get:function(){return this._startTime},set:function(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap)for(var t=this.instances,i=0,n=t.length;i<n;i++)t[i].startTime=this._startTime}},{key:"duration",get:function(){var e=0;if(this._hasAsset()){var t=this._assets.get(this._asset);e=t.resource?t.resource.duration:0}return null!=this._duration?this._duration%(e||1):e},set:function(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap)for(var t=this.instances,i=0,n=t.length;i<n;i++)t[i].duration=this._duration}},{key:"asset",get:function(){return this._asset},set:function(e){var t=this._asset;if(t){this._assets.off("add:"+t,this._onAssetAdd,this);var i=this._assets.get(t);i&&i.off("remove",this._onAssetRemoved,this)}this._asset=e,this._asset instanceof Kr&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}},{key:"isLoaded",get:function(){if(this._hasAsset()){var e=this._assets.get(this._asset);if(e)return!!e.resource}return!1}},{key:"isPlaying",get:function(){for(var e=this.instances,t=0,i=e.length;t<i;t++)if(e[t].isPlaying)return!0;return!1}},{key:"isPaused",get:function(){var e=this.instances,t=e.length;if(0===t)return!1;for(var i=0;i<t;i++)if(!e[i].isPaused)return!1;return!0}},{key:"isStopped",get:function(){for(var e=this.instances,t=0,i=e.length;t<i;t++)if(!e[t].isStopped)return!1;return!0}}]),e}(p),Of=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._volume=1,i._pitch=1,i._positional=!0,i._refDistance=1,i._maxDistance=1e4,i._rollOffFactor=1,i._distanceModel=dr,i._slots={},i._playingBeforeDisable={},i}u(e,n);var t=e.prototype;return t.onEnable=function(){if(!this.system._inTools){var e=this._slots,t=this._playingBeforeDisable;for(var i in e){var n=e[i];n.autoPlay&&n.isStopped?n.play():t[i]?n.resume():n.isLoaded||n.load()}}},t.onDisable=function(){var e=this._slots,t={};for(var i in e)e[i].overlap||e[i].isPlaying&&(e[i].pause(),t[i]=!0);this._playingBeforeDisable=t},t.onRemove=function(){this.off()},t.addSlot=function(e,t){var i=this._slots;if(i[e])return null;var n=new Lf(this,e,t);return(i[e]=n).autoPlay&&this.enabled&&this.entity.enabled&&n.play(),n},t.removeSlot=function(e){var t=this._slots;t[e]&&(t[e].stop(),delete t[e])},t.slot=function(e){return this._slots[e]},t.play=function(e){if(!this.enabled||!this.entity.enabled)return null;var t=this._slots[e];return t?t.play():null},t.pause=function(e){var t,i=this._slots;if(e){if(!(t=i[e]))return;t.pause()}else for(var n in i)i[n].pause()},t.resume=function(e){var t=this._slots;if(e){var i=t[e];if(!i)return;i.isPaused&&i.resume()}else for(var n in t)t[n].resume()},t.stop=function(e){var t=this._slots;if(e){var i=t[e];if(!i)return;i.stop()}else for(var n in t)t[n].stop()},c(e,[{key:"positional",get:function(){return this._positional},set:function(e){this._positional=e;var t=this._slots;for(var i in t){var n=t[i];if(!n.overlap)for(var a=n.instances,s=a.length-1;0<=s;s--){var r=a[s].isPlaying||a[s].isSuspended,o=a[s].currentTime;r&&a[s].stop();var l=n._createInstance();r&&(l.play(),l.currentTime=o),a.push(l)}}}},{key:"slots",get:function(){return this._slots},set:function(e){var t,i=this._slots;if(i)for(t in i)i[t].stop();var n={};for(t in e)e[t]instanceof Lf?n[e[t].name]=e[t]:e[t].name&&(n[e[t].name]=new Lf(this,e[t].name,e[t]));this._slots=n,this.enabled&&this.entity.enabled&&this.onEnable()}}]),e}(Xh);function Ff(o,l){Object.defineProperty(Of.prototype,o,{get:function(){return this[l]},set:function(e){this[l]=e;var t=this._slots;for(var i in t){var n=t[i];if(!n.overlap)for(var a=n.instances,s=0,r=a.length;s<r;s++)a[s][o]=e}}})}function zf(o,l){Object.defineProperty(Of.prototype,o,{get:function(){return this[l]},set:function(e){this[l]=e;var t=this._slots;for(var i in t){var n=t[i];if(!n.overlap)for(var a=n.instances,s=0,r=a.length;s<r;s++)a[s][o]=n[o]*e}}})}zf("pitch","_pitch"),zf("volume","_volume"),Ff("refDistance","_refDistance"),Ff("maxDistance","_maxDistance"),Ff("rollOffFactor","_rollOffFactor"),Ff("distanceModel","_distanceModel");var Bf=function(){this.enabled=!0},Vf=["enabled"],Uf=function(a){function e(e,t){var i;return(i=a.call(this,e)||this).id="sound",i.ComponentType=Of,i.DataType=Bf,i.schema=Vf,i.manager=t,qh.bind("update",i.onUpdate,g(i)),i.on("beforeremove",i.onBeforeRemove,g(i)),i}u(e,a);var t=e.prototype;return t.initializeComponentData=function(e,t,i){i=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(var n=0;n<i.length;n++)t.hasOwnProperty(i[n])&&(e[i[n]]=t[i[n]]);a.prototype.initializeComponentData.call(this,e,t,["enabled"])},t.cloneComponent=function(e,t){var i=e.sound,n=i.slots,a={};for(var s in n){var r=n[s];a[s]={name:r.name,volume:r.volume,pitch:r.pitch,loop:r.loop,duration:r.duration,startTime:r.startTime,overlap:r.overlap,autoPlay:r.autoPlay,asset:r.asset}}var o={distanceModel:i.distanceModel,enabled:i.enabled,maxDistance:i.maxDistance,pitch:i.pitch,positional:i.positional,refDistance:i.refDistance,rollOffFactor:i.rollOffFactor,slots:a,volume:i.volume};return this.addComponent(t,o)},t.onUpdate=function(e){var t=this.store;for(var i in t)if(t.hasOwnProperty(i)){var n=t[i].entity;if(n.enabled){var a=n.sound;if(a.enabled&&a.positional){var s=n.getPosition(),r=a.slots;for(var o in r)r[o].updatePosition(s)}}}},t.onBeforeRemove=function(e,t){var i=t.slots;for(var n in i)i[n].overlap||i[n].stop();t.onRemove()},c(e,[{key:"volume",get:function(){return this.manager.volume},set:function(e){this.manager.volume=e}},{key:"context",get:function(){return cr()?this.manager.context:null}}]),e}(qh);Xh._buildAccessors(Of.prototype,Vf);var Nf="animated",Gf=function(n){function e(e,t){var i;return(i=n.call(this)||this)._component=e,i._frame=0,i._sprite=null,i._spriteAsset=null,i.spriteAsset=t.spriteAsset,i.name=t.name,i.fps=t.fps||0,i.loop=t.loop||!1,i._playing=!1,i._paused=!1,i._time=0,i}u(e,n);var t=e.prototype;return t._onSpriteAssetAdded=function(e){this._component.system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)},t._bindSpriteAsset=function(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e)},t._unbindSpriteAsset=function(e){e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&e.resource.atlas&&this._component.system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},t._onSpriteAssetLoad=function(e){if(e.resource)if(e.resource.atlas)this.sprite=e.resource;else{var t=e.data.textureAtlasAsset,i=this._component.system.app.assets;i.off("load:"+t,this._onTextureAtlasLoad,this),i.once("load:"+t,this._onTextureAtlasLoad,this)}else this.sprite=null},t._onTextureAtlasLoad=function(e){var t=this._spriteAsset;t instanceof Kr?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t))},t._onSpriteAssetRemove=function(e){this.sprite=null},t._onSpriteMeshesChange=function(){this._component.currentClip===this&&this._component._showFrame(this.frame)},t._onSpritePpuChanged=function(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame)},t._update=function(e){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var t=this.fps<0?-1:1,i=this._time+e*this._component.speed*t,n=this.duration,a=n<i||i<0;this._setTime(i);var s=this.frame;(s=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/n):0)!==this._frame&&this._setFrame(s),a&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}},t._setTime=function(e){this._time=e;var t=this.duration;this._time<0?this.loop?this._time=this._time%t+t:this._time=0:this._time>t&&(this.loop?this._time%=t:this._time=t)},t._setFrame=function(e){this._sprite?this._frame=Se.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame)},t._destroy=function(){this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)},t.play=function(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))},t.pause=function(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))},t.resume=function(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))},t.stop=function(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))},c(e,[{key:"spriteAsset",get:function(){return this._spriteAsset},set:function(e){var t=this._component.system.app.assets,i=e;if(e instanceof Kr&&(i=e.id),this._spriteAsset!==i){if(this._spriteAsset){var n=t.get(this._spriteAsset);n&&this._unbindSpriteAsset(n)}if(this._spriteAsset=i,this._spriteAsset){var a=t.get(this._spriteAsset);a?this._bindSpriteAsset(a):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}},{key:"sprite",get:function(){return this._sprite},set:function(e){var t;this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=e,this._sprite&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this&&(e&&e.atlas?(e.atlas.texture&&((t=this._component._meshInstance)&&(t.setParameter("texture_emissiveMap",e.atlas.texture),t.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):((t=this._component._meshInstance)&&(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap")),this._component._hideModel()))}},{key:"frame",get:function(){return this._frame},set:function(e){this._setFrame(e);var t=this.fps||Number.MIN_VALUE;this._setTime(this._frame/t)}},{key:"isPlaying",get:function(){return this._playing}},{key:"isPaused",get:function(){return this._paused}},{key:"duration",get:function(){if(this._sprite){var e=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(e)}return 0}},{key:"time",get:function(){return this._time},set:function(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}}]),e}(p),Wf="texture_emissiveMap",Hf="texture_opacityMap",jf="material_emissive",Xf="material_opacity",qf=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._type="simple",i._material=e.defaultMaterial,i._color=new $(1,1,1,1),i._colorUniform=new Float32Array(3),i._speed=1,i._flipX=!1,i._flipY=!1,i._width=1,i._height=1,i._drawOrder=0,i._layers=[0],i._outerScale=new J(1,1),i._outerScaleUniform=new Float32Array(2),i._innerOffset=new ee,i._innerOffsetUniform=new Float32Array(4),i._atlasRect=new ee,i._atlasRectUniform=new Float32Array(4),i._batchGroupId=-1,i._batchGroup=null,i._node=new mn,i._model=new rr,i._model.graph=i._node,i._meshInstance=null,t.addChild(i._model.graph),i._model._entity=t,i._updateAabbFunc=i._updateAabb.bind(g(i)),i._addedModel=!1,i._autoPlayClip=null,i._clips={},i._defaultClip=new Gf(g(i),{name:i.entity.name,fps:0,loop:!1,spriteAsset:null}),i._currentClip=i._defaultClip,i}u(e,n);var t=e.prototype;return t.onEnable=function(){var e=this.system.app,t=e.scene;t.on("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.on("add",this._onLayerAdded,this),t.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),0<=this._batchGroupId&&e.batcher.insert(Cn.SPRITE,this._batchGroupId,this.entity)},t.onDisable=function(){var e=this.system.app,t=e.scene;t.off("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.off("add",this._onLayerAdded,this),t.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),0<=this._batchGroupId&&e.batcher.remove(Cn.SPRITE,this._batchGroupId,this.entity)},t.onDestroy=function(){for(var e in this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null),this._clips)this._clips[e]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null),this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)},t._showModel=function(){if(!this._addedModel&&this._meshInstance){var e,t,i=[this._meshInstance];for(e=0,t=this._layers.length;e<t;e++){var n=this.system.app.scene.layers.getLayerById(this._layers[e]);n&&n.addMeshInstances(i)}this._addedModel=!0}},t._hideModel=function(){if(this._addedModel&&this._meshInstance){var e,t,i=[this._meshInstance];for(e=0,t=this._layers.length;e<t;e++){var n=this.system.app.scene.layers.getLayerById(this._layers[e]);n&&n.removeMeshInstances(i)}this._addedModel=!1}},t._showFrame=function(e){if(this.sprite){var t=this.sprite.meshes[e];if(t){var i;if(i=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new Mn(t,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(jf,this._colorUniform),this._meshInstance.setParameter(Xf,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==i&&(this._meshInstance.material=i),this._meshInstance.mesh!==t&&(this._meshInstance.mesh=t,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(Wf,this.sprite.atlas.texture),this._meshInstance.setParameter(Hf,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(Wf),this._meshInstance.deleteParameter(Hf)),!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode)this._meshInstance._updateAabbFunc=null;else{this._meshInstance._updateAabbFunc=this._updateAabbFunc;var n=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(n){var a=2/n.rect.z,s=2/n.rect.w;this._innerOffset.set(n.border.x*a,n.border.y*s,n.border.z*a,n.border.w*s);var r=this.sprite.atlas.texture;this._atlasRect.set(n.rect.x/r.width,n.rect.y/r.height,n.rect.z/r.width,n.rect.w/r.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)}this._updateTransform()}else this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1)}},t._updateTransform=function(){var e=this.flipX?-1:1,t=this.flipY?-1:1,i=0,n=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){var a=1,s=1;if(this.sprite.atlas){var r=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];r&&(a=r.rect.z,s=r.rect.w,i=(.5-r.pivot.x)*this._width,n=(.5-r.pivot.y)*this._height)}var o=a/this.sprite.pixelsPerUnit,l=s/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*o),Math.max(this._height,this._innerOffset.y*l)),e*=o,t*=l,this._outerScale.x/=o,this._outerScale.y/=l,e*=Se.clamp(this._width/(this._innerOffset.x*o),1e-4,1),t*=Se.clamp(this._height/(this._innerOffset.y*l),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform))}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(i,n,0)},t._updateAabb=function(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e},t._tryAutoPlay=function(){if(this._autoPlayClip&&this.type===Nf){var e=this._clips[this._autoPlayClip];!e||e.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(e.name)}},t._onLayersChanged=function(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()},t._onLayerAdded=function(e){this.layers.indexOf(e.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance])},t._onLayerRemoved=function(e){this._meshInstance&&(this.layers.indexOf(e.id)<0||e.removeMeshInstances([this._meshInstance]))},t.removeModelFromLayers=function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.removeMeshInstances([this._meshInstance])},t.addClip=function(e){var t=new Gf(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return(this._clips[e.name]=t).name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t},t.removeClip=function(e){delete this._clips[e]},t.clip=function(e){return this._clips[e]},t.play=function(e){var t=this._clips[e],i=this._currentClip;return i&&i!==t&&(i._playing=!1),this._currentClip=t,this._currentClip&&(this._currentClip=t,this._currentClip.play()),t},t.pause=function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()},t.resume=function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()},t.stop=function(){this._currentClip!==this._defaultClip&&this._currentClip.stop()},c(e,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,"simple"===this._type?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===Nf&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}},{key:"frame",get:function(){return this._currentClip.frame},set:function(e){this._currentClip.frame=e}},{key:"spriteAsset",get:function(){return this._defaultClip._spriteAsset},set:function(e){this._defaultClip.spriteAsset=e}},{key:"sprite",get:function(){return this._currentClip.sprite},set:function(e){this._currentClip.sprite=e}},{key:"material",get:function(){return this._material},set:function(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(jf,this._colorUniform))}},{key:"opacity",get:function(){return this._color.a},set:function(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter(Xf,e)}},{key:"clips",get:function(){return this._clips},set:function(e){var t,i;if(e){for(t in this._clips){var n=!1;for(i in e)if(e[i].name===t){n=!0,this._clips[t].fps=e[i].fps,this._clips[t].loop=e[i].loop,e[i].hasOwnProperty("sprite")?this._clips[t].sprite=e[i].sprite:e[i].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[i].spriteAsset);break}n||this.removeClip(t)}for(i in e)this._clips[e[i].name]||this.addClip(e[i]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(t in this._clips)this.removeClip(t)}},{key:"currentClip",get:function(){return this._currentClip}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._updateTransform())}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._updateTransform())}},{key:"width",get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}},{key:"height",get:function(){return this._height},set:function(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var t=this._batchGroupId;this._batchGroupId=e,this.entity.enabled&&0<=t&&this.system.app.batcher.remove(Cn.SPRITE,t,this.entity),this.entity.enabled&&0<=e?this.system.app.batcher.insert(Cn.SPRITE,e,this.entity):0<=t&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}},{key:"autoPlayClip",get:function(){return this._autoPlayClip},set:function(e){this._autoPlayClip=e instanceof Gf?e.name:e,this._tryAutoPlay()}},{key:"drawOrder",get:function(){return this._drawOrder},set:function(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e)}},{key:"layers",get:function(){return this._layers},set:function(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}},{key:"aabb",get:function(){return this._meshInstance?this._meshInstance.aabb:null}}]),e}(Xh),$f=function(){this.enabled=!0},Yf=["enabled"],Kf=function(a){function e(e){var t;return(t=a.call(this,e)||this).id="sprite",t.ComponentType=qf,t.DataType=$f,t.schema=Yf,t._defaultTexture=null,t._defaultMaterial=null,t._default9SlicedMaterialSlicedMode=null,t._default9SlicedMaterialTiledMode=null,qh.bind("update",t.onUpdate,g(t)),t.on("beforeremove",t.onBeforeRemove,g(t)),t}u(e,a);var t=e.prototype;return t.destroy=function(){this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)},t.initializeComponentData=function(e,t,i){if(void 0!==t.enabled&&(e.enabled=t.enabled),e.type=t.type,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),void 0!==t.drawOrder&&(e.drawOrder=t.drawOrder),void 0!==t.color&&(t.color instanceof $?e.color.set(t.color.r,t.color.g,t.color.b,void 0!==t.opacity?t.opacity:1):e.color.set(t.color[0],t.color[1],t.color[2],void 0!==t.opacity?t.opacity:1),e.color=e.color),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.flipX&&(e.flipX=t.flipX),void 0!==t.flipY&&(e.flipY=t.flipY),void 0!==t.width&&(e.width=t.width),void 0!==t.height&&(e.height=t.height),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.frame&&(e.frame=t.frame),t.clips)for(var n in t.clips)e.addClip(t.clips[n]);void 0!==t.speed&&(e.speed=t.speed),t.autoPlayClip&&(e.autoPlayClip=t.autoPlayClip),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,a.prototype.initializeComponentData.call(this,e,t,i)},t.cloneComponent=function(e,t){var i=e.sprite;return this.addComponent(t,{enabled:i.enabled,type:i.type,spriteAsset:i.spriteAsset,sprite:i.sprite,frame:i.frame,color:i.color.clone(),opacity:i.opacity,flipX:i.flipX,flipY:i.flipY,speed:i.speed,clips:i.clips,autoPlayClip:i.autoPlayClip,batchGroupId:i.batchGroupId,drawOrder:i.drawOrder,layers:i.layers.slice(0)})},t.onUpdate=function(e){var t=this.store;for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];if(n.data.enabled&&n.entity.enabled){var a=n.entity.sprite;a._currentClip&&a._currentClip._update(e)}}},t.onBeforeRemove=function(e,t){t.onDestroy()},c(e,[{key:"defaultMaterial",get:function(){if(!this._defaultMaterial){var e=new Kt(this.app.graphicsDevice,{width:1,height:1,format:7}),t=new Uint8Array(e.lock());t[0]=t[1]=t[2]=t[3]=255,e.name="sprite",e.unlock();var i=new gm;i.diffuse.set(0,0,0),i.emissive.set(.5,.5,.5),i.emissiveMap=e,i.emissiveMapTint=!0,i.opacityMap=e,i.opacityMapChannel="a",i.opacityTint=!0,i.opacity=0,i.useLighting=!1,i.useGammaTonemap=!1,i.useFog=!1,i.useSkybox=!1,i.blendType=4,i.depthWrite=!1,i.pixelSnap=!1,i.cull=0,i.update(),this._defaultTexture=e,this._defaultMaterial=i}return this._defaultMaterial},set:function(e){this._defaultMaterial=e}},{key:"default9SlicedMaterialSlicedMode",get:function(){if(!this._default9SlicedMaterialSlicedMode){var e=this.defaultMaterial.clone();e.nineSlicedMode=1,e.update(),this._default9SlicedMaterialSlicedMode=e}return this._default9SlicedMaterialSlicedMode},set:function(e){this._default9SlicedMaterialSlicedMode=e}},{key:"default9SlicedMaterialTiledMode",get:function(){if(!this._default9SlicedMaterialTiledMode){var e=this.defaultMaterial.clone();e.nineSlicedMode=2,e.update(),this._default9SlicedMaterialTiledMode=e}return this._default9SlicedMaterialTiledMode},set:function(e){this._default9SlicedMaterialTiledMode=e}}]),e}(qh);Xh._buildAccessors(qf.prototype,Yf);var Zf=function(n){function e(e,t){var i;return(i=n.call(this,e,t)||this)._oldState=!0,i._size=new de,i.on("set_enabled",i._onSetEnabled,g(i)),i}u(e,n);var t=e.prototype;return t.onEnable=function(){this._checkState()},t.onDisable=function(){this._checkState()},t._onSetEnabled=function(e,t,i){this._checkState()},t._checkState=function(){var e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled))},t._onBeforeRemove=function(){this.fire("remove")},c(e,[{key:"size",get:function(){return this._size},set:function(e){e instanceof de?this._size.copy(e):e instanceof Array&&3<=e.length&&this.size.set(e[0],e[1],e[2])}}]),e}(Xh),Qf=function(){this.enabled=!0},Jf=["enabled"],em=function(i){function e(e){var t;return(t=i.call(this,e)||this).id="zone",t.ComponentType=Zf,t.DataType=Qf,t.schema=Jf,t.on("beforeremove",t._onBeforeRemove,g(t)),t}u(e,i);var t=e.prototype;return t.initializeComponentData=function(e,t,i){e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,t.size&&(t.size instanceof de?e.size.copy(t.size):t.size instanceof Array&&3<=t.size.length&&e.size.set(t.size[0],t.size[1],t.size[2]))},t.cloneComponent=function(e,t){var i={size:e.zone.size};return this.addComponent(t,i)},t._onBeforeRemove=function(e,t){t._onBeforeRemove()},e}(qh);Xh._buildAccessors(Zf.prototype,Jf);var tm=function(){function e(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}return c(e,[{key:"scene",get:function(){return hi().scene._stats}},{key:"lightmapper",get:function(){return hi().lightmapper._stats}},{key:"batcher",get:function(){return hi().batcher._stats}}]),e}(),im=function(){function e(e,t){this.name=e,this.url=t,this.data=null,this._loading=!1,this._onLoadedCallbacks=[]}return c(e,[{key:"loaded",get:function(){return!!this.data}},{key:"loading",get:function(){return this._loading}}]),e}(),nm=function(){function e(e){this._app=e,this._list=[],this._index={},this._urlIndex={}}var t=e.prototype;return t.destroy=function(){this._app=null},t.list=function(){return this._list},t.add=function(e,t){if(this._index.hasOwnProperty(e))return!1;var i=new im(e,t),n=this._list.push(i);return this._index[i.name]=n-1,this._urlIndex[i.url]=n-1,!0},t.find=function(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null},t.findByUrl=function(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null},t.remove=function(e){if(this._index.hasOwnProperty(e)){var t=this._index[e],i=this._list[t];for(delete this._urlIndex[i.url],delete this._index[e],this._list.splice(t,1),t=0;t<this._list.length;t++)i=this._list[t],this._index[i.name]=t,this._urlIndex[i.url]=t}},t._loadSceneData=function(n,a,e){var t=n;if(n instanceof im?t=n.url:(n=this.findByUrl(t))||(n=new im("Untitled",t)),n.url)if(n.loaded)e(null,n);else{var i=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!Vr.test(t)&&(t=C.join(this._app.assets.prefix,t)),n._onLoadedCallbacks.push(e),n._loading||i.load(t,function(e,t){n.data=t,n._loading=!1;for(var i=0;i<n._onLoadedCallbacks.length;i++)n._onLoadedCallbacks[i](e,n);a||(n.data=null),n._onLoadedCallbacks.length=0}),n._loading=!0}else e("URL or SceneRegistryItem is null when loading a scene")},t.loadSceneData=function(e,t){this._loadSceneData(e,!0,t)},t.unloadSceneData=function(e){"string"==typeof e&&(e=this.findByUrl(e)),e&&(e.data=null)},t.loadSceneHierarchy=function(e,a){var s=this,r=this._app.loader.getHandler("hierarchy");this._loadSceneData(e,!1,function(t,e){if(t)a&&a(t);else{var i=e.url,n=e.data;s._app._preloadScripts(n,function(){s._app.systems.script.preloading=!0;var e=r.open(i,n);s._app.systems.script.preloading=!1,s._app.loader.clearCache(i,"hierarchy"),s._app.root.addChild(e),qh.initialize(e),qh.postInitialize(e),a&&a(t,e)})}})},t.loadSceneSettings=function(e,i){var n=this;this._loadSceneData(e,!1,function(e,t){e?i&&i(e):(n._app.applySceneSettings(t.data.settings),i&&i(null))})},t.loadScene=function(n,a){var s=this,r=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!Vr.test(n)&&(n=C.join(this._app.assets.prefix,n)),r.load(n,function(e,i){e?a&&a(e):s._app._preloadScripts(i,function(){s._app.systems.script.preloading=!0;var e=r.open(n,i),t=s.findByUrl(n);t&&!t.loaded&&(t.data=i),s._app.systems.script.preloading=!1,s._app.loader.clearCache(n,"scene"),s._app.loader.patch({resource:e,type:"scene"},s._app.assets),s._app.root.addChild(e.root),s._app.systems.rigidbody&&"undefined"!=typeof Ammo&&s._app.systems.rigidbody.gravity.set(e._gravity.x,e._gravity.y,e._gravity.z),a&&a(null,e)})})},e}(),am=function(){function e(e){this.length=e,this.count=0}var t=e.prototype;return t.inc=function(){this.count++},t.done=function(){return this.count===this.length},e}(),sm=!1,rm=null,om=function(a){function l(e,t){var i;void 0===t&&(t={}),i=a.call(this)||this,l._applications[e.id]=g(i),ci(g(i)),rm=g(i),i._destroyRequested=!1,i._inFrameUpdate=!1,i._time=0,i.timeScale=1,i.maxDeltaTime=.1,i.frame=0,i.autoRender=!0,i.renderNextFrame=!1,i.useLegacyScriptAttributeCloning=gl.legacy,i._librariesLoaded=!1,i._fillMode=lh,i._resolutionMode="FIXED",i._allowResize=!0,i.context=g(i),t.graphicsDeviceOptions||(t.graphicsDeviceOptions={}),t.graphicsDeviceOptions.xrCompatible=!0,t.graphicsDeviceOptions.alpha=t.graphicsDeviceOptions.alpha||!1,i.graphicsDevice=new Lm(e,t.graphicsDeviceOptions),i.stats=new tm(i.graphicsDevice),i._soundManager=new _r(t),i.loader=new pl(g(i)),ai.init(i.graphicsDevice),i._entityIndex={},i.scene=new hr,i.root=new Cr(g(i)),i.root._enabledInHierarchy=!0,i._enableList=[],i._enableList.size=0,i.assets=new ih(i.loader),t.assetPrefix&&(i.assets.prefix=t.assetPrefix),i.bundles=new nh(i.assets),i.enableBundles="undefined"!=typeof TextDecoder,i.scriptsOrder=t.scriptsOrder||[],i.scripts=new ah(g(i)),i.i18n=new rh(g(i)),i.scenes=new nm(g(i));var s=g(i);i.defaultLayerWorld=new _a({name:"World",id:0}),i.sceneDepth=new ya(g(i)),i.defaultLayerDepth=i.sceneDepth.layer,i.defaultLayerSkybox=new _a({enabled:!0,name:"Skybox",id:2,opaqueSortMode:0}),i.defaultLayerUi=new _a({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1}),i.defaultLayerImmediate=new _a({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0});var n=new pi(i.graphicsDevice,"default");return n.pushOpaque(i.defaultLayerWorld),n.pushOpaque(i.defaultLayerDepth),n.pushOpaque(i.defaultLayerSkybox),n.pushTransparent(i.defaultLayerWorld),n.pushOpaque(i.defaultLayerImmediate),n.pushTransparent(i.defaultLayerImmediate),n.pushTransparent(i.defaultLayerUi),i.scene.layers=n,i._immediateLayer=i.defaultLayerImmediate,i.scene.on("set:layers",function(e,t){for(var i,n=t.layerList,a=0;a<n.length;a++)switch((i=n[a]).id){case 1:s.sceneDepth.patch(i);break;case 4:i.passThrough=s.defaultLayerUi.passThrough;break;case 3:i.passThrough=s.defaultLayerImmediate.passThrough}}),Ya.createPlaceholder(i.graphicsDevice),i.renderer=new qa(i.graphicsDevice),i.renderer.scene=i.scene,i.lightmapper=new as(i.graphicsDevice,i.root,i.scene,i.renderer,i.assets),i.once("prerender",i._firstBake,g(i)),i.batcher=new zn(i.graphicsDevice,i.root,i.scene),i.once("prerender",i._firstBatch,g(i)),i.keyboard=t.keyboard||null,i.mouse=t.mouse||null,i.touch=t.touch||null,i.gamepads=t.gamepads||null,i.elementInput=t.elementInput||null,i.elementInput&&(i.elementInput.app=g(i)),i.vr=null,i.xr=new jh(g(i)),i.elementInput&&i.elementInput.attachSelectEvents(),i._inTools=!1,i._skyboxLast=0,i._scriptPrefix=t.scriptPrefix||"",i.enableBundles&&i.loader.addHandler("bundle",new Do(i.assets)),i.loader.addHandler("animation",new _o),i.loader.addHandler("animclip",new yo),i.loader.addHandler("animstategraph",new xo),i.loader.addHandler("model",new ll(i.graphicsDevice,i.scene.defaultMaterial)),i.loader.addHandler("render",new dl(i.assets)),i.loader.addHandler("material",new Jo(g(i))),i.loader.addHandler("texture",new eh(i.graphicsDevice,i.assets,i.loader)),i.loader.addHandler("text",new Al),i.loader.addHandler("json",new $o),i.loader.addHandler("audio",new Co(i._soundManager)),i.loader.addHandler("script",new _l(g(i))),i.loader.addHandler("scene",new fl(g(i))),i.loader.addHandler("cubemap",new zo(i.graphicsDevice,i.assets,i.loader)),i.loader.addHandler("html",new qo),i.loader.addHandler("css",new Fo),i.loader.addHandler("shader",new yl),i.loader.addHandler("hierarchy",new Xo(g(i))),i.loader.addHandler("folder",new Bo),i.loader.addHandler("font",new Go(i.loader)),i.loader.addHandler("binary",new Po),i.loader.addHandler("textureatlas",new kl(i.loader)),i.loader.addHandler("sprite",new Cl(i.assets,i.graphicsDevice)),i.loader.addHandler("template",new Tl(g(i))),i.loader.addHandler("container",new Oo(i.graphicsDevice,i.scene.defaultMaterial)),i.systems=new Iu,i.systems.add(new Up(g(i))),i.systems.add(new Du(g(i))),i.systems.add(new Md(g(i))),i.systems.add(new rc(g(i))),i.systems.add(new Lc(g(i))),i.systems.add(new lp(g(i))),i.systems.add(new pp(g(i))),i.systems.add(new lu(g(i))),i.systems.add(new ap(g(i))),gl.legacy?i.systems.add(new cf(g(i))):i.systems.add(new ef(g(i))),i.systems.add(new Gc(g(i),i._soundManager)),i.systems.add(new Uf(g(i),i._soundManager)),i.systems.add(new Bc(g(i),i._soundManager)),i.systems.add(new Mp(g(i))),i.systems.add(new Xp(g(i))),i.systems.add(new pd(g(i))),i.systems.add(new tu(g(i))),i.systems.add(new wf(g(i))),i.systems.add(new Af(g(i))),i.systems.add(new Kf(g(i))),i.systems.add(new Hd(g(i))),i.systems.add(new Td(g(i))),i.systems.add(new em(g(i))),i._visibilityChangeHandler=i.onVisibilityChange.bind(g(i)),"undefined"!=typeof document&&(void 0!==document.hidden?(i._hiddenAttr="hidden",document.addEventListener("visibilitychange",i._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(i._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",i._visibilityChangeHandler,!1)):void 0!==document.msHidden?(i._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",i._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(i._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",i._visibilityChangeHandler,!1))),i.graphicsDevice.on("resizecanvas",function(){i.renderer.destroyWBRTs(),i.renderer.destroyDPRTS()}),i.tick=hm(g(i)),i}u(l,a),l.getApplication=function(e){return e?l._applications[e]:hi()};var e=l.prototype;return e.configure=function(e,s){var r=this;q.get(e,function(e,t){if(e)s(e);else{var i=t.application_properties,n=t.scenes,a=t.assets;r._parseApplicationProperties(i,function(e){r._parseScenes(n),r._parseAssets(a),s(e||null)})}})},e.preload=function(e){var t,i,n=this;n.fire("preload:start");var a=this.assets.list({preload:!0}),s=new am(a.length),r=!1,o=function(){n.graphicsDevice&&!r&&s.done()&&(r=!0,n.fire("preload:end"),e())};i=a.length;var l=function(){return s.count};if(s.length){var h=function(e){s.inc(),n.fire("preload:progress",l()/i),s.done()&&o()},c=function(e,t){s.inc(),n.fire("preload:progress",l()/i),s.done()&&o()};for(t=0;t<a.length;t++)a[t].loaded?(s.inc(),n.fire("preload:progress",l()/i),s.done()&&o()):(a[t].once("load",h),a[t].once("error",c),this.assets.load(a[t]))}else o()},e._preloadScripts=function(e,i){if(gl.legacy){var n=this;n.systems.script.preloading=!0;var t,a=this._getScriptReferences(e),s=0,r=a.length,o=new am(r),l=/^http(s)?:\/\//;if(r){var h=function(e,t){o.inc(),o.done()&&(n.systems.script.preloading=!1,i())};for(s=0;s<r;s++)t=a[s],!l.test(t.toLowerCase())&&n._scriptPrefix&&(t=C.join(n._scriptPrefix,a[s])),this.loader.load(t,"script",h)}else n.systems.script.preloading=!1,i()}else i()},e._handleAreaLightDataProperty=function(e){var t=this.assets.get(e);t?this.setAreaLightLuts(t):this.assets.once("add:"+e,this.setAreaLightLuts,this)},e._parseApplicationProperties=function(e,t){var i,n;if("number"==typeof e.maxAssetRetries&&0<e.maxAssetRetries&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){var a=new pi(this.graphicsDevice,"application"),s={};for(var r in e.layers){var o=e.layers[r];o.id=parseInt(r,10),o.enabled=1!==o.id,s[r]=new _a(o)}for(i=0,n=e.layerOrder.length;i<n;i++){var l=e.layerOrder[i],h=s[l.layer];h&&(l.transparent?a.pushTransparent(h):a.pushOpaque(h),a.subLayerEnabled[i]=l.enabled)}this.scene.layers=a}if(e.batchGroups)for(i=0,n=e.batchGroups.length;i<n;i++){var c=e.batchGroups[i];this.batcher.addGroup(c.name,c.dynamic,c.maxAabbSize,c.id,c.layers)}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),e.areaLightDataAsset&&this._handleAreaLightDataProperty(e.areaLightDataAsset),this._loadLibraries(e.libraries,t)},e._loadLibraries=function(e,i){var t=e.length,n=t,a=this,s=/^http(s)?:\/\//;if(t)for(var r=function(e,t){n--,e?i(e):0===n&&(a.onLibrariesLoaded(),i(null))},o=0;o<t;++o){var l=e[o];!s.test(l.toLowerCase())&&a._scriptPrefix&&(l=C.join(a._scriptPrefix,l)),this.loader.load(l,"script",r)}else a.onLibrariesLoaded(),i(null)},e._parseScenes=function(e){if(e)for(var t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)},e._parseAssets=function(e){var t,i,n=[],a={},s={};if(gl.legacy){if(this.enableBundles)for(i in e)"bundle"===e[i].type&&(s[i]=!0,n.push(e[i]));for(i in e)s[i]||n.push(e[i])}else{for(t=0;t<this.scriptsOrder.length;t++)e[i=this.scriptsOrder[t]]&&(a[i]=!0,n.push(e[i]));if(this.enableBundles)for(i in e)"bundle"===e[i].type&&(s[i]=!0,n.push(e[i]));for(i in e)a[i]||s[i]||n.push(e[i])}for(t=0;t<n.length;t++){var r=n[t],o=new Kr(r.name,r.type,r.file,r.data);if(o.id=parseInt(r.id,10),o.preload=!!r.preload&&r.preload,o.loaded="script"===r.type&&r.data&&0<r.data.loadingType,o.tags.add(r.tags),r.i18n)for(var l in r.i18n)o.addLocalizedAssetId(l,r.i18n[l]);this.assets.add(o)}},e._getScriptReferences=function(e){var t,i,n=[];e.settings.priority_scripts&&(n=e.settings.priority_scripts);var a=[],s={};for(t=0;t<n.length;t++)a.push(n[t]),s[n[t]]=!0;var r=e.entities;for(i in r)if(r[i].components.script){var o=r[i].components.script.scripts;for(t=0;t<o.length;t++)s[o[t].url]||(a.push(o[t].url),s[o[t].url]=!0)}return a},e.start=function(){this.frame=0,this.fire("start",{timestamp:W(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),qh.initialize(this.root),this.fire("initialize"),qh.postInitialize(this.root),this.fire("postinitialize"),this.tick()},e.inputUpdate=function(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(e),this.keyboard&&this.keyboard.update(e),this.gamepads&&this.gamepads.update(e)},e.update=function(e){this.frame++,this.graphicsDevice.updateClientRect(),this.vr&&this.vr.poll(),gl.legacy&&qh.fixedUpdate(1/60,this._inTools),qh.update(e,this._inTools),qh.animationUpdate(e,this._inTools),qh.postUpdate(e,this._inTools),this.fire("update",e),this.inputUpdate(e)},e.render=function(){this.fire("prerender"),this.root.syncHierarchy(),this.batcher.updateAll(),this.renderer.generateRTs(),this.renderer.renderComposition(this.scene.layers),this.fire("postrender")},e._fillFrameStatsBasic=function(e,t,i){var n=this.stats.frame;n.dt=t,n.ms=i,e>n._timeToCountFrames?(n.fps=n._fpsAccum,n._fpsAccum=0,n._timeToCountFrames=e+1e3):n._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0},e._fillFrameStats=function(){var e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;var t=this.graphicsDevice._primsPerFrame;e.triangles=t[4]/3+Math.max(t[5]-2,0)+Math.max(t[6]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.instancingTime=this.renderer._instancingTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime;for(var i=e.otherPrimitives=0;i<t.length;i++)i<4&&(e.otherPrimitives+=t[i]),t[i]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._instancingTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(e=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.renderer._removedByInstancing=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(e=this.stats.particles).updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0},e.setCanvasFillMode=function(e,t,i){this._fillMode=e,this.resizeCanvas(t,i)},e.setCanvasResolution=function(e,t,i){(this._resolutionMode=e)===hh&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,i=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,i)},e.isHidden=function(){return document[this._hiddenAttr]},e.onVisibilityChange=function(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()},e.resizeCanvas=function(e,t){if(this._allowResize&&(!this.xr||!this.xr.session)){var i=window.innerWidth,n=window.innerHeight;if(this._fillMode===lh){var a=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;i/n<a?t=(e=i)/a:e=(t=n)*a}else this._fillMode===oh&&(e=i,t=n);return this.graphicsDevice.canvas.style.width=e+"px",this.graphicsDevice.canvas.style.height=t+"px",this.updateCanvasSize(),{width:e,height:t}}},e.updateCanvasSize=function(){if(this._allowResize&&!this.xr.active&&this._resolutionMode===hh){var e=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(e.clientWidth,e.clientHeight)}},e.onLibrariesLoaded=function(){this._librariesLoaded=!0,this.systems.rigidbody.onLibraryLoaded()},e.applySceneSettings=function(e){var t;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){var i=e.physics.gravity;this.systems.rigidbody.gravity.set(i[0],i[1],i[2])}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox))?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this):this.setSkybox(null))},e.setAreaLightLuts=function(e){if(e){var t=this.graphicsDevice;e.ready(function(e){Ya.set(t,e.resource)}),this.assets.load(e)}},e.setSkybox=function(e){if(e){if(this._skyboxLast===e.id)return void(0!==this.scene.skyboxMip||e.loadFaces?this._onSkyboxChange(e):this._skyboxLoad(e));this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=e.id,this.assets.on("load:"+e.id,this._onSkyboxChange,this),this.assets.once("remove:"+e.id,this._skyboxRemove,this),e.resource&&this.scene.setSkybox(e.resources),this._skyboxLoad(e)}else{if(!this._skyboxLast)return;this._skyboxRemove({id:this._skyboxLast})}},e.enableVr=function(){this.vr||(this.vr=new uh(this))},e.disableVr=function(){this.vr&&(this.vr.destroy(),this.vr=null)},e._onSkyboxChange=function(e){this.scene.setSkybox(e.resources)},e._skyboxLoad=function(e){0===this.scene.skyboxMip&&(e.loadFaces=!0),this.assets.load(e),this._onSkyboxChange(e)},e._skyboxRemove=function(e){this._skyboxLast&&(this.assets.off("add:"+e.id,this.setSkybox,this),this.assets.off("load:"+e.id,this._onSkyboxChange,this),this.assets.off("remove:"+e.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},e._firstBake=function(){this.lightmapper.bake(null,this.scene.lightmapMode)},e._firstBatch=function(){this.scene._needsStaticPrepare&&(this.renderer.prepareStaticMeshes(this.graphicsDevice,this.scene),this.scene._needsStaticPrepare=!1),this.batcher.generate()},e._processTimestamp=function(e){return e},e._preRenderImmediate=function(){this._immediateData.finalize()},e._postRenderImmediate=function(){this._immediateData.clear()},e._initImmediate=function(){this._immediateData||(this._immediateData=new Ja(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},e._addLines=function(e,t,i){var n=i&&i.layer?i.layer:this.scene.layers.getLayerById(3),a=!i||void 0===i.depthTest||i.depthTest,s=i&&i.mask?i.mask:void 0;this._initImmediate(),this._immediateData.prepareLineBatch(n,a,s,e.length/2).addLines(e,t)},e.renderLine=function(e,t,i){var n,a=i,s=arguments[3],r=arguments[4];s instanceof $?(a=s,"number"==typeof r?(sm||(sm=!0),n=1===r?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):n=r):"number"==typeof s?(sm||(sm=!0),a=i,n=1===s?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):s&&(n=s),this._addLines([e,t],[i,a],n)},e.renderLines=function(e,t,i){i?"number"==typeof i&&(sm||(sm=!0),i=1===i?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):i={layer:this.scene.layers.getLayerById(3),depthTest:!0},t.length&&e.length!==t.length||e.length%2==0&&this._addLines(e,t,i)},e._getDefaultImmediateOptions=function(e){return void 0===e&&(e=!1),{layer:this.scene.layers.getLayerById(3),depthTest:e}},e.renderWireCube=function(e,t,i){void 0===i&&(i=this._getDefaultImmediateOptions(!0)),this._initImmediate(),this._immediateData.renderWireCube(e,t,i)},e.renderWireSphere=function(e,t,i,n){void 0===n&&(n=this._getDefaultImmediateOptions(!0)),this._initImmediate(),this._immediateData.renderWireSphere(e,t,i,n)},e.renderMeshInstance=function(e,t){void 0===t&&(t=this._getDefaultImmediateOptions(!0)),this._initImmediate(),this._immediateData.renderMesh(null,null,null,e,t)},e.renderMesh=function(e,t,i,n){void 0===n&&(n=this._getDefaultImmediateOptions(!0)),this._initImmediate(),this._immediateData.renderMesh(t,i,e,null,n)},e.renderQuad=function(e,t,i){void 0===i&&(i=this._getDefaultImmediateOptions()),this._initImmediate(),this._immediateData.renderMesh(t,e,this._immediateData.getQuadMesh(),null,i)},e.renderTexture=function(e,t,i,n,a,s,r){this._initImmediate();var o=new pe;o.setTRS(new de(e,t,0),fe.IDENTITY,new de(i,n,0)),s||((s=new Ui).setParameter("colorMap",a),s.shader=this._immediateData.getTextureShader(),s.update()),this.renderQuad(o,s,r)},e.renderDepthTexture=function(e,t,i,n,a){this._initImmediate();var s=new Ui;s.shader=this._immediateData.getDepthTextureShader(),s.update(),this.renderTexture(e,t,i,n,null,s,a)},e.destroy=function(){if(this._inFrameUpdate)this._destroyRequested=!0;else{var e,t,i=this.graphicsDevice.canvas.id;this.off("librariesloaded"),document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1),this._visibilityChangeHandler=null,this.onVisibilityChange=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null);var n=this.systems.list;for(e=0,t=n.length;e<t;e++)n[e].destroy();qh.destroy(),this.scene.layers&&this.scene.layers.destroy();var a=this.assets.list();for(e=0;e<a.length;e++)a[e].unload(),a[e].off();for(var s in this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null,this.loader.getHandler("script")._cache){var r=this.loader.getHandler("script")._cache[s],o=r.parentNode;o&&o.removeChild(r)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=[],this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper.destroy(),this.lightmapper=null,this.batcher.destroy(),this.batcher=null,this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,Pt&&(Pt.destroy(),Pt=null),this.vr&&(this.vr.destroy(),this.vr=null),this.xr.end(),this.graphicsDevice.destroy(),this.graphicsDevice=null,this.renderer.destroy(),this.renderer=null,this.tick=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),gl.app=null,Ys.DEFAULT_PARAM_TEXTURE=null,l._applications[i]=null,hi()===this&&ci(null)}},e.getEntityFromIndex=function(e){return this._entityIndex[e]},c(l,[{key:"fillMode",get:function(){return this._fillMode}},{key:"resolutionMode",get:function(){return this._resolutionMode}}]),l}(p);om._applications={};var lm={},hm=function(e){var s,r=e;return function(e,t){if(r.graphicsDevice){ci(r),s&&(window.cancelAnimationFrame(s),s=null);var i=(rm=r)._processTimestamp(e)||W(),n=i-(r._time||i),a=n/1e3;a=Se.clamp(a,0,r.maxDeltaTime),a*=r.timeScale,r._time=i,s=r.vr&&r.vr.display?r.vr.display.requestAnimationFrame(r.tick):r.xr.session?r.xr.session.requestAnimationFrame(r.tick):window.requestAnimationFrame(r.tick),r.graphicsDevice.contextLost||(r._fillFrameStatsBasic(i,a,n),r._inFrameUpdate=!0,r.fire("frameupdate",n),t?(r.xr.update(t),r.graphicsDevice.defaultFramebuffer=t.session.renderState.baseLayer.framebuffer):r.graphicsDevice.defaultFramebuffer=null,r.update(a),r.fire("framerender"),(r.autoRender||r.renderNextFrame)&&(r.updateCanvasSize(),r.render(),r.renderNextFrame=!1),lm.timestamp=W(),(lm.target=r).fire("frameend",lm),r.fire("frameEnd",lm),r.vr&&r.vr.display&&r.vr.display.presenting&&r.vr.display.submitFrame(),r._inFrameUpdate=!1,r._destroyRequested&&r.destroy())}}},cm=[],um=[],dm=[],pm=[],fm={},mm=[],vm=function(){function e(){}return e.prototype.copy=function(e){for(var t in e)e.hasOwnProperty(t)&&"copy"!==t&&(this[t]=e[t])},e}(),gm=function(t){function n(){var e;return(e=t.call(this)||this)._preCameraMappingNeededMatrix=new pe,e._assetReferences={},e._validator=null,e.shaderOptBuilder=new Ni,e.reset(),e}u(n,t);var e=n.prototype;return e.reset=function(){for(var e=0;e<cm.length;e++){var t=um[e];this[cm[e]]=t&&t.clone?t.clone():t}for(var i=0;i<dm.length;i++)this[dm[i]]=null;for(var n=0;n<pm.length;n++)this[pm[n]]=new Float32Array(3);this._chunks=new vm,this.cubeMapMinUniform=new Float32Array(3),this.cubeMapMaxUniform=new Float32Array(3)},e.clone=function(){var e=new n;this._cloneInternal(e);for(var t=0;t<cm.length;t++){var i=cm[t];void 0!==this[i]&&(this[i]&&this[i].copy?e[i]?e[i].copy(this[i]):e[i]=this[i].clone():e[i]=this[i])}return e},e._updateMapMappingTypeReverseTilingModeCameraLock=function(e,t){return e=e||0,t},e._updateMapTilingOffset=function(e,t){return(e=e||new J).set(t.x,t.y),e},e._updateMapRadianPlaneMappingDepth=function(e,t){return e=e||0,t},e._updateMapTranslationRotationScaleGizmoPlanePosWS=function(e,t){return(e=e||new de).set(t.x,t.y,t.z),e},e._setParameter=function(e,t){this.parameters[e]||this._propsSet.push(e),this.setParameter(e,t)},e._clearParameters=function(){for(var e=this._propsSet,t=0;t<e.length;t++)delete this.parameters[e[t]];this._propsSet=[]},e._updateMap=function(e,t){var i=e+"Map",n=this[i];if(n){this._setParameter("texture_"+i,n);var a=i+"MappingType";this[a]=this._updateMapMappingTypeReverseTilingModeCameraLock(this[a],this[i+"MappingType"]);var s=this[a],r=i+"MappingTypeUniform",o=this[r];o||(o=new Float32Array(1),this[r]=o),o=s,this._setParameter(a,o);var l=i+"Tiling";this[l]=this._updateMapTilingOffset(this[l],this[i+"Tiling"]);var h=this[l],c=i+"TilingUniform",u=this[c];u||(u=new Float32Array([h.x,h.y]),this[c]=u),0!==s&&1!==s?(u[0]=1/h.x,u[1]=1/h.y):(u[0]=h.x,u[1]=h.y),this._setParameter(l,u);var d=i+"Offset";this[d]=this._updateMapTilingOffset(this[d],this[i+"Offset"]);var p=this[d],f=i+"OffsetUniform",m=this[f];m||(m=new Float32Array(2),this[f]=m),m[0]=p.x,m[1]=p.y,this._setParameter(d,m);var v=i+"Radian";this[v]=this._updateMapRadianPlaneMappingDepth(this[v],this[i+"Radian"]);var g=this[v],_=i+"RadianUniform",y=this[_];if(y||(y=new Float32Array(1),this[_]=y),y=g*Se.DEG_TO_RAD,this._setParameter(v,y),2===s||4===s||3===s){var b=i+"MappingTranslation",x=i+"MappingRotation",M=i+"MappingScale";this[b]=this._updateMapTranslationRotationScaleGizmoPlanePosWS(this[b],this[i+"MappingTranslation"]),this[x]=this._updateMapTranslationRotationScaleGizmoPlanePosWS(this[x],this[i+"MappingRotation"]),this[M]=this._updateMapTranslationRotationScaleGizmoPlanePosWS(this[M],this[i+"MappingScale"]);var S=this[b],w=this[x],C=this[M],P=i+"MappingMatrixUniform",T=this[P];T||(T=new Float32Array(16),this[P]=T);var A=new pe;A.setTRS(new de(-S.x,-S.y,-S.z),(new fe).setFromEulerAngles(-w.x,-w.y,-w.z),2===s?C:new de(1/C.x,1/C.y,1/C.z)),T=A.data,this._setParameter(i+"MappingMatrix",T),this._setParameter(i+"MappingPosition",[-S.x,-S.y,-S.z])}else if(5===s){var E=i+"MappingTranslation",R=i+"MappingRotation",D=i+"MappingScale",I=i+"GizmoPlanePosWS";this[E]=this._updateMapTranslationRotationScaleGizmoPlanePosWS(this[E],this[i+"MappingTranslation"]),this[R]=this._updateMapTranslationRotationScaleGizmoPlanePosWS(this[R],this[i+"MappingRotation"]),this[D]=this._updateMapTranslationRotationScaleGizmoPlanePosWS(this[D],this[i+"MappingScale"]),this[I]=this._updateMapTranslationRotationScaleGizmoPlanePosWS(this[I],this[i+"GizmoPlanePosWS"]);var k=this[E],L=this[R],O=this[D],F=this[I],z=new pe;z.setFromEulerAngles(-L.x,-L.y,-L.z);var B=new de;B.add(F),B.add(new de(-k.x,-k.y,-k.z)),B=z.transformVector(B);var V=new de;V.add(B),V.add(z.transformVector(new de(0,1,0)));var U=z.transformVector(new de(0,0,-1)).normalize(),N=new pe;N.setLookAt(V,B,U);var G=new pe;G.setOrtho(-h.x*O.x,h.x*O.x,-h.y*O.y,h.y*O.y,.1,1e3);var W=i+"MappingMatrixUniform",H=this[W];H||(H=new Float32Array(16),this[W]=H),H=G.mul(N).data,this._setParameter(i+"MappingMatrix",H),this._setParameter(i+"MappingPosition",[k.x,k.y,k.z]);var j=i+"GizmoPlanePosWSUniform",X=this[j];X||(X=new Float32Array(3),this[j]=X),X[0]=B.x,X[1]=B.y,X[2]=B.z,this._setParameter(i+"GizmoPlanePosWS",X);var q=i+"PlaneMappingCameraFrontUniform",$=this[q];$||($=new Float32Array(3),this[q]=$);var Y=B;Y.sub(V),Y.normalize(),$[0]=Y.x,$[1]=Y.y,$[2]=Y.z,this._setParameter(i+"PlaneMappingCameraFront",$);var K=i+"PlaneMappingDepth";this[K]=this._updateMapRadianPlaneMappingDepth(this[K],this[i+"PlaneMappingDepth"]);var Z=this[K],Q=i+"PlaneMappingDepthUniform",J=this[Q];J||(J=new Float32Array(1),this[Q]=J),J=Z,this._setParameter(K,J)}else if(6===s){!1===this[i+"CameraMappingLock"]&&t&&(this._preCameraMappingNeededMatrix=t.projectionMatrix.clone(),this._preCameraMappingNeededMatrix.mul(t.viewMatrix));var ee=i+"MappingMatrixUniform",te=this[ee];te||(te=new Float32Array(16),this[ee]=te),te=this._preCameraMappingNeededMatrix.data,this._setParameter(i+"MappingMatrix",te)}else if(7===s){!1===this[i+"CameraMappingLock"]&&t&&(this._preCameraMappingNeededMatrix=(new pe).setOrtho(-h.x,h.x,-h.y,h.y,t.nearClip,t.farClip),this._preCameraMappingNeededMatrix.mul(t.viewMatrix));var ie=i+"MappingMatrixUniform",ne=this[ie];ne||(ne=new Float32Array(16),this[ie]=ne),ne=this._preCameraMappingNeededMatrix.data,this._setParameter(i+"MappingMatrix",ne)}var ae=i+"ReverseMode";this[ae]=this._updateMapMappingTypeReverseTilingModeCameraLock(this[ae],this[i+"ReverseMode"]);var se=this[ae],re=i+"ReverseModeUniform",oe=this[re];oe||(oe=new Float32Array(1),this[re]=oe),oe=se,this._setParameter(ae,oe);var le=i+"TilingMode";this[le]=this._updateMapMappingTypeReverseTilingModeCameraLock(this[le],this[i+"TilingMode"]);var he=this[le],ce=i+"TilingModeUniform",ue=this[ce];ue||(ue=new Float32Array(1),this[ce]=ue),ue=he,this._setParameter(le,ue)}},e.getUniform=function(e,t,i){var n=fm[e];return n?n(this,t,i):null},e.updateUniforms=function(e){this._clearParameters(),this._setParameter("material_ambient",this.ambientUniform),this._setParameter("material_diffuse",this.diffuseUniform),this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform),this.useMetalness&&(!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),0<this.clearCoat&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness));var t=this.getUniform("shininess",this.shininess,!0);for(var i in this._setParameter(t.name,t.value),this._setParameter("material_roughness",this.roughness),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",this.emissiveUniform),this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),0<this.refraction&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),1<=this.ior&&this._setParameter("ior",this.ior||1.5),0<=this.transmission&&(this._setParameter("material_transmission",this.transmission||0),this._setParameter("material_diffuseTransmission",this.diffuseTransmissionUniform||new Float32Array([0,0,0])),this._setParameter("material_specularTransmission",this.specularTransmissionUniform||new Float32Array([1,1,1]))),0<=this.thickness&&this._setParameter("material_thickness",this.thickness||0),this.attenuationColor&&this._setParameter("attenuationColor",this.attenuationColorUniform||[1,1,1]),0<this.attenuationDistance&&this._setParameter("attenuationDistance",this.attenuationDistance,0),this.subsurfaceColor&&this._setParameter("subsurfaceColor",this.subsurfaceColorUniform||[0,0,0]),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0)),Ci)this._updateMap(i,e);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&(t=this.getUniform("heightMapFactor",this.heightMapFactor,!0),this._setParameter(t.name,t.value)),this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap),this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]?this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]):rm.scene&&rm.scene._skyboxPrefiltered[0]&&this._setParameter("texture_prefilteredCubeMap128",rm.scene._skyboxPrefiltered[0]),this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]),this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]),this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]),this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]),this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]),this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas),this._setParameter("material_reflectivity",this.reflectivity),this.useClearCoat&&(this._setParameter("useClearCoat",this.useClearCoat),this._setParameter("uClearCoatFactor",this.uClearCoatFactor),this._setParameter("uClearCoatIor",this.uClearCoatIor),this._setParameter("uClearCoatF0",this.uClearCoatF0),this._setParameter("uClearCoatThickness",this.uClearCoatThickness),this._setParameter("uClearCoatFresnelPower",this.uClearCoatFresnelPower),this.uClearCoatMap?this._setParameter("texture_uClearCoatMap",this.uClearCoatMap):this._setParameter("uClearCoatColor",this.uClearCoatColorUniform)),!this.dirtyShader&&this._scene||(this.shader=null,this.clearVariants()),this._processColor()},e._processColor=function(){if(this.dirtyColor&&(this._scene||!this.useGammaTonemap)){var e=!1;this.useGammaTonemap&&(e=this._scene.gammaCorrection);for(var t=0;t<mm.length;t++){var i=this["_"+mm[t]],n=this[mm[t]+"Uniform"];e?(n[0]=Math.pow(i.r,2.2),n[1]=Math.pow(i.g,2.2),n[2]=Math.pow(i.b,2.2)):(n[0]=i.r,n[1]=i.g,n[2]=i.b)}for(var a=0;a<3;a++)this.emissiveUniform[a]*=this.emissiveIntensity;this.dirtyColor=!1}},e.updateShader=function(e,t,i,n,a,s){var r=this;!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());var o,l,h,c,u,d,p=1<a&&a<=18,f=p?Pi.optionsContextMin:Pi.optionsContext,m=e.useTexCubeLod,v=!e.extTextureLod;this.useSkybox&&(o=t._skyboxPrefiltered[0],l=t._skyboxPrefiltered[1],h=t._skyboxPrefiltered[2],c=t._skyboxPrefiltered[3],u=t._skyboxPrefiltered[4],d=t._skyboxPrefiltered[5]);var g,_,y=this.prefilteredCubeMap128||o,b=this.prefilteredCubeMap64||l,x=this.prefilteredCubeMap32||h,M=this.prefilteredCubeMap16||c,S=this.prefilteredCubeMap8||u,w=this.prefilteredCubeMap4||d;if(y){var C=y&&b&&x&&M&&S&&w;if(v&&C){if(!y.dpAtlas){var P=[y,b,x,M,S,w];y.dpAtlas=Bi(e,P),y.sh=Um(e,M)}this.dpAtlas=y.dpAtlas,this.ambientSH=y.sh,this._setParameter("ambientSH[0]",this.ambientSH),this._setParameter("texture_sphereMap",this.dpAtlas)}else m?y._levels.length<6?C&&this._setParameter("texture_prefilteredCubeMap128",y):this._setParameter("texture_prefilteredCubeMap128",y):C&&(this._setParameter("texture_prefilteredCubeMap128",y),this._setParameter("texture_prefilteredCubeMap64",b),this._setParameter("texture_prefilteredCubeMap32",x),this._setParameter("texture_prefilteredCubeMap16",M),this._setParameter("texture_prefilteredCubeMap8",S),this._setParameter("texture_prefilteredCubeMap4",w));this.useSkybox&&!t.skyboxRotation.equals(fe.IDENTITY)&&t._skyboxRotationMat3&&this._setParameter("cubeMapRotationMatrix",t._skyboxRotationMat3.data),f.useIBL=!0}else f.useIBL=!1;if(1!==f.oit&&2!==f.oit||null!=(g=rm.renderer)&&null!=(_=g.transmissionRenderTarget)&&_.depthBuffer&&this._setParameter("uOpaqueDepth",rm.renderer.transmissionRenderTarget.depthBuffer),1!==f.oit||f.accumOIT||(rm.renderer.transparentRenderTarget&&(this._setParameter("uAccumulate",rm.renderer.transparentRenderTarget.colorBuffer),this._setParameter("uResolution",[e.width,e.height])),rm.renderer.accumAlphaRenderTarget&&this._setParameter("uAccumulateAlpha",rm.renderer.accumAlphaRenderTarget.colorBuffer)),t.irradianceMap&&this._setParameter("irradianceMap",t.irradianceMap),t.prefilterMaps&&t.prefilterMaps.forEach(function(e,t){r._setParameter("prefilterMap"+t,e)}),t.brdfLUT&&this._setParameter("brdfLUT",t.brdfLUT),0<f.transmission){var T=rm.renderer.transmissionRenderTarget;T&&(this._setParameter("transmissionSamplerMap",T.colorBuffer),this._setParameter("transmissionSamplerSize",[T.width,T.height]))}var A=[],E=i?i>>16:1;s&&(this.shaderOptBuilder._collectLights(0,s[0],A,E),this.shaderOptBuilder._collectLights(1,s[1],A,E,n),this.shaderOptBuilder._collectLights(2,s[2],A,E,n)),p?this.shaderOptBuilder.updateMinRef(f,e,t,this,i,n,a,s,y):this.shaderOptBuilder.updateRef(f,e,t,this,i,n,a,s,y),this.onUpdateShader&&(f=this.onUpdateShader(f));var R=e.getProgramLibrary();this.shader=R.getProgram("standard",f),i||(this.clearVariants(),this.variants[0]=this.shader),this.dirtyShader=!1},e.setPBRMaps=function(e){var i=this;e.irradianceMap&&this._setParameter("irradianceMap",e.irradianceMap),e.prefilterMaps&&e.prefilterMaps.forEach(function(e,t){i._setParameter("prefilterMap"+t,e)}),e.brdfLUT&&this._setParameter("brdfLUT",e.brdfLUT)},n}(Ui);function _m(e,t,i,n,a,s,r){var o="_"+t+"Map",l=o+"MappingType",h=o+"Tiling",c=o+"Offset",u=o+"Radian",d=o+"MappingTranslation",p=o+"MappingRotation",f=o+"MappingScale",m=o+"GizmoPlanePosWS",v=o+"PlaneMappingDepth",g=o+"CameraMappingLock",_=o+"ReverseMode",y=o+"TilingMode",b=h+"Uniform",x=c+"Uniform",M=u+"Uniform",S=d+"Uniform",w=p+"Uniform",C=f+"Uniform",P=l+"Uniform",T=m+"Uniform",A=v+"Uniform",E=g+"Uniform",R=_+"Uniform",D=y+"Uniform",I=o+"Uv",k=o+"Channel",L="_"+t+"VertexColor",O="_"+t+"VertexColorChannel",F="_"+t+"Mode";if(e[o]=null,e[I]=i,e[l]=0,e[h]=new J(1,1),e[c]=new J(0,0),e[u]=0,e[d]=new de(0,0,0),e[p]=new de(0,0,0),e[f]=new de(1,1,1),e[m]=new de(0,0,0),e[v]=0,e[g]=!1,e[_]=3,e[y]=2,e[b]=null,e[x]=null,e[M]=null,e[S]=null,e[w]=null,e[C]=null,e[P]=null,e[T]=null,e[A]=null,e[E]=null,e[R]=null,e[D]=null,0<n){var z=a||(1<n?"rgb":"g");e[k]=z,s&&(e[O]=z)}s&&(e[L]=!1),r&&(e[F]="mul"),Ci[t]=n,Object.defineProperty(gm.prototype,o.substring(1),{get:function(){return this[o]},set:function(e){var t=this[o];!!t^!!e&&(this.dirtyShader=!0),t&&e&&(t.type===e.type&&t.fixCubemapSeams===e.fixCubemapSeams&&t.format===e.format||(this.dirtyShader=!0)),this[o]=e}});var B=l.substring(1);Object.defineProperty(gm.prototype,B,{get:function(){return this[l]},set:function(e){this.dirtyShader=!0,this[l]=e}}),fm[B]=function(e,t,i){var n=e._updateMapMappingTypeReverseTilingModeCameraLock(i?e[B]:null,t);return{name:B,value:n.data}};var V=h.substring(1);Object.defineProperty(gm.prototype,V,{get:function(){return this[h]},set:function(e){this.dirtyShader=!0,this[h]=e}}),fm[V]=function(e,t,i){var n=e._updateMapTilingOffset(i?e[V]:null,t);return{name:V,value:n.data}};var U=c.substring(1);Object.defineProperty(gm.prototype,U,{get:function(){return this[c]},set:function(e){this.dirtyShader=!0,this[c]=e}}),fm[U]=function(e,t,i){var n=e._updateMapTilingOffset(i?e[U]:null,t);return{name:U,value:n.data}};var N=u.substring(1);Object.defineProperty(gm.prototype,N,{get:function(){return this[u]},set:function(e){this.dirtyShader=!0,this[u]=e}}),fm[N]=function(e,t,i){var n=e._updateMapRadianPlaneMappingDepth(i?e[N]:null,t);return{name:N,value:n.data}};var G=d.substring(1);Object.defineProperty(gm.prototype,G,{get:function(){return this[d]},set:function(e){this.dirtyShader=!0,this[d]=e}}),fm[G]=function(e,t,i){var n=e._updateMapTranslationRotationScaleGizmoPlanePosWS(i?e[G]:null,t);return{name:G,value:n.data}};var W=p.substring(1);Object.defineProperty(gm.prototype,W,{get:function(){return this[p]},set:function(e){this.dirtyShader=!0,this[p]=e}}),fm[W]=function(e,t,i){var n=e._updateMapTranslationRotationScaleGizmoPlanePosWS(i?e[W]:null,t);return{name:W,value:n.data}};var H=f.substring(1);Object.defineProperty(gm.prototype,H,{get:function(){return this[f]},set:function(e){this.dirtyShader=!0,this[f]=e}}),fm[H]=function(e,t,i){var n=e._updateMapTranslationRotationScaleGizmoPlanePosWS(i?e[H]:null,t);return{name:H,value:n.data}};var j=m.substring(1);Object.defineProperty(gm.prototype,j,{get:function(){return this[m]},set:function(e){this.dirtyShader=!0,this[m]=e}}),fm[j]=function(e,t,i){var n=e._updateMapTranslationRotationScaleGizmoPlanePosWS(i?e[j]:null,t);return{name:j,value:n.data}};var X=v.substring(1);Object.defineProperty(gm.prototype,X,{get:function(){return this[v]},set:function(e){this.dirtyShader=!0,this[v]=e}}),fm[X]=function(e,t,i){var n=e._updateMapRadianPlaneMappingDepth(i?e[X]:null,t);return{name:X,value:n.data}};var q=g.substring(1);Object.defineProperty(gm.prototype,q,{get:function(){return this[g]},set:function(e){this.dirtyShader=!0,this[g]=e}}),fm[q]=function(e,t,i){var n=e._updateMapMappingTypeReverseTilingModeCameraLock(i?e[q]:null,t);return{name:q,value:n.data}};var $=_.substring(1);Object.defineProperty(gm.prototype,$,{get:function(){return this[_]},set:function(e){this.dirtyShader=!0,this[_]=e}}),fm[$]=function(e,t,i){var n=e._updateMapMappingTypeReverseTilingModeCameraLock(i?e[$]:null,t);return{name:$,value:n.data}};var Y=y.substring(1);Object.defineProperty(gm.prototype,Y,{get:function(){return this[y]},set:function(e){this.dirtyShader=!0,this[y]=e}}),fm[Y]=function(e,t,i){var n=e._updateMapMappingTypeReverseTilingModeCameraLock(i?e[Y]:null,t);return{name:Y,value:n.data}},Object.defineProperty(gm.prototype,I.substring(1),{get:function(){return this[I]},set:function(e){this[I]!==e&&(this.dirtyShader=!0),this[I]=e}}),Object.defineProperty(gm.prototype,k.substring(1),{get:function(){return this[k]},set:function(e){this[k]!==e&&(this.dirtyShader=!0),this[k]=e}}),s&&(Object.defineProperty(gm.prototype,L.substring(1),{get:function(){return this[L]},set:function(e){this.dirtyShader=!0,this[L]=e}}),Object.defineProperty(gm.prototype,O.substring(1),{get:function(){return this[O]},set:function(e){this[O]!==e&&(this.dirtyShader=!0),this[O]=e}})),r&&Object.defineProperty(gm.prototype,F.substring(1),{get:function(){return this[F]},set:function(e){this.dirtyShader=!0,this[F]=e}}),cm.push(o.substring(1)),cm.push(l.substring(1)),cm.push(h.substring(1)),cm.push(c.substring(1)),cm.push(u.substring(1)),cm.push(d.substring(1)),cm.push(p.substring(1)),cm.push(f.substring(1)),cm.push(v.substring(1)),cm.push(g.substring(1)),cm.push(_.substring(1)),cm.push(y.substring(1)),cm.push(I.substring(1)),cm.push(k.substring(1)),s&&(cm.push(L.substring(1)),cm.push(O.substring(1))),r&&cm.push(F.substring(1))}function ym(e,r,t,o){var l="_"+r,h=r+"Uniform",i=r+"Intensity",c="_"+i;e[l]=t,e[h]=new Float32Array(3),Object.defineProperty(gm.prototype,r,{get:function(){return this.dirtyColor=!0,this.dirtyShader=!0,this[l]},set:function(e){var t=this[l];(0===t.r&&0===t.g&&0===t.b||1===t.r&&1===t.g&&1===t.b)^(0===e.r&&0===e.g&&0===e.b||1===e.r&&1===e.g&&1===e.b)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[l]=e}}),cm.push(r),pm.push(h),mm.push(r),fm[r]=function(e,t,i){var n=i?e[h]:new Float32Array(3),a=!1;e.useGammaTonemap&&(a=(e._scene||hi().scene).gammaCorrection);for(var s=0;s<3;s++)n[s]=a?Math.pow(t.data[s],2.2):t.data[s],o&&(n[s]*=e[c]);return{name:"material_"+r,value:n}},o&&(e[c]=1,Object.defineProperty(gm.prototype,i,{get:function(){return this[c]},set:function(e){var t=this[c];(0===t||1===t)^(0===e||1===e)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[c]=e}}),cm.push(i),fm[i]=function(e,t,i){var n=i?e[h]:new Float32Array(3),a=!1;e.useGammaTonemap&&(a=(e._scene||hi().scene).gammaCorrection);for(var s=0;s<3;s++)n[s]=a?Math.pow(e[l].data[s],2.2):e[l].data[s],n[s]*=e[c];return{name:"material_"+r,value:n}})}function bm(e,n,t,i){var a="_"+n;e[a]=t,Object.defineProperty(gm.prototype,n,{get:function(){return this[a]},set:function(e){var t=this[a];t!==e&&(this[a]=e,(0===t||1===t||0===e||1===e)&&(this.dirtyShader=!0))}}),cm.push(n),fm[n]=void 0!==i?i:function(e,t,i){return{name:"material_"+n,value:t}}}function xm(e,t,i){var n="_"+t;e[n]=null,Object.defineProperty(gm.prototype,t,{get:function(){return this[n]},set:function(e){!!this[n]^!!e&&(this.dirtyShader=!0),this[n]=e}}),cm.push(t),fm[t]=i}function Mm(e,t,i){Object.defineProperty(gm.prototype,i,{get:function(){return this[t]},set:function(e){this[t]=e}})}function Sm(e,t,i){var n="_"+t;e[n]=i,Object.defineProperty(gm.prototype,t,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this.dirtyShader=!0),this[n]=e}}),cm.push(t)}gm.TEXTURE_PARAMETERS=Hi,gm.CUBEMAP_PARAMETERS=ji,function(e){e.dirtyShader=!0,e.dirtyColor=!0,e._scene=null,e._colorProcessed=!1,ym(e,"ambient",new $(.7,.7,.7)),ym(e,"diffuse",new $(1,1,1)),ym(e,"specular",new $(.33,.33,.33)),ym(e,"emissive",new $(0,0,0),!0),ym(e,"uClearCoatColor",new $(0,0,0)),ym(e,"attenuationColor",new $(1,1,1)),ym(e,"subsurfaceColor",new $(.55,.55,.55)),ym(e,"diffuseTransmission",new $(0,0,0)),ym(e,"specularTransmission",new $(1,1,1)),bm(e,"shininess",80,function(e,t){return{name:"material_shininess",value:0===e.shadingModel?Math.pow(2,.01*t*11):.01*t}}),bm(e,"roughness",.2),bm(e,"heightMapFactor",1,function(e,t){return{name:"material_heightMapFactor",value:.025*t}}),bm(e,"opacity",1),bm(e,"alphaFade",1),bm(e,"alphaTest",0),bm(e,"bumpiness",1),bm(e,"normalDetailMapBumpiness",1),bm(e,"reflectivity",1),bm(e,"occludeSpecularIntensity",1),bm(e,"refraction",0),bm(e,"refractionIndex",1/1.5),bm(e,"metalness",1),bm(e,"anisotropy",0),bm(e,"clearCoat",0),bm(e,"clearCoatGlossiness",1),bm(e,"clearCoatBumpiness",1),bm(e,"transmission",0),bm(e,"ior",1.5),bm(e,"thickness",0),bm(e,"attenuationDistance",0),bm(e,"uClearCoatFactor",1),bm(e,"uClearCoatIor",1),bm(e,"uClearCoatF0",.08),bm(e,"uClearCoatThickness",.01),bm(e,"uClearCoatReflection",1),bm(e,"uClearCoatF0Radio",.04),bm(e,"uClearCoatFresnelPower",3),bm(e,"aoUvSet",0,null),xm(e,"ambientSH",function(e,t,i){return{name:"ambientSH[0]",value:t}}),xm(e,"cubeMapProjectionBox",function(e,t,i){var n=i?e.cubeMapMinUniform:new Float32Array(3),a=i?e.cubeMapMaxUniform:new Float32Array(3);return n[0]=t.center.x-t.halfExtents.x,n[1]=t.center.y-t.halfExtents.y,n[2]=t.center.z-t.halfExtents.z,a[0]=t.center.x+t.halfExtents.x,a[1]=t.center.y+t.halfExtents.y,a[2]=t.center.z+t.halfExtents.z,[{name:"envBoxMin",value:n},{name:"envBoxMax",value:a}]}),Object.defineProperty(gm.prototype,"chunks",{get:function(){return this.dirtyShader=!0,this._chunks},set:function(e){this.dirtyShader=!0,this._chunks=e}}),cm.push("chunks"),Sm(e,"ambientTint",!1),Sm(e,"diffuseTint",!1),Sm(e,"specularTint",!1),Sm(e,"emissiveTint",!1),Sm(e,"fastTbn",!1),Sm(e,"specularAntialias",!1),Sm(e,"useMetalness",!1),Sm(e,"enableGGXSpecular",!1),Sm(e,"occludeDirect",!1),Sm(e,"normalizeNormalMap",!0),Sm(e,"conserveEnergy",!0),Sm(e,"opacityFadesSpecular",!0),Sm(e,"occludeSpecular",1),Sm(e,"shadingModel",1),Sm(e,"fresnelModel",2),Sm(e,"cubeMapProjection",0),Sm(e,"customFragmentShader",null),Sm(e,"forceFragmentPrecision",null),Sm(e,"useFog",!0),Sm(e,"useLighting",!0),Sm(e,"useGammaTonemap",!0),Sm(e,"useSkybox",!0),Sm(e,"useClearCoat",!1),Sm(e,"forceUv1",!1),Sm(e,"pixelSnap",!1),Sm(e,"twoSidedLighting",!1),Sm(e,"nineSlicedMode",void 0),_m(e,"diffuse",0,3,"",!0),_m(e,"specular",0,3,"",!0),_m(e,"emissive",0,3,"",!0),_m(e,"normal",0,-1,"",!1),_m(e,"metalness",0,1,"",!0),_m(e,"gloss",0,1,"",!0),_m(e,"roughness",0,1,"",!0),_m(e,"opacity",0,1,"a",!0),_m(e,"height",0,1,"",!1),_m(e,"ao",0,1,"",!0),_m(e,"light",1,3,"",!0),_m(e,"msdf",0,3,"",!1),_m(e,"diffuseDetail",0,3,"",!1,!0),_m(e,"normalDetail",0,-1,"",!1),_m(e,"uClearCoat",0,3,"",!0),_m(e,"clearCoat",0,1,"",!0),_m(e,"clearCoatGloss",0,1,"",!0),_m(e,"clearCoatNormal",0,-1,"",!1),_m(e,"transmission",0,1,"r",!1,null),_m(e,"thickness",0,1,"g",!1,null),xm(e,"cubeMap"),xm(e,"sphereMap"),xm(e,"dpAtlas"),xm(e,"prefilteredCubeMap128"),xm(e,"prefilteredCubeMap64"),xm(e,"prefilteredCubeMap32"),xm(e,"prefilteredCubeMap16"),xm(e,"prefilteredCubeMap8"),xm(e,"prefilteredCubeMap4"),Mm(0,"diffuseTint","diffuseMapTint"),Mm(0,"specularTint","specularMapTint"),Mm(0,"emissiveTint","emissiveMapTint"),Mm(0,"aoVertexColor","aoMapVertexColor"),Mm(0,"diffuseVertexColor","diffuseMapVertexColor"),Mm(0,"specularVertexColor","specularMapVertexColor"),Mm(0,"emissiveVertexColor","emissiveMapVertexColor"),Mm(0,"metalnessVertexColor","metalnessMapVertexColor"),Mm(0,"glossVertexColor","glossMapVertexColor"),Mm(0,"opacityVertexColor","opacityMapVertexColor"),Mm(0,"lightVertexColor","lightMapVertexColor");for(var t=0;t<cm.length;t++)um[t]=e[cm[t]];e._propsSet=[]}(gm.prototype);var wm=function(){function e(e){this._device=e,this._cache={},this._generators={},this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption={},this._defaultStdMatOptionMin={};var t=new gm;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,e,{},t,null,[],0,null,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,e,{},t,null,[],3,null,null)}var t=e.prototype;return t.register=function(e,t){this.isRegistered(e)||(this._generators[e]=t)},t.unregister=function(e){this.isRegistered(e)&&delete this._generators[e]},t.isRegistered=function(e){return void 0!==this._generators[e]},t.getProgram=function(e,t){var i=this._generators[e];if(void 0===i)return null;var n=this._device,a=i.generateKey(t),s=this._cache[a];if(!s){var r;t.lights&&(r=t.lights,t.lights=r.map(function(e){var t=e.clone?e.clone():e;return t.key=e.key,t})),this.storeNewProgram(e,t),t.lights&&(t.lights=r),this._precached;var o=i.createShaderDefinition(n,t);(s=this._cache[a]=new Et(n,o)).key=a}return s},t.storeNewProgram=function(e,t){var i={};if("standard"===e){var n=this._getDefaultStdMatOptions(t.pass);for(var a in t)(t.hasOwnProperty(a)&&n[a]!==t[a]||"pass"===a)&&(i[a]=t[a])}else i=t;this._programsCollection.push(JSON.stringify({name:e,options:i}))},t.dumpPrograms=function(){var e="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";e+="let shaders = [",this._programsCollection[0]&&(e+="\n\t"+this._programsCollection[0]);for(var t=1;t<this._programsCollection.length;++t)e+=",\n\t"+this._programsCollection[t];e+="\n];\n",e+="device.programLib.precompile(shaders);\n",e+='if (pc.version != "2.0.0" || pc.revision != "32decc1")\n',e+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';var i=document.createElement("a");i.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),i.setAttribute("download","precompile-shaders.js"),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)},t.clearCache=function(){var e=this._cache;for(var t in this._isClearingCache=!0,e)e.hasOwnProperty(t)&&e[t].destroy();this._cache={},this._isClearingCache=!1},t.removeFromCache=function(e){if(!this._isClearingCache){var t=this._cache;for(var i in t)if(t.hasOwnProperty(i)&&t[i]===e){delete t[i];break}}},t._getDefaultStdMatOptions=function(e){return 1<e&&e<=18?this._defaultStdMatOptionMin:this._defaultStdMatOption},t.precompile=function(e){if(e)for(var t=new Array(e.length),i=0;i<e.length;i++){if("standard"===e[i].name){var n=e[i].options,a=this._getDefaultStdMatOptions(n.pass);for(var s in a)a.hasOwnProperty(s)&&void 0===n[s]&&(n[s]=a[s]);n.useTexCubeLod=this._device.useTexCubeLod}t[i]=this.getProgram(e[i].name,e[i].options)}this._precached=!0},e}(),Cm=function(){function e(){this.globalId=0,this.revision=0}var t=e.prototype;return t.equals=function(e){return this.globalId===e.globalId&&this.revision===e.revision},t.copy=function(e){this.globalId=e.globalId,this.revision=e.revision},t.reset=function(){this.globalId=0,this.revision=0},e}(),Pm=0,Tm=function(){function e(){Pm++,this.version=new Cm,this.version.globalId=Pm}return e.prototype.increment=function(){this.version.revision++},e}(),Am=function(){function e(e){this.name=e,this.value=null,this.versionObject=new Tm}var t=e.prototype;return t.setValue=function(e){this.value=e,this.versionObject.increment()},t.getValue=function(){return this.value},e}(),Em=function(){function e(e){this.name=e,this.variables=new Map}var t=e.prototype;return t.resolve=function(e){return this.variables.has(e)||this.variables.set(e,new Am(e)),this.variables.get(e)},t.removeValue=function(e){for(var t in this.variables){var i=this.variables[t];i.value===e&&(i.value=null)}},e}(),Rm=function(e,t,i,n){if(this.locationId=n,this.scopeId=e.scope.resolve(t),this.version=new Cm,"[0]"===t.substr(t.length-3))switch(i){case 2:i=17;break;case 3:i=21;break;case 4:i=22;break;case 5:i=23}this.dataType=i,this.value=[null,null,null,null],this.array=[]},Dm="resizecanvas";function Im(e,t){var i=e.width,n=e.height;if(t<i||t<n){var a=t/Math.max(i,n),s=Math.floor(i*a),r=Math.floor(n*a),o=document.createElement("canvas");return o.width=s,o.height=r,o.getContext("2d").drawImage(e,0,0,i,n,0,0,s,r),o}return e}function km(e,t){var i=!0,n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,null);var a=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,a),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0),e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE&&(i=!1),e.bindTexture(e.TEXTURE_2D,null),e.deleteTexture(n),e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteFramebuffer(a),i}var Lm=function(v){function e(e,t){var i;(i=v.call(this)||this).canvas=e,i._enableAutoInstancing=!1,i.autoInstancingMaxObjects=16384,i.defaultFramebuffer=null,i._maxPixelRatio=1,i._width=0,i._height=0,i.updateClientRect(),i.shaders=[],i.buffers=[],i.textures=[],i.targets=[],i.contextLost=!1,i._contextLostHandler=function(e){e.preventDefault(),i.contextLost=!0,i.loseContext(),i.fire("devicelost")},i._contextRestoredHandler=function(){i.restoreContext(),i.contextLost=!1,i.fire("devicerestored")};var n=!t||void 0===t.preferWebGl2||t.preferWebGl2?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"],a=null;(t=t||{}).stencil=!0;for(var s=0;s<n.length;s++)if(a=e.getContext(n[s],t)){i.webgl2="webgl2"===n[s];break}if(!a)throw new Error("WebGL not supported");i.gl=a,i._tempEnableSafariTextureUnitWorkaround=!!window.safari;var r,o,l,h,c,u=!!window.chrome,d=-1!==navigator.appVersion.indexOf("Mac");for(var p in i._tempMacChromeBlitFramebufferWorkaround=d&&u&&!t.alpha,window.setupVertexArrayObject(a),e.addEventListener("webglcontextlost",i._contextLostHandler,!1),e.addEventListener("webglcontextrestored",i._contextRestoredHandler,!1),i.initializeExtensions(),i.initializeCapabilities(),i.initializeRenderState(),i.initializeContextCaches(),i.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},i.glAddress=[a.REPEAT,a.CLAMP_TO_EDGE,a.MIRRORED_REPEAT],i.glBlendEquation=[a.FUNC_ADD,a.FUNC_SUBTRACT,a.FUNC_REVERSE_SUBTRACT,i.webgl2?a.MIN:i.extBlendMinmax?i.extBlendMinmax.MIN_EXT:a.FUNC_ADD,i.webgl2?a.MAX:i.extBlendMinmax?i.extBlendMinmax.MAX_EXT:a.FUNC_ADD],i.glBlendFunction=[a.ZERO,a.ONE,a.SRC_COLOR,a.ONE_MINUS_SRC_COLOR,a.DST_COLOR,a.ONE_MINUS_DST_COLOR,a.SRC_ALPHA,a.SRC_ALPHA_SATURATE,a.ONE_MINUS_SRC_ALPHA,a.DST_ALPHA,a.ONE_MINUS_DST_ALPHA],i.glComparison=[a.NEVER,a.LESS,a.EQUAL,a.LEQUAL,a.GREATER,a.NOTEQUAL,a.GEQUAL,a.ALWAYS],i.glStencilOp=[a.KEEP,a.ZERO,a.REPLACE,a.INCR,a.INCR_WRAP,a.DECR,a.DECR_WRAP,a.INVERT],i.glClearFlag=[0,a.COLOR_BUFFER_BIT,a.DEPTH_BUFFER_BIT,a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT,a.STENCIL_BUFFER_BIT,a.STENCIL_BUFFER_BIT|a.COLOR_BUFFER_BIT,a.STENCIL_BUFFER_BIT|a.DEPTH_BUFFER_BIT,a.STENCIL_BUFFER_BIT|a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT],i.glCull=[0,a.BACK,a.FRONT,a.FRONT_AND_BACK],i.glFilter=[a.NEAREST,a.LINEAR,a.NEAREST_MIPMAP_NEAREST,a.NEAREST_MIPMAP_LINEAR,a.LINEAR_MIPMAP_NEAREST,a.LINEAR_MIPMAP_LINEAR],i.glPrimitive=[a.POINTS,a.LINES,a.LINE_LOOP,a.LINE_STRIP,a.TRIANGLES,a.TRIANGLE_STRIP,a.TRIANGLE_FAN],i.glType=[a.BYTE,a.UNSIGNED_BYTE,a.SHORT,a.UNSIGNED_SHORT,a.INT,a.UNSIGNED_INT,a.FLOAT],i.pcUniformType={},i.pcUniformType[a.BOOL]=0,i.pcUniformType[a.INT]=1,i.pcUniformType[a.FLOAT]=2,i.pcUniformType[a.FLOAT_VEC2]=3,i.pcUniformType[a.FLOAT_VEC3]=4,i.pcUniformType[a.FLOAT_VEC4]=5,i.pcUniformType[a.INT_VEC2]=6,i.pcUniformType[a.INT_VEC3]=7,i.pcUniformType[a.INT_VEC4]=8,i.pcUniformType[a.BOOL_VEC2]=9,i.pcUniformType[a.BOOL_VEC3]=10,i.pcUniformType[a.BOOL_VEC4]=11,i.pcUniformType[a.FLOAT_MAT2]=12,i.pcUniformType[a.FLOAT_MAT3]=13,i.pcUniformType[a.FLOAT_MAT4]=14,i.pcUniformType[a.SAMPLER_2D]=15,i.pcUniformType[a.SAMPLER_CUBE]=16,i.webgl2&&(i.pcUniformType[a.SAMPLER_2D_SHADOW]=18,i.pcUniformType[a.SAMPLER_CUBE_SHADOW]=19,i.pcUniformType[a.SAMPLER_3D]=20),i.targetToSlot={},i.targetToSlot[a.TEXTURE_2D]=0,i.targetToSlot[a.TEXTURE_CUBE_MAP]=1,i.targetToSlot[a.TEXTURE_3D]=2,i.commitFunction=[],i.commitFunction[0]=function(e,t){e.value!==t&&(a.uniform1i(e.locationId,t),e.value=t)},i.commitFunction[1]=i.commitFunction[0],i.commitFunction[2]=function(e,t){e.value!==t&&(a.uniform1f(e.locationId,t),e.value=t)},i.commitFunction[3]=function(e,t){c=e.value,r=t[0],o=t[1],c[0]===r&&c[1]===o||(a.uniform2fv(e.locationId,t),c[0]=r,c[1]=o)},i.commitFunction[4]=function(e,t){c=e.value,r=t[0],o=t[1],l=t[2],c[0]===r&&c[1]===o&&c[2]===l||(a.uniform3fv(e.locationId,t),c[0]=r,c[1]=o,c[2]=l)},i.commitFunction[5]=function(e,t){c=e.value,r=t[0],o=t[1],l=t[2],h=t[3],c[0]===r&&c[1]===o&&c[2]===l&&c[3]===h||(a.uniform4fv(e.locationId,t),c[0]=r,c[1]=o,c[2]=l,c[3]=h)},i.commitFunction[6]=function(e,t){c=e.value,r=t[0],o=t[1],c[0]===r&&c[1]===o||(a.uniform2iv(e.locationId,t),c[0]=r,c[1]=o)},i.commitFunction[9]=i.commitFunction[6],i.commitFunction[7]=function(e,t){c=e.value,r=t[0],o=t[1],l=t[2],c[0]===r&&c[1]===o&&c[2]===l||(a.uniform3iv(e.locationId,t),c[0]=r,c[1]=o,c[2]=l)},i.commitFunction[10]=i.commitFunction[7],i.commitFunction[8]=function(e,t){c=e.value,r=t[0],o=t[1],l=t[2],h=t[3],c[0]===r&&c[1]===o&&c[2]===l&&c[3]===h||(a.uniform4iv(e.locationId,t),c[0]=r,c[1]=o,c[2]=l,c[3]=h)},i.commitFunction[11]=i.commitFunction[8],i.commitFunction[12]=function(e,t){a.uniformMatrix2fv(e.locationId,!1,t)},i.commitFunction[13]=function(e,t){a.uniformMatrix3fv(e.locationId,!1,t)},i.commitFunction[14]=function(e,t){a.uniformMatrix4fv(e.locationId,!1,t)},i.commitFunction[17]=function(e,t){a.uniform1fv(e.locationId,t)},i.commitFunction[21]=function(e,t){a.uniform2fv(e.locationId,t)},i.commitFunction[22]=function(e,t){a.uniform3fv(e.locationId,t)},i.commitFunction[23]=function(e,t){a.uniform4fv(e.locationId,t)},i.scope=new Em("Device"),i.programLib=new wm(g(i)),Ri)i.programLib.register(p,Ri[p]);i.supportsBoneTextures=i.extTextureFloat&&0<i.maxVertexTextures,i.useTexCubeLod=i.extTextureLod&&i.maxTextures<16;var f=i.vertexUniformsCount;f-=16,f-=8,f-=1,f-=16,i.boneLimit=Math.floor(f/3),i.boneLimit=Math.min(i.boneLimit,128),"Mali-450 MP"===i.unmaskedRenderer&&(i.boneLimit=34),i._drawCallsPerFrame=0,i._shaderSwitchesPerFrame=0,i._primsPerFrame=[];for(var m=0;m<=6;m++)i._primsPerFrame[m]=0;return i._renderTargetCreationTime=0,i._vram={tex:0,vb:0,ib:0},i._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},i.constantTexSource=i.scope.resolve("source"),i.extTextureFloat?i.webgl2?i.textureFloatRenderable=!!i.extColorBufferFloat:i.textureFloatRenderable=km(a,a.FLOAT):i.textureFloatRenderable=!1,i.extColorBufferHalfFloat?i.textureHalfFloatRenderable=!!i.extColorBufferHalfFloat:i.extTextureHalfFloat?i.webgl2?i.textureHalfFloatRenderable=!!i.extColorBufferFloat:i.textureHalfFloatRenderable=km(a,i.extTextureHalfFloat.HALF_FLOAT_OES):i.textureHalfFloatRenderable=!1,i.supportsMorphTargetTexturesCore="highp"===i.maxPrecision&&2<=i.maxVertexTextures,i._textureFloatHighPrecision=void 0,i._textureHalfFloatUpdatable=void 0,i.grabPassAvailable=!0,i.grabPassAlpha=t.alpha,i.createGrabPass(),ut.init(g(i)),i.areaLightLutFormat=7,i.extTextureHalfFloat&&i.textureHalfFloatUpdatable&&i.extTextureHalfFloatLinear?i.areaLightLutFormat=we:i.extTextureFloat&&i.extTextureFloatLinear&&(i.areaLightLutFormat=Ce),i}u(e,v);var t=e.prototype;return t.toJSON=function(e){},t.getPrecision=function(){var e=this.gl,t="highp";if(e.getShaderPrecisionFormat){var i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),n=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),s=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT),r=0<i.precision&&0<a.precision,o=0<n.precision&&0<s.precision;r||(t=o?"mediump":"lowp")}return t},t.initializeExtensions=function(){var e,t=this.gl,i={};t.getSupportedExtensions().forEach(function(e){i[e]=!0});var n=function(){for(var e=0;e<arguments.length;e++)if(i.hasOwnProperty(arguments[e]))return t.getExtension(arguments[e]);return null};this.webgl2?(this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureHalfFloatLinear=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=n("EXT_color_buffer_float"),this.extDisjointTimerQuery=n("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")):(this.extBlendMinmax=n("EXT_blend_minmax"),this.extDrawBuffers=n("EXT_draw_buffers"),this.extInstancing=n("ANGLE_instanced_arrays"),this.extInstancing&&(e=this.extInstancing,t.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),t.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),t.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)),this.extStandardDerivatives=n("OES_standard_derivatives"),this.extTextureFloat=n("OES_texture_float"),this.extTextureHalfFloat=n("OES_texture_half_float"),this.extTextureHalfFloatLinear=n("OES_texture_half_float_linear"),this.extTextureLod=n("EXT_shader_texture_lod"),this.extUintElement=n("OES_element_index_uint"),this.extVertexArrayObject=n("OES_vertex_array_object"),this.extVertexArrayObject&&(e=this.extVertexArrayObject,t.createVertexArray=e.createVertexArrayOES.bind(e),t.deleteVertexArray=e.deleteVertexArrayOES.bind(e),t.isVertexArray=e.isVertexArrayOES.bind(e),t.bindVertexArray=e.bindVertexArrayOES.bind(e)),this.extColorBufferFloat=null,this.extDisjointTimerQuery=null),this.extDebugRendererInfo=n("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=n("OES_texture_float_linear"),this.extFloatBlend=n("EXT_float_blend"),this.extTextureFilterAnisotropic=n("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=n("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=n("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=n("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=n("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=n("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=n("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=n("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=n("EXT_color_buffer_half_float"),this.supportsInstancing=!!this.extInstancing},t.initializeCapabilities=function(){var e,t=this.gl;this.maxPrecision=this.precision=this.getPrecision();var i=t.getContextAttributes();this.supportsMsaa=i.antialias,this.supportsStencil=i.stencil,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE)):(e=this.extDrawBuffers,this.maxDrawBuffers=e?t.getParameter(e.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"",e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=t.getParameter(t.SAMPLES),this.maxSamples=this.webgl2?t.getParameter(t.MAX_SAMPLES):1},t.initializeRenderState=function(){var e=this.gl;this.blending=!1,e.disable(e.BLEND),this.blendSrc=1,this.blendDst=0,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.separateAlphaBlend=!1,this.blendEquation=0,this.blendAlphaEquation=0,this.separateAlphaEquation=!1,e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),this.writeRed=!0,this.writeGreen=!0,this.writeBlue=!0,this.writeAlpha=!0,e.colorMask(!0,!0,!0,!0),this.cullMode=1,e.enable(e.CULL_FACE),e.cullFace(e.BACK),this.depthTest=!0,e.enable(e.DEPTH_TEST),this.depthFunc=3,e.depthFunc(e.LEQUAL),this.depthWrite=!0,e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearRed=0,this.clearBlue=0,this.clearGreen=0,this.clearAlpha=0,e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.webgl2?e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST):this.extStandardDerivatives&&e.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_ALIGNMENT,1)},t.initializeContextCaches=function(){this.vertexShaderCache={},this.fragmentShaderCache={},this._vaoMap=new Map,this.boundVao=null,this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.renderTarget=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[];for(var e=0;e<this.maxCombinedTextures;e++)this.textureUnits.push([null,null,null])},t.loseContext=function(){for(var e,t=_(this.shaders);!(e=t()).done;)e.value.loseContext();for(this.destroyGrabPass();0<this.textures.length;){var i=this.textures[0];this.destroyTexture(i),i.dirtyAll()}for(var n,a=_(this.buffers);!(n=a()).done;)n.value.loseContext();for(var s,r=_(this.targets);!(s=r()).done;)s.value.loseContext()},t.restoreContext=function(){this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(var e,t=_(this.shaders);!(e=t()).done;){var i=e.value;this.compileAndLinkShader(i)}for(var n,a=_(this.buffers);!(n=a()).done;)n.value.unlock();this.createGrabPass()},t.createGrabPass=function(){if(!this.grabPassTexture){var e=new Kt(this,{format:!1===this.grabPassAlpha?6:7,minFilter:1,magFilter:1,addressU:1,addressV:1,mipmaps:!1});e.name="texture_grabPass";var t=this.scope.resolve(e.name);t.setValue(e);var i=new Fm({colorBuffer:e,depth:!1});this.grabPassRenderTarget=i,this.grabPassTextureId=t,this.grabPassTexture=e}},t.updateGrabPass=function(){var e=this.gl;if(!this.grabPassAvailable)return!1;var t=this.renderTarget,i=t&&t._glResolveFrameBuffer,n=this.grabPassTexture,a=this.width,s=this.height;if(this.webgl2&&!this._tempMacChromeBlitFramebufferWorkaround&&a===n._width&&s===n._height){i&&t.resolve(!0);var r=t?t._glFrameBuffer:null,o=t?t._glResolveFrameBuffer||t._glFrameBuffer:null;this.initRenderTarget(this.grabPassRenderTarget);var l=this.grabPassRenderTarget._glFrameBuffer;e.bindFramebuffer(e.READ_FRAMEBUFFER,o),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,l),e.blitFramebuffer(0,0,a,s,0,0,a,s,e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,r)}else{i&&(t.resolve(!0),e.bindFramebuffer(e.FRAMEBUFFER,t._glResolveFrameBuffer));var h=n._glFormat;e.copyTexImage2D(e.TEXTURE_2D,0,h,0,0,a,s,0),n._width=a,n._height=s,i&&e.bindFramebuffer(e.FRAMEBUFFER,t._glFrameBuffer)}return!0},t.destroyGrabPass=function(){this.grabPassRenderTarget.destroy(),this.grabPassRenderTarget=null,this.grabPassTextureId=null,this.grabPassTexture.destroy(),this.grabPassTexture=null},t.updateClientRect=function(){this.clientRect=this.canvas.getBoundingClientRect()},t.setViewport=function(e,t,i,n){this.vx===e&&this.vy===t&&this.vw===i&&this.vh===n||(this.gl.viewport(e,t,i,n),this.vx=e,this.vy=t,this.vw=i,this.vh=n)},t.setScissor=function(e,t,i,n){this.sx===e&&this.sy===t&&this.sw===i&&this.sh===n||(this.gl.scissor(e,t,i,n),this.sx=e,this.sy=t,this.sw=i,this.sh=n)},t.getProgramLibrary=function(){return this.programLib},t.setProgramLibrary=function(e){this.programLib=e},t.setFramebuffer=function(e){this.activeFramebuffer!==e&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.activeFramebuffer=e)},t._checkFbo=function(){var e=this.gl;switch(e.checkFramebufferStatus(e.FRAMEBUFFER)){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:case e.FRAMEBUFFER_UNSUPPORTED:break;case e.FRAMEBUFFER_COMPLETE:}},t.copyRenderTarget=function(e,t,i,n){var a=this.gl;if(!this.webgl2&&n)return!1;if(i)if(t){if(!e._colorBuffer||!t._colorBuffer)return!1;if(e._colorBuffer._format!==t._colorBuffer._format)return!1}else if(!e._colorBuffer)return!1;if(n){if(!e._depthBuffer||!t._depthBuffer)return!1;if(e._depthBuffer._format!==t._depthBuffer._format)return!1}if(this.webgl2&&t){var s=this.renderTarget;this.renderTarget=t,this.updateBegin(),a.bindFramebuffer(a.READ_FRAMEBUFFER,e?e._glFrameBuffer:null),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,t._glFrameBuffer);var r=e?e.width:t.width,o=e?e.height:t.height;a.blitFramebuffer(0,0,r,o,0,0,r,o,(i?a.COLOR_BUFFER_BIT:0)|(n?a.DEPTH_BUFFER_BIT:0),a.NEAREST),this.renderTarget=s,a.bindFramebuffer(a.FRAMEBUFFER,s?s._glFrameBuffer:null)}else{var l=this.getCopyShader();this.constantTexSource.setValue(e._colorBuffer),At(this,t,l)}return!0},t.initRenderTarget=function(i){var n=this;if(!i._glFrameBuffer){var a=(i._device=this).gl;i._glFrameBuffer=a.createFramebuffer(),this.setFramebuffer(i._glFrameBuffer);var e=i._colorBuffer,t=i._colorBuffers;t?t.forEach(function(e,t){e._glTexture||(e._width=Math.min(e.width,n.maxRenderBufferSize),e._height=Math.min(e.height,n.maxRenderBufferSize),n.setTexture(e,t)),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+t,e._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+i._face:a.TEXTURE_2D,e._glTexture,0)}):e&&(e._glTexture||(e._width=Math.min(e.width,this.maxRenderBufferSize),e._height=Math.min(e.height,this.maxRenderBufferSize),this.setTexture(e,0)),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,e._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+i._face:a.TEXTURE_2D,e._glTexture,0));var s=i._depthBuffer;s&&this.webgl2?(s._glTexture||(s._width=Math.min(s.width,this.maxRenderBufferSize),s._height=Math.min(s.height,this.maxRenderBufferSize),this.setTexture(s,0)),i._stencil?a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,s._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+i._face:a.TEXTURE_2D,i._depthBuffer._glTexture,0):a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,s._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+i._face:a.TEXTURE_2D,i._depthBuffer._glTexture,0)):i._depth&&(1<i._samples&&this.webgl2||(i._glDepthBuffer||(i._glDepthBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,i._glDepthBuffer),i._stencil?(a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_STENCIL,i.width,i.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,a.RENDERBUFFER,i._glDepthBuffer)):(a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,i.width,i.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,i._glDepthBuffer)),a.bindRenderbuffer(a.RENDERBUFFER,null))),this.webgl2&&1<i._samples&&(i._glResolveFrameBuffer=i._glFrameBuffer,i._glFrameBuffer=a.createFramebuffer(),this.setFramebuffer(i._glFrameBuffer),e&&(i._glMsaaColorBuffer||(i._glMsaaColorBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,i._glMsaaColorBuffer),a.renderbufferStorageMultisample(a.RENDERBUFFER,i._samples,e._glInternalFormat,i.width,i.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.RENDERBUFFER,i._glMsaaColorBuffer)),i._depth&&(i._glMsaaDepthBuffer||(i._glMsaaDepthBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,i._glMsaaDepthBuffer),i._stencil?(a.renderbufferStorageMultisample(a.RENDERBUFFER,i._samples,a.DEPTH24_STENCIL8,i.width,i.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,a.RENDERBUFFER,i._glMsaaDepthBuffer)):(a.renderbufferStorageMultisample(a.RENDERBUFFER,i._samples,a.DEPTH_COMPONENT32F,i.width,i.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,i._glMsaaDepthBuffer)))),this.targets.push(i)}},t.getCopyShader=function(){return this._copyShader||(this._copyShader=Ht(this,Dt.fullscreenQuadVS,Dt.outputTex2DPS,"outputTex2D")),this._copyShader},t.updateBegin=function(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(var e=0;e<this.textureUnits.length;++e)for(var t=0;t<3;++t)this.textureUnits[e][t]=null;var i=this.renderTarget;i?i._glFrameBuffer?this.setFramebuffer(i._glFrameBuffer):this.initRenderTarget(i):this.setFramebuffer(this.defaultFramebuffer)},t.updateEnd=function(){var e=this.gl;this.boundVao=null,this.gl.bindVertexArray(null);var t=this.renderTarget;if(t){var i=t._colorBuffer;i&&i._glTexture&&i.mipmaps&&(i.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(i),e.generateMipmap(i._glTarget)),this.webgl2&&1<t._samples&&t.autoResolve&&t.resolve()}},t.initializeTexture=function(e){var t,i=this.gl;switch(e._glTexture=i.createTexture(),e._glTarget=e._cubemap?i.TEXTURE_CUBE_MAP:e._volume?i.TEXTURE_3D:i.TEXTURE_2D,e._format){case 0:e._glFormat=i.ALPHA,e._glInternalFormat=i.ALPHA,e._glPixelType=i.UNSIGNED_BYTE;break;case 1:e._glFormat=i.LUMINANCE,e._glInternalFormat=i.LUMINANCE,e._glPixelType=i.UNSIGNED_BYTE;break;case 2:e._glFormat=i.LUMINANCE_ALPHA,e._glInternalFormat=i.LUMINANCE_ALPHA,e._glPixelType=i.UNSIGNED_BYTE;break;case 3:e._glFormat=i.RGB,e._glInternalFormat=i.RGB,e._glPixelType=i.UNSIGNED_SHORT_5_6_5;break;case 4:e._glFormat=i.RGBA,e._glInternalFormat=i.RGBA,e._glPixelType=i.UNSIGNED_SHORT_5_5_5_1;break;case 5:e._glFormat=i.RGBA,e._glInternalFormat=i.RGBA,e._glPixelType=i.UNSIGNED_SHORT_4_4_4_4;break;case 6:e._glFormat=i.RGB,e._glInternalFormat=this.webgl2?i.RGB8:i.RGB,e._glPixelType=i.UNSIGNED_BYTE;break;case 7:e._glFormat=i.RGBA,e._glInternalFormat=this.webgl2?i.RGBA8:i.RGBA,e._glPixelType=i.UNSIGNED_BYTE;break;case 8:t=this.extCompressedTextureS3TC,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:t=this.extCompressedTextureS3TC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:t=this.extCompressedTextureS3TC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:t=this.extCompressedTextureETC1,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:t=this.extCompressedTexturePVRTC,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:t=this.extCompressedTexturePVRTC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:t=this.extCompressedTexturePVRTC,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:t=this.extCompressedTexturePVRTC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:t=this.extCompressedTextureETC,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB8_ETC2;break;case 23:t=this.extCompressedTextureETC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:t=this.extCompressedTextureASTC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:t=this.extCompressedTextureATC,e._glFormat=i.RGB,e._glInternalFormat=t.COMPRESSED_RGB_ATC_WEBGL;break;case 30:t=this.extCompressedTextureATC,e._glFormat=i.RGBA,e._glInternalFormat=t.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:t=this.extTextureHalfFloat,e._glFormat=i.RGB,this.webgl2?(e._glInternalFormat=i.RGB16F,e._glPixelType=i.HALF_FLOAT):(e._glInternalFormat=i.RGB,e._glPixelType=t.HALF_FLOAT_OES);break;case we:t=this.extTextureHalfFloat,e._glFormat=i.RGBA,this.webgl2?(e._glInternalFormat=i.RGBA16F,e._glPixelType=i.HALF_FLOAT):(e._glInternalFormat=i.RGBA,e._glPixelType=t.HALF_FLOAT_OES);break;case 13:e._glFormat=i.RGB,this.webgl2?e._glInternalFormat=i.RGB32F:e._glInternalFormat=i.RGB,e._glPixelType=i.FLOAT;break;case Ce:e._glFormat=i.RGBA,this.webgl2?e._glInternalFormat=i.RGBA32F:e._glInternalFormat=i.RGBA,e._glPixelType=i.FLOAT;break;case 15:e._glFormat=i.RED,e._glInternalFormat=i.R32F,e._glPixelType=i.FLOAT;break;case 16:this.webgl2?(e._glFormat=i.DEPTH_COMPONENT,e._glInternalFormat=i.DEPTH_COMPONENT32F,e._glPixelType=i.FLOAT):(e._glFormat=i.DEPTH_COMPONENT,e._glInternalFormat=i.DEPTH_COMPONENT,e._glPixelType=i.UNSIGNED_SHORT);break;case Pe:e._glFormat=i.DEPTH_STENCIL,e._glInternalFormat=i.DEPTH24_STENCIL8,e._glPixelType=i.UNSIGNED_INT_24_8;break;case 18:e._glFormat=i.RGB,e._glInternalFormat=i.R11F_G11F_B10F,e._glPixelType=i.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:e._glFormat=i.RGB,e._glInternalFormat=i.SRGB8,e._glPixelType=i.UNSIGNED_BYTE;break;case 20:e._glFormat=i.RGBA,e._glInternalFormat=i.SRGB8_ALPHA8,e._glPixelType=i.UNSIGNED_BYTE}this.textures.push(e)},t.destroyTexture=function(e){if(e._glTexture){var t=this.textures.indexOf(e);-1!==t&&this.textures.splice(t,1),this.scope.removeValue(e);for(var i=0;i<this.textureUnits.length;i++)for(var n=this.textureUnits[i],a=0;a<n.length;a++)n[a]===e._glTexture&&(n[a]=null);this.gl.deleteTexture(e._glTexture),delete e._glTexture,delete e._glTarget,delete e._glFormat,delete e._glInternalFormat,delete e._glPixelType,this._vram.tex-=e._gpuSize}},t.setUnpackFlipY=function(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;var t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}},t.setUnpackPremultiplyAlpha=function(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;var t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}},t._isBrowserInterface=function(e){return"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap},t.uploadTexture=function(e){var t=this.gl;if(e._needsUpload||!(e._needsMipmapsUpload&&e._mipmapsUploaded||!e.pot)){for(var i,n,a=0,s=Math.log2(Math.max(e._width,e._height))+1;e._levels[a]||0===a;)if(e._needsUpload||0!==a){if(a&&(!e._needsMipmapsUpload||!e._mipmaps))break;if(i=e._levels[a],1===a&&!e._compressed&&e._levels.length<s&&(t.generateMipmap(e._glTarget),e._mipmapsUploaded=!0),e._cubemap){var r=void 0;if(this._isBrowserInterface(i[0])){for(r=0;r<6;r++)if(e._levelsUpdated[0][r]){var o=i[r];o instanceof HTMLImageElement&&(o.width>this.maxCubeMapSize||o.height>this.maxCubeMapSize)&&(o=Im(o,this.maxCubeMapSize),0===a&&(e._width=o.width,e._height=o.height)),this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,e._glInternalFormat,e._glFormat,e._glPixelType,o)}}else for(n=1/Math.pow(2,a),r=0;r<6;r++)if(e._levelsUpdated[0][r]){var l=i[r];e._compressed?t.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,e._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,l):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,e._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,e._glFormat,e._glPixelType,l))}}else e._volume?(n=1/Math.pow(2,a),e._compressed?t.compressedTexImage3D(t.TEXTURE_3D,a,e._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),Math.max(e._depth*n,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage3D(t.TEXTURE_3D,a,e._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),Math.max(e._depth*n,1),0,e._glFormat,e._glPixelType,i))):(this._isBrowserInterface(i)?(i instanceof HTMLImageElement&&(i.width>this.maxTextureSize||i.height>this.maxTextureSize)&&(i=Im(i,this.maxTextureSize),0===a&&(e._width=i.width,e._height=i.height)),this.setUnpackFlipY(e._flipY),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_2D,a,e._glInternalFormat,e._glFormat,e._glPixelType,i)):(n=1/Math.pow(2,a),e._compressed?t.compressedTexImage2D(t.TEXTURE_2D,a,e._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,i):(e._forceFilpY?this.setUnpackFlipY(e._flipY):this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_2D,a,e._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,e._glFormat,e._glPixelType,i))),e._mipmapsUploaded=0!==a);a++}else a++;if(e._needsUpload)if(e._cubemap)for(var h=0;h<6;h++)e._levelsUpdated[0][h]=!1;else e._levelsUpdated[0]=!1;!e._compressed&&e._mipmaps&&e._needsMipmapsUpload&&(e.pot||this.webgl2)&&1===e._levels.length&&(t.generateMipmap(e._glTarget),e._mipmapsUploaded=!0),e._gpuSize&&(this._vram.tex-=e._gpuSize),e._gpuSize=e.gpuSize,this._vram.tex+=e._gpuSize}},t.activeTexture=function(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)},t.bindTexture=function(e){var t=e._glTarget,i=e._glTexture,n=this.textureUnit,a=this.targetToSlot[t];this.textureUnits[n][a]!==i&&(this.gl.bindTexture(t,i),this.textureUnits[n][a]=i)},t.bindTextureOnUnit=function(e,t){var i=e._glTarget,n=e._glTexture,a=this.targetToSlot[i];this.textureUnits[t][a]!==n&&(this.activeTexture(t),this.gl.bindTexture(i,n),this.textureUnits[t][a]=n)},t.setTextureParameters=function(e){var t=this.gl,i=e._parameterFlags,n=e._glTarget;if(1&i){var a=e._minFilter;(!e.pot&&!this.webgl2||!e._mipmaps||e._compressed&&1===e._levels.length)&&(2===a||3===a?a=0:4!==a&&5!==a||(a=1)),t.texParameteri(n,t.TEXTURE_MIN_FILTER,this.glFilter[a])}if(2&i&&t.texParameteri(n,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&i&&(this.webgl2?t.texParameteri(n,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]):t.texParameteri(n,t.TEXTURE_WRAP_S,this.glAddress[e.pot?e._addressU:1])),8&i&&(this.webgl2?t.texParameteri(n,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]):t.texParameteri(n,t.TEXTURE_WRAP_T,this.glAddress[e.pot?e._addressV:1])),16&i&&this.webgl2&&t.texParameteri(n,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&i&&this.webgl2&&t.texParameteri(n,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),64&i&&this.webgl2&&t.texParameteri(n,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&i){var s=this.extTextureFilterAnisotropic;s&&t.texParameterf(n,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(e._anisotropy),this.maxAnisotropy)))}},t.setTexture=function(e,t){e._glTexture||this.initializeTexture(e),0<e._parameterFlags||e._needsUpload||e._needsMipmapsUpload||e===this.grabPassTexture?(this.activeTexture(t),this.bindTexture(e),e._parameterFlags&&(this.setTextureParameters(e),e._parameterFlags=0),e===this.grabPassTexture&&this.updateGrabPass()||!e._needsUpload&&!e._needsMipmapsUpload||(this.uploadTexture(e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,t)},t.createVertexArray=function(e){var t,i,n=1<e.length;if(n){t="";for(var a=0;a<e.length;a++){var s=e[a];t+=s.id+s.format.renderingingHash}i=this._vaoMap.get(t)}if(!i){var r=this.gl;i=r.createVertexArray(),r.bindVertexArray(i),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null);for(var o=0;o<e.length;o++){var l=e[o];r.bindBuffer(r.ARRAY_BUFFER,l.bufferId);for(var h=l.format.elements,c=0;c<h.length;c++){var u=h[c],d=ot[u.name];r.vertexAttribPointer(d,u.numComponents,this.glType[u.dataType],u.normalize,u.stride,u.offset),r.enableVertexAttribArray(d),l.instancing&&r.vertexAttribDivisor(d,1)}}r.bindVertexArray(null),r.bindBuffer(r.ARRAY_BUFFER,null),n&&this._vaoMap.set(t,i)}return i},t.setBuffers=function(){var e,t=this.gl;if(1===this.vertexBuffers.length){var i=this.vertexBuffers[0];i._vao||(i._vao=this.createVertexArray(this.vertexBuffers)),e=i._vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.vertexBuffers.length=0;var n=this.indexBuffer?this.indexBuffer.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n)},t.draw=function(e,t,i){var n,a,s,r,o,l,h,c,u=this.gl,d=this.shader;if(d){var p=d.samplers,f=d.uniforms;i||this.setBuffers();for(var m=0,v=0,g=p.length;v<g;v++)if(a=(n=p[v]).scopeId.value)if(a instanceof Kt)s=a,this.setTexture(s,m),n.slot!==m&&(u.uniform1i(n.locationId,m),n.slot=m),m++;else{n.array.length=0,r=a.length;for(var _=0;_<r;_++)s=a[_],this.setTexture(s,m),n.array[_]=m,m++;u.uniform1iv(n.locationId,n.array)}for(var y=0,b=f.length;y<b;y++)l=(o=f[y]).scopeId,h=o.version,c=l.versionObject.version,h.globalId===c.globalId&&h.revision===c.revision||(h.globalId=c.globalId,h.revision=c.revision,null!==l.value&&this.commitFunction[o.dataType](o,l.value));this.webgl2&&this.transformFeedbackBuffer&&(u.bindBufferBase(u.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),u.beginTransformFeedback(u.POINTS));var x=this.glPrimitive[e.type],M=e.count;if(e.indexed){var S=this.indexBuffer,w=S.glFormat,C=e.base*S.bytesPerIndex;0<t?u.drawElementsInstanced(x,M,w,C,t):u.drawElements(x,M,w,C)}else{var P=e.base;0<t?u.drawArraysInstanced(x,P,M,t):u.drawArrays(x,P,M)}this.webgl2&&this.transformFeedbackBuffer&&(u.endTransformFeedback(),u.bindBufferBase(u.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}},t.clear=function(e){var t=this.defaultClearOptions,i=null==(e=e||t).flags?t.flags:e.flags;if(0!==i){var n=this.gl;if(1&i){var a=null==e.color?t.color:e.color;this.setClearColor(a[0],a[1],a[2],a[3])}if(2&i){var s=null==e.depth?t.depth:e.depth;this.setClearDepth(s),this.depthWrite||n.depthMask(!0)}if(4&i){var r=null==e.stencil?t.stencil:e.stencil;this.setClearStencil(r)}n.clear(this.glClearFlag[i]),2&i&&(this.depthWrite||n.depthMask(!1))}},t.readPixels=function(e,t,i,n,a){var s=this.gl;s.readPixels(e,t,i,n,s.RGBA,s.UNSIGNED_BYTE,a)},t.setClearDepth=function(e){e!==this.clearDepth&&(this.gl.clearDepth(e),this.clearDepth=e)},t.setClearColor=function(e,t,i,n){e===this.clearRed&&t===this.clearGreen&&i===this.clearBlue&&n===this.clearAlpha||(this.gl.clearColor(e,t,i,n),this.clearRed=e,this.clearGreen=t,this.clearBlue=i,this.clearAlpha=n)},t.setClearStencil=function(e){e!==this.clearStencil&&(this.gl.clearStencil(e),this.clearStencil=e)},t.setRenderTarget=function(e){this.renderTarget=e},t.getRenderTarget=function(){return this.renderTarget},t.getDepthTest=function(){return this.depthTest},t.setDepthTest=function(e){if(this.depthTest!==e){var t=this.gl;e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this.depthTest=e}},t.setDepthFunc=function(e){this.depthFunc!==e&&(this.gl.depthFunc(this.glComparison[e]),this.depthFunc=e)},t.getDepthWrite=function(){return this.depthWrite},t.setDepthWrite=function(e){this.depthWrite!==e&&(this.gl.depthMask(e),this.depthWrite=e)},t.setColorWrite=function(e,t,i,n){this.writeRed===e&&this.writeGreen===t&&this.writeBlue===i&&this.writeAlpha===n||(this.gl.colorMask(e,t,i,n),this.writeRed=e,this.writeGreen=t,this.writeBlue=i,this.writeAlpha=n)},t.setAlphaToCoverage=function(e){this.webgl2&&this.alphaToCoverage!==e&&((this.alphaToCoverage=e)?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},t.setTransformFeedbackBuffer=function(e){if(this.transformFeedbackBuffer!==e&&(this.transformFeedbackBuffer=e,this.webgl2)){var t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}},t.setRaster=function(e){this.raster!==e&&(this.raster=e,this.webgl2&&(e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},t.setDepthBias=function(e){this.depthBiasEnabled!==e&&((this.depthBiasEnabled=e)?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},t.setDepthBiasValues=function(e,t){this.gl.polygonOffset(t,e)},t.getBlending=function(){return this.blending},t.setBlending=function(e){if(this.blending!==e){var t=this.gl;e?t.enable(t.BLEND):t.disable(t.BLEND),this.blending=e}},t.setStencilTest=function(e){if(this.stencil!==e){var t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}},t.setStencilFunc=function(e,t,i){this.stencilFuncFront===e&&this.stencilRefFront===t&&this.stencilMaskFront===i&&this.stencilFuncBack===e&&this.stencilRefBack===t&&this.stencilMaskBack===i||(this.gl.stencilFunc(this.glComparison[e],t,i),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=i)},t.setStencilFuncFront=function(e,t,i){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==i){var n=this.gl;n.stencilFuncSeparate(n.FRONT,this.glComparison[e],t,i),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=i}},t.setStencilFuncBack=function(e,t,i){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==i){var n=this.gl;n.stencilFuncSeparate(n.BACK,this.glComparison[e],t,i),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=i}},t.setStencilOperation=function(e,t,i,n){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===i&&this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===i||(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=i),this.stencilWriteMaskFront===n&&this.stencilWriteMaskBack===n||(this.gl.stencilMask(n),this.stencilWriteMaskFront=n,this.stencilWriteMaskBack=n)},t.setStencilOperationFront=function(e,t,i,n){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===i||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=i),this.stencilWriteMaskFront!==n&&(this.gl.stencilMaskSeparate(this.gl.FRONT,n),this.stencilWriteMaskFront=n)},t.setStencilOperationBack=function(e,t,i,n){this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===i||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=i),this.stencilWriteMaskBack!==n&&(this.gl.stencilMaskSeparate(this.gl.BACK,n),this.stencilWriteMaskBack=n)},t.setBlendFunction=function(e,t){(this.blendSrc!==e||this.blendDst!==t||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[e],this.glBlendFunction[t]),this.blendSrc=e,this.blendDst=t,this.separateAlphaBlend=!1)},t.setBlendFunctionSeparate=function(e,t,i,n){this.blendSrc===e&&this.blendDst===t&&this.blendSrcAlpha===i&&this.blendDstAlpha===n&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[e],this.glBlendFunction[t],this.glBlendFunction[i],this.glBlendFunction[n]),this.blendSrc=e,this.blendDst=t,this.blendSrcAlpha=i,this.blendDstAlpha=n,this.separateAlphaBlend=!0)},t.setBlendEquation=function(e){(this.blendEquation!==e||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[e]),this.blendEquation=e,this.separateAlphaEquation=!1)},t.setBlendEquationSeparate=function(e,t){this.blendEquation===e&&this.blendAlphaEquation===t&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[e],this.glBlendEquation[t]),this.blendEquation=e,this.blendAlphaEquation=t,this.separateAlphaEquation=!0)},t.setCullMode=function(e){if(this.cullMode!==e){if(0===e)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);var t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}},t.getCullMode=function(){return this.cullMode},t.setIndexBuffer=function(e){this.indexBuffer=e},t.setVertexBuffer=function(e){e&&this.vertexBuffers.push(e)},t.compileShaderSource=function(e,t){var i=this.gl,n=t?this.vertexShaderCache[e]:this.fragmentShaderCache[e];return n||(n=i.createShader(t?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(n,e),i.compileShader(n),t?this.vertexShaderCache[e]=n:this.fragmentShaderCache[e]=n),n},t.compileAndLinkShader=function(e){var t=this.gl,i=e.definition,n=i.attributes,a=this.compileShaderSource(i.vshader,!0),s=this.compileShaderSource(i.fshader,!1),r=t.createProgram();if(t.attachShader(r,a),t.attachShader(r,s),this.webgl2&&i.useTransformFeedback){var o=[];for(var l in n)n.hasOwnProperty(l)&&o.push("out_"+l);t.transformFeedbackVaryings(r,o,t.INTERLEAVED_ATTRIBS)}var h={};for(var c in n)if(n.hasOwnProperty(c)){var u=n[c],d=ot[u];h[d]=c,t.bindAttribLocation(r,d,c)}t.linkProgram(r),e._glVertexShader=a,e._glFragmentShader=s,e._glProgram=r},t.createShader=function(e){this.compileAndLinkShader(e),this.shaders.push(e)},t.destroyShader=function(e){var t=this.shaders.indexOf(e);-1!==t&&this.shaders.splice(t,1),e._glProgram&&(this.gl.deleteProgram(e._glProgram),e._glProgram=null,this.removeShaderFromCache(e))},t._addLineNumbers=function(e){if(!e)return"";for(var t=e.split("\n"),i=0,n=t.length;i<n;i++)t[i]=i+1+":\t"+t[i];return t.join("\n")},t.postLink=function(e){var t,i,n,a,s=this.gl,r=e._glVertexShader,o=e._glFragmentShader,l=e._glProgram,h=e.definition;if(!s.getShaderParameter(r,s.COMPILE_STATUS))return!1;if(!s.getShaderParameter(o,s.COMPILE_STATUS))return!1;if(!s.getProgramParameter(l,s.LINK_STATUS))return!1;t=0;for(var c=s.getProgramParameter(l,s.ACTIVE_ATTRIBUTES);t<c;)i=s.getActiveAttrib(l,t++),n=s.getAttribLocation(l,i.name),h.attributes[i.name],a=new Rm(this,h.attributes[i.name],this.pcUniformType[i.type],n),e.attributes.push(a);t=0;for(var u=s.getProgramParameter(l,s.ACTIVE_UNIFORMS);t<u;)i=s.getActiveUniform(l,t++),n=s.getUniformLocation(l,i.name),a=new Rm(this,i.name,this.pcUniformType[i.type],n),i.type===s.SAMPLER_2D||i.type===s.SAMPLER_CUBE||this.webgl2&&(i.type===s.SAMPLER_2D_SHADOW||i.type===s.SAMPLER_CUBE_SHADOW||i.type===s.SAMPLER_3D)?e.samplers.push(a):e.uniforms.push(a);return e.ready=!0},t.setShader=function(e){if(e!==this.shader){if(!e.ready&&!this.postLink(e))return!1;this.shader=e,this.gl.useProgram(e._glProgram),this.attributesInvalidated=!0}return!0},t.getHdrFormat=function(){return this.textureHalfFloatRenderable?we:this.textureFloatRenderable?Ce:7},t.getBoneLimit=function(){return this.boneLimit},t.setBoneLimit=function(e){this.boneLimit=e},t.resizeCanvas=function(e,t){this._width=e,this._height=t;var i=Math.min(this._maxPixelRatio,window.devicePixelRatio);e=Math.floor(e*i),t=Math.floor(t*i),this.canvas.width===e&&this.canvas.height===t||(this.canvas.width=e,this.canvas.height=t,this.fire(Dm,e,t))},t.setResolution=function(e,t){this._width=e,this._height=t,this.canvas.width=e,this.canvas.height=t,this.fire(Dm,e,t)},t.clearShaderCache=function(){var e=this.gl;for(var t in this.fragmentShaderCache)e.deleteShader(this.fragmentShaderCache[t]),delete this.fragmentShaderCache[t];for(var i in this.vertexShaderCache)e.deleteShader(this.vertexShaderCache[i]),delete this.vertexShaderCache[i];this.programLib.clearCache()},t.clearVertexArrayObjectCache=function(){var n=this.gl;this._vaoMap.forEach(function(e,t,i){n.deleteVertexArray(e)}),this._vaoMap.clear()},t.removeShaderFromCache=function(e){this.programLib.removeFromCache(e)},t.destroy=function(){var e=this.gl;this.destroyGrabPass(),this.webgl2&&this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.canvas=null,this.gl=null},t.getShaderErrors=function(e,t,i){var n=e.getShaderParameter(t,e.COMPILE_STATUS),a=e.getShaderInfoLog(t).trim();if(n&&""===a)return"";var s=e.getShaderSource(t);return"WebGLShader: gl.getShaderInfoLog() "+i+"\n"+a+this._addLineNumbers(s)},c(e,[{key:"width",get:function(){return this.gl.drawingBufferWidth||this.canvas.width}},{key:"height",get:function(){return this.gl.drawingBufferHeight||this.canvas.height}},{key:"fullscreen",get:function(){return!!document.fullscreenElement},set:function(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen()}},{key:"enableAutoInstancing",get:function(){return this._enableAutoInstancing},set:function(e){this._enableAutoInstancing=e&&this.extInstancing}},{key:"maxPixelRatio",get:function(){return this._maxPixelRatio},set:function(e){this._maxPixelRatio=e,this.resizeCanvas(this._width,this._height)}},{key:"textureFloatHighPrecision",get:function(){return void 0===this._textureFloatHighPrecision&&(this._textureFloatHighPrecision=function(e){if(!e.textureFloatRenderable)return!1;var t=Ht(e,Dt.fullscreenQuadVS,Dt.precisionTestPS,"ptest1"),i=Ht(e,Dt.fullscreenQuadVS,Dt.precisionTest2PS,"ptest2"),n={format:Ce,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0},a=new Kt(e,n);a.name="testFHP";var s=new Fm({colorBuffer:a,depth:!1});At(e,s,t),n.format=7;var r=new Kt(e,n);r.name="testFHP";var o=new Fm({colorBuffer:r,depth:!1});e.constantTexSource.setValue(a),At(e,o,i);var l=e.activeFramebuffer;e.setFramebuffer(o._glFrameBuffer);var h=new Uint8Array(4);e.readPixels(0,0,1,1,h),e.setFramebuffer(l);var c=h[0]/255/16777216+h[1]/255/65536+h[2]/255/256+h[3]/255;return a.destroy(),s.destroy(),r.destroy(),o.destroy(),0===c}(this)),this._textureFloatHighPrecision}},{key:"textureHalfFloatUpdatable",get:function(){return void 0===this._textureHalfFloatUpdatable&&(this.webgl2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=function(e,t){var i=!0,n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);var a=new Uint16Array(16);return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,a),e.getError()!==e.NO_ERROR&&(i=!1),e.bindTexture(e.TEXTURE_2D,null),e.deleteTexture(n),i}(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}]),e}(p),Om={depth:!0,face:0},Fm=function(){function e(e){var t,i,n=arguments[1],a=arguments[2];if(e instanceof Lm?(this._colorBuffer=n,e=a):(this._colorBuffer=e.colorBuffer,this._colorBuffers=e.colorBuffers),this._colorBuffer&&(this._colorBuffer._isRenderTarget=!0),this._colorBuffers&&this._colorBuffers.forEach(function(e){e._isRenderTarget=!0}),this._device=null,this._glFrameBuffer=null,this._glDepthBuffer=null,e=void 0!==e?e:Om,this._depthBuffer=e.depthBuffer,this._face=void 0!==e.face?e.face:0,this._depthBuffer){var s=this._depthBuffer._format;16===s?(this._depth=!0,this._stencil=!1):s===Pe?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else this._depth=void 0===e.depth||e.depth,this._stencil=void 0!==e.stencil&&e.stencil;this._samples=void 0!==e.samples?e.samples:1,this.autoResolve=void 0===e.autoResolve||e.autoResolve,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null,this.name=e.name,this.name||(this.name=null==(t=this._colorBuffer)?void 0:t.name),this.name||(this.name=null==(i=this._depthBuffer)?void 0:i.name),this.name||(this.name="Untitled"),this.flipY=!!e.flipY}var t=e.prototype;return t.destroy=function(){var e=this._device;if(e){var t=e.targets.indexOf(this);-1!==t&&e.targets.splice(t,1),this.destroyFrameBuffers()}},t.destroyFrameBuffers=function(){var e=this._device;if(e){var t=e.gl;this._glFrameBuffer&&(t.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(t.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(t.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(t.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(t.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}},t.destroyTextureBuffers=function(){this._depthBuffer&&(this._depthBuffer.destroy(),this._depthBuffer=null),this._colorBuffer&&(this._colorBuffer.destroy(),this._colorBuffer=null)},t.loseContext=function(){this._glFrameBuffer=void 0,this._glDepthBuffer=void 0,this._glResolveFrameBuffer=void 0,this._glMsaaColorBuffer=void 0,this._glMsaaDepthBuffer=void 0},t.resolve=function(e,t){if(void 0===e&&(e=!0),void 0===t&&(t=!!this._depthBuffer),this._device&&this._device.webgl2){var i=this._device.gl;i.bindFramebuffer(i.READ_FRAMEBUFFER,this._glFrameBuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),i.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(e?i.COLOR_BUFFER_BIT:0)|(t?i.DEPTH_BUFFER_BIT:0),i.NEAREST),i.bindFramebuffer(i.FRAMEBUFFER,this._glFrameBuffer)}},t.copy=function(e,t,i){if(!this._device){if(!e._device)return!1;this._device=e._device}return this._device.copyRenderTarget(e,this,t,i)},c(e,[{key:"colorBuffer",get:function(){return this._colorBuffer}},{key:"colorBuffers",get:function(){return this._colorBuffers}},{key:"depthBuffer",get:function(){return this._depthBuffer}},{key:"face",get:function(){return this._face}},{key:"width",get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}},{key:"height",get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}}]),e}();function zm(e,t,i){var n=t._colorBuffer;if(7===n.format){var a=new Uint8Array(n.width*n.height*4),s=e.gl;e.setFramebuffer(t._glFrameBuffer),s.readPixels(0,0,n.width,n.height,s.RGBA,s.UNSIGNED_BYTE,a),n._levels||(n._levels=[]),n._levels[0]||(n._levels[0]=[]),n._levels[0][i]=a}}function Bm(e){var t=e.device,i=e.sourceCubemap,n=e.method,a=e.samples,s=e.cpuSync;if(!s||i._levels[0]){var r,o,l,h,c,u,d=i.type,p=d===Qe,f=Ht(t,Rt.fullscreenQuadVS,Rt.rgbmPS+Rt.prefilterCubemapPS.replace(/\$METHOD/g,0===n?"cos":"phong").replace(/\$NUMSAMPLES/g,a).replace(/\$textureCube/g,p?"textureCubeRGBM":"textureCube"),"prefilter"+n+a+p),m=Ht(t,Rt.fullscreenQuadVS,Rt.outputCubemapPS,"outputCubemap"),v=t.scope.resolve("source"),g=t.scope.resolve("params"),_=new Float32Array(4),y=i.width,b=i.format,x=[[],e.filteredFixed,e.filteredRgbm,e.filteredFixedRgbm],M=0===n?[.9,.85,.7,.4,.25,.15,.1]:[512,128,32,8,2,1,1],S=[64,32,16,8,4,2,1],w=6===b,C=!1;if(s&&(C=i._levels[0][0]instanceof HTMLImageElement),(w||C)&&s){for((c=new Kt(t,{cubemap:!0,type:d,format:b=7,width:y,height:y,mipmaps:!1})).name="prefiltered-cube",l=0;l<6;l++)r=new Fm({colorBuffer:c,face:l,depth:!1}),_[0]=l,_[1]=0,v.setValue(i),g.setValue(_),At(t,r,m),zm(t,r,l);i=c}if(128<y){var P=Math.round(Math.log2(128)),T=Math.round(Math.log2(y))-P;for(o=0;o<T;o++){y=.5*i.width;var A=0===n?1:Math.pow(2,Math.round(Math.log2(M[0])+2*(T-o)));for((c=new Kt(t,{cubemap:!0,type:d,format:b,width:y,height:y,mipmaps:!1})).name="prefiltered-cube",l=0;l<6;l++)r=new Fm({colorBuffer:c,face:l,depth:!1}),_[0]=l,_[1]=A,_[2]=y,_[3]=p?3:0,v.setValue(i),g.setValue(_),At(t,r,m),o===T-1&&s&&zm(t,r,l);i=c}}e.sourceCubemap=i;var E=null;if(!p&&e.filteredFixedRgbm){for((c=new Kt(t,{cubemap:!0,type:Qe,format:7,width:y,height:y,mipmaps:!1})).name="prefiltered-cube",l=0;l<6;l++)r=new Fm({colorBuffer:c,face:l,depth:!1}),_[0]=l,_[3]=2,v.setValue(i),g.setValue(_),At(t,r,m),zm(t,r,l);E=c}var R,D=0===n?1:2048,I=0===n?0:-1;for(x[I]=[],o=0;o<7;o++)for(h=I;h<x.length;h++)null!=x[h]&&(x[h][o]=new Kt(t,{cubemap:!0,type:h<2?d:Qe,format:h<2?b:7,fixCubemapSeams:1===h||3===h,width:S[o],height:S[o],mipmaps:!1}),x[h][o].name="prefiltered-cube");for(h=I;h<x.length;h++)if(null!=x[h]){if(1<h&&p){x[h]=x[h-2];continue}for(o=0;o<7;o++)for(l=0;l<6;l++)r=new Fm({colorBuffer:x[h][o],face:l,depth:!1}),_[0]=l,_[1]=h<0?D:M[o],_[2]=S[o],_[3]=p?3:h,v.setValue(0===o?i:0===n?x[0][o-1]:x[-1][o-1]),g.setValue(_),At(t,r,f),s&&zm(t,r,l)}if(e.filtered=x[0],s&&e.singleFilteredFixed){for(R=[i].concat(e.filteredFixed),(u=new Kt(t,{cubemap:!0,type:d,fixCubemapSeams:!0,format:b,width:128,height:128,addressU:1,addressV:1})).name="prefiltered-cube",o=0;o<R.length;o++)u._levels[o]=R[o]._levels[0];u.upload(),e.singleFilteredFixed=u}if(s&&e.singleFilteredFixedRgbm&&e.filteredFixedRgbm){for(R=[E].concat(e.filteredFixedRgbm),(u=new Kt(t,{cubemap:!0,type:Qe,fixCubemapSeams:!0,format:7,width:128,height:128,addressU:1,addressV:1})).name="prefiltered-cube",o=0;o<R.length;o++)u._levels[o]=R[o]._levels[0];u.upload(),e.singleFilteredFixedRgbm=u}}}function Vm(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}function Um(e,t,i){var n,a,s,r,o,l,h,c,u,d,p,f,m,v,g=t.width;if(7===t.format&&t._levels[0]){if(t._levels[0][0]&&!t._levels[0][0].length){if(!(t._levels[0][0]instanceof HTMLImageElement))return;var _=e.gl,y=Ht(e,Rt.fullscreenQuadVS,Rt.fullscreenQuadPS,"fsQuadSimple"),b=e.scope.resolve("source");for(n=0;n<6;n++){var x=t._levels[0][n],M=new Kt(e,{cubemap:!1,type:Ze,format:t.format,width:g,height:g,mipmaps:!1});M.name="prefiltered-cube",M._levels[0]=x,M.upload();var S=new Kt(e,{cubemap:!1,type:Ze,format:t.format,width:g,height:g,mipmaps:!1});S.name="prefiltered-cube";var w=new Fm({colorBuffer:S,depth:!1});b.setValue(M),At(e,w,y);var C=new Uint8Array(g*g*4);_.bindFramebuffer(_.FRAMEBUFFER,w._glFrameBuffer),_.readPixels(0,0,M.width,M.height,_.RGBA,_.UNSIGNED_BYTE,C),t._levels[0][n]=C}}var P=[];for(s=0;s<g;s++)for(a=0;a<g;a++){var T=a/(g-1)*2-1,A=s/(g-1)*2-1;P[s*g+a]=new de(T,A,1).normalize()}var E,R,D,I,k,L,O,F,z,B,V,U,N,G,W=new Float32Array(27),H=0;for(n=0;n<6;n++)for(s=0;s<g;s++)for(a=0;a<g;a++)for(E=s*g+a,B=4*(v=c=h=void 0,h=2*((r=a)+.5)/(l=g)-1,c=2*((o=s)+.5)/l-1,d=(h*=1-(u=1/l))-u,p=(c*=1-1/l)-u,f=h+u,m=c+u,v=Vm(d,p)-Vm(d,m)-Vm(f,p)+Vm(f,m),0===r&&0===o||r===l-1&&0===o||0===r&&o===l-1||r===l-1&&o===l-1?v/=3:0!==r&&0!==o&&r!==l-1&&o!==l-1||(v*=.5),k=v)/17,V=8*k/17,U=15*k/17,N=5*k/68,G=15*k/68,L=P[E],0==n?(O=L.z,F=-L.y,z=-L.x):1===n?(O=-L.z,F=-L.y,z=L.x):2===n?(O=L.x,F=L.z,z=L.y):3===n?(O=L.x,F=-L.z,z=-L.y):4===n?(O=L.x,F=-L.y,z=L.z):5===n&&(O=-L.x,F=-L.y,z=-L.z),i||(O=-O),D=t._levels[0][n][4*E+3]/255,R=0;R<3;R++)I=t._levels[0][n][4*E+R]/255,t.type===Qe?(I*=8*D,I*=I):I=Math.pow(I,2.2),W[0+R]+=I*B,W[3+R]+=I*V*O,W[6+R]+=I*V*F,W[9+R]+=I*V*z,W[12+R]+=I*U*O*z,W[15+R]+=I*U*z*F,W[18+R]+=I*U*F*O,W[21+R]+=I*N*(3*z*z-1),W[24+R]+=I*G*(O*O-F*F),H+=k;for(R=0;R<W.length;R++)W[R]*=4*Math.PI/H;return W}}var Nm={type:5,base:0,count:4,indexed:!1};function Gm(e){this.device=e,this.shader=null,this.depthMap=null,this.vertexBuffer=Wm(e),this.needsDepthBuffer=!1}function Wm(e){var t=new ut(e,[{semantic:Te,components:2,type:6}]),i=new ht(e,t,4),n=new Ct(i);return n.element.POSITION.set(-1,-1),n.next(),n.element.POSITION.set(1,-1),n.next(),n.element.POSITION.set(-1,1),n.next(),n.element.POSITION.set(1,1),n.end(),i}function Hm(e,t,i,n,a){var s=e.getRenderTarget();e.setRenderTarget(t),e.updateBegin();var r=t?t.width:e.width,o=t?t.height:e.height,l=0,h=0;a&&(l=a.x*r,h=a.y*o,r*=a.z,o*=a.w);var c=e.vx,u=e.vy,d=e.vw,p=e.vh;e.setViewport(l,h,r,o);var f=e.sx,m=e.sy,v=e.sw,g=e.sh;e.setScissor(l,h,r,o);var _=e.getBlending(),y=e.getDepthTest(),b=e.getDepthWrite(),x=e.getCullMode(),M=e.writeRed,S=e.writeGreen,w=e.writeBlue,C=e.writeAlpha;e.setBlending(!1),e.setDepthTest(!1),e.setDepthWrite(!1),e.setCullMode(0),e.setColorWrite(!0,!0,!0,!0),e.setVertexBuffer(i,0),e.setShader(n),e.draw(Nm),e.setBlending(_),e.setDepthTest(y),e.setDepthWrite(b),e.setCullMode(x),e.setColorWrite(M,S,w,C),e.updateEnd(),e.setRenderTarget(s),e.updateBegin(),e.setViewport(c,u,d,p),e.setScissor(f,m,v,g)}Object.assign(Gm.prototype,{render:function(e,t,i){}}),function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var i=t.prototype;i.clone=function(){var e=new t;return Ui.prototype._cloneInternal.call(this,e),e},i.updateShader=function(e){var t={skin:!!this.meshInstances[0].skinInstance},i=e.getProgramLibrary();this.shader=i.getProgram("depth",t)}}(Ui);var jm=new Set,Xm={depth:1,flags:2},qm=function(){function e(e,t,i){e instanceof Lm&&(e=hi()),this.app=e,this.device=e.graphicsDevice,this.pickColor=new Float32Array(4),this.pickColor[3]=1,this.mapping=[],this.cameraEntity=null,this.layer=null,this.layerComp=null,this.initLayerComposition(),this._renderTarget=null;var n=this.device;this.clearDepthCommand=new xn(0,0,function(){n.clear(Xm)}),this.width=0,this.height=0,this.resize(t,i)}var t=e.prototype;return t.getSelection=function(e,t,i,n){var a=this.device;if("object"==(void 0===e?"undefined":dx(e))){var s=e;e=s.x,t=s.y,i=s.width,n=s.height}else t=this.renderTarget.height-(t+(n||1));e=Math.floor(e),t=Math.floor(t),i=Math.floor(Math.max(i||1,1)),n=Math.floor(Math.max(n||1,1));var r=a.renderTarget;a.setRenderTarget(this.renderTarget),a.updateBegin();var o=new Uint8Array(4*i*n);a.readPixels(e,t,i,n,o),a.updateEnd(),a.setRenderTarget(r);for(var l=this.mapping,h=0;h<i*n;h++){var c=o[4*h+0]<<16|o[4*h+1]<<8|o[4*h+2];16777215!==c&&jm.add(l[c])}var u=[];return jm.forEach(function(e){return u.push(e)}),jm.clear(),u},t.allocateRenderTarget=function(){var e=new Kt(this.device,{format:7,width:this.width,height:this.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});e.name="pick",this.renderTarget=new Fm({colorBuffer:e,depth:!0})},t.releaseRenderTarget=function(){this.cameraEntity.camera.renderTarget=null,this._renderTarget&&(this._renderTarget._colorBuffer.destroy(),this._renderTarget.destroy(),this._renderTarget=null)},t.initLayerComposition=function(){var i=this.device,n=this,a=i.scope.resolve("uColor");this.cameraEntity=new Cr,this.cameraEntity.addComponent("camera"),this.layer=new _a({name:"Picker",shaderPass:18,opaqueSortMode:0,onDrawCall:function(e,t){n.pickColor[0]=(t>>16&255)/255,n.pickColor[1]=(t>>8&255)/255,n.pickColor[2]=(255&t)/255,a.setValue(n.pickColor),i.setBlending(!1),n.mapping[t]=e}}),this.layer.addCamera(this.cameraEntity.camera),this.layerComp=new pi("picker"),this.layerComp.pushOpaque(this.layer)},t.prepare=function(e,t,i){e instanceof Oi&&(e=e.node.camera),i instanceof _a&&(i=[i]),this.layer.clearMeshInstances();for(var n=this.layer.opaqueMeshInstances,a=t.layers.layerList,s=t.layers.subLayerEnabled,r=t.layers.subLayerList,o=0;o<a.length;o++){var l=a[o];if(!(i&&i.indexOf(l)<0)&&l.enabled&&s[o]&&0<=l.cameras.indexOf(e)){l._clearDepthBuffer&&n.push(this.clearDepthCommand);for(var h=r[o]?l.instances.transparentMeshInstances:l.instances.opaqueMeshInstances,c=0;c<h.length;c++){var u=h[c];u.pick&&n.push(u)}}}this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.updateCamera(e),this.mapping.length=0,this.app.renderer.renderComposition(this.layerComp)},t.updateCamera=function(e){this.cameraEntity.copy(e.entity),this.cameraEntity.name="PickerCamera";var t=this.cameraEntity.camera;t.copy(e),t.clearColorBuffer=!0,t.clearDepthBuffer=!0,t.clearStencilBuffer=!0,t.clearColor=$.WHITE,t.renderTarget=this.renderTarget,this.layer.clearCameras(),this.layer.addCamera(t),t.layers=[this.layer.id]},t.resize=function(e,t){this.width=Math.floor(e),this.height=Math.floor(t)},e}(),$m=function(e,t,i){return"\n#ifdef MAPFLOAT\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"},Ym=function(e,t,i){return"\n#ifdef MAPCOLOR\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"},Km=function(e,t,i){return"\n#ifdef MAPTEXTURE\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"},Zm=function(e,t,i){return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"},Qm=function(e,t,i){return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"},Jm=function(e,t,i){return"\n#ifdef MAPVERTEX\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"},ev=function(e,t,i){return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"},tv=function(e,t,i){return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"},iv=[],nv={_oldChunkToNew:{aoTexPS:{n:"aoPS",f:Km},aoVertPS:{n:"aoPS",f:Jm},diffuseConstPS:{n:"diffusePS",f:Ym},diffuseTexPS:{n:"diffusePS",f:Km},diffuseTexConstPS:{n:"diffusePS",f:Zm},diffuseVertPS:{n:"diffusePS",f:Jm},diffuseVertConstPS:{n:"diffusePS",f:ev},emissiveConstPS:{n:"emissivePS",f:Ym},emissiveTexPS:{n:"emissivePS",f:Km},emissiveTexConstPS:{n:"emissivePS",f:Zm},emissiveTexConstFloatPS:{n:"emissivePS",f:Qm},emissiveVertPS:{n:"emissivePS",f:Jm},emissiveVertConstPS:{n:"emissivePS",f:ev},emissiveVertConstFloatPS:{n:"emissivePS",f:tv},glossConstPS:{n:"glossPS",f:$m},glossTexPS:{n:"glossPS",f:Km},glossTexConstPS:{n:"glossPS",f:Qm},glossVertPS:{n:"glossPS",f:Jm},glossVertConstPS:{n:"glossPS",f:tv},metalnessConstPS:{n:"metalnessPS",f:$m},metalnessTexPS:{n:"metalnessPS",f:Km},metalnessTexConstPS:{n:"metalnessPS",f:Qm},metalnessVertPS:{n:"metalnessPS",f:Jm},metalnessVertConstPS:{n:"metalnessPS",f:tv},opacityConstPS:{n:"opacityPS",f:$m},opacityTexPS:{n:"opacityPS",f:Km},opacityTexConstPS:{n:"opacityPS",f:Qm},opacityVertPS:{n:"opacityPS",f:Jm},opacityVertConstPS:{n:"opacityPS",f:tv},specularConstPS:{n:"specularPS",f:Ym},specularTexPS:{n:"specularPS",f:Km},specularTexConstPS:{n:"specularPS",f:Zm},specularVertPS:{n:"specularPS",f:Jm},specularVertConstPS:{n:"specularPS",f:ev},transformBatchSkinnedVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef DYNAMICBATCH\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"}},transformInstancedVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef INSTANCING\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"}},transformPixelSnapVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef PIXELSNAP\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"}},transformScreenSpaceVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef SCREENSPACE\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"}},transformScreenSpaceBatchSkinned:{n:"transformVS",f:function(e,t,i){return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"}},transformSkinned:{n:"transformVS",f:function(e,t,i){return"\n#ifdef SKIN\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"}},transformUv1:{n:"transformVS",f:function(e,t,i){return"\n#ifdef UV1LAYOUT\n"+e+"\n#else\n"+Dt[t]+"\n#endif\n"}}},optionsContext:{},optionsContextMin:{},generateKey:function(e){var t,i=function(e){var t=[];for(var i in e)e.hasOwnProperty(i)&&"chunks"!==i&&"lights"!==i&&t.push(i);return t.sort()};e===this.optionsContextMin?(this.propsMin||(this.propsMin=i(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=i(e)),t=this.props):t=i(e);var n,a="standard";for(n=0;n<t.length;n++)e[t[n]]&&(a+=t[n]+e[t[n]]);if(e.chunks){var s=[];for(var r in e.chunks)e.chunks.hasOwnProperty(r)&&s.push(r+e.chunks[r]);s.sort(),a+=s}if(e.lights)for(n=0;n<e.lights.length;n++)a+=e.lights[n].key;return ct(a)},_correctChannel:function(e,t){if(0<iv[e]){if(iv[e]<t.length)return t.substring(0,iv[e]);if(iv[e]>t.length){for(var i=t,n=i.charAt(i.length-1),a=iv[e]-i.length,s=0;s<a;s++)i+=n;return i}return t}},_setMapTransform:function(e,t,i,n){e[0]+="uniform vec4 texture_"+t+"MapTransform;\n";var a=i+100*n;return e[3][a]||(e[1]+="varying vec2 vUV"+n+"_"+i+";\n",e[2]+="   vUV"+n+"_"+i+" = uv"+n+" * texture_"+t+"MapTransform.xy + texture_"+t+"MapTransform.zw;\n",e[3][a]=!0),e},_getUvSourceExpression:function(e,t,i){var n,a=i[e],s=i[t],r=0===i.pass||1===i.pass;return r&&1===i.nineSlicedMode?n="nineSlicedUv":r&&2===i.nineSlicedMode?n="nineSlicedUv, -1000.0":(n=0===a?"vUv"+s:"vUV"+s+"_"+a,i.heightMap&&"heightMapTransform"!==e&&(n+=" + dUvOffset")),n},_addMapDef:function(e,t){var i="\n#undef "+e+"\n";return t&&(i+=" #define "+e+"\n"),i},_addMapDefs:function(e,t,i,n){var a="";return a+=this._addMapDef("MAPFLOAT",e),a+=this._addMapDef("MAPCOLOR",t),(a+=this._addMapDef("MAPVERTEX",i))+this._addMapDef("MAPTEXTURE",n)},_addMap:function(e,t,i,n,a){var s=e+"Map",r=s+"Uv",o=s+"Transform",l=s+"Channel",h=e+"VertexColorChannel",c=e+"VertexColor",u=e+"Mode",d=i[e+"Tint"],p=i[c],f=i[s],m=i[u],v=n[t];if(f){var g=this._getUvSourceExpression(o,r,i);if(v=v.replace(/\$UV/g,g).replace(/\$CH/g,i[l]),void 0!==a){var _=0===a?"texture2DSRGB":1===a?"texture2DRGBM":"texture2D";v=v.replace(/\$texture2DSAMPLE/g,_)}}p&&(v=v.replace(/\$VC/g,i[h])),m&&(v=v.replace(/\$DETAILMODE/g,m));var y=1===d,b=3===d;return(v=this._addMapDefs(y,b,p,f)+v).replace(/\$/g,"")},_directionalShadowMapProjection:function(e,t,i,n,a){var s="";return 1<e.numCascades&&(s+="getShadowCascadeMatrix(light"+n+"_shadowMatrixPalette, light"+n+"_shadowCascadeDistances, light"+n+"_shadowCascadeCount);\n",t="(cascadeShadowMat, "+i+");\n"),(s+=a+t)+"fadeShadow(light"+n+"_shadowCascadeDistances);\n"},_nonPointShadowMapProjection:function(e,t,i,n,a){var s="("+i+", "+n+");\n";return!t._normalOffsetBias||t._isVsm?2===t._type?t._isPcf&&(e.webgl2||e.extStandardDerivatives)?"       getShadowCoordPerspZbuffer"+s:"       getShadowCoordPersp"+s:this._directionalShadowMapProjection(t,s,n,a,"getShadowCoordOrtho"):2===t._type?t._isPcf&&(e.webgl2||e.extStandardDerivatives)?"       getShadowCoordPerspZbufferNormalOffset"+s:"       getShadowCoordPerspNormalOffset"+s:this._directionalShadowMapProjection(t,s,n,a,"getShadowCoordOrthoNormalOffset")},_addVaryingIfNeeded:function(e,t,i){return 0<=e.indexOf(i)?"varying "+t+" "+i+";\n":""},_getLightSourceShapeString:function(e){switch(e){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}},_vsAddTransformCode:function(e,t,i,n){return e+i.transformVS},_vsAddBaseCode:function(e,t,i,n){return e+=i.baseVS,1!==n.nineSlicedMode&&2!==n.nineSlicedMode||(e+=i.baseNineSlicedVS),e},_fsAddBaseCode:function(e,t,i,n){return e+=i.basePS,1===n.nineSlicedMode?e+=i.baseNineSlicedPS:2===n.nineSlicedMode&&(e+=i.baseNineSlicedTiledPS),e},_fsAddStartCode:function(e,t,i,n){return e+=i.startPS,1===n.nineSlicedMode?e+=i.startNineSlicedPS:2===n.nineSlicedMode&&(e+=i.startNineSlicedTiledPS),e},createShaderDefinition:function(e,t){var i,n,a=0<t.lights.length;t.dirLightMap&&(a=!0),pi.clusteredLightingEnabled&&(a=!0),0===t.shadingModel?(t.fresnelModel=0,t.specularAntialias=!1,t.prefilteredCubemap=!1,t.dpAtlas=!1,t.ambientSH=!1):t.fresnelModel=0===t.fresnelModel?2:t.fresnelModel;var s=(t.cubeMap||t.prefilteredCubemap&&t.useSpecular)&&!t.sphereMap&&!t.dpAtlas,r=t.sphereMap||s||t.dpAtlas,o=t.useTexCubeLod;t.cubeMap&&(t.sphereMap=null),t.dpAtlas&&(t.prefilteredCubemap=null),t.useSpecular||(t.specularMap=t.glossMap=null);var l=a||r||t.ambientSH||t.prefilteredCubemap||t.heightMap||t.enableGGXSpecular,h=3<=t.pass&&t.pass<=17;this.options=t;var c,u,d,p="",f="",m="",v=Dt,g={vertex_position:Te};if(t.chunks){var _,y={};for(n in v)v.hasOwnProperty(n)&&(t.chunks[n]?(0<=(d=t.chunks[n]).indexOf("vertex_normal")&&(g.vertex_normal=Ae),0<=d.indexOf("vertex_tangent")&&(g.vertex_tangent=Ee),0<=d.indexOf("vertex_texCoord0")&&(g.vertex_texCoord0=Le),0<=d.indexOf("vertex_texCoord1")&&(g.vertex_texCoord1=Oe),0<=d.indexOf("vertex_color")&&(g.vertex_color=Ie),0<=d.indexOf("vertex_boneWeights")&&(g.vertex_boneWeights=Re),0<=d.indexOf("vertex_boneIndices")&&(g.vertex_boneIndices=De),y[n]=d):y[n]=v[n]);for(n in t.chunks)(_=this._oldChunkToNew[n])&&(y[_.n]=_.f(t.chunks[n],_.n,n));v=y}p=this._vsAddBaseCode(p,e,v,t),f+="   vPositionW    = getWorldPosition();\n",2===t.pass&&(p+="varying float vDepth;\n",p+="#ifndef VIEWMATRIX\n",p+="#define VIEWMATRIX\n",p+="uniform mat4 matrix_view;\n",p+="#endif\n",p+="#ifndef CAMERAPLANES\n",p+="#define CAMERAPLANES\n",p+="uniform vec4 camera_params;\n\n",p+="#endif\n",f+="    vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),t.useInstancing&&(g.instance_line1=Fe,g.instance_line2=ze,g.instance_line3=Be,g.instance_line4=Ve,p+=v.instancingVS),l&&(g.vertex_normal=Ae,f+="   vNormalW = getNormal();\n",t.sphereMap&&e.fragmentUniformsCount<=16&&(p+=v.viewNormalVS,f+="   vNormalV    = getViewNormal();\n"),(t.heightMap||t.normalMap||t.enableGGXSpecular)&&t.hasTangents?(g.vertex_tangent=Ee,p+=v.tangentBinormalVS,f+="   vTangentW   = getTangent();\n",f+="   vBinormalW  = getBinormal();\n"):t.enableGGXSpecular&&(p+=v.tangentBinormalVS,f+="   vObjectSpaceUpW  = getObjectSpaceUp();\n"));var b,x,M,S,w=[],C=[];for(n in iv)if(x=n+"Map",t[n+"VertexColor"]&&(t[b=n+"VertexColorChannel"]=this._correctChannel(n,t[b])),t[x]){b=x+"Channel",M=x+"Transform",t[S=x+"Uv"]=Math.min(t[S],1),t[b]=this._correctChannel(n,t[b]);var P=t[S];w[P]=!0,C[P]=C[P]||t[x]&&!t[M]}for(t.forceUv1&&(w[1]=!0,C[1]=void 0===C[1]||C[1]),i=0;i<2;i++)w[i]&&(g["vertex_texCoord"+i]="TEXCOORD"+i,p+=v["uv"+i+"VS"],f+="   vec2 uv"+i+" = getUv"+i+"();\n"),C[i]&&(f+="   vUv"+i+" = uv"+i+";\n");var T=[p,m,f,[]];for(n in iv)t[x=n+"Map"]&&t[M=x+"Transform"]&&(S=x+"Uv",this._setMapTransform(T,n,t[M],t[S]));p=T[0],m=T[1],f=T[2],t.vertexColors&&(g.vertex_color=Ie,f+="   vVertexColor = vertex_color;\n"),(t.useMorphPosition||t.useMorphNormal)&&(t.useMorphTextureBased?(p+="#define MORPHING_TEXTURE_BASED\n",t.useMorphPosition&&(p+="#define MORPHING_TEXTURE_BASED_POSITION\n"),t.useMorphNormal&&(p+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),g.morph_vertex_id=Ke,p+="attribute float morph_vertex_id;\n"):(p+="#define MORPHING\n",t.useMorphPosition?(g.morph_pos0=We,g.morph_pos1=He,g.morph_pos2=je,g.morph_pos3=Xe,p+="#define MORPHING_POS03\n",p+="attribute vec3 morph_pos0;\n",p+="attribute vec3 morph_pos1;\n",p+="attribute vec3 morph_pos2;\n",p+="attribute vec3 morph_pos3;\n"):t.useMorphNormal&&(g.morph_nrm0=We,g.morph_nrm1=He,g.morph_nrm2=je,g.morph_nrm3=Xe,p+="#define MORPHING_NRM03\n",p+="attribute vec3 morph_nrm0;\n",p+="attribute vec3 morph_nrm1;\n",p+="attribute vec3 morph_nrm2;\n",p+="attribute vec3 morph_nrm3;\n"),t.useMorphNormal?(g.morph_nrm4=qe,g.morph_nrm5=$e,g.morph_nrm6=Ye,g.morph_nrm7=Ke,p+="#define MORPHING_NRM47\n",p+="attribute vec3 morph_nrm4;\n",p+="attribute vec3 morph_nrm5;\n",p+="attribute vec3 morph_nrm6;\n",p+="attribute vec3 morph_nrm7;\n"):(g.morph_pos4=qe,g.morph_pos5=$e,g.morph_pos6=Ye,g.morph_pos7=Ke,p+="#define MORPHING_POS47\n",p+="attribute vec3 morph_pos4;\n",p+="attribute vec3 morph_pos5;\n",p+="attribute vec3 morph_pos6;\n",p+="attribute vec3 morph_pos7;\n"))),t.skin?(g.vertex_boneWeights=Re,g.vertex_boneIndices=De,p+=Ot(e,v),p+="#define SKIN\n"):t.useInstancing&&(p+="#define INSTANCING\n"),t.screenSpace&&(p+="#define SCREENSPACE\n"),t.pixelSnap&&(p+="#define PIXELSNAP\n"),p=this._vsAddTransformCode(p,e,v,t),l&&(p+=v.normalVS),p+="\n",p+=v.startVS,p+=f,p+=v.endVS;var A=p+="}",E=m;m="",m+=this._addVaryingIfNeeded(p,"vec4","vVertexColor"),m+=this._addVaryingIfNeeded(p,"vec3","vPositionW"),m+=this._addVaryingIfNeeded(p,"vec3","vNormalV"),m+=this._addVaryingIfNeeded(p,"vec3","vNormalW"),m+=this._addVaryingIfNeeded(p,"vec3","vTangentW"),m+=this._addVaryingIfNeeded(p,"vec3","vBinormalW"),m+=this._addVaryingIfNeeded(p,"vec3","vObjectSpaceUpW"),m+=this._addVaryingIfNeeded(p,"vec2","vUv0"),m+=this._addVaryingIfNeeded(p,"vec2","vUv1"),A=(m+=E)+A;var R="";if(e.webgl2?(R=zt(e),v.extensionVS&&(R+=v.extensionVS+"\n"),A=R+v.gles3VS+A):(v.extensionVS&&(R=v.extensionVS+"\n"),A=R+A),t.forceFragmentPrecision&&"highp"!==t.forceFragmentPrecision&&"mediump"!==t.forceFragmentPrecision&&"lowp"!==t.forceFragmentPrecision&&(t.forceFragmentPrecision=null),t.forceFragmentPrecision&&("highp"===t.forceFragmentPrecision&&"highp"!==e.maxPrecision&&(t.forceFragmentPrecision="mediump"),"mediump"===t.forceFragmentPrecision&&"lowp"===e.maxPrecision&&(t.forceFragmentPrecision="lowp")),p="",e.webgl2&&(p+=zt(e)),e.extStandardDerivatives&&!e.webgl2&&(p+="#extension GL_OES_standard_derivatives : enable\n\n"),v.extensionPS&&(p+=v.extensionPS+"\n"),e.webgl2&&(p+=v.gles3PS),p+=t.forceFragmentPrecision?"precision "+t.forceFragmentPrecision+" float;\n\n":Ft(e),18===t.pass)return p+="uniform vec4 uColor;\n",p+=m,t.alphaTest&&(p+="float dAlpha;\n",p+=this._addMap("opacity","opacityPS",t,v),p+=v.alphaTestPS),p+="void main(void)\n{\n",t.alphaTest&&(p+="   getOpacity();\n",p+="   alphaTest(dAlpha);\n"),p+="    gl_FragColor = uColor;\n",{attributes:g,vshader:A,fshader:p+="}\n"};if(2===t.pass)return p+="varying float vDepth;\n",p+=m,p+=v.packDepthPS,t.alphaTest&&(p+="float dAlpha;\n",p+=this._addMap("opacity","opacityPS",t,v),p+=v.alphaTestPS),p+="void main(void)\n{\n",t.alphaTest&&(p+="   getOpacity();\n",p+="   alphaTest(dAlpha);\n"),p+="    gl_FragColor = packFloat(vDepth);\n",{attributes:g,vshader:A,fshader:p+="}\n"};if(h){var D=t.pass-3,I=D-5*(c=Math.floor(D/5));return e.extStandardDerivatives&&!e.webgl2&&(p+="uniform vec2 polygonOffset;\n"),3===I?e.textureFloatHighPrecision?p+="#define VSM_EXPONENT 15.0\n\n":p+="#define VSM_EXPONENT 5.54\n\n":2===I&&(p+="#define VSM_EXPONENT 5.54\n\n"),0!==c&&(p+="uniform vec3 view_position;\n",p+="uniform float light_radius;\n"),p+=m,t.alphaTest&&(p+="float dAlpha;\n",p+=this._addMap("opacity","opacityPS",t,v),p+=v.alphaTestPS),0!==I||e.webgl2&&1!==c?1===I&&(p+="vec2 encodeFloatRG( float v ) {\n",p+="    vec2 enc = vec2(1.0, 255.0) * v;\n",p+="    enc = fract(enc);\n",p+="    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",p+="    return enc;\n",p+="}\n\n"):p+=v.packDepthPS,p+="void main(void)\n{\n",t.alphaTest&&(p+="   getOpacity();\n",p+="   alphaTest(dAlpha);\n"),p+=1===c||(1===I||2===I||3===I)&&0!==c?"   float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":"   float depth = gl_FragCoord.z;\n",0!==I||e.webgl2&&1!==c?p+=0===I||4===I?"   gl_FragColor = vec4(1.0);\n":1===I?"   gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":v.storeEVSMPS:(e.extStandardDerivatives&&!e.webgl2&&(p+="   float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",p+="   depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),p+="   gl_FragColor = packFloat(depth);\n"),{attributes:g,vshader:A,fshader:p+="}\n"}}if(t.customFragmentShader)return{attributes:g,vshader:A,fshader:p+t.customFragmentShader,tag:1};p+=m,p=this._fsAddBaseCode(p,e,v,t),t.detailModes&&(p+=v.detailModesPS);var k=p;p="",0<t.clearCoat&&(p+="#define CLEARCOAT\n"),!1===t.opacityFadesSpecular&&(p+="uniform float material_alphaFade;\n");var L,O=0,F=[],z=!1,B=!1,V=!1,U=t.lights.some(function(e){return e._shape&&0!==e._shape});7===e.areaLightLutFormat?(p+="#define AREA_R8_G8_B8_A8_LUTS\n",p+="#define AREA_LUTS_PRECISION lowp\n"):p+="#define AREA_LUTS_PRECISION highp\n",U&&(p+="#define AREA_LIGHTS\n",p+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex1;\n",p+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex2;\n");var N,G=0;for(i=0;i<t.lights.length;i++)p+="uniform vec3 light"+i+"_color;\n",0===(c=(L=t.lights[i])._type)?p+="uniform vec3 light"+i+"_direction;\n":(p+="uniform vec3 light"+i+"_position;\n",p+="uniform float light"+i+"_radius;\n",2===c&&(p+="uniform vec3 light"+i+"_direction;\n",p+="uniform float light"+i+"_innerConeAngle;\n",p+="uniform float light"+i+"_outerConeAngle;\n")),0!==(G=U&&L._shape?L._shape:0)&&(0===c&&(p+="uniform vec3 light"+i+"_position;\n"),p+="uniform vec3 light"+i+"_halfWidth;\n",p+="uniform vec3 light"+i+"_halfHeight;\n"),L.castShadows&&!t.noShadow&&(p+="uniform mat4 light"+i+"_shadowMatrix;\n",0===c&&(p+="uniform mat4 light"+i+"_shadowMatrixPalette[4];\n",p+="uniform float light"+i+"_shadowCascadeDistances[4];\n",p+="uniform float light"+i+"_shadowCascadeCount;\n"),0!==c?p+="uniform vec4 light"+i+"_shadowParams;\n":(z=!0,p+="uniform vec3 light"+i+"_shadowParams;\n"),1===c?p+="uniform samplerCube light"+i+"_shadowMap;\n":L._isPcf&&e.webgl2?p+="uniform sampler2DShadow light"+i+"_shadowMap;\n":p+="uniform sampler2D light"+i+"_shadowMap;\n",O++,F[L._shadowType]=!0,L._isVsm&&(B=!0),L._isPcf&&(e.webgl2||e.extStandardDerivatives)&&2===c&&(V=!0)),L._cookie&&(L._cookie._cubemap?1===c&&(p+="uniform samplerCube light"+i+"_cookie;\n",p+="uniform float light"+i+"_cookieIntensity;\n",L.castShadows&&!t.noShadow||(p+="uniform mat4 light"+i+"_shadowMatrix;\n")):2===c&&(p+="uniform sampler2D light"+i+"_cookie;\n",p+="uniform float light"+i+"_cookieIntensity;\n",L.castShadows&&!t.noShadow||(p+="uniform mat4 light"+i+"_shadowMatrix;\n"),L._cookieTransform&&(p+="uniform vec4 light"+i+"_cookieMatrix;\n",p+="uniform vec2 light"+i+"_cookieOffset;\n")));if(p+="\n",N=!t.hasTangents&&e.extStandardDerivatives?v.TBNderivativePS:t.fastTbn?v.TBNfastPS:v.TBNPS,l)if(t.normalMap||t.clearCoatNormalMap){if(p+=t.packedNormal?v.normalXYPS:v.normalXYZPS,!t.hasTangents){var W=this._getUvSourceExpression("normalMapTransform","normalMapUv",t);N=N.replace(/\$UV/g,W)}p+=N}else t.enableGGXSpecular&&!t.heightMap&&(p+=v.normalVertexPS,p+=v.TBNObjectSpacePS);if(l)if(t.normalMap){t.normalDetail&&(p+=this._addMap("normalDetail","normalDetailMapPS",t,v));var H=this._getUvSourceExpression("normalMapTransform","normalMapUv",t);t.normalizeNormalMap?p+=v.normalMapPS.replace(/\$UV/g,H):p+=v.normalMapFastPS.replace(/\$UV/g,H)}else t.enableGGXSpecular&&!t.heightMap||(p+=v.normalVertexPS);if(p+=It(t.gamma,v),p+=kt(t.toneMap,v),p+=Lt(t.fog,v),t.useRgbm&&(p+=v.rgbmPS),(s||t.prefilteredCubemap)&&(p+=t.fixSeams?v.fixCubemapSeamsStretchPS:v.fixCubemapSeamsNonePS),t.useCubeMapRotation&&(p+="#define CUBEMAP_ROTATION\n"),t.useRightHandedCubeMap&&(p+="#define RIGHT_HANDED_CUBEMAP\n"),l&&(p+=v.cubeMapRotatePS,p+=0<t.cubeMapProjection?v.cubeMapProjectBoxPS:v.cubeMapProjectNonePS,p+=t.skyboxIntensity?v.envMultiplyPS:v.envConstPS),t.diffuseDetail&&(p+=this._addMap("diffuseDetail","diffuseDetailMapPS",t,v)),p+=this._addMap("diffuse","diffusePS",t,v),(3!==t.blendType||t.alphaTest||t.alphaToCoverage)&&(p+=this._addMap("opacity","opacityPS",t,v)),p+=this._addMap("emissive","emissivePS",t,v,t.emissiveFormat),a&&t.useSpecular||r){t.specularAntialias&&t.normalMap?t.normalizeNormalMap&&l?p+=v.specularAaToksvigPS:p+=v.specularAaToksvigFastPS:p+=v.specularAaNonePS;var j=t.useMetalness?"metalness":"specular";p+=this._addMap(j,j+"PS",t,v),p+=this._addMap("gloss","glossPS",t,v),2===t.fresnelModel&&(p+=v.fresnelSchlickPS)}if(0<t.clearCoat&&(p+=this._addMap("clearCoat","clearCoatPS",t,v),p+=this._addMap("clearCoatGloss","clearCoatGlossPS",t,v),p+=this._addMap("clearCoatNormal","clearCoatNormalPS",t,v)),t.heightMap){if(!t.normalMap){var X=this._getUvSourceExpression("heightMapTransform","heightMapUv",t);t.hasTangents||(N=N.replace(/\$UV/g,X)),p+=N}p+=this._addMap("height","parallaxPS",t,v)}var q=t.aoMap||t.aoVertexColor;q&&(p+=this._addMap("ao","aoPS",t,v),t.occludeSpecular&&(1===t.occludeSpecular?p+=t.occludeSpecularFloat?v.aoSpecOccSimplePS:v.aoSpecOccConstSimplePS:p+=t.occludeSpecularFloat?v.aoSpecOccPS:v.aoSpecOccConstPS));var $=t.rgbmReflection?"decodeRGBM":t.hdrReflection?"":"gammaCorrectInput";if(t.sphereMap){var Y=16<e.fragmentUniformsCount?v.reflectionSpherePS:v.reflectionSphereLowPS;p+=Y=Y.replace(/\$texture2DSAMPLE/g,t.rgbmReflection?"texture2DRGBM":t.hdrReflection?"texture2D":"texture2DSRGB")}else s?t.prefilteredCubemap?p+=o?v.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,$):v.reflectionPrefilteredCubePS.replace(/\$DECODE/g,$):p+=v.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,t.rgbmReflection?"textureCubeRGBM":t.hdrReflection?"textureCube":"textureCubeSRGB"):t.dpAtlas&&(p+=v.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,t.rgbmReflection?"texture2DRGBM":t.hdrReflection?"texture2D":"texture2DSRGB"));(s||t.sphereMap||t.dpAtlas)&&(0<t.clearCoat&&(p+=v.reflectionCCPS),t.refraction&&(p+=v.refractionPS)),0<O&&(z&&(p+=Dt.shadowCascadesPS),F[0]&&(p+=v.shadowStandardPS),F[4]&&(p+=v.shadowStandardGL2PS),B&&(p+=v.shadowVSM_commonPS,F[1]&&(p+=v.shadowVSM8PS),F[2]&&(p+=e.extTextureHalfFloatLinear?v.shadowEVSMPS.replace(/\$/g,"16"):v.shadowEVSMnPS.replace(/\$/g,"16")),F[3]&&(p+=e.extTextureFloatLinear?v.shadowEVSMPS.replace(/\$/g,"32"):v.shadowEVSMnPS.replace(/\$/g,"32"))),e.webgl2||e.extStandardDerivatives||(p+=v.biasConstPS),p+=v.shadowCoordPS+v.shadowCommonPS,V&&(p+=v.shadowCoordPerspZbufferPS)),t.enableGGXSpecular&&(p+="uniform float material_anisotropy;\n"),a&&(p+=v.lightDiffuseLambertPS,U&&(p+=v.ltc));var K=!1;t.useSpecular?(a&&(p+=0===t.shadingModel?v.lightSpecularPhongPS:t.enableGGXSpecular?v.lightSpecularAnisoGGXPS:v.lightSpecularBlinnPS),t.sphereMap||s||t.dpAtlas||0<t.fresnelModel?0<t.fresnelModel?t.conserveEnergy&&!U?p+=v.combineDiffuseSpecularPS:p+=v.combineDiffuseSpecularNoConservePS:p+=v.combineDiffuseSpecularOldPS:t.diffuseMap?p+=v.combineDiffuseSpecularNoReflPS:(p+=v.combineDiffuseSpecularNoReflSeparateAmbientPS,K=!0)):p+=v.combineDiffusePS,0<t.clearCoat&&(p+=v.combineClearCoatPS);var Z=!0;if(t.lightMap||t.lightVertexColor){var Q=t.dirLightMap&&t.useSpecular?"lightmapDirPS":"lightmapSinglePS";p+=this._addMap("light",Q,t,v,t.lightMapFormat),Z=t.lightMapWithoutAmbient}if(Z){var J=t.rgbmAmbient?"decodeRGBM":t.hdrAmbient?"":"gammaCorrectInput";t.ambientSH?p+=v.ambientSHPS:t.prefilteredCubemap?p+=o?v.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,J):v.ambientPrefilteredCubePS.replace(/\$DECODE/g,J):p+=v.ambientConstantPS}t.ambientTint&&!K&&(p+="uniform vec3 material_ambient;\n"),t.alphaTest&&(p+=v.alphaTestPS),t.msdf&&(p+=v.msdfPS),l&&(p+=v.viewDirPS,t.useSpecular&&(p+=t.enableGGXSpecular?v.reflDirAnisoPS:v.reflDirPS));var ee,te=!1,ie=!1,ne=!1,ae=!1,se=!1;pi.clusteredLightingEnabled&&(ie=te=ae=!0,p+="\n#define CLUSTER_TEXTURE_"+(ai.lightTextureFormat===ai.FORMAT_FLOAT?"FLOAT":"8BIT")+"\n",p+=v.clusteredLightPS),t.twoSidedLighting&&(p+="uniform float twoSidedLightingNegScaleFactor;\n"),p=this._fsAddStartCode(p,e,v,t),l&&(t.hasTangents||!e.extStandardDerivatives||t.fastTbn?t.twoSidedLighting?p+="   dVertexNormalW = gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor;\n":p+="   dVertexNormalW = vNormalW;\n":t.twoSidedLighting?p+="   dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);\n":p+="   dVertexNormalW = normalize(vNormalW);\n",(t.heightMap||t.normalMap)&&t.hasTangents&&(t.twoSidedLighting?(p+="   dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;\n",p+="   dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;\n"):(p+="   dTangentW = vTangentW;\n",p+="   dBinormalW = vBinormalW;\n")));var re=!1;3!==t.blendType||t.alphaTest||t.alphaToCoverage?t.heightMap&&t.opacityMap?re=!0:(p+="   getOpacity();\n",t.alphaTest&&(p+="   alphaTest(dAlpha);\n")):p+="   dAlpha = 1.0;\n";var oe=!1;if(l&&(p+="   getViewDir();\n",(t.heightMap||t.normalMap||t.clearCoatNormalMap||t.enableGGXSpecular)&&(p+="   getTBN();\n"),t.heightMap&&(p+="   getParallax();\n"),re&&(p+="   getOpacity();\n",t.alphaTest&&(p+="   alphaTest(dAlpha);\n")),p+="   getNormal();\n",t.useSpecular&&(t.enableGGXSpecular&&(p+="   getGlossiness();\n",oe=!0),p+="   getReflDir();\n")),p+="   getAlbedo();\n",0<t.clearCoat&&(p+="   getClearCoat();\n",p+="   getClearCoatGlossiness();\n",p+="   getClearCoatNormal();\n"),(a&&t.useSpecular||r)&&(p+="   getSpecularity();\n",oe||(p+="   getGlossiness();\n"),U&&(p+="   #ifdef AREA_LIGHTS\n",p+="   dSpecularityNoFres = dSpecularity;\n",p+="   #ifdef CLEARCOAT\n",p+="   ccSpecularityNoFres = ccSpecularity;\n",p+="   #endif\n",p+="   #endif\n"),0<t.fresnelModel&&(p+="   getFresnel();\n")),Z&&(p+="   addAmbient();\n"),t.ambientTint&&!K&&(p+="   dDiffuseLight *= material_ambient;\n"),q&&!t.occludeDirect&&(p+="    applyAO();\n"),(t.lightMap||t.lightVertexColor)&&(p+="   addLightMap();\n"),a||r){(s||t.sphereMap||t.dpAtlas)&&(0<t.clearCoat&&(p+="   addReflectionCC();\n"),p+="   addReflection();\n"),U&&(p+="   ccReflection.rgb *= ccSpecularity;\n",p+="   dReflection.rgb *= dSpecularity;\n",p+="   dSpecularLight *= dSpecularity;\n",p+="   float roughness = max((1.0 - dGlossiness) * (1.0 - dGlossiness), 0.001);\n");var le="";for(pi.clusteredLightingEnabled&&(te=ie=!0,p+=v.clusteredLightLoopPS),i=0;i<t.lights.length;i++)if(c=(L=t.lights[i])._type,!pi.clusteredLightingEnabled||0===c){if(ee=!1,U&&L._shape?(G=L._shape,le=this._getLightSourceShapeString(G)):(G=0,le=""),0!==G&&(p+="   calc"+le+"LightValues(light"+i+"_position, light"+i+"_halfWidth, light"+i+"_halfHeight);\n"),0===c?(p+="   dLightDirNormW = light"+i+"_direction;\n",p+="   dAtten = 1.0;\n"):(L._cookie&&(2!==c||L._cookie._cubemap?1===c&&L._cookie._cubemap&&(ee=se=!0):ee=se=!0),p+="   getLightDirPoint(light"+i+"_position);\n",te=!0,ee&&(p+=2===c?"   dAtten3 = getCookie2D"+(L._cookieFalloff?"":"Clip")+(L._cookieTransform?"Xform":"")+"(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity"+(L._cookieTransform?", light"+i+"_cookieMatrix, light"+i+"_cookieOffset":"")+")."+L._cookieChannel+";\n":"   dAtten3 = getCookieCube(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity)."+L._cookieChannel+";\n"),0===G?0===L._falloffMode?(p+="   dAtten = getFalloffLinear(light"+i+"_radius);\n",ie=!0):(p+="   dAtten = getFalloffInvSquared(light"+i+"_radius);\n",ne=!0):(p+="   dAtten = getFalloffWindow(light"+i+"_radius);\n",ne=!0),p+="   if (dAtten > 0.00001) {\n",2===c&&(ee&&!L._cookieFalloff||(p+="       dAtten *= getSpotEffect(light"+i+"_direction, light"+i+"_innerConeAngle, light"+i+"_outerConeAngle);\n",ae=!0))),p+=0!==G?0===c?"       dAttenD = getLightDiffuse();\n":"       dAttenD = get"+le+"LightDiffuse() * 16.0;\n":"       dAtten *= getLightDiffuse();\n",L.castShadows&&!t.noShadow){var he,ce=null;if(1===L._shadowType?(ce="VSM8",he="0.0"):2===L._shadowType?(ce="VSM16",he="5.54"):3===L._shadowType?(ce="VSM32",he=e.textureFloatHighPrecision?"15.0":"5.54"):ce=4===L._shadowType?"PCF5x5":"PCF3x3",null!==ce)if(1===c)u="(light"+i+"_shadowMap, light"+i+"_shadowParams);\n",L._normalOffsetBias&&(p+="       normalOffsetPointShadow(light"+i+"_shadowParams);\n"),p+="       dAtten *= getShadowPoint"+ce+u;else{var ue="light"+i+"_shadowMatrix",de="light"+i+"_shadowParams";p+=this._nonPointShadowMapProjection(e,t.lights[i],ue,de,i),2===c&&(ce="Spot"+ce),p+="       dAtten *= getShadow"+ce+"(light"+i+"_shadowMap, light"+i+"_shadowParams"+(L._isVsm?", "+he:"")+");\n"}}0!==G?t.conserveEnergy&&t.useSpecular?p+="       dDiffuseLight += mix((dAttenD * dAtten) * light"+i+"_color"+(ee?" * dAtten3":"")+", vec3(0), dLTCSpecFres);\n":p+="       dDiffuseLight += (dAttenD * dAtten) * light"+i+"_color"+(ee?" * dAtten3":"")+";\n":U&&t.conserveEnergy&&t.useSpecular?p+="       dDiffuseLight += mix(dAtten * light"+i+"_color"+(ee?" * dAtten3":"")+", vec3(0), dSpecularity);\n":p+="       dDiffuseLight += dAtten * light"+i+"_color"+(ee?" * dAtten3":"")+";\n",0!==G?(0<t.clearCoat&&(p+="       ccSpecularLight += ccLTCSpecFres * get"+le+"LightSpecularCC() * dAtten * light"+i+"_color"+(ee?" * dAtten3":"")+";\n"),t.useSpecular&&(p+="       dSpecularLight += dLTCSpecFres * get"+le+"LightSpecular() * dAtten * light"+i+"_color"+(ee?" * dAtten3":"")+";\n")):U?(0<t.clearCoat&&(p+="       ccSpecularLight += ccSpecularity * getLightSpecularCC() * dAtten * light"+i+"_color"+(ee?" * dAtten3":"")+";\n"),t.useSpecular&&(p+="       dSpecularLight += dSpecularity * getLightSpecular() * dAtten * light"+i+"_color"+(ee?" * dAtten3":"")+";\n")):(0<t.clearCoat&&(p+="       ccSpecularLight += getLightSpecularCC() * dAtten * light"+i+"_color"+(ee?" * dAtten3":"")+";\n"),t.useSpecular&&(p+="       dSpecularLight += getLightSpecular() * dAtten * light"+i+"_color"+(ee?" * dAtten3":"")+";\n")),0!==c&&(p+="   }\n"),p+="\n"}U&&(0<t.clearCoat&&(p+="   ccSpecularity = 1.0;\n"),t.useSpecular&&(p+="   dSpecularity = vec3(1);\n")),(s||t.sphereMap||t.dpAtlas)&&t.refraction&&(p+="   addRefraction();\n")}p+="\n",q&&(t.occludeDirect&&(p+="    applyAO();\n"),t.occludeSpecular&&(p+="    occludeSpecular();\n")),!1===t.opacityFadesSpecular&&(2!==t.blendType&&4!==t.blendType||(p+="float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n",p+="#ifdef CLEARCOAT\n specLum += dot(ccSpecularLight * ccSpecularity + ccReflection.rgb * ccReflection.a * ccSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif\n",p+="dAlpha = clamp(dAlpha + gammaCorrectInput(specLum), 0.0, 1.0);\n"),p+="dAlpha *= material_alphaFade;\n"),p+=v.endPS,t.useClearCoat&&(p+="    gl_FragColor.rgb = addClearCoat(gl_FragColor);\n"),2===t.blendType||6===t.blendType||t.alphaToCoverage?p+=v.outputAlphaPS:4===t.blendType?p+=v.outputAlphaPremulPS:p+=v.outputAlphaOpaquePS,t.msdf&&(p+="   gl_FragColor = applyMsdf(gl_FragColor);\n"),p+="\n",p+="}\n",te&&(p=v.lightDirPointPS+p),ie&&(p=v.falloffLinearPS+p),ne&&(p=v.falloffInvSquaredPS+p),ae&&(p=v.spotPS+p),se&&(p=v.cookiePS+p);var pe="";return p.includes("dReflection")&&(pe+="vec4 dReflection;\n"),p.includes("dTBN")&&(pe+="mat3 dTBN;\n"),p.includes("dAlbedo")&&(pe+="vec3 dAlbedo;\n"),p.includes("dEmission")&&(pe+="vec3 dEmission;\n"),p.includes("dNormalW")&&(pe+="vec3 dNormalW;\n"),p.includes("dVertexNormalW")&&(pe+="vec3 dVertexNormalW;\n"),p.includes("dTangentW")&&(pe+="vec3 dTangentW;\n"),p.includes("dBinormalW")&&(pe+="vec3 dBinormalW;\n"),p.includes("dViewDirW")&&(pe+="vec3 dViewDirW;\n"),p.includes("dReflDirW")&&(pe+="vec3 dReflDirW;\n"),p.includes("dDiffuseLight")&&(pe+="vec3 dDiffuseLight;\n"),p.includes("dSpecularLight")&&(pe+="vec3 dSpecularLight;\n"),p.includes("dLightDirNormW")&&(pe+="vec3 dLightDirNormW;\n"),p.includes("dLightDirW")&&(pe+="vec3 dLightDirW;\n"),p.includes("dLightPosW")&&(pe+="vec3 dLightPosW;\n"),p.includes("dShadowCoord")&&(pe+="vec3 dShadowCoord;\n"),p.includes("dNormalMap")&&(pe+="vec3 dNormalMap;\n"),p.includes("dSpecularity")&&(pe+="vec3 dSpecularity;\n"),p.includes("dSpecularityNoFres")&&(pe+="vec3 dSpecularityNoFres;\n"),p.includes("dUvOffset")&&(pe+="vec2 dUvOffset;\n"),p.includes("dGlossiness")&&(pe+="float dGlossiness;\n"),p.includes("dAlpha")&&(pe+="float dAlpha;\n"),p.includes("dAtten")&&(pe+="float dAtten;\n"),p.includes("dAttenD")&&(pe+="float dAttenD;\n"),p.includes("dAtten3")&&(pe+="vec3 dAtten3;\n"),p.includes("dAo")&&(pe+="float dAo;\n"),p.includes("dMsdf")&&(pe+="vec4 dMsdf;\n"),p.includes("ccReflection")&&(pe+="vec4 ccReflection;\n"),p.includes("ccNormalW")&&(pe+="vec3 ccNormalW;\n"),p.includes("ccReflDirW")&&(pe+="vec3 ccReflDirW;\n"),p.includes("ccSpecularLight")&&(pe+="vec3 ccSpecularLight;\n"),p.includes("ccSpecularity")&&(pe+="float ccSpecularity;\n"),p.includes("ccSpecularityNoFres")&&(pe+="float ccSpecularityNoFres;\n"),p.includes("ccGlossiness")&&(pe+="float ccGlossiness;\n"),{attributes:g,vshader:A,fshader:p=k+pe+p,tag:1}}};function av(){this._mapXForms=null}av.prototype.updateMinRef=function(e,t,i,n,a,s,r,o,l){this._updateSharedOptions(e,n,a,r),this._updateMinOptions(e,n),this._updateUVOptions(e,n,a,!0)},av.prototype.updateRef=function(e,t,i,n,a,s,r,o,l){this._updateSharedOptions(e,n,a,r),e.useTexCubeLod=t.useTexCubeLod,this._updateEnvOptions(e,n,i,l),this._updateMaterialOptions(e,n),1===r&&(e.gamma&&(e.gamma=3),e.toneMap=0),e.hasTangents=a&&n.normalMap&&0!=(512&a),this._updateLightOptions(e,n,a,o,s),this._updateUVOptions(e,n,a,!1)},av.prototype._updateSharedOptions=function(e,t,i,n){e.pass=n,e.alphaTest=0<t.alphaTest,e.forceFragmentPrecision=t.forceFragmentPrecision||"",e.chunks=t.chunks||"",e.blendType=t.blendType,e.forceUv1=t.forceUv1,e.screenSpace=i&&0!=(256&i),e.skin=i&&0!=(2&i),e.useInstancing=i&&0!=(32&i),e.useMorphPosition=i&&0!=(1024&i),e.useMorphNormal=i&&0!=(2048&i),e.useMorphTextureBased=i&&0!=(4096&i),e.nineSlicedMode=t.nineSlicedMode||0},av.prototype._updateUVOptions=function(e,t,i,n){var a=!1,s=!1,r=!1;for(var o in i&&(a=0!=(4&i),s=0!=(8&i),r=0!=(16&i)),e.vertexColors=!1,this._mapXForms=[],iv)this._updateTexOptions(e,t,o,a,s,r,n);this._mapXForms=null},av.prototype._updateMinOptions=function(e,t){e.opacityTint=1!==t.opacity&&3!==t.blendType,e.lights=[]},av.prototype._updateMaterialOptions=function(e,t){var i=1===t.diffuse.r&&1===t.diffuse.g&&1===t.diffuse.b||!t.diffuseTint&&(t.diffuseMap||t.diffuseVertexColor)?0:3,n=!1,a=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||t.dpAtlas);(a=(a=(a=a||!!t.useMetalness||!(0===t.specular.r&&0===t.specular.g&&0===t.specular.b))||t.enableGGXSpecular)||0<t.clearCoat)&&(!t.specularTint&&(t.specularMap||t.specularVertexColor)||t.useMetalness||(n=1!==t.specular.r||1!==t.specular.g||1!==t.specular.b));var s=t.emissiveMap?0:3;s||(s=(s=(1!==t.emissive.r||1!==t.emissive.g||1!==t.emissive.b||1!==t.emissiveIntensity)&&t.emissiveTint)?3:1!==t.emissiveIntensity?1:0);var r=!!t.normalMap&&(10===t.normalMap.format||t.normalMap.type===et);e.opacityTint=1!==t.opacity&&3!==t.blendType?1:0,e.blendMapsWithColors=!0,e.ambientTint=t.ambientTint,e.diffuseTint=i,e.specularTint=n?3:0,e.metalnessTint=t.useMetalness&&t.metalness<1?1:0,e.glossTint=1,e.emissiveTint=s,e.alphaToCoverage=t.alphaToCoverage,e.normalizeNormalMap=t.normalizeNormalMap,e.sphereMap=!!t.sphereMap,e.cubeMap=!!t.cubeMap,e.dpAtlas=!!t.dpAtlas,e.ambientSH=!!t.ambientSH,e.useSpecular=a,e.emissiveFormat=t.emissiveMap?t.emissiveMap.type===Qe?1:t.emissiveMap.format===Ce?2:0:null,e.lightMapFormat=t.lightMap?t.lightMap.type===Qe?1:t.lightMap.format===Ce?2:0:null,e.specularAntialias=t.specularAntialias&&!!t.normalMap&&!!t.normalMap.mipmaps&&!r,e.conserveEnergy=t.conserveEnergy,e.opacityFadesSpecular=t.opacityFadesSpecular,e.alphaFade=t.alphaFade,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.occludeDirect=t.occludeDirect,e.shadingModel=t.shadingModel,e.fresnelModel=t.fresnelModel,e.packedNormal=r,e.fastTbn=t.fastTbn,e.cubeMapProjection=t.cubeMapProjection,e.customFragmentShader=t.customFragmentShader,e.refraction=!!t.refraction,e.useMetalness=t.useMetalness,e.enableGGXSpecular=t.enableGGXSpecular,e.useClearCoat=t.useClearCoat,e.uClearCoatColor=t.uClearCoatColor,e.uClearCoatMap=!!t.uClearCoatMap,e.attenuationColor=t.attenuationColor,e.subsurfaceColor=t.subsurfaceColor,e.msdf=!!t.msdfMap,e.twoSidedLighting=t.twoSidedLighting,e.pixelSnap=t.pixelSnap,e.aoMapUv=t.aoUvSet,e.diffuseDetail=!!t.diffuseMap,e.normalDetail=!!t.normalMap,e.diffuseDetailMode=t.diffuseDetailMode,e.detailModes=!!e.diffuseDetail,e.clearCoat=!!t.clearCoat,e.clearCoatTint=1!==t.clearCoat?1:0,e.clearCoatGlossiness=!!t.clearCoatGlossiness,e.clearCoatGlossTint=1!==t.clearCoatGlossiness?1:0},av.prototype._updateEnvOptions=function(e,t,i,n){var a,s=n&&n.type===Qe||t.cubeMap&&t.cubeMap.type===Qe||t.dpAtlas&&t.dpAtlas.type===Qe,r=n&&(n.type===Qe||n.format===Ce)||t.cubeMap&&(t.cubeMap.type===Qe||t.cubeMap.format===Ce)||t.dpAtlas&&(t.dpAtlas.type===Qe||t.dpAtlas.format===Ce),o=n&&!t.cubeMap&&!t.sphereMap&&!t.dpAtlas&&n.type===Qe||t.cubeMap&&t.cubeMap.type===Qe||t.sphereMap&&t.sphereMap.type===Qe||t.dpAtlas&&t.dpAtlas.type===Qe,l=!(!n||t.cubeMap||t.sphereMap||t.dpAtlas)&&(n.type===Qe||n.format===Ce)||t.cubeMap&&(t.cubeMap.type===Qe||t.cubeMap.format===Ce)||t.sphereMap&&(t.sphereMap.type===Qe||t.sphereMap.format===Ce)||t.dpAtlas&&(t.dpAtlas.type===Qe||t.dpAtlas.format===Ce);t.useSkybox&&i._skyboxPrefiltered&&(a=i._skyboxPrefiltered[0]),e.fog=t.useFog?i.fog:"none",e.gamma=t.useGammaTonemap?i.gammaCorrection:0,e.toneMap=t.useGammaTonemap?i.toneMapping:-1,e.rgbmAmbient=s,e.hdrAmbient=r,e.rgbmReflection=o,e.hdrReflection=l,e.useRgbm=o||s||t.emissiveMap&&t.emissiveMap.type===Qe||t.lightMap&&t.lightMap.type===Qe,e.fixSeams=n?n.fixCubemapSeams:!!t.cubeMap&&t.cubeMap.fixCubemapSeams,e.prefilteredCubemap=!!n,e.skyboxIntensity=n&&a&&n===a&&1!==i.skyboxIntensity,e.useCubeMapRotation=!t.cubeMap&&!t.prefilteredCubeMap128&&t.useSkybox&&i&&i.skyboxRotation&&!i.skyboxRotation.equals(fe.IDENTITY),e.useRightHandedCubeMap=t.cubeMap?t.cubeMap._isRenderTarget:!t.prefilteredCubeMap128&&t.useSkybox&&i&&i._skyboxIsRenderTarget},av.prototype._updateLightOptions=function(e,t,i,n,a){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.noShadow=0!=(1&i),0!=(64&i)&&(e.lightMapFormat=1,e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.lightMapWithoutAmbient=!t.lightMap,e.useRgbm=!0,0!=(128&i)&&(e.dirLightMap=!0))),t.useLighting){var s=[],r=i?i>>16:1;n&&(this._collectLights(0,n[0],s,r),this._collectLights(1,n[1],s,r,a),this._collectLights(2,n[2],s,r,a)),e.lights=s}else e.lights=[];0===e.lights.length&&(e.noShadow=!0)},av.prototype._updateTexOptions=function(e,t,i,n,a,s,r){var o=i+"Map",l=i+"VertexColor",h=i+"VertexColorChannel",c=o+"Channel",u=o+"Transform",d=o+"Uv";"light"!==i&&(e[o]=!1,e[c]="",e[u]=0,e[d]=0),e[l]=!1,e[h]="";var p="opacity"===i;if(p&&3===t.blendType&&0===t.alphaTest&&!t.alphaToCoverage)return e;if((!r||p)&&("height"!==i&&t[l]&&s&&(e[l]=t[l],e[h]=t[h],e.vertexColors=!0),t[o])){var f=!0;0!==t[d]||n||(f=!1),1!==t[d]||a||(f=!1),f&&(e[o]=!!t[o],e[u]=this._getMapTransformID(t[u],t[d]),e[c]=t[c],e[d]=t[d])}},av.prototype._collectLights=function(e,t,i,n,a){var s,r;for(r=0;r<t.length;r++)if((s=t[r]).enabled&&s.mask&n){if(0!==e&&s.isStatic)continue;i.push(s)}if(a)for(r=0;r<a.length;r++)(s=a[r])._type===e&&i.push(s)},av.prototype._getMapTransformID=function(e,t){if(!e)return 0;var i,n;for(this._mapXForms[t]||(this._mapXForms[t]=[]),i=0;i<this._mapXForms[t].length;i++){if(n=!0,this._mapXForms[t][i][0]!==e.x){n=!1;break}if(this._mapXForms[t][i][1]!==e.y){n=!1;break}if(this._mapXForms[t][i][2]!==e.z){n=!1;break}if(this._mapXForms[t][i][3]!==e.w){n=!1;break}if(n)return i+1}var a=this._mapXForms[t].length;return this._mapXForms[t][a]=[],this._mapXForms[t][a][0]=e.x,this._mapXForms[t][a][1]=e.y,this._mapXForms[t][a][2]=e.z,this._mapXForms[t][a][3]=e.w,a+1};var sv,rv={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useClearCoat:"boolean",uClearCoatFactor:"number",uClearCoatIor:"number",uClearCoatF0:"number",uClearCoatReflection:"number",uClearCoatF0Radio:"number",uClearCoatThickness:"number",uClearCoatColor:"rgb",uClearCoatMap:"texture",uClearCoatMapChannel:"string",uClearCoatMapUv:"number",uClearCoatMapTiling:"vec2",uClearCoatMapOffset:"vec2",uClearCoatFresnelPower:"number",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"},ov=[];for(sv in rv)"texture"===rv[sv]&&ov.push(sv);var lv=[];for(sv in rv)"cubemap"===rv[sv]&&lv.push(sv);var hv=[],cv=[],uv=[],dv=[],pv={},fv=[],mv=function(){function e(){}return e.prototype.copy=function(e){for(var t in e)e.hasOwnProperty(t)&&"copy"!==t&&(this[t]=e[t])},e}(),vv=function(t){function n(){var e;return(e=t.call(this)||this)._assetReferences={},e._validator=null,e.shaderOptBuilder=new av,e.reset(),e}u(n,t);var e=n.prototype;return e.reset=function(){for(var e=0;e<hv.length;e++){var t=cv[e];this[hv[e]]=t&&t.clone?t.clone():t}for(var i=0;i<uv.length;i++)this[uv[i]]=null;for(var n=0;n<dv.length;n++)this[dv[n]]=new Float32Array(3);this._chunks=new mv,this.cubeMapMinUniform=new Float32Array(3),this.cubeMapMaxUniform=new Float32Array(3)},e.clone=function(){var e=new n;this._cloneInternal(e);for(var t=0;t<hv.length;t++){var i=hv[t];void 0!==this[i]&&(this[i]&&this[i].copy?e[i]?e[i].copy(this[i]):e[i]=this[i].clone():e[i]=this[i])}return e},e._updateMapTransform=function(e,t,i){return 1===t.x&&1===t.y&&0===i.x&&0===i.y?null:((e=e||new ee).set(t.x,t.y,i.x,1-t.y-i.y),e)},e._setParameter=function(e,t){this.parameters[e]||this._propsSet.push(e),this.setParameter(e,t)},e._clearParameters=function(){for(var e=this._propsSet,t=0;t<e.length;t++)delete this.parameters[e[t]];this._propsSet=[]},e._updateMap=function(e){var t=e+"Map",i=this[t];if(i){this._setParameter("texture_"+t,i);var n=t+"Transform";this[n]=this._updateMapTransform(this[n],this[t+"Tiling"],this[t+"Offset"]);var a=this[n];if(a){var s=t+"TransformUniform",r=this[s];r||(r=new Float32Array(4),this[s]=r),r[0]=a.x,r[1]=a.y,r[2]=a.z,r[3]=a.w,this._setParameter("texture_"+n,r)}}},e.getUniform=function(e,t,i){var n=pv[e];return n?n(this,t,i):null},e.updateUniforms=function(){this._clearParameters(),this._setParameter("material_ambient",this.ambientUniform),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",this.diffuseUniform),this.useMetalness?(!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness):this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),0<this.clearCoat&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness));var e=this.getUniform("shininess",this.shininess,!0);for(var t in this._setParameter(e.name,e.value),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",this.emissiveUniform),this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),0<this.refraction&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0)),iv)this._updateMap(t);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&(e=this.getUniform("heightMapFactor",this.heightMapFactor,!0),this._setParameter(e.name,e.value)),this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap),this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]&&this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]),this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]),this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]),this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]),this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]),this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]),this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas),this._setParameter("material_reflectivity",this.reflectivity),this.useClearCoat&&(this._setParameter("useClearCoat",this.useClearCoat),this._setParameter("uClearCoatFactor",this.uClearCoatFactor),this._setParameter("uClearCoatIor",this.uClearCoatIor),this._setParameter("uClearCoatF0",this.uClearCoatF0),this._setParameter("uClearCoatThickness",this.uClearCoatThickness),this._setParameter("uClearCoatFresnelPower",this.uClearCoatFresnelPower),this.uClearCoatMap?this._setParameter("texture_uClearCoatMap",this.uClearCoatMap):this._setParameter("uClearCoatColor",this.uClearCoatColorUniform)),!this.dirtyShader&&this._scene||(this.shader=null,this.clearVariants()),this._processColor()},e._processColor=function(){if(this.dirtyColor&&(this._scene||!this.useGammaTonemap)){var e=!1;this.useGammaTonemap&&(e=this._scene.gammaCorrection);for(var t=0;t<fv.length;t++){var i=this["_"+fv[t]],n=this[fv[t]+"Uniform"];e?(n[0]=Math.pow(i.r,2.2),n[1]=Math.pow(i.g,2.2),n[2]=Math.pow(i.b,2.2)):(n[0]=i.r,n[1]=i.g,n[2]=i.b)}for(var a=0;a<3;a++)this.emissiveUniform[a]*=this.emissiveIntensity;this.dirtyColor=!1}},e.updateShader=function(e,t,i,n,a,s){!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());var r,o,l,h,c,u,d=e.useTexCubeLod,p=!e.extTextureLod;this.useSkybox&&(r=t._skyboxPrefiltered[0],o=t._skyboxPrefiltered[1],l=t._skyboxPrefiltered[2],h=t._skyboxPrefiltered[3],c=t._skyboxPrefiltered[4],u=t._skyboxPrefiltered[5]);var f=this.prefilteredCubeMap128||r,m=this.prefilteredCubeMap64||o,v=this.prefilteredCubeMap32||l,g=this.prefilteredCubeMap16||h,_=this.prefilteredCubeMap8||c,y=this.prefilteredCubeMap4||u;if(f){var b=f&&m&&v&&g&&_&&y;if(p&&b){if(!f.dpAtlas){var x=[f,m,v,g,_,y];f.dpAtlas=Bi(e,x),f.sh=Um(e,g)}this.dpAtlas=f.dpAtlas,this.ambientSH=f.sh,this._setParameter("ambientSH[0]",this.ambientSH),this._setParameter("texture_sphereMap",this.dpAtlas)}else d?f._levels.length<6?b&&this._setParameter("texture_prefilteredCubeMap128",f):this._setParameter("texture_prefilteredCubeMap128",f):b&&(this._setParameter("texture_prefilteredCubeMap128",f),this._setParameter("texture_prefilteredCubeMap64",m),this._setParameter("texture_prefilteredCubeMap32",v),this._setParameter("texture_prefilteredCubeMap16",g),this._setParameter("texture_prefilteredCubeMap8",_),this._setParameter("texture_prefilteredCubeMap4",y));this.useSkybox&&!t.skyboxRotation.equals(fe.IDENTITY)&&t._skyboxRotationMat3&&this._setParameter("cubeMapRotationMatrix",t._skyboxRotationMat3.data)}var M=1<a&&a<=18,S=M?nv.optionsContextMin:nv.optionsContext;M?this.shaderOptBuilder.updateMinRef(S,e,t,this,i,n,a,s,f):this.shaderOptBuilder.updateRef(S,e,t,this,i,n,a,s,f),this.onUpdateShader&&(S=this.onUpdateShader(S));var w=e.getProgramLibrary();this.shader=w.getProgram("standard",S),i||(this.clearVariants(),this.variants[0]=this.shader),this.dirtyShader=!1},e.destroy=function(){for(var e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,this._validator=null,t.prototype.destroy.call(this)},n}(Ui);function gv(e,t,i,n,a,s,r){var o="_"+t+"Map",l=o+"Tiling",h=o+"Offset",c=o.substring(1)+"Transform",u=c+"Uniform",d=o+"Uv",p=o+"Channel",f="_"+t+"VertexColor",m="_"+t+"VertexColorChannel",v="_"+t+"Mode";if(e[o]=null,e[l]=new J(1,1),e[h]=new J(0,0),e[c]=null,e[u]=null,e[d]=i,0<n){var g=a||(1<n?"rgb":"g");e[p]=g,s&&(e[m]=g)}s&&(e[f]=!1),r&&(e[v]="mul"),iv[t]=n,Object.defineProperty(vv.prototype,o.substring(1),{get:function(){return this[o]},set:function(e){var t=this[o];!!t^!!e&&(this.dirtyShader=!0),t&&e&&(t.type===e.type&&t.fixCubemapSeams===e.fixCubemapSeams&&t.format===e.format||(this.dirtyShader=!0)),this[o]=e}});var _=l.substring(1),y=h.substring(1);Object.defineProperty(vv.prototype,_,{get:function(){return this[l]},set:function(e){this.dirtyShader=!0,this[l]=e}}),pv[_]=function(e,t,i){var n=e._updateMapTransform(i?e[c]:null,t,e[h]);return{name:"texture_"+c,value:n.data}},Object.defineProperty(vv.prototype,y,{get:function(){return this[h]},set:function(e){this.dirtyShader=!0,this[h]=e}}),pv[y]=function(e,t,i){var n=e._updateMapTransform(i?e[c]:null,e[l],t);return{name:"texture_"+c,value:n.data}},Object.defineProperty(vv.prototype,d.substring(1),{get:function(){return this[d]},set:function(e){this[d]!==e&&(this.dirtyShader=!0),this[d]=e}}),Object.defineProperty(vv.prototype,p.substring(1),{get:function(){return this[p]},set:function(e){this[p]!==e&&(this.dirtyShader=!0),this[p]=e}}),s&&(Object.defineProperty(vv.prototype,f.substring(1),{get:function(){return this[f]},set:function(e){this.dirtyShader=!0,this[f]=e}}),Object.defineProperty(vv.prototype,m.substring(1),{get:function(){return this[m]},set:function(e){this[m]!==e&&(this.dirtyShader=!0),this[m]=e}})),r&&Object.defineProperty(vv.prototype,v.substring(1),{get:function(){return this[v]},set:function(e){this.dirtyShader=!0,this[v]=e}}),hv.push(o.substring(1)),hv.push(l.substring(1)),hv.push(h.substring(1)),hv.push(d.substring(1)),hv.push(p.substring(1)),s&&(hv.push(f.substring(1)),hv.push(m.substring(1))),r&&hv.push(v.substring(1)),uv.push(c)}function _v(e,r,t,o){var l="_"+r,h=r+"Uniform",i=r+"Intensity",c="_"+i;e[l]=t,e[h]=new Float32Array(3),Object.defineProperty(vv.prototype,r,{get:function(){return this.dirtyColor=!0,this.dirtyShader=!0,this[l]},set:function(e){var t=this[l];(0===t.r&&0===t.g&&0===t.b||1===t.r&&1===t.g&&1===t.b)^(0===e.r&&0===e.g&&0===e.b||1===e.r&&1===e.g&&1===e.b)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[l]=e}}),hv.push(r),dv.push(h),fv.push(r),pv[r]=function(e,t,i){var n=i?e[h]:new Float32Array(3),a=!1;e.useGammaTonemap&&(a=(e._scene||hi().scene).gammaCorrection);for(var s=0;s<3;s++)n[s]=a?Math.pow(t.data[s],2.2):t.data[s],o&&(n[s]*=e[c]);return{name:"material_"+r,value:n}},o&&(e[c]=1,Object.defineProperty(vv.prototype,i,{get:function(){return this[c]},set:function(e){var t=this[c];(0===t||1===t)^(0===e||1===e)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[c]=e}}),hv.push(i),pv[i]=function(e,t,i){var n=i?e[h]:new Float32Array(3),a=!1;e.useGammaTonemap&&(a=(e._scene||hi().scene).gammaCorrection);for(var s=0;s<3;s++)n[s]=a?Math.pow(e[l].data[s],2.2):e[l].data[s],n[s]*=e[c];return{name:"material_"+r,value:n}})}function yv(e,n,t,i){var a="_"+n;e[a]=t,Object.defineProperty(vv.prototype,n,{get:function(){return this[a]},set:function(e){var t=this[a];t!==e&&(this[a]=e,(0===t||1===t||0===e||1===e)&&(this.dirtyShader=!0))}}),hv.push(n),pv[n]=void 0!==i?i:function(e,t,i){return{name:"material_"+n,value:t}}}function bv(e,t,i){var n="_"+t;e[n]=null,Object.defineProperty(vv.prototype,t,{get:function(){return this[n]},set:function(e){!!this[n]^!!e&&(this.dirtyShader=!0),this[n]=e}}),hv.push(t),pv[t]=i}function xv(e,t,i){Object.defineProperty(vv.prototype,i,{get:function(){return this[t]},set:function(e){this[t]=e}})}function Mv(e,t,i){var n="_"+t;e[n]=i,Object.defineProperty(vv.prototype,t,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this.dirtyShader=!0),this[n]=e}}),hv.push(t)}vv.TEXTURE_PARAMETERS=ov,vv.CUBEMAP_PARAMETERS=lv,function(e){e.dirtyShader=!0,e.dirtyColor=!0,e._scene=null,e._colorProcessed=!1,_v(e,"ambient",new $(.7,.7,.7)),_v(e,"diffuse",new $(1,1,1)),_v(e,"specular",new $(.33,.33,.33)),_v(e,"emissive",new $(0,0,0),!0),_v(e,"uClearCoatColor",new $(0,0,0)),yv(e,"shininess",80,function(e,t){return{name:"material_shininess",value:0===e.shadingModel?Math.pow(2,.01*t*11):.01*t}}),yv(e,"heightMapFactor",1,function(e,t){return{name:"material_heightMapFactor",value:.025*t}}),yv(e,"opacity",1),yv(e,"alphaFade",1),yv(e,"alphaTest",0),yv(e,"bumpiness",1),yv(e,"normalDetailMapBumpiness",1),yv(e,"reflectivity",1),yv(e,"occludeSpecularIntensity",1),yv(e,"refraction",0),yv(e,"refractionIndex",1/1.5),yv(e,"metalness",1),yv(e,"anisotropy",0),yv(e,"clearCoat",0),yv(e,"clearCoatGlossiness",1),yv(e,"clearCoatBumpiness",1),yv(e,"uClearCoatFactor",1),yv(e,"uClearCoatIor",1),yv(e,"uClearCoatF0",.08),yv(e,"uClearCoatThickness",.01),yv(e,"uClearCoatReflection",1),yv(e,"uClearCoatF0Radio",.04),yv(e,"uClearCoatFresnelPower",3),yv(e,"aoUvSet",0,null),bv(e,"ambientSH",function(e,t,i){return{name:"ambientSH[0]",value:t}}),bv(e,"cubeMapProjectionBox",function(e,t,i){var n=i?e.cubeMapMinUniform:new Float32Array(3),a=i?e.cubeMapMaxUniform:new Float32Array(3);return n[0]=t.center.x-t.halfExtents.x,n[1]=t.center.y-t.halfExtents.y,n[2]=t.center.z-t.halfExtents.z,a[0]=t.center.x+t.halfExtents.x,a[1]=t.center.y+t.halfExtents.y,a[2]=t.center.z+t.halfExtents.z,[{name:"envBoxMin",value:n},{name:"envBoxMax",value:a}]}),Object.defineProperty(vv.prototype,"chunks",{get:function(){return this.dirtyShader=!0,this._chunks},set:function(e){this.dirtyShader=!0,this._chunks=e}}),hv.push("chunks"),Mv(e,"ambientTint",!1),Mv(e,"diffuseTint",!1),Mv(e,"specularTint",!1),Mv(e,"emissiveTint",!1),Mv(e,"fastTbn",!1),Mv(e,"specularAntialias",!1),Mv(e,"useMetalness",!1),Mv(e,"enableGGXSpecular",!1),Mv(e,"occludeDirect",!1),Mv(e,"normalizeNormalMap",!0),Mv(e,"conserveEnergy",!0),Mv(e,"opacityFadesSpecular",!0),Mv(e,"occludeSpecular",1),Mv(e,"shadingModel",1),Mv(e,"fresnelModel",2),Mv(e,"cubeMapProjection",0),Mv(e,"customFragmentShader",null),Mv(e,"forceFragmentPrecision",null),Mv(e,"useFog",!0),Mv(e,"useLighting",!0),Mv(e,"useGammaTonemap",!0),Mv(e,"useSkybox",!0),Mv(e,"useClearCoat",!1),Mv(e,"forceUv1",!1),Mv(e,"pixelSnap",!1),Mv(e,"twoSidedLighting",!1),Mv(e,"nineSlicedMode",void 0),gv(e,"diffuse",0,3,"",!0),gv(e,"specular",0,3,"",!0),gv(e,"emissive",0,3,"",!0),gv(e,"normal",0,-1,"",!1),gv(e,"metalness",0,1,"",!0),gv(e,"gloss",0,1,"",!0),gv(e,"opacity",0,1,"a",!0),gv(e,"height",0,1,"",!1),gv(e,"ao",0,1,"",!0),gv(e,"light",1,3,"",!0),gv(e,"msdf",0,3,"",!1),gv(e,"diffuseDetail",0,3,"",!1,!0),gv(e,"normalDetail",0,-1,"",!1),gv(e,"uClearCoat",0,3,"",!0),gv(e,"clearCoat",0,1,"",!0),gv(e,"clearCoatGloss",0,1,"",!0),gv(e,"clearCoatNormal",0,-1,"",!1),bv(e,"cubeMap"),bv(e,"sphereMap"),bv(e,"dpAtlas"),bv(e,"prefilteredCubeMap128"),bv(e,"prefilteredCubeMap64"),bv(e,"prefilteredCubeMap32"),bv(e,"prefilteredCubeMap16"),bv(e,"prefilteredCubeMap8"),bv(e,"prefilteredCubeMap4"),xv(0,"diffuseTint","diffuseMapTint"),xv(0,"specularTint","specularMapTint"),xv(0,"emissiveTint","emissiveMapTint"),xv(0,"aoVertexColor","aoMapVertexColor"),xv(0,"diffuseVertexColor","diffuseMapVertexColor"),xv(0,"specularVertexColor","specularMapVertexColor"),xv(0,"emissiveVertexColor","emissiveMapVertexColor"),xv(0,"metalnessVertexColor","metalnessMapVertexColor"),xv(0,"glossVertexColor","glossMapVertexColor"),xv(0,"opacityVertexColor","opacityMapVertexColor"),xv(0,"lightVertexColor","lightMapVertexColor");for(var t=0;t<hv.length;t++)cv[t]=e[hv[t]];e._propsSet=[]}(vv.prototype);var Sv=function(o){function e(e,t){var i;void 0===t&&(t={}),(i=o.call(this)||this).type="bitmap",i.app=e,i.intensity=0,i.fontWeight=t.fontWeight||"normal",i.fontSize=parseInt(t.fontSize,10),i.glyphSize=i.fontSize,i.fontName=t.fontName||"Arial",i.color=t.color||new $(1,1,1),i.padding=t.padding||0;var n=4096<t.width?4096:t.width||512,a=4096<t.height?4096:t.height||512,s=document.createElement("canvas");s.height=a,s.width=n;var r=new Kt(i.app.graphicsDevice,{format:7,mipmaps:!0});return r.name="font",r.flipY=!1,r.setSource(s),r.minFilter=5,r.magFilter=1,r.addressU=1,r.addressV=1,i.textures=[r],i.chars="",i.data={},i}u(e,o);var t=e.prototype;return t.createTextures=function(e){var t=this._normalizeCharsSet(e);if(t.length===this.chars.length){for(var i=0;i<t.length;i++)if(t[i]!==this.chars[i])return void this._renderAtlas(t)}else this._renderAtlas(t)},t.updateTextures=function(e){for(var t=this._normalizeCharsSet(e),i=[],n=0;n<t.length;n++){var a=t[n];this.data.chars[a]||i.push(a)}0<i.length&&this._renderAtlas(this.chars.concat(i))},t.destroy=function(){for(var e=0;e<this.textures.length;e++)this.textures[e].destroy();this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.textures=null,this.type=null,this.fontWeight=null},t._getAndClearContext=function(e,t){var i=e.width,n=e.height,a=e.getContext("2d",{alpha:!0});return a.clearRect(0,0,i,n),a.fillStyle=t,a.fillRect(0,0,i,n),a},t._colorToRgbString=function(e,t){var i=Math.round(255*e.r),n=Math.round(255*e.g),a=Math.round(255*e.b);return t?"rgba("+i+", "+n+", "+a+", "+e.a+")":"rgb("+i+", "+n+", "+a+")"},t.renderCharacter=function(e,t,i,n,a){e.fillStyle=a,e.fillText(t,i,n)},t._renderAtlas=function(e){this.chars=e;var t=1,i=this.textures[t-1].getSource(),n=i.width,a=i.height,s=this._colorToRgbString(this.color,!1),r=this.color.a;this.color.a=1/255;var o=this._colorToRgbString(this.color,!0);this.color.a=r;var l="alphabetic",h=this._getAndClearContext(i,o);h.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName,h.textAlign="center",h.textBaseline=l,this.data=this._createJson(this.chars,this.fontName,n,a);var c,u,d=Me.getSymbols(this.chars.join("")),p=this.textures.length,f=0,m=0,v={};for(c=0;c<d.length;c++)v[u=d[c]]=this._getTextMetrics(u),f=Math.max(f,v[u].height),m=Math.max(m,v[u].descent);this.glyphSize=Math.max(this.glyphSize,f);var g=this.glyphSize+2*this.padding,_=this.glyphSize+2*this.padding,y=this.glyphSize/2+this.padding,b=_-m-this.padding,x=0,M=0;for(c=0;c<d.length;c++){u=d[c];var S=Me.getCodePoint(d[c]),w=this.fontSize;h.font=this.fontWeight+" "+w.toString()+"px "+this.fontName,h.textAlign="center",h.textBaseline=l;var C=h.measureText(u).width;w<C&&(w=this.fontSize*this.fontSize/C,h.font=this.fontWeight+" "+w.toString()+"px "+this.fontName,C=this.fontSize),this.renderCharacter(h,u,x+y,M+b,s);var P=this.padding+(this.glyphSize-C)/2,T=-this.padding+v[u].descent-m,A=C;if(this._addChar(this.data,u,S,x,M,g,_,P,T,A,t-1,n,a),(x+=g)+g>n&&(x=0,(M+=_)+_>a))if(this.textures[t-1].upload(),M=0,++t>p){(i=document.createElement("canvas")).height=a,i.width=n,h=this._getAndClearContext(i,o);var E=new Kt(this.app.graphicsDevice,{format:7,mipmaps:!0});E.flipY=!1,E.name="font-atlas",E.setSource(i),E.minFilter=5,E.magFilter=1,E.addressU=1,E.addressV=1,this.textures.push(E)}else i=this.textures[t-1].getSource(),h=this._getAndClearContext(i,o)}if(this.textures[t-1].upload(),t<p){for(c=t;c<p;c++)this.textures[c].destroy();this.textures.splice(t)}this.fire("render")},t._createJson=function(e,t,i,n){return{version:3,intensity:this.intensity,info:{face:t,width:i,height:n,maps:[{width:i,height:n}]},chars:{}}},t._addChar=function(e,t,i,n,a,s,r,o,l,h,c,u,d){e.info.maps.length<c+1&&e.info.maps.push({width:u,height:d});var p=this.fontSize/32;e.chars[t]={id:i,letter:t,x:n,y:a,width:s,height:r,xadvance:h/p,xoffset:o/p,yoffset:(l+this.padding)/p,scale:p,range:1,map:c,bounds:[0,0,s/p,r/p]}},t._normalizeCharsSet=function(e){var t=this.app.systems.element.getUnicodeConverter();t&&(e=t(e));var i,n={},a=Me.getSymbols(e);for(i=0;i<a.length;i++){var s=a[i];n[s]||(n[s]=s)}return Object.keys(n).sort()},t._getTextMetrics=function(e){var t=document.createElement("span");t.id="content-span",t.innerHTML=e;var i=document.createElement("div");i.id="content-block",i.style.display="inline-block",i.style.width="1px",i.style.height="0px";var n=document.createElement("div");n.appendChild(t),n.appendChild(i),n.style.font=this.fontSize+"px "+this.fontName,document.body.appendChild(n);var a=-1,s=-1,r=-1;try{i.style["vertical-align"]="baseline",a=i.offsetTop-t.offsetTop,i.style["vertical-align"]="bottom",s=(r=i.offsetTop-t.offsetTop)-a}finally{document.body.removeChild(n)}return{ascent:a,descent:s,height:r}},e}(p),wv=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*"),Cv=function(i){function e(e){var t;return(t=i.call(this)||this).initScriptType(e),t}u(e,i);var t=e.prototype;return t.initScriptType=function(e){var t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled="boolean"!=typeof e.enabled||e.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=e.attributes||{},this.__scriptType=t,this.__executionOrder=-1},e.__getScriptName=function(e){if("function"==typeof e){if("name"in Function.prototype)return e.name;if(e===Function||e===Function.prototype.constructor)return"Function";var t=(""+e).match(wv);return t?t[1]:void 0}},t.__initializeAttributes=function(e){if(e||this.__attributesRaw){for(var t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}},e.extend=function(e){for(var t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t])},c(e,[{key:"enabled",get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,Zp.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,Zp.scriptMethods.postInitialize)))}}],[{key:"scriptName",get:function(){return this.__name}},{key:"attributes",get:function(){return this.hasOwnProperty("__attributes")||(this.__attributes=new Kp(this)),this.__attributes}}]),e}(p);Cv.__name=null;var Pv=new Set(["system","entity","create","destroy","swap","move","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","has","get","on","off","fire","once","hasEvent"]);function Tv(e,t){if(gl.legacy)return null;if(Pv.has(e))throw new Error("script name: '"+e+"' is reserved, please change script name");var i=function(e){p.prototype.initEventHandler.call(this),Cv.prototype.initScriptType.call(this,e)};return((i.prototype=Object.create(Cv.prototype)).constructor=i).extend=Cv.extend,i.attributes=new Kp(i),function(e,t,i){if(!e.legacy){if("function"!=typeof e)throw new Error("script class: '"+e+"' must be a constructor function (i.e. class).");if(!(e.prototype instanceof Cv))throw new Error("script class: '"+Cv.__getScriptName(e)+"' does not extend pc.ScriptType.");if(t=t||e.__name||Cv.__getScriptName(e),Pv.has(t))throw new Error("script name: '"+t+"' is reserved, please change script name");e.__name=t,(i?i.scripts:om.getApplication().scripts).add(e),_l._push(e)}}(i,e,t),i}var Av={};Kp.reservedNames.forEach(function(e,t,i){Av[e]=1}),Tv.reservedAttributes=Av;var Ev="keydown",Rv="mousedown",Dv="mousemove",Iv="mouseup",kv="mousewheel",Lv="touchstart",Ov="touchend",Fv="touchmove",zv="touchcancel",Bv=new function(e,t){this.key=null,this.element=null,this.event=null};function Vv(e){return Bv.key=e.keyCode,Bv.element=e.target,Bv.event=e,Bv}function Uv(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e}var Nv={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},Gv=function(n){function e(e,t){var i;return void 0===t&&(t={}),(i=n.call(this)||this)._element=null,i._keyDownHandler=i._handleKeyDown.bind(g(i)),i._keyUpHandler=i._handleKeyUp.bind(g(i)),i._keyPressHandler=i._handleKeyPress.bind(g(i)),i._visibilityChangeHandler=i._handleVisibilityChange.bind(g(i)),i._windowBlurHandler=i._handleWindowBlur.bind(g(i)),i._keymap={},i._lastmap={},e&&i.attach(e),i.preventDefault=t.preventDefault||!1,i.stopPropagation=t.stopPropagation||!1,i}u(e,n);var t=e.prototype;return t.attach=function(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)},t.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1)},t.toKeyIdentifier=function(e){var t,i,n;e=Uv(e);var a=Nv[e.toString()];if(a)return a;for(n=(i=e.toString(16).toUpperCase()).length,t=0;t<4-n;t++)i="0"+i;return"U+"+i},t._handleKeyDown=function(e){var t=e.keyCode||e.charCode;if(void 0!==t){var i=this.toKeyIdentifier(t);this._keymap[i]=!0,this.fire("keydown",Vv(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}},t._handleKeyUp=function(e){var t=e.keyCode||e.charCode;if(void 0!==t){var i=this.toKeyIdentifier(t);delete this._keymap[i],this.fire("keyup",Vv(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}},t._handleKeyPress=function(e){this.fire("keypress",Vv(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()},t._handleVisibilityChange=function(){"hidden"===document.visibilityState&&this._handleWindowBlur()},t._handleWindowBlur=function(){this._keymap={},this._lastmap={}},t.update=function(){var e;for(e in this._lastmap)delete this._lastmap[e];for(e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])},t.isPressed=function(e){var t=Uv(e),i=this.toKeyIdentifier(t);return!!this._keymap[i]},t.wasPressed=function(e){var t=Uv(e),i=this.toKeyIdentifier(t);return!!this._keymap[i]&&!this._lastmap[i]},t.wasReleased=function(e){var t=Uv(e),i=this.toKeyIdentifier(t);return!this._keymap[i]&&!!this._lastmap[i]},e}(p);function Wv(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}var Hv,jv,Xv=function e(t,i){var n={x:0,y:0};if(i){if(i instanceof e)throw Error("Expected MouseEvent");n=t._getTargetCoords(i)}else i={};if(n)this.x=n.x,this.y=n.y;else{if(!Wv())return;this.x=0,this.y=0}this.wheelDelta=0,"wheel"===i.type&&(0<i.deltaY?this.wheelDelta=1:i.deltaY<0&&(this.wheelDelta=-1)),Wv()?(this.dx=i.movementX||i.webkitMovementX||i.mozMovementX||0,this.dy=i.movementY||i.webkitMovementY||i.mozMovementY||0):(this.dx=this.x-t._lastX,this.dy=this.y-t._lastY),"mousedown"===i.type||"mouseup"===i.type?this.button=i.button:this.button=-1,this.buttons=t._buttons.slice(0),this.element=i.target,this.ctrlKey=i.ctrlKey||!1,this.altKey=i.altKey||!1,this.shiftKey=i.shiftKey||!1,this.metaKey=i.metaKey||!1,this.event=i},qv=function(i){function e(e){var t;return(t=i.call(this)||this)._lastX=0,t._lastY=0,t._buttons=[!1,!1,!1],t._lastbuttons=[!1,!1,!1],t._upHandler=t._handleUp.bind(g(t)),t._downHandler=t._handleDown.bind(g(t)),t._moveHandler=t._handleMove.bind(g(t)),t._wheelHandler=t._handleWheel.bind(g(t)),t._contextMenuHandler=function(e){e.preventDefault()},t._target=null,t._attached=!1,t.attach(e),t}u(e,i),e.isPointerLocked=function(){return Wv()};var t=e.prototype;return t.attach=function(e){if(this._target=e,!this._attached){this._attached=!0;var t=!!T&&{passive:!1};window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)}},t.detach=function(){if(this._attached){this._attached=!1,this._target=null;var e=!!T&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)}},t.disableContextMenu=function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},t.enableContextMenu=function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},t.enablePointerLock=function(t,i){document.body.requestPointerLock?(t&&document.addEventListener("pointerlockchange",function e(){t(),document.removeEventListener("pointerlockchange",e)},!1),i&&document.addEventListener("pointerlockerror",function e(){i(),document.removeEventListener("pointerlockerror",e)},!1),document.body.requestPointerLock()):i&&i()},t.disablePointerLock=function(t){document.exitPointerLock&&(t&&document.addEventListener("pointerlockchange",function e(){t(),document.removeEventListener("pointerlockchange",e)},!1),document.exitPointerLock())},t.update=function(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]},t.isPressed=function(e){return this._buttons[e]},t.wasPressed=function(e){return this._buttons[e]&&!this._lastbuttons[e]},t.wasReleased=function(e){return!this._buttons[e]&&this._lastbuttons[e]},t._handleUp=function(e){this._buttons[e.button]=!1;var t=new Xv(this,e);t.event&&this.fire(Iv,t)},t._handleDown=function(e){this._buttons[e.button]=!0;var t=new Xv(this,e);t.event&&this.fire(Rv,t)},t._handleMove=function(e){var t=new Xv(this,e);t.event&&(this.fire(Dv,t),this._lastX=t.x,this._lastY=t.y)},t._handleWheel=function(e){var t=new Xv(this,e);t.event&&this.fire(kv,t)},t._getTargetCoords=function(e){var t=this._target.getBoundingClientRect(),i=Math.floor(t.left),n=Math.floor(t.top);return e.clientX<i||e.clientX>=i+this._target.clientWidth||e.clientY<n||e.clientY>=n+this._target.clientHeight?null:{x:e.clientX-i,y:e.clientY-n}},e}(p),$v=new de,Yv=new de,Kv=new xe,Zv=new xe,Qv=new xe;Kv.end=new de,Zv.end=new de,Qv.end=new de;var Jv=new de,eg=new de,tg=new de,ig=new de,ng=new de,ag=new de,sg=new de,rg=new J,og=new de,lg=new de,hg=new de,cg=new de,ug=new de,dg=new de,pg=new de,fg=new de,mg=new ee;function vg(e,t,i){return sg.cross(e,t).dot(i)}var gg=function(){function e(e,t,i){this.event=e,this.element=t,this.camera=i,this._stopPropagation=!1}return e.prototype.stopPropagation=function(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())},e}(),_g=function(l){function e(e,t,i,n,a,s,r){var o;return(o=l.call(this,e,t,i)||this).x=n,o.y=a,o.ctrlKey=e.ctrlKey||!1,o.altKey=e.altKey||!1,o.shiftKey=e.shiftKey||!1,o.metaKey=e.metaKey||!1,o.button=e.button,qv.isPointerLocked()?(o.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,o.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(o.dx=n-s,o.dy=a-r),o.wheelDelta=0,"wheel"===e.type&&(0<e.deltaY?o.wheelDelta=1:e.deltaY<0&&(o.wheelDelta=-1)),o}return u(e,l),e}(gg),yg=function(o){function e(e,t,i,n,a,s){var r;return(r=o.call(this,e,t,i)||this).touches=e.touches,r.changedTouches=e.changedTouches,r.x=n,r.y=a,r.touch=s,r}return u(e,o),e}(gg),bg=function(s){function e(e,t,i,n){var a;return(a=s.call(this,e,t,i)||this).inputSource=n,a}return u(e,s),e}(gg),xg=function(){function e(e,t){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!t||!1!==t.useMouse,this._useTouch=!t||!1!==t.useTouch,this._useXr=!t||!1!==t.useXr,this._selectEventsAttached=!1,w&&(this._clickedEntities={}),this.attach(e)}var t=e.prototype;return t.attach=function(e){this._attached&&(this._attached=!1,this.detach()),this._target=e,this._attached=!0;var t=!!T&&{passive:!0};this._useMouse&&(window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)),this._useTouch&&w&&(this._target.addEventListener("touchstart",this._touchstartHandler,t),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()},t.attachSelectEvents=function(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))},t.detach=function(){if(this._attached){this._attached=!1;var e=!!T&&{passive:!0};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,e),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}},t.addElement=function(e){-1===this._elements.indexOf(e)&&this._elements.push(e)},t.removeElement=function(e){var t=this._elements.indexOf(e);-1!==t&&this._elements.splice(t,1)},t._handleUp=function(e){this._enabled&&(qv.isPointerLocked()||(this._calcMouseCoords(e),null!==Hv&&this._onElementMouseEvent("mouseup",e)))},t._handleDown=function(e){this._enabled&&(qv.isPointerLocked()||(this._calcMouseCoords(e),null!==Hv&&this._onElementMouseEvent("mousedown",e)))},t._handleMove=function(e){this._enabled&&(this._calcMouseCoords(e),null!==Hv&&(this._onElementMouseEvent("mousemove",e),this._lastX=Hv,this._lastY=jv))},t._handleWheel=function(e){this._enabled&&(this._calcMouseCoords(e),null!==Hv&&this._onElementMouseEvent("mousewheel",e))},t._determineTouchedElements=function(e){var t,i,n,a={},s=this.app.systems.camera.cameras;for(t=s.length-1;0<=t;t--){var r=s[t],o=0;for(i=0,n=e.changedTouches.length;i<n;i++)if(a[e.changedTouches[i].identifier])o++;else{var l=this._calcTouchCoords(e.changedTouches[i]),h=this._getTargetElement(r,l.x,l.y);h&&(o++,a[e.changedTouches[i].identifier]={element:h,camera:r,x:l.x,y:l.y})}if(o===n)break}return a},t._handleTouchStart=function(e){if(this._enabled){for(var t=this._determineTouchedElements(e),i=0,n=e.changedTouches.length;i<n;i++){var a=e.changedTouches[i],s=t[a.identifier],r=this._touchedElements[a.identifier];!s||r&&s.element===r.element||(this._fireEvent(e.type,new yg(e,s.element,s.camera,s.x,s.y,a)),this._touchesForWhichTouchLeaveHasFired[a.identifier]=!1)}for(var o in t)this._touchedElements[o]=t[o]}},t._handleTouchEnd=function(e){if(this._enabled){var t=this.app.systems.camera.cameras;for(var i in this._clickedEntities)delete this._clickedEntities[i];for(var n=0,a=e.changedTouches.length;n<a;n++){var s=e.changedTouches[n],r=this._touchedElements[s.identifier];if(r){var o=r.element,l=r.camera,h=r.x,c=r.y;if(delete this._touchedElements[s.identifier],delete this._touchesForWhichTouchLeaveHasFired[s.identifier],this._fireEvent(e.type,new yg(e,o,l,h,c,s)),0===e.touches.length)for(var u=this._calcTouchCoords(s),d=t.length-1;0<=d;d--)this._getTargetElement(t[d],u.x,u.y)===o&&(this._clickedEntities[o.entity.getGuid()]||(this._fireEvent("click",new yg(e,o,l,h,c,s)),this._clickedEntities[o.entity.getGuid()]=!0))}}}},t._handleTouchMove=function(e){if(e.preventDefault(),this._enabled)for(var t=this._determineTouchedElements(e),i=0,n=e.changedTouches.length;i<n;i++){var a=e.changedTouches[i],s=t[a.identifier],r=this._touchedElements[a.identifier];if(r){var o=this._calcTouchCoords(a);s&&s.element===r.element||this._touchesForWhichTouchLeaveHasFired[a.identifier]||(this._fireEvent("touchleave",new yg(e,r.element,r.camera,o.x,o.y,a)),this._touchesForWhichTouchLeaveHasFired[a.identifier]=!0),this._fireEvent("touchmove",new yg(e,r.element,r.camera,o.x,o.y,a))}}},t._onElementMouseEvent=function(e,t){var i,n=this._hoveredElement;this._hoveredElement=null;for(var a,s=this.app.systems.camera.cameras,r=s.length-1;0<=r&&(a=s[r],!(i=this._getTargetElement(a,Hv,jv)));r--);i&&(this._fireEvent(e,new _g(t,i,a,Hv,jv,this._lastX,this._lastY)),this._hoveredElement=i,"mousedown"===e&&(this._pressedElement=i)),n!==this._hoveredElement&&(n&&this._fireEvent("mouseleave",new _g(t,n,a,Hv,jv,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new _g(t,this._hoveredElement,a,Hv,jv,this._lastX,this._lastY))),"mouseup"===e&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new _g(t,this._hoveredElement,a,Hv,jv,this._lastX,this._lastY))):this._pressedElement=null)},t._onXrStart=function(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)},t._onXrEnd=function(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)},t._onXrUpdate=function(){if(this._enabled)for(var e=this.app.xr.input.inputSources,t=0;t<e.length;t++)this._onElementSelectEvent("selectmove",e[t],null)},t._onXrInputRemove=function(e){var t=this._selectedElements[e.id];t&&(e._elementEntity=null,this._fireEvent("selectleave",new bg(null,t,null,e))),delete this._selectedElements[e.id],delete this._selectedPressedElements[e.id]},t._onSelectStart=function(e,t){this._enabled&&this._onElementSelectEvent("selectstart",e,t)},t._onSelectEnd=function(e,t){this._enabled&&this._onElementSelectEvent("selectend",e,t)},t._onElementSelectEvent=function(e,t,i){var n,a,s,r=this._selectedElements[t.id],o=this.app.systems.camera.cameras;if(t.elementInput){Qv.set(t.getOrigin(),t.getDirection());for(var l=o.length-1;0<=l&&(s=o[l],!(n=this._getTargetElementByRay(Qv,s)));l--);}t._elementEntity=n||null,n?a=this._selectedElements[t.id]=n:delete this._selectedElements[t.id],r!==a&&(r&&this._fireEvent("selectleave",new bg(i,r,s,t)),a&&this._fireEvent("selectenter",new bg(i,a,s,t))),"selectstart"===e&&((this._selectedPressedElements[t.id]=a)&&this._fireEvent("selectstart",new bg(i,a,s,t)));var h=this._selectedPressedElements[t.id];!t.elementInput&&h&&(delete this._selectedPressedElements[t.id],r&&this._fireEvent("selectend",new bg(i,r,s,t))),"selectend"===e&&t.elementInput&&(delete this._selectedPressedElements[t.id],r&&this._fireEvent("selectend",new bg(i,r,s,t)),h&&h===r&&this._fireEvent("click",new bg(i,h,s,t)))},t._fireEvent=function(e,t){for(var i=t.element;i.fire(e,t),!t._stopPropagation&&i.entity.parent&&(i=i.entity.parent.element););},t._calcMouseCoords=function(e){var t=this._target.getBoundingClientRect(),i=Math.floor(t.left),n=Math.floor(t.top);e.clientX<i||e.clientX>=i+this._target.clientWidth||e.clientY<n||e.clientY>=n+this._target.clientHeight?jv=Hv=null:(Hv=e.clientX-i,jv=e.clientY-n)},t._calcTouchCoords=function(e){for(var t=0,i=0,n=e.target;!(n instanceof HTMLElement);)n=n.parentNode;for(var a=n;t+=a.offsetLeft-a.scrollLeft,i+=a.offsetTop-a.scrollTop,a=a.offsetParent;);return{x:e.pageX-t,y:e.pageY-i}},t._sortElements=function(e,t){var i=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return 0!==i?i:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:e.screen||t.screen?e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder:0},t._getTargetElement=function(e,t,i){var n,a,s=null;this._elements.sort(this._sortHandler);for(var r=0,o=this._elements.length;r<o;r++){var l,h=this._elements[r],c=!1,u=null==h?void 0:h._rectPixels;if((!u||!(t<u.left||t>u.right||i<u.top||i>u.bottom))&&(h.screen&&h.screen.screen.screenSpace?(void 0===n&&(n=Kv,!1===this._calculateRayScreen(t,i,e,n)&&(n=null)),l=n,c=!0):(void 0===a&&(a=Zv,!1===this._calculateRay3d(t,i,e,a)&&(a=null)),l=a),l&&this._checkElement(l,h,c))){s=h;break}}return s},t._getTargetElementByRay=function(e,t){var i=null;Kv.origin.copy(e.origin),Kv.direction.copy(e.direction),Kv.end.copy(Kv.direction).mulScalar(2*t.farClip).add(Kv.origin),this._elements.sort(this._sortHandler);for(var n=0,a=this._elements.length;n<a;n++){var s=this._elements[n];if((!s.screen||!s.screen.screen.screenSpace)&&this._checkElement(Kv,s,!1)){i=s;break}}return i},t._buildHitCorners=function(e,t,i,n){var a=t;if(e.entity&&e.entity.button){var s=e.entity.button.hitPadding||mg;og.copy(e.entity.up),lg.copy(og).mulScalar(-1),cg.copy(e.entity.right),hg.copy(cg).mulScalar(-1),og.mulScalar(s.w*n),lg.mulScalar(s.y*n),cg.mulScalar(s.z*i),hg.mulScalar(s.x*i),ug.copy(a[0]).add(lg).add(hg),dg.copy(a[1]).add(lg).add(cg),pg.copy(a[2]).add(og).add(cg),fg.copy(a[3]).add(og).add(hg),a=[ug,dg,pg,fg]}return a},t._calculateScaleToScreen=function(e){var t=e.entity,i=e.screen.screen.scale;for(rg.set(i,i);t&&!t.screen;)rg.mul(t.getLocalScale()),t=t.parent;return rg},t._calculateRayScreen=function(e,t,i,n){var a=this.app.graphicsDevice.width,s=this.app.graphicsDevice.height,r=i.rect.z*a,o=i.rect.w*s,l=i.rect.x*a,h=l+r,c=(1-i.rect.y)*s,u=c-o,d=e*a/this._target.clientWidth,p=t*s/this._target.clientHeight;return l<=d&&d<=h&&p<=c&&u<=p&&(d=a*(d-l)/r,p=s-(p=s*(p-u)/o),n.origin.set(d,p,1),n.direction.set(0,0,-1),n.end.copy(n.direction).mulScalar(2).add(n.origin),!0)},t._calculateRay3d=function(e,t,i,n){var a=this._target.clientWidth,s=this._target.clientHeight,r=i.rect.z*a,o=i.rect.w*s,l=i.rect.x*a,h=l+r,c=(1-i.rect.y)*s,u=c-o,d=e,p=t;return l<=e&&e<=h&&t<=c&&u<=p&&(d=a*(d-l)/r,p=s*(p-u)/o,i.screenToWorld(d,p,i.nearClip,$v),i.screenToWorld(d,p,i.farClip,Yv),n.origin.copy($v),n.direction.set(0,0,-1),n.end.copy(Yv),!0)},t._checkElement=function(e,t,i){var n;if(t.maskedBy&&!this._checkElement(e,t.maskedBy.element,i))return!1;n=i?this._calculateScaleToScreen(t):t.entity.getWorldTransform().getScale();var a=this._buildHitCorners(t,i?t.screenCorners:t.worldCorners,n.x,n.y);return!!function(e,t,i){if(Jv.sub2(t,e),eg.sub2(i[0],e),tg.sub2(i[1],e),ig.sub2(i[2],e),ag.cross(ig,Jv),0<=eg.dot(ag)){if(-tg.dot(ag)<0)return!1;if(vg(Jv,tg,eg)<0)return!1}else{if(ng.sub2(i[3],e),ng.dot(ag)<0)return!1;if(vg(Jv,eg,ng)<0)return!1}return!(Jv.sub2(i[0],i[2]).lengthSq()<1e-8||Jv.sub2(i[1],i[3]).lengthSq()<1e-8)}(e.origin,e.end,a)},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"app",get:function(){return this._app||hi()},set:function(e){this._app=e}}]),e}(),Mg={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},Sg={"Product: 0268":"PS3"},wg=function(){function e(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads,this.current=[],this.previous=[],this.deadZone=.25}var t=e.prototype;return t.update=function(){var e,t,i,n,a;for(e=0,i=this.current.length;e<i;e++)for(a=(n=this.current[e].pad.buttons).length,t=0;t<a;t++)void 0===this.previous[e]&&(this.previous[e]=[]),this.previous[e][t]=n[t].pressed;this.poll(this.current)},t.poll=function(e){if(void 0===e&&(e=[]),0<e.length&&(e.length=0),this.gamepadsSupported){var t,i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),n=i.length;for(t=0;t<n;t++)i[t]&&e.push({map:this.getMap(i[t]),pad:i[t]})}return e},t.getMap=function(e){for(var t in Sg)if(0<=e.id.indexOf(t))return Mg[Sg[t]];return Mg.DEFAULT},t.isPressed=function(e,t){if(!this.current[e])return!1;var i=this.current[e].map.buttons[t];return this.current[e].pad.buttons[pc[i]].pressed},t.wasPressed=function(e,t){if(!this.current[e])return!1;var i=this.current[e].map.buttons[t],n=pc[i];return this.current[e].pad.buttons[n].pressed&&!(this.previous[e]&&this.previous[e][n])},t.wasReleased=function(e,t){if(!this.current[e])return!1;var i=this.current[e].map.buttons[t],n=pc[i];return!this.current[e].pad.buttons[n].pressed&&this.previous[e]&&this.previous[e][n]},t.getAxis=function(e,t){if(!this.current[e])return 0;var i=this.current[e].map.axes[t],n=this.current[e].pad.axes[pc[i]];return Math.abs(n)<this.deadZone&&(n=0),n},e}(),Cg=function(e){var t=function(e){for(var t=0,i=0,n=e.target;!(n instanceof HTMLElement);)n=n.parentNode;for(var a=n;t+=a.offsetLeft-a.scrollLeft,i+=a.offsetTop-a.scrollTop,a=a.offsetParent;);return{x:e.pageX-t,y:e.pageY-i}}(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e},Pg=function(){function e(e,t){if(this.element=t.target,this.event=t,this.touches=[],this.changedTouches=[],t){var i,n=t.touches.length;for(i=0;i<n;i++)this.touches.push(new Cg(t.touches[i]));for(n=t.changedTouches.length,i=0;i<n;i++)this.changedTouches.push(new Cg(t.changedTouches[i]))}}return e.prototype.getTouchById=function(e,t){var i,n=t.length;for(i=0;i<n;i++)if(t[i].id===e)return t[i];return null},e}(),Tg=function(i){function e(e){var t;return(t=i.call(this)||this)._element=null,t._startHandler=t._handleTouchStart.bind(g(t)),t._endHandler=t._handleTouchEnd.bind(g(t)),t._moveHandler=t._handleTouchMove.bind(g(t)),t._cancelHandler=t._handleTouchCancel.bind(g(t)),t.attach(e),t}u(e,i);var t=e.prototype;return t.attach=function(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)},t.detach=function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null},t._handleTouchStart=function(e){this.fire("touchstart",new Pg(this,e))},t._handleTouchEnd=function(e){this.fire("touchend",new Pg(this,e))},t._handleTouchMove=function(e){e.preventDefault(),this.fire("touchmove",new Pg(this,e))},t._handleTouchCancel=function(e){this.fire("touchcancel",new Pg(this,e))},e}(p);Me.endsWith=function(e,t){return e.endsWith(t)},Me.startsWith=function(e,t){return e.startsWith(t)},Object.defineProperty($.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty($.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),Se.INV_LOG2=Math.LOG2E,Se.intToBytes=Se.intToBytes32,Se.bytesToInt=Se.bytesToInt32,Object.defineProperty(J.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),J.prototype.scale=J.prototype.mulScalar,Object.defineProperty(de.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),de.prototype.scale=de.prototype.mulScalar,Object.defineProperty(ee.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),ee.prototype.scale=ee.prototype.mulScalar,ge.prototype.intersectRay=ge.prototype.intersectsRay,be.prototype.update=function(e,t){var i=new pe;i.mul2(e,t),this.setFromMat4(i)};var Ag={createFullscreenQuad:Wm,drawFullscreenQuad:Hm,PostEffect:Gm,PostEffectQueue:nu};Object.defineProperty(Dt,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+Dt.transformVS}}),Object.defineProperties(Kt.prototype,{rgbm:{get:function(){return this.type===Qe},set:function(e){this.type=e?Qe:Ze}},swizzleGGGR:{get:function(){return this.type===et},set:function(e){this.type=e?et:Ze}}}),Object.defineProperty(wn.prototype,"model",{get:function(){return null}}),ar.prototype.getTarget=function(e){return this.targets[e]},mn.prototype._dirtify=function(e){e?this._dirtifyLocal():this._dirtifyWorld()},mn.prototype.addLabel=function(e){this._labels[e]=!0},mn.prototype.getLabels=function(){return Object.keys(this._labels)},mn.prototype.hasLabel=function(e){return!!this._labels[e]},mn.prototype.removeLabel=function(e){delete this._labels[e]},mn.prototype.findByLabel=function(e,t){var i,n=this._children.length;for(t=t||[],this.hasLabel(e)&&t.push(this),i=0;i<n;++i)t=this._children[i].findByLabel(e,t);return t},mn.prototype.getChildren=function(){return this.children},mn.prototype.getName=function(){return this.name},mn.prototype.getPath=function(){return this.path},mn.prototype.getRoot=function(){return this.root},mn.prototype.getParent=function(){return this.parent},mn.prototype.setName=function(e){this.name=e},Ui.prototype.getName=function(){return this.name},Ui.prototype.setName=function(e){this.name=e},Ui.prototype.getShader=function(){return this.shader},Ui.prototype.setShader=function(e){this.shader=e},xr.prototype.getDuration=function(){return this.duration},xr.prototype.getName=function(){return this.name},xr.prototype.getNodes=function(){return this.nodes},xr.prototype.setDuration=function(e){this.duration=e},xr.prototype.setName=function(e){this.name=e},ic.prototype.getAnimation=function(){return this.animation},ic.prototype.getCurrentTime=function(){return this.currentTime},ic.prototype.getLooping=function(){return this.looping},ic.prototype.getNumNodes=function(){return this.numNodes},ic.prototype.setAnimation=function(e){this.animation=e},ic.prototype.setCurrentTime=function(e){this.currentTime=e},ic.prototype.setLooping=function(e){this.looping=e},_r.prototype.getListener=function(){return this.listener},_r.prototype.getVolume=function(){return this.volume},_r.prototype.setVolume=function(e){this.volume=e},ih.prototype.getAssetById=function(e){return this.get(e)},Object.defineProperty(Dh.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(Dh.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(Dh.prototype,"rotation",{get:function(){return this._localRotation}}),Object.defineProperty(xg.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Object.defineProperty(Xv.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),om.prototype.isFullscreen=function(){return!!document.fullscreenElement},om.prototype.enableFullscreen=function(e,t,i){e=e||this.graphicsDevice.canvas,t&&document.addEventListener("fullscreenchange",function e(){t(),document.removeEventListener("fullscreenchange",e)},!1),i&&document.addEventListener("fullscreenerror",function e(){i(),document.removeEventListener("fullscreenerror",e)},!1),e.requestFullscreen?e.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):i()},om.prototype.disableFullscreen=function(t){t&&document.addEventListener("fullscreenchange",function e(){t(),document.removeEventListener("fullscreenchange",e)},!1),document.exitFullscreen()},om.prototype.getSceneUrl=function(e){var t=this.scenes.find(e);return t?t.url:null},om.prototype.loadScene=function(e,t){this.scenes.loadScene(e,t)},om.prototype.loadSceneHierarchy=function(e,t){this.scenes.loadSceneHierarchy(e,t)},om.prototype.loadSceneSettings=function(e,t){this.scenes.loadSceneSettings(e,t)},Object.defineProperty(su.prototype,"node",{get:function(){return this.entity}}),Object.defineProperty(ep.prototype,"enable",{get:function(){return this.enabled},set:function(e){this.enabled=e}}),sp.prototype.setVisible=function(e){this.enabled=e},Object.defineProperty(sp.prototype,"aabb",{get:function(){return null},set:function(e){}}),Object.defineProperty(hp.prototype,"aabb",{get:function(){return null},set:function(e){}}),Object.defineProperty(Dp.prototype,"bodyType",{get:function(){return this.type},set:function(e){this.type=e}}),Dp.prototype.syncBodyToEntity=function(){this._updateDynamic()},Up.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};var Eg=function(){function e(){}var t=e.prototype;return t.log=function(){var e;(e=console).log.apply(e,arguments)},t.error=function(){var e;(e=console).error.apply(e,arguments)},t.info=function(){var e;(e=console).info.apply(e,arguments)},t.warn=function(){var e;(e=console).warn.apply(e,arguments)},e}(),Rg={AUTHORIZATION_WARNING:"The license is reserved until %s, Currently expired.",EXPIRY_OF_AUTHORIZATION:"The license has expired.",DOMAIN_UNAUTHORIZED:"Domain name not authorized."};function Dg(e,t){if(""===e)return"";if(t&&""!==t||(t=""),t=encodeURIComponent(t),void 0===e||e.length<8)return"";if(void 0===t||t.length<=0)return"";for(var i="",n=0,a=t.length;n<a;n+=1)i+=t.charCodeAt(n).toString();var s=Math.floor(i.length/5),r=parseInt(i.charAt(s)+i.charAt(2*s)+i.charAt(3*s)+i.charAt(4*s)+i.charAt(5*s)),o=Math.round(t.length/2),l=Math.pow(2,31)-1,h=parseInt(e.substring(e.length-8,e.length),16);for(e=e.substring(0,e.length-8),i+=h;10<i.length;)i=(parseInt(i.substring(0,10))+parseInt(i.substring(10,i.length))).toString();i=(r*i+o)%l;for(var c="",u="",d=0;d<e.length;d+=2)c=parseInt(parseInt(e.substring(d,d+2),16)^Math.floor(i/l*255)),u+=String.fromCharCode(c),i=(r*i+o)%l;return decodeURIComponent(u)}function Ig(e,t){for(var i="",n=0;n<e.length;n++)i+=t[parseInt(e[n])];return i}var kg={h:["57fe0d4c3e095589790599440d","30e54ac6d4270ad02f0122fa8e","08b920b17f2f7bce2e78fb94c904f1de65","10f0ed50a49aaed1ca1af8ba03d78c95","4b0bec5dab137c00e6bec586a26d0375a8f6","169f7b865f2f545cf589950501b47f","4e7576f678638ce86b76d2507304c80c80","38001bd00f6af063694d6b0753a2486cf3aa9c69ee1038f0c875474802b07109"],k:"ncJRmHIFvZ",v:"32decc1",a:["2e5f079aa88b01b9ba06"],l:{a:"22fa682d19506ba4258d1c18da33090c97125ad2e204671188",b:"6c19de5a73f117ec02c7e00b",c:"7d479daedac1a91ff7173cb6aebcc914170477e5e50ac064f0248a05e5dd4b593d522c4077d29299d803163812",d:"24e4a539031c8413",e:"232765086b434791a68cf4675d4e5280c570323180c23e05932926",i:"1b4b9104cbcb153db33c18cdfc20ed85e4bbce02c8a628",h:"0de00177a1ac2043054fc570",p:"14e7dbb90724496404b34c54",f:"3bdda5d99b88e101dde480",l:"3105cc45fe81957801b40828",v:"2a7b7a3f83f68201513ca4",m:"6b9131fbc73901ee7c54",r:"2c97769529597778022b2aed",y:"2f79adeaf002025848",t:"516e9c8365116b81a8ae030671b1"},w:0,t:0,d:[[11,14,2,0,19,8,14,13],[7,14,18,19,13,0,12,4],[17,4,0,11,8,1,14,23],[3,4,18,27,28,29]]};function Lg(e){if(e){var t,i=new Eg,n=kg.l,a=Dg(n.c,"r").split(""),s=Ig(kg.d[3],a),r=Dg(n.r,s),o=Dg(n.v,s),l=Dg(n.d,s),h=m[l],c=Number(Dg(n.t,s)),u=Number(Dg(n.b,s)),d=kg.v;(t=m[r]&&m[r]instanceof Object?m[r]:{})&&!t[o]&&(t[o]=d);var p=function(){var e=kg.l,t=Dg(e.c,"r").split(""),i=Ig(kg.d[3],t),n=Dg(e.d,i),a=Dg(e.l,i),s=Dg(e.h,i);Number(Dg(e.t,i)),Number(Dg(e.b,i));var r=Dg(e.p,i),o=Dg(e.f,i),l=m[a],h=m[n],c=l[s];Math.round(new h/1e3);var u=!1;if(l[r]===o)u=!0;else for(var d=0;d<kg.h.length;d++){var p=Dg(kg.h[d],i);("*"===p[0]&&"."===p[1]&&-1!==c.indexOf(p.substr(2))||p===c)&&(u=!0)}return{d:u,t:!0}}();if(p.d){if(p.t)for(var f=0;f<e.length;f++)t[Dg(kg.a[f],s)]=e[f];else i.log(Rg[Dg(n.a,s)],new h(1e3*(c+u)));return t}return i.log(Rg[Dg(n.i,s)]),t}}var Og={version:2,intensity:0,info:{face:"Arial",maps:[{width:1024,height:512}]},chars:{32:{id:32,letter:" ",x:1,y:1,width:64,height:64,map:0,xadvance:8.890625,xoffset:.166666666667,yoffset:.166666666667,scale:48,range:.166666666667},33:{id:33,letter:"!",x:67,y:1,width:64,height:64,map:0,xadvance:8.890625,xoffset:10.7786458333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.75,0,6.234375,22.90625]},34:{id:34,letter:'"',x:133,y:1,width:64,height:64,map:0,xadvance:11.359375,xoffset:-.0703125,yoffset:-13.2578125,scale:5.72067039106,range:1.3984375,bounds:[1.46875,14.796875,9.859375,22.90625]},35:{id:35,letter:"#",x:199,y:1,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.93229166667,yoffset:4.33854166667,scale:2.02638522427,range:3.94791666667,bounds:[.328125,-.390625,17.390625,23.296875]},36:{id:36,letter:"$",x:265,y:1,width:64,height:64,map:0,xadvance:17.796875,xoffset:10.15625,yoffset:8.015625,scale:1.69536423841,range:4.71875,bounds:[1.140625,-3.296875,16.296875,25.015625]},37:{id:37,letter:"%",x:331,y:1,width:64,height:64,map:0,xadvance:28.453125,xoffset:2.24479166667,yoffset:5.19010416667,scale:1.94923857868,range:4.10416666667,bounds:[1.859375,-.84375,26.484375,23.296875]},38:{id:38,letter:"&",x:397,y:1,width:64,height:64,map:0,xadvance:21.34375,xoffset:4.89322916667,yoffset:4.50260416667,scale:2.01442622951,range:3.97135416667,bounds:[1.375,-.53125,20.609375,23.296875]},39:{id:39,letter:"'",x:463,y:1,width:64,height:64,map:0,xadvance:6.109375,xoffset:2.3984375,yoffset:-13.4453125,scale:5.91907514451,range:1.3515625,bounds:[1.40625,14.796875,4.609375,22.90625]},40:{id:40,letter:"(",x:529,y:1,width:64,height:64,map:0,xadvance:10.65625,xoffset:14.3020833333,yoffset:11.7395833333,scale:1.59833506764,range:5.00520833333,bounds:[1.9375,-6.734375,9.5,23.296875]},41:{id:41,letter:")",x:595,y:1,width:64,height:64,map:0,xadvance:10.65625,xoffset:14.3020833333,yoffset:11.7395833333,scale:1.59833506764,range:5.00520833333,bounds:[1.9375,-6.734375,9.5,23.296875]},42:{id:42,letter:"*",x:661,y:1,width:64,height:64,map:0,xadvance:12.453125,xoffset:.721354166667,yoffset:-11.5364583333,scale:4.64750378215,range:1.72135416667,bounds:[1,13.546875,11.328125,23.296875]},43:{id:43,letter:"+",x:727,y:1,width:64,height:64,map:0,xadvance:18.6875,xoffset:.75,yoffset:-1.1796875,scale:3.17027863777,range:2.5234375,bounds:[1.78125,3.703125,16.90625,18.84375]},44:{id:44,letter:",",x:793,y:1,width:64,height:64,map:0,xadvance:8.890625,xoffset:.8046875,yoffset:5.8203125,scale:6.20606060606,range:1.2890625,bounds:[2.65625,-4.53125,6.046875,3.203125]},45:{id:45,letter:"-",x:859,y:1,width:64,height:64,map:0,xadvance:10.65625,xoffset:.424479166667,yoffset:-2.52864583333,scale:5.55515370705,range:1.44010416667,bounds:[1.015625,6.875,9.65625,9.703125]},46:{id:46,letter:".",x:925,y:1,width:64,height:64,map:0,xadvance:8.890625,xoffset:-2.37239583333,yoffset:.533854166667,scale:14.9853658537,range:.533854166667,bounds:[2.90625,0,6.109375,3.203125]},47:{id:47,letter:"/",x:1,y:67,width:64,height:64,map:0,xadvance:8.890625,xoffset:11.3463541667,yoffset:4.33854166667,scale:2.02638522427,range:3.94791666667,bounds:[0,-.390625,8.890625,23.296875]},48:{id:48,letter:"0",x:67,y:67,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.796875,yoffset:4.2890625,scale:2.05210420842,range:3.8984375,bounds:[1.328125,-.390625,16.265625,23]},49:{id:49,letter:"1",x:133,y:67,width:64,height:64,map:0,xadvance:17.796875,xoffset:7.63020833333,yoffset:3.83333333333,scale:2.08695652174,range:3.83333333333,bounds:[3.484375,0,11.921875,23]},50:{id:50,letter:"2",x:199,y:67,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.79552083333,yoffset:3.83333333333,scale:2.08695652174,range:3.83333333333,bounds:[.96625,0,16.109375,23]},51:{id:51,letter:"3",x:265,y:67,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.76041666667,yoffset:4.30729166667,scale:2.05073431242,range:3.90104166667,bounds:[1.34375,-.40625,16.34375,23]},52:{id:52,letter:"4",x:331,y:67,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.94270833333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[.40625,0,16.25,22.90625]},53:{id:53,letter:"5",x:397,y:67,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.40104166667,yoffset:4.22135416667,scale:2.08837525493,range:3.83072916667,bounds:[1.328125,-.390625,16.515625,22.59375]},54:{id:54,letter:"6",x:463,y:67,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.828125,yoffset:4.2890625,scale:2.05210420842,range:3.8984375,bounds:[1.203125,-.390625,16.328125,23]},55:{id:55,letter:"7",x:529,y:67,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.14322916667,yoffset:3.76822916667,scale:2.12301313062,range:3.76822916667,bounds:[1.515625,0,16.34375,22.609375]},56:{id:56,letter:"8",x:595,y:67,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.75,yoffset:4.2890625,scale:2.05210420842,range:3.8984375,bounds:[1.296875,-.390625,16.390625,23]},57:{id:57,letter:"9",x:661,y:67,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.734375,yoffset:4.2890625,scale:2.05210420842,range:3.8984375,bounds:[1.328125,-.390625,16.390625,23]},58:{id:58,letter:":",x:727,y:67,width:64,height:64,map:0,xadvance:8.890625,xoffset:6.5703125,yoffset:2.765625,scale:2.89265536723,range:2.765625,bounds:[2.890625,0,6.09375,16.59375]},59:{id:59,letter:";",x:793,y:67,width:64,height:64,map:0,xadvance:8.890625,xoffset:9.73177083333,yoffset:8.05208333333,scale:2.27218934911,range:3.52083333333,bounds:[2.65625,-4.53125,6.046875,16.59375]},60:{id:60,letter:"<",x:859,y:67,width:64,height:64,map:0,xadvance:18.6875,xoffset:1.0078125,yoffset:-.9453125,scale:3.09365558912,range:2.5859375,bounds:[1.75,3.53125,16.921875,19.046875]},61:{id:61,letter:"=",x:925,y:67,width:64,height:64,map:0,xadvance:18.6875,xoffset:.739583333333,yoffset:-1.22135416667,scale:3.17355371901,range:2.52083333333,bounds:[1.78125,6.515625,16.90625,16.09375]},62:{id:62,letter:">",x:1,y:133,width:64,height:64,map:0,xadvance:18.6875,xoffset:1.0078125,yoffset:-.9453125,scale:3.09365558912,range:2.5859375,bounds:[1.75,3.53125,16.921875,19.046875]},63:{id:63,letter:"?",x:67,y:133,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.734375,yoffset:3.8828125,scale:2.06036217304,range:3.8828125,bounds:[1.40625,0,16.1875,23.296875]},64:{id:64,letter:"@",x:133,y:133,width:64,height:64,map:0,xadvance:32.484375,xoffset:3.51041666667,yoffset:11.7447916667,scale:1.59667359667,range:5.01041666667,bounds:[1.734375,-6.734375,31.328125,23.328125]},65:{id:65,letter:"A",x:199,y:133,width:64,height:64,map:0,xadvance:21.34375,xoffset:4.59895833333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[-.046875,0,21.390625,22.90625]},66:{id:66,letter:"B",x:265,y:133,width:64,height:64,map:0,xadvance:21.34375,xoffset:4.27864583333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.34375,0,19.640625,22.90625]},67:{id:67,letter:"C",x:331,y:133,width:64,height:64,map:0,xadvance:23.109375,xoffset:4.07291666667,yoffset:4.33854166667,scale:2.02638522427,range:3.94791666667,bounds:[1.59375,-.390625,21.84375,23.296875]},68:{id:68,letter:"D",x:397,y:133,width:64,height:64,map:0,xadvance:23.109375,xoffset:3.33333333333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.46875,0,21.40625,22.90625]},69:{id:69,letter:"E",x:463,y:133,width:64,height:64,map:0,xadvance:21.34375,xoffset:4.19270833333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.53125,0,19.625,22.90625]},70:{id:70,letter:"F",x:529,y:133,width:64,height:64,map:0,xadvance:19.546875,xoffset:4.91927083333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.625,0,18.078125,22.90625]},71:{id:71,letter:"G",x:595,y:133,width:64,height:64,map:0,xadvance:24.890625,xoffset:3.49479166667,yoffset:4.33854166667,scale:2.02638522427,range:3.94791666667,bounds:[1.703125,-.390625,22.890625,23.296875]},72:{id:72,letter:"H",x:661,y:133,width:64,height:64,map:0,xadvance:23.109375,xoffset:3.72395833333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.5625,0,20.53125,22.90625]},73:{id:73,letter:"I",x:727,y:133,width:64,height:64,map:0,xadvance:8.890625,xoffset:10.7708333333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.984375,0,6.015625,22.90625]},74:{id:74,letter:"J",x:793,y:133,width:64,height:64,map:0,xadvance:16,xoffset:8.31367924528,yoffset:4.2734375,scale:2.06036217304,range:3.8828125,bounds:[.919516509434,-.390625,13.515625,22.90625]},75:{id:75,letter:"K",x:859,y:133,width:64,height:64,map:0,xadvance:21.34375,xoffset:3.45833333333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.34375,0,21.28125,22.90625]},76:{id:76,letter:"L",x:925,y:133,width:64,height:64,map:0,xadvance:17.796875,xoffset:5.77083333333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.34375,0,16.65625,22.90625]},77:{id:77,letter:"M",x:1,y:199,width:64,height:64,map:0,xadvance:26.65625,xoffset:1.96614583333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.375,0,24.234375,22.90625]},78:{id:78,letter:"N",x:67,y:199,width:64,height:64,map:0,xadvance:23.109375,xoffset:3.80989583333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.4375,0,20.484375,22.90625]},79:{id:79,letter:"O",x:133,y:199,width:64,height:64,map:0,xadvance:24.890625,xoffset:3.30208333333,yoffset:4.34114583333,scale:2.02504943968,range:3.95052083333,bounds:[1.546875,-.390625,23.453125,23.3125]},80:{id:80,letter:"P",x:199,y:199,width:64,height:64,map:0,xadvance:21.34375,xoffset:4.05989583333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.46875,0,19.953125,22.90625]},81:{id:81,letter:"Q",x:265,y:199,width:64,height:64,map:0,xadvance:24.890625,xoffset:4.18229166667,yoffset:5.96354166667,scale:1.91282689913,range:4.18229166667,bounds:[1.375,-1.78125,23.71875,23.3125]},82:{id:82,letter:"R",x:331,y:199,width:64,height:64,map:0,xadvance:23.109375,xoffset:2.66145833333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.515625,0,22.703125,22.90625]},83:{id:83,letter:"S",x:397,y:199,width:64,height:64,map:0,xadvance:21.34375,xoffset:5.23697916667,yoffset:4.33854166667,scale:2.02638522427,range:3.94791666667,bounds:[1.4375,-.390625,19.671875,23.296875]},84:{id:84,letter:"T",x:463,y:199,width:64,height:64,map:0,xadvance:19.546875,xoffset:5.44270833333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[.75,0,18.90625,22.90625]},85:{id:85,letter:"U",x:529,y:199,width:64,height:64,map:0,xadvance:23.109375,xoffset:4.0078125,yoffset:4.2734375,scale:2.06036217304,range:3.8828125,bounds:[2.515625,-.390625,20.53125,22.90625]},86:{id:86,letter:"V",x:595,y:199,width:64,height:64,map:0,xadvance:21.34375,xoffset:4.65364583333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[.140625,0,21.09375,22.90625]},87:{id:87,letter:"W",x:661,y:199,width:64,height:64,map:0,xadvance:30.203125,xoffset:4.51822916667,yoffset:8.18229166667,scale:1.62970822281,range:4.90885416667,bounds:[.390625,0,29.84375,22.90625]},88:{id:88,letter:"X",x:727,y:199,width:64,height:64,map:0,xadvance:21.34375,xoffset:4.63020833333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[.140625,0,21.140625,22.90625]},89:{id:89,letter:"Y",x:793,y:199,width:64,height:64,map:0,xadvance:21.34375,xoffset:4.67708333333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[.09375,0,21.09375,22.90625]},90:{id:90,letter:"Z",x:859,y:199,width:64,height:64,map:0,xadvance:19.546875,xoffset:5.57552083333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[.640625,0,18.75,22.90625]},91:{id:91,letter:"[",x:925,y:199,width:64,height:64,map:0,xadvance:8.890625,xoffset:14.2369791667,yoffset:11.2369791667,scale:1.64014949279,range:4.87760416667,bounds:[2.171875,-6.359375,8.375,22.90625]},92:{id:92,letter:"\\",x:1,y:265,width:64,height:64,map:0,xadvance:8.890625,xoffset:11.3463541667,yoffset:4.33854166667,scale:2.02638522427,range:3.94791666667,bounds:[0,-.390625,8.890625,23.296875]},93:{id:93,letter:"]",x:67,y:265,width:64,height:64,map:0,xadvance:8.890625,xoffset:15.7994791667,yoffset:11.2369791667,scale:1.64014949279,range:4.87760416667,bounds:[.609375,-6.359375,6.8125,22.90625]},94:{id:94,letter:"^",x:133,y:265,width:64,height:64,map:0,xadvance:15.015625,xoffset:1.37760416667,yoffset:-8.15364583333,scale:3.60140679953,range:2.22135416667,bounds:[.84375,10.78125,14.171875,23.296875]},95:{id:95,letter:"_",x:199,y:265,width:64,height:64,map:0,xadvance:17.796875,xoffset:3.59114583333,yoffset:17.7708333333,scale:2.57502095557,range:3.10677083333,bounds:[-.484375,-6.359375,18.15625,-4.328125]},96:{id:96,letter:"`",x:265,y:265,width:64,height:64,map:0,xadvance:10.65625,xoffset:-.411458333333,yoffset:-16.9270833333,scale:8.17021276596,range:.979166666667,bounds:[1.390625,18.65625,7.265625,23.03125]},97:{id:97,letter:"a",x:331,y:265,width:64,height:64,map:0,xadvance:17.796875,xoffset:2.765625,yoffset:3.265625,scale:2.76756756757,range:2.890625,bounds:[1.15625,-.375,16.4375,16.96875]},98:{id:98,letter:"b",x:397,y:265,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.23177083333,yoffset:4.25520833333,scale:2.06174496644,range:3.88020833333,bounds:[2.09375,-.375,16.484375,22.90625]},99:{id:99,letter:"c",x:463,y:265,width:64,height:64,map:0,xadvance:16,xoffset:3.0859375,yoffset:3.265625,scale:2.76756756757,range:2.890625,bounds:[1.25,-.375,15.703125,16.96875]},100:{id:100,letter:"d",x:529,y:265,width:64,height:64,map:0,xadvance:17.796875,xoffset:7.23177083333,yoffset:4.25520833333,scale:2.06174496644,range:3.88020833333,bounds:[1.09375,-.375,15.484375,22.90625]},101:{id:101,letter:"e",x:595,y:265,width:64,height:64,map:0,xadvance:17.796875,xoffset:2.7421875,yoffset:3.265625,scale:2.76756756757,range:2.890625,bounds:[1.171875,-.375,16.46875,16.96875]},102:{id:102,letter:"f",x:661,y:265,width:64,height:64,map:0,xadvance:8.890625,xoffset:10.3828125,yoffset:3.8828125,scale:2.06036217304,range:3.8828125,bounds:[.296875,0,10,23.296875]},103:{id:103,letter:"g",x:727,y:265,width:64,height:64,map:0,xadvance:17.796875,xoffset:7.45833333333,yoffset:10.6848958333,scale:2.02504943968,range:3.95052083333,bounds:[1.03125,-6.734375,15.65625,16.96875]},104:{id:104,letter:"h",x:793,y:265,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.40364583333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.109375,0,15.625,22.90625]},105:{id:105,letter:"i",x:859,y:265,width:64,height:64,map:0,xadvance:7.109375,xoffset:11.7395833333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.125,0,4.9375,22.90625]},106:{id:106,letter:"j",x:925,y:265,width:64,height:64,map:0,xadvance:7.109375,xoffset:18.0416666667,yoffset:11.6744791667,scale:1.61939905113,range:4.94010416667,bounds:[-1.46875,-6.734375,4.90625,22.90625]},107:{id:107,letter:"k",x:1,y:331,width:64,height:64,map:0,xadvance:16,xoffset:6.27083333333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.125,0,15.875,22.90625]},108:{id:108,letter:"l",x:67,y:331,width:64,height:64,map:0,xadvance:7.109375,xoffset:11.8177083333,yoffset:3.81770833333,scale:2.09549795362,range:3.81770833333,bounds:[2.046875,0,4.859375,22.90625]},109:{id:109,letter:"m",x:133,y:331,width:64,height:64,map:0,xadvance:26.65625,xoffset:1.63802083333,yoffset:6.50520833333,scale:2.13481584434,range:3.74739583333,bounds:[2.109375,0,24.59375,16.96875]},110:{id:110,letter:"n",x:199,y:331,width:64,height:64,map:0,xadvance:17.796875,xoffset:2.4609375,yoffset:2.828125,scale:2.82872928177,range:2.828125,bounds:[2.109375,0,15.59375,16.96875]},111:{id:111,letter:"o",x:265,y:331,width:64,height:64,map:0,xadvance:17.796875,xoffset:2.7265625,yoffset:3.265625,scale:2.76756756757,range:2.890625,bounds:[1.0625,-.375,16.609375,16.96875]},112:{id:112,letter:"p",x:331,y:331,width:64,height:64,map:0,xadvance:17.796875,xoffset:6.23958333333,yoffset:10.2473958333,scale:2.05760214334,range:3.88802083333,bounds:[2.109375,-6.359375,16.515625,16.96875]},113:{id:113,letter:"q",x:397,y:331,width:64,height:64,map:0,xadvance:17.796875,xoffset:7.23958333333,yoffset:10.2473958333,scale:2.05760214334,range:3.88802083333,bounds:[1.125,-6.359375,15.5,16.96875]},114:{id:114,letter:"r",x:463,y:331,width:64,height:64,map:0,xadvance:10.65625,xoffset:4.7265625,yoffset:2.828125,scale:2.82872928177,range:2.828125,bounds:[2.078125,0,11.09375,16.96875]},115:{id:115,letter:"s",x:529,y:331,width:64,height:64,map:0,xadvance:16,xoffset:3.6875,yoffset:3.265625,scale:2.76756756757,range:2.890625,bounds:[.984375,-.375,14.765625,16.96875]},116:{id:116,letter:"t",x:595,y:331,width:64,height:64,map:0,xadvance:8.890625,xoffset:10.4635416667,yoffset:3.98697916667,scale:2.12301313062,range:3.76822916667,bounds:[.5625,-.21875,8.65625,22.390625]},117:{id:117,letter:"u",x:661,y:331,width:64,height:64,map:0,xadvance:17.796875,xoffset:2.5390625,yoffset:3.203125,scale:2.82872928177,range:2.828125,bounds:[2.046875,-.375,15.5,16.59375]},118:{id:118,letter:"v",x:727,y:331,width:64,height:64,map:0,xadvance:16,xoffset:3.046875,yoffset:2.765625,scale:2.89265536723,range:2.765625,bounds:[.40625,0,15.625,16.59375]},119:{id:119,letter:"w",x:793,y:331,width:64,height:64,map:0,xadvance:23.109375,xoffset:3.70052083333,yoffset:6.88020833333,scale:2.10844200412,range:3.79427083333,bounds:[.09375,0,22.859375,16.59375]},120:{id:120,letter:"x",x:859,y:331,width:64,height:64,map:0,xadvance:16,xoffset:3.0625,yoffset:2.765625,scale:2.89265536723,range:2.765625,bounds:[.234375,0,15.765625,16.59375]},121:{id:121,letter:"y",x:925,y:331,width:64,height:64,map:0,xadvance:16,xoffset:7.43489583333,yoffset:10.6223958333,scale:2.05760214334,range:3.88802083333,bounds:[.515625,-6.734375,15.71875,16.59375]},122:{id:122,letter:"z",x:1,y:397,width:64,height:64,map:0,xadvance:16,xoffset:3.09375,yoffset:2.765625,scale:2.89265536723,range:2.765625,bounds:[.625,0,15.3125,16.59375]},123:{id:123,letter:"{",x:67,y:397,width:64,height:64,map:0,xadvance:10.6875,xoffset:14.6067708333,yoffset:11.7395833333,scale:1.59833506764,range:5.00520833333,bounds:[.890625,-6.734375,9.9375,23.296875]},124:{id:124,letter:"|",x:133,y:397,width:64,height:64,map:0,xadvance:8.3125,xoffset:15.8567708333,yoffset:11.7395833333,scale:1.59833506764,range:5.00520833333,bounds:[2.9375,-6.734375,5.390625,23.296875]},125:{id:125,letter:"}",x:199,y:397,width:64,height:64,map:0,xadvance:10.6875,xoffset:14.7630208333,yoffset:11.7395833333,scale:1.59833506764,range:5.00520833333,bounds:[.734375,-6.734375,9.78125,23.296875]},126:{id:126,letter:"~",x:265,y:397,width:64,height:64,map:0,xadvance:18.6875,xoffset:1.3046875,yoffset:-.609375,scale:3.00293255132,range:2.6640625,bounds:[1.359375,8.703125,17.34375,13.828125]}}},Fg=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterRadius","initialVelocity","wrap","wrapBounds","localSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animNumFrames","animSpeed","animLoop","layers"],zg={mesh:"asset",colorMap:"asset",normalMap:"asset",emitterExtents:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},Bg=Object.keys(Wi).concat(["useMatCap"]),Vg=Hi,Ug=ji,Ng=["prefilteredCubeMap128","prefilteredCubeMap64","prefilteredCubeMap32","prefilteredCubeMap16","prefilteredCubeMap8","prefilteredCubeMap4"],Gg=Bg.map(function(e){if("vec2"===Wi[e])return e}).filter(function(e){return!!e}),Wg=Bg.map(function(e){if("vec3"===Wi[e])return e}).filter(function(e){return!!e}),Hg=Bg.map(function(e){var t;if(0===(null==(t=Wi[e])?void 0:t.indexOf("enum:")))return e}).filter(function(e){return!!e}),jg=Bg.map(function(e){if("rgb"===Wi[e])return e}),Xg=Bg.map(function(e){if("number"===Wi[e])return e}),qg=["blendType","alphaToCoverage","alphaTest","opacity","opacityMap","opacityMapChannel","opacityMapOffset","opacityMapTiling","opacityMapUv","opacityMapVertexColor"],$g=["cubeMapProjectionBox"],Yg=jg.concat(Gg),Kg=Vg.reduce(function(e,t){return e[t]=!0,e},{}),Zg=Ug.reduce(function(e,t){return e[t]=!0,e},{}),Qg=Ng.reduce(function(e,t){return e[t]=!0,e},{});$g.reduce(function(e,t){return e[t]=!0,e},{}),Yg.reduce(function(e,t){return e[t]=!0,e},{}),Xg.reduce(function(e,t){return e[t]=!0,e},{});var Jg={model:"model",light:"light",particle:"particlesystem",picker:"element",annotation:"element"},e_="editor",t_=["right","left","top","bottom","front","back"],i_={UV0:0,UV1:1,Box:2,Sphere:3,Cylinder:4,Planar:5,Camera:6},n_="rbsData",a_=function(e,t){"string"==typeof(t=t||["r","b","s"])&&(t=t.split(""));var i=t.map(function(e){return e.charCodeAt(0)}),n=i.length,a=new Uint8Array(e),s=a.length;[0,1,2].forEach(function(e){var t=a[e],i=Math.floor(s/2+e);a[e]=a[i],a[i]=t});for(var r=Math.floor(s/n),o=0;o<r;o++){var l=o-n*Math.floor(o/n);a[o*n]=a[o*n]^i[l]}var h={};try{h=JSON.parse(function(e){for(var t,i=e.length,n=0,a="";n<i;)t=Array.prototype.slice.call(e,n,n+32768),a+=String.fromCharCode.apply(null,t),n+=32768;return a}(a))}catch(e){h=null}return h},s_=function(e,t){return e&&-1===e.indexOf("data:")&&-1===e.indexOf("blob:")&&(0===e.indexOf("http://")&&(e=e.substring(5)),0===e.indexOf("https://")&&(e=e.substring(6)),-1!==e.indexOf("//")&&0===e.indexOf("//")||rm&&!rm.assets.prefix&&(e="//"+e),/(\?|\&)xhr/.test(e)||(e=e+(-1!==e.indexOf("?")?"&":"?")+"xhr"),q.protocol&&(e=""+q.protocol+e)),e},r_=function e(){var i=0,n=document.createElement("div");function t(e){return n.appendChild(e.dom),e}function a(e){for(var t=0;t<n.children.length;t++)n.children[t].style.display=t===e?"block":"none";i=e}n.style.cssText="position:absolute;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",n.addEventListener("click",function(e){e.preventDefault(),a(++i%n.children.length)},!1);var s,r=(performance||Date).now(),o=r,l=0,h=t(new e.Panel("FPS","#0ff","#002")),c=t(new e.Panel("MS","#0f0","#020"));return self.performance&&self.performance.memory&&(s=t(new e.Panel("MB","#f08","#201"))),a(0),{REVISION:16,dom:n,addPanel:t,showPanel:a,showAllPanel:function(){for(var e=0;e<n.children.length;e++)n.children[e].style.display="block"},hideAllPanel:function(){for(var e=0;e<n.children.length;e++)n.children[e].style.display="none"},begin:function(){r=(performance||Date).now()},end:function(){l++;var e=(performance||Date).now();if(c.update(e-r,200),o+1e3<=e&&(h.update(1e3*l/(e-o),100),o=e,l=0,s)){var t=performance.memory;s.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e},update:function(){r=this.end()},domElement:n,setMode:a}};r_.Panel=function(i,n,a){var s=1/0,r=0,o=Math.round,l=o(window.devicePixelRatio||1),h=80*l,e=48*l,c=3*l,u=2*l,d=3*l,p=15*l,f=74*l,m=30*l,v=document.createElement("canvas");v.width=h,v.height=e,v.style.cssText="width:80px;height:48px";var g=v.getContext("2d");return g.font="bold "+9*l+"px Helvetica,Arial,sans-serif",g.textBaseline="top",g.fillStyle=a,g.fillRect(0,0,h,e),g.fillStyle=n,g.fillText(i,c,u),g.fillRect(d,p,f,m),g.fillStyle=a,g.globalAlpha=.9,g.fillRect(d,p,f,m),{dom:v,update:function(e,t){s=Math.min(s,e),r=Math.max(r,e),g.fillStyle=a,g.globalAlpha=1,g.fillRect(0,0,h,p),g.fillStyle=n,g.fillText(o(e)+" "+i+" ("+o(s)+"-"+o(r)+")",c,u),g.drawImage(v,d+l,p,f-l,m,d,p,f-l,m),g.fillRect(d+f-l,p,l,m),g.fillStyle=a,g.globalAlpha=.9,g.fillRect(d+f-l,p,l,o((1-e/t)*m))}}};var o_={},l_=function(n){return new Promise(function(e,t){var i=document.createElement("script");i.type="text/javascript",i.src=n,i.onload=function(){e()},i.onerror=function(){t()},document.body.appendChild(i)})},h_=function(){return new Promise(function(e,t){"DracoDecoderModule"in window?(o_.onModuleLoaded=function(){e()},window.DracoDecoderModule=window.DracoDecoderModule(o_)):t()})},c_=function(e){return e.scene_uid&&(e.uuid=e.scene_uid),e},u_=new de,d_=new de,p_=new de,f_=new de,m_=Object.keys(Wi),v_={prefilteredCubeMap128:"texture",prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"},g_={cubeMapProjectionBox:"boundingbox",chunks:"chunks"};var __=mi(function(e){var t=function(r){var l,e=Object.prototype,c=e.hasOwnProperty,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.asyncIterator||"@@asyncIterator",n=t.toStringTag||"@@toStringTag";function s(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(r){s=function(e,t,i){return e[t]=i}}function o(e,t,i,n){var s,r,o,l,a=t&&t.prototype instanceof g?t:g,h=Object.create(a.prototype),c=new A(n||[]);return h._invoke=(s=e,r=i,o=c,l=d,function(e,t){if(l===f)throw new Error("Generator is already running");if(l===m){if("throw"===e)throw t;return R()}for(o.method=e,o.arg=t;;){var i=o.delegate;if(i){var n=C(i,o);if(n){if(n===v)continue;return n}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(l===d)throw l=m,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);l=f;var a=u(s,r,o);if("normal"===a.type){if(l=o.done?m:p,a.arg===v)continue;return{value:a.arg,done:o.done}}"throw"===a.type&&(l=m,o.method="throw",o.arg=a.arg)}}),h}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}r.wrap=o;var d="suspendedStart",p="suspendedYield",f="executing",m="completed",v={};function g(){}function h(){}function _(){}var y={};s(y,a,function(){return this});var b=Object.getPrototypeOf,x=b&&b(b(E([])));x&&x!==e&&c.call(x,a)&&(y=x);var M=_.prototype=g.prototype=Object.create(y);function S(e){["next","throw","return"].forEach(function(t){s(e,t,function(e){return this._invoke(t,e)})})}function w(l,h){var t;this._invoke=function(i,n){function e(){return new h(function(e,t){!function t(e,i,n,a){var s=u(l[e],l,i);if("throw"!==s.type){var r=s.arg,o=r.value;return o&&"object"==(void 0===o?"undefined":dx(o))&&c.call(o,"__await")?h.resolve(o.__await).then(function(e){t("next",e,n,a)},function(e){t("throw",e,n,a)}):h.resolve(o).then(function(e){r.value=e,n(r)},function(e){return t("throw",e,n,a)})}a(s.arg)}(i,n,e,t)})}return t=t?t.then(e,e):e()}}function C(e,t){var i=e.iterator[t.method];if(i===l){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=l,C(e,t),"throw"===t.method))return v;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return v}var n=u(i,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,v;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=l),t.delegate=null,v):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,v)}function P(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(P,this),this.reset(!0)}function E(t){if(t){var e=t[a];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,n=function e(){for(;++i<t.length;)if(c.call(t,i))return e.value=t[i],e.done=!1,e;return e.value=l,e.done=!0,e};return n.next=n}}return{next:R}}function R(){return{value:l,done:!0}}return s(M,"constructor",h.prototype=_),s(_,"constructor",h),h.displayName=s(_,n,"GeneratorFunction"),r.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},r.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,s(e,n,"GeneratorFunction")),e.prototype=Object.create(M),e},r.awrap=function(e){return{__await:e}},S(w.prototype),s(w.prototype,i,function(){return this}),r.AsyncIterator=w,r.async=function(e,t,i,n,a){void 0===a&&(a=Promise);var s=new w(o(e,t,i,n),a);return r.isGeneratorFunction(t)?s:s.next().then(function(e){return e.done?e.value:s.next()})},S(M),s(M,n,"Generator"),s(M,a,function(){return this}),s(M,"toString",function(){return"[object Generator]"}),r.keys=function(i){var n=[];for(var e in i)n.push(e);return n.reverse(),function e(){for(;n.length;){var t=n.pop();if(t in i)return e.value=t,e.done=!1,e}return e.done=!0,e}},r.values=E,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=l,this.done=!1,this.delegate=null,this.method="next",this.arg=l,this.tryEntries.forEach(T),!e)for(var t in this)"t"===t.charAt(0)&&c.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=l)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(i){if(this.done)throw i;var n=this;function e(e,t){return s.type="throw",s.arg=i,n.next=e,t&&(n.method="next",n.arg=l),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var a=this.tryEntries[t],s=a.completion;if("root"===a.tryLoc)return e("end");if(a.tryLoc<=this.prev){var r=c.call(a,"catchLoc"),o=c.call(a,"finallyLoc");if(r&&o){if(this.prev<a.catchLoc)return e(a.catchLoc,!0);if(this.prev<a.finallyLoc)return e(a.finallyLoc)}else if(r){if(this.prev<a.catchLoc)return e(a.catchLoc,!0)}else{if(!o)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return e(a.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;0<=i;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&c.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var a=n;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,v):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),v},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),T(i),v}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var n=i.completion;if("throw"===n.type){var a=n.arg;T(i)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:E(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=l),v}},r}(e.exports);try{regeneratorRuntime=t}catch(e){"object"==("undefined"==typeof globalThis?"undefined":dx(globalThis))?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}}),y_=null,b_=function(){function e(){this.id=1e9,this.composition=new pi,this.layerIndex={},this.nameIndex={},this.layerIndexBefore={},this.layerIndexAfter={},this.layers={0:{name:"World",clearColorBuffer:!1,opaqueSortMode:2,transparentSortMode:3,onPreRender:function(){var e;null==rm||null==(e=rm.backgroundRenderer)||e.render()}},1001:{name:"Independent",opaqueSortMode:2,transparentSortMode:3},1:{name:"Depth",opaqueSortMode:2,transparentSortMode:3},2:{name:"Skybox",opaqueSortMode:0,transparentSortMode:3},3:{name:"Immediate",opaqueSortMode:0,transparentSortMode:3},4:{name:"UI",opaqueSortMode:1,transparentSortMode:1},1e3:{name:"Transparent",opaqueSortMode:2,transparentSortMode:1}},this.layerOrder=[{layer:0,transparent:!1,enabled:!0},{layer:1,transparent:!1,enabled:!0},{layer:1e3,transparent:!1,enabled:!0},{layer:1001,transparent:!1,enabled:!0},{layer:2,transparent:!1,enabled:!0},{layer:0,transparent:!0,enabled:!0},{layer:3,transparent:!1,enabled:!0},{layer:1e3,transparent:!0,enabled:!0},{layer:1001,transparent:!0,enabled:!0},{layer:3,transparent:!0,enabled:!0},{layer:4,transparent:!0,enabled:!0}],this.independent=!1,(y_=this).currentCamera=rm.call("edk:render:camera:get"),this.preInitialize(),this.preInitializeEvents(),this.currentCamera?this.setCamera():rm.once("edk:render:camera:change",this.setCamera,this)}var t=e.prototype;return t.preInitialize=function(){this.initLayerComposition(),this.independentLayer=this.nameIndex.Independent,this.register("Viewport Grid",!0),rm.mode===e_&&this.initEditorLayers(),this.addToComposition()},t.preInitializeEvents=function(){rm.method("edk:layer:get",this.getLayer,this),rm.method("edk:layer:independent:update",this.independentUpdate,this)},t.getLayer=function(e){return this.nameIndex[e]},t.initLayerComposition=function(){for(var e in this.layers)this.layerIndex[e]=this.initCreateSystemLayer(e,this.layers[e]),this.nameIndex[this.layers[e].name]=this.layerIndex[e];for(var t=0,i=this.layerOrder.length;t<i;t++){var n=this.layerOrder[t],a=this.layerIndex[n.layer];a&&(n.transparent?this.composition.pushTransparent(a):this.composition.pushOpaque(a),this.composition.subLayerEnabled[t]=n.enabled)}rm.scene.layers=this.composition},t.initCreateSystemLayer=function(e,t){return e=parseInt(e,10),new _a(h({},t,{id:e,enabled:1!==e,name:t.name,opaqueSortMode:t.opaqueSortMode,transparentSortMode:t.transparentSortMode}))},t.initEditorLayers=function(){this.register("Bright Gizmo",!0),this.register("Bright Collision"),this.register("Dim Gizmo",!1,{overrideClear:!0,clearDepthBuffer:!0,onPreRender:function(){}}),this.register("Viewport Outline",!1,{passThrough:!0,isPostEffect:!0}),this.register("Axis Gizmo Immediate",!1,{passThrough:!0,overrideClear:!0,clearDepthBuffer:!0,opaqueSortMode:0,transparentSortMode:0}),this.register("Axis Rotate Gizmo Immediate",!1,{passThrough:!0,overrideClear:!0,clearDepthBuffer:!0,opaqueSortMode:0,transparentSortMode:0}),this.register("Axis Gizmo",!1,{}),this.register("Camera Preview",!1,{passThrough:!0,isPostEffect:!0}),this.register("UVMapping",!1,{})},t.register=function(e,t,i){this.nameIndex[e],i||(i={}),i.id=this.id++,i.enabled=!0,i.name="Editor Layer "+e,void 0===i.opaqueSortMode&&(i.opaqueSortMode=0),void 0===i.transparentSortMode&&(i.transparentSortMode=3);var n=t?this.layerIndexBefore:this.layerIndexAfter,a=Object.keys(n);return a.length&&n[a[a.length-1]],n[i.id]=new _a(i),this.nameIndex[e]=n[i.id],n[i.id]},t.removeFromComposition=function(e){if(!e){if(!rm)return;e=rm.scene.layers}for(var t in this.layerIndexBefore)e.remove(this.layerIndexBefore[t]);for(var i in this.layerIndexAfter)e.remove(this.layerIndexAfter[i])},t.addToComposition=function(e){if(!e){if(!rm)return;e=rm.scene.layers}var t=0;for(var i in this.layerIndexBefore)e.insert(this.layerIndexBefore[i],t++);for(var n in this.layerIndexAfter)e.push(this.layerIndexAfter[n])},t.setCamera=function(e){if(this.currentCamera||(this.currentCamera=e),this.currentCamera){for(var t=this.layerList,i=0;i<t.length;i++){var n=t[i];-1===this.currentCamera.entity.camera.layers.indexOf(n.id)&&this.currentCamera.entity.camera.layers.push(n.id)}this.currentCamera.entity.camera.layers=this.currentCamera.entity.camera.layers}},t.independentUpdate=function(e){if(this.independent=e,this.currentCamera){for(var t=this.layerList,i=[],n=0;n<t.length;n++){var a=t[n];this.independent?0!==a.id&&1e3!==a.id&&i.push(a.id):i.push(a.id)}this.currentCamera.entity.camera.layers=i}},t.destroy=function(){this.id=1e9,this.layers={},this.layerOrder=[],this.layerIndex={},this.layerIndexBefore={},this.layerIndexAfter={},this.nameIndex={},this.composition=null,this.currentCamera=null,y_=null},c(e,[{key:"layerList",get:function(){var e=[];for(var t in this.nameIndex)e.push(this.nameIndex[t]);return e}}]),e}(),x_=function(){function e(e,t){this.type="base",this.scene=null,this.uuid="",this.parent_uuid="",this.entity=new Cr,this.deleted=!1,this.data={},this.extensions={},this.scene=t,this.app=rm.call("edk:app"),this.parent_uuid=e&&e.parent_uuid,this.entity.type=e.type||this.type,this.entity.name=e&&e.name,this.order=e&&e.order,this.entity.on("enable",this.onEnabled,this),this.entity.on("disable",this.onDisable,this),this.entity.once("destroy",this.onDestroy,this),this.entity.enabled=!e||void 0===e.enabled||e.enabled,this.entity.sceneGuid=this.scene.uuid,e&&e.uuid?this.uuid=e.uuid:this.uuid=this.entity.getGuid(),this.entity.localGuid=this.uuid,this.entity.setGuid(this.space_uuid),this.scene.entities.entityIndex[this.uuid]||(this.scene.entities.entityIndex[this.uuid]=this),Xy.entityIndex[this.space_uuid]||(Xy.entityIndex[this.space_uuid]=this),this.entity.addComponent("script"),this.entity.script.on("initialize",this.onScriptInitialize,this),this.entity.script.create("entityAabb"),this._init=!1,e.data&&(this.data=e.data),e.extensions&&(this.extensions=e.extensions),this.seleted=!1,this.startPosition=new de,this.currPosition=new de,this.transPosition=new de,this.startRotation=new fe,this.currRotation=new fe,this.transRotation=new fe,this.startScale=new de,this.currScale=new de,this.transScale=new de,this.transparentLayer=rm.call("edk:layer:get","Transparent"),this.independentLayer=rm.call("edk:layer:get","Independent"),this.initEventListener()}var t=e.prototype;return t.onScriptInitialize=function(){},t.initEventListener=function(){rm.on("edk:script:gizmo:translate:start",this.onTranslateStart,this),rm.on("edk:script:gizmo:translate:set",this.onTranslate,this),rm.on("edk:script:gizmo:translate:end",this.onTranslateEnd,this),rm.on("edk:script:gizmo:rotate:start",this.onRotateStart,this),rm.on("edk:script:gizmo:rotate:set",this.onRotate,this),rm.on("edk:script:gizmo:rotate:end",this.onRotateEnd,this),rm.on("edk:script:gizmo:scale:end",this.onScaleEnd,this),rm.on("edk:script:gizmo:scale:set",this.onScale,this),rm.on("edk:script:gizmo:scale:start",this.onScaleStart,this)},t.removeEventListener=function(){rm.off("edk:script:gizmo:translate:start",this.onTranslateStart,this),rm.off("edk:script:gizmo:translate:set",this.onTranslate,this),rm.off("edk:script:gizmo:translate:end",this.onTranslateEnd,this),rm.off("edk:script:gizmo:rotate:start",this.onRotateStart,this),rm.off("edk:script:gizmo:rotate:set",this.onRotate,this),rm.off("edk:script:gizmo:rotate:end",this.onRotateEnd,this),rm.off("edk:script:gizmo:scale:end",this.onScaleEnd,this),rm.off("edk:script:gizmo:scale:set",this.onScale,this),rm.off("edk:script:gizmo:scale:start",this.onScaleStart,this)},t.get=function(){return this},t.remove=function(){this.deleted=!0,this.seleted=!1,this.entity.enabled=!1,this.removeEventListener(),rm.call("edk:selector:remove","entity",this.uuid)},t.recovery=function(){this.deleted=!1,this.entity.enabled=!0,this.initEventListener()},t.onEnabled=function(){},t.onDisable=function(){this.seleted},t.onTranslateStart=function(){this.seleted&&this.startPosition.copy(this.entity.getPosition())},t.onTranslate=function(e){var t;this.seleted&&((t=this.transPosition).set.apply(t,e),this.currPosition.add2(this.startPosition,this.transPosition),this.entity.setPosition(this.currPosition),rm.fire("edk:scene:entity:update:data:change",this.scene.uuid,this.uuid,"position",[this.entity.localPosition.x,this.entity.localPosition.y,this.entity.localPosition.z]))},t.onTranslateEnd=function(){this.seleted&&rm.fire("edk:scene:entity:update:data:complete",this.scene.uuid,this.uuid,"position",[this.entity.localPosition.x,this.entity.localPosition.y,this.entity.localPosition.z])},t.onRotateStart=function(){this.seleted&&this.startRotation.copy(this.entity.getRotation())},t.onRotate=function(e){if(this.seleted){var t;(t=this.transRotation).set.apply(t,e),this.currRotation.copy(this.transRotation).mul(this.startRotation),this.entity.setRotation(this.currRotation);var i=this.entity.getLocalEulerAngles();rm.fire("edk:scene:entity:update:data:change",this.scene.uuid,this.uuid,{rotation:[i.x,i.y,i.z],position:[this.entity.localPosition.x,this.entity.localPosition.y,this.entity.localPosition.z]})}},t.onRotateEnd=function(){if(this.seleted){var e=this.entity.getLocalEulerAngles();rm.fire("edk:scene:entity:update:data:complete",this.scene.uuid,this.uuid,{rotation:[e.x,e.y,e.z],position:[this.entity.localPosition.x,this.entity.localPosition.y,this.entity.localPosition.z]})}},t.onScaleStart=function(){this.seleted&&this.startScale.copy(this.entity.getLocalScale())},t.onScale=function(e){var t;this.seleted&&((t=this.transScale).set.apply(t,e),this.currScale.add2(this.startScale,this.transScale),this.entity.setLocalScale(this.currScale),rm.fire("edk:scene:entity:update:data:change",this.scene.uuid,this.uuid,"scale",[this.currScale.x,this.currScale.y,this.currScale.z]))},t.onScaleEnd=function(){this.seleted&&rm.fire("edk:scene:entity:update:data:complete",this.scene.uuid,this.uuid,"scale",[this.currScale.x,this.currScale.y,this.currScale.z])},t.onSelectAdd=function(){this.seleted=!0,this.onCheckIndependentLayer(this.entity,this.seleted)},t.onSelectRemove=function(){this.seleted=!1,this.onCheckIndependentLayer(this.entity,this.seleted)},t.onCheckIndependentLayer=function(e,t,i){var n=this;if(void 0===i&&(i=!1),"group"===e.type)e.independent=t,e.children.forEach(function(e){n.onCheckIndependentLayer(e,t,!0)});else{var a=e.getGuid(),s=Xy.entityIndex[a];if(s){var r=Jg[s.type],o=s.pickerEntity?s.pickerEntity:s.entity;if(r&&o[r]&&"light"!==r){var l=Array.from(o[r].layers),h=l.indexOf(this.independentLayer.id);t?-1===h&&(e.independent=!0,l.push(this.independentLayer.id)):-1!==h&&(e.independent=!1,l.splice(h,1)),o[r].layers=l}i&&e.children.forEach(function(e){e instanceof Cr&&n.onCheckIndependentLayer(e,t,i)})}}},t.initData=function(e){var t,i,n,a,s,r;e.local?(e.position&&(t=this.entity).setLocalPosition.apply(t,e.position),e.rotation&&(i=this.entity).setLocalEulerAngles.apply(i,e.rotation),e.scale&&(n=this.entity).setLocalScale.apply(n,e.scale)):(e.position&&(a=this.entity).setPosition.apply(a,e.position),e.rotation&&(s=this.entity).setEulerAngles.apply(s,e.rotation),e.scale&&(r=this.entity).setLocalScale.apply(r,e.scale))},t.addChild=function(e,t,i){void 0===i&&(i=!1),"number"==typeof t?this.entity.insertChild(e.entity,t):this.entity.addChild(e.entity),!e._init&&e.data&&(e.initData(e.data),e._init=!0),y_&&y_.independent&&this.onCheckIndependentLayer(this.entity,this.entity.independent,!0),i&&rm.fire("edk:scene:entity:add:child",this.scene.uuid,this.uuid,e.uuid,t)},t.reparent=function(e,t){var i=this.entity.getPosition().clone(),n=this.entity.getRotation().clone();this.entity.reparent(e.entity,t),this.entity.setPosition(i),this.entity.setRotation(n);var a=this.entity.getLocalEulerAngles();rm.fire("edk:scene:entity:reparent",this.scene.uuid,this.uuid,{rotation:[a.x,a.y,a.z],position:[this.entity.localPosition.x,this.entity.localPosition.y,this.entity.localPosition.z]}),y_&&y_.independent&&this.onCheckIndependentLayer(this.entity,e.entity.independent,!0)},t.createComponent=function(e){this.entity.script&&!this.entity.script[e.script]&&this.entity.script.create(e.script,{enabled:e.enabled,attributes:e.attributes})},t.removeComponent=function(e){this.entity.script&&this.entity.script[e]&&this.entity.script.destroy(e)},t.updateComponent=function(t,i,e){var n=this;this.entity.script&&(i instanceof Object?Object.keys(i).forEach(function(e){n.updateComponent(t,e,i[e])}):this.entity.script[t]&&(this.entity.script[t][i]=e))},t.execComponent=function(){var e,t=Array.from(arguments),i=t.shift(),n=t.shift();return this.entity.script&&this.entity.script[i]&&this.entity.script[i][n]&&"function"==typeof this.entity.script[i][n]?(e=this.entity.script[i])[n].apply(e,t):null},t.onDestroy=function(){this.seleted=!1,this.entity&&(this.entity.off("enable",this.onEnabled,this),this.entity.off("disable",this.onDisable,this),this.entity.script&&this.entity.script.off("initialize",this.onScriptInitialize,this),this.removeEventListener())},t.destroy=function(){this.scene&&this.scene.entities.entityIndex[this.uuid]&&delete this.scene.entities.entityIndex[this.uuid],Xy.entityIndex[this.space_uuid]&&delete Xy.entityIndex[this.space_uuid],this.entity&&this.entity.destroy(),this.scene=null,this.uuid=null,this.parent_uuid=null,this.entity=null,this.deleted=!1,this.data={},this.extensions={},this.transparentLayer=null,this.independentLayer=null,this.seleted=!1,this.startPosition=null,this.currPosition=null,this.transPosition=null,this.startRotation=null,this.currRotation=null,this.transRotation=null,this.startScale=null,this.currScale=null,this.transScale=null},c(e,[{key:"space_uuid",get:function(){return this.scene?this.scene.uuid+"_"+this.uuid:this.uuid}},{key:"space_parent_uuid",get:function(){return this.scene?this.scene.uuid+"_"+this.parent_uuid:this.parent_uuid}}]),e}(),M_=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).type="model",e.entity.addComponent("model"),e.entity.script.create("entitySizer"),e}u(e,t);var i=e.prototype;return i.onResourceReady=function(){},i.onSelectAdd=function(){t.prototype.onSelectAdd.call(this),this.startPosition.copy(this.entity.getPosition())},i.getCurrentParams=function(e){void 0===e&&(e=!1);var t=this.entity.getLocalEulerAngles();return{scale:[this.entity.localScale.x,this.entity.localScale.y,this.entity.localScale.z],position:[this.entity.localPosition.x,this.entity.localPosition.y,this.entity.localPosition.z],rotation:e?this.entity.getLocalRotation():[t.x,t.y,t.z]}},i.setCurrentParams=function(e,t){void 0===t&&(t=!1),e.scale&&this.updateField("scale",e.scale),e.position&&this.updateField("position",e.position),e.rotation&&(t?this.updateField("rotation_quat",e.rotation):this.updateField("rotation",e.rotation))},i.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.updateField(e,t[e])}):this.updateField(t,e)},i.updateField=function(e,t){var i,n,a,s=this;switch(e){case"name":this.entity.name=t;break;case"enabled":this.entity.enabled=t;break;case"position":(i=this.entity).setLocalPosition.apply(i,t);break;case"rotation":(n=this.entity).setLocalEulerAngles.apply(n,t);break;case"rotation_quat":var r;t instanceof fe?this.entity.setLocalRotation(t):(r=this.entity).setLocalRotation.apply(r,t);break;case"scale":(a=this.entity).setLocalScale.apply(a,t);break;case"sizer":t instanceof Object&&Object.keys(t).forEach(function(e){s.updateSizer(e,t[e])})}rm.fire("edk:render:gizmo:update:gizmo")},i.updateSizer=function(e,t){if(this.entity.script.entitySizer)switch(e){case"enabled":this.entity.script.entitySizer.enabled=t,this.entity.script.entitySizer.render=t;break;case"size":this.entity.script.entitySizer.xSize=t[0],this.entity.script.entitySizer.ySize=t[2],this.entity.script.entitySizer.zSize=t[1];break;case"exclude":this.entity.script.entitySizer.exclude=t,this.entity.script.entitySizer.updateAabb();break;case"unit":this.entity.script.entitySizer.unit=t;break;case"color":this.entity.script.entitySizer.color=t;break;case"thickness":this.entity.script.entitySizer.thickness=t}},e}(x_),S_=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).model_type="box",e.entity.model.type=e.model_type,e}return u(e,t),e}(M_),w_=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).model_type="asset",t.extensions={},t.components=[],t.entityCloned=null,t.wireframeMaterial=null,t.uvMaterialMap={},t.entity.model.type=t.model_type,e.components&&e.components.length&&(t.components=e.components),e.extensions&&t.scene&&(t.extensions=e.extensions,t.resource=t.scene.resources.get(e.extensions.resource),t.resource&&t.resource.asset&&t.resource.asset.loaded&&t.onSceneResourceReady(t.resource.uuid,t.resource),t.scene.on("edk:scene:resource:ready",t.onSceneResourceReady,g(t))),t}u(e,i);var t=e.prototype;return t.onSceneResourceReady=function(e,t){if(e===this.extensions.resource){var i=this.resource?"replace":"init";this.resource=t,this.handleResource(i),this.handleExtensions(),rm.on("edk:app:entity:wireframe:change",this.wireframeChange,this),rm.on("edk:app:entity:uvDetection:change",this.uvDetectionChange,this)}},t.handleExtensions=function(){var t=this;this.extensions.transparentLayer&&this.transparentLayer&&(this.entity.model.layers=[this.transparentLayer.id]),this.components&&this.components.length&&this.components.forEach(function(e){t.entity.script.create(e.script,{enabled:e.enabled,attributes:e.attributes})})},t.handleResource=function(e){var t=this;if(this.resource){if(this.model=this.resource.asset.resource.clone(),this.entity.model.model=this.model,this.extensions.materials){if("replace"===e){var i=JSON.parse(JSON.stringify(this.resource.materials));Object.keys(i).forEach(function(e){t.extensions.materials[e]&&(i[e]=t.extensions.materials[e])}),this.extensions.materials=i}Object.keys(this.extensions.materials).forEach(function(e){t.updateMaterial(e,t.extensions.materials[e].selected)})}0<this.resource.animations.length&&(this.entity.animation||(this.entity.addComponent("animation"),this.entity.animation.activate=!1),this.entity.animation.assets=this.resource.animations)}},t.updateField=function(e,t){switch(i.prototype.updateField.call(this,e,t),e){case"transparentLayer":this.entity.model&&(t?this.transparentLayer&&(this.entity.model.layers=[this.transparentLayer.id]):this.entity.model.layers=[0]);break;case"resource":"string"==typeof t||(this.extensions.resource=null,this.entity.model.model=null)}},t.getAnimation=function(e,t){if(!this.entity.animation)return null;switch(e){case"playing":return this.entity.animation.playing;case"currAnim":return this.entity.animation.currAnim;case"currentTime":return this.entity.animation.currentTime;case"loop":return this.entity.animation.loop;case"lerp":return this.entity.animation.lerp;case"speed":return this.entity.animation.speed;case"duration":return this.entity.animation.animations[t]?this.entity.animation.animations[t].duration:0}},t.setAnimation=function(t,e){var i=this;if(t instanceof Object)Object.keys(t).forEach(function(e){i.setAnimation(e,t[e])});else if(this.entity.animation)switch(t){case"playing":this.entity.animation.currAnim&&this.entity.animation.playing!==e&&(this.entity.animation.playing=e);break;case"currAnim":this.entity.animation.play(e);break;case"currentTime":this.entity.animation.currAnim&&this.entity.animation.currentTime!==e&&(this.entity.animation.currentTime=e);break;case"loop":this.entity.animation.loop=e;break;case"lerp":this.entity.animation.lerp=e;break;case"speed":this.entity.animation.speed=e}},t.getMaterial=function(e){if(this.resource&&this.resource.meshInstances[e]&&this.resource.meshInstances[e].length){var t=this.resource.meshInstances[e][0];return this.entity.model.model.meshInstances[t]?this.entity.model.model.meshInstances[t].material:null}return null},t.updateMaterial=function(e,t){var i,n=this;if(this.resource&&(this.extensions.materials[e]||this.resource.meshInstances[e])&&this.scene&&this.entity.model.model&&(null==(i=Object.keys(this.uvMaterialMap))||!i.length)){var a=this.extensions.materials[e].meshes?this.extensions.materials[e].meshes:this.resource.meshInstances[e],s=null;if("string"==typeof t){var r=this.scene.resources.get(t);r&&(s=r.asset.resource,r.updateMaterialGizmoPlanePosWS(this.entity.getPosition())),this.extensions&&this.extensions.materials&&(this.extensions.materials[e]?this.extensions.materials[e].selected=t:this.extensions.materials[e]={selected:t})}else t instanceof gm&&(s=t);s&&a instanceof Array&&a.forEach(function(e){n.entity.model.model.meshInstances[e].material=s,n.entity.model.model.meshInstances[e].material.update()})}},t.getMeshsIndex=function(e){return this.resource&&this.resource.meshInstances[e]?this.resource.meshInstances[e]:[]},t.getMaterialSpaceName=function(e){return this.resource&&this.resource.meshInstancesName[e]?this.resource.meshInstancesName[e]:null},t.updateComponent=function(t,i,e){var n=this;i instanceof Object?Object.keys(i).forEach(function(e){n.updateComponent(t,e,i[e])}):this.entity.script[t]&&(this.entity.script[t][i]=e)},t.onDestroy=function(){i.prototype.onDestroy.call(this),this.model instanceof rr&&(this.model.destroy(),this.model=null)},t.destroyEntityCloned=function(){var e,t;null==(e=this.entityCloned)||null==e.destroy||e.destroy(),null==(t=this.wireframeMaterial)||null==t.destroy||t.destroy(),this.entityCloned=null,this.wireframeMaterial=null},t.wireframeChange=function(e){var t=this;if(e){var i,n,a,s,r=Boolean(!this.entityCloned&&!this.wireframeMaterial),o=this.entity;if(r){var l;this.wireframeMaterial||(this.wireframeMaterial=new gm,this.wireframeMaterial.diffuse.set(0,0,0,0),this.wireframeMaterial.specular.set(0,0,0,0),this.wireframeMaterial.shininess=0);var h=new Cr;h.addComponent("model"),h.model.model=o.model.model.clone(),null!=h&&null!=(l=h.script)&&l.entityShadowBake&&(h.script.entityShadowBake.enabled=!1),h.name="WIREFRAME_CLONE_"+o.name,this.entityCloned=h}(i=this.wireframeMaterial.emissive).set.apply(i,e);var c=null==(n=this.entityCloned)||null==(a=n.model)?void 0:a.model;null==c||c.generateWireframe(),null==c||null==(s=c.meshInstances)||s.forEach(function(e){e.renderStyle=1,e.material=t.wireframeMaterial,e.material.update()}),r&&(this.entityCloned.setLocalPosition(0,0,0,1),this.entityCloned.setLocalRotation(0,0,0,1),this.entityCloned.setLocalScale(1.001,1.001,1.001),o.addChild(this.entityCloned))}else this.destroyEntityCloned()},t.uvDetectionChange=function(i){var e,n=this,a=this.entity,t=a.model.model;null==t||null==(e=t.meshInstances)||e.forEach(function(e){var t=a.localGuid+"_"+e.index;n.uvMaterialMap[t]&&(e.material=n.uvMaterialMap[t],e.material.update()),i&&(n.uvMaterialMap[t]=e.material,e.material=i,e.material.update())}),i||(this.uvMaterialMap={})},t.destroy=function(){i.prototype.destroy.call(this),this.scene&&this.scene.off("edk:scene:resource:ready",this.onSceneResourceReady,this),this.resource=null},e}(M_),C_=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).model_type="capsule",e.entity.model.type=e.model_type,e}return u(e,t),e}(M_),P_=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).model_type="cone",e.entity.model.type=e.model_type,e}return u(e,t),e}(M_),T_=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).model_type="cylinder",e.entity.model.type=e.model_type,e}return u(e,t),e}(M_),A_=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).model_type="sphere",e.entity.model.type=e.model_type,e}return u(e,t),e}(M_),E_=function(){function e(e){var t=this;this.type="camera",this.entity=new Cr,this.entity.type=e.type||this.type,this.entity.name=e&&e.name||"摄像机",e&&e.uuid?(this.uuid=e.uuid,this.entity.setGuid(this.uuid)):this.uuid=this.entity.getGuid(),this.entity.addComponent("script"),this.entity.script.create("entityAabb"),this.entity.script.on("initialize",this.onScriptInitialize,this),e.data&&(this.data=e.data),e.extensions&&(this.extensions=e.extensions),e.components.length&&e.components.forEach(function(e){t.entity.script.create(e.script,{enabled:e.enabled,attributes:e.attributes})}),this.entity.addComponent("camera"),this.entity.camera.nearClip=.01,this.entity.on("enable",this.onEnabled,this),this.entity.on("disable",this.onDisable,this)}var t=e.prototype;return t.onEnabled=function(){},t.onDisable=function(){},t.onDestroy=function(){},t.onScriptInitialize=function(){},t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.updateField(e,t[e])}):this.updateField(t,e)},t.destroy=function(){this.uuid=null,this.extensions={},this.entity.destroy()},t.updateField=function(){},e}(),R_=function(i){function e(e){var t;return(t=i.call(this,e)||this).camera_type="orbit",t.orbitCameraScripts=["orbitCamera","orbitCameraMouseInput","orbitCameraTouchInput"],t.fpsCameraScripts=["fpsCamera","fpsCameraKeyboardInput","fpsCameraMouseInput","fpsCameraTouchInput"],t.entity.script.create("camera"),t.entity.script.create("bvhPicker"),t.entity.script.create("orbitCamera"),t.entity.script.create("orbitCameraMouseInput"),t.entity.script.create("orbitCameraTouchInput"),t.entity.script.create("fpsCamera"),t.entity.script.create("fpsCameraKeyboardInput"),t.entity.script.create("fpsCameraMouseInput"),t.entity.script.create("fpsCameraTouchInput"),t.entity.script.create("cameraMapping"),"meeting"===rm.mode||"preview"===rm.mode||"viewer"===rm.mode?(t.initEventListener(),t.entity.script.orbitCamera.enabled=!0,t.entity.script.orbitCamera.frameOnStart=!1,t.entity.script.orbitCamera.inertiaFactor=.2,t.entity.script.fpsCamera.enabled=!1,t.entity.script.fpsCameraKeyboardInput.enabled=!1,t.entity.script.fpsCameraMouseInput.enabled=!1,t.entity.script.fpsCamera.fpsHeight=1.6,rm.fire("edk:render:camera:change",g(t)),t.entity.enabled=!0):t.entity.enabled=!1,t}u(e,i);var t=e.prototype;return t.initEventListener=function(){},t.onSwitchCameraType=function(){var t=this,e=this.entity.getPosition().clone(),i=this.entity.getRotation().clone();"orbit"===this.camera_type?(this.camera_type="fps",this.orbitCameraScripts.forEach(function(e){t.entity.script[e]&&(t.entity.script[e].enabled=!1)}),this.fpsCameraScripts.forEach(function(e){t.entity.script[e]&&(t.entity.script[e].enabled=!0)}),this.entity.script.fpsCamera&&this.entity.script.orbitCamera&&this.entity.script.fpsCamera.resetToTRS({position:e,rotation:i})):(this.camera_type="orbit",this.entity.script.fpsCamera&&this.entity.script.orbitCamera&&(this.entity.script.orbitCamera._yaw=this.entity.script.fpsCamera._yaw,this.entity.script.orbitCamera._targetYaw=this.entity.script.fpsCamera._targetYaw,this.entity.script.orbitCamera._pitch=this.entity.script.fpsCamera._pitch,this.entity.script.orbitCamera._targetPitch=this.entity.script.fpsCamera._targetPitch),this.orbitCameraScripts.forEach(function(e){t.entity.script[e]&&(t.entity.script[e].enabled=!0)}),this.fpsCameraScripts.forEach(function(e){t.entity.script[e]&&(t.entity.script[e].enabled=!1)}),this.entity.script.fpsCamera&&this.entity.script.orbitCamera&&this.entity.script.orbitCamera.resetToTRS({position:e,rotation:i})),rm.fire("edk:render:camera:type:change",this.camera_type)},t.onScriptInitialize=function(e){switch(e){case"orbitCamera":this.extensions&&this.initExtensions(this.extensions)}},t.initExtensions=function(t){var i=this,n={pivot:!1,yaw:!1,pitch:!1,distance:!1};Object.keys(t).forEach(function(e){!1!==n[e]&&i.updateField(e,t[e])}),Object.keys(n).forEach(function(e){i.updateField(e,t[e])})},t.getCurrentParams=function(){if("orbit"===this.camera_type){var e=this.entity.script.orbitCamera._yaw;return 360<=e&&(e%=360),e<=-360&&(e%=-360),{yaw:e,pitch:this.entity.script.orbitCamera._pitch,distance:this.entity.script.orbitCamera._distance,pivot:[this.entity.script.orbitCamera.pivot.x,this.entity.script.orbitCamera.pivot.y,this.entity.script.orbitCamera.pivot.z]}}if("fps"===this.camera_type){var t=this.entity.script.fpsCamera._yaw;return 360<=t&&(t%=360),t<=-360&&(t%=-360),{yaw:t,pitch:this.entity.script.fpsCamera._pitch,position:this.entity.getPosition(),fpsHeight:this.entity.script.fpsCamera.fpsHeight}}},t.setCurrentParams=function(e){"orbit"===this.camera_type?(e.pivot&&this.updateField("pivot",e.pivot),void 0===e.yaw&&(e.yaw=this.entity.script.orbitCamera._yaw),void 0===e.pitch&&(e.pitch=this.entity.script.orbitCamera._pitch),void 0===e.distance&&(e.distance=this.entity.script.orbitCamera._distance),this.entity.script.orbitCamera.reset(e.yaw,e.pitch,e.distance)):(void 0===e.yaw&&(e.yaw=this.entity.script.fpsCamera._yaw),void 0===e.pitch&&(e.pitch=this.entity.script.fpsCamera._pitch),void 0===e.position?e.position=this.entity.getPosition():e.position=z(de,e.position),this.entity.script.fpsCamera.reset(e))},t.getCurrentData=function(){var e=this.entity.getLocalEulerAngles();return{scale:[this.entity.localScale.x,this.entity.localScale.y,this.entity.localScale.z],position:[this.entity.localPosition.x,this.entity.localPosition.y,this.entity.localPosition.z],rotation:[e.x,e.y,e.z]}},t.updateField=function(e,t){var i="orbit"===this.camera_type?"orbitCamera":"fpsCamera";switch(e){case"name":this.entity.name=t;break;case"enabled":this.entity.enabled=t;break;case"fov":this.extensions[e]=t,this.entity.script[i].reverseOrbit?this.entity.script[i][e]=t:this.entity.camera.fov=t;break;case"clearColor":(this.extensions[e]=t)instanceof Array&&3<=t.length&&(this.entity.camera.clearColor=z($,t));break;case"ground":"fps"===this.camera_type&&this.setBvhEntities(t);break;case"forwardSpeed":case"translationSpeed":this.entity.script.fpsCamera&&(this.entity.script.fpsCamera.direction=this.entity.forward,this.entity.script.fpsCamera[e]=t);break;case"yaw":case"pitch":case"pivot":case"distance":case"distanceMin":case"distanceMax":case"fovMax":case"fovMin":case"pitchAngleLimit":case"pitchAngleMax":case"pitchAngleMin":case"yawAngleLimit":case"yawAngleMax":case"yawAngleMin":case"reverseOrbit":case"disableMove":case"disablePivot":case"autoRotate":case"rotationSpeed":case"waitingTime":case"speed":case"fpsHeightMax":case"fpsHeightMin":this.extensions[e]=t,this.entity.script[i][e]=t}},t.addBvhEntity=function(e){this.entity&&this.entity.script.bvhPicker&&this.entity.script.bvhPicker.addBvhEntity(e)},t.removeBvhEntity=function(e){this.entity&&this.entity.script.bvhPicker&&this.entity.script.bvhPicker.removeBvhEntity(e)},t.clearBvhEntities=function(){this.entity&&this.entity.script.bvhPicker&&this.entity.script.bvhPicker.clearBvhEntities(entity)},t.setBvhEntities=function(e){this.entity&&this.entity.script.bvhPicker&&this.entity.script.bvhPicker.setBvhEntities(e)},e}(E_),D_=function(i){function e(e){var t;return(t=i.call(this,e)||this).camera_type="editor",t.entity.script.create("camera"),t.entity.script.create("editorCamera"),t.entity.script.create("editorCameraMouseInput"),t.entity.script.create("entityPicker"),t.entity.script.create("cameraMapping"),rm.mode===e_?(rm.on("edk:render:camera:mouse:up",t.onCameraMouseUp,g(t)),rm.method("edk:render:camera:get:results",t.onCameraGetResults,g(t)),t.initEventListener(),rm.fire("edk:render:camera:change",g(t)),t.entity.enabled=!0):t.entity.enabled=!1,t}u(e,i);var t=e.prototype;return t.onScriptInitialize=function(e){switch(e){case"editorCamera":this.extensions&&this.initExtensions(this.extensions)}},t.initEventListener=function(){rm.on("edk:script:gizmo:translate:start",this.onTranslateStart,this),rm.on("edk:script:gizmo:translate:start:uvmapping",this.onTranslateStart,this),rm.on("edk:script:gizmo:translate:set",this.onTranslate,this),rm.on("edk:script:gizmo:translate:end",this.onTranslateEnd,this),rm.on("edk:script:gizmo:translate:end:uvmapping",this.onTranslateEnd,this),rm.on("edk:script:gizmo:rotate:start",this.onRotateStart,this),rm.on("edk:script:gizmo:rotate:start:uvmapping",this.onRotateStart,this),rm.on("edk:script:gizmo:rotate:set",this.onRotate,this),rm.on("edk:script:gizmo:rotate:end",this.onRotateEnd,this),rm.on("edk:script:gizmo:rotate:end:uvmapping",this.onRotateEnd,this),rm.on("edk:script:gizmo:scale:start",this.onScaleStart,this),rm.on("edk:script:gizmo:scale:start:uvmapping",this.onScaleStart,this),rm.on("edk:script:gizmo:scale:set",this.onScale,this),rm.on("edk:script:gizmo:scale:end",this.onScaleEnd,this),rm.on("edk:script:gizmo:scale:end:uvmapping",this.onScaleEnd,this),this.entity.once("destroy",this.onDestroy,this)},t.initExtensions=function(t){var i=this;Object.keys(t).forEach(function(e){switch(e){case"yaw":case"pitch":case"pivot":case"distance":i.entity.script.editorCamera[e]=t[e];break;case"fov":i.entity.camera.fov=t[e];break;case"clearColor":t[e]instanceof Array&&3<=t[e].length&&($y&&$y.background&&"color"===$y.background.type?i.entity.camera.clearColor=new $(0,0,0,0):i.entity.camera.clearColor=z($,t[e]))}})},t.getCurrentParams=function(){var e=this.entity.script.editorCamera._yaw;return 360<=e&&(e%=360),e<=-360&&(e%=-360),{yaw:e,pitch:this.entity.script.editorCamera._pitch,distance:this.entity.script.editorCamera._distance,pivot:[this.entity.script.editorCamera.pivot.x,this.entity.script.editorCamera.pivot.y,this.entity.script.editorCamera.pivot.z]}},t.getPositionParams=function(e){var t=this.entity.script.editorCamera._yaw;360<=t&&(t%=360),t<=-360&&(t%=-360);var i=this.entity.getPosition();return{yaw:t,fpsHeight:this.entity.script.editorCamera.getFpsHeight(i,e),pitch:this.entity.script.editorCamera._pitch,position:JSON.parse(i.toString())}},t.setCurrentParams=function(e){e.pivot&&this.updateField("pivot",e.pivot),void 0===e.yaw&&(e.yaw=this.entity.script.editorCamera._yaw),void 0===e.pitch&&(e.pitch=this.entity.script.editorCamera._pitch),void 0===e.distance&&(e.distance=this.entity.script.editorCamera._distance),this.entity.script.editorCamera.reset(e.yaw,e.pitch,e.distance)},t.getCurrentData=function(){var e=this.entity.getLocalEulerAngles();return{scale:[this.entity.localScale.x,this.entity.localScale.y,this.entity.localScale.z],position:[this.entity.localPosition.x,this.entity.localPosition.y,this.entity.localPosition.z],rotation:[e.x,e.y,e.z]}},t.onTranslateStart=function(){this.entity.script.editorCameraMouseInput.enabled=!1},t.onTranslate=function(){},t.onTranslateEnd=function(){this.entity.script.editorCameraMouseInput.enabled=!0},t.onRotateStart=function(){this.entity.script.editorCameraMouseInput.enabled=!1},t.onRotate=function(){},t.onRotateEnd=function(){this.entity.script.editorCameraMouseInput.enabled=!0},t.onScaleStart=function(){this.entity.script.editorCameraMouseInput.enabled=!1},t.onScale=function(){},t.onScaleEnd=function(){this.entity.script.editorCameraMouseInput.enabled=!0},t.updateField=function(e,t){switch(e){case"name":this.entity.name=t;break;case"enabled":this.entity.enabled=t;break;case"clearColor":this.extensions[e]=t,$y&&$y.background&&"skybox"===$y.background.type&&t instanceof Array&&3<=t.length&&(this.entity.camera.clearColor=z($,t));break;case"yaw":case"pitch":case"pivot":case"distance":this.extensions[e]=t,this.entity.script.editorCamera[e]=t;break;case"disableMove":this.entity.script.entityPicker.enabled=!t,this.entity.script.editorCamera[e]=t}},t.onCameraMouseUp=function(){rm.fire("edk:render:camera:update:extensions",this.uuid,this.getCurrentParams())},t.onCameraGetResults=function(e,t){void 0===t&&(t=function(){});var i=this.entity.script.entityPicker.getResults(e);if(!i)return t(null);var n=i.id,a=i.meshIndex;t({uuid:n.split("_")[1],meshIndex:a})},e}(E_),I_=null,k_=function(){function e(){this.camera=null,this.cameraReady=!1,I_=this,rm.method("edk:render:camera:create:component",this.createComponent,this),rm.method("edk:render:camera:update:component",this.updateComponent,this),rm.method("edk:render:camera:remove:component",this.removeComponent,this),rm.method("edk:render:camera:get",this.getCamera,this),rm.method("edk:render:camera:focus",this.focus,this),rm.method("edk:render:camera:update",this.update,this)}var t=e.prototype;return t.initialize=function(e,t){var i=this;if(void 0===t&&(t={}),!this.cameraReady){if(rm.mode===e_?this.camera=new D_(e):this.camera=new R_(e),this.camera&&this.camera.entity&&(this.cameraReady=!0,rm.root.addChild(this.camera.entity)),Xy){var n=t.data;n&&(e.components=e.components.concat(n.scene.components.filter(function(e){return e.camera})))}e.components.length&&e.components.forEach(function(e){i.camera.entity.script.create(e.script,{enabled:e.enabled,attributes:e.attributes})})}},t.getCamera=function(){return this.camera},t.createComponent=function(e){this.camera&&!this.camera.entity.script[e.script]&&this.camera.entity.script.create(e.script,{enabled:e.enabled,attributes:e.attributes})},t.removeComponent=function(e){this.camera.entity.script[e]&&this.camera.entity.script.destroy(e)},t.updateComponent=function(t,i,e){var n=this;this.camera&&(i instanceof Object?Object.keys(i).forEach(function(e){n.updateComponent(t,e,i[e])}):this.camera.entity.script[t]&&(this.camera.entity.script[t][i]=e))},t.update=function(e,t){this.camera&&this.camera.update(e,t)},t.focus=function(e,t,i){var n=this;void 0===i&&(i={});var a=Xy.getEntity(e,t),s=a&&a.entity?a.entity:rm.root;if(s&&s.aabb&&this.camera&&"fps"!==this.camera.camera_type){var r=s.aabb,o=Math.max(r.halfExtents.x,Math.max(r.halfExtents.y,r.halfExtents.z));o=1.1*(o/=Math.tan(.5*this.camera.entity.camera.fov*Math.PI/180))+1,i instanceof Object||(i={}),this.update(h({},i,{pivot:[r.center.x,r.center.y,r.center.z],distance:o})),rm.mode===e_&&(this.focusTimer&&(clearTimeout(this.focusTimer),this.focusTimer=null),this.focusTimer=setTimeout(function(){rm.fire("edk:render:camera:update:extensions",n.camera.uuid,n.camera.getCurrentParams()),clearTimeout(n.focusTimer),n.focusTimer=null},100))}},t.destroy=function(){this.camera.destroy(),this.camera=null,this.cameraReady=!1,I_=null},e}(),L_=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).type="annotation",e.extensions&&(t.annotation_type=e.extensions.annotation_type),t.entity.script.create("annotationPicker"),"attach"!==t.annotation_type&&(t.pickerEntity=new Cr,t.pickerEntity._system=!0,t.pickerEntity.type="picker",t.pickerEntity.addComponent("element"),t.pickerEntity.element.enabled=!1,t.pickerEntity.element.layers=!0===t.extensions.transparentLayer?[t.transparentLayer.id]:[0],t.pickerEntity.element.type=ku,t.pickerEntity.name="Picker Entity",t.pickerEntity.element.width=void 0!==e.extensions.width?e.extensions.width:"text"===t.annotation_type?8:1,t.pickerEntity.element.height=void 0!==e.extensions.height?e.extensions.height:1,t.pickerEntity.element.anchor=new ee(.5,.5,.5,.5),t.pickerEntity.element.pivot=new J(.5,.5),t.pickerEntity.element.useInput=!0,t.pickerEntity.element.material.emissiveMapReverseMode=1,t.pickerEntity.element.material.opacityMapReverseMode=1,t.pickerEntity.element.material.update(),t.entity.script.annotationPicker.pickerEntity=t.pickerEntity,t.entity.script.annotationPicker.pickerWidth=t.pickerEntity.element.width,t.entity.script.annotationPicker.pickerState="normal",t.entity.addChild(t.pickerEntity)),t.setCamera(),rm.on("edk:render:camera:change",t.setCamera,g(t)),rm.on("edk:scene:default:resource:ready",t.onSceneDefaultResourceReady,g(t)),t.scene&&"text"!==t.annotation_type&&t.scene.on("edk:scene:resource:ready",t.onSceneResourceReady,g(t)),t}u(e,i);var t=e.prototype;return t.onSceneDefaultResourceReady=function(e,t){"annotation"===e&&this.onSceneResourceReady("annotation_default_asset",t.resource)},t.onSceneResourceReady=function(e,t){},t.setCamera=function(e){e||(e=I_.getCamera()),e&&this.entity&&this.entity.script&&this.entity.script.annotationPicker&&(this.entity.script.annotationPicker.cameraEntity=e.entity)},t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.updateField(e,t[e])}):this.updateField(t,e)},t.updateField=function(n,a){var e,t,i,s=this;switch(n){case"name":(this.entity.name=a)&&"text"===this.annotation_type&&this.renderImage(a);break;case"enabled":this.entity.enabled=a;break;case"position":(e=this.entity).setLocalPosition.apply(e,a);break;case"rotation":(t=this.entity).setLocalEulerAngles.apply(t,a);break;case"scale":break;case"scaling":this.entity.script.annotationPicker.scaleMode&&this.entity.setLocalScale(a,a,a),this.entity.script.annotationPicker[n]=a;break;case"scaleMode":a&&this.entity.setLocalScale(this.entity.script.annotationPicker.scaling,this.entity.script.annotationPicker.scaling,this.entity.script.annotationPicker.scaling),this.entity.script.annotationPicker[n]=a;break;case"angleRange":this.entity.script.annotationPicker.angleLock?this.entity.setEulerAngles(this.entity.script.annotationPicker.pitchLock?this.entity.script.annotationPicker.pitchRange:0,a<0?360-a:a,0):this.entity.setEulerAngles(this.entity.script.annotationPicker.pitchLock?this.entity.script.annotationPicker.pitchRange:0,0,0),this.entity.script.annotationPicker[n]=a;break;case"pitchRange":this.entity.script.annotationPicker.pitchLock?this.entity.setEulerAngles(-a,this.entity.script.annotationPicker.angleLock?this.entity.script.annotationPicker.angleRange:0,0):this.entity.setEulerAngles(0,this.entity.script.annotationPicker.angleLock?this.entity.script.annotationPicker.angleRange:0,0),this.entity.script.annotationPicker[n]=-a;break;case"angleLock":a?this.entity.setEulerAngles(this.entity.script.annotationPicker.pitchLock?this.entity.script.annotationPicker.pitchRange:0,this.entity.script.annotationPicker.angleRange,0):this.entity.setEulerAngles(this.entity.script.annotationPicker.pitchLock?this.entity.script.annotationPicker.pitchRange:0,0,0),this.entity.script.annotationPicker[n]=a;break;case"pitchLock":a?this.entity.setEulerAngles(this.entity.script.annotationPicker.pitchRange,this.entity.script.annotationPicker.angleLock?this.entity.script.annotationPicker.angleRange:0,0):this.entity.setEulerAngles(0,this.entity.script.annotationPicker.angleLock?this.entity.script.annotationPicker.angleRange:0,0),this.entity.script.annotationPicker[n]=a;break;case"annotationType":case"pickerDirection":case"timelineSwitch":case"mode":this.entity.script.annotationPicker[n]=a;break;case"depthTest":break;case"resourceType":this.resourceType=a,this.entity.script.annotationPicker[n]=a,["normal","hover"].forEach(function(e){s[s.resourceType][e]&&s[s.resourceType][e].asset.loaded?s.updateResources(a,e,s[s.resourceType][e].asset.resource):s.updateResources(a,e,null)});break;case"textures":case"materials":"icon"!==this.annotation_type&&"product"!==this.annotation_type||["normal","hover"].forEach((i=o(__.mark(function e(t){var i;return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:(i=a[t])?(s[n][t]=s.scene.resources.get(i),s[n][t]&&s[n][t].asset.loaded?(s.pickerEntity.element.enabled||(s.pickerEntity.element.enabled=!0),s.resources[i]=s[n][t].asset.resource,s.updateResources(n,t,s.resources[i])):s.resources[i]=[n,t]):(s[n][t]=null,s.updateResources(n,t,null));case 2:case"end":return e.stop()}},e)})),function(e){return i.apply(this,arguments)}));break;case"default":if("icon"===this.annotation_type||"product"===this.annotation_type){var r=Xy.getDefaultResource("annotation");r.resource?(this.pickerEntity.element.enabled||(this.pickerEntity.element.enabled=!0),this.updateResources("default","default",r.resource)):this.resources[a]=["default"]}}rm.fire("edk:render:gizmo:update:gizmo")},t.destroy=function(){i.prototype.destroy.call(this),this.pickerEntity&&(this.pickerEntity.destroy(),this.pickerEntity=null),rm.off("edk:render:camera:change",this.setCamera,this)},e}(x_),O_=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).type="annotation",e.texture=new Kt(rm.graphicsDevice),e.image=new Image,e.image.crossOrigin="",e.image.width=256,e.image.height=32,e.pickerEntity.element.texture=e.texture,e.initAnnotation(),e}u(e,t);var i,n=e.prototype;return n.onScriptInitialize=function(e){"annotationPicker"===e&&this.renderImage(this.entity.name)},n.initAnnotation=(i=o(__.mark(function e(){var i=this;return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:["scaleMode","angleLock","pitchLock","scaling","angleRange","pitchRange","depthTest","timelineSwitch"].forEach(function(){var t=o(__.mark(function e(t){return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===i.extensions[t]){e.next=3;break}return e.next=3,i.updateField(t,i.extensions[t]);case 3:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()),this.pickerEntity.element.enabled||(this.pickerEntity.element.enabled=!0);case 2:case"end":return e.stop()}},e,this)})),function(){return i.apply(this,arguments)}),n.fillRoundRect=function(e,t,i,n,a,s,r){if(n<2*s||a<2*s)return!1;e.save(),e.translate(t,i),this.drawRoundRectPath(e,n,a,s),e.fillStyle=r||"#000",e.fill(),e.restore()},n.drawRoundRectPath=function(e,t,i,n){e.beginPath(0),e.arc(t-n,i-n,n,0,Math.PI/2),e.lineTo(n,i),e.arc(n,i-n,n,Math.PI/2,Math.PI),e.lineTo(0,n),e.arc(n,n,n,Math.PI,3*Math.PI/2),e.lineTo(t-n,0),e.arc(t-n,n,n,3*Math.PI/2,2*Math.PI),e.lineTo(t,i-n),e.closePath()},n.renderImage=function(e){var t=this,i=rm.call("edk:render:preview:canvas"),n=rm.call("edk:render:preview:canvas:ctx");i.width=512,i.height=64,n.font="24px normal",n.fillStyle="#fff";var a=n.measureText(e).width;n.clearRect(0,0,i.width,i.height),this.fillRoundRect(n,(i.width-32-a)/2,(i.height-48)/2,a+32,48,8,"rgba(0,0,0,0.7)"),n.fillText(e,(i.width-32-a)/2+16,40),this.image.src=i.toDataURL("image/svg"),this.entity.script.annotationPicker.pickerWidth=(a+32)/64,this.image.onload=function(){t.texture.setSource(t.image)}},n.destroy=function(){t.prototype.destroy.call(this),this.image=null,this.texture=null},e}(L_),F_=function(a){function e(){var e;return(e=a.apply(this,arguments)||this).type="annotation",e.resources={annotation_default_asset:["textures","default"],annotation_active_asset:["textures","active"]},e.resourceType="textures",e.defaultTexture=null,e.textures={},e.materials={},e.initAnnotationTexture(),e}u(e,a);var t,i=e.prototype;return i.initAnnotationTexture=function(){var i=this;this.extensions.textures&&Object.keys(this.extensions.textures).forEach(function(e){var t=i.extensions.textures[e];t&&(i.textures[e]=i.scene.resources.get(t),(void 0===i.textures[e]||null===i.textures[e]||i.textures[e]&&!i.textures[e].asset.loaded)&&(i.resources[t]=["textures",e]))})},i.onScriptInitialize=function(e){switch(e){case"annotationPicker":this.initAnnotation()}},i.initAnnotation=(t=o(__.mark(function e(){var i=this;return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.resourceType=this.extensions.resourceType||"textures",["resourceType","scaleMode","angleLock","pitchLock","scaling","angleRange","pitchRange","depthTest","textures","materials","timelineSwitch"].forEach(function(){var t=o(__.mark(function e(t){return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===i.extensions[t]){e.next=3;break}return e.next=3,i.updateField(t,i.extensions[t]);case 3:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()),this.updateField("annotationType",this.annotation_type),this.updateField("mode",rm.mode),e.next=6,this.updateField("default","annotation_default_asset");case 6:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)}),i.onSceneResourceReady=function(e,t){if(a.prototype.onSceneResourceReady.call(this,e,t),this.resources[e]&&this.resources[e]instanceof Array){this.pickerEntity.element.enabled||(this.pickerEntity.element.enabled=!0);var i=this.resources[e][0],n=this.resources[e][1];"default"!==i?(this[i][n]=t,this.resources[e]=t.asset.resource,this.updateResources(i,n,this.resources[e])):(this.resources[e]=t,this.updateResources(i,null,this.resources[e]))}},i.updateResources=function(e,t,i){e===this.resourceType?this.entity.script.annotationPicker[t+"Resource"]=i:"default"===e&&(this.entity.script.annotationPicker.defaultTexture=i)},i.destroy=function(){a.prototype.destroy.call(this),this.scene&&this.scene.off("edk:scene:resource:ready",this.onSceneResourceReady,this),this.defaultTexture=null,this.textures={},this.materials={}},e}(L_),z_=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).type="annotation",e.extensions&&e.extensions.attach&&t.entity.script.create("annotationAttach",{attributes:e.extensions.attach}),t.initAnnotation(),t}u(e,i);var t,n=e.prototype;return n.initAnnotation=(t=o(__.mark(function e(){var i=this;return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.entity.script&&this.entity.script.annotationPicker&&(this.entity.script.annotationPicker.annotationType="attach"),["angleLock","angleRange","pitchLock","pitchRange","pickerDirection"].forEach(function(){var t=o(__.mark(function e(t){return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===i.extensions[t]){e.next=3;break}return e.next=3,i.updateField(t,i.extensions[t]);case 3:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}());case 2:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)}),n.updateAttach=function(t,e,i){var n=this;void 0===i&&(i=!0),t instanceof Object?(this.entity.script.annotationAttach.lock(),Object.keys(t).forEach(function(e){n.updateAttach(e,t[e],!1)}),this.entity.script.annotationAttach.unlock(),this.entity.script&&this.entity.script.annotationPicker&&this.entity.script.annotationPicker.resetPositiveVisible()):(i&&this.entity.script.annotationAttach.lock(),this.entity.script.annotationAttach[t]=e,i&&(this.entity.script.annotationAttach.unlock(),this.entity.script&&this.entity.script.annotationPicker&&this.entity.script.annotationPicker.resetPositiveVisible()))},e}(L_),B_=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).type="group",t.group_type="default",e.extensions&&(t.group_type=e.extensions.group_type||"default"),t.entity.script.create("entitySizer"),e.components&&e.components.length&&e.components.forEach(function(e){t.entity.script.create(e.script,{enabled:e.enabled,attributes:e.attributes})}),t}u(e,i);var t=e.prototype;return t.getCurrentParams=function(e){void 0===e&&(e=!1);var t=this.entity.getLocalEulerAngles();return{scale:[this.entity.localScale.x,this.entity.localScale.y,this.entity.localScale.z],position:[this.entity.localPosition.x,this.entity.localPosition.y,this.entity.localPosition.z],rotation:e?this.entity.getLocalRotation():[t.x,t.y,t.z]}},t.setCurrentParams=function(e,t){if(void 0===t&&(t=!1),void 0===e.scale&&(e.scale=[this.entity.localScale.x,this.entity.localScale.y,this.entity.localScale.z]),void 0===e.position&&(e.position=[this.entity.localPosition.x,this.entity.localPosition.y,this.entity.localPosition.z]),void 0===e.rotation){var i=this.entity.getLocalEulerAngles();e.rotation=[i.x,i.y,i.z]}this.updateField("scale",e.scale),this.updateField("position",e.position),t?this.updateField("rotation_quat",e.rotation):this.updateField("rotation",e.rotation)},t.update=function(t,e,i){var n=this;void 0===i&&(i=!0),t instanceof Object?Object.keys(t).forEach(function(e){n.updateField(e,t[e],i)}):this.updateField(t,e,i)},t.updateField=function(e,t){var i,n,a,s=this;switch(e){case"enabled":this.entity.enabled=t;break;case"position":(i=this.entity).setLocalPosition.apply(i,t);break;case"rotation":(n=this.entity).setLocalEulerAngles.apply(n,t);break;case"rotation_quat":var r;t instanceof fe?this.entity.setLocalRotation(t):(r=this.entity).setLocalRotation.apply(r,t);break;case"scale":(a=this.entity).setLocalScale.apply(a,t);break;case"sizer":t instanceof Object&&Object.keys(t).forEach(function(e){s.updateSizer(e,t[e])})}rm.fire("edk:render:gizmo:update:gizmo")},t.updateSizer=function(e,t){if(this.entity.script.entitySizer)switch(e){case"enabled":this.entity.script.entitySizer.enabled=t,this.entity.script.entitySizer.render=t;break;case"size":this.entity.script.entitySizer.xSize=t[0],this.entity.script.entitySizer.ySize=t[2],this.entity.script.entitySizer.zSize=t[1];break;case"exclude":this.entity.script.entitySizer.exclude=t,this.entity.script.entitySizer.updateAabb();break;case"unit":this.entity.script.entitySizer.unit=t;break;case"color":this.entity.script.entitySizer.color=t;break;case"thickness":this.entity.script.entitySizer.thickness=t}},t.updateComponent=function(t,i,e){var n=this;i instanceof Object?Object.keys(i).forEach(function(e){n.updateComponent(t,e,i[e])}):this.entity.script[t]&&(this.entity.script[t][i]=e)},e}(x_),V_=function(n){function e(e){var t;(t=n.apply(this,arguments)||this).type="light",t.entity.addComponent("light"),e.extensions&&(t.light_type=e.extensions.light_type,t.update(e.extensions),t.entity.light.shadowBias=.2,t.entity.light.normalOffsetBias=.05),t.entity.light.type=t.light_type;var i=t.entity.light.layers;return t.transparentLayer&&-1===i.indexOf(t.transparentLayer.id)&&i.push(t.transparentLayer.id),t.independentLayer&&-1===i.indexOf(t.independentLayer.id)&&i.push(t.independentLayer.id),t.entity.light.layers=i,t}u(e,n);var t=e.prototype;return t.getCurrentParams=function(){return{color:[this.entity.light.color.r,this.entity.light.color.g,this.entity.light.color.b,this.entity.light.color.a],intensity:this.entity.light.intensity}},t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.updateField(e,t[e])}):this.updateField(t,e)},t.updateField=function(e,t){var i,n,a;switch(e){case"light_type":this.entity.light.type=t;break;case"color":this.entity.light[e]=z($,t);break;case"name":this.entity.name=t;break;case"enabled":this.entity.enabled=t;break;case"position":(i=this.entity).setLocalPosition.apply(i,t);break;case"rotation":(n=this.entity).setLocalEulerAngles.apply(n,t);break;case"scale":(a=this.entity).setLocalScale.apply(a,t);break;default:this.entity.light[e]=t}rm.fire("edk:render:gizmo:update:gizmo"),rm.fire("edk:render:gizmo:update:light:gizmo")},t.onTranslate=function(e){n.prototype.onTranslate.call(this,e),this.seleted&&rm.fire("edk:render:gizmo:update:light:gizmo")},t.onRotate=function(e){n.prototype.onRotate.call(this,e),this.seleted&&rm.fire("edk:render:gizmo:update:light:gizmo")},t.onScale=function(e){n.prototype.onScale.call(this,e),this.seleted&&rm.fire("edk:render:gizmo:update:light:gizmo")},e}(x_),U_=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).type="particle",t.resources={},e.extensions&&(t.extensions=e.extensions,e.extensions.particlesystem&&(t.particlesystem=t.validateData(Object.assign({},e.extensions.particlesystem)),t.particlesystem&&(t.entity.addComponent("particlesystem",t.particlesystem),t.entity.particlesystem.layers=[0],t.scene&&t.scene.on("edk:scene:resource:ready",t.onSceneResourceReady,g(t))))),t}u(e,i);var t=e.prototype;return t.validateData=function(n){var a=this;return Fg.forEach(function(e){switch(e){case"mesh":case"colorMap":case"normalMap":if("string"==typeof n[e]){var t=n[e],i=rm.call("edk:scene:resource:get",a.scene.uuid,t);a.resources[t]?-1===a.resources[t].indexOf(e)&&a.resources[t].push(e):a.resources[t]=[e],i&&i.asset&&i.asset.loaded?n[e]=i.asset.id:n[e]=null}break;case"localVelocityGraph":case"velocityGraph":case"rotationSpeedGraph":case"scaleGraph":case"colorGraph":case"alphaGraph":void 0===n[e]||n[e].betweenCurves||(n[e+"2"]=Object.assign({},n[e]),delete n[e+"2"].betweenCurves)}}),n},t.onSceneResourceReady=function(t){var i=this;this.resources[t]&&this.resources[t].forEach(function(e){i.updateField(e,t).then(function(){})})},t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.updateField(e,t[e])}):this.updateField(t,e)},t.updateField=function(a,s){var r=this;return new Promise(function(e,t){if(-1!==Fg.indexOf(a)&&r.entity.particlesystem)if("asset"===zg[a])if(s){var i=rm.call("edk:scene:resource:get",r.scene.uuid,s);i&&i.asset.loaded?(r.entity.particlesystem[a]=i.asset.resource,e()):t()}else r.entity.particlesystem[a]=null,e();else if("curveset"===zg[a]||"curve"===zg[a]){if(s instanceof Object){var n=s.type;!1===a.betweenCurves&&(r.entity.particlesystem[a+"2"]=new K(s.keys||[]),r.entity.particlesystem[a+"2"].type=n),r.entity.particlesystem[a]="curveset"===zg[a]?new Z(s.keys||[]):new K(s.keys||[]),r.entity.particlesystem[a].type=n}}else if("vec3"===zg[a])s instanceof Array||(s=[0,0,0]),r.entity.particlesystem[a]=z(de,s);else switch(a){case"enabled":r.entity[a]=s,r.entity.particlesystem[a]=s;break;default:r.entity.particlesystem[a]=s}else t()})},e}(x_),N_=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).type="rooter",t.rooter_type="visual",e.extensions&&(t.rooter_type=e.extensions.rooter_type||"visual"),t.entity.name=e.name||"rooter",t}return u(e,i),e}(x_),G_=function(){function e(e){this.scene=null,this.entityIndex={},this.scene=e}var t=e.prototype;return t.loadEntities=function(e){var i=this;if(e.length){var n=[];e.forEach(function(e){var t=i.create(e);t&&n.push(t)}),(n=n.sort(function(e,t){return e.order===t.order?0:e.order<t.order?-1:1})).forEach(function(e){if(i.entityIndex[e.uuid]){var t=i.entityIndex[e.parent_uuid];t?t.addChild(e,!1,!0):i.scene.addChild(e,!1,!0)}})}rm.fire("edk:scene:entity:preload:end",this.scene.uuid,e)},t.get=function(e){return this.entityIndex[e]&&!this.entityIndex[e].deleted?this.entityIndex[e]:null},t.create=function(e){var t=null;switch(e.type){case"rooter":t=new N_(e,this.scene);break;case"particle":t=new U_(e,this.scene);break;case"light":t=new V_(e,this.scene);break;case"annotation":switch(e.extensions.annotation_type){default:case"text":t=new O_(e,this.scene);break;case"icon":case"product":t=new F_(e,this.scene);break;case"attach":t=new z_(e,this.scene);break;case"hidden":t=new L_(e,this.scene)}break;case"group":t=new B_(e,this.scene);break;case"model":switch(e.extensions.model_type){case"asset":t=new w_(e,this.scene);break;case"box":t=new S_(e,this.scene);break;case"capsule":t=new C_(e,this.scene);break;case"cone":t=new P_(e,this.scene);break;case"cylinder":t=new T_(e,this.scene);break;case"sphere":t=new A_(e,this.scene)}}return t&&(e.uuid=t.uuid,rm.fire("edk:scene:entity:create",this.scene.uuid,e,t)),t},t.addChild=function(e,t,i,n){void 0===n&&(n=!1),this.get(t)&&(this.get(e)?this.entityIndex[e].addChild(this.entityIndex[t],i,n):this.scene.addChild(this.entityIndex[t],i,n))},t.reparent=function(e,t,i){this.get(e)&&this.get(t)&&this.entityIndex[e].reparent(this.entityIndex[t],i)},t.destroy=function(){var t=this;Object.keys(this.entityIndex).forEach(function(e){t.entityIndex[e].destroy(),t.entityIndex[e]=null,delete t.entityIndex[e]}),this.entityIndex={},this.scene=null},e}(),W_=null,H_=function(){function e(){this.queue=[],(W_=this).currentQuantity=0,this.maximumQuantity=rm.call("edk:app:get:setting","requestMaximum")}var t=e.prototype;return t.add=function(e){this.queue.push(e),this.loadNext()},t.loadNext=function(){var t=this;if(0!==this.queue.length&&this.currentQuantity!==this.maximumQuantity){var e=this.queue.shift();e.resource||e.loading?this.loadNext():(this.currentQuantity++,e.once("load",function(){t.currentQuantity--,t.loadNext()}),e.once("error",function(e){t.currentQuantity--,t.loadNext()}),rm.assets.load(e))}},t.asyncPool=function(s,r,o){var l=0,h=[],c=[];return function e(){if(l===r.length)return Promise.resolve();var t=r[l++],i=Promise.resolve().then(function(){return o(t,r)});h.push(i);var n=i.then(function(){return c.splice(c.indexOf(n),1)});c.push(n);var a=Promise.resolve();return c.length>=s&&(a=Promise.race(c)),a.then(function(){return e()})}().then(function(){return Promise.all(h)})},t.destroy=function(){this.queue=[]},e}(),j_=function(){function e(e,t){void 0===e&&(e={}),this.type=null,this.scene=null,this.app=null,this.uuid="",this.parent_uuid="",this.name="",this.data={},this.preload=!1,this.asset=null,this.parent=null,this.deleted=!1,this.scene=t,this.app=rm.call("edk:app"),this.data=e.data,this.uuid=e.uuid||B(),this.parent_uuid=e.parent_uuid||null,this.preload=e.preload||!1,this.name=e.name||"",this.type=e.type||null,this.scene.resources.resourceIndex[this.uuid]||(this.scene.resources.resourceIndex[this.uuid]=this),Xy.resourceIndex[this.space_uuid]||(Xy.resourceIndex[this.space_uuid]=this)}var t=e.prototype;return t.remove=function(){var t=this;return new Promise(function(e){t.deleted=!0,e()})},t.load=function(){var t=this;return new Promise(function(e,i){t.asset?t.asset.loaded?e(t.asset):(t.asset.once("load",function(){e(t.asset)}),t.asset.once("error",function(e,t){i(e,t)}),rm.assets.load(t.asset)):i()})},t.destroy=function(){this.scene&&this.scene.resources.resourceIndex[this.uuid]&&delete this.scene.resources.resourceIndex[this.uuid],Xy.resourceIndex[this.space_uuid]&&delete Xy.resourceIndex[this.space_uuid],this.type=null,this.scene=null,this.name="",this.uuid=null,this.app=null,this.parent_uuid=null,this.preload=!1,this.deleted=!1,this.parent=null,this.data={}},c(e,[{key:"space_uuid",get:function(){return this.scene?this.scene.uuid+"_"+this.uuid:this.uuid}},{key:"space_parent_uuid",get:function(){return this.scene?this.scene.uuid+"_"+this.parent_uuid:this.parent_uuid}}]),e}(),X_=["validated","metal_detection","metal_detection_type"],q_=function(s){function r(e){var t,i;void 0===e&&(e={}),(i=s.apply(this,arguments)||this).textures={},i.cubemaps={};var n=r.clearData((null==(t=e)?void 0:t.data)||{}),a=i.validateData(Object.assign({},Xy.getDefaultResource("material"),n||{},{uuid:i.uuid,cubeMapProjectionBox:{center:[0,0,0],halfExtents:[.5,.5,.5]}}));return i.asset=new Kr(i.space_uuid,"material",null,a),rm.assets.add(i.asset),rm.assets.on("load:"+i.asset.id,i.onAssetLoad,g(i)),rm.assets.on("error:"+i.asset.id,i.onAssetError,g(i)),i.scene&&i.scene.on("edk:scene:resource:ready",i.onSceneResourceReady,g(i)),rm.on("edk:render:skybox:cubemap:update",i.onSkyboxChange,g(i)),i}u(r,s);var e=r.prototype;return e.onAssetLoad=function(){rm.fire("edk:scene:resource:ready",this.scene.uuid,this.uuid,this),rm.fire("edk:scene:resource:ready:"+this.space_uuid,this),this.scene&&(this.scene.fire("edk:scene:resource:ready",this.uuid,this),this.scene.fire("edk:scene:resource:ready:"+this.uuid,this))},e.onAssetError=function(){},e.onSkyboxChange=function(){this.asset&&this.asset.loaded&&this.asset.resource.update()},e.onSceneResourceReady=function(t){var i=this,e=[];this.textures[t]&&(e=this.textures[t]),this.cubemaps[t]&&(e=this.cubemaps[t]),e.length&&e.forEach(function(e){i.updateField(e,t).then(function(){var e;null==(e=i.asset.resource)||e.update()}),rm.fire("edk:scene:resource:update",i.scene.uuid,i.uuid,{type:"texture",field:e,value:t},i)})},e.validateData=function(n){var a=this;for(var e in Vg.forEach(function(e){if("string"==typeof n[e]&&!Qg[e]){var t=n[e],i=a.scene.resources.get(t);a.textures[t]?-1===a.textures[t].indexOf(e)&&a.textures[t].push(e):a.textures[t]=[e],i&&i.asset?n[e]=i.asset.id:n[e]=null}}),Ug.forEach(function(e){if("string"==typeof n[e]){var t=n[e],i=a.scene.resources.get(t);a.cubemaps[t]||(a.cubemaps[t]=[e]),i&&i.asset?n[e]=i.asset.id:n[e]=null}}),jg.forEach(function(e){n[e]instanceof Array&&4===n[e].length&&n[e].splice(3,1)}),Gg.forEach(function(e){var t=a.preproccess(e,n[e],n),i=t[0];t[1]||(n[e]=i)}),Wg.forEach(function(e){var t=a.preproccess(e,n[e],n),i=t[0];t[1]||(n[e]=i)}),void 0!==n.bumpMapFactor&&(n.bumpiness=n.bumpMapFactor,delete n.bumpMapFactor),delete n.chunks,delete n.mappingFormat,delete n._engine,delete n.metalnessTint,Ci){var t=e+"Map",i=t+"Uv",s=t+"MappingType";n[i]&&!n[s]&&(n[s]=n[i])}return n},e.preproccess=function(e,t,i){if(void 0===i&&(i=this.asset.resource),t instanceof Array&&(t=t.map(function(e){return NaN===e?0:e})),-1!==e.indexOf("MapTiling")&&-1===e.indexOf("MapTilingMode")){var n=[.5,.5],a=i[e.replace("Tiling","")+"MappingType"];a===i_.Box?(n[0]*=2,n[1]*=2):[i_.UV0,i_.UV1].includes(a)&&(n[0]=1,n[1]=1),t=[t[0]*n[0],t[1]*n[1]]}if(-1!==e.indexOf("MappingRotation")&&i[e.replace("MappingRotation","")+"MappingType"]===i_.Planar&&(t=[t[0],t[2],-t[1]]),-1!==e.indexOf("MappingScale")&&i[e.replace("MappingScale","")+"MappingType"]===i_.Planar&&(t=[t[0],t[2],t[1]]),-1!==e.indexOf("MappingTranslation")){var s=i[e.replace("MappingTranslation","")+"MappingType"];[i_.Planar].includes(s)&&(t=[t[0],t[2]+1,-t[1]])}return-1!==e.indexOf("GizmoPlanePosWS")&&i[e.replace("GizmoPlanePosWS","")+"MappingType"]===i_.Planar&&(t=[-t[0],-t[2],-t[1]]),[t,!1]},e.updateField=function(r,e){var o=this;if(X_.includes(r))return!1;var t=this.preproccess(r,e),l=t[0],h=t[1];return new Promise(function(t,e){if(o.asset.loaded&&!h)if(Kg[r]&&!Qg[r])if(l){var i=o.scene.resources.get(l);i?i.asset.loaded?(o.asset.resource[r]=i.asset.resource,t()):rm.call("edk:scene:resource:load",o.scene.uuid,l).then(function(){o.asset.resource[r]=i.asset.resource,t()}).catch(function(){e()}):(o.asset.resource[r]=null,t())}else o.asset.resource[r]=null,t();else if(Zg[r])if(l){var n=o.scene.resources.get(l);if(n)if(n.asset.loaded){if(o.asset.resource[r]=n.asset.resource,n.asset.resources&&7===n.asset.resources.length)for(var a=0;a<Ng.length;a++)o.asset.resource[Ng[a]]=n.asset.resources[a+1];t()}else rm.call("edk:scene:resource:load",o.scene.uuid,l).then(function(){if(o.asset.resource[r]=n.asset.resource,n.asset.resources&&7===n.asset.resources.length)for(var e=0;e<Ng.length;e++)o.asset.resource[Ng[e]]=n.asset.resources[e+1];t()}).catch(function(){e()});else t()}else{o.asset.resource[r]=null;for(var s=0;s<6;s++)o.asset.resource[Ng[s]]=null;t()}else-1!==jg.indexOf(r)?(o.asset.resource[r]=z($,l),t()):-1!==Gg.indexOf(r)?(3!==o.asset.resource.blendType||-1===qg.indexOf(r))&&(o.asset.resource[r]=z(J,l),t()):-1!==Wg.indexOf(r)?(o.asset.resource[r]=z(de,l),t()):-1!==Hg.indexOf(r)?(o.asset.resource[r]=l,o.asset.resource.update(),t()):-1!==$g.indexOf(r)||("blendType"===r&&(o.asset.resource[r]=l),(3!==o.asset.resource.blendType||-1===qg.indexOf(r))&&(o.asset.resource[r]=l,t()));else t()})},e.updateMaterialGizmoPlanePosWS=function(t){var i=this;Object.keys(Wi).filter(function(e){return-1!==e.indexOf("GizmoPlanePosWS")}).forEach(function(e){i.updateField(e,t instanceof de?[t.x,t.y,t.z]:t)}),null==this||this.asset.resource.update()},e.preUpdate=function(e,t,i){void 0===i&&(i=!0),e instanceof Object&&void 0!==e.blendType&&void 0!==e.opacity&&this.update("blendType",e.blendType,i)},e.update=function(n,a,s){var r=this;return void 0===s&&(s=!0),this.preUpdate(n,a,s),new Promise(function(e,t){var i;n instanceof Object?(Object.keys(n).forEach((i=o(__.mark(function e(t){return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.updateField(t,n[t],!1);case 2:case"end":return e.stop()}},e)})),function(e){return i.apply(this,arguments)})),s&&r.asset.resource.update(),e()):r.updateField(n,a).then(function(){s&&r.asset.resource.update(),e()}).catch(function(){t()})})},e.destroy=function(){s.prototype.destroy.call(this),this.asset&&(rm.assets.off("load:"+this.asset.id,this.onAssetLoad,this),rm.assets.off("error:"+this.asset.id,this.onAssetError,this),rm.assets.remove(this.asset),this.asset.unload()),rm.off("edk:scene:resource:ready",this.onSceneResourceReady,this),rm.off("edk:render:skybox:cubemap:update",this.onSkyboxChange,this),this.textures={},this.cubemaps={}},r}(j_);q_.clearData=function(e){var t=h({},e);return X_.forEach(function(e){return delete t[e]}),t};var $_,Y_,K_,Z_,Q_=function(n){function e(e){var t,i;return void 0===e&&(e={}),(i=n.apply(this,arguments)||this).JSON_ADDRESS_MODE={repeat:0,clamp:1,mirror:2},i.asset=new Kr(i.space_uuid,"texture",e.file||{url:s_(null==(t=e.data)?void 0:t.url)},e.data||{addressu:e.data.addressu||"repeat",addressv:e.data.addressv||"repeat",anisotropy:e.data.anisotropy||1,magfilter:e.data.magfilter||"linear",minfilter:e.data.minfilter||"linear_mip_linear",rgbm:void 0!==e.data.rgbm&&e.data.rgbm,mipmaps:void 0===e.data.mipmaps||e.data.mipmaps}),i.asset._name=i.name,rm.assets.add(i.asset),rm.assets.on("load:"+i.asset.id,i.onAssetLoad,g(i)),rm.assets.on("error:"+i.asset.id,i.onAssetError,g(i)),i}u(e,n);var t=e.prototype;return t.onAssetLoad=function(){rm.fire("edk:scene:resource:ready",this.scene.uuid,this.uuid,this),rm.fire("edk:scene:resource:ready:"+this.space_uuid,this),this.scene&&(this.scene.fire("edk:scene:resource:ready",this.uuid,this),this.scene.fire("edk:scene:resource:ready:"+this.uuid,this))},t.onAssetError=function(){},t.update=function(e,i){var n=this;switch(e){case"texture":return new Promise(function(e,t){i instanceof Image?n.asset.loaded?(n.asset.resource.setSource(i),e()):t():"string"==typeof i?(n.asset.once("load",function(){e()},n),n.asset.once("error",function(){e()},n),n.asset.file=Object.assign(n.asset.file,{url:s_(i)})):t()});case"addressu":this.asset.loaded&&this.asset.resource.addressU!==this.JSON_ADDRESS_MODE[i]&&(this.asset.resource.addressU=this.JSON_ADDRESS_MODE[i]);break;case"addressv":this.asset.loaded&&this.asset.resource.addressV!==this.JSON_ADDRESS_MODE[i]&&(this.asset.resource.addressV=this.JSON_ADDRESS_MODE[i]);break;case"mipmaps":this.asset.loaded&&this.asset.resource.mipmaps!==i&&(this.asset.resource.mipmaps=i,this.asset.resource.dirtyAll())}},t.destroy=function(){n.prototype.destroy.call(this),this.asset&&(rm.assets.off("load:"+this.asset.id,this.onAssetLoad,this),rm.assets.off("error:"+this.asset.id,this.onAssetError,this),rm.assets.remove(this.asset),this.asset.unload())},e}(j_),J_=function(n){function e(e){var t,i;return void 0===e&&(e={}),(i=n.apply(this,arguments)||this).mapping=[],i.materials={},i.meshInstances={},i.meshInstancesName=[],i.animations=[],i.validateData(e.data),i.asset=new Kr(i.space_uuid,"model",e.file||{url:s_(null==(t=e.data)?void 0:t.url)},e.data||{area:0,mapping:i.mapping}),i.asset._name=i.name,rm.assets.add(i.asset),rm.assets.on("load:"+i.asset.id,i.onAssetLoad,g(i)),rm.assets.on("error:"+i.asset.id,i.onAssetError,g(i)),i.scene&&i.scene.on("edk:scene:resource:ready",i.onSceneResourceReady,g(i)),i}u(e,n);var i,t=e.prototype;return t.onAssetLoad=function(){rm.fire("edk:scene:resource:ready",this.scene.uuid,this.uuid,this),rm.fire("edk:scene:resource:ready:"+this.space_uuid,this),this.scene&&(this.scene.fire("edk:scene:resource:ready",this.uuid,this),this.scene.fire("edk:scene:resource:ready:"+this.uuid,this))},t.onAssetError=function(){},t.onSceneResourceReady=function(){},t.validateData=function(e){var i=this;e.mapping&&this.update("mapping",e.mapping),e.animations&&(this.animations=[],e.animations.forEach(function(e){var t=new Kr(e.name,"animation",{url:s_(e.url)});i.animations.push(t.id),rm.assets.add(t)}))},t.update=(i=o(__.mark(function e(t,i){var n,a,s,r,o,l=this;return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t,e.next="replace"===e.t0?3:"mapping"===e.t0?4:35;break;case 3:return e.abrupt("return",new Promise(function(e,t){l.data=i,l.validateData(l.data),l.asset&&(l.asset.once("load",function(){rm.fire("edk:scene:resource:replace",l.scene.uuid,l.uuid,l),e(l.asset)}),l.asset.once("error",function(){t()}),l.asset.data={area:0,mapping:l.mapping},l.asset.file={url:s_(l.data.url)},l.animations.forEach(function(e){var t=rm.assets.get(e);l.app.requests.add(t)}))}));case 4:this.mapping=[],this.materials={},this.meshInstances={},this.meshInstancesName=[],n=0,a=_(i);case 10:if((s=a()).done){e.next=34;break}if(r=s.value,this.materials[r.name]={selected:r.resource,name:r.name,variables:[r.resource]},this.meshInstancesName[n]=r.name,this.meshInstances[r.name]?this.meshInstances[r.name].push(n):this.meshInstances[r.name]=[n],!(o=this.scene.resources.get(r.resource))){e.next=26;break}if(!o.loaded){e.next=21;break}this.mapping.push({material:o.asset.id}),e.next=24;break;case 21:return e.next=23,o.load();case 23:this.mapping.push({material:o.asset.id});case 24:e.next=30;break;case 26:return o=new q_({},this.scene),e.next=29,o.load();case 29:this.mapping.push({material:o.asset.id});case 30:this.asset&&this.asset.resource&&this.asset.resource.meshInstances&&this.asset.resource.meshInstances[n]&&o.asset&&o.asset.loaded&&(this.asset.resource.meshInstances[n].material=o.asset.resource),n++;case 32:e.next=10;break;case 34:case 35:return e.abrupt("break",36);case 36:case"end":return e.stop()}},e,this)})),function(e,t){return i.apply(this,arguments)}),t.updateMaterial=function(e,i){var n=this;this.meshInstances[e]&&this.meshInstances[e].forEach(function(e){var t=n.scene.resources.get(i);n.asset.resource.meshInstances[e].material=t?t.asset.resource:rm.scene.defaultMaterial})},t.destroy=function(){n.prototype.destroy.call(this),this.asset&&(rm.assets.off("load:"+this.asset.id,this.onAssetLoad,this),rm.assets.off("error:"+this.asset.id,this.onAssetError,this),rm.assets.remove(this.asset),this.asset.unload()),this.mapping=[],this.materials={},this.meshInstances={},this.meshInstancesName=[],this.animations.forEach(function(e){var t=rm.assets.get(e);t&&rm.assets.remove(t)}),this.animations=[]},e}(j_),ey=function(n){function e(e){var t,i;return void 0===e&&(e={}),(i=n.apply(this,arguments)||this).loadFaces=!1,i.partAssets=[],i.loadFaces=null==(t=e.data)?void 0:t.loadFaces,i.textures=[],i.initFaceTexture(e.data.texture,i.loadFaces),i.asset=new Kr(i.space_uuid,"cubemap",e.data.cubemap?{url:s_(e.data.cubemap)}:null,{anisotropy:1,magFilter:1,minFilter:5,rgbm:!0,textures:i.textures.map(function(e){return e.id})}),i.asset._name=i.name,i.asset.loadFaces=i.loadFaces,rm.assets.add(i.asset),rm.assets.on("load:"+i.asset.id,i.onAssetLoad,g(i)),rm.assets.on("error:"+i.asset.id,i.onAssetError,g(i)),i}u(e,n);var t,i=e.prototype;return i.onAssetLoad=function(e){var t=this;this.partAssets=rm.assets.filter(function(e){return-1!==e.name.indexOf(t.space_uuid+"_")}),rm.fire("edk:scene:resource:ready",this.scene.uuid,this.uuid,this),rm.fire("edk:scene:resource:ready:"+this.space_uuid,this),this.scene&&(this.scene.fire("edk:scene:resource:ready",this.uuid,this),this.scene.fire("edk:scene:resource:ready:"+this.uuid,this))},i.onAssetError=function(e,t){},i.initFaceTexture=function(i,n){var a=this;t_.forEach(function(e){if(i&&i[e]&&n){var t=new Kr(a.space_uuid+"_"+e,"texture",{url:s_(i[e])},{rgbm:!0,addressu:"repeat",addressv:"repeat",anisotropy:1,magfilter:"linear",minfilter:"linear_mip_linear",mipmaps:!0});rm.assets.add(t),a.textures.push(t)}})},i.loadFaceTexture=function(){var a=this;return new Promise(function(e,t){var i=0,n=function(){++i===a.textures.length&&e()};a.textures.forEach(function(e){e.loaded||(e.ready(n),rm.assets.load(e))})})},i.prefilterCubemap=(t=o(__.mark(function e(){var r=this;return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.asset.loaded){e.next=4;break}return e.abrupt("return",new Promise(function(n,e){for(var a=6,s=new Array(6),t=function(e,i){rm.assets._loader.load(e,"texture",function(e,t){e||t&&(s[i]=t),0==--a&&function(){var e=new Kt(rm.graphicsDevice,{cubemap:!0,rgbm:!1,fixCubemapSeams:!0,format:s[0].format,width:s[0].width,height:s[0].height});e.addressU=1,e.addressV=1,e._levels[0]=s.map(function(e){return e._levels[0]});var t={device:rm.graphicsDevice,sourceCubemap:e,method:1,samples:4096,cpuSync:!0,filteredFixed:[],filteredFixedRgbm:[],singleFilteredFixedRgbm:!0};Bm(t),n(t.singleFilteredFixedRgbm.getDds())}()})},i=0;i<r.textures.length;i++)r.textures[i]&&t(r.swapExtension(r.textures[i].getFileUrl(),".png",".DDS"),i)}));case 4:return e.abrupt("return",new Promise.reject);case 5:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)}),i.swapExtension=function(e,t,i){for(;0<=e.indexOf(t);)e=e.replace(t,i);return e},i.update=function(i,n){var a=this;return new Promise(function(e,t){switch(i){case"texture":a.textures.length||(a.initFaceTexture(n,!0),a.loadFaceTexture().then(function(){a.asset.data={anisotropy:1,magFilter:1,minFilter:5,rgbm:!0,textures:a.textures.map(function(e){return e.id})},e()}).catch(function(){t()}));break;case"cubemap":a.asset.loaded&&(a.asset.file={url:s_(n)})}})},i.destroy=function(){n.prototype.destroy.call(this),this.asset&&(rm.assets.off("load:"+this.asset.id,this.onAssetLoad,this),rm.assets.off("error:"+this.asset.id,this.onAssetError,this),rm.assets.remove(this.asset),this.asset.unload(),this.asset.off(),this.partAssets.length&&(this.partAssets.forEach(function(e){rm.assets.remove(e),e.unload(),e.off()}),this.partAssets=[])),this.textures=[]},e}(j_),ty=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).type="folder",e.children=[],e}u(e,t);var i=e.prototype;return i.reparent=function(e,t){e.uuid!==this.uuid&&(this.parent&&this.parent.removeChild(this.uuid),this.parent=e,this.parent_uuid=e.uuid,this.parent.addChild(this,t))},i.addChild=function(e,t){void 0===t&&(t=!1),this.children.push(e),e.parent=this,e.parent_uuid=this.uuid,t&&rm.fire("edk:scene:resource:add:child",this.scene.uuid,this.uuid,e.uuid)},i.removeChild=function(e){for(var t=-1,i=0;i<this.children.length;i++)if(this.children[i].uuid===e){t=i;break}-1!==t&&this.children.splice(t,1)},i.load=function(){var t=this;return new Promise(function(e){e(t)})},i.destroy=function(){t.prototype.destroy.call(this),this.parent=null,this.children=[]},e}(j_),iy=function(){function e(e){this.length=e,this.count=0,this.aborted=0,this.successful=0}var t=e.prototype;return t.inc=function(e){this.count++,e?this.successful++:this.aborted++},t.done=function(){return this.count===this.length},c(e,[{key:"progress",get:function(){return this.length?this.count/this.length:0}}]),e}(),ny=function(){function e(e){this.resourceIndex={},this.scene=e,this.materialValidator=new Ko}var t=e.prototype;return t.loadResources=function(s){var r=this,e=s.filter(function(e){return"folder"===e.type});!function i(n){e.filter(function(e){return e.parent_uuid===n&&"folder"===e.type}).forEach(function(e){if(e.parent_uuid===n){var t=r.create(e);t.parent_uuid&&r.resourceIndex[t.parent_uuid]&&r.resourceIndex[t.parent_uuid].addChild(t,!0),i(e.uuid)}})}(null),["material","texture","cubemap","model"].forEach(function(t){for(var e,i=_(s.filter(function(e){return e.type===t}));!(e=i()).done;){var n=e.value,a=r.create(n);a.parent_uuid&&r.resourceIndex[a.parent_uuid]&&r.resourceIndex[a.parent_uuid].addChild(a,!0)}}),this.preload()},t.preload=function(e){var t,i=this,n=!1,a=rm.call("edk:app:get:setting","requestThrottle");rm.fire("edk:scene:resource:preload:start",this.scene.uuid);var s=this.resourceList.filter(function(e){return e.preload&&"folder"!==e.type}),r=new iy(s.length),o=function(){!n&&r.done()&&(n=!0,rm.fire("edk:scene:resource:preload:end",i.scene.uuid),e&&e())};if(r.length){var l=function(e){r.inc(!0),rm.fire("edk:scene:resource:preload:progress",i.scene.uuid,r),r.done()&&o()},h=function(e,t){r.inc(),rm.fire("edk:scene:resource:preload:progress",i.scene.uuid,r),r.done()&&o()};for(t=0;t<s.length;t++)s[t].asset?s[t].asset.loaded?(r.inc(!0),r.done()&&o()):(s[t].asset.once("load",l),s[t].asset.once("error",h),W_&&a?W_.add(s[t].asset):rm.assets.load(s[t].asset)):(r.inc(),rm.fire("edk:scene:resource:preload:progress",this.scene.uuid,r),r.done()&&o())}else o()},t.create=function(e){var t=null;switch(e.type){case"folder":t=new ty(e,this.scene);break;case"cubemap":t=new ey(e,this.scene);break;case"material":this.materialValidator.validate(q_.clearData(e.data)),t=new q_(e,this.scene);break;case"texture":t=new Q_(e,this.scene);break;case"model":t=new J_(e,this.scene)}return t?(e.uuid=t.uuid,rm.fire("edk:scene:resource:create",this.scene.uuid,e,t),t):null},t.addChild=function(e,t,i){void 0===i&&(i=!1),this.resourceIndex[e]&&this.resourceIndex[t]&&this.resourceIndex[e].addChild(this.resourceIndex[t],i)},t.get=function(e){return this.resourceIndex[e]&&!this.resourceIndex[e].deleted?this.resourceIndex[e]:null},t.destroy=function(){var t=this;this.scene=null,Object.keys(this.resourceIndex).forEach(function(e){t.resourceIndex[e].destroy(),t.resourceIndex[e]=null,delete t.resourceIndex[e]}),this.resourceIndex={}},c(e,[{key:"resourceList",get:function(){var t=this;return Object.keys(this.resourceIndex).map(function(e){return t.resourceIndex[e]})}}]),e}(),ay=0,sy=1e3,ry=1,oy=2,ly=3,hy=4,cy=5,uy=8,dy=6,py=7,fy=12,my=19,vy=20,gy=21,_y=22,yy=23,by=24,xy=25,My=function(){function e(e,t,i){this.scene=null,this.interaction=null,this.enabled=!0,this.name=null,this.uuid=null,this.parent_uuid=null,this.attach={type:0,uuid:""},this.time={},this.data={},this.children=[],this.status=0,this.scene=t,this.interaction=i}var t=e.prototype;return t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):void 0!==this[t]&&(this[t]=e instanceof Object?Object.assign(this[t],e):e)},t.execEvent=function(){},t.stopEvent=function(){},t.reverseEvent=function(){},t.execUpdate=function(){},t.destroy=function(){this.enabled=!1,this.interaction&&this.uuid&&delete this.interaction.data[this.uuid],this.interaction=null,this.scene=null,this.name=null,this.uuid=null,this.parent_uuid=null,this.attach={},this.time={},this.data={},this.children=[],this.status=2},e}(),Sy=function(){function e(e,t,i,n){this.scene=null,this.root=null,this.interaction=null,this._event=null,this._time=0,this._complete=!1,this._switch=!1,this.name=null,this.enabled=!0,this.uuid=null,this.parent_uuid=null,this.event=null,this.order=0,this.status=0,this.time={length:.12,reverse:!1,start:.01},this.attach={type:0,uuid:""},this.data={},this.scene=t,this.interaction=i,this.root=n,this.update(e)}var t=e.prototype;return t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):void 0!==this[t]&&(this[t]=e instanceof Object?Object.assign(this[t],e):e)},t.updateTrack=function(e,t){if(this._event||(this._event=this.interaction.data[this.event],this._switch=this._event&&"switch"===this._event.time.type),this._event&&this._event.attach&&this._event.attach.uuid){var i=this.time.start,n=this._switch?this.time.start:this.time.start+this.time.length;(this.root._reverse?e<=n:i<=e)&&(this._switch?this.root._reverse?this.reverseEvent(t):this.execEvent(t):this.updateEvent(t))}else this.status=2},t.execEvent=function(){switch(this.status){case 0:this.status=2,this._event.run(!1)}},t.reverseEvent=function(){switch(this.status){case 0:this.status=2,this.time.reverse&&this._event.run(!0)}},t.updateEvent=function(e){if(0===this.status&&(this.root._reverse?this._time=this.time.length:this._time=0,this._complete=!1,this.status=1,this._event.recordEvent(this.uuid)),2!==this.status)if(this.root._reverse?this._time-=e:this._time+=e,(!this.root._reverse&&this._time>this.time.length||this.root._reverse&&this._time<0)&&(this._complete=!0),this._complete)this.stopEvent();else{var t=this._time/this.time.length;this._event.run(t,this.uuid)}},t.stopEvent=function(){2!==this.status&&(this._event.run(1,this.uuid),this._event.clear(this.uuid),this.status=2)},t.execUpdate=function(){},t.destroy=function(){this.scene=null,this._event&&this._event.destroy(),this._event=null,this._time=0,this._complete=!1,this._switch=!1,this.name=null,this.enabled=!1,this.uuid=null,this.parent_uuid=null,this.event=null,this.order=0,this.root=null,this.status=2,this.time={},this.attach={},this.data={}},e}(),wy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).type=ay,t.tracks=[],t._children=[],t.time={},t.duration=0,t.playing=!1,t.stopped=!0,t.complete=!1,t.pending=!1,t.loop=!1,t.yoyo=!1,t._time=0,t._timeScale=1,t._count=0,t._reverse=!1,t._numRepeats=0,t._delay=!1,t._timeOut=!1,t._endedCount=0,t.update(e),t.initChildren(e),t.interaction.data[t.uuid]=g(t),t}u(e,i);var t=e.prototype;return t.initChildren=function(e){var t=this;e&&e.children&&e.children.length&&e.children.forEach(function(e){t._children.push(new Sy(e,t.scene,t.interaction,t))})},t.run=function(e){void 0===e&&(e=!1),this.playing?(this.updateStatus(0,!0),this._reverse=e):(this._reverse=!!e,this.start())},t.updateStatus=function(t,i){void 0===i&&(i=!1),this._children.forEach(function(e){i?e.enabled&&2===e.status&&(e.status=t):e.enabled&&(e.status=t)})},t.start=function(){this.tracks=this._children.filter(function(e){return e.enabled}),this.updateStatus(0),this.playing=!0,this.complete=!1,this.stopped=!1,this._count=0,this._timeOut=!1,this.pending=this.data.delay&&0<this.data.delay,this.duration=this.time.length,this.yoyo=this.data.yoyo||!1,this.loop=this.data.loop||!1,this.loop?this._numRepeats=1/0:this._numRepeats=this.data.repeat||0,this._reverse&&!this.pending?this._time=this.duration:this._time=0},t.pause=function(){this.playing=!1},t.resume=function(){this.playing=!0},t.stop=function(){this.playing=!1,this.stopped=!0,this._reverse?this._time=this.duration:this._time=0,this.tracks.length&&this.updateStatus(2)},t.reverse=function(){this._reverse=!this._reverse},t.delay=function(e){return this._delay=e,this.pending=!0,this},t.execUpdate=function(e){if(this.stopped)return!1;if(!this.playing)return!0;if(!this._reverse||this.pending?this._time+=e*this._timeScale:this._time-=e*this._timeScale,this.pending){if(!(this._time>this.data.delay))return!0;this._reverse?this._time=this.duration:this._time=0,this.pending=!1}if((!this._reverse&&this._time>this.duration||this._reverse&&this._time<0)&&(this._timeOut=!0),this._endedCount=this.tracks.filter(function(e){return 2===e.status}).length,(this.loop||0!==this._numRepeats?this._timeOut&&this._endedCount===this.tracks.length:this._endedCount===this.tracks.length)&&(this._count++,this.complete=!0,this.playing=!1),this.complete){var t=this._repeat();return t?(this.updateStatus(0),rm.fire("edk:scene:interaction:timeline:loop",this.scene.uuid,this.uuid)):(this.stop(),rm.fire("edk:scene:interaction:timeline:stop",this.scene.uuid,this.uuid)),t}for(var i,n=_(this.tracks);!(i=n()).done;)i.value.updateTrack(this._time,e);return!0},t._repeat=function(){return this._count<this._numRepeats&&(this.yoyo&&(rm.fire("edk:scene:interaction:timeline:yoyo",this.scene.uuid,this.uuid),this.reverse()),this._reverse?this._time=this.duration:this._time=0,this.complete=!1,this.stopped=!1,this.playing=!0,!(this._timeOut=!1))},t.destroy=function(){i.prototype.destroy.call(this),this.tracks=[],this._children.forEach(function(e){e.destroy()}),this._children=[],this.duration=0,this.playing=!1,this.stopped=!0,this.complete=!1,this.pending=!1,this.loop=!1,this.yoyo=!1,this._time=0,this._count=0,this._reverse=!1,this._numRepeats=0,this._delay=!1,this._timeOut=!1,this._endedCount=0},e}(My),Cy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).type=sy,t.children=[],t.update(e),t.interaction.data[t.uuid]=g(t),t}u(e,i);var t=e.prototype;return t.addChild=function(e,t){void 0===t&&(t=!1),this.children.push(e),e.parent=this,t&&rm.fire("edk:scene:interaction:add:child",this.scene.uuid,this.uuid,e.uuid)},t.get=function(t){return this.children.find(function(e){return e.uuid===t})},t.replace=function(t){var e=this.children.findIndex(function(e){return e.uuid===t.uuid});-1!==e&&((t.parent=this).children[e]=t)},t.remove=function(t){var e=this.children.findIndex(function(e){return e.uuid===t});-1!==e&&(this.selected===t&&(this.selected=null),this.children.splice(e,1))},e}(My),Py=function(){function e(e,t,i){this.scene=null,this.interaction=null,this.type=1,this.name=null,this.uuid=null,this.parent_uuid=null,this.attach={type:0,uuid:""},this.time={type:"tween"},this.data={},this.origin={},this.buffer={},this.target={},this.uuid=e.uuid,this.scene=t,this.interaction=i,this.parent_uuid=e.parent_uuid,this.interaction.data[this.uuid]=this}var t=e.prototype;return t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):void 0!==this[t]&&(this[t]=e instanceof Object?Object.assign(this[t],e):e)},t.run=function(){if(this.attach.uuid)if("switch"===this.time.type){arguments[0]?this.reverseEvent():this.execEvent()}else if("tween"===this.time.type){var e=arguments[0],t=arguments[1];this.origin[t]&&this.execUpdate(e,t)}},t.clear=function(e){this.origin[e]&&(this.origin[e]=null,delete this.origin[e]),this.buffer[e]&&(this.buffer[e]=null,delete this.buffer[e]),this.target[e]&&(this.target[e]=null,delete this.target[e])},t.destroy=function(){var t=this;this.origin&&Object.keys(this.origin).forEach(function(e){t.origin[e]=null,delete t.origin[e]}),this.origin={},this.buffer&&Object.keys(this.buffer).forEach(function(e){t.buffer[e]=null,delete t.buffer[e]}),this.buffer={},this.target&&Object.keys(this.target).forEach(function(e){t.target[e]=null,delete t.target[e]}),this.target={},this.name=null,this.uuid=null,this.parent_uuid=null,this.attach=null,this.time=null,this.data=null,this.scene=null,this.interaction=null,this.entity&&(this.entity=null)},t.recordEvent=function(){},t.execEvent=function(){},t.reverseEvent=function(){},t.execUpdate=function(){},e}(),Ty=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={enabled:!1},t.update(e),t}u(e,i);var t=e.prototype;return t.execEvent=function(){Xy&&Xy.updateEntity(this.scene.uuid,this.attach.uuid,"enabled",this.data.enabled)},t.reverseEvent=function(){Xy&&Xy.updateEntity(this.scene.uuid,this.attach.uuid,"enabled",!this.data.enabled)},e}(Py),Ay=function e(t,i,n,a){var s,r,o=Se.clamp(a,0,1);for(var l in i)if(i.hasOwnProperty(l)&&t.hasOwnProperty(l))if(s=t[l],r=i[l],s instanceof J||s instanceof de||s instanceof ee||s instanceof $)n[l].lerp(s,r,o);else if(s instanceof fe)n[l].slerp(s,r,o);else if(s instanceof Array){if(s instanceof Array&&r instanceof Array){n[l]||(n[l]=new Array(s.length));for(var h=0;h<s.length;h++)void 0!==s[h]&&void 0!==r[h]&&(n[l][h]=Se.lerp(s[h],r[h],o))}}else if("object"==(void 0===s?"undefined":dx(s)))for(var c in s)s.hasOwnProperty(c)&&r.hasOwnProperty(l)&&e(s[c],r[c],n[l][c],o);else"number"==typeof s&&(n[l]=Se.lerp(s,r,o))},Ey=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},t.rotationSegments=[],t.rotationSegmentNum=1,t.rotationSegmentMaxLen=180,t.rotationOrigin=new fe,t.rotationBuffer=new fe,t.rotationTarget=new fe,t.update(e),t}u(e,i);var t=e.prototype;return t.execEvent=function(){!this.entity&&this.attach.uuid&&(this.entity=this.scene.entities.get(this.attach.uuid)),this.entity&&this.entity.setCurrentParams(this.data)},t.execRotationSegment=function(e,t){for(var i=[],n=0;n<3;n++)i.push(Math.abs(t[n]-e[n]));var a=Math.max.apply(Math,i);a>this.rotationSegmentMaxLen&&(this.rotationSegmentNum=Math.floor(a/this.rotationSegmentMaxLen)+1);var s=(t[0]-e[0])/this.rotationSegmentNum,r=(t[1]-e[1])/this.rotationSegmentNum,o=(t[2]-e[2])/this.rotationSegmentNum;this.rotationSegments=[];for(var l=0;l<this.rotationSegmentNum;l++)this.rotationSegments.push({origin:{x:e[0]+s*l,y:e[1]+r*l,z:e[2]+o*l},target:{x:e[0]+s*(l+1),y:e[1]+r*(l+1),z:e[2]+o*(l+1)}})},t.recordEvent=function(e){!this.entity&&this.attach.uuid&&(this.entity=this.scene.entities.get(this.attach.uuid)),e&&this.entity&&(this.origin[e]=this.entity.getCurrentParams(),this.buffer[e]=JSON.parse(JSON.stringify(this.origin[e])),this.target[e]=JSON.parse(JSON.stringify(this.data)),this.execRotationSegment(this.origin[e].rotation,this.target[e].rotation),delete this.origin[e].rotation,delete this.target[e].rotation,delete this.buffer[e].rotation)},t.execUpdate=function(e,t){if(this.entity&&this.origin[t]&&this.buffer[t]&&this.target[t]){Ay(this.origin[t],this.target[t],this.buffer[t],e);var i=Math.floor(e*this.rotationSegmentNum),n=e*this.rotationSegmentNum-parseInt(e*this.rotationSegmentNum);if(this.rotationSegments[i]){var a=this.rotationSegments[i].origin,s=this.rotationSegments[i].target;this.rotationOrigin.setFromEulerAngles(a.x,a.y,a.z),this.rotationTarget.setFromEulerAngles(s.x,s.y,s.z),this.rotationBuffer.slerp(this.rotationOrigin,this.rotationTarget,Se.clamp(n,0,1))}else{var r;(r=this.rotationBuffer).setFromEulerAngles.apply(r,this.data.rotation)}this.buffer[t].rotation=this.rotationBuffer,this.entity.setCurrentParams(this.buffer[t],!0)}},e}(Py),Ry=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={enabled:!1,size:[0,0,0],unit:"cm",color:[.4,.4,.4,.8],thickness:.1},t.update(e),t}u(e,i);var t=e.prototype;return t.execEvent=function(){Xy&&Xy.updateEntity(this.scene.uuid,this.attach.uuid,"sizer",this.data)},t.reverseEvent=function(){var e=JSON.parse(JSON.stringify(this.data));e.enabled=!e.enabled,Xy&&Xy.updateEntity(this.scene.uuid,this.attach.uuid,"sizer",e)},e}(Py),Dy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={materials:{}},t.delta=0,t.update(e),t}u(e,i);var t=e.prototype;return t.execEvent=function(){var t=this;!this.entity&&this.attach.uuid&&(this.entity=this.scene.entities.get(this.attach.uuid)),this.entity&&Object.keys(this.data.materials).forEach(function(e){t.data.materials[e]&&Xy&&Xy.updateEntityMaterial(t.scene.uuid,t.attach.uuid,e,t.data.materials[e])})},t.recordEvent=function(n){var a=this;!this.entity&&this.attach.uuid&&(this.entity=this.scene.entities.get(this.attach.uuid)),n&&this.entity&&Object.keys(this.data.materials).forEach(function(e){a.origin[n]||(a.origin[n]={}),a.buffer[n]||(a.buffer[n]={}),a.target[n]||(a.target[n]={});var t=a.scene.resources.get(a.data.materials[e]),i=a.entity.getMaterial(e);i&&t&&t.asset.resource&&(a.origin[n][e]=i,a.buffer[n][e]=i.clone(),a.target[n][e]=t.asset.resource,Xy&&Xy.updateEntityMaterial(a.scene.uuid,a.attach.uuid,e,a.buffer[n][e]))})},t.execUpdate=function(t,i){var n=this;this.entity&&Object.keys(this.data.materials).forEach(function(e){n.origin[i][e]&&n.buffer[i][e]&&n.target[i][e]&&(n.delta=t,function(e,t,i,n){var a,s,r=Se.clamp(n,0,1);for(var o in Wi)if(Wi.hasOwnProperty(o))switch(a=e[o],s=t[o],Wi[o]){case"vec2":a instanceof J&&s instanceof J&&!a.equals(s)&&i[o].lerp(a,s,r);break;case"rgb":a instanceof $&&s instanceof $&&a.toString()!==s.toString()&&i[o].lerp(a,s,r);break;case"number":a!==s&&(-1===o.indexOf("Uv")?i[o]=Se.lerp(a,s,r):i[o]=s);break;case"boolean":case"enum:blendType":a!==s&&(i[o]=s);break;case"texture":case"chunks":case"cubemap":case"enum:cull":case"enum:occludeSpecular":case"enum:shadingModel":a!==s&&(i[o]=1===r?s:a);break;case"boundingbox":a instanceof ue&&s instanceof ue&&(i[o]instanceof ue||(i[o]=new ue(a.center,a.halfExtents)),a.center.equals(s.center)||i[o].center.lerp(a.center,s.center,r),a.halfExtents.equals(s.halfExtents)||i[o].halfExtents.lerp(a.halfExtents,s.halfExtents,r));break;default:a!==s&&(i[o]=1===r?s:a)}}(n.origin[i][e],n.target[i][e],n.buffer[i][e],t),n.buffer[i][e].update())})},t.clear=function(t){var i=this;Object.keys(this.data.materials).forEach(function(e){i.origin[t]&&i.origin[t][e]&&0===i.delta&&(Xy&&Xy.updateEntityMaterial(i.scene.uuid,i.attach.uuid,e,i.origin[t][e]),i.buffer[t][e]&&i.buffer[t][e].destroy&&i.buffer[t][e].destroy(),i.buffer[t][e]=null,i.origin[t][e]=null,i.target[t][e]=null),i.target[t]&&i.target[t][e]&&1===i.delta&&(Xy&&Xy.updateEntityMaterial(i.scene.uuid,i.attach.uuid,e,i.target[t][e]),i.buffer[t][e]&&i.buffer[t][e].destroy&&i.buffer[t][e].destroy(),i.buffer[t][e]=null,i.origin[t][e]=null,i.target[t][e]=null)}),0!==this.delta&&1!==this.delta||(this.origin[t]&&(this.origin[t]=null,delete this.origin[t]),this.buffer[t]&&(this.buffer[t]=null,delete this.buffer[t]),this.target[t]&&(this.target[t]=null,delete this.target[t]))},t.destroy=function(){var i=this;this.origin&&Object.keys(this.origin).forEach(function(e){i.origin[e]=null,delete i.origin[e]}),this.origin={},this.buffer&&Object.keys(this.buffer).forEach(function(t){Object.keys(i.data.materials).forEach(function(e){i.buffer[t][e]&&i.buffer[t][e].destroy&&i.buffer[t][e].destroy()}),i.buffer[t]=null,delete i.buffer[t]}),this.buffer={},this.target&&Object.keys(this.target).forEach(function(e){i.target[e]=null,delete i.target[e]}),this.target={},this.name=null,this.uuid=null,this.parent_uuid=null,this.attach=null,this.time=null,this.data=null,this.scene=null,this.interaction=null,this.entity&&(this.entity=null)},e}(Py),Iy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={animation:null,loop:!1,duration:0,tween:"duration",lerp:!0,status:"play",speed:1},t.update(e),t}u(e,i);var t=e.prototype;return t.execEvent=function(){if(!this.entity&&this.attach.uuid&&(this.entity=this.scene.entities.get(this.attach.uuid)),this.entity&&this.data.loop&&this.data.loop){var e={lerp:void 0===this.data.lerp||this.data.lerp,speed:void 0!==this.data.speed?this.data.speed:1};"play"===this.data.status&&(e.currAnim=this.data.animation,e.playing=!0),"stop"===this.data.status&&(e.currAnim=this.data.animation,e.currentTime=0,e.playing=!1),"pause"===this.data.status&&(e.playing=!1),"resume"===this.data.status&&(e.playing=!0),this.entity.setAnimation(e)}},t.recordEvent=function(e){if(!this.entity&&this.attach.uuid&&(this.entity=this.scene.entities.get(this.attach.uuid)),e&&this.entity&&this.data.animation)if("speed"===this.data.tween)this.entity.setAnimation({currAnim:this.data.animation,playing:!1}),this.origin[e]={playing:!0,speed:0},this.buffer[e]={playing:!0,speed:0},this.target[e]={playing:!0,speed:this.data.speed?this.data.speed:1};else{this.entity.setAnimation({lerp:void 0===this.data.lerp||this.data.lerp,speed:void 0!==this.data.speed?this.data.speed:1,currAnim:this.data.animation,playing:!1});var t=this.entity.getAnimation("duration",this.data.animation);t&&(this.origin[e]={currentTime:0},this.buffer[e]={currentTime:0},this.target[e]={currentTime:t-1e-12})}},t.execUpdate=function(e,t){this.entity&&this.origin[t]&&this.buffer[t]&&this.target[t]&&(Ay(this.origin[t],this.target[t],this.buffer[t],e),this.entity.setAnimation(this.buffer[t]))},e}(Py),ky=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={color:[1,1,1,1],intensity:1},t.update(e),t}u(e,i);var t=e.prototype;return t.execEvent=function(){!this.entity&&this.attach.uuid&&(this.entity=this.scene.entities.get(this.attach.uuid)),this.entity&&Xy&&Xy.updateEntity(this.scene.uuid,this.attach.uuid,this.data)},t.recordEvent=function(e){!this.entity&&this.attach.uuid&&(this.entity=this.scene.entities.get(this.attach.uuid)),e&&this.entity&&(this.origin[e]=this.entity.getCurrentParams(),this.buffer[e]=JSON.parse(JSON.stringify(this.origin[e])),this.target[e]=this.data)},t.execUpdate=function(e,t){this.entity&&this.origin[t]&&this.buffer[t]&&this.target[t]&&(Ay(this.origin[t],this.target[t],this.buffer[t],e),Xy&&Xy.updateEntity(this.scene.uuid,this.attach.uuid,this.buffer[t]))},e}(Py),Ly=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).camera=null,e.camera=rm.call("edk:render:camera:get"),e.camera||rm.on("edk:render:camera:change",e.updateCamera,g(e)),e}u(e,t);var i=e.prototype;return i.updateCamera=function(e){this.camera=e},i.destroy=function(){t.prototype.destroy.call(this),this.camera=null},e}(Py),Oy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={end:{distance:0,pitch:0,pivot:[0,0,0],yaw:0}},t.update(e),t}u(e,i);var t=e.prototype;return t.execEvent=function(){this.camera&&this.camera.setCurrentParams(this.data.end)},t.recordEvent=function(e){if(e&&this.camera&&(this.origin[e]=this.camera.getCurrentParams(),this.buffer[e]=JSON.parse(JSON.stringify(this.origin[e])),this.target[e]=JSON.parse(JSON.stringify(this.data.end)),this.data.nearest)){var t=this.origin[e].yaw,i=this.target[e].yaw,n=(i=(i+360)%360)-(t=(t+360)%360),a=-n/Math.abs(n)*(360-Math.abs(n));i=t+(Math.abs(n)>Math.abs(a)?a:n),this.origin[e].yaw=t,this.target[e].yaw=i}},t.execUpdate=function(e,t){this.camera&&this.origin[t]&&this.buffer[t]&&this.target[t]&&(Ay(this.origin[t],this.target[t],this.buffer[t],e),this.camera.setCurrentParams(this.buffer[t]))},e}(Ly),Fy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={start:{distance:0,pitch:0,pivot:[0,0,0],yaw:0},end:{distance:0,pitch:0,pivot:[0,0,0],yaw:0}},t.update(e),t}u(e,i);var t=e.prototype;return t.recordEvent=function(e){e&&this.camera&&(this.origin[e]=this.data.start,this.buffer[e]=JSON.parse(JSON.stringify(this.origin[e])),this.target[e]=this.data.end)},t.execUpdate=function(e,t){this.camera&&this.origin[t]&&this.buffer[t]&&this.target[t]&&(Ay(this.origin[t],this.target[t],this.buffer[t],e),this.camera.setCurrentParams(this.buffer[t]))},e}(Ly),zy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={enabled:!1},t.update(e),t}u(e,i);var t=e.prototype;return t.execEvent=function(){this.camera&&this.camera.update("autoRotate",this.data.enabled)},t.reverseEvent=function(){this.camera&&this.camera.update("autoRotate",!this.data.enabled)},e}(Ly),By=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={enabled:!1},t.update(e),t}u(e,i);var t=e.prototype;return t.execEvent=function(){this.camera&&this.camera.update("disablePivot",this.data.enabled)},t.reverseEvent=function(){this.camera&&this.camera.update("disablePivot",!this.data.enabled)},e}(Ly),Vy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={enabled:!1,fov:45,fovMax:0,fovMin:0},t.update(e),t}return u(e,i),e.prototype.execEvent=function(){this.camera&&(this.camera.update("reverseOrbit",this.data.enabled),this.camera.update({fov:this.data.fov||45,fovMax:this.data.fovMax||0,fovMin:this.data.fovMin||0}))},e}(Ly),Uy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={clearColor:[.722,.722,.722,1],fov:45,pitchAngleMax:90,pitchAngleMin:-90,distanceMax:0,distanceMin:0},t.update(e),t}return u(e,i),e.prototype.execEvent=function(){this.camera&&this.camera.update(this.data)},e}(Ly),Ny=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={end:{pitch:0,position:[0,0,0],yaw:0,fpsHeight:1.6},ground:[],speed:1,enabled:!1,fpsHeightMax:1/0,fpsHeightMin:.1},t.update(e),t}u(e,i);var t=e.prototype;return t.updateConfig=function(){var i=this,e=this.data,t=e.ground,n=e.speed,a=e.fpsHeightMax,s=e.fpsHeightMin;this.camera.update({ground:t.map(function(e){var t=e.uuid;return rm.call("edk:scene:entity:get",i.scene.uuid,t).entity}),speed:n,fpsHeightMax:a||1/0,fpsHeightMin:s||1/0})},t.execEvent=function(){this.camera&&(this.data.enabled?("fps"!==this.camera.camera_type&&this.camera.onSwitchCameraType(),this.updateConfig(),this.camera.setCurrentParams(this.data.end)):"fps"===this.camera.camera_type&&this.camera.onSwitchCameraType())},e}(Ly),Gy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={start:{numParticles:0,intensity:0},end:{numParticles:0,intensity:0}},t.entity=null,t.update(e),t}u(e,i);var t=e.prototype;return t.recordEvent=function(e){!this.entity&&this.attach.uuid&&(this.entity=this.scene.entities.get(this.attach.uuid)),e&&this.entity&&(this.origin[e]=this.data.start,this.buffer[e]=JSON.parse(JSON.stringify(this.origin[e])),this.target[e]=this.data.end)},t.execUpdate=function(e,t){this.entity&&this.origin[t]&&this.buffer[t]&&this.target[t]&&(Ay(this.origin[t],this.target[t],this.buffer[t],e),this.entity.setCurrentParams(this.buffer[t]))},e}(Py),Wy=function(i){function e(e){var t;return(t=i.apply(this,arguments)||this).data={color:[0,0,0],cubemap:null,transparent:!1,intensity:1,mip:0},t.update(e),t}return u(e,i),e.prototype.execEvent=function(){$y&&$y.update(this.data)},e}(Py),Hy=function(){function e(e){this.scene=null,this.data={},this.collections=[],this.running=[],this.scene=e}var t=e.prototype;return t.loadInteractions=function(e){var a=this;if(e.length){var t=e.filter(function(e){return e.type===sy});!function i(n){t.filter(function(e){return e.parent_uuid===n&&e.type===sy}).forEach(function(e){if(e.parent_uuid===n){var t=a.create(e);t.parent_uuid&&a.data[t.parent_uuid]&&a.data[t.parent_uuid].addChild(t,!0),i(e.uuid)}})}(null),e.filter(function(e){return e.type!==sy}).forEach(function(e){var t=a.create(e);if(t){e.type===ay&&a.collections.push(t);var i=a.data[t.parent_uuid];i&&i.addChild(t,!0)}}),rm.on("update",this.onUpdate,this)}},t.record=function(){var e=Array.from(arguments),t=e.shift(),i=this.data[t];i&&i.type!==sy&&i.type!==ay&&i.recordEvent.apply(i,e)},t.run=function(){var e=Array.from(arguments),t=e.shift(),i=this.data[t];if(i&&i.type!==sy)switch(i.run.apply(i,e),i.type){case ay:-1===this.running.indexOf(i)&&this.running.push(i)}},t.stop=function(){var e=Array.from(arguments),t=e.shift(),i=this.running.find(function(e){return e.uuid===t});i&&i.stop.apply(i,e)},t.pause=function(){var e=Array.from(arguments),t=e.shift(),i=this.running.find(function(e){return e.uuid===t});i&&i.pause.apply(i,e)},t.resume=function(){var e=Array.from(arguments),t=e.shift(),i=this.running.find(function(e){return e.uuid===t});i&&i.resume.apply(i,e)},t.clear=function(){this.running.length&&this.running.forEach(function(e){e.data&&e.data.break&&e.stop()})},t.onUpdate=function(e){for(var t=0,i=this.running.length;t<i;)this.running[t].execUpdate(e)?t++:(this.running.splice(t,1),i--)},t.create=function(e){var t=null;switch(e.type){case ay:t=new wy(e,this.scene,this);break;case sy:t=new Cy(e,this.scene,this);break;case ry:t=new Py(e,this.scene,this);break;case hy:t=new Ty(e,this.scene,this);break;case cy:t=new Ey(e,this.scene,this);break;case uy:t=new Ry(e,this.scene,this);break;case py:t=new Dy(e,this.scene,this);break;case dy:t=new Iy(e,this.scene,this);break;case fy:t=new ky(e,this.scene,this);break;case oy:t=new Oy(e,this.scene,this);break;case ly:t=new Fy(e,this.scene,this);break;case my:t=new zy(e,this.scene,this);break;case vy:t=new Vy(e,this.scene,this);break;case gy:t=new Uy(e,this.scene,this);break;case _y:t=new By(e,this.scene,this);break;case yy:t=new Gy(e,this.scene,this);break;case by:t=new Wy(e,this.scene,this);break;case xy:t=new Ny(e,this.scene,this)}return t&&rm.fire("edk:scene:interaction:create",this.scene.uuid,e,t),t},t.addChild=function(e,t,i){void 0===i&&(i=!1),this.data[e]&&this.data[t]&&this.data[e].addChild(this.data[t],i)},t.destroy=function(){var t=this;rm.off("update",this.onUpdate,this),Object.keys(this.data).forEach(function(e){t.data[e].destroy(),t.data[e]=null,delete t.data[e]}),this.scene=null,this.data=null,this.collections=null,this.running=null},e}(),jy=function(n){function e(e,t){var i;return void 0===t&&(t={}),(i=n.apply(this,arguments)||this).uuid="",i.root=new Cr,i.entities=new G_(g(i)),i.resources=new ny(g(i)),i.interactions=new Hy(g(i)),i.loaded=!1,i.postRendering=!1,c_(e),i.root.type=e.type||"scene",e.name&&(i.root.name=e.name),e&&e.uuid?(i.root.setGuid(e.uuid),i.uuid=e.uuid):i.uuid=i.root.getGuid(),i.root.addComponent("script"),i.root.script.create("entityAabb"),i.mountNodeID=t.mountNodeID||null,i.mountNodeEntityID=t.mountNodeEntityID||null,i.postRendering=t.postRendering||!1,rm.once("edk:scene:resource:preload:end",i.onResouercePreloadEnd,g(i)),i.postRendering||i.mountNode(),i}u(e,n);var t=e.prototype;return t.mountNode=function(){if(this.mountNodeID&&this.mountNodeEntityID&&this.mountNodeID!==this.uuid){var e=Xy.getEntity(this.mountNodeID,this.mountNodeEntityID);e&&e.entity?e.entity.addChild(this.root):rm.root.addChild(this.root)}else rm.root.addChild(this.root)},t.onResouercePreloadEnd=function(e){this.uuid===e&&(this.loaded=!0,this.postRendering&&this.mountNode())},t.addChild=function(e,t,i){void 0===i&&(i=!1),"number"==typeof t?this.root.insertChild(e.entity,t):this.root.addChild(e.entity),!e._init&&e.data&&(e.initData(e.data),e._init=!0),i&&rm.fire("edk:scene:entity:add:child",this.uuid,this.uuid,e.uuid,t)},t.destroy=function(){var e=this;this.root&&(this.root.once("destroy",function(){e.interactions.destroy(),e.entities.destroy(),e.resources.destroy(),e.entities=null,e.resources=null,e.interactions=null,e.loaded=!1,e.fire("destroy",e)}),this.root.destroy(),this.root=null)},e}(p),Xy=null,qy=function(){function e(){this.sceneIndex={},this.entityIndex={},this.resourceIndex={},this.defaultData={material:rm.scene.defaultMaterial.toJSON(),annotation:{name:"annotation_default_asset",data:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACABAMAAAAxEHz4AAAALVBMVEVHcEz////////////////////////////////////////////////////////NXt0CAAAADnRSTlMA7sOpCkfZiRc5eSX6WOsgfKoAAAORSURBVGjepVrLaxNBGJ8mmzZpLPTgCytLaAU9yBIKYkUIbUEUQakoFi9FDxYfsPigoJeQWlEQkYKoFy0VRDzUkiJ4KRT0pEWCBy96EHbTbmy7zt9gk5g22c63mZnfd2oyM7/M95jvWcZIMl7d7h7d+2m0+/DPfqZOx26ZfIOc/eeUjxe40/P+wvz9E/PPfvWa3FeDeGHyz2O5zc/x4YPcuSt9PPmWe2MBto1hm1/Ly51PZPguwdbkTV6clDpv+YfEK2cLrgRCzHLuUGsPTXeo2fl4xnlHrz4yi7kmAK+dN2HLJ8094eef877wDRP8athyG7/cjMfz/EaIAKzFplZvzLi0GM54EmpK2DtoBvpkDGWCYsLILMqZ6kxRzOigMylp6+Y+sQS7ZF/bnFCOH7289HO1rwsuYB+Q9xf3vK1XGHQVHJ9hbZWCdUXFZT3Y8nNRJ68CkDTTgW+yXUyJ5koBN+JPqgHECo2uZXxVNW7M7m4UYVoVIOo2PCMvpwoQt+uf1NRX9dj3cqXugz2tDtDu1f+tEX6Nul8dX9YI32xkUw+ZtA5AtLhhFE5OByBu1mwpssq0aDZVU+J2PYCBmiKtaT2A9v/GmNATQVkI1RcYLTFNyla1t/BFF+DxWlWYaV2AaFV99pAuQMyrypBpU0WKbSV9gGzZJwys6QMslE1w5KI+QOty7RqaVGHfClHCqd5LO3t+hKhh3ZiNb7Q3eloocO77R2ivtH445obkMlXyj5Jb1q9PazG2UXE4QyF6jJD+cHazYiGTp5EUa/lDvXZeR5THeNLJTndS4PUA1DVblthUisoA6gGo7CGywn4TjznKG4ja9ZdlCfamGgFWCEGVWOa7eCnTCFAU7+ooUpZsFBoB/H7Kli1xbtPBAyS+aMJldl5GhpQUkx4FEAmc91MUgCmOKq3BG4jdTtxhBbF0WoIAYoM1fBwAZkFSiDylqIWgGn1SjYQhxaQNCTZl+DHBzxl2KLBLw5zqtiXcrUsFltWQwAKHtpDg+qEGEBpcw8N7xQjDwzucYOApDpxkwWkenGjCqS6cbOPpPlxwwCUPXHTBZR9eeMKlL1x8w+U/3oCAWyBwEwZvA8GNKLgVhjfjlNuBiUA7EG5I4i1RA23K4m1huDENt8bx5rz8eCAmHg/gAwp4RIIPafAxETsODqrwURk+rMPHhfDAEh+Z4kNbfGzM4ME1w0fnDB7eV9iW+veBf9vB7RCjTNPcAAAAAElFTkSuQmCC",resource:null}},Xy=this,rm.method("edk:scene:resource:get:default",this.getDefaultResource,this),rm.method("edk:scene:resource:get",this.getResource,this),rm.method("edk:scene:resource:create",this.createResource,this),rm.method("edk:scene:resource:add:child",this.addResourceChild,this),rm.method("edk:scene:resource:load",this.loadResource,this),rm.method("edk:scene:resource:update",this.updateResource,this),rm.method("edk:scene:resource:remove",this.removeResource,this),rm.method("edk:scene:entity:get",this.getEntity,this),rm.method("edk:scene:entity:create",this.createEntity,this),rm.method("edk:scene:entity:add:child",this.addEntityChild,this),rm.method("edk:scene:entity:update",this.updateEntity,this),rm.method("edk:scene:entity:update:attach",this.updateAttach,this),rm.method("edk:scene:entity:update:material",this.updateEntityMaterial,this),rm.method("edk:scene:entity:recovery",this.recoveryEntity,this),rm.method("edk:scene:entity:remove",this.removeEntity,this),rm.method("edk:scene:entity:destroy",this.destroyEntity,this),rm.method("edk:scene:entity:create:component",this.createComponent,this),rm.method("edk:scene:entity:remove:component",this.removeComponent,this),rm.method("edk:scene:entity:update:component",this.updateComponent,this),rm.method("edk:scene:entity:exec:component",this.execComponent,this),rm.method("edk:scene:entity:reparent",this.reparentEntity,this),rm.method("edk:scene:interaction:create",this.createInteraction,this),rm.method("edk:scene:interaction:run",this.runInteraction,this),rm.method("edk:scene:interaction:add:child",this.addInteractionChild,this),rm.method("edk:scene:interaction:stop",this.stopInteraction,this),rm.method("edk:scene:interaction:pause",this.pauseInteraction,this),rm.method("edk:scene:interaction:resume",this.resumeInteraction,this),rm.method("edk:scene:interaction:clear",this.clearInteraction,this),rm.method("edk:scene:interaction:record",this.recordInteraction,this),rm.on("edk:selector:add",this.onSelectAdd,this),rm.on("edk:selector:remove",this.onSelectRemove,this),rm.on("edk:scene:resource:preload:end",this.onResourceInitializeEnd,this),rm.root.type="root",rm.root.addComponent("script"),rm.root.script.create("entityAabb"),this.initDefaultResource()}var t,i=e.prototype;return i.loadSceneData=function(e,t){void 0===t&&(t={}),this.handleSceneData(e.scene);var i,n,a=c_(e.scene.info),s=t instanceof Object&&t.id?t.id:a.uuid;if(s&&!this.sceneIndex[s]){var r=new jy(Object.assign(a,{scene_uid:s}),{postRendering:t.postRendering||!1,mountNodeID:t.mountNodeID||null,mountNodeEntityID:t.mountNodeEntityID||null});if(r){this.sceneIndex[s]=r;try{r.entities.loadEntities((i=e.entities,(n=i.find(function(e){return"rooter"===e.type&&e.extensions&&"unvisual"===e.extensions.rooter_type}))?i.reduce(function(e,t){return"camera"!==t.type&&t.uuid!==n.uuid&&t.parent_uuid!==n.uuid&&e.push(t),e},[]):[]))}catch(e){}try{r.resources.loadResources(e.resources.sort(function(e){e.type}))}catch(e){}try{r.interactions.loadInteractions(e.events)}catch(e){}}}},i.handleSceneData=function(e){var t,i,n,a=e.background;null!=a&&a.enabled&&null!=a&&a.image&&null!=(t=e.skybox)&&t.transparent&&(rm.call("edk:render:camera:get"),null==rm||null==(i=rm.backgroundRenderer)||i.onEnable(),null==rm||null==(n=rm.backgroundRenderer)||n.loadBackgroundImage(null==a?void 0:a.image))},i.initDefaultResource=(t=o(__.mark(function e(){var t,n=this;return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=function(){return new Promise(function(t,i){var e=new Kr(n.defaultData.annotation.name,"texture",{url:n.defaultData.annotation.data},{addressu:"repeat",addressv:"repeat",anisotropy:1,magfilter:"linear",minfilter:"linear_mip_linear",rgbm:!0,mipmaps:!0});e.ready(function(e){e&&e.resource?(n.defaultData.annotation.resource=e.resource,rm.fire("edk:scene:default:resource:ready","annotation",e),t()):i()}),e.once("error",function(){i()}),e.preload=!0,rm.assets.add(e)})},e.next=3,t();case 3:case"end":return e.stop()}},e)})),function(){return t.apply(this,arguments)}),i.getDefaultResource=function(e){return this.defaultData[e]?this.defaultData[e]:null},i.removeSceneData=function(e){var t=this;e&&this.sceneIndex[e]&&(this.sceneIndex[e].loaded?(this.sceneIndex[e].once("destroy",function(){delete t.sceneIndex[e]}),this.sceneIndex[e].destroy()):delete this.sceneIndex[e])},i.onResourceInitializeEnd=function(){if(rm&&rm.mode!==e_){var e=rm.call("edk:render:camera:get").getCurrentParams(),t=!1;0===e.yaw&&0===e.pitch&&0===e.distance&&e.pivot&&3===e.pivot.length&&e.pivot[0]+e.pivot[1]+e.pivot[2]===0&&(t=!0),t&&setTimeout(function(){rm.call("edk:render:camera:focus")},300)}},i.getResource=function(){var e,t;return 2===arguments.length?(e=arguments[0],t=arguments[1]):t=arguments[0],e&&t&&this.sceneIndex[e]?this.sceneIndex[e].resources.get(t):t&&this.resourceIndex[t]&&!this.resourceIndex[t].deleted?this.resourceIndex[t]:null},i.createResource=function(){var e,t=Array.from(arguments),i=t.shift();return this.sceneIndex[i]?(e=this.sceneIndex[i].resources).create.apply(e,t):null},i.addResourceChild=function(){var e,t=Array.from(arguments),i=t.shift();this.sceneIndex[i]&&(e=this.sceneIndex[i].resources).addChild.apply(e,t)},i.loadResource=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].resources.get(i);if(n)return n.load.apply(n,e)}return Promise.reject()},i.updateResource=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].resources.get(i);if(n)return n.update.apply(n,e)}return Promise.reject()},i.removeResource=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].resources.get(i);n&&n.remove.apply(n,e)}},i.getEntity=function(){var e,t;return 2===arguments.length?(e=arguments[0],t=arguments[1]):t=arguments[0],e&&t&&this.sceneIndex[e]?this.sceneIndex[e].entities.get(t):t&&this.entityIndex[t]&&!this.entityIndex[t].deleted?this.entityIndex[t]:null},i.createEntity=function(){var e,t=Array.from(arguments),i=t.shift();return this.sceneIndex[i]?(e=this.sceneIndex[i].entities).create.apply(e,t):null},i.updateEntity=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].entities.get(i);n&&n.update.apply(n,e)}},i.updateEntityMaterial=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].entities.get(i);n&&n.updateMaterial.apply(n,e)}},i.updateAttach=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].entities.get(i);n&&(null==n||n.updateAttach.apply(n,e))}},i.recoveryEntity=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].entities.entityIndex[i];n&&n.deleted&&n.recovery.apply(n,e)}},i.removeEntity=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].entities.get(i);n&&n.remove.apply(n,e)}},i.destroyEntity=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].entities.get(i);n&&n.destroy.apply(n,e)}},i.createComponent=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].entities.get(i);n&&n.createComponent.apply(n,e)}},i.removeComponent=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].entities.get(i);n&&n.removeComponent.apply(n,e)}},i.updateComponent=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].entities.get(i);n&&n.updateComponent.apply(n,e)}},i.execComponent=function(){var e=Array.from(arguments),t=e.shift();if(this.sceneIndex[t]){var i=e.shift(),n=this.sceneIndex[t].entities.get(i);if(n)return n.execComponent.apply(n,e)}return null},i.reparentEntity=function(){var e,t=Array.from(arguments),i=t.shift();this.sceneIndex[i]&&(e=this.sceneIndex[i].entities).reparent.apply(e,t)},i.addEntityChild=function(){var e,t=Array.from(arguments),i=t.shift();this.sceneIndex[i]&&(e=this.sceneIndex[i].entities).addChild.apply(e,t)},i.createInteraction=function(){var e,t=Array.from(arguments),i=t.shift();return this.sceneIndex[i]?(e=this.sceneIndex[i].interactions).create.apply(e,t):null},i.runInteraction=function(){var e,t=Array.from(arguments),i=t.shift();this.sceneIndex[i]&&(e=this.sceneIndex[i].interactions).run.apply(e,t)},i.addInteractionChild=function(){var e,t=Array.from(arguments),i=t.shift();this.sceneIndex[i]&&(e=this.sceneIndex[i].interactions).addChild.apply(e,t)},i.stopInteraction=function(){var e,t=Array.from(arguments),i=t.shift();this.sceneIndex[i]&&(e=this.sceneIndex[i].interactions).stop.apply(e,t)},i.pauseInteraction=function(){var e,t=Array.from(arguments),i=t.shift();this.sceneIndex[i]&&(e=this.sceneIndex[i].interactions).pause.apply(e,t)},i.resumeInteraction=function(){var e,t=Array.from(arguments),i=t.shift();this.sceneIndex[i]&&(e=this.sceneIndex[i].interactions).resume.apply(e,t)},i.clearInteraction=function(){var e,t=Array.from(arguments),i=t.shift();this.sceneIndex[i]&&(e=this.sceneIndex[i].interactions).clear.apply(e,t)},i.recordInteraction=function(){var e,t=Array.from(arguments),i=t.shift();this.sceneIndex[i]&&(e=this.sceneIndex[i].interactions).record.apply(e,t)},i.onSelectAdd=function(e,t,i){"entity"===i&&this.entityIndex[e+"_"+t]&&this.entityIndex[e+"_"+t].onSelectAdd()},i.onSelectRemove=function(e,t,i){"entity"===i&&this.entityIndex[e+"_"+t]&&this.entityIndex[e+"_"+t].onSelectRemove()},i.destroy=function(){var t=this;Object.keys(this.sceneIndex).forEach(function(e){t.sceneIndex[e].once("destroy",function(){delete t.sceneIndex[e]}),t.sceneIndex[e].destroy()}),this.sceneIndex={}},e}(),$y=null,Yy=function(){function e(){this.skyboxReady=!1,this.scene_uid="",this.skybox={},this.render={},this.background={},this.cubemapResource=null,this.transparent=!1,this.transparentClearColor=new $(0,0,0,0),this.skyboxRotationOriginal=[],this.skyboxRotation=new fe,$y=this,rm.scene.lightmapMaxResolution=2048,rm.scene.lightmapMode=1,rm.scene.lightmapSizeMultiplier=16,rm.scene.toneMapping=0,rm.scene.ambientLight=new $(.2,.2,.2,1),rm.scene.gammaCorrection=1,rm.method("edk:render:skybox:update",this.update,this),rm.method("edk:render:skybox:background",this.updateBackground,this),rm.method("edk:render:skybox:change",this.changeCubemap,this)}var t=e.prototype;return t.initialize=function(e,t){void 0===t&&(t={}),this.skyboxReady=!0,this.scene_uid=t instanceof Object&&t.id?t.id:e.info.scene_uid,e.skybox&&(this.skybox=h({},e.skybox),this.update(this.skybox)),e.render&&(this.render=h({},e.render),this.update(this.render)),e.background&&(this.background=h({},e.background),this.updateBackground(this.background)),rm.fire("edk:render:skybox:initialized",e)},t.onSkyboxCubemapLoaded=function(e){e&&e.asset&&e.asset.loaded&&this.updateSkyboxField("cubemap",e.uuid)},t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).map(function(e){i.update(e,t[e])}):"tonemap"===t?this.updateRenderField(t,e):this.updateSkyboxField(t,e)},t.updateBackground=function(t,e){var i=this;if(t instanceof Object)Object.keys(t).map(function(e){i.updateBackground(e,t[e])});else switch(this.background[t]=e,t){case"type":"image"!==e&&rm.backgroundRenderer.onDisable(),"skybox"===e?(rm.scene.skyboxTransparent=this.transparent,I_.camera&&I_.camera.updateField("clearColor",I_.camera.extensions.clearColor||[.7215686274509804,.7215686274509804,.7215686274509804,1])):this.updateBackground(this.background.type,this.background[this.background.type]);break;case"style":switch(this.background.style){case 1:rm.backgroundRenderer.wrapMode=1,rm.backgroundRenderer.scaleMode=1;break;case 2:rm.backgroundRenderer.wrapMode=1,rm.backgroundRenderer.scaleMode=0;break;case 3:rm.backgroundRenderer.wrapMode=1,rm.backgroundRenderer.scaleMode=2;break;case 4:rm.backgroundRenderer.wrapMode=1,rm.backgroundRenderer.scaleMode=5;break;case 5:rm.backgroundRenderer.wrapMode=2,rm.backgroundRenderer.scaleMode=5}break;case"image":var n,a,s;if("image"===this.background.type)rm.scene.skyboxTransparent=!0,I_.camera&&I_.camera.entity&&(I_.camera.entity.camera.clearColor=this.transparentClearColor),(void 0===(null==(n=rm.backgroundRenderer)?void 0:n.image)||(null==(a=rm.backgroundRenderer)?void 0:a.image.src)!==e)&&(null==(s=rm.backgroundRenderer)||s.loadBackgroundImage(this.background.image,{})),rm.backgroundRenderer.onEnable();break;case"color":if("color"===this.background.type){rm.scene.skyboxTransparent=!0;var r=4===(null==e?void 0:e.length)?e:[].concat(e,[1]);I_.camera.entity.camera.clearColor=z($,r)}}},t.changeCubemap=function(e){if(this.cubemapResource){var t=this.cubemapResource.asset;rm.loader.clearCache(t.getFileUrl(),t.type),this.cubemapResource.destroy()}var i=Xy.sceneIndex[this.scene_uid].resources.create({uuid:e.cubemap.uuid,type:"cubemap",name:e.cubemap.uuid,preload:!0,data:{loadFaces:!0,cubemap:e.cubemap.dds,texture:e.cubemap.faces}});rm.assets.load(i.asset),this.updateSkyboxField("cubemap",e.cubemap.uuid)},t.updateSkyboxField=function(e,t){switch(this.skybox[e]=t,e){case"color":rm.scene.ambientLight=z($,t);break;case"intensity":rm.scene.skyboxIntensity=t;break;case"cubemap":if(t){var i=this.scene_uid+"_"+t;this.cubemapResource=Xy.getResource(i),this.cubemapResource&&this.cubemapResource.asset?this.cubemapResource.asset.loaded?rm.setSkybox(this.cubemapResource.asset):(rm.once("edk:scene:resource:ready:"+i,this.onSkyboxCubemapLoaded,this),rm.assets.load(this.cubemapResource.asset)):rm.once("edk:scene:resource:ready:"+i,this.onSkyboxCubemapLoaded,this)}else this.cubemapResource=null,rm.setSkybox(null);rm.fire("edk:render:skybox:cubemap:update",this.cubemapResource);break;case"mip":0===(rm.scene.skyboxMip=t)&&this.cubemapResource&&this.cubemapResource.asset.loaded&&rm.setSkybox(this.cubemapResource.asset);break;case"transparent":this.transparent=t,rm.scene.skyboxTransparent=t,rm.call("edk:render:camera:get");try{var n,a;t?null==(n=rm.backgroundRenderer)||n.onEnable():null==(a=rm.backgroundRenderer)||a.onDisable()}catch(e){}break;case"skyboxRotation":var s;t instanceof Array&&3===t.length&&(this.skyboxRotationOriginal=t,(s=this.skyboxRotation).setFromEulerAngles.apply(s,t),rm.scene.skyboxRotation=this.skyboxRotation)}},t.updateRenderField=function(e,t){switch(e){case"tonemap":rm.scene.toneMapping=t}},t.destroy=function(){this.skyboxReady=!1,this.scene_uid="",this.skybox={},this.render={},this.background={},this.cubemapResource=null,this.transparent=!1,this.transparentClearColor=null,this.skyboxRotation=null,this.skyboxRotationOriginal=[]},e}(),Ky="notstarted",Zy="baking",Qy="complete",Jy=1024,eb=function(){function e(e){this.projectionMatrix=void 0,this.renderTarget=void 0,this.position=void 0,this.rotation=void 0,this._viewProjMatrix=void 0,this._planeScale=4,this.projectionMatrix=new pe,this.renderTarget=e,this.position=de.ZERO.clone(),this.rotation=de.ZERO.clone(),this._viewProjMatrix=new pe}var t=e.prototype;return t.updateDirect=function(e,t,i){this.rotation.x=e,this.rotation.y=t,this.rotation.z=i,this.position.copy(de.UP);var n=(new pe).setFromEulerAngles(this.rotation.x,this.rotation.y,this.rotation.z).transformPoint(this.position);this.position.copy(n)},t.updatePosition=function(e,t,i){this.position.set(e,t,i)},t._lerp=function(e,t,i){return(1-i)*e+i*t},t.updateVP=function(e,t,i){var n=i/90;e*=this._lerp(1.41,1.41*this._planeScale,n);var a=t,s=de.UP.clone();this.position.normalize(),.99<=this.position.dot(s)&&(s=de.RIGHT.clone()),this.position.mulScalar(e),this.position.add(a),s.add(a),this._viewProjMatrix.setLookAt(this.position,a,s),this._viewProjMatrix.invert(),this.projectionMatrix.setOrtho(-e,e,-e,e,0,2*e),this._viewProjMatrix.mul2(this.projectionMatrix,this._viewProjMatrix)},t.getMVP=function(e){return(new pe).mul2(this._viewProjMatrix,e)},e}(),tb={EPSILON:1e-6,BVHVector3:function(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}};tb.BVHVector3.prototype={constructor:tb.BVHVector3,copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},set:function(e,t,i){return this.x=e,this.y=t,this.z=i,this},setFromArray:function(e,t){this.x=e[t],this.y=e[t+1],this.z=e[t+2]},add:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},cross:function(e){var t=this.x,i=this.y,n=this.z;return this.x=i*e.z-n*e.y,this.y=n*e.x-t*e.z,this.z=t*e.y-i*e.x,this},crossVectors:function(e,t){var i=e.x,n=e.y,a=e.z,s=t.x,r=t.y,o=t.z;return this.x=n*o-a*r,this.y=a*s-i*o,this.z=i*r-n*s,this},clone:function(){return new tb.BVHVector3(this.x,this.y,this.z)}},tb.BVH=function(e,t){var i=[];i.length=9*e.length;for(var n=0;n<e.length;n++){var a=e[n][0],s=e[n][1],r=e[n][2];i[9*n]=a.x,i[9*n+1]=a.y,i[9*n+2]=a.z,i[9*n+3]=s.x,i[9*n+4]=s.y,i[9*n+5]=s.z,i[9*n+6]=r.x,i[9*n+7]=r.y,i[9*n+8]=r.z}this._trianglesArray=i,this._maxTrianglesPerNode=t||10,this._bboxArray=this.calcBoundingBoxes(i),this._bboxHelper=new Float32Array(this._bboxArray.length),this._bboxHelper.set(this._bboxArray);var o=i.length/9,l=this.calcExtents(0,o,tb.EPSILON);for(this._rootNode=new tb.BVHNode(l[0],l[1],0,o,0),this._nodesToSplit=[this._rootNode];0<this._nodesToSplit.length;){var h=this._nodesToSplit.pop();this.splitNode(h)}},tb.BVH.prototype.intersectRay=function(e,t,i){for(var n,a=[this._rootNode],s=[],r=[],o=new tb.BVHVector3(1/t.x,1/t.y,1/t.z);0<a.length;){var l=a.pop();if(tb.BVH.intersectNodeBox(e,o,l))for(l._node0&&a.push(l._node0),l._node1&&a.push(l._node1),n=l._startIndex;n<l._endIndex;n++)s.push(this._bboxArray[7*n])}var h=new tb.BVHVector3,c=new tb.BVHVector3,u=new tb.BVHVector3,d=new tb.BVHVector3(e.x,e.y,e.z),p=new tb.BVHVector3(t.x,t.y,t.z);for(n=0;n<s.length;n++){var f=s[n];h.setFromArray(this._trianglesArray,9*f),c.setFromArray(this._trianglesArray,9*f+3),u.setFromArray(this._trianglesArray,9*f+6);var m=tb.BVH.intersectRayTriangle(h,c,u,d,p,i);m&&r.push({triangle:[h.clone(),c.clone(),u.clone()],triangleIndex:f,intersectionPoint:m})}return r},tb.BVH.prototype.calcBoundingBoxes=function(e){for(var t,i,n,a,s,r,o,l,h,c,u,d,p,f,m,v=e.length/9,g=new Float32Array(7*v),_=0;_<v;_++)t=e[9*_],i=e[9*_+1],n=e[9*_+2],a=e[9*_+3],s=e[9*_+4],r=e[9*_+5],o=e[9*_+6],l=e[9*_+7],h=e[9*_+8],c=Math.min(Math.min(t,a),o),u=Math.min(Math.min(i,s),l),d=Math.min(Math.min(n,r),h),p=Math.max(Math.max(t,a),o),f=Math.max(Math.max(i,s),l),m=Math.max(Math.max(n,r),h),tb.BVH.setBox(g,_,_,c,u,d,p,f,m);return g},tb.BVH.prototype.calcExtents=function(e,t,i){if(i=i||0,t<=e)return[{x:0,y:0,z:0},{x:0,y:0,z:0}];for(var n=Number.MAX_VALUE,a=Number.MAX_VALUE,s=Number.MAX_VALUE,r=-Number.MAX_VALUE,o=-Number.MAX_VALUE,l=-Number.MAX_VALUE,h=e;h<t;h++)n=Math.min(this._bboxArray[7*h+1],n),a=Math.min(this._bboxArray[7*h+2],a),s=Math.min(this._bboxArray[7*h+3],s),r=Math.max(this._bboxArray[7*h+4],r),o=Math.max(this._bboxArray[7*h+5],o),l=Math.max(this._bboxArray[7*h+6],l);return[{x:n-i,y:a-i,z:s-i},{x:r+i,y:o+i,z:l+i}]},tb.BVH.prototype.splitNode=function(e){if(!(e.elementCount()<=this._maxTrianglesPerNode||0===e.elementCount())){var t=e._startIndex,i=e._endIndex,n=[[],[],[]],a=[[],[],[]],s=[e.centerX(),e.centerY(),e.centerZ()],r=[e._extentsMax.x-e._extentsMin.x,e._extentsMax.y-e._extentsMin.y,e._extentsMax.z-e._extentsMin.z],o=[];o.length=3;for(var l=t;l<i;l++){o[0]=.5*(this._bboxArray[7*l+1]+this._bboxArray[7*l+4]),o[1]=.5*(this._bboxArray[7*l+2]+this._bboxArray[7*l+5]),o[2]=.5*(this._bboxArray[7*l+3]+this._bboxArray[7*l+6]);for(var h=0;h<3;h++)o[h]<s[h]?n[h].push(l):a[h].push(l)}var c=[];if(c.length=3,c[0]=0===n[0].length||0===a[0].length,c[1]=0===n[1].length||0===a[1].length,c[2]=0===n[2].length||0===a[2].length,!(c[0]&&c[1]&&c[2])){var u,d,p=[0,1,2];for(p.sort(function(e,t){return r[t]-r[e]}),h=0;h<3;h++){var f=p[h];if(!c[f]){u=n[f],d=a[f];break}}var m,v=t,g=v+u.length,_=g,y=i,b=e._startIndex,x=u.concat(d);for(l=0;l<x.length;l++)m=x[l],tb.BVH.copyBox(this._bboxArray,m,this._bboxHelper,b),b++;var M=this._bboxHelper.subarray(7*e._startIndex,7*e._endIndex);this._bboxArray.set(M,7*e._startIndex);var S=this.calcExtents(v,g,tb.EPSILON),w=this.calcExtents(_,y,tb.EPSILON),C=new tb.BVHNode(S[0],S[1],v,g,e._level+1),P=new tb.BVHNode(w[0],w[1],_,y,e._level+1);e._node0=C,e._node1=P,e.clearShapes(),this._nodesToSplit.push(C),this._nodesToSplit.push(P)}}},tb.BVH._calcTValues=function(e,t,i,n){var a={min:0,max:0};return 0<=n?(a.min=(e-i)*n,a.max=(t-i)*n):(a.min=(t-i)*n,a.max=(e-i)*n),a},tb.BVH.intersectNodeBox=function(e,t,i){var n=tb.BVH._calcTValues(i._extentsMin.x,i._extentsMax.x,e.x,t.x),a=tb.BVH._calcTValues(i._extentsMin.y,i._extentsMax.y,e.y,t.y);if(n.min>a.max||a.min>n.max)return!1;(a.min>n.min||n.min!=n.min)&&(n.min=a.min),(a.max<n.max||n.max!=n.max)&&(n.max=a.max);var s=tb.BVH._calcTValues(i._extentsMin.z,i._extentsMax.z,e.z,t.z);return!(n.min>s.max||s.min>n.max||((s.min>n.min||n.min!=n.min)&&(n.min=s.min),(s.max<n.max||n.max!=n.max)&&(n.max=s.max),n.max<0))},tb.BVH.intersectRayTriangle=($_=new tb.BVHVector3,Y_=new tb.BVHVector3,K_=new tb.BVHVector3,Z_=new tb.BVHVector3,function(e,t,i,n,a,s){Y_.subVectors(t,e),K_.subVectors(i,e),Z_.crossVectors(Y_,K_);var r,o=a.dot(Z_);if(0<o){if(s)return null;r=1}else{if(!(o<0))return null;r=-1,o=-o}$_.subVectors(n,e);var l=r*a.dot(K_.crossVectors($_,K_));if(l<0)return null;var h=r*a.dot(Y_.cross($_));if(h<0)return null;if(o<l+h)return null;var c=-r*$_.dot(Z_);if(c<0)return null;var u=c/o;return(new tb.BVHVector3).copy(a).multiplyScalar(u).add(n)}),tb.BVH.setBox=function(e,t,i,n,a,s,r,o,l){e[7*t]=i,e[7*t+1]=n,e[7*t+2]=a,e[7*t+3]=s,e[7*t+4]=r,e[7*t+5]=o,e[7*t+6]=l},tb.BVH.copyBox=function(e,t,i,n){i[7*n]=e[7*t],i[7*n+1]=e[7*t+1],i[7*n+2]=e[7*t+2],i[7*n+3]=e[7*t+3],i[7*n+4]=e[7*t+4],i[7*n+5]=e[7*t+5],i[7*n+6]=e[7*t+6]},tb.BVH.getBox=function(e,t,i){i.triangleId=e[7*t],i.minX=e[7*t+1],i.minY=e[7*t+2],i.minZ=e[7*t+3],i.maxX=e[7*t+4],i.maxY=e[7*t+5],i.maxZ=e[7*t+6]},tb.BVHNode=function(e,t,i,n,a){this._extentsMin=e,this._extentsMax=t,this._startIndex=i,this._endIndex=n,this._level=a,this._node0=null,this._node1=null},tb.BVHNode.prototype.elementCount=function(){return this._endIndex-this._startIndex},tb.BVHNode.prototype.centerX=function(){return.5*(this._extentsMin.x+this._extentsMax.x)},tb.BVHNode.prototype.centerY=function(){return.5*(this._extentsMin.y+this._extentsMax.y)},tb.BVHNode.prototype.centerZ=function(){return.5*(this._extentsMin.z+this._extentsMax.z)},tb.BVHNode.prototype.clearShapes=function(){this._startIndex=-1,this._endIndex=-1},tb.BVHNode.calcBoundingSphereRadius=function(e,t){var i=.5*(e.x+t.x),n=.5*(e.y+t.y),a=.5*(e.z+t.z),s=(i-e.x)*(i-e.x)+(n-e.y)*(n-e.y)+(a-e.z)*(a-e.z),r=(i-t.x)*(i-t.x)+(n-t.y)*(n-t.y)+(a-t.z)*(a-t.z);return Math.sqrt(Math.max(s,r))};var ib=tb,nb="1",ab="2",sb="3",rb="4",ob="5",lb="6",hb="7",cb="8",ub="9",db="10",pb="11",fb="12",mb="13",vb="14",gb="15",_b="16",yb="17",bb="18",xb="19",Mb="20",Sb="21",wb="22",Cb="23",Pb="24",Tb="25",Ab="26",Eb=[{name:ab,text:"前"},{name:sb,text:"右"},{name:rb,text:"后"},{name:ob,text:"左"},{name:nb,text:"上"},{name:lb,text:"下"}],Rb=[{name:xb},{name:Mb},{name:Sb},{name:wb},{name:Pb},{name:Cb},{name:Ab},{name:Tb}],Db=[{name:hb},{name:cb},{name:ub},{name:db},{name:yb},{name:_b},{name:gb},{name:bb}],Ib=[{name:pb},{name:fb},{name:mb},{name:vb}],kb=function(){function e(e){void 0===e&&(e={entity:null,cubeSize:1,layers:[]}),this.entity=null,this.camera=null,this.faces={},this.cameraRect=[.89,.89,.1,.1],this.layers=[],this.tinyOffset=.001,this.cubeSize=1,this.cubeOffset=this.cubeSize/2,this.edgeSize=.1,this.fontAsset=null,this.lineSize=.01,this.faceSize=1-2*this.edgeSize,this.fontSize=.3,this.borderOffset=this.cubeOffset-this.edgeSize/2,this._elements=[],this.hoverColor=new $([.66,.8,.97]),this.defaultColor=new $([.93,.93,.93]),this.fontColor=new $([.72,.72,.72]),this.lineColor=new $(.72,.73,.74),this.whiteColor=new $(1,1,1),this.mouseIgnoreNames=["line_"],Object.assign(this,e),this.init()}var t=e.prototype;return t.init=function(){var e=this.createFaces(),t=this.createCorners(),i=this.createHorzEdges(),n=this.createVertEdges();this.entity.addChild(e),this.entity.addChild(i),this.entity.addChild(n),this.entity.addChild(t),this.resize(),window.addEventListener("resize",this.resize.bind(this),!1)},t.destory=function(){window.removeEventListener("resize",this.resize.bind(this),!1)},t.resize=function(){var t=this;this._elements.forEach(function(e){e._rectPixels=t.getRect()})},t.createFace=function(e,t,i){void 0===e&&(e=[this.faceSize,this.faceSize]);var n=void 0===i?{}:i,a=n.axis,s=void 0===a?[0,1,0]:a,r=n.offset,o=void 0===r?this.tinyOffset:r,l=n.angle,h=void 0===l?0:l,c=n.name,u=void 0===c?"":c,d=n.color,p=void 0===d?this.defaultColor:d,f=n.useInput,m=void 0===f||f,v=e,g=v[0],_=v[1];t=t.map(function(e){return 0<e?e+o:e<0?e-o:0});var y=new Cr(u);y.setLocalPosition.apply(y,t);var b=(new fe).setFromAxisAngle(z(de,s),h);y.setLocalRotation(b);var x=y.addComponent("element",{width:g,height:_,type:ku,color:p,anchor:[.5,.5,.5,.5],pivot:[.5,.5],useInput:m,layers:this.layers});return this._elements.push(x),this.faces[y._guid]=y},t.createFaces=function(e){void 0===e&&(e="");var t=new Cr("cubeFaces");t.addChild(this.createFace([this.faceSize,this.faceSize],[0,0,this.cubeOffset],{})),t.addChild(this.createFace([this.faceSize,this.faceSize],[this.cubeOffset,0,0],{axis:[0,1,0],angle:90,name:e})),t.addChild(this.createFace([this.faceSize,this.faceSize],[0,0,-this.cubeOffset],{axis:[0,1,0],angle:180,name:e})),t.addChild(this.createFace([this.faceSize,this.faceSize],[-this.cubeOffset,0,0],{axis:[0,1,0],angle:270,name:e})),t.addChild(this.createFace([this.faceSize,this.faceSize],[0,this.cubeOffset,0],{axis:[1,0,0],angle:-90,name:e})),t.addChild(this.createFace([this.faceSize,this.faceSize],[0,-this.cubeOffset,0],{axis:[1,0,0],angle:90,name:e}));for(var i,n=_(Eb.entries());!(i=n()).done;){var a=i.value,s=a[0],r=a[1];t.children[s].name=r.name;var o=new Cr,l=o.addComponent("element",{type:Lu,autoHeight:!0,autoWidth:!0,fontAsset:this.fontAsset,fontSize:this.fontSize,text:r.text,color:this.fontColor,layers:this.layers,anchor:[.5,.5,.5,.5],pivot:[.5,.5]});this._elements.push(l),t.children[s]&&(t.children[s].addChild(o),this.addEvent(t.children[s]))}return t},t.createCornerFaces=function(e){void 0===e&&(e="");var t=new Cr(e);t.addChild(this.createFace([this.edgeSize,this.edgeSize],[this.borderOffset,this.borderOffset,this.cubeOffset],{axis:[0,1,0],angle:0,name:e})),t.addChild(this.createFace([this.edgeSize,this.edgeSize],[this.cubeOffset,this.borderOffset,this.borderOffset],{axis:[0,1,0],angle:90,name:e})),t.addChild(this.createFace([this.edgeSize,this.edgeSize],[this.borderOffset,this.cubeOffset,this.borderOffset],{axis:[1,0,0],angle:-90,name:e}));var i=this.createFace([this.edgeSize,this.lineSize],[this.borderOffset,this.borderOffset+this.edgeSize/2,this.cubeOffset],{axis:[0,1,0],angle:0,name:"line_1_"+e,useInput:!1,color:this.lineColor,offset:this.tinyOffset}),n=this.createFace([this.edgeSize,this.lineSize],[this.cubeOffset,this.borderOffset+this.edgeSize/2,this.borderOffset],{axis:[0,1,0],angle:90,name:"line_2_"+e,useInput:!1,color:this.lineColor,offset:this.tinyOffset}),a=this.createFace([this.edgeSize,this.lineSize],[this.borderOffset+this.edgeSize/2,this.cubeOffset-this.edgeSize/2,this.borderOffset+this.edgeSize/2],{axis:[0,0,1],angle:90,name:"line_3_"+e,useInput:!1,color:this.lineColor,offset:this.tinyOffset});return t.addChild(i),t.addChild(n),t.addChild(a),this.addEvents(t),t},t.createCorners=function(){for(var e,t=new Cr("corners"),i=[],n=new Cr,a=new Cr,s=_(Rb.entries());!(e=s()).done;){var r=e.value,o=r[0],l=r[1],h=this.createCornerFaces(l.name),c=(new fe).setFromAxisAngle(new de(0,1,0),o%4*90);h.setLocalRotation(c),i.push(h)}i.slice(0,4).forEach(function(e){return n.addChild(e)}),i.slice(4).forEach(function(e){return a.addChild(e)});var u=(new fe).setFromAxisAngle(new de(1,0,0),180);return a.setLocalRotation(u),t.addChild(n),t.addChild(a),t},t.createHorzEdgeFaces=function(e){void 0===e&&(e="");var t=new Cr(e),i=this.createFace([this.cubeSize,this.lineSize],[0,this.cubeOffset,this.cubeOffset],{axis:[1,0,0],angle:-45,name:"line_"+e,useInput:!1,color:this.lineColor,offset:this.tinyOffset});t.addChild(i);var n=this.cubeOffset-this.edgeSize/2;return t.addChild(this.createFace([this.cubeSize-2*this.edgeSize,this.edgeSize],[0,n,this.cubeOffset],{axis:[0,1,0],angle:0,name:e})),t.addChild(this.createFace([this.cubeSize-2*this.edgeSize,this.edgeSize],[0,this.cubeOffset,n],{axis:[1,0,0],angle:-90,name:e})),this.addEvents(t),t},t.createHorzEdges=function(){for(var e,t=new Cr("HorzEdges"),i=[],n=_(Db.entries());!(e=n()).done;){var a=e.value,s=a[0],r=a[1],o=this.createHorzEdgeFaces(r.name),l=(new fe).setFromAxisAngle(new de(0,1,0),s%4*90);o.setLocalRotation(l),i.push(o)}var h=new Cr,c=new Cr;i.slice(0,4).forEach(function(e){return h.addChild(e)}),i.slice(4).forEach(function(e){return c.addChild(e)});var u=(new fe).setFromAxisAngle(new de(1,0,0),180);return c.setLocalRotation(u),t.addChild(h),t.addChild(c),t},t.createVertEdgeFaces=function(e){void 0===e&&(e="");var t=new Cr(e),i=this.cubeOffset-this.edgeSize/2,n=this.createFace([this.lineSize,this.cubeSize],[this.cubeOffset,0,this.cubeOffset],{axis:[0,1,0],angle:45,name:"line_"+e,useInput:!1,color:this.lineColor});return t.addChild(n),t.addChild(this.createFace([this.edgeSize,this.cubeSize-2*this.edgeSize],[i,0,this.cubeOffset],{axis:[0,1,0],angle:0,name:e})),t.addChild(this.createFace([this.edgeSize,this.cubeSize-2*this.edgeSize],[this.cubeOffset,0,i],{axis:[0,1,0],angle:90,name:e})),this.addEvents(t),t},t.createVertEdges=function(){for(var e,t=new Cr("VertEdges"),i=_(Ib.entries());!(e=i()).done;){var n=e.value,a=n[0],s=n[1],r=this.createVertEdgeFaces(s.name),o=(new fe).setFromAxisAngle(new de(0,1,0),a%4*90);r.setLocalRotation(o),t.addChild(r)}return t},t.isIgnore=function(t){var i=!1;return this.mouseIgnoreNames.forEach(function(e){-1!==t.indexOf(e)&&(i=!0)}),i},t.addEvents=function(i){var n=this;i.children.forEach(function(e){e.element&&(e.element.on("click",function(e){n.isInCameraRect(e)&&n.onClick(i.name)}),e.element.on("mouseenter",function(t){n.isInCameraRect(t)&&i.children.forEach(function(e){n.isIgnore(e.name)||t.camera.entity._guid!==n.camera._guid||(e.element.color=n.hoverColor)})}),e.element.on("mouseleave",function(e){n.isInCameraRect(e)&&i.children.forEach(function(e){n.isIgnore(e.name)||(e.element.color=n.defaultColor)})}))})},t.addEvent=function(t){var i=this,n=t.element;n.on("click",function(e){i.isInCameraRect(e)&&i.onClick(t.name)}),n.on("mouseenter",function(e){i.isInCameraRect(e)&&e.camera.entity._guid===i.camera._guid&&(n.color=i.hoverColor,t.children.find(function(e){return e.element&&e.element.type===Lu}))}),n.on("mouseleave",function(e){i.isInCameraRect(e)&&(n.color=i.defaultColor,t.children.find(function(e){return e.element&&e.element.type===Lu}))})},t.isInCameraRect=function(e){var t=this.getRect(e),i=t.left,n=t.right,a=t.top,s=t.bottom;return e.x>i&&e.x<n&&e.y>a&&e.y<s},t.getRect=function(){var e=rm.graphicsDevice.canvas.getBoundingClientRect(),t=e.width*this.cameraRect[2],i=e.height*this.cameraRect[3],n=e.width*this.cameraRect[0],a=e.height-e.height*this.cameraRect[1]-i;return{left:n,right:n+t,top:a,bottom:a+i}},e}(),Lb="viewCubeOrbitCamera",Ob=function(e,t){var s,i=new Cr("viewcube camera");return i.setPosition(0,0,2),i.addComponent("camera",{layers:e,priority:1,rect:t,clearColorBuffer:!1}),i.addComponent("script"),(s=rm.scripts.get(Lb))||((s=Tv("viewCubeOrbitCamera")).attributes.add("distanceMax",{type:"number",default:0,title:"Distance Max",description:"Setting this at 0 will give an infinite distance limit"}),s.attributes.add("distanceMin",{type:"number",default:0,title:"Distance Min"}),s.attributes.add("pitchAngleMax",{type:"number",default:90,title:"Pitch Angle Max (degrees)"}),s.attributes.add("pitchAngleMin",{type:"number",default:-90,title:"Pitch Angle Min (degrees)"}),s.attributes.add("inertiaFactor",{type:"number",default:0,title:"Inertia Factor",description:"Higher value means that the camera will continue moving after the user has stopped dragging. 0 is fully responsive."}),s.attributes.add("focusEntity",{type:"entity",title:"Focus Entity",description:"Entity for the camera to focus on. If blank, then the camera will use the whole scene"}),s.attributes.add("frameOnStart",{type:"boolean",default:!0,title:"Frame on Start",description:'Frames the entity or scene at the start of the application."'}),Object.defineProperty(s.prototype,"distance",{get:function(){return this._targetDistance},set:function(e){this._targetDistance=this._clampDistance(e)}}),Object.defineProperty(s.prototype,"pitch",{get:function(){return this._targetPitch},set:function(e){this._targetPitch=this._clampPitchAngle(e)}}),Object.defineProperty(s.prototype,"yaw",{get:function(){return this._targetYaw},set:function(e){this._targetYaw=e;var t=(this._targetYaw-this._yaw)%360;this._targetYaw=180<t?this._yaw-(360-t):t<-180?this._yaw+(360+t):this._yaw+t}}),Object.defineProperty(s.prototype,"pivotPoint",{get:function(){return this._pivotPoint},set:function(e){this._pivotPoint.copy(e)}}),s.prototype.focus=function(e){this._buildAabb(e,0);var t=this._modelsAabb.halfExtents,i=Math.max(t.x,Math.max(t.y,t.z));i/=Math.tan(.5*this.entity.camera.fov*Se.DEG_TO_RAD),i*=2,this.distance=i,this._removeInertia(),this._pivotPoint.copy(this._modelsAabb.center)},s.distanceBetween=new de,s.prototype.resetAndLookAtPoint=function(e,t){this.pivotPoint.copy(t),this.entity.setPosition(e),this.entity.lookAt(t);var i=s.distanceBetween;i.sub2(t,e),this.distance=i.length(),this.pivotPoint.copy(t);var n=this.entity.getRotation();this.yaw=this._calcYaw(n),this.pitch=this._calcPitch(n,this.yaw),this._removeInertia(),this._updatePosition()},s.prototype.resetAndLookAtEntity=function(e,t){this._buildAabb(t,0),this.resetAndLookAtPoint(e,this._modelsAabb.center)},s.prototype.reset=function(e,t,i){this.pitch=t,this.yaw=e,this.distance=i,this._removeInertia()},s.prototype.initialize=function(){var e=this,t=function(){e._checkAspectRatio()};window.addEventListener("resize",t,!1),this._checkAspectRatio(),this._modelsAabb=new ue,this._buildAabb(this.focusEntity||rm.root,0),this.entity.lookAt(this._modelsAabb.center),this._pivotPoint=new de,this._pivotPoint.copy(this._modelsAabb.center);var i=this.entity.getRotation();if(this._yaw=this._calcYaw(i),this._pitch=this._clampPitchAngle(this._calcPitch(i,this._yaw)),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0),this._distance=0,this._targetYaw=this._yaw,this._targetPitch=this._pitch,this.frameOnStart)this.focus(this.focusEntity||rm.root);else{var n=new de;n.sub2(this.entity.getPosition(),this._pivotPoint),this._distance=this._clampDistance(n.length())}this._targetDistance=this._distance,this.on("attr:distanceMin",function(e,t){this._targetDistance=this._clampDistance(this._distance)}),this.on("attr:distanceMax",function(e,t){this._targetDistance=this._clampDistance(this._distance)}),this.on("attr:pitchAngleMin",function(e,t){this._targetPitch=this._clampPitchAngle(this._pitch)}),this.on("attr:pitchAngleMax",function(e,t){this._targetPitch=this._clampPitchAngle(this._pitch)}),this.on("attr:focusEntity",function(e,t){this.frameOnStart?this.focus(e||rm.root):this.resetAndLookAtEntity(this.entity.getPosition(),e||rm.root)}),this.on("attr:frameOnStart",function(e,t){e&&this.focus(this.focusEntity||rm.root)}),this.on("destroy",function(){window.removeEventListener("resize",t,!1)})},s.prototype.update=function(e){var t=0===this.inertiaFactor?1:Math.min(e/this.inertiaFactor,1);this._distance=Se.lerp(this._distance,this._targetDistance,t),this._yaw=Se.lerp(this._yaw,this._targetYaw,t),this._pitch=Se.lerp(this._pitch,this._targetPitch,t),this._updatePosition()},s.prototype._updatePosition=function(){this.entity.setLocalPosition(0,0,0),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0);var e=this.entity.getPosition();e.copy(this.entity.forward),e.mulScalar(-this._distance),e.add(this.pivotPoint),this.entity.setPosition(e)},s.prototype._removeInertia=function(){this._yaw=this._targetYaw,this._pitch=this._targetPitch,this._distance=this._targetDistance},s.prototype._checkAspectRatio=function(){var e=rm.graphicsDevice.height,t=rm.graphicsDevice.width;this.entity.camera.horizontalFov=t<e},s.prototype._buildAabb=function(e,t){var i=0;if(e.model){var n=e.model.meshInstances;for(i=0;i<(null==n?void 0:n.length);i++)0===t?this._modelsAabb.copy(n[i].aabb):this._modelsAabb.add(n[i].aabb),t+=1}for(i=0;i<e.children.length;++i)t+=this._buildAabb(e.children[i],t);return t},s.prototype._calcYaw=function(e){var t=new de;return e.transformVector(de.FORWARD,t),Math.atan2(-t.x,-t.z)*Se.RAD_TO_DEG},s.prototype._clampDistance=function(e){return 0<this.distanceMax?Se.clamp(e,this.distanceMin,this.distanceMax):Math.max(e,this.distanceMin)},s.prototype._clampPitchAngle=function(e){return Se.clamp(e,-this.pitchAngleMax,-this.pitchAngleMin)},s.quatWithoutYaw=new fe,s.yawOffset=new fe,s.prototype._calcPitch=function(e,t){var i=s.quatWithoutYaw,n=s.yawOffset;n.setFromEulerAngles(0,-t,0),i.mul2(n,e);var a=new de;return i.transformVector(de.FORWARD,a),Math.atan2(a.y,-a.z)*Se.RAD_TO_DEG}),i.script.create(Lb),i};var Fb=function(){function e(e){this.config={sizer:!0,viewcube:!1,explode:!1},this.preInitialize(e)}return e.prototype.preInitialize=function(e){var t,r,i,n,a,s,o,l,h,c,u,d,m,p,f,v,g,_,y,b,x,M,S,w,C,P,T,A,E,R,D,I,k,L,O,F;void 0===e&&(e=this.config),(F=rm.scripts.get("camera"))||((F=Tv("camera")).prototype.initialize=function(){this.localCenter=new de,this.modelCenter=new de,this.world2CameraTransform=new pe,this.aabb=new ue},F.prototype.loopAabb=function(e){var t=this;e.forEach(function(e){e instanceof Cr&&e.aabb&&(t.first?(t.first=!1,t.aabb.copy(e.aabb)):t.aabb.add(e.aabb),e.children&&t.loopAabb(e.children))})},F.prototype.update=function(){this.first=!0,this.loopAabb(rm.root.children),this.modelCenter.copy(this.aabb.center),this.world2CameraTransform.copy(this.entity.getWorldTransform()).invert(),this.world2CameraTransform.transformPoint(this.modelCenter,this.localCenter);var e=Math.abs(this.localCenter.z),t=this.aabb.halfExtents.length(),i=300<e?1:.01,n=Math.max(2e3,e+6*t);this.entity.camera.nearClip=i,this.entity.camera.farClip=n}),L="orbitCamera",(O=rm.scripts.get(L))||((O=Tv(L)).attributes.add("distanceMax",{type:"number",default:0}),O.attributes.add("distanceMin",{type:"number",default:0}),O.attributes.add("fovMax",{type:"number",default:0}),O.attributes.add("fovMin",{type:"number",default:0}),O.attributes.add("yawAngleLimit",{type:"boolean",default:!1}),O.attributes.add("yawAngleMax",{type:"number",default:0}),O.attributes.add("yawAngleMin",{type:"number",default:0}),O.attributes.add("pitchAngleLimit",{type:"boolean",default:!1}),O.attributes.add("pitchAngleMax",{type:"number",default:90}),O.attributes.add("pitchAngleMin",{type:"number",default:-90}),O.attributes.add("inertiaFactor",{type:"number",default:0}),O.attributes.add("dragInertiaFactor",{type:"number",default:0}),O.attributes.add("reverseOrbit",{type:"boolean",default:!1}),O.attributes.add("disableMove",{type:"boolean",default:!1}),O.attributes.add("disablePivot",{type:"boolean",default:!1}),O.attributes.add("autoRotate",{type:"boolean",default:!1}),O.attributes.add("rotationSpeed",{type:"number",default:.6}),O.attributes.add("waitingTime",{type:"number",default:3}),Object.defineProperty(O.prototype,"fov",{get:function(){return this._targetFov},set:function(e){this._targetFov=this._clampFovScale(e)}}),Object.defineProperty(O.prototype,"distance",{get:function(){return this._targetDistance},set:function(e){this._targetDistance=this._clampDistance(e)}}),Object.defineProperty(O.prototype,"pitch",{get:function(){return this._targetPitch},set:function(e){this._targetPitch=this._clampPitchAngle(e)}}),Object.defineProperty(O.prototype,"yaw",{get:function(){return this._targetYaw},set:function(e){var t=e,i=(t-this._yaw)%360;t=180<i?this._yaw-(360-i):i<-180?this._yaw+(360+i):this._yaw+i,this._targetYaw=this._clampYawAngle(t)}}),Object.defineProperty(O.prototype,"pivot",{get:function(){return this._pivotPoint},set:function(e){var t;(t=this._targetPivotPoint).set.apply(t,e)}}),Object.defineProperty(O.prototype,"pivotPoint",{get:function(){return this._targetPivotPoint},set:function(e){this._targetPivotPoint.copy(e)}}),O.prototype.initialize=function(){var e=this.entity.getRotation();this._rotationFrameNumber=0,this._distanceBetween=new de,this._pivotPoint=new de,this._targetPivotPoint=new de,this.diffPivotPoint=new de,this.forwardPosition=new de,this._yaw=this._calcYaw(e),this._targetYaw=this._yaw,this._pitch=this._clampPitchAngle(this._calcPitch(e,this._yaw)),this._targetPitch=this._pitch,this.entity.setLocalEulerAngles(this._pitch,this._yaw,0),this._distance=0,this._fov=this.entity.camera.fov,this._prevFov=this._fov,this._targetFov=this._fov,this._distanceBetween.sub2(this.entity.getPosition(),this._pivotPoint),this._distance=this._clampDistance(this._distanceBetween.length()),this._targetDistance=this._distance,this.on("attr:distanceMin",function(){this._targetDistance=this._clampDistance(this._distance)}),this.on("attr:distanceMax",function(){this._targetDistance=this._clampDistance(this._distance)}),this.on("attr:pitchAngleMin",function(){this._targetPitch=this._clampPitchAngle(this._pitch)}),this.on("attr:pitchAngleMax",function(){this._targetPitch=this._clampPitchAngle(this._pitch)}),this.on("attr:yawAngleMin",function(){this._targetYaw=this._clampYawAngle(this._yaw)}),this.on("attr:yawAngleMax",function(){this._targetYaw=this._clampYawAngle(this._yaw)}),this.on("attr:waitingTime",function(e){this._rotationFrameNumber=parseInt(60*e)}),this.on("attr:autoRotate",function(){this._rotationFrameNumber=parseInt(60*this.waitingTime)}),this.on("attr:reverseOrbit",function(e){e?this._prevFov=this.entity.camera.fov:this.entity.camera.fov=this._prevFov}),this.on("attr:fovMax",function(){this._targetFov=this._clampFovScale(this._targetFov)}),this.on("attr:fovMin",function(){this._targetFov=this._clampFovScale(this._targetFov)}),this.entity.script.fire("initialize",this.__scriptType.__name,this)},O.prototype.reset=function(e,t,i){this._yaw=this._targetYaw,this._pitch=this._targetPitch,this._distance=this._targetDistance,this._pitch=t,this.pitch=t,this._yaw=e,this.yaw=e,this._distance=i,this.distance=i},O.prototype.resetToTRS=function(e){if(e)if(void 0!==e.entity&&e.entity instanceof Entity){var t=e.entity.getPosition().clone(),i=e.entity.getRotation().clone();this.resetToTRS({position:t,rotation:i})}else{var n=de.ZERO.clone(),a=de.ZERO.clone(),s=fe.ZERO.clone();void 0!==e.position&&(e.position instanceof de?n.copy(e.position):e.position instanceof Array&&3===e.position.length&&n.set.apply(n,e.position),a.copy(this.entity.forward),a.mulScalar(-this._distance),n.sub(a),this._targetPivotPoint.copy(n),this._pivotPoint.copy(n)),e.rotation&&(e.rotation instanceof fe?s.copy(e.rotation):e.rotation instanceof Array&&4===e.position.length&&s.set.apply(s,e.rotation),this._yaw=this._calcYaw(s),this._targetYaw=this._yaw,this._pitch=this._clampPitchAngle(this._calcPitch(s,this._yaw)),this._targetPitch=this._pitch)}},O.prototype.update=function(e){var t;.001<Math.abs(this.dragInertiaFactor-this.inertiaFactor)?(this.dragInertiaFactor=Se.lerp(this.dragInertiaFactor,this.inertiaFactor,.1),t=0===this.dragInertiaFactor?1:Math.min(e/this.dragInertiaFactor,1)):t=0===this.inertiaFactor?1:Math.min(e/this.inertiaFactor,1),this._distance=Se.lerp(this._distance,this._targetDistance,t),this._yaw=Se.lerp(this._yaw,this._targetYaw,t),this._pitch=Se.lerp(this._pitch,this._targetPitch,t),this._fov=Se.lerp(this._fov,this._targetFov,t),this._checkHorizontalFov(),this._updateFovScale(t),this._updateRotation(t),this._updatePosition(t)},O.prototype._updateFovScale=function(){this.reverseOrbit&&(this.entity.camera.fov=this._fov)},O.prototype._updateRotation=function(){this.autoRotate&&(this.waitingTime?(this._rotationFrameNumber++,this._rotationFrameNumber>=parseInt(60*this.waitingTime)&&(this.yaw-=this.rotationSpeed)):this.yaw-=this.rotationSpeed)},O.prototype._updatePosition=function(e){this.entity.setLocalPosition(0,0,0),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0),this.forwardPosition.copy(this.entity.forward),this.forwardPosition.mulScalar(-this._distance);var t=.001<Math.abs(this.dragInertiaFactor-this.inertiaFactor)?.1:1;this.diffPivotPoint.sub2(this._targetPivotPoint,this._pivotPoint);var i=Se.lerp(0,this.diffPivotPoint.length(),t);this.diffPivotPoint.normalize(),this.diffPivotPoint.mulScalar(i,e),this._pivotPoint.add(this.diffPivotPoint),this.forwardPosition.add(this._pivotPoint),this.entity.setPosition(this.forwardPosition)},O.prototype._checkHorizontalFov=function(){var e=!1;rm.graphicsDevice&&(e=rm.graphicsDevice.height>rm.graphicsDevice.width),this.entity.camera.horizontalFov!==e&&(this.entity.camera.horizontalFov=e)},O.prototype._clampDistance=function(e){return 0<this.distanceMax?Se.clamp(e,this.distanceMin,this.distanceMax):Math.max(e,this.distanceMin)},O.prototype._clampFovScale=function(e){return 0<this.fovMax?Se.clamp(e,this.fovMin,this.fovMax):Math.max(e,this.fovMin)},O.prototype._clampYawAngle=function(e){return this.yawAngleLimit?Se.clamp(e,this.yawAngleMin,this.yawAngleMax):e},O.prototype._clampPitchAngle=function(e){return this.pitchAngleLimit?Se.clamp(e,-this.pitchAngleMax,-this.pitchAngleMin):Se.clamp(e,-90,90)},O.prototype.quatWithoutYaw=new fe,O.prototype.yawOffset=new fe,O.prototype.transformedForward=new de,O.prototype._calcYaw=function(e){return e.transformVector(de.FORWARD,this.transformedForward),Math.atan2(-this.transformedForward.x,-this.transformedForward.z)*Se.RAD_TO_DEG},O.prototype._calcPitch=function(e,t){return this.yawOffset.setFromEulerAngles(0,-t,0),this.quatWithoutYaw.mul2(this.yawOffset,e),this.quatWithoutYaw.transformVector(de.FORWARD,this.transformedForward),Math.atan2(this.transformedForward.y,-this.transformedForward.z)*Se.RAD_TO_DEG}),t="orbitCameraMouseInput",(r=rm.scripts.get(t))||((r=Tv(t)).attributes.add("orbitSensitivity",{type:"number",default:.3}),r.attributes.add("distanceSensitivity",{type:"number",default:.15}),r.prototype.initialize=function(){this.orbitCamera=this.entity.script.orbitCamera,this.orbitCamera&&rm.mouse&&(this.on("enable",this.onEnable),this.on("disable",this.onDisable),this.onEnable(),rm.mouse.disableContextMenu()),this.lookButtonDown=!1,this.panButtonDown=!1,this.lastPoint=new J},r.prototype.onEnable=function(){this.lookButtonDown=!1,this.panButtonDown=!1,rm.mouse.on(Rv,this.onMouseDown,this),rm.mouse.on(Iv,this.onMouseUp,this),rm.mouse.on(Dv,this.onMouseMove,this),rm.mouse.on(kv,this.onMouseWheel,this),window.addEventListener("mouseout",this.onMouseOut.bind(this),!1)},r.prototype.onDisable=function(){this.lookButtonDown=!1,this.panButtonDown=!1,rm.mouse.off(Rv,this.onMouseDown,this),rm.mouse.off(Iv,this.onMouseUp,this),rm.mouse.off(Dv,this.onMouseMove,this),rm.mouse.off(kv,this.onMouseWheel,this),window.removeEventListener("mouseout",this.onMouseOut.bind(this),!1)},r.prototype.onMouseDown=function(e){if(!this.orbitCamera.disableMove)switch(e.button){case 0:this.lookButtonDown=!0;break;case 1:case 2:this.panButtonDown=!0}},r.prototype.onMouseUp=function(e){if(!this.orbitCamera.disableMove){switch(e.button){case 0:this.lookButtonDown=!1;break;case 1:case 2:this.panButtonDown=!1}this.orbitCamera._rotationFrameNumber=0}},r.prototype.onMouseMove=function(e){this.lookButtonDown?(100<Math.abs(e.dx)&&(e.dx=0<e.dx?100:-100),this.orbitCamera.reverseOrbit?(this.orbitCamera.pitch+=e.dy*this.orbitSensitivity,this.orbitCamera.yaw+=e.dx*this.orbitSensitivity):(this.orbitCamera.pitch-=e.dy*this.orbitSensitivity,this.orbitCamera.yaw-=e.dx*this.orbitSensitivity)):this.panButtonDown&&!this.orbitCamera.disablePivot&&this.pan(e),this.lastPoint.set(e.x,e.y)},r.prototype.onMouseWheel=function(e){this.orbitCamera.disableMove||(this.orbitCamera.reverseOrbit?this.orbitCamera.fov-=-2*e.wheelDelta*this.distanceSensitivity*(.1*(this.orbitCamera.fov+.1)):this.orbitCamera.distance-=-2*e.wheelDelta*this.distanceSensitivity*(.1*this.orbitCamera.distance))},r.fromWorldPoint=new de,r.toWorldPoint=new de,r.worldDiff=new de,r.prototype.pan=function(e){var t=r.fromWorldPoint,i=r.toWorldPoint,n=r.worldDiff,a=this.entity.camera,s=this.orbitCamera.distance;a.screenToWorld(e.x,e.y,s,t),a.screenToWorld(this.lastPoint.x,this.lastPoint.y,s,i),n.sub2(i,t),this.orbitCamera.pivotPoint.add(n)},r.prototype.onMouseOut=function(){this.lookButtonDown=!1,this.panButtonDown=!1}),I="orbitCameraTouchInput",(k=rm.scripts.get(I))||((k=Tv(I)).attributes.add("orbitSensitivity",{type:"number",default:.4}),k.attributes.add("distanceSensitivity",{type:"number",default:.3}),k.attributes.add("pinchSensitivity",{type:"number",default:1}),k.prototype.initialize=function(){this.orbitCamera=this.entity.script.orbitCamera,this.originDistance=0,this.lastTouchPoint=new J,this.lastPinchMidPoint=new J,this.lastPinchDistance=0,this.orbitCamera&&rm.touch&&(this.on("enable",this.onEnable),this.on("disable",this.onDisable),this.onEnable())},k.prototype.onEnable=function(){rm.touch.on(Lv,this.onTouchStart,this),rm.touch.on(Ov,this.onTouchEnd,this),rm.touch.on(zv,this.onTouchEnd,this),rm.touch.on(Fv,this.onTouchMove,this)},k.prototype.onDisable=function(){rm.touch.off(Lv,this.onTouchStart,this),rm.touch.off(Ov,this.onTouchEnd,this),rm.touch.off(zv,this.onTouchEnd,this),rm.touch.off(Fv,this.onTouchMove,this)},k.prototype.getPinchDistance=function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},k.prototype.calcMidPoint=function(e,t,i){i.set(t.x-e.x,t.y-e.y),i.mulScalar(.5),i.x+=e.x,i.y+=e.y},k.prototype.onTouchStart=function(e){this.onTouchStartEndCancel(e)},k.prototype.onTouchEnd=function(e){this.onTouchStartEndCancel(e)},k.prototype.onTouchStartEndCancel=function(e){if(!this.orbitCamera.disableMove){var t=e.touches;1===t.length?this.lastTouchPoint.set(t[0].x,t[0].y):2===t.length&&(this.lastPinchDistance=this.getPinchDistance(t[0],t[1]),this.calcMidPoint(t[0],t[1],this.lastPinchMidPoint))}},k.fromWorldPoint=new de,k.toWorldPoint=new de,k.worldDiff=new de,k.pinchMidPoint=new J,k.prototype.OrbitCameraMode=function(e){var t=e[0],i=(t.y-this.lastTouchPoint.y)*this.orbitSensitivity,n=(t.x-this.lastTouchPoint.x)*this.orbitSensitivity;this.orbitCamera.reverseOrbit?(this.orbitCamera.pitch+=i,this.orbitCamera.yaw+=n):(this.orbitCamera.pitch-=i,this.orbitCamera.yaw-=n),this.lastTouchPoint.set(t.x,t.y),this.orbitCamera._rotationFrameNumber=0},k.prototype.DollyCameraMode=function(e){var t=k.pinchMidPoint,i=this.getPinchDistance(e[0],e[1]),n=i-this.lastPinchDistance;if(this.lastPinchDistance=i,this.calcMidPoint(e[0],e[1],t),Math.abs(n)<=this.pinchSensitivity)this.orbitCamera.disablePivot||this.pan(t);else if(this.orbitCamera.reverseOrbit)this.orbitCamera.fov-=n*this.distanceSensitivity*.5;else{var a=n*this.distanceSensitivity*this.orbitCamera.distance*.01;this.orbitCamera.distance-=a}this.lastPinchMidPoint.copy(t)},k.prototype.onTouchMove=function(e){if(!this.orbitCamera.disableMove){var t=e.touches;1===t.length?this.OrbitCameraMode(t):2===t.length&&this.DollyCameraMode(t)}},k.prototype.pan=function(e){var t=k.fromWorldPoint,i=k.toWorldPoint,n=k.worldDiff,a=this.entity.camera,s=this.orbitCamera.distance;a.screenToWorld(e.x,e.y,s,t),a.screenToWorld(this.lastPinchMidPoint.x,this.lastPinchMidPoint.y,s,i),n.sub2(i,t),this.orbitCamera.pivotPoint.add(n)}),(D=rm.scripts.get("fpsCamera"))||((D=Tv("fpsCamera")).attributes.add("speed",{type:"number",default:.2}),D.attributes.add("translateSpeed",{type:"number",default:2}),D.attributes.add("fpsHeightMax",{type:"number",default:1/0}),D.attributes.add("fpsHeightMin",{type:"number",default:-1/0}),D.attributes.add("yawAngleLimit",{type:"boolean",default:!1}),D.attributes.add("yawAngleMax",{type:"number",default:1/0}),D.attributes.add("yawAngleMin",{type:"number",default:-1/0}),D.attributes.add("pitchAngleLimit",{type:"boolean",default:!1}),D.attributes.add("pitchAngleMax",{type:"number",default:90}),D.attributes.add("pitchAngleMin",{type:"number",default:-90}),D.attributes.add("inertiaFactor",{type:"number",default:.2}),D.attributes.add("dragInertiaFactor",{type:"number",default:0}),D.attributes.add("stepHeightLimit",{type:"boolean",default:!0}),D.attributes.add("stepHeightMax",{type:"number",default:.5}),D.attributes.add("disablePanHeight",{type:"boolean",default:!1}),Object.defineProperty(D.prototype,"forwardSpeed",{get:function(){return this._targetForwardSpeed},set:function(e){this._targetForwardSpeed=Se.clamp(e,-1,1)}}),Object.defineProperty(D.prototype,"translationSpeed",{get:function(){return this._targetTranslationSpeed},set:function(e){this._targetTranslationSpeed=Se.clamp(e,-1,1)}}),Object.defineProperty(D.prototype,"fpsHeight",{get:function(){return this._targetFpsHeight},set:function(e){this._targetFpsHeight=this._clampFpsHeight(e)}}),Object.defineProperty(D.prototype,"direction",{get:function(){return this._targetDirection},set:function(e){this._targetDirection.copy(e).normalize()}}),Object.defineProperty(D.prototype,"distance",{get:function(){return this._translateDistance},set:function(e){this._translateDistance=e}}),Object.defineProperty(D.prototype,"pitch",{get:function(){return this._targetPitch},set:function(e){this._targetPitch=this._clampPitchAngle(e)}}),Object.defineProperty(D.prototype,"yaw",{get:function(){return this._targetYaw},set:function(e){var t=e,i=(t-this._yaw)%360;t=180<i?this._yaw-(360-i):i<-180?this._yaw+(360+i):this._yaw+i,this._targetYaw=this._clampYawAngle(t)}}),D.prototype.initialize=function(){var e=this.entity.getRotation();this._forwardSpeed=0,this._targetForwardSpeed=0,this._translationSpeed=0,this._targetTranslationSpeed=0,this.orbitSensitivity=10,this._forward=this.entity.forward.clone(),this.fpsHeight=1.6,this._fpsHeight=1.6,this._targetFpsHeight=this._fpsHeight,this.dragInertiaFactor=0,this._yaw=this._calcYaw(e),this._targetYaw=this._yaw,this._pitch=this._clampPitchAngle(this._calcPitch(e,this._yaw)),this._targetPitch=this._pitch,this.entity.setLocalEulerAngles(this._pitch,this._yaw,0),this._translateDistance=0,this._translateTotalDuration=0,this._translateMoveDuration=0,this._direction=this.entity.forward.clone(),this._targetDirection=this.entity.forward.clone(),this._targetPosition=this.entity.getPosition().clone()},D.prototype.initCylinder=function(e){var i=this;this.cylinderEntity=new Cr,this.cylinderMaterial=new gm,rm.assets.loadFromUrl("//staging.asset.realibox.com/realibox/studio/0a2283f8-1156-4828-8ce1-643e67ecd03d.png","texture",function(e,t){e||(i.cylinderMaterial.diffuseMap=t.resource,i.cylinderMaterial.update())}),this.cylinderEntity.addComponent("model",{type:"cylinder"}),this.cylinderEntity.model.model.meshInstances[0].material=this.cylinderMaterial,rm.root.addChild(this.cylinderEntity),this.cylinderEntity.setLocalScale(.1,.1,.1),this.cylinderEntity.setPosition(0,1,0)},D.prototype.resetToTRS=function(e){if(e)if(void 0!==e.entity&&e.entity instanceof Cr){var t=e.entity.getPosition().clone(),i=e.entity.getRotation().clone();this.resetToTRS({position:t,rotation:i})}else{var n=de.ZERO.clone(),a=fe.ZERO.clone();void 0!==e.position&&(e.position instanceof de?n.copy(e.position):e.position instanceof Array&&3===e.position.length&&n.set.apply(n,e.position),this._fpsHeight=n.y,this._targetFpsHeight=this._fpsHeight,this.entity.setPosition(n)),e.rotation&&(e.rotation instanceof fe?a.copy(e.rotation):e.rotation instanceof Array&&4===e.position.length&&a.set.apply(a,e.rotation),this._yaw=this._calcYaw(a),this._targetYaw=this._yaw,this._pitch=this._clampPitchAngle(this._calcPitch(a,this._yaw)),this._targetPitch=this._pitch)}},D.prototype.moveTo=function(e){if(e)if(void 0!==e.entity&&e.entity instanceof Cr){var t=e.entity.getPosition(),i=e.entity.getRotation();this.translateTo(t),this.rotateTo(i)}else void 0!==e.position&&this.translateTo(e.position),void 0!==e.rotation&&this.rotateTo(e.rotation)},D.prototype.translateTo=function(e,t,i){if(this._startPosition=this.entity.getPosition().clone(),e instanceof de)this._targetPosition.copy(e);else if(e instanceof Array&&3===e.length){var n;(n=this._targetPosition).set.apply(n,e)}else this._targetPosition.set(e,t,i);this._targetDirection.sub2(this._targetPosition,this._startPosition),this._translateDistance=this._targetDirection.length(),this._translateTotalDuration=this._translateDistance/this.translateSpeed,this._translateMoveDuration=0,this._targetDirection.normalize()},D.prototype.rotateTo=function(e,t){if(e instanceof fe){var i=e;t=this._calcYaw(i),e=this._clampPitchAngle(this._calcPitch(i,t))}else if(e instanceof de){var n=e;e=n.x,t=n.y}else if(e instanceof Array){var a=e;e=a[0],t=a[1]}this.pitch=e,this.yaw=t},D.prototype.update=function(e){var t;.001<Math.abs(this.dragInertiaFactor-this.inertiaFactor)?(this.dragInertiaFactor=Se.lerp(this.dragInertiaFactor,this.inertiaFactor,.1),t=0===this.dragInertiaFactor?1:Math.min(e/this.dragInertiaFactor,1)):t=0===this.inertiaFactor?1:Math.min(e/this.inertiaFactor,1),this._updateEulerAngles(t),this._updatePosition(t)},D.prototype._updateEulerAngles=function(e){0!==this._targetTranslationSpeed&&(this._translationSpeed=Se.lerp(this._translationSpeed,this._targetTranslationSpeed,e),this.yaw+=this._translationSpeed*this.speed*this.orbitSensitivity),this._yaw=Se.lerp(this._yaw,this._targetYaw,e),this._pitch=Se.lerp(this._pitch,this._targetPitch,e),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0)},D.prototype._updatePosition=function(e){var t=this.entity.getPosition(),i=de.ZERO.clone();if(this._fpsHeight=Se.lerp(this._fpsHeight,this._targetFpsHeight,e),0!==this._translateDistance&&0===this._targetForwardSpeed)if(0!==this._translateTotalDuration){this._translateMoveDuration+=e,this._translateMoveDuration>this._translateTotalDuration&&(this._translateMoveDuration=this._translateTotalDuration);var n=Se.clamp(this._translateMoveDuration/this._translateTotalDuration,0,1);i.lerp(this._startPosition,this._targetPosition,n),this._collisionDetection(i,t,this._fpsHeight),1===n&&(this._translateDistance=0,this._translateTotalDuration=0,rm.fire("edk:plugin:camera:fps:move:end"))}else{var a=this._translateDistance;this._translateDistance=Se.lerp(this._translateDistance,0,e*this.translateSpeed),this._translateDistance<1e-4&&(this._translateDistance=0),i.copy(this._targetDirection).scale(Math.abs(a-this._translateDistance)),i.add(t),this._collisionDetection(i,t,this._fpsHeight)}else this._translateDistance=0,this._forwardSpeed=Se.lerp(this._forwardSpeed,this._targetForwardSpeed,e),this._direction.copy(this._targetDirection),0!==this._forwardSpeed?(0<this._forwardSpeed?(i.x+=this._direction.x*this._forwardSpeed*this.speed,i.z+=this._direction.z*this._forwardSpeed*this.speed):(i.x-=this._direction.x*this._forwardSpeed*this.speed,i.z-=this._direction.z*this._forwardSpeed*this.speed),i.mulScalar(this._forwardSpeed),i.add(t),this._collisionDetection(i,t,this._fpsHeight)):(i.add(t),i.y=this._fpsHeight,this.entity.setPosition(i))},D.prototype._translateTimer=null,D.prototype._collisionDetection=function(e,t,i){var n=this;if(this.entity.script.bvhPicker){var a=this.entity.script.bvhPicker.intersectRay(e,de.DOWN);if(null!==a&&0===a.length){0!==this._translateTotalDuration&&(this._translateTimer&&(clearTimeout(this._translateTimer),this._translateTimer=null),this._translateDistance=0,this._translateTotalDuration=0,this._targetForwardSpeed=1,this._translateTimer=setTimeout(function(){n._targetForwardSpeed=0,clearTimeout(n._translateTimer),n._translateTimer=null},100));var s=this.entity.script.bvhPicker.getCollisionInertia();return void(s&&0!==s.inertia&&(t.add(s.direction.mulScalar(.01*s.inertia)),t.y=i,this.entity.script.bvhPicker.intersectRay(t,de.DOWN).length&&this.entity.setPosition(t)))}}e.y=i,this.entity.setPosition(e)},D.prototype._clampYawAngle=function(e){return this.yawAngleLimit?Se.clamp(e,this.yawAngleMin,this.yawAngleMax):e},D.prototype._clampPitchAngle=function(e){return this.pitchAngleLimit?Se.clamp(e,-this.pitchAngleMax,-this.pitchAngleMin):Se.clamp(e,-90,90)},D.prototype._clampFpsHeight=function(e){return Se.clamp(e,this.fpsHeightMin,this.fpsHeightMax)},D.prototype.quatWithoutYaw=new fe,D.prototype.yawOffset=new fe,D.prototype.transformedForward=new de,D.prototype._calcYaw=function(e){return e.transformVector(de.FORWARD,this.transformedForward),Math.atan2(-this.transformedForward.x,-this.transformedForward.z)*Se.RAD_TO_DEG},D.prototype._calcPitch=function(e,t){return this.yawOffset.setFromEulerAngles(0,-t,0),this.quatWithoutYaw.mul2(this.yawOffset,e),this.quatWithoutYaw.transformVector(de.FORWARD,this.transformedForward),Math.atan2(this.transformedForward.y,-this.transformedForward.z)*Se.RAD_TO_DEG}),E="fpsCameraKeyboardInput",(R=rm.scripts.get(E))||((R=Tv(E)).prototype.initialize=function(){this.keyCode={},this.fpsCamera=this.entity.script.fpsCamera,this.isPressed=!1,this.orbitSensitivity=8,this.on("enable",this.onEnable),this.on("disable",this.onDisable),this.onEnable()},R.prototype.onEnable=function(){this.app.keyboard.on(Ev,this.onKeyDown,this),this.app.keyboard.on("keyup",this.onKeyUp,this)},R.prototype.onDisable=function(){this.app.keyboard.off(Ev,this.onKeyDown,this),this.app.keyboard.off("keyup",this.onKeyUp,this)},R.prototype.onKeyDown=function(e){switch(e.key){case 87:case 83:case 65:case 68:case 38:case 40:case 37:case 39:this.isPressed=!0,this.keyCode[e.key]=this.isPressed}},R.prototype.onKeyUp=function(e){switch(e.key){case 87:case 83:case 38:case 40:this.keyCode[e.key]=!1,this.fpsCamera.forwardSpeed=0;break;case 65:case 68:case 37:case 39:this.fpsCamera.translationSpeed=0,this.keyCode[e.key]=!1}Object.values(this.keyCode).includes(!0)||(this.isPressed=!1)},R.prototype.update=function(e){this.fpsCamera&&this.isPressed&&(this.fpsCamera.direction=this.entity.forward,this.keyCode[65]||this.keyCode[37]?this.fpsCamera.translationSpeed=1:(this.keyCode[68]||this.keyCode[39])&&(this.fpsCamera.translationSpeed=-1),this.keyCode[87]||this.keyCode[38]?this.fpsCamera.forwardSpeed=1:this.keyCode[83]||this.keyCode[40]?this.fpsCamera.forwardSpeed=-1:this.fpsCamera.forwardSpeed=0)}),T="fpsCameraMouseInput",(A=rm.scripts.get(T))||((A=Tv(T)).prototype.initialize=function(){this.fpsCamera=this.entity.script.fpsCamera,this.direction=new de,this.distanceSensitivity=2,this.orbitSensitivity=.1,this.heightSensitivity=3,this.lookButtonDown=!1,this.panButtonDown=!1,this.lastPoint=new J,this.pressPoint=new J,this.pressTimeCount=0,this.singleClickTime=.3,this.cameraRay=new xe,this.fromPoint=new de,this.toPoint=new de,this.on("enable",this.onEnable),this.on("disable",this.onDisable),this.onEnable()},A.prototype.onEnable=function(){this.app.mouse.on(Rv,this.onMouseDown,this),this.app.mouse.on(Iv,this.onMouseUp,this),this.app.mouse.on(Dv,this.onMouseMove,this),this.app.mouse.on(kv,this.onMouseWheel,this),this.app.on("edk:app:window:mouse:out",this.onMouseOut,this),this.lookButtonDown=!1,this.panButtonDown=!1},A.prototype.onDisable=function(){this.app.mouse.off(Rv,this.onMouseDown,this),this.app.mouse.off(Iv,this.onMouseUp,this),this.app.mouse.off(Dv,this.onMouseMove,this),this.app.mouse.off(kv,this.onMouseWheel,this),this.app.off("edk:app:window:mouse:out",this.onMouseOut,this)},A.prototype.onMouseDown=function(e){switch(e.button){case 0:this.lookButtonDown=!0;break;case 1:case 2:this.panButtonDown=!0}this.pressPoint.set(e.x,e.y)},A.prototype.onMouseUp=function(e){switch(e.button){case 0:this.onClick(e),this.lookButtonDown=!1,this.pressTimeCount=0;break;case 1:case 2:this.panButtonDown=!1}},A.prototype.onMouseMove=function(e){this.lookButtonDown?(this.fpsCamera.pitch+=e.dy*this.orbitSensitivity,this.fpsCamera.yaw+=e.dx*this.orbitSensitivity):this.panButtonDown&&(this.fpsCamera.disablePanHeight||this.panHeight(e)),this.lastPoint.set(e.x,e.y)},A.prototype.onMouseWheel=function(e){0<e.wheelDelta?this.direction.copy(this.entity.forward).scale(-1):this.direction.copy(this.entity.forward),this.fpsCamera.direction=this.direction,this.fpsCamera.distance+=Math.abs(e.wheelDelta*this.fpsCamera.speed*this.distanceSensitivity)},A.prototype.onMouseOut=function(e){this.lookButtonDown=!1,this.panButtonDown=!1},A.prototype.onClick=function(e){if(this.lookButtonDown&&0<this.pressTimeCount&&this.pressTimeCount<this.singleClickTime&&Math.pow(e.x-this.pressPoint.x,2)+Math.pow(e.y-this.pressPoint.y,2)<100&&(this.entity.camera.screenToWorld(e.x,e.y,this.entity.camera.nearClip,this.fromPoint),this.entity.camera.screenToWorld(e.x,e.y,this.entity.camera.farClip,this.toPoint),this.cameraRay.origin.copy(this.fromPoint),this.cameraRay.direction.copy(this.toPoint).sub(this.cameraRay.origin).normalize(),this.entity.script.bvhPicker)){var t=this.entity.script.bvhPicker.intersectRay(this.cameraRay.origin,this.cameraRay.direction);if(t&&t.length){var i=t[0].intersectionPoint;this.entity.script.fpsCamera.translateTo(i.x,i.y,i.z)}}},A.prototype.heightDiff=new de,A.prototype.worldDiff=new de,A.prototype.panHeight=function(e){Math.abs(e.y-this.lastPoint.y)>Math.abs(this.lastPoint.x-e.x)&&(this.worldDiff.set(0,-this.lastPoint.y+e.y,0).scale(.1),this.heightDiff.copy(de.ZERO),this.heightDiff.add(this.worldDiff.scale(this.heightSensitivity)),this.heightDiff=this.entity.getWorldTransform().transformVector(this.heightDiff),this.heightDiff.add(this.entity.getPosition()),this.fpsCamera.fpsHeight=this.heightDiff.y)},A.prototype.update=function(e){this.lookButtonDown&&(this.pressTimeCount+=e)}),C="fpsCameraTouchInput",(P=rm.scripts.get(C))||((P=Tv(C)).prototype.initialize=function(){this.fpsCamera=this.entity.script.fpsCamera,this.direction=new de,this.distanceSensitivity=.1,this.orbitSensitivity=.2,this.heightSensitivity=5,this.pinchSensitivity=1,this.lastTouchPoint=new J,this.lastPinchMidPoint=new J,this.lastPinchDistance=0,this.touchPress=!1,this.pressPoint=new J,this.pressTimeCount=0,this.singleClickTime=.3,this.cameraRay=new xe,this.fromPoint=new de,this.toPoint=new de,this.on("enable",this.onEnable,this),this.on("disable",this.onDisable,this),this.onEnable()},P.prototype.onEnable=function(){this.app.touch&&(this.app.touch.on(Lv,this.onTouchStart,this),this.app.touch.on(Ov,this.onTouchEnd,this),this.app.touch.on(zv,this.onTouchStartEndCancel,this),this.app.touch.on(Fv,this.onTouchMove,this))},P.prototype.onDisable=function(){this.app.touch&&(this.app.touch.off(Lv,this.onTouchStart,this),this.app.touch.off(Ov,this.onTouchEnd,this),this.app.touch.off(zv,this.onTouchStartEndCancel,this),this.app.touch.off(Fv,this.onTouchMove,this))},P.prototype.getPinchDistance=function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},P.prototype.calcMidPoint=function(e,t,i){i.set(t.x-e.x,t.y-e.y),i.scale(.5),i.x+=e.x,i.y+=e.y},P.prototype.onTouchStart=function(e){var t=e.touches;1===t.length&&(this.touchPress=!0,this.pressPoint.set(t[0].x,t[0].y)),this.onTouchStartEndCancel(e)},P.prototype.onTouchEnd=function(e){var t=e.touches,i=e.changedTouches;0===t.length&&1===i.length&&(this.onClick(i[0]),this.touchPress=!1,this.pressTimeCount=!1),this.onTouchStartEndCancel(e)},P.prototype.onTouchStartEndCancel=function(e){var t=e.touches;1==t.length?this.lastTouchPoint.set(t[0].x,t[0].y):2==t.length&&(this.lastPinchDistance=this.getPinchDistance(t[0],t[1]),this.calcMidPoint(t[0],t[1],this.lastPinchMidPoint))},P.prototype.onTouchMove=function(e){var t=e.touches;1==t.length?this.onSingleFinger(e):2==t.length&&this.onDoubleFinger(e)},P.prototype.onClick=function(e){if(this.touchPress&&0<this.pressTimeCount&&this.pressTimeCount<this.singleClickTime&&Math.pow(e.x-this.pressPoint.x,2)+Math.pow(e.y-this.pressPoint.y,2)<100&&(this.entity.camera.screenToWorld(e.x,e.y,this.entity.camera.nearClip,this.fromPoint),this.entity.camera.screenToWorld(e.x,e.y,this.entity.camera.farClip,this.toPoint),this.cameraRay.origin.copy(this.fromPoint),this.cameraRay.direction.copy(this.toPoint).sub(this.cameraRay.origin).normalize(),this.entity.script.bvhPicker)){var t=this.entity.script.bvhPicker.intersectRay(this.cameraRay.origin,this.cameraRay.direction);if(t&&t.length){var i=t[0].intersectionPoint;this.entity.script.fpsCamera.translateTo(i.x,i.y,i.z)}}},P.prototype.onSingleFinger=function(e){var t=e.touches[0];this.fpsCamera.pitch-=(t.y-this.lastTouchPoint.y)*this.orbitSensitivity*-1,this.fpsCamera.yaw-=(t.x-this.lastTouchPoint.x)*this.orbitSensitivity*-1,this.lastTouchPoint.set(t.x,t.y)},P.prototype.pinchMidPoint=new J,P.prototype.onDoubleFinger=function(e){var t=e.touches,i=this.getPinchDistance(t[0],t[1]),n=i-this.lastPinchDistance;this.lastPinchDistance=i,this.calcMidPoint(t[0],t[1],this.pinchMidPoint),Math.abs(n)>this.pinchSensitivity?(0<n?this.direction.copy(this.entity.forward):this.direction.copy(this.entity.forward).scale(-1),this.fpsCamera.direction=this.direction,this.fpsCamera.distance+=Math.abs(n*this.fpsCamera.speed*this.distanceSensitivity)):Math.abs(n)<=this.pinchSensitivity&&(this.fpsCamera.disablePanHeight||this.panHeight(this.pinchMidPoint)),this.lastPinchMidPoint.copy(this.pinchMidPoint)},P.prototype.heightDiff=new de,P.prototype.worldDiff=new de,P.prototype.panHeight=function(e){Math.abs(e.y-this.lastPinchMidPoint.y)>Math.abs(this.lastPinchMidPoint.x-e.x)&&(this.worldDiff.set(0,-this.lastPinchMidPoint.y+e.y,0).scale(.1),this.heightDiff.copy(de.ZERO),this.heightDiff.add(this.worldDiff.scale(this.heightSensitivity)),this.heightDiff=this.entity.getWorldTransform().transformVector(this.heightDiff),this.heightDiff.add(this.entity.getPosition()),this.fpsCamera.fpsHeight=this.heightDiff.y)},P.prototype.update=function(e){this.touchPress&&(this.pressTimeCount+=e)}),S="cameraMapping",(w=rm.scripts.get(S))||((w=Tv(S)).prototype.initialize=function(){this.initialized={},rm.method("edk:plugin:camera:mapping:matrix",this.getMappingMatrix,this)},w.prototype.getMappingMatrix=function(){if(this.entity.camera){var e=this.entity.camera.camera.projectionMatrix.clone();return e.mul(this.entity.camera.camera.viewMatrix),Array.from(e.data)}return null},w.prototype.handle=function(e,t){if(e&&!this.initialized[e.name]&&e[t+"CameraMappingLock"]&&e[t+"CameraMappingMatrix"]&&(this.initialized[e.name]=!0,e._preCameraMappingNeededMatrix.set(e[t+"CameraMappingMatrix"])),e&&6===e[t+"MappingType"]){!1===e[t+"CameraMappingLock"]&&(e._preCameraMappingNeededMatrix=this.entity.camera.camera.projectionMatrix.clone(),e._preCameraMappingNeededMatrix.mul(this.entity.camera.camera.viewMatrix));var i=t+"MappingMatrixUniform",n=e[i];n||(n=new Float32Array(16),e[i]=n),n=e._preCameraMappingNeededMatrix.data,e._setParameter(t+"MappingMatrix",n)}else if(e&&7===e[t+"MappingType"]){var a=e[t+"Tiling"];!1===e[t+"CameraMappingLock"]&&(e._preCameraMappingNeededMatrix=(new pe).setOrtho(-a.x,a.x,-a.y,a.y,this.entity.camera.camera.nearClip,this.entity.camera.camera.farClip),e._preCameraMappingNeededMatrix.mul(this.entity.camera.camera.viewMatrix));var s=t+"MappingMatrixUniform",r=e[s];r||(r=new Float32Array(16),e[s]=r),r=e._preCameraMappingNeededMatrix.data,e._setParameter(t+"MappingMatrix",r)}},w.prototype.update=function(){var i=this,e=function(t){rm.scene.layers._meshInstances.forEach(function(e){i.handle(e.material,t+"Map")})};for(var t in Ci)e(t)}),x="annotationPicker",(M=rm.scripts.get(x))||((M=Tv(x)).attributes.add("annotationType",{type:"string"}),M.attributes.add("scaleMode",{type:"boolean",default:!1}),M.attributes.add("angleLock",{type:"boolean",default:!1}),M.attributes.add("pitchLock",{type:"boolean",default:!1}),M.attributes.add("scaling",{type:"number",default:1}),M.attributes.add("angleRange",{type:"number",default:1}),M.attributes.add("pitchRange",{type:"number",default:1}),M.attributes.add("pickerDirection",{type:"vec3",default:[0,0,0]}),M.attributes.add("pickerEntity",{type:"entity"}),M.attributes.add("cameraEntity",{type:"entity"}),M.attributes.add("defaultTexture",{type:"any"}),M.attributes.add("activeResource",{type:"any"}),M.attributes.add("normalResource",{type:"any"}),M.attributes.add("hoverResource",{type:"any"}),M.attributes.add("count",{type:"number",default:0}),M.attributes.add("timelineSwitch",{type:"boolean",default:!1}),Object.defineProperty(M.prototype,"pickerWidth",{get:function(){return this.width},set:function(e){this.width=e}}),Object.defineProperty(M.prototype,"pickerState",{get:function(){return this._pickerState},set:function(e){this._pickerState=e,this.updateResource()}}),M.prototype.initialize=function(){this.vecA=new de,this.vecB=new de,this.vecC=new de,this.vecD=new de,this.vecPQ=new de,this.vecPA=new de,this.vecPB=new de,this.vecPC=new de,this.vecPD=new de,this.vecM=new de,this.vecSCT=new de,this.vecEND=new de,this.worldCoord=new de,this.screenCoord=new de,this.screenCoordTemp=new de,this.cameraWorldTransform=new pe,this.entityWorldTransform=new pe,this.localCoord=new de,this.matA=new pe,this.matB=new pe,this.matC=new pe,this.matD=new pe,this.positiveVisible=!0,this.positiveVisibleTemp=null,this.entity.setLocalScale(0,0,0),this.whiteColor=new $(1,1,1),this.greenColor=new $(0,1,0),this._worldCorners=[new de,new de,new de,new de],this._pickerState="default",this.pickerEntity&&(this.pickerEntity.element.on("click",this.onClick,this),this.pickerEntity.element.on("mouseenter",this.onAnnotationEnter,this),this.pickerEntity.element.on("mouseleave",this.onAnnotationLeave,this),this.pickerEntity.element.on("touchstart",this.onAnnotationEnter,this),this.pickerEntity.element.on("touchmove",this.onAnnotationEnter,this),this.width=this.pickerEntity.element.width,this.height=this.pickerEntity.element.height),this.onEnable(),this.on("enable",this.onEnable),this.on("disable",this.onDisable),this.on("attr",this.onAttr),this.entity.script.fire("initialize",this.__scriptType.__name,this)},M.prototype.onAttr=function(e){switch(e){case"angleLock":case"pitchLock":case"defaultTexture":case"normalResource":case"hoverResource":this.updateResource()}},M.prototype.onEnable=function(){rm.touch&&this.pickerEntity&&(rm.touch.on(Ov,this.onAnnotationLeave,this),rm.touch.on(zv,this.onAnnotationLeave,this))},M.prototype.onDisable=function(){rm.touch&&this.pickerEntity&&(rm.touch.off(zv,this.onAnnotationLeave,this),rm.touch.off(Ov,this.onAnnotationLeave,this))},M.prototype.onAnnotationEnter=function(){"active"!==this.pickerState&&this.pickerEntity&&!this.timelineSwitch&&"viewer"===this.mode&&(this.pickerState="active"),rm.fire("edk:plugin:annotation:enter",this.entity.sceneGuid,this.entity.localGuid)},M.prototype.onAnnotationLeave=function(){"normal"!==this.pickerState&&this.pickerEntity&&!this.timelineSwitch&&"viewer"===this.mode&&(this.pickerState="normal"),rm.fire("edk:plugin:annotation:leave",this.entity.sceneGuid,this.entity.localGuid)},M.prototype.onClick=function(e){if(this.pickerEntity&&this.cameraEntity&&this.getTargetElement(this.cameraEntity.camera,e.x,e.y)){e.event.stopPropagation(),this.count+=1;var t=this.count%2==1&&this.timelineSwitch&&"viewer"===this.mode;this.pickerState=t?"active":"default",this.updateResource(),rm.fire("edk:plugin:annotation:click",this.entity.sceneGuid,this.entity.localGuid,{clickCount:this.count},e)}},M.prototype.updateResource=function(){if(this.pickerEntity)switch(this.pickerState){case"default":case"normal":this.normalResource?"materials"===this.resourceType?(this.pickerEntity.element.texture=null,this.pickerEntity.element.material=this.normalResource,3===this.normalResource.blendType&&(this.recoveryNormalResource=!0,this.normalResource.blendType=4,this.normalResource.update())):(this.pickerEntity.element.material=null,this.pickerEntity.element.texture=this.normalResource,this.pickerEntity.element.material.depthTest=!0,this.pickerEntity.element.material.update()):this.defaultTexture&&(this.pickerEntity.element.material=null,this.pickerEntity.element.texture=this.defaultTexture,this.pickerEntity.element.material.depthTest=!0,this.pickerEntity.element.material.update());break;case"active":this.hoverResource?"materials"===this.resourceType?(this.pickerEntity.element.texture=null,this.pickerEntity.element.material=this.hoverResource,3===this.hoverResource.blendType&&(this.recoveryHoverResource=!0,this.hoverResource.blendType=4,this.hoverResource.update())):(this.pickerEntity.element.material=null,this.pickerEntity.element.texture=this.hoverResource,this.pickerEntity.element.material.depthTest=!0,this.pickerEntity.element.material.update()):this.activeResource&&(this.pickerEntity.element.material=null,this.pickerEntity.element.texture=this.activeResource,this.pickerEntity.element.material.depthTest=!0,this.pickerEntity.element.material.update())}},M.prototype.getWorldCorners=function(){if(this.pickerEntity){if(this.pickerEntity.element.screen);else{var e=this.pickerEntity.getLocalPosition();this.matA.setTranslate(-e.x,-e.y,-e.z),this.matB.setTRS(de.ZERO,this.pickerEntity.getLocalRotation(),this.pickerEntity.getLocalScale()),this.matC.setTranslate(e.x,e.y,e.z),this.matD.copy(this.pickerEntity.parent.getWorldTransform()),this.matD.mul(this.matC).mul(this.matB).mul(this.matA),this.vecA.set(e.x-this.pickerEntity.element.pivot.x*this.width,e.y-this.pickerEntity.element.pivot.y*this.height,e.z),this.matD.transformPoint(this.vecA,this._worldCorners[0]),this.vecA.set(e.x+(1-this.pickerEntity.element.pivot.x)*this.width,e.y-this.pickerEntity.element.pivot.y*this.height,e.z),this.matD.transformPoint(this.vecA,this._worldCorners[1]),this.vecA.set(e.x+(1-this.pickerEntity.element.pivot.x)*this.width,e.y+(1-this.pickerEntity.element.pivot.y)*this.height,e.z),this.matD.transformPoint(this.vecA,this._worldCorners[2]),this.vecA.set(e.x-this.pickerEntity.element.pivot.x*this.width,e.y+(1-this.pickerEntity.element.pivot.y)*this.height,e.z),this.matD.transformPoint(this.vecA,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}return this._worldCorners},M.prototype.getTargetElement=function(e,t,i){return!(!this.pickerEntity||this.pickerEntity.element.screen&&this.pickerEntity.element.screen.screen.screenSpace)&&this._checkElement3d(t,i,e)},M.prototype._checkElement3d=function(e,t,i){var n=rm.graphicsDevice.canvas.clientWidth,a=rm.graphicsDevice.canvas.clientHeight,s=i.rect.z*n,r=i.rect.w*a,o=i.rect.x*n,l=o+s,h=(1-i.rect.y)*a,c=h-r,u=e,d=t;if(o<=e&&e<=l&&t<=h&&c<=d){u=n*(u-o)/s,d=a*(d-c)/r,i.screenToWorld(u,d,i.farClip,this.vecEND);var p=this.getWorldCorners(),f=i.entity.getPosition(),m=this.vecEND;if(this.intersectLineQuad(f,m,p))return!0}return!1},M.prototype.intersectLineQuad=function(e,t,i){if(this.vecPQ.sub2(t,e),this.vecPA.sub2(i[0],e),this.vecPB.sub2(i[1],e),this.vecPC.sub2(i[2],e),this.vecM.cross(this.vecPC,this.vecPQ),0<=this.vecPA.dot(this.vecM)){if(-this.vecPB.dot(this.vecM)<0)return!1;if(this.scalarTriple(this.vecPQ,this.vecPB,this.vecPA)<0)return!1}else{if(this.vecPD.sub2(i[3],e),this.vecPD.dot(this.vecM)<0)return!1;if(this.scalarTriple(this.vecPQ,this.vecPA,this.vecPD)<0)return!1}return!0},M.prototype.scalarTriple=function(e,t,i){return this.vecSCT.cross(e,t).dot(i)},M.prototype.update=function(){if(this.cameraEntity){var e=this.cameraEntity.script.orbitCamera?this.cameraEntity.script.orbitCamera._yaw:this.cameraEntity.script.editorCamera._yaw,t=this.cameraEntity.script.orbitCamera?this.cameraEntity.script.orbitCamera._pitch:this.cameraEntity.script.editorCamera._pitch,i=!0;this.worldCoord.copy(this.entity.getPosition());var n=1;if(this.scaleMode)this.entity.setLocalScale(this.scaling,this.scaling,this.scaling);else{var a=this.cameraEntity.getPosition();if(0===this.cameraEntity.camera.projection){var s=this.vecB.copy(this.worldCoord).sub(a).dot(this.cameraEntity.forward),r=1280/(2*Math.tan(this.cameraEntity.camera.fov*Se.DEG_TO_RAD/2));n=Math.max(1e-4,s/r*150)*this.scaling}else n=this.cameraEntity.camera.orthoHeight/3*this.scaling;this.entity.setLocalScale(n,n,n)}if(this.pickerEntity&&this.pickerEntity.setRotation(this.cameraEntity.getRotation()),this.cameraWorldTransform=this.cameraWorldTransform.copy(this.cameraEntity.getWorldTransform()).invert(),this.cameraWorldTransform.transformPoint(this.worldCoord,this.localCoord),this.screenCoordTemp.copy(this.screenCoord),this.localCoord.z<0?(i=!0,this.cameraEntity.camera.worldToScreen(this.worldCoord,this.screenCoord)):i=!1,i)if(this.screenCoordTemp.sub(this.screenCoord),.05<this.screenCoordTemp.length()&&rm.fire("edk:plugin:annotation:coordinates",this.entity.sceneGuid,this.entity.localGuid,[this.screenCoord.x,this.screenCoord.y]),this.angleLock||this.pitchLock){var o,l,h,c=1;this.angleLock&&("attach"===this.annotationType?c=this.pickerDirection.dot(this.cameraEntity.forward):(l=Math.max(this.angleRange+45,this.angleRange-45),h=Math.min(this.angleRange+45,this.angleRange-45),o=(o=e%360)<0?360+o:o,c=(o=Math.abs(this.angleRange)<45?180<o?o-360:o:315<Math.abs(this.angleRange)?o<180?o+360:o:0<this.angleRange?o:-1*o)<l&&h<o?1:0)),this.pitchLock&&(this.cameraEntity.script.orbitCamera||this.cameraEntity.script.editorCamera)&&30<Math.abs(this.pitchRange-t)&&(c=0),c<.5?(c=0,this.positiveVisible=!1):this.positiveVisible=!0,this.pickerEntity&&("materials"===this.resourceType?(this.pickerEntity.element.material.opacity=c,this.pickerEntity.element.material.update()):this.pickerEntity.element.opacity=c)}else this.positiveVisible=!0,this.pickerEntity&&("materials"===this.resourceType?(this.recoveryNormalResource&&this.normalResource&&3!==this.normalResource.blendType&&(this.normalResource.blendType=3,this.normalResource.opacity=1,this.normalResource.update()),this.recoveryHoverResource&&this.hoverResource&&3!==this.hoverResource.blendType&&(this.hoverResource.blendType=3,this.hoverResource.opacity=1,this.hoverResource.update())):1!==this.pickerEntity.element.opacity&&(this.pickerEntity.element.opacity=1));else this.positiveVisible=!1;this.positiveVisible===this.positiveVisibleTemp&&null!==this.positiveVisibleTemp||(this.positiveVisibleTemp=this.positiveVisible,rm.fire("edk:plugin:annotation:visible",this.entity.sceneGuid,this.entity.localGuid,this.positiveVisible))}},M.prototype.resetPositiveVisible=function(){this.positiveVisible=!0,this.positiveVisibleTemp=!1}),y="annotationAttach",(b=rm.scripts.get(y))||((b=Tv(y)).attributes.add("uuid",{type:"string"}),b.attributes.add("index",{type:"number"}),b.attributes.add("meshIndex",{type:"number",default:-1}),b.attributes.add("point",{type:"array"}),b.attributes.add("localPoint",{type:"array"}),b.attributes.add("edgeScales",{type:"array"}),b.UPDATE_ENTITY=0,b.UPDATE_MESHINSTANCE=1,b.UPDATE_POSITION=2,b.UPDATE_BONE_POSITION=3,b.prototype.initialize=function(){this.updateStatus=b.UPDATE_ENTITY,this.attachEntity=null,this.locking=!1,this.meshInstance=null,this.edgeAB=new de,this.edgeAC=new de,this.edgeAO=new de,this.edgeAP=new de,this.worldTransform=new pe,this.localCoord=new de,this.worldCoord=new de,this.boneIndices=[0,0,0,0],this.boneWeights=[0,0,0,0],this.boneWeightVertices=[new de,new de,new de,new de],this.boneTmpPoints=[new de,new de,new de]},b.prototype.lock=function(){this.locking=!0},b.prototype.unlock=function(){this.locking=!1,this.updateStatus=b.UPDATE_ENTITY},b.prototype.update=function(){this.locking||(this.updateStatus===b.UPDATE_ENTITY?this.updateEntity():this.updateStatus===b.UPDATE_MESHINSTANCE?this.updateMeshInstance():this.updateStatus===b.UPDATE_POSITION?this.updatePosition():this.updateStatus===b.UPDATE_BONE_POSITION&&this.updateBonePosition())},b.prototype.updateEntity=function(){if(this.uuid){var e=rm.call("edk:scene:entity:get",this.entity.sceneGuid,this.uuid);e&&e.entity&&e.entity instanceof Cr&&(this.attachEntity=e.entity,this.updateStatus=b.UPDATE_MESHINSTANCE)}},b.prototype.updateMeshInstance=function(){-1!==this.meshIndex&&"number"==typeof this.meshIndex&&this.attachEntity.model&&this.attachEntity.model.model&&this.attachEntity.model.model.meshInstances[this.meshIndex]&&(this.meshInstance=this.attachEntity.model.model.meshInstances[this.meshIndex],this.updateStatus=b.UPDATE_POSITION)},b.prototype.updatePosition=function(){if(this.meshInstance)if(this.meshInstance.skinInstance){var e=this.meshInstance.mesh.vertexBuffer,t=this.meshInstance.mesh.indexBuffer[0],i=e.format.elements,n=e.format.size,a=0,s=0,r=0,o=0;for(o=0;o<i.length;o++)i[o].name===Te?a=i[o].offset:i[o].name===De?s=i[o].offset:i[o].name===Re&&(r=i[o].offset);this.offsetPF=a/4,this.offsetWF=r/4,this.vertSizeF=n/4,this.vertSize=n,this.offsetI=s,this.data8=new Uint8Array(e.lock()),this.dataF=new Float32Array(e.lock()),this.boneMatrices=this.meshInstance.skinInstance.matrices,this.indices=2===t.bytesPerIndex?new Uint16Array(t.lock()):new Uint32Array(t.lock()),this.updateStatus=b.UPDATE_BONE_POSITION}else{var l;(l=this.localCoord).set.apply(l,this.localPoint),this.worldTransform.copy(this.meshInstance.node.getWorldTransform()),this.worldTransform.transformPoint(this.localCoord,this.worldCoord),this.entity.setPosition(this.worldCoord)}},b.prototype.updateBonePosition=function(){if(this.edgeScales.length){this.worldTransform.copy(this.meshInstance.node.getWorldTransform());var e=0,t=0,i=0;for(e=0;e<3;e++){var n=0;for(i=this.indices[this.index+e],t=0;t<4;t++)this.boneIndices[t]=this.data8[i*this.vertSize+this.offsetI+t],this.boneWeights[t]=this.dataF[i*this.vertSizeF+this.offsetPF+this.offsetWF+t],n+=this.boneWeights[t];for(i=i*this.vertSizeF+this.offsetPF,this.boneTmpPoints[e].set(this.dataF[i],this.dataF[i+1],this.dataF[i+2]),t=0;t<4;t++)this.boneMatrices[this.boneIndices[t]].transformPoint(this.boneTmpPoints[e],this.boneWeightVertices[t]),this.boneWeightVertices[t].mulScalar(this.boneWeights[t]/n);this.boneTmpPoints[e].copy(this.boneWeightVertices[0]).add(this.boneWeightVertices[1]).add(this.boneWeightVertices[2]).add(this.boneWeightVertices[3]),this.worldTransform.transformPoint(this.boneTmpPoints[e],this.boneTmpPoints[e])}this.edgeAB.sub2(this.boneTmpPoints[1],this.boneTmpPoints[0]),this.edgeAC.sub2(this.boneTmpPoints[2],this.boneTmpPoints[0]),this.edgeAP.add2(this.edgeAB.mulScalar(this.edgeScales[0]),this.edgeAC.mulScalar(this.edgeScales[1])),this.worldCoord.add2(this.edgeAP,this.boneTmpPoints[0]),this.entity.setPosition(this.worldCoord)}}),e.sizer&&(g="entitySizer",(_=rm.scripts.get(g))||((_=Tv(g)).attributes.add("size",{type:"vec3",default:[0,0,0]}),_.attributes.add("_xSize",{type:"string",default:"0"}),_.attributes.add("_ySize",{type:"string",default:"0"}),_.attributes.add("_zSize",{type:"string",default:"0"}),_.attributes.add("unit",{type:"string",default:"cm"}),_.attributes.add("exclude",{type:"array",default:[]}),_.attributes.add("render",{type:"boolean",default:!1}),_.attributes.add("color",{type:"array",default:[.4,.4,.4]}),_.attributes.add("thickness",{type:"number",default:.2}),_.worldTransform=new pe,_.quat=new fe,_.px=new de,_.tx=new de,_.tbx=new de,_.nx=new de,_.py=new de,_.ty=new de,_.tby=new de,_.ny=new de,_.pz=new de,_.tz=new de,_.tbz=new de,_.nz=new de,_.tmpVec=new de,_.lineColor=new $(1,1,1),_.prototype.initialize=function(){this.axis={},this.scaleMin=1,this.scaleMin_x=1,this.scaleMin_y=1,this.scaleMin_z=1,this._xSize=0,this._ySize=0,this._zSize=0,this.lineMaterial=this.createCylinderMaterial(this.color),this.updateScaleFactor(),this.createTextEntity("x"),this.createTextEntity("y"),this.createTextEntity("z"),this.root=new Cr,this.root.name="Sizer Root",this.updatePoints(),this.root.addChild(this.axis.x.root),this.root.addChild(this.axis.y.root),this.root.addChild(this.axis.z.root),this.entity.addChild(this.root),this.axis.x.root.enabled=!1,this.axis.y.root.enabled=!1,this.axis.z.root.enabled=!1,this.updateTextEntity(),this.createCylinderEntity("x"),this.createCylinderEntity("y"),this.createCylinderEntity("z"),this.on("attr:render",function(e){e?(this.axis.x.root.enabled=!0,this.axis.y.root.enabled=!0,this.axis.z.root.enabled=!0):(this.axis.x.root.enabled=!1,this.axis.y.root.enabled=!1,this.axis.z.root.enabled=!1)}),this.on("attr:unit",function(){this.axis.x.textEntity.element.text=this._xSize+" "+this.unit,this.axis.y.textEntity.element.text=this._ySize+" "+this.unit,this.axis.z.textEntity.element.text=this._zSize+" "+this.unit,this.axis.x.textEntityBack.element.text=this._xSize+" "+this.unit,this.axis.y.textEntityBack.element.text=this._ySize+" "+this.unit,this.axis.z.textEntityBack.element.text=this._zSize+" "+this.unit}),this.on("destroy",this.onDestroy,this),rm.once("edk:app:font:asset",this.setFontAsset.bind(this))},Object.defineProperty(_.prototype,"xSize",{get:function(){return this._xSize},set:function(e){1==isNaN(e)?e=0:0!==e&&(e=Number(e.toFixed(2))),this._xSize=e,this.axis.x.textEntity.element.text=this._xSize+" "+this.unit,this.axis.x.textEntityBack.element.text=this._xSize+" "+this.unit}}),Object.defineProperty(_.prototype,"ySize",{get:function(){return this._ySize},set:function(e){1==isNaN(e)?e=0:0!==e&&(e=Number(e.toFixed(2))),this._ySize=e,this.axis.y.textEntity.element.text=this._ySize+" "+this.unit,this.axis.y.textEntityBack.element.text=this._ySize+" "+this.unit}}),Object.defineProperty(_.prototype,"zSize",{get:function(){return this._zSize},set:function(e){1==isNaN(e)?e=0:0!==e&&(e=Number(e.toFixed(2))),this._zSize=e,this.axis.z.textEntity.element.text=this._zSize+" "+this.unit,this.axis.z.textEntityBack.element.text=this._zSize+" "+this.unit}}),_.prototype.updateScaleFactor=function(){var t=this,e=(this.entity.aabb.halfExtents.x+this.entity.aabb.halfExtents.y+this.entity.aabb.halfExtents.z)/3;this.fontSize=.15*e/this.scaleMin*.8,this.lineOffset=.15*e*.6,this.lateralLineLength=.4*this.lineOffset,this.fontOffset=.6*this.lineOffset,this.cylinderDiameter=.15*e/this.scaleMin*this.thickness,this.root&&this.root.setLocalScale(1/this.entity.localScale.x,1/this.entity.localScale.y,1/this.entity.localScale.z),["x","y","z"].forEach(function(e){t.updateScaleMin(e,t.entity.parent)})},_.prototype.setFontAsset=function(t){var i=this;["x","y","z"].forEach(function(e){t&&(i.axis[e].textEntity.element.fontAsset=t,i.axis[e].textEntityBack.element.fontAsset=t)})},_.prototype.createTextEntity=function(e){this.axis[e]={},this.axis[e].root=new Cr,this.axis[e].root.name=e+"Root",this.axis[e].root.addComponent("screen",{resolution:new J(2*this.entity.aabb.halfExtents[e],this.fontSize)}),this.axis[e].textEntity=new Cr,this.axis[e].textEntity.name=e+"Text",this.axis[e].textEntity.addComponent("element",{type:"text"}),this.axis[e].textEntity.element.fontAsset=rm.call("edk:app").fontAsset,this.axis[e].textEntity.element.fontSize=this.fontSize,this.axis[e].textEntity.element.lineHeight=this.fontSize,this.axis[e].textEntity.element.layers=[0],this.axis[e].textEntity.element.color=new $(this.color[0],this.color[1],this.color[2]),this.axis[e].textEntity.element.text=this[e+"Size"]+" "+this.unit,this.axis[e].textEntityBack=new Cr,this.axis[e].textEntityBack.name=e+"TextBack",this.axis[e].textEntityBack.addComponent("element",{type:"text"}),this.axis[e].textEntityBack.element.fontAsset=rm.call("edk:app").fontAsset,this.axis[e].textEntityBack.element.fontSize=this.fontSize,this.axis[e].textEntityBack.element.lineHeight=this.fontSize,this.axis[e].textEntityBack.element.layers=[0],this.axis[e].textEntityBack.element.color=new $(this.color[0],this.color[1],this.color[2]),this.axis[e].textEntityBack.element.text=this[e+"Size"]+" "+this.unit,this.axis[e].root.addChild(this.axis[e].textEntity),this.axis[e].root.addChild(this.axis[e].textEntityBack)},_.prototype.createCylinderEntity=function(e){this.axis[e].axisLeft=new Cr,this.axis[e].axisLeft.name="axisLeft "+e,this.axis[e].axisLeft.addComponent("model",{type:"cylinder",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.axis[e].axisLeft.model.material=this.lineMaterial,this.axis[e].axisLeft.setLocalScale(0,0,0),this.axis[e].axisCenter=new Cr,this.axis[e].axisCenter.name="AxisCenter "+e,this.axis[e].axisCenter.addComponent("model",{type:"cylinder",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.axis[e].axisCenter.model.material=this.lineMaterial,this.axis[e].axisCenter.setLocalScale(0,0,0),this.axis[e].axisRight=new Cr,this.axis[e].axisRight.name="axisRight "+e,this.axis[e].axisRight.addComponent("model",{type:"cylinder",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.axis[e].axisRight.model.material=this.lineMaterial,this.axis[e].axisRight.setLocalScale(0,0,0),this.axis[e].root.addChild(this.axis[e].axisLeft),this.axis[e].root.addChild(this.axis[e].axisCenter),this.axis[e].root.addChild(this.axis[e].axisRight)},_.prototype.createCylinderMaterial=function(e,t){var i=new gm;return i.diffuse.set(0,0,0),i.specular.set(0,0,0),i.shininess=0,i.useLighting=!1,i.useSkybox=!1,i.cull=0,t&&(i.name=t),e&&(i.emissive=z($,this.color)),i.update(),i},_.prototype.updatePoints=function(){var e=_.px,t=_.tx,i=_.tbx,n=_.nx,a=_.py,s=_.ty,r=_.tby,o=_.ny,l=_.pz,h=_.tz,c=_.tbz,u=_.nz,d=_.tmpVec,p=this.entity.aabb.halfExtents,f=this.axis.x.textEntity.element.textWidth*this.scaleMin,m=this.axis.y.textEntity.element.textWidth*this.scaleMin,v=this.axis.z.textEntity.element.textWidth*this.scaleMin;e.copy(this.entity.aabb.center).add(d.set(p.x,-p.y,p.z+this.lineOffset)),n.copy(this.entity.aabb.center).add(d.set(-p.x,-p.y,p.z+this.lineOffset)),t.copy(n).add(e).add(d.set(-f*this.scaleMin_x,.1*this.fontOffset,5*this.fontOffset)).mulScalar(.5),i.copy(n).add(e).add(d.set(-f*this.scaleMin_x,.1*this.fontOffset,.5*this.fontOffset)).mulScalar(.5),a.copy(this.entity.aabb.center).add(d.set(p.x+this.lineOffset,p.y,-p.z-this.lineOffset)),o.copy(this.entity.aabb.center).add(d.set(p.x+this.lineOffset,-p.y,-p.z-this.lineOffset)),s.copy(o).add(a).add(d.set(.5*this.fontOffset,0,0)).mulScalar(.5),r.copy(o).add(a).add(d.set(this.fontOffset+2*m*this.scaleMin_x,0,0)).mulScalar(.5),l.copy(this.entity.aabb.center).add(d.set(p.x+this.lineOffset,-p.y,p.z)),u.copy(this.entity.aabb.center).add(d.set(p.x+this.lineOffset,-p.y,-p.z)),h.copy(u).add(l).add(d.set(5*this.fontOffset,.1*this.fontOffset,v*this.scaleMin_z)).mulScalar(.5),c.copy(u).add(l).add(d.set(.5*this.fontOffset,.1*this.fontOffset,v*this.scaleMin_z)).mulScalar(.5)},_.prototype.updateTextEntity=function(){var t=this;this.axis.x.textEntity.setPosition(_.tx),this.axis.y.textEntity.setPosition(_.ty),this.axis.z.textEntity.setPosition(_.tz),this.axis.x.textEntityBack.setPosition(_.tbx),this.axis.y.textEntityBack.setPosition(_.tby),this.axis.z.textEntityBack.setPosition(_.tbz),this.axis.x.textEntity.setRotation(_.quat.setFromEulerAngles(-90,0,0)),this.axis.z.textEntity.setRotation(_.quat.setFromEulerAngles(-90,90,0)),this.axis.x.textEntityBack.setRotation(_.quat.setFromEulerAngles(90,0,0)),this.axis.y.textEntityBack.setRotation(_.quat.setFromEulerAngles(0,180,0)),this.axis.z.textEntityBack.setRotation(_.quat.setFromEulerAngles(90,90,0)),this.axis.x.textEntity.setLocalScale(1/this.scaleMin_x*this.scaleMin_x,1/this.scaleMin_z*this.scaleMin_x,1),this.axis.x.textEntityBack.setLocalScale(1/this.scaleMin_x*this.scaleMin_x,1/this.scaleMin_z*this.scaleMin_x,1),this.axis.y.textEntity.setLocalScale(1/this.scaleMin_x*this.scaleMin_y,1/this.scaleMin_y*this.scaleMin_y,1),this.axis.y.textEntityBack.setLocalScale(1/this.scaleMin_x*this.scaleMin_y,1/this.scaleMin_y*this.scaleMin_y,1),this.axis.z.textEntity.setLocalScale(1/this.scaleMin_z*this.scaleMin_z,1/this.scaleMin_x*this.scaleMin_z,1),this.axis.z.textEntityBack.setLocalScale(1/this.scaleMin_z*this.scaleMin_z,1/this.scaleMin_x*this.scaleMin_z,1),["x","y","z"].forEach(function(e){t.axis[e].textEntity.element.fontSize=t.fontSize/t["scaleMin_"+e],t.axis[e].textEntity.element.lineHeight=t.fontSize/t["scaleMin_"+e],t.axis[e].textEntity.element.color=new $(t.color[0],t.color[1],t.color[2]),t.axis[e].textEntityBack.element.fontSize=t.fontSize/t["scaleMin_"+e],t.axis[e].textEntityBack.element.lineHeight=t.fontSize/t["scaleMin_"+e],t.axis[e].textEntityBack.element.color=new $(t.color[0],t.color[1],t.color[2])})},_.prototype.updateRenderCylinder=function(){var e,t=_.px,i=_.nx,n=_.py,a=_.ny,s=_.pz,r=_.nz,o=_.tmpVec,l=_.quat,h=(e=_.lineColor).set.apply(e,this.color);this.lineMaterial.emissive=h,this.lineMaterial.update(),this.axis.x.axisLeft.setRotation(l.setFromEulerAngles(-90,0,0)),this.axis.x.axisLeft.setLocalScale(this.cylinderDiameter/this.scaleMin_x,this.lateralLineLength/this.scaleMin_z,this.cylinderDiameter/this.scaleMin_y),this.axis.x.axisLeft.setPosition(i.x,i.y,i.z-this.lateralLineLength/2),this.axis.x.axisCenter.setRotation(l.setFromEulerAngles(-90,-90,0)),this.axis.x.axisCenter.setLocalScale(this.cylinderDiameter/this.scaleMin_z,2*this.entity.aabb.halfExtents.x/this.scaleMin_x,this.cylinderDiameter/this.scaleMin_y),this.axis.x.axisCenter.setPosition(o.copy(i).add(t).mulScalar(.5)),this.axis.x.axisRight.setRotation(l.setFromEulerAngles(-90,0,0)),this.axis.x.axisRight.setLocalScale(this.cylinderDiameter/this.scaleMin_x,this.lateralLineLength/this.scaleMin_z,this.cylinderDiameter/this.scaleMin_y),this.axis.x.axisRight.setPosition(t.x,t.y,t.z-this.lateralLineLength/2),this.axis.y.axisLeft.setRotation(l.setFromEulerAngles(-90,0,0)),this.axis.y.axisLeft.setLocalScale(this.cylinderDiameter/this.scaleMin_x,this.lateralLineLength/this.scaleMin_z,this.cylinderDiameter/this.scaleMin_y),this.axis.y.axisLeft.setPosition(a.x,a.y,a.z+this.lateralLineLength/2),this.axis.y.axisCenter.setRotation(l.setFromEulerAngles(0,0,0)),this.axis.y.axisCenter.setLocalScale(this.cylinderDiameter/this.scaleMin_x,2*this.entity.aabb.halfExtents.y/this.scaleMin_y,this.cylinderDiameter/this.scaleMin_z),this.axis.y.axisCenter.setPosition(o.copy(a).add(n).mulScalar(.5)),this.axis.y.axisRight.setRotation(l.setFromEulerAngles(-90,0,0)),this.axis.y.axisRight.setLocalScale(this.cylinderDiameter/this.scaleMin_x,this.lateralLineLength/this.scaleMin_z,this.cylinderDiameter/this.scaleMin_y),this.axis.y.axisRight.setPosition(n.x,n.y,n.z+this.lateralLineLength/2),this.axis.z.axisLeft.setRotation(l.setFromEulerAngles(-90,-90,0)),this.axis.z.axisLeft.setLocalScale(this.cylinderDiameter/this.scaleMin_z,this.lateralLineLength/this.scaleMin_x,this.cylinderDiameter/this.scaleMin_y),this.axis.z.axisLeft.setPosition(r.x-this.lateralLineLength/2,r.y,r.z),this.axis.z.axisCenter.setRotation(l.setFromEulerAngles(-90,0,0)),this.axis.z.axisCenter.setLocalScale(this.cylinderDiameter/this.scaleMin_x,2*this.entity.aabb.halfExtents.z/this.scaleMin_z,this.cylinderDiameter/this.scaleMin_y),this.axis.z.axisCenter.setPosition(o.copy(r).add(s).mulScalar(.5)),this.axis.z.axisRight.setRotation(l.setFromEulerAngles(-90,-90,0)),this.axis.z.axisRight.setLocalScale(this.cylinderDiameter/this.scaleMin_z,this.lateralLineLength/this.scaleMin_x,this.cylinderDiameter/this.scaleMin_y),this.axis.z.axisRight.setPosition(s.x-this.lateralLineLength/2,s.y,s.z)},_.prototype.updateRenderLines=function(){},_.prototype.updateScaleMin=function(e,t){t===this.entity.parent&&(this["scaleMin_"+e]=1),this["scaleMin_"+e]*=t.localScale[e],t.parent&&this.updateScaleMin(e,t.parent)},_.prototype.update=function(){this.render&&(this.updateScaleFactor(),this.updatePoints(),this.updateRenderCylinder(),this.updateTextEntity())},_.prototype.onDestroy=function(){var t=this;["x","y","z"].forEach(function(e){t.axis[e]&&(t.axis[e].root.destroy(),t.axis[e].root=null,t.axis[e].textEntity=null,t.axis[e].textEntityBack=null,t.axis[e].axisLeft=null,t.axis[e].axisCenter=null,t.axis[e].axisRight=null,t.axis[e]=null,delete t.axis[e])}),this.axis=null,this.scaleMin=1,this.scaleMin_x=1,this.scaleMin_y=1,this.scaleMin_z=1,this._xSize=0,this._ySize=0,this._zSize=0,this.lineMaterial&&(this.lineMaterial.destroy(),this.lineMaterial=null),this.root&&(this.root.destroy(),this.root=null),this.off()})),e.explode&&((v=rm.scripts.get("explode"))||((v=Tv("explode")).attributes.add("scale",{type:"number",default:0}),v.prototype.initialize=function(){var s=this;this.nodes=[],this.nodeAabb={},this.nodePos={},this.direction={},this.posToAabb={},this.scope=2,this.initAabb(),this.nodes=this.entity.model.model.meshInstances.map(function(e){return e.node.uid=B(),(e.node.mesh=e).node}),this.nodes.forEach(function(e){var t=e.getPosition(),i=e.mesh.aabb.center,n=s.entity.aabb.center;s.nodePos[e.uid]=t,s.posToAabb[e.uid]=(new de).sub2(i,t);var a=new de(i.x+(i.x-n.x)*s.scope,i.y+(i.y-n.y)*s.scope,i.z+(i.z-n.z)*s.scope);s.direction[e.uid]=(new de).sub2(a,i),s.nodeAabb[e.uid]=(new de).copy(i)})},v.prototype.setExplode=function(v){var g=this;this.scale=v,1<Object.keys(this.direction).length&&1<Object.keys(this.nodeAabb).length&&this.nodes.forEach(function(e){if(e)if(v<.5){var t=2*v,i=g.nodePos[e.uid],n=i.x,a=i.y,s=i.z,r=g.posToAabb[e.uid],o=r.x,l=r.y,h=r.z;e.children.length||e.setPosition(n+o*t,a+l*t,s+h*t)}else if(.5<=v){var c=2*(v-.5),u=g.direction[e.uid],d=u.x,p=u.y,f=u.z,m=g.nodeAabb[e.uid];e.children.length||e.setPosition(m.x+d*c,m.y+p*c,m.z+f*c)}})},v.prototype.initAabb=function(e){var i=this;this.entity.aabb=new ue,this.entity.model&&this.entity.model.model&&this.entity.model.model.meshInstances.forEach(function(e,t){0===t?i.entity.aabb.copy(e.aabb):i.entity.aabb.add(e.aabb)})},v.prototype.update=function(e){})),p="entityPicker",(f=rm.scripts.get(p))||((f=Tv(p)).attributes.add("doubleClickDelay",{type:"number",default:.5}),f.attributes.add("hoverDetection",{type:"boolean",default:!1}),f.prototype.initialize=function(){this.longPressTime=0,this.longTimerEnabled=!1,this.longPress=!1,this.doubleClickTime=0,this.mouseStatus="up",this.pickerResult={entity:null,entityUuid:null,meshInstance:null,meshIndex:-1},this.picker=new qm(rm,1024,1024),this.lastPoint=new J,this.fromPoint=new de,this.toPoint=new de,this.ray=new xe,this.on("attr:hoverDetection",function(e){e||rm.fire("edk:plugin:entity:picker:hover",null)}),this.on("enable",this.onEnable),this.on("disable",this.onDisable),this.onEnable()},f.prototype.onEnable=function(){rm.mouse&&(rm.mouse.on(Rv,this.onMouseDown,this),rm.mouse.on(Dv,this.onMouseMove,this),rm.mouse.on(Iv,this.onMouseUp,this)),rm.touch&&(rm.touch.on(Lv,this.onTouchStartEndCancel,this),rm.touch.on(Ov,this.onTouchStartEndCancel,this),rm.touch.on(zv,this.onTouchStartEndCancel,this))},f.prototype.onDisable=function(){rm.mouse&&(rm.mouse.off(Rv,this.onMouseDown,this),rm.mouse.off(Iv,this.onMouseUp,this),rm.mouse.off(Dv,this.onMouseMove,this)),rm.touch&&(rm.touch.off(Lv,this.onTouchStartEndCancel,this),rm.touch.off(Ov,this.onTouchStartEndCancel,this),rm.touch.off(zv,this.onTouchStartEndCancel,this))},f.prototype.onMouseDown=function(e){switch(e.button){case 0:this.mouseStatus="down",this.longTimerEnabled=!0}},f.prototype.onMouseMove=function(e){if(this.hoverDetection){var t=this.getResults(e);if(t){var i=t.intersects,n=t.entity,a=t.meshIndex;rm.fire("edk:plugin:entity:picker:hover",n.sceneGuid,n.localGuid,a,i),this.longPress&&rm.fire("edk:plugin:entity:picker:press",n.sceneGuid,n.localGuid,a,i,e)}else rm.fire("edk:plugin:entity:picker:hover",null)}},f.prototype.onMouseUp=function(e){switch(e.button){case 0:rm.fire("edk:plugin:entity:picker:mouseup");var t=!1;this.mouseStatus="up",this.longPress=!1,0<this.doubleClickTime&&this.doubleClickTime<this.doubleClickDelay&&Math.pow(e.x-this.lastPoint.x,2)+Math.pow(e.y-this.lastPoint.y,2)<100?(this.doubleClickTime=0,this.onDoubleClick(e),t=!0):this.doubleClickTime=0,Math.pow(e.x-this.lastPoint.x,2)+Math.pow(e.y-this.lastPoint.y,2)<100&&(t=!0),this.longTimerEnabled&&this.longPressTime<this.doubleClickDelay/2&&this.onClick(e,t),this.lastPoint.set(e.x,e.y)}},f.prototype.onTouchStartEndCancel=function(e){this.onClick(e)},f.prototype.onClick=function(e,t){var i=this.getResults(e);if(i){var n=i.intersects,a=i.entity,s=i.meshIndex;rm.fire("edk:plugin:entity:picker:click",a.sceneGuid,a.localGuid,s,n,e,t)}else rm.fire("edk:plugin:entity:picker:click",null)},f.prototype.onDoubleClick=function(e){var t=this.getResults(e);if(t){var i=t.intersects,n=t.entity,a=t.meshIndex;rm.fire("edk:plugin:entity:picker:double:click",n.sceneGuid,n.localGuid,a,i)}else rm.fire("edk:plugin:entity:picker:double:click",null)},f.prototype.doRaycast=function(e){return e?rm.systems.camera.raycastMeshInstances(this.ray,e):null},f.prototype.getMeshes=function(e){var t=this;return rm.scene.layers._meshInstances.filter(function(e){return e.aabb.intersectsRay(t.ray)})},f.prototype.getEntityByMesh=function(e){var t=this.getMeshes(e),r=this.entity.getPosition();return 0<t.length&&t.map(function(t){for(var e=t.node;null!==(null==(i=e)?void 0:i.parent)&&!(e instanceof Cr&&void 0!==e.type);){var i;e=e.parent}if(e instanceof Cr){if(t)if(e.model&&e.model.model&&e.model.model.meshInstances.length){var n=e.model.model.meshInstances.findIndex(function(e){return e===t});if(-1!==n){var a=e.getPosition();return{id:e.getGuid(),entity:e,meshIndex:n,meshInstance:t,distance:Math.sqrt(Math.pow(a.x-r.x,2)+Math.pow(a.y-r.y,2)+Math.pow(a.z-r.z,2))}}}else if(e.element){var s=(e=e._system?e.parent:e).getPosition();return{id:e.getGuid(),entity:e,meshIndex:0,meshInstance:t,distance:Math.sqrt(Math.pow(s.x-r.x,2)+Math.pow(s.y-r.y,2)+Math.pow(s.z-r.z,2))}}return null}return null}).filter(function(e){return!!e})},f.prototype.getResults=function(l){var h=this;this.entity.camera.screenToWorld(l.x,l.y,this.entity.camera.nearClip,this.fromPoint),this.entity.camera.screenToWorld(l.x,l.y,this.entity.camera.farClip,this.toPoint),this.ray.origin.copy(this.fromPoint),this.ray.direction.copy(this.toPoint).sub(this.ray.origin).normalize();var e=this.getEntityByMesh(l);if(e&&e.length){var c={};e.forEach(function(e){var t=e.id,i=e.entity,n=e.meshIndex,a=e.meshInstance,s=e.distance;if("annotation"===i.type)i.script&&i.script.annotationPicker&&i.script.annotationPicker.getTargetElement(h.entity.camera,l.x,l.y)&&(c[s]={id:t,entity:i,meshIndex:n,meshInstance:a,intersects:[]});else{var r=h.doRaycast(a);if(r&&r.length){var o=Math.min.apply(Math,r.map(function(e){return e.distance}));c[o]={id:t,entity:i,meshIndex:n,meshInstance:a,intersects:r}}}}),Object.keys(c).length||e.forEach(function(e){var t=e.id,i=e.entity,n=e.meshIndex,a=e.meshInstance,s=e.distance;c[s]={id:t,entity:i,meshIndex:n,meshInstance:a,intersects:[]}});var t=Math.min.apply(Math,Object.keys(c).map(function(e){return Number(e)}));return c[t]}return null},f.prototype.getSelection=function(e){return this.picker.resize(rm.graphicsDevice.canvas.clientWidth,rm.graphicsDevice.canvas.clientHeight),this.picker.prepare(this.entity.camera,rm.scene),this.picker.getSelection(e.x,e.y)},f.prototype.getSelectEntity=function(e){var t=this.getSelection(e);if(this.pickerResult.entity=null,this.pickerResult.entityUuid=null,this.pickerResult.meshIndex=-1,this.pickerResult.meshInstance=null,0<t.length&&t[0]){var i=null;t[0]instanceof Mn&&(i=t[0]);for(var n=t[0].node;null!==n&&(!(n instanceof Cr&&void 0!==n.type)||n._system);)n=n.parent;if(n instanceof Cr&&(this.pickerResult.entity=n,this.pickerResult.entityUuid=n.getGuid(),i&&n.model&&n.model.model&&n.model.model.meshInstances.length)){var a=n.model.model.meshInstances.findIndex(function(e){return e===i});-1!==a&&(this.pickerResult.meshIndex=a,this.pickerResult.meshInstance=i)}var s=Math.min.apply(Math,Object.keys(distToObj).map(function(e){return Number(e)}));return distToObj[s]}return null},f.prototype.update=function(e){this.longTimerEnabled&&(this.longPressTime+=e,this.longPressTime>this.doubleClickDelay/2&&(this.longPressTime=0,this.longTimerEnabled=!1,"down"===this.mouseStatus&&(this.longPress=!0))),this.doubleClickTime+=e},f.prototype.printTriangle=function(e){}),u=["measure_selection_area","measure_label","measure_length","markerItem"],d="entityRange",(m=rm.scripts.get(d))||((m=Tv(d)).attributes.add("enableMouse",{type:"boolean",default:!1}),m.attributes.add("range",{type:"string",default:"0"}),m.attributes.add("unit",{type:"string",default:"mm"}),m.attributes.add("color",{type:"array",default:[0,0,0]}),m.attributes.add("thickness",{type:"number",default:.5}),m.worldTransform=new pe,m.quat=new fe,m.textPoint=new de,m.tmpVec=new de,m.origin=new de,m.midPoint=new de,m.lineColor=new $(1,1,1),m.prototype.initialize=function(){rm.method("rdk:entity:range:clear",this.onClearByIndex.bind(this)),rm.method("rdk:entity:range:endpoint",this.onEndPointChanged.bind(this)),rm.method("rdk:entity:range:enabled",this.onEnabled.bind(this)),rm.on("edk:plugin:entity:picker:click",this.onClick.bind(this)),rm.on("edk:plugin:entity:picker:hover",this.onPickerHover.bind(this)),this.on("attr:unit",function(e,t){switch(e){case"mm":this.thickness=.1;break;case"cm":this.thickness=.5;break;case"m":this.thickness=1}}),this.data=[],this.vertexes=[],this.relativeVertexes=[],this.midPoints=[],this.rangings=[],this.firstSpheres=[],this.secondSpheres=[],this.cylinders=[],this.deletedIndex=[],this.scaleMin=1,this.scale=4,this.enabled=!1,this.originDistance=0===this.entity.script.orbitCamera._distance?1:this.entity.script.orbitCamera._distance,this.root=new Cr,this.root.name="Range Root",this.root.enabled=!0,this.entity.addChild(this.root),this.firstIndex=0,this.endIndex=1,this.hover=!1,this.changingPointIndex=[-1,0],this.pickerInfo=[]},m.prototype.onEnabled=function(e){(this.enabled=e)?this.onEnableAll():this.onClearAll()},m.prototype.onClick=function(e,t,i,n,a,s){if(this.enabled&&n&&!s){for(var r=0;r<u.length;r++)if(a&&a.element&&-1!==a.element.className.indexOf(u[r]))return;if(-1!==this.changingPointIndex[0])this.changingPointIndex[0]=-1,this.fireClick.apply(this,[!1].concat(this.pickerInfo,[0]));else if(null!=n&&n.length){var o=n[0].point,l=[o.x,o.y,o.z];if(this.data[this.firstIndex]){if(this.hover)return this.fireClick.apply(this,[!1].concat(this.pickerInfo,[1])),this.hover=!1,this.firstIndex=this.data.length,void(this.endIndex=this.data.length+1)}else this.data[this.firstIndex]=l,this.initVertexes(this.firstIndex),this.onRefreshMaterial(),this.createFirstEntity(),this.createRestEntity(),this.hover=!0,this.fireClick(!0,t,i,n,0);this.updatePoints()}}},m.prototype.onPickerHover=function(e,t,i,n){if(this.enabled&&null!=n&&n.length){var a=n[0].point,s=[a.x,a.y,a.z];if(this.hover&&this.data[this.firstIndex]&&(this.data[this.endIndex]=s,this.initVertexes(this.endIndex),this.calculateRanging(),this.updatePoints()),-1!==this.changingPointIndex[0]){var r=this.changingPointIndex[0],o=this.changingPointIndex[1];this.data[2*r]&&(this.data[2*r+o]=s,this.initVertexes(2*r+o),this.calculateRanging(),this.updatePoints())}-1!==i&&n&&(this.pickerInfo=[t,i,n])}},m.prototype.onEndPointChanged=function(e,t){-1<e&&(this.onSwitchHoverDetection(!0),this.changingPointIndex=[e,t])},m.prototype.fireClick=function(e,t,i,n,a){this.onSwitchHoverDetection(e),rm.fire("rdk:plugin:range:click",t,i,n,a)},m.prototype.onSwitchHoverDetection=function(e){rm.call("edk:render:camera:update:component","entityPicker","hoverDetection",e)},m.prototype.initVertexes=function(e){var t=m.origin,i=this.entity.aabb.halfExtents,n=this.relativeVertexes;if(t.copy(this.entity.aabb.center).sub(new de(i.x,i.y,i.z)),this.data[e]){var a=z(de,this.data[e]);n[e]=a.sub(t)}this.vertexes[e]=new de},m.prototype.calculateRanging=function(){for(var e=0;e<this.vertexes.length;e+=2){var t=this.data[e],i=this.data[e+1];if(i){var n=Math.pow(t[0]-i[0],2),a=Math.pow(t[1]-i[1],2),s=Math.pow(t[2]-i[2],2);this.rangings[e/2]=Math.sqrt(n+a+s),rm.fire("rdk:entity:range:length",e/2,(100*this.rangings[e/2]).toFixed(1))}else this.data.splice(e,1)}},m.prototype.createFirstEntity=function(){var e=new Cr;e.name=this.firstSpheres.length+1+".FirstSphere",e.addComponent("model",{type:"sphere",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),e.model.material=this.lineMaterial,e.setLocalScale(0,0,0),this.root.addChild(e),this.firstSpheres.push(e)},m.prototype.createRestEntity=function(){var e=new Cr;e.name="centerCylinder",e.addComponent("model",{type:"cylinder",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),e.model.material=this.lineMaterial,e.setLocalScale(0,0,0),this.cylinders.push(e),this.root.addChild(e),this.midPoints.push(new de);var t=new Cr;t.name="secondSphere",t.addComponent("model",{type:"sphere",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),t.model.material=this.lineMaterial,t.setLocalScale(0,0,0),this.secondSpheres.push(t),this.root.addChild(t)},m.prototype.onEnableEntity=function(e,t,i){this[e]&&this[e][t]&&(this[e][t].enabled=i)},m.prototype.onEnableGroups=function(e,t){void 0===t&&(t=!0),this.onEnableEntity("firstSpheres",e,t),this.onEnableEntity("secondSpheres",e,t),this.onEnableEntity("cylinders",e,t)},m.prototype.onClearAll=function(e){var i=this;this.cylinders.forEach(function(e,t){i.onEnableGroups(t,!1)})},m.prototype.onClearByIndex=function(e){this.onEnableGroups(e,!1),this.firstSpheres[e]=null,this.secondSpheres[e]=null,this.cylinders[e]=null},m.prototype.onEnableAll=function(e){var i=this;this.cylinders.forEach(function(e,t){i.onEnableGroups(t,!0)})},m.prototype.updateEntity=function(e,t){for(var i=0;i<this.cylinders.length;i+=1){var n,a=m.quat,s=(n=m.lineColor).set.apply(n,this.color);this.lineMaterial.emissive=s;var r=this.vertexes,o=this.firstSpheres[i],l=this.secondSpheres[i],h=this.cylinders[i],c=this.midPoints[i];if(o&&r[2*i]&&(o.setLocalScale(this.sphereDiameter/this.scale,this.sphereDiameter/this.scale,this.sphereDiameter/this.scale),o.setPosition(r[2*i].x,r[2*i].y,r[2*i].z)),h&&r[2*i+1]&&r[2*i]){h.setLocalScale(this.cylinderDiameter/this.scale,this.rangings[i],this.cylinderDiameter/this.scale),h.setPosition(c.x,c.y,c.z);var u=new de(0,this.rangings[i],0),d=new de(r[2*i+1].x-r[2*i].x,r[2*i+1].y-r[2*i].y,r[2*i+1].z-r[2*i].z),p=180*Math.acos(u.clone().normalize().dot(d.clone().normalize()))/Math.PI,f=(new de).cross(u.clone().normalize(),d.clone().normalize()).normalize();a.setFromAxisAngle(f,p),h.setRotation(a)}l&&r[2*i+1]&&r[2*i]&&(l.setLocalScale(this.sphereDiameter/this.scale,this.sphereDiameter/this.scale,this.sphereDiameter/this.scale),l.setPosition(r[2*i+1].x,r[2*i+1].y,r[2*i+1].z))}},m.prototype.updatePoints=function(){for(var e=this.vertexes,t=this.relativeVertexes,i=0;i<e.length;i+=2)if(e[i]&&t[i]){var n=m.origin,a=this.entity.aabb.halfExtents;n.copy(this.entity.aabb.center).sub(new de(a.x,a.y,a.z)),e[i].copy(n).add(t[i]),e[i+1]&&t[i+1]&&(e[i+1].copy(n).add(t[i+1]),this.midPoints[i/2].set((e[i].x+e[i+1].x)/2,(e[i].y+e[i+1].y)/2,(e[i].z+e[i+1].z)/2))}},m.prototype.updateScaleFactor=function(){var e=this.entity.script.orbitCamera._distance/this.originDistance,t=(this.entity.aabb.halfExtents.x+this.entity.aabb.halfExtents.y+this.entity.aabb.halfExtents.z)/3*e;this.fontSize=.15*t/this.scaleMin*.2,this.lineOffset=.15*t*.6,this.lateralLineLength=.4*this.lineOffset,this.fontOffset=.6*this.lineOffset,this.cylinderDiameter=.15*t/this.scaleMin*this.thickness,this.sphereDiameter=2*this.cylinderDiameter,this.root&&this.root.setLocalScale(1/this.entity.localScale.x,1/this.entity.localScale.y,1/this.entity.localScale.z)},m.prototype.update=function(){this.enabled&&(this.updateScaleFactor(),this.updateEntity())},m.prototype.onRefreshMaterial=function(e){var t=new vv;t.diffuse.set(0,0,0),t.specular.set(0,0,0),t.shininess=0,t.useLighting=!1,t.useSkybox=!1,t.cull=0,name&&(t.name=name),this.color&&(t.emissive=z($,this.color)),t.update(),this.lineMaterial=t}),h="entityShadowBake",(c=rm.scripts.get(h))||((c=Tv(h)).attributes.add("quality",{type:"number",default:0}),c.attributes.add("texture",{type:"string",default:null}),c.attributes.add("radius",{type:"number",default:10}),c.attributes.add("scale",{type:"number",default:4}),c.attributes.add("opacity",{type:"number",default:1}),c.attributes.add("altitude",{type:"number",default:0}),c.prototype.initialize=function(){var t=this;this.status=Ky,this.bakePlanePosition=new de,this.entity._aabbInit?this.aabb=this.entity.aabb.clone():this.entity.once("aabb:init",function(){t.aabb=t.entity.aabb.clone()}),this._planeScale=this.scale,this.root=rm.root.findByName("ShadowBakeRoot"),this.root||(this.root=new Cr,this.root.name="ShadowBakeRoot",rm.root.addChild(this.root));var n=function(e){t.shadowMat=t.createRealiboxMaterial({blendType:4,opacityMapChannel:"r",metalness:0,shininess:0,diffuse:[0,0,0],cull:0,useLighting:!1}),e&&(t.shadowMat.opacityMap=e,t.shadowMat.update()),t.shadowMat._bakeHelper=!0,t.shadowMat.opacity=t.opacity,t.on("attr:opacity",function(e){t.shadowMat.opacity=e,t.shadowMat.update()}),t.bakePlaneEntity=new Cr,t.bakePlaneEntity.name="bakePlaneEntity",t.bakePlaneEntity.addComponent("model",{type:"plane"}),t.bakePlaneEntity.model.material=t.shadowMat,t.root.addChild(t.bakePlaneEntity)};this.texture?rm.loader.load(s_(this.texture),"texture",function(e,t,i){e||n(t)}):n(),this.on("enable",this.onEnable,this),this.on("disable",this.onDisable,this),this.on("destroy",this.onDestroy,this),this.entity.script.fire("initialize:"+this.__scriptType.__name)},c.prototype.onEnable=function(){this.bakePlaneEntity&&(this.bakePlaneEntity.enabled=!0)},c.prototype.onDisable=function(){this.bakePlaneEntity&&(this.bakePlaneEntity.enabled=!1),this.status===Zy&&(rm.off("postrender",this.postRender,this),this.status=Ky,this.callback&&"function"==typeof this.callback&&this.callback(this.status,this.bakeCount/this.maxCount))},c.prototype.createBakeProgramData=function(){var e="precision "+rm.graphicsDevice.precision+" float;\n";e+="\n    varying vec2 vUv0;\n\n    uniform sampler2D uDiffuseMap;\n    \n    int unpackAlpha(vec4 color){\n        vec4 c = color * 255.0;\n        int one = int(c.x);\n        int two = int(c.y * 255.0);\n        int num = one + two;\n\n        return num;\n    }\n\n    void main(void)\n    {\n        vec4 color = texture2D(uDiffuseMap, vUv0);\n        \n        int n = unpackAlpha(color);\n        \n        float a = 1.0 - float(n + 200) / 65536.0;\n        gl_FragColor = vec4(a, a, a, 1.0);\n        \n        // gl_FragColor = color;\n    }",this.alphaMaterial=this.createCustomMaterial({aPosition:Te},"\n    attribute vec2 aPosition;\n\n    varying vec2 vUv0;\n\n    void main(void)\n    {\n        gl_Position = vec4(aPosition, 0.5, 1.0);\n        vUv0 = aPosition.xy*0.5+0.5;\n    }",e),this.bakeCacheMaterial=this.createCustomMaterial({aPosition:Te,aUv0:Le},"\n    attribute vec3 aPosition;\n    attribute vec2 aUv0;\n\n    uniform mat4 uLightMVP;\n\n    varying vec2 vTextureCoord;\n    varying vec4 vPositionFromLight;\n\n    void main(void)\n    {\n\t\tvec2 uv = vec2(aUv0.x, 1.0 - aUv0.y);\n        gl_Position = vec4(uv * 2.0 - 1.0, 0.0, 1.0);\n        vTextureCoord = uv;\n        vPositionFromLight = uLightMVP * vec4(aPosition, 1.0);\n    }","\n    precision highp float;\n    \n    uniform sampler2D uSampler;\n    uniform int planck;\n\n    varying vec2 vTextureCoord;\n\n    // Shadow map related variables\n    uniform sampler2D uShadowMap;\n    varying vec4 vPositionFromLight;\n\n    float unpack(vec4 rgbaDepth) {\n        const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n        return dot(rgbaDepth, bitShift);\n    }\n\n    int useShadowMap(sampler2D shadowMap, vec4 shadowCoord){\n        vec4 ndcFragCoord = vec4((shadowCoord.xyz / shadowCoord.w), 1.0 / shadowCoord.w);\n        // vec4 ndcFragCoord = shadowCoord;\n        float ndcFrag_z = ndcFragCoord.z;\n        vec4 rgbaDepth = texture2D(shadowMap, ndcFragCoord.xy / 2.0 + 0.5);\n        if (dot(vec4(1.0, 1.0, 1.0, 1.0), rgbaDepth) >= 3.9){\n            return planck;\n        }\n        \n        float shadowMapScreen_z = unpack(rgbaDepth);\n        float ndcShadowMap_z = shadowMapScreen_z * 2.0 - 1.0;\n        return ndcFrag_z < ndcShadowMap_z ? planck : 0;\n    }\n    \n    int unpackAlpha(vec4 color){\n        vec4 c = color * 255.0;\n        int one = int(c.x);\n        int two = int(c.y * 255.0);\n        int num = one + two;\n        \n        return num;\n    }\n\n    vec4 packAlpha(int num){\n        float n = float(num) / 255.0;\n        float y = floor(n) / 255.0;\n        float x = fract(n);\n        \n        return vec4(x, y, 0.0, 1.0);\n    }\n    \n    vec4 add (vec4 oldColor, int visibility){\n        int num = unpackAlpha(oldColor);\n        \n        int newNum = num + visibility;\n        \n        return packAlpha(newNum);\n    }\n    \n    void main(void) {\n        int visibility = useShadowMap(uShadowMap, vPositionFromLight);\n        vec4 oldColor = texture2D(uSampler, vTextureCoord);\n\n        vec4 newColor = add(oldColor, visibility);\n        gl_FragColor = newColor;\n        \n        // gl_FragColor = vec4(visibility, visibility, visibility, 1.0);\n        // gl_FragColor = texture2D(uShadowMap, vTextureCoord);\n    }"),this.depthCacheMaterial=this.createCustomMaterial({aPosition:Te},"\n    attribute vec3 aPosition;\n\n    uniform mat4 uMVP;\n\n    void main(void)\n    {\n        gl_Position = uMVP * vec4(aPosition, 1.0);\n    }","\n    precision highp float;\n    precision highp int;\n    \n    vec4 packFloat(float depth) {\n        const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n        const vec4 bit_mask = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n        vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n        res -= res.xxyz * bit_mask;\n        return res;\n    }\n    \n    void main(void) {\n        gl_FragColor = packFloat(gl_FragCoord.z);\n    }"),this.fullQuadVectexBuf=Ag.createFullscreenQuad(rm.graphicsDevice),this.targetA=this.createTarget(Jy,Jy),this.clearTarget(this.targetA),this.targetB=this.createTarget(Jy,Jy),this.clearTarget(this.targetB),this.targetC=this.createTarget(Jy,Jy),this.clearTarget(this.targetC),this.targetC&&(this.targetC.buffer=new ArrayBuffer(4194304),this.targetC.pixels=new Uint8Array(this.targetC.buffer),this.targetC.pixelsClamped=new Uint8ClampedArray(this.targetC.buffer));var t=this.createTarget(Jy,Jy,"depthCache",!0);this.clearTarget(t),this.bakeLight=new eb(t)},c.prototype.createCustomMaterial=function(e,t,i){var n={attributes:e,vshader:t,fshader:i},a=new Et(rm.graphicsDevice,n),s=new Ui;return s.shader=a,s},c.prototype.createRealiboxMaterial=function(e){var t=new gm;for(var i in e)t[i]=e[i];return t.update(),t},c.prototype.onStartBaking=function(e){if(this.enabled&&this.status!==Zy&&this.bakePlaneEntity){switch(this.status=Zy,this.entity._aabbInit&&(this.aabb=this.entity.aabb.clone()),this.alphaMaterial||this.createBakeProgramData(),this.quality){case 0:this._planck=100;break;case 1:this._planck=25;break;case 2:this._planck=15;break;case 3:this._planck=10;break;default:this._planck=25}this._radius=this.radius,this._planeScale=this.scale,this.bakeLight._planeScale=this.scale,this.bakeCount=0,this.maxCount=65536/this._planck,this.activeTargetA=!0,this.targetB&&this.clearTarget(this.targetB),this.shadowMat.opacityMap=this.targetC.colorBuffer,this.shadowMat.opacityMapReverseMode=1,this.shadowMat.update(),this.callback=e,rm.on("postrender",this.postRender,this)}},c.prototype.onCompleted=function(){this.status=Qy,rm.off("postrender",this.postRender,this),this.callback&&"function"==typeof this.callback&&this.callback(this.status,this.bakeCount/this.maxCount)},c.prototype.getDataUrl=function(){if(this.status===Qy){var e=rm.call("edk:render:preview:canvas"),t=rm.call("edk:render:preview:canvas:ctx"),i=rm.graphicsDevice.gl;e.width=Jy,e.height=Jy,i.bindFramebuffer(i.FRAMEBUFFER,this.targetC._glFrameBuffer),i.readPixels(0,0,Jy,Jy,i.RGBA,i.UNSIGNED_BYTE,this.targetC.pixels);var n=new ImageData(this.targetC.pixelsClamped,Jy,Jy);return t.putImageData(n,0,0),i.bindFramebuffer(i.FRAMEBUFFER,null),e.toDataURL()}return null},c.prototype.postRender=function(){this.status!==Qy&&(this.bakeCount>this.maxCount?this.onCompleted():(this.currentTarget=this.activeTargetA?this.targetA:this.targetB,this.cacheTarget=this.activeTargetA?this.targetB:this.targetA,this.drawDepth(this.entity,this.depthCacheMaterial),this.drawCache(this.cacheTarget,this.bakeCacheMaterial),this.drawAlphaTexture(this.currentTarget,this.targetC),this.randomBakeLightPos(),this.activeTargetA=!this.activeTargetA,this.bakeCount++,this.callback&&"function"==typeof this.callback&&this.callback(this.status,this.bakeCount/this.maxCount)))},c.prototype.drawDepth=function(e,t){var i=this.getEntityMeshInstances(e);if(i.length){rm.graphicsDevice.setRenderTarget(this.bakeLight.renderTarget),rm.graphicsDevice.updateBegin(),rm.graphicsDevice.setViewport(0,0,Jy,Jy),rm.graphicsDevice.setScissor(0,0,Jy,Jy),rm.graphicsDevice.clear({color:[1,1,1,1],depth:1,flags:3}),rm.graphicsDevice.setBlending(!1);var n=Math.max(e.aabb.halfExtents.x,e.aabb.halfExtents.y),a=Math.max(n,e.aabb.halfExtents.z);this.bakeLight.updateVP(a,e.aabb.center,this._radius);for(var s=i.length,r=0;r<s;r++){var o=i[r],l=o.mesh,h=this.getMeshInstanceMatrix(o),c=this.bakeLight.getMVP(h);t.setParameter("uMVP",c.data),t.setParameters(rm.graphicsDevice),rm.graphicsDevice.setShader(t.shader),rm.graphicsDevice.setVertexBuffer(l.vertexBuffer),rm.graphicsDevice.setIndexBuffer(l.indexBuffer[0]),rm.graphicsDevice.draw(l.primitive[0])}rm.graphicsDevice.updateEnd()}},c.prototype.drawCache=function(e,t){var i=this.getEntityMeshInstances(this.bakePlaneEntity);if(i.length){rm.graphicsDevice.setRenderTarget(this.currentTarget),rm.graphicsDevice.updateBegin(),rm.graphicsDevice.setViewport(0,0,Jy,Jy),rm.graphicsDevice.setScissor(0,0,Jy,Jy);var n=i[0].mesh,a=this.getMeshInstanceMatrix(i[0]),s=e.colorBuffer,r=this.bakeLight.getMVP(a);t.setParameter("uShadowMap",this.bakeLight.renderTarget.colorBuffer),t.setParameter("uSampler",s),t.setParameter("planck",this._planck),t.setParameter("uLightMVP",r.data),t.setParameters(rm.graphicsDevice),rm.graphicsDevice.setShader(t.shader),rm.graphicsDevice.setVertexBuffer(n.vertexBuffer),rm.graphicsDevice.setIndexBuffer(n.indexBuffer[0]),rm.graphicsDevice.draw(n.primitive[0]),rm.graphicsDevice.updateEnd()}},c.prototype.drawAlphaTexture=function(e,t){this.alphaMaterial.setParameter("uDiffuseMap",e.colorBuffer),this.alphaMaterial.setParameters(rm.graphicsDevice),Ag.drawFullscreenQuad(rm.graphicsDevice,t,this.fullQuadVectexBuf,this.alphaMaterial.shader)},c.prototype.randomBakeLightPos=function(){if(this.bakeLight){var e=Math.max(this._radius,.02),t=this.bakeCount+1,i=180/e,n=1-(2*t-1)/(this.maxCount*i),a=Math.sqrt(1-n*n)*Math.cos(2*Math.PI*t*.618),s=Math.sqrt(1-n*n)*Math.sin(2*Math.PI*t*.618);this.bakeLight.updatePosition(a,n,s)}},c.prototype.getEntityMeshInstances=function(e){var i=this,n=[];return e.model&&n.push.apply(n,e.model.model.meshInstances),e.children&&e.children.length&&e.children.forEach(function(e){if(e instanceof Cr&&("model"===e.type||"group"===e.type)&&!0===e.enabled&&!e.deleted){if(!0===rm.call("edk:scene:entity:get",e._guid).deleted)return;var t=!1;e.script&&e.script.entityShadowBake&&e.script.entityShadowBake.enabled&&(t=!0),t||n.push.apply(n,i.getEntityMeshInstances(e))}}),n},c.prototype.getMeshInstanceMatrix=function(e){return e.node.worldTransform},c.prototype.update=function(){this.updateBakePlane()},c.prototype.updateBakePlane=function(){if(this.aabb&&this.bakePlaneEntity){if(this.entity&&this.entity.animation&&this.entity.animation.playing)return;var e=this.aabb;this.status===Ky&&(e=this.entity.aabb);var t=Math.max(e.halfExtents.x,e.halfExtents.z)*this._planeScale*2;this.bakePlaneEntity.setLocalScale(t,1,t),this.bakePlanePosition.copy(this.entity.aabb.center),this.bakePlanePosition.sub({x:0,y:this.getBakePlanePositionY(),z:0}),this.bakePlaneEntity.setPosition(this.bakePlanePosition)}},c.prototype.getBakePlanePositionY=function(){var e=1.001*this.entity.aabb.halfExtents.y;return 0<this.altitude?-this.altitude*(e+e)+e:this.altitude<0?Math.abs(this.altitude*(e+e))+e:e},c.prototype.createTarget=function(e,t,i,n){void 0===i&&(i="bakeCache"),void 0===n&&(n=!1);var a=new Kt(rm.graphicsDevice,{format:7,width:e,height:t,mipmaps:!1,addressU:1,addressV:1,addressW:1});a.name=i;var s=new Fm({colorBuffer:a,depth:n});return this.clearTarget(s),s},c.prototype.clearTarget=function(e){rm.graphicsDevice.setRenderTarget(e),rm.graphicsDevice.updateBegin(),rm.graphicsDevice.setViewport(0,0,Jy,Jy),rm.graphicsDevice.setScissor(0,0,Jy,Jy);var t=e.depth?1:3;rm.graphicsDevice.clear({color:[0,0,0,1],flags:t}),rm.graphicsDevice.updateEnd(),rm.graphicsDevice.setViewport(0,0,Jy,Jy),rm.graphicsDevice.setScissor(0,0,Jy,Jy)},c.prototype.onDestroy=function(){}),o="entityAabb",(l=rm.scripts.get(o))||((l=Tv(o)).prototype.initialize=function(){this.entity.aabb||(this.entity.aabb=new ue),this.on("destroy",this.onDestroy,this),this.entity.script.fire("initialize:"+this.__scriptType.__name)},l.prototype.update=function(){var i=this;if(this.entity.aabb)switch(this.entity.type){case"root":case"scene":case"rooter":case"light":case"annotation":this.entity.aabb.center.copy(this.entity.getPosition()),this.entity.aabb.halfExtents.set(.1,.1,.1),this.entity.children.forEach(function(e,t){e.aabb&&(0===t?i.entity.aabb.copy(e.aabb):i.entity.aabb.add(e.aabb))});break;case"group":this.entity.aabb.center.copy(this.entity.getPosition()),this.entity.aabb.halfExtents.set(.1,.1,.1),this.entity.children.forEach(function(e,t){e.aabb&&(0===t?i.entity.aabb.copy(e.aabb):i.entity.aabb.add(e.aabb))}),this.entity._aabbInit||(this.entity._aabbInit=!0,this.entity.fire("aabb:init"));break;case"model":this.entity.model&&this.entity.model.model&&(this.entity.model.model.meshInstances.forEach(function(e,t){0===t?i.entity.aabb.copy(e.aabb):i.entity.aabb.add(e.aabb)}),this.entity._aabbInit||(this.entity._aabbInit=!0,this.entity.fire("aabb:init")))}},l.prototype.onDestroy=function(){this.entity&&(this.entity.aabb=null)}),(s=rm.scripts.get("bvhPicker"))||((s=Tv("bvhPicker")).prototype.initialize=function(){this.bvhEntities=[],this.bvhTriangles=[],this.bvhMeshInstances=[]},s.prototype.addBvhEntity=function(e){this.bvhEntities.includes(e)||(this.bvhEntities.push(e),this.updateBvhMesh())},s.prototype.removeBvhEntity=function(e){var t=this.bvhEntities.indexOf(e);-1!==t&&(this.bvhEntities.splice(t,1),this.updateBvhMesh())},s.prototype.setBvhEntities=function(e){this.bvhEntities=e,this.updateBvhMesh()},s.prototype.clearBvhEntities=function(e){-1!==this.bvhEntities.indexOf(e)&&(this.bvhEntities=[],this.bvhTriangles=[])},s.prototype.updateBvhMesh=function(){var t=this;this.bvhMeshInstances=[],this.bvhEntities.length&&(this.bvhTriangles=[],this.bvhEntities.forEach(function(e){e instanceof Cr&&e.model&&e.model.model&&(t.bvhMeshInstances=t.bvhMeshInstances.concat(e.model.model.meshInstances))}),this.bvhMeshInstances.forEach(function(e){t.addMeshInstanceToTris(t.bvhTriangles,e)}),this.bvh=new ib.BVH(this.bvhTriangles,12))},s.prototype.points=[new de,new de,new de],s.prototype.worldTransform=new pe,s.prototype.addMeshInstanceToTris=function(e,t){var i,n,a,s=t.mesh.vertexBuffer,r=t.mesh.indexBuffer[0],o=t.mesh.primitive[0].base,l=t.mesh.primitive[0].count,h=new Float32Array(s.storage),c=2===r.bytesPerIndex?new Uint16Array(r.lock()):new Uint32Array(r.lock()),u=s.format.elements,d=s.format.size,p=0;for(i=0;i<u.length;i++)u[i].name===Te&&(p=u[i].offset);var f=p/4,m=d/4;for(this.worldTransform.copy(t.node.getWorldTransform()),i=o;i<o+l;i+=3){for(n=0;n<3;n++)a=c[i+n]*m+f,this.points[n].set(h[a],h[a+1],h[a+2]);e.push([this.worldTransform.transformPoint(this.points[0]),this.worldTransform.transformPoint(this.points[1]),this.worldTransform.transformPoint(this.points[2])])}return e},s.prototype.intersectRay=function(e,t,i){if(void 0===i&&(i=!0),this.bvh&&this.bvhEntities.length){var n=this.bvh.intersectRay(e,t,i);return n.length&&(this.intersectionResult=n[0]),n}return null},s.prototype.direction=new de,s.prototype.intersectionPoint=new de,s.prototype.triangularPoints=[new de,new de,new de],s.prototype.triangularEdges=[new de,new de,new de],s.prototype.diffusionEdges=[new de,new de,new de],s.prototype.diffusionEdgeNormals=[new de,new de,new de],s.prototype.update=function(){this.getCollisionInertia()},s.prototype.getCollisionInertia=function(){var i=this;if(this.intersectionResult){var e=this.intersectionResult.intersectionPoint;this.intersectionPoint.set(e.x,e.y,e.z),this.intersectionResult.triangle.forEach(function(e,t){i.triangularPoints[t].set(e.x,e.y,e.z)});for(var t=0,n=0;n<3;++n){var a=n,s=2===n?0:n+1;this.diffusionEdges[n].sub2(this.triangularPoints[n],this.intersectionPoint),this.triangularEdges[n].sub2(this.triangularPoints[a],this.triangularPoints[s]),this.diffusionEdgeNormals[n].cross(this.diffusionEdges[a],this.diffusionEdges[s]),0<n&&(t=this.diffusionEdgeNormals[n].y<this.diffusionEdgeNormals[t].y?n:t)}var r=this.entity.forward.clone();r.y=0,r.normalize();var o=this.triangularEdges[t].clone();return o.normalize(),{inertia:r.dot(o),direction:o}}return{inertia:0,direction:de.ZERO}}),n="component_exposure",(a=rm.scripts.get(n))||((a=Tv(n)).attributes.add("intensity",{type:"number",default:1,min:0,max:10}),a.prototype.initialize=function(){this.on("attr:intensity",this.updateIntensity,this),this.on("enable",this.onEnbale),this.on("disable",this.onDisable),this.on("destroy",this.onDestroy),rm.scene.exposure=this.intensity},a.prototype.updateIntensity=function(e){rm.scene.exposure=e},a.prototype.onEnbale=function(){rm.scene.exposure=this.intensity},a.prototype.onDisable=function(){rm.scene.exposure=1},a.prototype.onDestroy=function(){rm.scene.exposure=1}),function(){function c(e,t){return 1/Math.sqrt(2*Math.PI*t)*Math.exp(-e*e/(2*t*t))}function s(e,t,i,n,a){e[0]=c(0,a),t[0]=0;var s,r,o=e[t[1]=0];for(s=0,r=Math.floor(7.5);s<r;s++){var l=c(s+1,a);e[2*s]=l,o+=2*(e[2*s+1]=l);var h=2*s+1.5;t[4*s]=i*h,t[4*s+1]=n*h,t[4*s+2]=-i*h,t[4*s+3]=-n*h}for(s=0,r=e.length;s<r;s++)e[s]/=o}function e(e){Gm.call(this,e);var t={aPosition:Te},i=["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition + 1.0) * 0.5;","}"].join("\n"),n=["precision "+e.precision+" float;","","varying vec2 vUv0;","","uniform sampler2D uBaseTexture;","uniform float uBloomThreshold;","","void main(void)","{","    vec4 color = texture2D(uBaseTexture, vUv0);","","    gl_FragColor = clamp((color - uBloomThreshold) / (1.0 - uBloomThreshold), 0.0, 1.0);","}"].join("\n"),a=["precision "+e.precision+" float;","","#define SAMPLE_COUNT 15","","varying vec2 vUv0;","","uniform sampler2D uBloomTexture;","uniform vec2 uBlurOffsets[SAMPLE_COUNT];","uniform float uBlurWeights[SAMPLE_COUNT];","","void main(void)","{","    vec4 color = vec4(0.0);","    for (int i = 0; i < SAMPLE_COUNT; i++)","    {","        color += texture2D(uBloomTexture, vUv0 + uBlurOffsets[i]) * uBlurWeights[i];","    }","","    gl_FragColor = color;","}"].join("\n"),s=["precision "+e.precision+" float;","","varying vec2 vUv0;","","uniform float uBloomEffectIntensity;","uniform sampler2D uBaseTexture;","uniform sampler2D uBloomTexture;","","void main(void)","{","    vec4 bloom = texture2D(uBloomTexture, vUv0) * uBloomEffectIntensity;","    vec4 base = texture2D(uBaseTexture, vUv0);","","    base *= (1.0 - clamp(bloom, 0.0, 1.0));","","    gl_FragColor = base + bloom;","}"].join("\n");this.extractShader=new Et(e,{attributes:t,vshader:i,fshader:n}),this.blurShader=new Et(e,{attributes:t,vshader:i,fshader:a}),this.combineShader=new Et(e,{attributes:t,vshader:i,fshader:s});var r=e.width,o=e.height;this.targets=[];for(var l=0;l<2;l++){var h=new Kt(e,{format:7,width:r>>1,height:o>>1,mipmaps:!1});h.minFilter=1,h.magFilter=1,h.addressU=1,h.addressV=1,h.name="pe-bloom";var c=new Fm(e,h,{depth:!1});this.targets.push(c)}this.bloomThreshold=.25,this.blurAmount=4,this.bloomIntensity=1.25,this.sampleWeights=new Float32Array(15),this.sampleOffsets=new Float32Array(30)}(e.prototype=Object.create(Gm.prototype)).constructor=e,Object.assign(e.prototype,{render:function(e,t,i){var n=this.device,a=n.scope;a.resolve("uBloomThreshold").setValue(this.bloomThreshold),a.resolve("uBaseTexture").setValue(e.colorBuffer),Hm(n,this.targets[0],this.vertexBuffer,this.extractShader),s(this.sampleWeights,this.sampleOffsets,1/this.targets[1].width,0,this.blurAmount),a.resolve("uBlurWeights[0]").setValue(this.sampleWeights),a.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),a.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),Hm(n,this.targets[1],this.vertexBuffer,this.blurShader),s(this.sampleWeights,this.sampleOffsets,0,1/this.targets[0].height,this.blurAmount),a.resolve("uBlurWeights[0]").setValue(this.sampleWeights),a.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),a.resolve("uBloomTexture").setValue(this.targets[1].colorBuffer),Hm(n,this.targets[0],this.vertexBuffer,this.blurShader),a.resolve("uBloomEffectIntensity").setValue(this.bloomIntensity),a.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),a.resolve("uBaseTexture").setValue(e.colorBuffer),Hm(n,t,this.vertexBuffer,this.combineShader,i)}});var t="component_bloom",i=rm.scripts.get(t);i||((i=Tv(t)).attributes.add("bloomIntensity",{type:"number",default:1,min:0}),i.attributes.add("bloomThreshold",{type:"number",default:.25,min:0,max:1}),i.attributes.add("blurAmount",{type:"number",default:4,min:1}),i.prototype.initialize=function(){this.effect=new e(rm.graphicsDevice),this.effect.bloomThreshold=this.bloomThreshold,this.effect.blurAmount=this.blurAmount,this.effect.bloomIntensity=this.bloomIntensity,this.entity.camera.postEffects.addEffect(this.effect),this.on("attr",function(e,t){this.effect[e]=t},this),this.on("state",function(e){e?this.entity.camera.postEffects.addEffect(this.effect):this.removeEffect(this.effect)}),this.on("destroy",function(){this.removeEffect(this.effect)})},i.prototype.removeEffect=function(e){var t=this.entity.camera.postEffects.effects.slice();this.entity.camera.postEffects.destroy();for(var i=0;i<t.length;++i)t[i].effect!==e&&this.entity.camera.postEffects.addEffect(t[i].effect)})}(),function(){function e(e){Gm.call(this,e),this.shader=new Et(e,{attributes:{aPosition:Te},vshader:["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:["precision "+e.precision+" float;","","uniform sampler2D uColorBuffer;","uniform float uBrightness;","uniform float uContrast;","","varying vec2 vUv0;","","void main() {","    gl_FragColor = texture2D( uColorBuffer, vUv0 );","    gl_FragColor.rgb += uBrightness;","","    if (uContrast > 0.0) {","        gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) / (1.0 - uContrast) + 0.5;","    } else {","        gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) * (1.0 + uContrast) + 0.5;","    }","}"].join("\n")}),this.brightness=0,this.contrast=0}(e.prototype=Object.create(Gm.prototype)).constructor=e,Object.assign(e.prototype,{render:function(e,t,i){var n=this.device,a=n.scope;a.resolve("uBrightness").setValue(this.brightness),a.resolve("uContrast").setValue(this.contrast),a.resolve("uColorBuffer").setValue(e.colorBuffer),Hm(n,t,this.vertexBuffer,this.shader,i)}});var t="component_brightnessContrast",i=rm.scripts.get(t);i||((i=Tv(t)).attributes.add("brightness",{type:"number",default:0,min:-1,max:1}),i.attributes.add("contrast",{type:"number",default:0,min:-1,max:1}),i.prototype.initialize=function(){this.effect=new e(rm.graphicsDevice),this.effect.brightness=this.brightness,this.effect.contrast=this.contrast,this.entity.camera.postEffects.addEffect(this.effect),this.on("attr",function(e,t){this.effect[e]=t},this),this.on("state",function(e){e?this.entity.camera.postEffects.addEffect(this.effect):this.removeEffect(this.effect)}),this.on("destroy",function(){this.removeEffect(this.effect)})},i.prototype.removeEffect=function(e){var t=this.entity.camera.postEffects.effects.slice();this.entity.camera.postEffects.destroy();for(var i=0;i<t.length;++i)t[i].effect!==e&&this.entity.camera.postEffects.addEffect(t[i].effect)})}(),function(){function e(e){Gm.call(this,e),this.shader=new Et(e,{attributes:{aPosition:Te},vshader:["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:["precision "+e.precision+" float;","","uniform sampler2D uColorBuffer;","uniform float uHue;","uniform float uSaturation;","","varying vec2 vUv0;","","void main() {","    gl_FragColor = texture2D( uColorBuffer, vUv0 );","","    float angle = uHue * 3.14159265;","    float s = sin(angle), c = cos(angle);","    vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;","    float len = length(gl_FragColor.rgb);","    gl_FragColor.rgb = vec3(","        dot(gl_FragColor.rgb, weights.xyz),","        dot(gl_FragColor.rgb, weights.zxy),","        dot(gl_FragColor.rgb, weights.yzx)","    );","","    float average = (gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3.0;","    if (uSaturation > 0.0) {","        gl_FragColor.rgb += (average - gl_FragColor.rgb) * (1.0 - 1.0 / (1.001 - uSaturation));","    } else {","        gl_FragColor.rgb += (average - gl_FragColor.rgb) * (-uSaturation);","    }","}"].join("\n")}),this.hue=0,this.saturation=0}(e.prototype=Object.create(Gm.prototype)).constructor=e,Object.assign(e.prototype,{render:function(e,t,i){var n=this.device,a=n.scope;a.resolve("uHue").setValue(this.hue),a.resolve("uSaturation").setValue(this.saturation),a.resolve("uColorBuffer").setValue(e.colorBuffer),Hm(n,t,this.vertexBuffer,this.shader,i)}});var t="component_hueSaturation",i=rm.scripts.get(t);i||((i=Tv(t)).attributes.add("hue",{type:"number",default:0,min:-1,max:1}),i.attributes.add("saturation",{type:"number",default:0,min:-1,max:1}),i.prototype.initialize=function(){this.effect=new e(rm.graphicsDevice),this.effect.hue=this.hue,this.effect.saturation=this.saturation,this.entity.camera.postEffects.addEffect(this.effect),this.on("attr",function(e,t){this.effect[e]=t},this),this.on("state",function(e){e?this.entity.camera.postEffects.addEffect(this.effect):this.removeEffect(this.effect)}),this.on("destroy",function(){this.removeEffect(this.effect)})},i.prototype.removeEffect=function(e){var t=this.entity.camera.postEffects.effects.slice();this.entity.camera.postEffects.destroy();for(var i=0;i<t.length;++i)t[i].effect!==e&&this.entity.camera.postEffects.addEffect(t[i].effect)})}(),function(){function e(e){Gm.call(this,e);var t={aPosition:Te},i=["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),n=["precision "+e.precision+" float;","","uniform sampler2D uColorBuffer;","uniform float uDarkness;","uniform float uOffset;","","varying vec2 vUv0;","","void main() {","    vec4 texel = texture2D(uColorBuffer, vUv0);","    vec2 uv = (vUv0 - vec2(0.5)) * vec2(uOffset);","    gl_FragColor = vec4(mix(texel.rgb, vec3(1.0 - uDarkness), dot(uv, uv)), texel.a);","}"].join("\n");this.vignetteShader=new Et(e,{attributes:t,vshader:i,fshader:n}),this.offset=1,this.darkness=1}(e.prototype=Object.create(Gm.prototype)).constructor=e,Object.assign(e.prototype,{render:function(e,t,i){var n=this.device,a=n.scope;a.resolve("uColorBuffer").setValue(e.colorBuffer),a.resolve("uOffset").setValue(this.offset),a.resolve("uDarkness").setValue(this.darkness),Hm(n,t,this.vertexBuffer,this.vignetteShader,i)}});var t="component_vignette",i=rm.scripts.get(t);i||((i=Tv(t)).attributes.add("offset",{type:"number",default:1,min:0}),i.attributes.add("darkness",{type:"number",default:1}),i.prototype.initialize=function(){this.effect=new e(rm.graphicsDevice),this.effect.offset=this.offset,this.effect.darkness=this.darkness,this.entity.camera.postEffects.addEffect(this.effect),this.on("attr",function(e,t){this.effect[e]=t},this),this.on("state",function(e){e?this.entity.camera.postEffects.addEffect(this.effect):this.removeEffect(this.effect)}),this.on("destroy",function(){this.removeEffect(this.effect)})},i.prototype.removeEffect=function(e){var t=this.entity.camera.postEffects.effects.slice();this.entity.camera.postEffects.destroy();for(var i=0;i<t.length;++i)t[i].effect!==e&&this.entity.camera.postEffects.addEffect(t[i].effect)})}(),function(){function t(e,t){Gm.call(this,e),this.ssaoScript=t,this.needsDepthBuffer=!0,this.ssaoShader=new Et(e,{attributes:{aPosition:Te},vshader:[e.webgl2?"#version 300 es\n\n"+Rt.gles3VS:"",e.webgl2?"":"#extension GL_OES_standard_derivatives: enable\n","attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:[e.webgl2?"#version 300 es\n\n"+Rt.gles3PS:"",e.webgl2?"":"#extension GL_OES_standard_derivatives: enable\n","precision "+e.precision+" float;",Rt.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uColorBuffer;","uniform vec4 uResolution;","","uniform float uAspect;","","#define saturate(x) clamp(x,0.0,1.0)","","// Largely based on 'Dominant Light Shadowing'","// 'Lighting Technology of The Last of Us Part II' by Hawar Doghramachi, Naughty Dog, LLC","","const float kSSCTLog2LodRate = 3.0;","","highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {","    // this essentially returns (p * vec4(v, 1.0)).w, but we make some assumptions","    // this assumes a perspective projection","    return -v.z;","    // this assumes a perspective or ortho projection","    // return p[2][3] * v.z + p[3][3];","}","","highp float getViewSpaceZFromW(const mat4 p, const float w) {","    // this assumes a perspective projection","    return -w;","    // this assumes a perspective or ortho projection","   // return (w - p[3][3]) / p[2][3];","}","","","const float kLog2LodRate = 3.0;","","vec2 sq(const vec2 a) {","    return a * a;","}","","uniform float uInvFarPlane;","","vec2 pack(highp float depth) {","// we need 16-bits of precision","    highp float z = clamp(depth * uInvFarPlane, 0.0, 1.0);","    highp float t = floor(256.0 * z);","    mediump float hi = t * (1.0 / 256.0);   // we only need 8-bits of precision","    mediump float lo = (256.0 * z) - t;     // we only need 8-bits of precision","    return vec2(hi, lo);","}","","// random number between 0 and 1, using interleaved gradient noise","float random(const highp vec2 w) {","    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);","    return fract(m.z * fract(dot(w, m.xy)));","}","","// returns the frag coord in the GL convention with (0, 0) at the bottom-left","highp vec2 getFragCoord() {","    return gl_FragCoord.xy;","}","","highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {","    return vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);","}","","highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {","    return normalize(cross(dpdx, dpdy));","}","","// Compute normals using derivatives, which essentially results in half-resolution normals","// this creates arifacts around geometry edges.","// Note: when using the spirv optimizer, this results in much slower execution time because","//       this whole expression is inlined in the AO loop below.","highp vec3 computeViewSpaceNormal(const highp vec3 position) {","    return faceNormal(dFdx(position), dFdy(position));","}","","// Compute normals directly from the depth texture, resulting in full resolution normals","// Note: This is actually as cheap as using derivatives because the texture fetches","//       are essentially equivalent to textureGather (which we don't have on ES3.0),","//       and this is executed just once.","highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {","    highp vec2 uvdx = uv + vec2(uResolution.z, 0.0);","    highp vec2 uvdy = uv + vec2(0.0, uResolution.w);","    highp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));","    highp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));","    highp vec3 dpdx = px - position;","    highp vec3 dpdy = py - position;","    return faceNormal(dpdx, dpdy);","}","","// Ambient Occlusion, largely inspired from:","// 'The Alchemy Screen-Space Ambient Obscurance Algorithm' by Morgan McGuire","// 'Scalable Ambient Obscurance' by Morgan McGuire, Michael Mara and David Luebke","","uniform vec2 uSampleCount;","uniform float uSpiralTurns;","","#define PI (3.14159)","","vec3 tapLocation(float i, const float noise) {","    float offset = ((2.0 * PI) * 2.4) * noise;","    float angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;","    float radius = (i + noise + 0.5) * uSampleCount.y;","    return vec3(cos(angle), sin(angle), radius * radius);","}","","highp vec2 startPosition(const float noise) {","    float angle = ((2.0 * PI) * 2.4) * noise;","    return vec2(cos(angle), sin(angle));","}","","uniform vec2 uAngleIncCosSin;","","highp mat2 tapAngleStep() {","    highp vec2 t = uAngleIncCosSin;","    return mat2(t.x, t.y, -t.y, t.x);","}","","vec3 tapLocationFast(float i, vec2 p, const float noise) {","    float radius = (i + noise + 0.5) * uSampleCount.y;","    return vec3(p, radius * radius);","}","","uniform float uMaxLevel;","uniform float uInvRadiusSquared;","uniform float uMinHorizonAngleSineSquared;","uniform float uBias;","uniform float uPeak2;","","void computeAmbientOcclusionSAO(inout float occlusion, float i, float ssDiskRadius,","        const highp vec2 uv,  const highp vec3 origin, const vec3 normal,","        const vec2 tapPosition, const float noise) {","","    vec3 tap = tapLocationFast(i, tapPosition, noise);","","    float ssRadius = max(1.0, tap.z * ssDiskRadius);","","    vec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uResolution.zw;","","    float level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));","    highp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);","    highp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);","","    // now we have the sample, compute AO","    vec3 v = p - origin;        // sample vector","    float vv = dot(v, v);       // squared distance","    float vn = dot(v, normal);  // distance * cos(v, normal)","","    // discard samples that are outside of the radius, preventing distant geometry to","    // cast shadows -- there are many functions that work and choosing one is an artistic","    // decision.","    float w = max(0.0, 1.0 - vv * uInvRadiusSquared);","    w = w*w;","","    // discard samples that are too close to the horizon to reduce shadows cast by geometry","    // not sufficiently tessellated. The goal is to discard samples that form an angle 'beta'","    // smaller than 'epsilon' with the horizon. We already have dot(v,n) which is equal to the","    // sin(beta) * |v|. So the test simplifies to vn^2 < vv * sin(epsilon)^2.","    w *= step(vv * uMinHorizonAngleSineSquared, vn * vn);","","    occlusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);","}","","uniform float uProjectionScaleRadius;","uniform float uIntensity;","","float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {","    float noise = random(getFragCoord());","    highp vec2 tapPosition = startPosition(noise);","    highp mat2 angleStep = tapAngleStep();","","    // Choose the screen-space sample radius","    // proportional to the projected area of the sphere","    float ssDiskRadius = -(uProjectionScaleRadius / origin.z);","","    float occlusion = 0.0;",e.webgl2?"    for (float i = 0.0; i < uSampleCount.x; i += 1.0) {":"   const float maxSampleCount = 256.0;   for (float i = 0.0; i < maxSampleCount; i += 1.0) {       if (i >= uSampleCount.x) break;","        computeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);","        tapPosition = angleStep * tapPosition;","    }","    return sqrt(occlusion * uIntensity);","}","","uniform float uPower;","","void main() {","    highp vec2 uv = vUv0; //variable_vertex.xy; // interpolated to pixel center","","    highp float depth = -getLinearScreenDepth(vUv0);","    highp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);","    vec3 normal = computeViewSpaceNormal(origin, uv);","","    float occlusion = 0.0;","","    if (uIntensity > 0.0) {","        occlusion = scalableAmbientObscurance(uv, origin, normal);","    }","","    // occlusion to visibility","    float aoVisibility = pow(saturate(1.0 - occlusion), uPower);","","    vec4 inCol = vec4(1.0, 1.0, 1.0, 1.0); //texture2D( uColorBuffer,  uv );","","    gl_FragColor.rgb = inCol.rgb * vec3(aoVisibility); //postProcess.color.rgb = vec3(aoVisibility, pack(origin.z));","    gl_FragColor.a = 1.0;","}","","void main_old()","{","    vec2 aspectCorrect = vec2( 1.0, uAspect );","","    float depth = getLinearScreenDepth(vUv0);","    gl_FragColor.rgb = vec3(fract(floor(depth*256.0*256.0)),fract(floor(depth*256.0)),fract(depth));","    gl_FragColor.a = 1.0;","}"].join("\n")}),this.blurShader=new Et(e,{attributes:{aPosition:Te},vshader:[e.webgl2?"#version 300 es\n\n"+Rt.gles3VS:"",e.webgl2?"":"#extension GL_OES_standard_derivatives: enable\n","attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:[e.webgl2?"#version 300 es\n\n"+Rt.gles3PS:"",e.webgl2?"":"#extension GL_OES_standard_derivatives: enable\n","precision "+e.precision+" float;",Rt.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uColorBuffer;","uniform sampler2D uSSAOBuffer;","uniform vec4 uResolution;","","uniform float uAspect;","","uniform int uBilatSampleCount;","uniform float uFarPlaneOverEdgeDistance;","uniform float uBrightness;","","float random(const highp vec2 w) {","    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);","    return fract(m.z * fract(dot(w, m.xy)));","}","","float bilateralWeight(in float depth, in float sampleDepth) {","    float diff = (sampleDepth - depth) * uFarPlaneOverEdgeDistance;","    return max(0.0, 1.0 - diff * diff);","}","","void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {","    // ambient occlusion sample","    float ssao = texture2D( uSSAOBuffer, position ).r;","    float tdepth = -getLinearScreenDepth( position );","","    // bilateral sample","    float bilateral = bilateralWeight(depth, tdepth);","    bilateral *= weight;","    sum += ssao * bilateral;","    totalWeight += bilateral;","}","","void main() {","    highp vec2 uv = vUv0; // variable_vertex.xy; // interpolated at pixel's center","","    // we handle the center pixel separately because it doesn't participate in bilateral filtering","    float depth = -getLinearScreenDepth(vUv0); // unpack(data.gb);","    float totalWeight = 0.0; // float(uBilatSampleCount*2+1)*float(uBilatSampleCount*2+1);","    float ssao = texture2D( uSSAOBuffer, vUv0 ).r;","    float sum = ssao * totalWeight;","",e.webgl2?"    for (int x = -uBilatSampleCount; x <= uBilatSampleCount; x++) {       for (int y = -uBilatSampleCount; y < uBilatSampleCount; y++) {":"    for (int x = -4; x <= 4; x++) {       for (int y = -4; y < 4; y++) {","           float weight = 1.0;","           vec2 offset = vec2(x,y)*uResolution.zw;","           tap(sum, totalWeight, weight, depth, uv + offset);","       }","    }","","    float ao = sum / totalWeight;","","    // simple dithering helps a lot (assumes 8 bits target)","    // this is most useful with high quality/large blurs","    // ao += ((random(gl_FragCoord.xy) - 0.5) / 255.0);","","    vec4 inCol = texture2D( uColorBuffer,  vUv0 );","","    ao = mix(ao, 1.0, uBrightness);","    gl_FragColor.rgb = inCol.rgb * ao;","    gl_FragColor.a = 1.0;","}"].join("\n")});var i=e.width,n=e.height,a=new Kt(e,{format:7,minFilter:1,magFilter:1,addressU:1,addressV:1,width:i,height:n,mipmaps:!1});a.name="ssao",this.target=new Fm({colorBuffer:a,depth:!1}),this.radius=4,this.bias=.001,this.brightness=0,this.samples=20}(t.prototype=Object.create(Gm.prototype)).constructor=t,Object.assign(t.prototype,{render:function(e,t,i){var n=this.device,a=n.scope,s=this.samples,r=1/(s-.5)*10*2*3.141,o=this.radius,l=this.bias,h=.1*o,c=2*h*3.141*.125,u=.5*n.height,d=this.ssaoScript.entity.camera.farClip;a.resolve("uAspect").setValue(n.width/n.height),a.resolve("uResolution").setValue([n.width,n.height,1/n.width,1/n.height]),a.resolve("uColorBuffer").setValue(e.colorBuffer),a.resolve("uBrightness").setValue(this.brightness),a.resolve("uInvFarPlane").setValue(1/d),a.resolve("uSampleCount").setValue([s,1/s]),a.resolve("uSpiralTurns").setValue(10),a.resolve("uAngleIncCosSin").setValue([Math.cos(r),Math.sin(r)]),a.resolve("uMaxLevel").setValue(0),a.resolve("uInvRadiusSquared").setValue(1/(o*o)),a.resolve("uMinHorizonAngleSineSquared").setValue(0),a.resolve("uBias").setValue(l),a.resolve("uPeak2").setValue(h*h),a.resolve("uIntensity").setValue(c),a.resolve("uPower").setValue(1),a.resolve("uProjectionScaleRadius").setValue(u*o),Hm(n,this.target,this.vertexBuffer,this.ssaoShader,i),a.resolve("uSSAOBuffer").setValue(this.target.colorBuffer),a.resolve("uFarPlaneOverEdgeDistance").setValue(1),a.resolve("uBilatSampleCount").setValue(4),Hm(n,t,this.vertexBuffer,this.blurShader,i)}});var e=Tv("component_ssao");e.attributes.add("radius",{type:"number",default:4,min:0,max:20,title:"Radius"}),e.attributes.add("bias",{type:"number",default:.001,min:.001,max:5,title:"Bias"}),e.attributes.add("brightness",{type:"number",default:0,min:0,max:1,title:"Brightness"}),e.attributes.add("samples",{type:"number",default:16,min:1,max:256,title:"Samples"}),e.prototype.initialize=function(){this.effect=new t(this.app.graphicsDevice,this),this.effect.radius=this.radius,this.effect.brightness=this.brightness,this.effect.samples=this.samples,this.on("attr",function(e,t){this.effect[e]=t},this);var e=this.entity.camera.postEffects;this.queue=e,this.onEnabled(),this.on("state",function(e){e?this.onEnabled():this.onDisabled()}),this.on("destroy",function(){this.onDisabled()})},e.prototype.onMouseDown=function(){this.queue.removeEffect(this.effect),this.mouse=!0},e.prototype.onMouseUp=function(){var e=this;clearTimeout(this.mouseTimer),this.mouseTimer=setTimeout(function(){e.mouse&&(e.queue.addEffect(e.effect),e.mouse=!1)},500)},e.prototype.onEnabled=function(){this.queue.addEffect(this.effect)},e.prototype.onDisabled=function(){this.queue.removeEffect(this.effect)}}(),function(){function e(e){Gm.call(this,e),this.needsDepthBuffer=!0,this.shader=new Et(e,{attributes:{aPosition:Te},vshader:["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:["precision "+e.precision+" float;",e.webgl2?"#define GL2":"",Rt.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uColorBuffer;","","uniform float uMaxBlur;","uniform float uAperture;","","uniform float uFocus;","uniform float uAspect;","","void main()","{","    vec2 aspectCorrect = vec2( 1.0, uAspect );","","    float factor = ((getLinearScreenDepth(vUv0) * -1.0) - uFocus) / camera_params.y;","","    vec2 dofblur = vec2 ( clamp( factor * uAperture, -uMaxBlur, uMaxBlur ) );","","    vec2 dofblur9 = dofblur * 0.9;","    vec2 dofblur7 = dofblur * 0.7;","    vec2 dofblur4 = dofblur * 0.4;","","    vec4 col;","","    col  = texture2D( uColorBuffer, vUv0 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15,  0.37 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37,  0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.40,  0.0  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37, -0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15, -0.37 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15,  0.37 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37,  0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37, -0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15, -0.37 ) * aspectCorrect ) * dofblur );","","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15,  0.37 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37,  0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37, -0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15, -0.37 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15,  0.37 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37,  0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37, -0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15, -0.37 ) * aspectCorrect ) * dofblur9 );","","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.40,  0.0  ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur7 );","","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.4,   0.0  ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur4 );","","    gl_FragColor = col / 41.0;","    gl_FragColor.a = 1.0;","}"].join("\n")}),this.maxBlur=.02,this.aperture=1,this.focus=1}(e.prototype=Object.create(Gm.prototype)).constructor=e,Object.assign(e.prototype,{render:function(e,t,i){var n=this.device,a=n.scope;a.resolve("uMaxBlur").setValue(this.maxBlur),a.resolve("uAperture").setValue(this.aperture),a.resolve("uFocus").setValue(this.focus),a.resolve("uAspect").setValue(n.width/n.height),a.resolve("uColorBuffer").setValue(e.colorBuffer),Hm(n,t,this.vertexBuffer,this.shader,i)}});var t=Tv("bokeh");t.attributes.add("maxBlur",{type:"number",default:.02,min:0,max:1,title:"Max Blur"}),t.attributes.add("aperture",{type:"number",default:1,min:0,max:1,title:"Aperture"}),t.attributes.add("focus",{type:"number",default:1,title:"Focus"}),t.prototype.initialize=function(){this.effect=new e(this.app.graphicsDevice),this.effect.maxBlur=this.maxBlur,this.effect.aperture=this.aperture,this.effect.focus=this.focus,this.on("attr",function(e,t){this.effect[e]=t},this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)}),this.on("destroy",function(){t.removeEffect(this.effect)})}}(),function(){function e(e){Gm.call(this,e),this.shader=new Et(e,{attributes:{aPosition:Te},vshader:["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:["precision "+e.precision+" float;","","uniform sampler2D uColorBuffer;","varying vec2 vUv0;","uniform vec2 uResolution;","uniform float uIntensity;","uniform vec4 uColor;","","mat3 G[2];","","const mat3 g0 = mat3( 1.0, 2.0, 1.0, 0.0, 0.0, 0.0, -1.0, -2.0, -1.0 );","const mat3 g1 = mat3( 1.0, 0.0, -1.0, 2.0, 0.0, -2.0, 1.0, 0.0, -1.0 );","","void main(void)","{","    mat3 I;","    float cnv[2];","    vec3 sample;","","    G[0] = g0;","    G[1] = g1;","","    for (float i = 0.0; i < 3.0; i++)","    {","        for (float j = 0.0; j < 3.0; j++)","        {","            sample = texture2D(uColorBuffer, vUv0 + uResolution * vec2(i - 1.0, j - 1.0)).rgb;","            I[int(i)][int(j)] = length(sample);","         }","    }","","    for (int i=0; i<2; i++)","    {","        float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","        cnv[i] = dp3 * dp3; ","    }","","    gl_FragColor = uIntensity * uColor * vec4(sqrt(cnv[0]*cnv[0]+cnv[1]*cnv[1]));","}"].join("\n")}),this.resolution=new Float32Array(2),this.intensity=1,this.color=new $(1,1,1,1)}(e.prototype=Object.create(Gm.prototype)).constructor=e,Object.assign(e.prototype,{render:function(e,t,i){var n=this.device,a=n.scope;this.resolution[0]=1/e.width,this.resolution[1]=1/e.height,a.resolve("uResolution").setValue(this.resolution),a.resolve("uColorBuffer").setValue(e.colorBuffer),a.resolve("uColor").setValue([this.color.r,this.color.g,this.color.b,this.color.a]),a.resolve("uIntensity").setValue(this.intensity),Hm(n,t,this.vertexBuffer,this.shader,i)}});var t=Tv("edgeDetect");t.attributes.add("intensity",{type:"number",default:1,min:0,max:2,title:"Intensity"}),t.attributes.add("color",{type:"rgba",default:[.5,.5,.5,1],title:"Color"}),t.prototype.initialize=function(){this.effect=new e(this.app.graphicsDevice),this.effect.intensity=this.intensity,this.effect.color=this.color,this.on("attr",function(e,t){this.effect[e]=t},this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)}),this.on("destroy",function(){t.removeEffect(this.effect)})}}(),function(){function e(e){Gm.call(this,e),this.shader=new Et(e,{attributes:{aPosition:Te},vshader:["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:["precision "+e.precision+" float;","","uniform sampler2D uColorBuffer;","uniform float uH;","uniform float uR;","","varying vec2 vUv0;","","void main() {","    vec4 sum = vec4( 0.0 );","    float hh = uH * abs( uR - vUv0.x );","","    sum += texture2D( uColorBuffer, vec2( vUv0.x - 4.0 * hh, vUv0.y ) ) * 0.051;","    sum += texture2D( uColorBuffer, vec2( vUv0.x - 3.0 * hh, vUv0.y ) ) * 0.0918;","    sum += texture2D( uColorBuffer, vec2( vUv0.x - 2.0 * hh, vUv0.y ) ) * 0.12245;","    sum += texture2D( uColorBuffer, vec2( vUv0.x - 1.0 * hh, vUv0.y ) ) * 0.1531;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y ) ) * 0.1633;","    sum += texture2D( uColorBuffer, vec2( vUv0.x + 1.0 * hh, vUv0.y ) ) * 0.1531;","    sum += texture2D( uColorBuffer, vec2( vUv0.x + 2.0 * hh, vUv0.y ) ) * 0.12245;","    sum += texture2D( uColorBuffer, vec2( vUv0.x + 3.0 * hh, vUv0.y ) ) * 0.0918;","    sum += texture2D( uColorBuffer, vec2( vUv0.x + 4.0 * hh, vUv0.y ) ) * 0.051;","","    gl_FragColor = sum;","}"].join("\n")}),this.focus=.35}(e.prototype=Object.create(Gm.prototype)).constructor=e,Object.assign(e.prototype,{render:function(e,t,i){var n=this.device,a=n.scope;a.resolve("uH").setValue(1/e.width),a.resolve("uR").setValue(this.focus),a.resolve("uColorBuffer").setValue(e.colorBuffer),Hm(n,t,this.vertexBuffer,this.shader,i)}});var t=Tv("horizontalTiltShift");t.attributes.add("focus",{type:"number",default:.35,min:0,max:1,title:"Focus"}),t.prototype.initialize=function(){this.effect=new e(this.app.graphicsDevice),this.effect.focus=this.focus,this.on("attr:focus",function(e){this.effect.focus=e},this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)}),this.on("destroy",function(){t.removeEffect(this.effect)})}}(),function(){function e(e){Gm.call(this,e),this.shader=new Et(e,{attributes:{aPosition:Te},vshader:["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:["precision "+e.precision+" float;","","uniform sampler2D uColorBuffer;","uniform float uV;","uniform float uR;","","varying vec2 vUv0;","","void main() {","    vec4 sum = vec4( 0.0 );","    float vv = uV * abs( uR - vUv0.y );","","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y - 4.0 * vv ) ) * 0.051;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y - 3.0 * vv ) ) * 0.0918;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y - 2.0 * vv ) ) * 0.12245;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y - 1.0 * vv ) ) * 0.1531;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y ) ) * 0.1633;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y + 1.0 * vv ) ) * 0.1531;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y + 2.0 * vv ) ) * 0.12245;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y + 3.0 * vv ) ) * 0.0918;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y + 4.0 * vv ) ) * 0.051;","","    gl_FragColor = sum;","}"].join("\n")}),this.focus=.35}(e.prototype=Object.create(Gm.prototype)).constructor=e,Object.assign(e.prototype,{render:function(e,t,i){var n=this.device,a=n.scope;a.resolve("uV").setValue(1/e.height),a.resolve("uR").setValue(this.focus),a.resolve("uColorBuffer").setValue(e.colorBuffer),Hm(n,t,this.vertexBuffer,this.shader,i)}});var t=Tv("verticalTiltShift");t.attributes.add("focus",{type:"number",default:.35,min:0,max:1,title:"Focus"}),t.prototype.initialize=function(){this.effect=new e(this.app.graphicsDevice),this.effect.focus=this.focus,this.on("attr:focus",function(e){this.effect.focus=e},this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)}),this.on("destroy",function(){t.removeEffect(this.effect)})}}(),function(){function e(e){Gm.call(this,e),this.shader=new Et(e,{attributes:{aPosition:Te},vshader:["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:["precision "+e.precision+" float;","","uniform sampler2D uColorBuffer;","","varying vec2 vUv0;","","void main() {","    vec4 texel = texture2D(uColorBuffer, vUv0);","    vec3 luma = vec3(0.299, 0.587, 0.114);","    float v = dot(texel.xyz, luma);","    gl_FragColor = vec4(v, v, v, texel.w);","}"].join("\n")})}(e.prototype=Object.create(Gm.prototype)).constructor=e,Object.assign(e.prototype,{render:function(e,t,i){var n=this.device;n.scope.resolve("uColorBuffer").setValue(e.colorBuffer),Hm(n,t,this.vertexBuffer,this.shader,i)}}),Tv("luminosity").prototype.initialize=function(){this.effect=new e(this.app.graphicsDevice);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)}),this.on("destroy",function(){t.removeEffect(this.effect)})}}(),function(){function e(e){Gm.call(this,e),this.shader=new Et(e,{attributes:{aPosition:Te},vshader:["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:["precision "+e.precision+" float;","","uniform float uAmount;","uniform sampler2D uColorBuffer;","","varying vec2 vUv0;","","void main() {","    vec4 color = texture2D(uColorBuffer, vUv0);","    vec3 c = color.rgb;","","    color.r = dot(c, vec3(1.0 - 0.607 * uAmount, 0.769 * uAmount, 0.189 * uAmount));","    color.g = dot(c, vec3(0.349 * uAmount, 1.0 - 0.314 * uAmount, 0.168 * uAmount));","    color.b = dot(c, vec3(0.272 * uAmount, 0.534 * uAmount, 1.0 - 0.869 * uAmount));","","    gl_FragColor = vec4(min(vec3(1.0), color.rgb), color.a);","}"].join("\n")}),this.amount=1}(e.prototype=Object.create(Gm.prototype)).constructor=e,Object.assign(e.prototype,{render:function(e,t,i){var n=this.device,a=n.scope;a.resolve("uAmount").setValue(this.amount),a.resolve("uColorBuffer").setValue(e.colorBuffer),Hm(n,t,this.vertexBuffer,this.shader,i)}});var t=Tv("sepia");t.attributes.add("amount",{type:"number",default:1,min:0,max:1,title:"Amount"}),t.prototype.initialize=function(){this.effect=new e(this.app.graphicsDevice),this.effect.amount=this.amount,this.on("attr:amount",function(e){this.effect.amount=e},this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)}),this.on("destroy",function(){t.removeEffect(this.effect)})}}(),(i=rm.scripts.get("viewcube"))||((i=Tv("viewcube")).prototype.initialize=function(){var t=this;this.initFont();var e=[.88,.8,.12,.12],i=rm.scene.layers,n=Math.max.apply(Math,i.layerList.map(function(e){return e.id}))+1;this.layer=new _a({id:n,name:"viewcube layer",passThrough:!0,overrideClear:!0}),i.push(this.layer);var a=[this.layer.id],s=Ob(a,e);this.layer.addCamera(s.camera),rm.root.addChild(s),this.camera=s,this.box=new Cr,this.box.name="viewcube",this.box.addComponent("model",{type:"box",layers:a});var r=new vv;r.emissive.set(.93,.93,.93),this.box.model.material=r,this.box.model.material.update(),rm.root.addChild(this.box),new kb({app:rm,entity:this.box,onClick:function(e){return t.rotate(e)},layers:a,cameraRect:e,camera:s}),rm.on("edk:scene:resource:preload:end",function(){t.mainCamera=rm.call("edk:render:camera:get")}),this.on("enable",this.onEnable,this),this.on("disable",this.onDisable,this),this.onDisable()},i.prototype.initFont=function(){ed.prototype._setText=function(){var t=new Sv(rm,{color:new $(1,1,1),fontSize:64});t.createTextures("!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~");var i=ed.prototype._setText;return function(e){return this.font!==t&&rm.once("postrender",function(){this.font=t},this),t.updateTextures(e),i.call(this,e)}}()},i.prototype.rotate=function(e){switch(e){case ab:this._setCubeAngles(0,0,0);break;case sb:this._setCubeAngles(0,90,0);break;case rb:this._setCubeAngles(0,180,0);break;case ob:this._setCubeAngles(0,270,0);break;case nb:this._setCubeAngles(-90,0,0);break;case lb:this._setCubeAngles(90,0,0);break;case hb:this._setCubeAngles(-45,0,0);break;case cb:this._setCubeAngles(-45,90,0);break;case ub:this._setCubeAngles(-45,180,0);break;case db:this._setCubeAngles(-45,270,0);break;case gb:this._setCubeAngles(45,0,0);break;case _b:this._setCubeAngles(45,90,0);break;case yb:this._setCubeAngles(45,180,0);break;case bb:this._setCubeAngles(45,270,0);break;case pb:this._setCubeAngles(0,45,0);break;case fb:this._setCubeAngles(0,135,0);break;case mb:this._setCubeAngles(0,225,0);break;case vb:this._setCubeAngles(0,315,0);break;case xb:this._setCubeAngles(-45,45,0);break;case Mb:this._setCubeAngles(-45,135,0);break;case Sb:this._setCubeAngles(-45,225,0);break;case wb:this._setCubeAngles(-45,315,0);break;case Cb:this._setCubeAngles(45,45,0);break;case Pb:this._setCubeAngles(45,135,0);break;case Tb:this._setCubeAngles(45,225,0);break;case Ab:this._setCubeAngles(45,315,0)}},i.prototype._setCubeAngles=function(e,t,i){var n={yaw:this.camera.script.viewCubeOrbitCamera.yaw%360,pitch:this.camera.script.viewCubeOrbitCamera.pitch%360},a={yaw:t,pitch:e};this._animation={base:n,delta:a,duration:500,time:Date.now()}},i.prototype._animateCubeRotation=function(e,t){var i,n,a=e.base,s=e.delta,r=.5*(Math.sin((2*t-1)*Math.PI*.5)+1),o=function(e,t,i){var n=0;e<0&&(e+=360),t<0&&(t+=360);var a=360-e,s=Math.abs(e),r=360-t,o=Math.abs(t),l=Math.min(a,s)+Math.min(r,o),h=Math.abs(e-t),c=1;return h<l?(n=h,c=t<e?-1:1):l<h?(n=l,c=t<e?1:-1):(n=l,c=t<e?-1:1),e+c*n*i}(a.yaw,s.yaw,r),l=Se.lerp(a.pitch,s.pitch,r);this.camera.script.viewCubeOrbitCamera.yaw=o,this.camera.script.viewCubeOrbitCamera.pitch=l,this.mainCamera&&null!=(i=this.mainCamera)&&null!=(n=i.entity)&&n.script&&this.mainCamera.setCurrentParams({yaw:o,pitch:l})},i.prototype._animate=function(e){if(this._animation){var t=Date.now(),i=this._animation,n=i.duration,a=i.time,s=Math.min((t-a)/n,1);this._animateCubeRotation(this._animation,s),1===s&&(this._animation=null)}},i.prototype.aspectRatio=1,i.prototype.update=function(e){var t,i,n,a,s,r;this._animate();var o=this.mainCamera||{};if(o._yaw,o._pitch,this.mainCamera&&null!=(t=this.mainCamera)&&null!=(i=t.entity)&&null!=(n=i.script)&&n.orbitCamera){var l=this.mainCamera.entity.script.orbitCamera,h=l._yaw,c=l._pitch;this.camera.script.viewCubeOrbitCamera.yaw=h,this.camera.script.viewCubeOrbitCamera.pitch=c}else if(this.mainCamera&&null!=(a=this.mainCamera)&&null!=(s=a.entity)&&null!=(r=s.script)&&r.editorCamera){var u=this.mainCamera.entity.script.editorCamera,d=u._yaw,p=u._pitch;this.camera.script.viewCubeOrbitCamera.yaw=d,this.camera.script.viewCubeOrbitCamera.pitch=p}this.aspectRatio!==this.camera.camera.aspectRatio&&(this.aspectRatio=this.camera.camera.aspectRatio,1<=this.aspectRatio?this.camera.camera.horizontalFov=!1:this.camera.camera.horizontalFov=!0)},i.prototype.onEnable=function(){this.layer.enabled=!0},i.prototype.onDisable=function(){this.layer.enabled=!1},rm.root.script||rm.root.addComponent("script"),rm.root.script.create("viewcube"))},e}(),zb=null,Bb=function(){function e(e){this.type="entity",this.types=["entity"],this.selects={entity:{}},zb=this,rm.method("edk:selector:add",this.add,this),rm.method("edk:selector:remove",this.remove,this),rm.method("edk:selector:clear",this.clear,this)}var t=e.prototype;return t.clear=function(i){var e=this;this.selects[i]&&Object.keys(this.selects[i]).forEach(function(t){e.selects[i][t]&&e.selects[i][t].forEach(function(e){rm.fire("edk:selector:remove",t,e,i)})}),this.selects[i]={},this.change(i,null,[])},t.has=function(e,t,i){return!(!this.selects[e]||!this.selects[e][t]||!~this.selects[e][t].indexOf(i))},t.add=function(e,t,i){e!=this.type&&(""!=this.type&&this.clear(this.type),this.type=e),this.has(e,t,i)||(this.selects[e][t]||(this.selects[e][t]=[]),this.selects[e][t].push(i),rm.fire("edk:selector:add",t,i,e),this.change(e,t,this.selects[e][t].slice()))},t.remove=function(e,t,i){if(this.has(e,t,i)){this.selects[e][t]||(this.selects[e][t]=[]);var n=this.selects[e][t].findIndex(function(e){return e===i});this.selects[e][t].splice(n,1),rm.fire("edk:selector:remove",t,i,e),this.change(e,t,this.selects[e][t].slice())}},t.change=function(e,t,i){rm.fire("edk:selector:change",e,t,i)},t.toggle=function(e,t,i){this.has(e,t,i)?this.remove(e,t,i):this.add(e,t,i)},t.toggleOne=function(e,t,i){this.clear(e),this.add(e,t,i)},t.destroy=function(){this.selects={entity:[]},zb=null},e}(),Vb=function(){function e(e){this.model=null,this.vertexBuffer=null,this.gridDivisions=8,this.gridDivisionSize=1}var t=e.prototype;return t.initialize=function(){var e,t=new ut(rm.graphicsDevice,[{semantic:Te,components:3,type:6},{semantic:Ie,components:4,type:1,normalize:!0}]),i=this.gridDivisions*this.gridDivisionSize,n=i/this.gridDivisions,a=4*(this.gridDivisions+1),s=[136,136,136,255],r=[0,0,0,255];this.vertexBuffer=new ht(rm.graphicsDevice,t,a);for(var o=this.vertexBuffer,l=new Ct(o),h=-this.gridDivisions/2;h<=this.gridDivisions/2;h++)e=0===h?r:s,l.element.POSITION.set(-i/2,0,h*n),l.element.COLOR.set(e[0],e[1],e[2],e[3]),l.next(),l.element.POSITION.set(i/2,0,h*n),l.element.COLOR.set(e[0],e[1],e[2],e[3]),l.next(),l.element.POSITION.set(h*n,0,-i/2),l.element.COLOR.set(e[0],e[1],e[2],e[3]),l.next(),l.element.POSITION.set(h*n,0,i/2),l.element.COLOR.set(e[0],e[1],e[2],e[3]),h!==this.gridDivisions/2&&l.next();l.end();var c=rm.graphicsDevice.getProgramLibrary().getProgram("basic",{vertexColors:!0,diffuseMapping:!1}),u=new Ui;u.shader=c;var d=new Zi;d.vertexBuffer=o,d.indexBuffer[0]=null,d.primitive[0].type=1,d.primitive[0].base=0,d.primitive[0].count=o.getNumVertices(),d.primitive[0].indexed=!1;var p=new mn("grid"),f=new Mn(p,d,u);f.mask=8;var m=new rr;m.graph=p,m.meshInstances=[f],this.model=m,this.model.meshInstances[0].aabb.halfExtents.set(i/2,i/2,i/2)},t.destroy=function(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null,this.model.destroy(),this.model=null)},e}(),Ub=function(){function e(e){this.suffix="",e.suffix&&(this.suffix=e.suffix),this.type="gizmo",this.entity=new Cr,this.entity.addComponent("model"),this.entity.addComponent("script"),this.camera=rm.call("edk:render:camera:get"),this.camera||rm.once("edk:render:camera:change",this.setCamera,this)}var t=e.prototype;return t.setCamera=function(e){this.camera=e},t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.updateField(e,t[e])}):this.updateField(t,e)},t.updateField=function(e,t){switch(e){case"enabled":"boolean"==typeof t&&(this.entity.enabled=t,this.entity.script&&(this.entity.script[this.scriptName].active=t));break;case"worldMode":"boolean"==typeof t&&(this.entity.script[this.scriptName].worldMode=t);break;case"position":var i;t instanceof Array?(i=this.entity).setPosition.apply(i,t):this.entity.setPosition(t);break;case"rotation":var n;t instanceof Array?(n=this.entity).setEulerAngles.apply(n,t):this.entity.setEulerAngles(t)}},e}(),Nb=function(i){function e(e){var t;return(t=i.call(this,e)||this).scriptName="gizmoRotate",t.entity.name="Gizmo Rotate",t.entity.script.create(t.scriptName),t.suffix&&(t.entity.script.gizmoRotate.suffix=t.suffix),t.entity.gizmo=g(t),t.sphere=null,t.planes={},t.lines={},t.entity.script.gizmoRotate.matBehindActive=t._createMaterial(new $(1,1,1,1.1)),t.entity.script.gizmoRotate.matBehindHoverX=t._createMaterial(new $(1,0,0,.3)),t.entity.script.gizmoRotate.matBehindHoverY=t._createMaterial(new $(0,1,0,.3)),t.entity.script.gizmoRotate.matBehindHoverZ=t._createMaterial(new $(0,0,1,.3)),t.entity.script.gizmoRotate.colorActive=new $(1,1,1,1),t.entity.script.gizmoRotate.xPlaneEntity=t._createPlane("x"),t.entity.script.gizmoRotate.yPlaneEntity=t._createPlane("y"),t.entity.script.gizmoRotate.zPlaneEntity=t._createPlane("z"),t.entity.script.gizmoRotate.active=!1,t._createLines(),t._initProperties(),t.entity.enabled=!1,rm.on("edk:script:gizmo:rotate:start"+t.suffix,t.onGizmoRotateStart,g(t)),rm.on("edk:script:gizmo:rotate:end"+t.suffix,t.onGizmoRotateEnd,g(t)),rm.on("edk:script:gizmo:rotate:doRaycast:normal"+t.suffix,t.onGizmoRotateDoRaycastNormal,g(t)),t}u(e,i);var t=e.prototype;return t.onGizmoRotateStart=function(){this.toggle(!1)},t.onGizmoRotateEnd=function(){this.toggle(!0)},t.onGizmoRotateDoRaycastNormal=function(){this.resetMaterials()},t.toggle=function(e){this.planes.x.model.enabled=e,this.planes.y.model.enabled=e,this.planes.z.model.enabled=e},t.resetMaterials=function(){this.lines.x.material=this.lines.x.mat,this.lines.y.material=this.lines.y.mat,this.lines.z.material=this.lines.z.mat},t._createMaterial=function(e){var t=new Ka;return 1!==(t.color=e).a&&(t.blend=!0,t.blendSrc=6,t.blendDst=8),t.cull=0,t.depthWrite=!1,t.depthTest=!1,t.update(),t},t._createSphere=function(){this.sphere=new Cr,this.sphere.addComponent("model",{type:"sphere",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.entity.addChild(this.sphere),this.sphere.setLocalScale(3,3,3),this.sphere.mat=this.sphere.model.material=this._createMaterial(new $(1,1,1,0))},t._createPlane=function(e){return this.planes[e]=new Cr,this.planes[e].name="Plane "+e,this.planes[e].axis=e,this.planes[e].plane=!0,this.planes[e].addComponent("model",{type:"cylinder",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.entity.addChild(this.planes[e]),this.planes[e]},t._createLines=function(){for(var e,t,i,n=rm.graphicsDevice,a=0,s=new ut(rm.graphicsDevice,[{semantic:Te,components:3,type:6}]),r=[],o=0;o<3;o++){r.push(new ht(n,s,51)),e=new Ct(r[o]);for(var l=0;l<=50;l++)a=2*Math.PI*(l/50),t=Math.sin(a),i=Math.cos(a),0===o?e.element.POSITION.set(0,2*t,2*i):1===o?e.element.POSITION.set(2*t,0,2*i):2===o&&e.element.POSITION.set(2*t,2*i,0),e.next();e.end()}for(var h,c,u=new mn,d=[],p=[this._createMaterial(new $(1,0,0,1.1)),this._createMaterial(new $(0,1,0,1.1)),this._createMaterial(new $(0,0,1,1.1))],f=0;f<3;f++)(h=new Zi).vertexBuffer=r[f],h.indexBuffer[0]=null,h.primitive[0].type=3,h.primitive[0].base=0,h.primitive[0].count=r[f].getNumVertices(),h.primitive[0].indexed=!1,(c=this._createMeshInstance(u,h,p[f])).mat=p[f],d.push(c);h=tr(n,{segments:75,radius:1.95});var m=this._createMaterial(new $(1,1,1,0));m.update(),c=this._createMeshInstance(u,h,m),d.push(c),this.lines.x=d[0],this.lines.y=d[1],this.lines.z=d[2],this.lines.cull=d[3]},t._createMeshInstance=function(e,t,i){var n=new Mn(e,t,i);return n.layer=1,n.updateKey(),n},t._initProperties=function(){this.planes.x.setLocalEulerAngles(90,-90,0),this.planes.x.setLocalScale(4,.3,4),this.planes.x.mat=this.planes.x.model.material=this._createMaterial(new $(1,0,0,0)),this.planes.y.setLocalEulerAngles(0,0,0),this.planes.y.setLocalScale(4,.3,4),this.planes.y.mat=this.planes.y.model.material=this._createMaterial(new $(0,1,0,0)),this.planes.z.setLocalEulerAngles(90,0,0),this.planes.z.setLocalScale(4,.3,4),this.planes.z.mat=this.planes.z.model.material=this._createMaterial(new $(0,0,1,0))},t.destroy=function(){this.entity.destroy(),this.entity=null,this.sphere=null,this.planes={},this.lines={}},e}(Ub),Gb=function(i){function e(e){var t;return(t=i.call(this,e)||this).scriptName="gizmoScale",t.entity.name="Gizmo Scale",t.entity.script.create(t.scriptName),t.suffix&&(t.entity.script.gizmoScale.suffix=t.suffix),t.middle=null,t.lines={},t.boxes={},t.gizmoSize=.4,t.entity.script.gizmoScale.matActive=t._createMaterial(new $(1,1,1,1)),t.entity.script.gizmoScale.colorLineBehind=new $(1,1,1,.05),t.entity.script.gizmoScale.colorLineActive=new $(1,1,1,1),t.entity.script.gizmoScale.xLineEntity=t._createLine("x"),t.entity.script.gizmoScale.yLineEntity=t._createLine("y"),t.entity.script.gizmoScale.zLineEntity=t._createLine("z"),t.entity.script.gizmoScale.xBoxEntity=t._createBox("x"),t.entity.script.gizmoScale.yBoxEntity=t._createBox("y"),t.entity.script.gizmoScale.zBoxEntity=t._createBox("z"),t.entity.script.gizmoScale.middleEntity=t._createMiddle(),t._initProperties(),t.entity.enabled=!1,rm.on("edk:script:gizmo:scale:start"+t.suffix,t.onGizmoScaleStart,g(t)),rm.on("edk:script:gizmo:scale:end"+t.suffix,t.onGizmoScaleEnd,g(t)),rm.on("edk:script:gizmo:scale:doRaycast:normal"+t.suffix,t.onGizmoScaleDoRaycastNormal,g(t)),t}u(e,i);var t=e.prototype;return t.onGizmoScaleStart=function(){this.toggle(!1)},t.onGizmoScaleEnd=function(){this.toggle(!0)},t.onGizmoScaleDoRaycastNormal=function(){this.resetMaterials()},t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.updateField(e,t[e])}):this.updateField(t,e)},t.resetMaterials=function(){var t=this;["x","y","z"].forEach(function(e){t.lines[e].model.material=t.lines[e].mat,t.boxes[e].model.material=t.boxes[e].mat})},t.toggle=function(t){var i=this;["x","y","z"].forEach(function(e){i.lines[e].model.enabled=t,i.boxes[e].model.enabled=t})},t._createMaterial=function(e){var t=new Ka;return 1!==(t.color=e).a&&(t.blend=!0,t.blendSrc=6,t.blendDst=8),t.cull=0,t.depthWrite=!1,t.depthTest=!1,t.update(),t},t._createLine=function(e){return this.lines[e]=new Cr,this.lines[e].axis=e,this.lines[e].addComponent("model",{type:"cylinder",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.lines[e].model.model.meshInstances[0].layer=1,this.lines[e].model.model.meshInstances[0].mask=8,this.entity.addChild(this.lines[e]),this.lines[e]},t._createBox=function(e){return this.boxes[e]=new Cr,this.boxes[e].axis=e,this.boxes[e].addComponent("model",{type:"box",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.boxes[e].model.model.meshInstances[0].mask=8,this.entity.addChild(this.boxes[e]),this.boxes[e]},t._createMiddle=function(){return this.middle=new Cr,this.middle.axis="xyz",this.middle.middle=!0,this.middle.addComponent("model",{type:"box",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.middle.model.model.meshInstances[0].layer=1,this.middle.model.model.meshInstances[0].mask=8,this.middle.model.material.id=4294967295,this.entity.addChild(this.middle),this.middle},t._initProperties=function(){this.middle.setLocalScale(1.5*this.gizmoSize,1.5*this.gizmoSize,1.5*this.gizmoSize),this.middle.mat=this.middle.model.material=this._createMaterial(new $(1,1,1,.2)),this.middle.mat.depthTest=!1,this.lines.x.setLocalEulerAngles(90,90,0),this.lines.x.setLocalPosition(1.25,0,0),this.lines.x.setLocalScale(this.gizmoSize,1.5,this.gizmoSize),this.lines.x.mat=this.lines.x.model.material=this._createMaterial(new $(1,0,0,0)),this.lines.y.setLocalEulerAngles(0,0,0),this.lines.y.setLocalPosition(0,1.25,0),this.lines.y.setLocalScale(this.gizmoSize,1.5,this.gizmoSize),this.lines.y.mat=this.lines.y.model.material=this._createMaterial(new $(0,1,0,0)),this.lines.z.setLocalEulerAngles(90,0,0),this.lines.z.setLocalPosition(0,0,1.25),this.lines.z.setLocalScale(this.gizmoSize,1.5,this.gizmoSize),this.lines.z.mat=this.lines.z.model.material=this._createMaterial(new $(0,0,1,0)),this.boxes.x.setLocalPosition(2.2,0,0),this.boxes.x.setLocalScale(this.gizmoSize,this.gizmoSize,this.gizmoSize),this.boxes.x.mat=this.boxes.x.model.material=this._createMaterial(new $(1,0,0,1.1)),this.boxes.x.color=new $(1,0,0,1),this.boxes.y.setLocalPosition(0,2.2,0),this.boxes.y.setLocalScale(this.gizmoSize,this.gizmoSize,this.gizmoSize),this.boxes.y.mat=this.boxes.y.model.material=this._createMaterial(new $(0,1,0,1.1)),this.boxes.y.color=new $(0,1,0,1),this.boxes.z.setLocalPosition(0,0,2.2),this.boxes.z.setLocalScale(this.gizmoSize,this.gizmoSize,this.gizmoSize),this.boxes.z.mat=this.boxes.z.model.material=this._createMaterial(new $(0,0,1,1.1)),this.boxes.z.color=new $(0,0,1,1)},t.destroy=function(){this.entity.destroy(),this.entity=null,this.middle=null,this.lines={},this.boxes={},this.gizmoSize=.4},e}(Ub),Wb=function(i){function e(e){var t;return(t=i.call(this,e)||this).scriptName="gizmoTranslate",t.lines={},t.arrows={},t.planes={},t.arrowRadius=.4,t.entity.name="Gizmo Translate",t.entity.script.create(t.scriptName),t.suffix&&(t.entity.script.gizmoTranslate.suffix=t.suffix),t.matActiveTransparent=t._createMaterial(new $(1,1,1,.25)),t.matActiveTransparent.cull=0,t.entity.script.gizmoTranslate.matActive=t._createMaterial(new $(1,1,1,.9)),t.entity.script.gizmoTranslate.gizmoSize=.4,t.entity.script.gizmoTranslate.arrowRadius=.4,t.entity.script.gizmoTranslate.linesColorBehind=new $(1,1,1,.05),t.entity.script.gizmoTranslate.linesColorActive=new $(1,1,1,.9),t.entity.script.gizmoTranslate.linesColor=new $(1,1,1,.2),t.entity.script.gizmoTranslate.xLineEntity=t._createLine("x"),t.entity.script.gizmoTranslate.yLineEntity=t._createLine("y"),t.entity.script.gizmoTranslate.zLineEntity=t._createLine("z"),t.entity.script.gizmoTranslate.xPlaneEntity=t._createPlane("x"),t.entity.script.gizmoTranslate.yPlaneEntity=t._createPlane("y"),t.entity.script.gizmoTranslate.zPlaneEntity=t._createPlane("z"),t.entity.script.gizmoTranslate.xArrowEntity=t._createArrow("x"),t.entity.script.gizmoTranslate.yArrowEntity=t._createArrow("y"),t.entity.script.gizmoTranslate.zArrowEntity=t._createArrow("z"),t.entity.script.gizmoTranslate.active=!1,t._initProperties(),t.entity.enabled=!1,rm.on("edk:script:gizmo:translate:start"+t.suffix,t.onGizmoTranslateStart,g(t)),rm.on("edk:script:gizmo:translate:end"+t.suffix,t.onGizmoTranslateEnd,g(t)),rm.on("edk:script:gizmo:translate:doRaycast:normal"+t.suffix,t.onGizmoTranslateDoRaycastNormal,g(t)),t}u(e,i);var t=e.prototype;return t.onGizmoTranslateStart=function(){this.toggle(!1)},t.onGizmoTranslateEnd=function(){this.toggle(!0)},t.onGizmoTranslateDoRaycastNormal=function(){this.resetMaterials()},t.resetMaterials=function(){var t=this;["x","y","z"].forEach(function(e){t.lines[e].model.material=t.lines[e].mat,t.arrows[e].model.material=t.arrows[e].mat,t.planes[e].model.material=t.planes[e].mat})},t.toggle=function(t){var i=this;["x","y","z"].forEach(function(e){i.lines[e].model.enabled=t,i.arrows[e].model.enabled=t,i.planes[e].model.enabled=t})},t._createMaterial=function(e){var t=new Ka;return 1!==(t.color=e).a&&(t.blend=!0,t.blendSrc=6,t.blendDst=8),t.cull=0,t.depthWrite=!1,t.depthTest=!1,t.update(),t},t._createLine=function(e){return this.lines[e]=new Cr,this.lines[e].axis=e,this.lines[e].name="Line "+e,this.lines[e].addComponent("model",{type:"cylinder",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.entity.addChild(this.lines[e]),this.lines[e]},t._createPlane=function(e){return this.planes[e]=new Cr,this.planes[e].axis=e,this.planes[e].plane=!0,this.planes[e].name="Plane "+e,this.planes[e].addComponent("model",{type:"plane",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.entity.addChild(this.planes[e]),this.planes[e]},t._createArrow=function(e){return this.arrows[e]=new Cr,this.arrows[e].axis=e,this.arrows[e].name="Arrow "+e,this.arrows[e].addComponent("model",{type:"cone",castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1}),this.entity.addChild(this.arrows[e]),this.arrows[e]},t._initProperties=function(){this.lines.x.setLocalEulerAngles(90,90,0),this.lines.x.setLocalPosition(1.6,0,0),this.lines.x.setLocalScale(this.arrowRadius,.8,this.arrowRadius),this.lines.x.mat=this.lines.x.model.material=this._createMaterial(new $(0,0,0,0)),this.lines.y.setLocalEulerAngles(0,0,0),this.lines.y.setLocalPosition(0,1.6,0),this.lines.y.setLocalScale(this.arrowRadius,.8,this.arrowRadius),this.lines.y.mat=this.lines.y.model.material=this._createMaterial(new $(0,0,0,0)),this.lines.z.setLocalEulerAngles(90,0,0),this.lines.z.setLocalPosition(0,0,1.6),this.lines.z.setLocalScale(this.arrowRadius,.8,this.arrowRadius),this.lines.z.mat=this.lines.z.model.material=this._createMaterial(new $(0,0,0,0)),this.arrows.x.setLocalEulerAngles(90,90,0),this.arrows.x.setLocalPosition(2.3,0,0),this.arrows.x.setLocalScale(this.arrowRadius,.6,this.arrowRadius),this.arrows.x.mat=this.arrows.x.model.material=this._createMaterial(new $(1,0,0,.9)),this.arrows.y.setLocalEulerAngles(0,0,0),this.arrows.y.setLocalPosition(0,2.3,0),this.arrows.y.setLocalScale(this.arrowRadius,.6,this.arrowRadius),this.arrows.y.mat=this.arrows.y.model.material=this._createMaterial(new $(0,1,0,.9)),this.arrows.z.setLocalEulerAngles(90,0,0),this.arrows.z.setLocalPosition(0,0,2.3),this.arrows.z.setLocalScale(this.arrowRadius,.6,this.arrowRadius),this.arrows.z.mat=this.arrows.z.model.material=this._createMaterial(new $(0,0,1,.9)),this.planes.x.setLocalEulerAngles(90,-90,0),this.planes.x.setLocalScale(.8,.8,.8),this.planes.x.setLocalPosition(0,.4,.4),this.planes.x.mat=this.planes.x.model.material=this._createMaterial(new $(1,0,0,.25)),this.planes.x.mat.cull=0,this.planes.y.setLocalEulerAngles(0,0,0),this.planes.y.setLocalScale(.8,.8,.8),this.planes.y.setLocalPosition(-.4,0,.4),this.planes.y.mat=this.planes.y.model.material=this._createMaterial(new $(0,1,0,.25)),this.planes.y.mat.cull=0,this.planes.z.setLocalEulerAngles(90,0,0),this.planes.z.setLocalScale(.8,.8,.8),this.planes.z.setLocalPosition(-.4,.4,0),this.planes.z.mat=this.planes.z.model.material=this._createMaterial(new $(0,0,1,.25)),this.planes.z.mat.cull=0},t.destroy=function(){this.entity.destroy(),this.entity=null,this.lines={},this.arrows={},this.planes={}},e}(Ub),Hb=function(){function e(){this.gizmoSize=.2,this.colorBehind=new $(1,1,1,.8),this.colorPrimary=new $(1,1,1),this.models={},this.material=null,this.materialBehind=null,this.materialSpot=null,this.materialSpotBehind=null;var i=rm.call("edk:layer:get","Bright Gizmo"),n=rm.call("edk:layer:get","Dim Gizmo");this.layerFront=i,this.layerBack=n,this.entity=new Cr,this.entity.addComponent("model",{castShadows:!1,receiveShadows:!1,castShadowsLightmap:!1,layers:[n.id,i.id]}),this.entity.name="Gizmo Light",this.entity.model.addModelToLayers=function(){var e=this.meshInstances.filter(function(e){return e.__useFrontLayer}),t=this.meshInstances.filter(function(e){return!e.__useFrontLayer});n.addMeshInstances(e),i.addMeshInstances(t)},this._createMaterial(),this._createMaterialSpot(),this._createDirectionalLight(),this._createPointLight(),this._createSpotLight()}var t=e.prototype;return t.update=function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.updateField(e,t[e])}):this.updateField(t,e)},t.updateField=function(e,t){switch(e){case"enabled":this.entity.enabled=t;break;case"position":var i;t instanceof Array&&(i=this.entity).setPosition.apply(i,t);break;case"rotation":var n;t instanceof Array&&(n=this.entity).setEulerAngles.apply(n,t);break;case"range":"point"===this.type?this.entity.setLocalScale(t,t,t):(this.entity.setLocalScale(1,1,1),"spot"===this.type&&this.entity.model.meshInstances&&(this.entity.model.meshInstances[0].setParameter("range",t),this.entity.model.meshInstances[1].setParameter("range",t)));break;case"innerAngle":"spot"===this.type&&this.entity.model.meshInstances&&(this.entity.model.meshInstances[0].setParameter("innerAngle",t),this.entity.model.meshInstances[1].setParameter("innerAngle",t));break;case"outerAngle":"spot"===this.type&&this.entity.model.meshInstances&&(this.entity.model.meshInstances[0].setParameter("outerAngle",t),this.entity.model.meshInstances[1].setParameter("outerAngle",t))}},t.updateType=function(e,t){if(this.entity&&e!==this.type){var i=this.entity.model.model;if(i&&(this.layerBack.removeMeshInstances(i.meshInstances),this.layerFront.removeMeshInstances(i.meshInstances),this.entity.removeChild(i.getGraph()),this.entity.model.model=null,i.destroy()),this.type=e,this.models[this.type]){i=this.models[this.type].clone();for(var n=0;n<i.meshInstances.length;n++)i.meshInstances[n].__useFrontLayer=this.models[this.type].meshInstances[n].__useFrontLayer;i.meshInstances.forEach(function(e){e.mask=8}),this.entity.model.model=i,"spot"===this.type&&(this.entity.model.meshInstances[0].setParameter("range",t.range),this.entity.model.meshInstances[0].setParameter("innerAngle",t.innerConeAngle),this.entity.model.meshInstances[0].setParameter("outerAngle",t.outerConeAngle),this.entity.model.meshInstances[1].setParameter("range",t.range),this.entity.model.meshInstances[1].setParameter("innerAngle",t.innerConeAngle),this.entity.model.meshInstances[1].setParameter("outerAngle",t.outerConeAngle))}}},t._createMaterial=function(){this.material=new Ka,this.material.color=this.colorPrimary,this.material.depthTest=!1,this.material.depthWrite=!1,this.material.update(),this.materialBehind=new Ka,this.materialBehind.color=this.colorBehind,this.materialBehind.blend=!0,this.materialBehind.blendSrc=6,this.materialBehind.blendDst=8,this.materialBehind.depthTest=!1,this.materialBehind.depthWrite=!1,this.materialBehind.update()},t._createMaterialSpot=function(){var t;this.materialSpot=new Ka,this.materialSpot.updateShader=function(e){t||(t=new Et(e,{attributes:{vertex_position:"POSITION",outer:"ATTR15"},vshader:"\n                    attribute vec3 vertex_position;\n                    attribute float outer;\n                    \n                    uniform mat4 matrix_model;\n                    uniform mat4 matrix_viewProjection;\n                    uniform float range;\n                    uniform float innerAngle;\n                    uniform float outerAngle;\n                    \n                    void main(void)\n                    {\n                        mat4 modelMatrix = matrix_model;\n                        vec4 positionW = vec4(vertex_position, 1.0);\n                        float radius = (outer * (sin(radians(outerAngle)) * range)) + ((1.0 - outer) * (sin(radians(innerAngle)) * range));\n                        positionW.xz *= radius;\n                        positionW.y *= range * ((outer * cos(radians(outerAngle))) + ((1.0 - outer) * cos(radians(innerAngle))));\n                        positionW = modelMatrix * positionW;\n                        gl_Position = matrix_viewProjection * positionW;\n                    }\n                    ".trim(),fshader:("\n                    precision "+e.precision+" float;\n                    \n                    uniform vec4 uColor;\n                    \n                    void main(void)\n                    {\n                        gl_FragColor = uColor;\n                        gl_FragColor = clamp(gl_FragColor, 0.0, 1.0);\n                    }\n                    ").trim()})),this.shader=t},this.materialSpot.color=this.colorPrimary,this.materialSpot.depthTest=!1,this.materialSpot.depthWrite=!1,this.materialSpot.update(),this.materialSpotBehind=new Ka,this.materialSpotBehind.updateShader=this.materialSpot.updateShader,this.materialSpotBehind.color=this.colorBehind,this.materialSpotBehind.blend=!0,this.materialSpotBehind.blendSrc=6,this.materialSpotBehind.blendDst=8,this.materialSpotBehind.depthTest=!1,this.materialSpotBehind.depthWrite=!1,this.materialSpotBehind.update()},t._createDirectionalLight=function(){var e=new ut(rm.graphicsDevice,[{semantic:Te,components:3,type:6}]),t=Math.PI/180,i=new ht(rm.graphicsDevice,e,14),n=new Ct(i),a=-1.6;n.element.POSITION.set(0,0,0),n.next(),n.element.POSITION.set(0,a,0),n.next(),n.element.POSITION.set(.2*Math.sin(0*t),a,.2*Math.cos(0*t)),n.next(),n.element.POSITION.set(.2*Math.sin(120*t),a,.2*Math.cos(120*t)),n.next(),n.element.POSITION.set(.2*Math.sin(120*t),a,.2*Math.cos(120*t)),n.next(),n.element.POSITION.set(.2*Math.sin(240*t),a,.2*Math.cos(240*t)),n.next(),n.element.POSITION.set(.2*Math.sin(240*t),a,.2*Math.cos(240*t)),n.next(),n.element.POSITION.set(.2*Math.sin(0*t),a,.2*Math.cos(0*t)),n.next(),n.element.POSITION.set(.2*Math.sin(0*t),a,.2*Math.cos(0*t)),n.next(),n.element.POSITION.set(0,-2,0),n.next(),n.element.POSITION.set(.2*Math.sin(120*t),a,.2*Math.cos(120*t)),n.next(),n.element.POSITION.set(0,-2,0),n.next(),n.element.POSITION.set(.2*Math.sin(240*t),a,.2*Math.cos(240*t)),n.next(),n.element.POSITION.set(0,-2,0),n.next(),n.end();var s=new mn,r=new Zi;r.vertexBuffer=i,r.indexBuffer[0]=null,r.primitive[0].type=1,r.primitive[0].base=0,r.primitive[0].count=i.getNumVertices(),r.primitive[0].indexed=!1;var o=new Mn(s,r,this.material);o.mask=8,o.pick=!1;var l=new Mn(s,r,this.materialBehind);l.__useFrontLayer=!0,l.mask=8,l.pick=!1;var h=new rr;h.graph=s,h.meshInstances=[o,l],this.models.directional=h},t._createPointLight=function(){for(var e=new ut(rm.graphicsDevice,[{semantic:Te,components:3,type:6}]),t=Math.PI/180,i=new ht(rm.graphicsDevice,e,144),n=new Ct(i),a=0;a<72;a++)n.element.POSITION.set(Math.sin(5*a*t),Math.cos(5*a*t),0),n.next(),n.element.POSITION.set(Math.sin(5*(a+1)*t),Math.cos(5*(a+1)*t),0),n.next();n.end();var s=new mn,r=new Zi;r.vertexBuffer=i,r.indexBuffer[0]=null,r.primitive[0].type=1,r.primitive[0].base=0,r.primitive[0].count=i.getNumVertices(),r.primitive[0].indexed=!1;var o=new Mn(s,r,this.material);o.mask=8,o.pick=!1;var l=new Mn(s,r,this.materialBehind);l.__useFrontLayer=!0,l.mask=8,l.pick=!1;var h=new rr;h.graph=s,h.meshInstances=[o,l],this.models.point=h},t._createSpotLight=function(){var e=new ut(rm.graphicsDevice,[{semantic:Te,components:3,type:6},{semantic:Ke,components:1,type:6}]),t=Math.PI/180,i=new ht(rm.graphicsDevice,e,296),n=new Ct(i);n.element.POSITION.set(0,0,0),n.element.ATTR15.set(1),n.next(),n.element.POSITION.set(Math.sin(0*t),-1,Math.cos(0*t)),n.element.ATTR15.set(1),n.next(),n.element.POSITION.set(0,0,0),n.element.ATTR15.set(1),n.next(),n.element.POSITION.set(Math.sin(180*t),-1,Math.cos(180*t)),n.element.ATTR15.set(1),n.next();for(var a=0;a<72;a++)n.element.POSITION.set(Math.sin(5*a*t),-1,Math.cos(5*a*t)),n.element.ATTR15.set(0),n.next(),n.element.POSITION.set(Math.sin(5*(a+1)*t),-1,Math.cos(5*(a+1)*t)),n.element.ATTR15.set(0),n.next(),n.element.POSITION.set(Math.sin(5*a*t),-1,Math.cos(5*a*t)),n.element.ATTR15.set(1),n.next(),n.element.POSITION.set(Math.sin(5*(a+1)*t),-1,Math.cos(5*(a+1)*t)),n.element.ATTR15.set(1),n.next();n.end();var s=new mn,r=new Zi;r.vertexBuffer=i,r.indexBuffer[0]=null,r.primitive[0].type=1,r.primitive[0].base=0,r.primitive[0].count=i.getNumVertices(),r.primitive[0].indexed=!1;var o=new Mn(s,r,this.materialSpot);o.mask=8,o.pick=!1;var l=new Mn(s,r,this.materialSpotBehind);l.__useFrontLayer=!0,l.mask=8,l.pick=!1;var h=new rr;h.graph=s,h.meshInstances=[o,l],this.models.spot=h},t.destroy=function(){var t=this;this.gizmoSize=.2,this.colorBehind=null,this.colorPrimary=null,Object.keys(this.models).forEach(function(e){t.models[e]instanceof rr&&t.models[e].destroy()}),this.models={},this.material=null,this.materialBehind=null,this.materialSpot=null,this.materialSpotBehind=null},e}(),jb=null,Xb=function(){function e(e){void 0===e&&(e={}),this.light=null,this.currentGizmo=null,(jb=this).type=null,this.worldMode=!0,this.entity=new Cr,this.entity.name="Gizmo Root",this.rotate=new Nb(e),this.scale=new Gb(e),this.translate=new Wb(e),this.light=new Hb,this.entity.addChild(this.light.entity),this.entity.addChild(this.rotate.entity),this.entity.addChild(this.scale.entity),this.entity.addChild(this.translate.entity),this.entity.enabled=!0,rm.root.addChild(this.entity),this.aabb=null,this.render=!1,this.list=[],rm.method("edk:render:gizmo:change:type",this.changeType,this),rm.method("edk:render:gizmo:change:mode",this.changeMode,this),rm.method("edk:render:gizmo:get:icon",this.getIconGizmo,this),rm.on("edk:render:gizmo:update:gizmo",this.updateGizmo,this),rm.on("edk:render:gizmo:update:light:gizmo",this.updateLightGizmo,this),rm.on("edk:auxiliary:aabb:change",this.onAabbChange,this)}var t=e.prototype;return t.getIconGizmo=function(){return this.icon},t.getLightGizmo=function(){return this.light},t.onAabbChange=function(e,t,i){this.aabb=e,this.render=t,this.list=i,this.updateGizmo(),this.light&&this.updateLightGizmo()},t.changeType=function(t){var i=this;this.type=t,-1!==["scale","rotate","translate"].indexOf(t)?(["scale","rotate","translate"].forEach(function(e){i.type===e?(i[t].entity.enabled=!0,i.currentGizmo=i[t]):i[e].entity.enabled=!1}),this.updateGizmo()):(this.currentGizmo&&this.currentGizmo.update({enabled:!1}),this.currentGizmo=null)},t.changeMode=function(e){this.worldMode=e,this.updateGizmo()},t.updateGizmo=function(){if(this.render&&this.currentGizmo)if(1<this.list.length){var e=rm.root.getEulerAngles();this.currentGizmo.update({enabled:!0,worldMode:!0,position:[this.aabb.center.x,this.aabb.center.y,this.aabb.center.z],rotation:[e.x,e.y,e.z]})}else if(1===this.list.length){var t=this.list[0];if(t){if("marker"===t.type&&"scale"!==this.type)return void this.currentGizmo.update("enabled",!1);var i=rm.root.getEulerAngles(),n=t.getEulerAngles(),a=t.getPosition();this.currentGizmo.update({enabled:!0,worldMode:this.worldMode,position:[a.x,a.y,a.z],rotation:this.worldMode&&"scale"!==this.type?[i.x,i.y,i.z]:[n.x,n.y,n.z].map(function(e){return isNaN(e)?0:e})})}else this.currentGizmo.update("enabled",!1)}else this.currentGizmo.update("enabled",!1);else this.currentGizmo&&this.currentGizmo.update("enabled",!1)},t.updateLightGizmo=function(){if(this.render)if(1===this.list.length){var e=this.list[0];if(e&&e.enabled&&"light"===e.type){var t=e.getEulerAngles(),i=e.getPosition();this.lightType!==e.light.type&&(this.lightType=e.light.type,this.light.updateType(this.lightType,e.light)),this.light.update({enabled:!0,range:e.light.range,innerAngle:e.light.innerConeAngle,outerAngle:e.light.outerConeAngle,position:[i.x,i.y,i.z],rotation:[t.x,t.y,t.z]})}else this.lightType=null,this.light.updateType(null),this.light.update("enabled",!1)}else this.lightType=null,this.light.updateType(null),this.light.update("enabled",!1);else this.lightType=null,this.light.updateType(null),this.light.update("enabled",!1)},t.destroy=function(){this.type=null,this.worldMode=!0,this.rotate.destroy(),this.rotate=null,this.scale.destroy(),this.scale=null,this.translate.destroy(),this.translate=null,this.light.destroy(),this.light=null,this.entity.destroy(),this.aabb=null,this.render=!1,this.list=[],jb=null},e}(),qb=function(){function e(){this.wireframeEntityName="WIREFRAME_CLONE",this.uvTextureUrl="https://staging.asset.realibox.com/realibox/studio/0a2283f8-1156-4828-8ce1-643e67ecd03d.png",this.uvTexture=null,this.uvMaterial=null,this.stats=null,this.grid=null,this.gridLayer=null,this.config={wireframe:!1,uv_detection:!1,stats_panel:!1,view_cube:!1,ground_grid:!1},rm.method("edk:render:editorViewConfig:change:config",this.changeConfig,this),rm.method("edk:render:editorViewConfig:change:close",this.closeAllConfig,this),rm.method("edk:render:editorViewConfig:change:restore",this.restoreAllConfig,this),this.changeViewCube(!1)}var t=e.prototype;return t.closeAllConfig=function(t){var i=this,n=h({},this.config);Object.keys(this.config).forEach(function(e){n[e]&&i.changeConfig(t,e,!1)}),this.config=n},t.restoreAllConfig=function(t){var i=this;Object.keys(this.config).forEach(function(e){i.config[e]&&i.changeConfig(t,e,i.config[e])})},t.changeConfig=function(e,t,i){switch(this.config[t]=i,t){case"wireframe":this.changeWireframe(i);break;case"uv_detection":this.changeUVDetection(i);break;case"stats_panel":this.changeStats(i);break;case"view_cube":this.changeViewCube(i);break;case"ground_grid":this.changeGrid(i)}},t.changeUVDetection=function(e){var n=this;if(this.uvTexture&&this.uvMaterial)rm.fire("edk:app:entity:uvDetection:change",!!e&&this.uvMaterial);else{if(!e)return;rm.loader.load(s_(this.uvTextureUrl),"texture",function(e,t,i){e||(n.uvTexture=t,n.uvMaterial=new gm,n.uvMaterial.name="UV_TEST_MATERIAL",n.uvMaterial.useLighting=!1,n.uvMaterial.useSkybox=!1,n.uvMaterial.diffuseMap=n.uvTexture,rm.fire("edk:app:entity:uvDetection:change",n.uvMaterial))})}},t.changeWireframe=function(e){rm.fire("edk:app:entity:wireframe:change",e)},t.changeStats=function(e){var t,i,n,a=this;e?this.stats?this.stats.showAllPanel():(this.stats=new r_,this.stats.showAllPanel(),null==(t=rm.graphicsDevice.canvas)||null==(i=t.parentElement)||i.appendChild(this.stats.dom),rm.on("frameupdate",function(e){a.stats.begin()}),rm.on("frameend",function(e){a.stats.end()})):null==(n=this.stats)||n.hideAllPanel()},t.changeViewCube=function(e){rm&&rm.root&&rm.root.script&&rm.root.script.viewcube&&(rm.root.script.viewcube.enabled=e)},t.changeGrid=function(e){if(e){if(this.grid)return this.changeGrid(!1);this.grid=new Vb,this.grid.initialize(),this.gridLayer=rm.call("edk:layer:get","Viewport Grid"),this.gridLayer.addMeshInstances(this.grid.model.meshInstances)}else this.grid&&this.gridLayer&&(this.gridLayer.removeMeshInstances(this.grid.model.meshInstances),this.grid.destroy(),this.grid=null)},t.destroy=function(){this.uvTexture=null,this.uvMaterial=null,this.stats=null,this.grid=null,this.gridLayer=null,this.config={}},e}(),$b=function(){function e(e){this.sceneInitialized=!1,this.registry=e,this.canvas=this.registry.canvas,this.ctx=this.registry.ctx,this.layerComposition=this.registry.layerComposition,this.layer=this.registry.layer}var t=e.prototype;return t.initializeScene=function(){this.defaultMaterial=new gm,this.sphere=new Cr,this.sphere.addComponent("model",{type:"sphere",layers:[this.layer.id]}),this.sphere.model.material=this.defaultMaterial;var e=new mn,t=tr(rm.graphicsDevice,{radius:.5,latitudeBands:128,longitudeBands:128});this.sphereModel=new rr,this.sphereModel.graph=e,this.sphereModel.meshInstances=[new Mn(e,t,this.defaultMaterial)],this.sphere.model.model=this.sphereModel,this.box=new Cr,this.box.addComponent("model",{type:"box",layers:[this.layer.id]}),this.box.setLocalScale(.6,.6,.6),this.box.model.material=this.defaultMaterial,this.lightEntity=new Cr("preview_light"),this.lightEntity.addComponent("light",{type:"directional",layers:[this.layer.id]}),this.lightEntity.setLocalEulerAngles(45,45,0),this.cameraOrigin=new mn,this.cameraEntity=new Cr,this.cameraEntity.addComponent("camera",{nearClip:.1,farClip:32,clearColor:new $(41/255,53/255,56/255,0),frustumCulling:!1,layers:[this.layer.id]}),this.cameraEntity.setLocalPosition(0,0,1.35),this.cameraOrigin.addChild(this.cameraEntity),this.previewRoot=new Cr,this.previewRoot._enabledInHierarchy=!0,this.previewRoot.enabled=!0,this.previewRoot.addChild(this.box),this.previewRoot.addChild(this.sphere),this.previewRoot.addChild(this.lightEntity),this.previewRoot.addChild(this.cameraOrigin),this.previewRoot.syncHierarchy(),this.previewRoot.enabled=!1,this._rotationX=0,this._rotationY=0,this._model="sphere"},t.render=function(e,t,i,n,a){void 0===i&&(i={}),void 0===a&&(a="sphere"),i=i||{};var s=rm.graphicsDevice.gl;this.sceneInitialized||this.initializeScene(),this._rotationX=i.hasOwnProperty("rotation")?i.rotation[0]:-160,this._rotationY=i.hasOwnProperty("rotation")?i.rotation[1]:160,this._model=a;var r=this.canvas.width,o=this.canvas.height;o<r?r=o:o=r,this.previewRoot.enabled=!0,this.cameraEntity.camera.aspectRatio=o/r,this.layer.renderTarget=t,this.material=e.resource.clone(),this.material.useFog=!1,"box"===a?(this.sphere.enabled=!1,this.box.enabled=!0,this.box.model.material=this.material):(this.box.enabled=!1,this.sphere.enabled=!0,this.sphere.model.material=this.material),this.cameraOrigin.setLocalEulerAngles(this._rotationX,this._rotationY,0),this.lightEntity.light.intensity=1/(Math.min(1,rm.scene.exposure)||.01),this.layer.addCamera(this.cameraEntity.camera),this.layer.addLight(this.lightEntity.light),this.layer.addMeshInstances(this.sphere.enabled?this.sphere.model.meshInstances:this.box.model.meshInstances),rm.renderer.renderComposition(this.layerComposition),s.bindFramebuffer(s.FRAMEBUFFER,this.layer.renderTarget._glFrameBuffer),s.readPixels(0,0,r,o,s.RGBA,s.UNSIGNED_BYTE,this.layer.renderTarget.pixels);var l=new ImageData(this.layer.renderTarget.pixelsClamped,this.canvas.width,this.canvas.height);return n&&(this.ctx.putImageData(l,0,0),l=this.canvas.toDataURL()),this.layer.renderTarget=null,this.layer.removeCamera(this.cameraEntity.camera),this.layer.removeLight(this.lightEntity.light),this.layer.removeMeshInstances(this.sphere.enabled?this.sphere.model.meshInstances:this.box.model.meshInstances),this.previewRoot.enabled=!1,this.material&&this.material!==this.defaultMaterial&&("box"===a?this.box.model.material=this.defaultMaterial:this.sphere.model.material=this.defaultMaterial,this.material.destroy()),l},t.destroy=function(){this.registry=null,this.canvas=null,this.ctx=null,this.layerComposition=null,this.layer=null,this.defaultMaterial=null,this.sphereModel&&this.sphereModel.destroy(),this.sphereModel=null,this.sphere&&this.sphere.destroy(),this.sphere=null,this.box&&this.box.destroy(),this.box=null,this.lightEntity&&this.lightEntity.destroy(),this.lightEntity=null,this.cameraOrigin=null,this.cameraEntity&&this.cameraEntity.destroy(),this.cameraEntity=null,this.previewRoot&&this.previewRoot.destroy(),this.previewRoot=null,this._rotationX=0,this._rotationY=0,this._model="sphere"},e}(),Yb=function(){function e(e){this.sceneInitialized=!1,this.registry=e,this.canvas=this.registry.canvas,this.ctx=this.registry.ctx,this.layerComposition=this.registry.layerComposition,this.layer=this.registry.layer}var t=e.prototype;return t.initializeScene=function(){this.material=new gm,this.material.useSkybox=!1,this.material.useFog=!1,this.aabb=new ue;var e=new mn,t=tr(rm.graphicsDevice,{radius:0,latitudeBands:2,longitudeBands:2});this.modelPlaceholder=new rr,this.modelPlaceholder.node=e,this.modelPlaceholder.meshInstances=[new Mn(e,t,this.material)],this.lightEntity=new Cr,this.lightEntity.addComponent("light",{type:"directional",layers:[this.layer.id]}),this.lightEntity.setLocalEulerAngles(45,135,0),this.cameraOrigin=new Cr,this.cameraEntity=new Cr,this.cameraEntity.addComponent("camera",{nearClip:.01,farClip:32,clearColor:new $(41/255,53/255,56/255,0),frustumCulling:!1,layers:[this.layer.id]}),this.cameraEntity.setLocalPosition(0,0,1.35),this.cameraOrigin.addChild(this.cameraEntity),this.previewRoot=new Cr,this.previewRoot._enabledInHierarchy=!0,this.previewRoot.enabled=!0,this.previewRoot.addChild(e),this.previewRoot.addChild(this.lightEntity),this.previewRoot.addChild(this.cameraOrigin),this.previewRoot.syncHierarchy(),this.previewRoot.enabled=!1,this._rotationX=-160,this._rotationY=160},t.render=function(e,t,i,n){void 0===i&&(i={}),i=i||{};var a=rm.graphicsDevice.gl;this.sceneInitialized||this.initializeScene(),this._rotationX=i.hasOwnProperty("rotation")?i.rotation[0]:this._rotationX,this._rotationY=i.hasOwnProperty("rotation")?i.rotation[1]:this._rotationY;var s=this.canvas.width,r=this.canvas.height;if(r<s?s=r:r=s,this.previewRoot.enabled=!0,this.cameraEntity.camera.aspectRatio=r/s,this.layer.renderTarget=t,this.model=this.modelPlaceholder,this.first=!0,e.resource){try{this.model=e.resource.clone()}catch(e){}for(var o=0;o<this.model.meshInstances.length;o++)this.model.meshInstances[o].skinInstance&&this.model.meshInstances[o].skinInstance.updateMatrices(this.model.meshInstances[o].node),this.model.meshInstances[o].material=this.material,this.first?(this.first=!1,this.aabb.copy(this.model.meshInstances[o].aabb)):this.aabb.add(this.model.meshInstances[o].aabb)}this.material.update(),this.model.lights=[this.lightEntity.light.light],this.first&&(this.aabb.center.set(0,0,0),this.aabb.halfExtents.set(.01,.01,.01));var l=this.aabb.halfExtents.length();this.cameraEntity.setLocalPosition(0,0,2.5*l),this.cameraOrigin.setLocalPosition(this.aabb.center),this.cameraOrigin.setLocalEulerAngles(this._rotationX,this._rotationY,0),this.cameraOrigin.syncHierarchy(),this.lightEntity.setLocalRotation(this.cameraOrigin.getLocalRotation()),this.lightEntity.rotateLocal(90,0,0),this.cameraEntity.camera.farClip=5*l,this.lightEntity.light.intensity=1/(Math.min(1,rm.scene.exposure)||.01),this.layer.addMeshInstances(this.model.meshInstances),this.layer.addLight(this.lightEntity.light),this.layer.addCamera(this.cameraEntity.camera),rm.renderer.renderComposition(this.layerComposition),a.bindFramebuffer(a.FRAMEBUFFER,this.layer.renderTarget._glFrameBuffer),a.readPixels(0,0,s,r,a.RGBA,a.UNSIGNED_BYTE,this.layer.renderTarget.pixels);var h=new ImageData(this.layer.renderTarget.pixelsClamped,this.canvas.width,this.canvas.height);return n&&(this.ctx.putImageData(h,0,0),h=this.canvas.toDataURL()),this.layer.removeLight(this.lightEntity.light),this.layer.removeCamera(this.cameraEntity.camera),this.layer.removeMeshInstances(this.model.meshInstances),this.layer.renderTarget=null,this.previewRoot.enabled=!1,this.model!==this.modelPlaceholder&&this.model.destroy(),h},t.destroy=function(){this.registry=null,this.canvas=null,this.ctx=null,this.layerComposition=null,this.layer=null,this.material=null,this.aabb=null,this.modelPlaceholder&&this.modelPlaceholder.destroy(),this.modelPlaceholder=null,this.lightEntity&&this.lightEntity.destroy(),this.lightEntity=null,this.cameraOrigin&&this.cameraOrigin.destroy(),this.cameraOrigin=null,this.cameraEntity&&this.cameraEntity.destroy(),this.cameraEntity=null,this.previewRoot&&this.previewRoot.destroy(),this.previewRoot=null,this._rotationX=-160,this._rotationY=160},e}(),Kb=function(){function e(e){this.sceneInitialized=!1,this.registry=e,this.canvas=this.registry.canvas,this.ctx=this.registry.ctx,this.layerComposition=this.registry.layerComposition,this.layer=this.registry.layer,this.backupCameraColor=[]}var t=e.prototype;return t.initializeScene=function(){this.sceneCanvas=document.createElement("canvas"),this.sceneCtx=this.sceneCanvas.getContext("2d"),this.worldLayer=rm.call("edk:layer:get","World"),this.skyboxLayer=rm.call("edk:layer:get","Skybox"),this.transparentLayer=rm.call("edk:layer:get","Transparent")},t.render=function(e){var t,i,n,a,s,r,o,l,h,c,u,d,p,f,m,v,g,_,y,b=this,x=rm.graphicsDevice.gl,M=rm.graphicsDevice.maxRenderBufferSize,S=e.width,w=e.height,C=e.canvasWidth,P=e.canvasHeight,T=e.format,A=e.transparent,E=e.sampling,R=e.x,D=e.y,I=1;this.sceneInitialized||this.initializeScene();var k=rm.scene._activeCamera.clearColor.clone();T=void 0!==T&&0===T?"image/png":"image/jpeg",A=void 0!==A&&A,S=void 0!==S?S:1280,w=void 0!==w?w:720,v=(C=void 0!==C?C:S)*(E=void 0!==E?E:1),g=(P=void 0!==P?P:w)*E,_=S*E,y=w*E,R=void 0!==R?Math.floor(R*E):0,D=void 0!==D?Math.floor(D*E):0,(M<v||M<g)&&(I=M/Math.max(v,g),v=Math.floor(v*I),g=Math.floor(g*I),_=Math.floor(_*I),y=Math.floor(y*I),R=Math.floor(R*I),D=Math.floor(D*I));var L=this.registry.getRenderTarget(rm,v,g,!1,_,y);if(null!=(t=L)&&t.isError)return L;var O,F,z,B=this.worldLayer.renderTarget,V=this.skyboxLayer.renderTarget,U=this.transparentLayer.renderTarget;this.worldLayer.renderTarget=L,this.transparentLayer.renderTarget=L,A?rm.scene._activeCamera.clearColor.set(0,0,0,0):($y&&$y.background&&"image"===$y.background.type&&this.worldLayer.cameras.forEach(function(e,t){b.backupCameraColor[t]=e.clearColorBuffer,e.clearColorBuffer=!1}),this.skyboxLayer.renderTarget=L,null==rm||null==(O=rm.backgroundRenderer)||O.setRenderTarget(L),null==rm||null==(F=rm.backgroundRenderer)||F.render({canvasWidth:C,canvasHeight:P}),null==rm||null==(z=rm.backgroundRenderer)||z.setRenderTarget(null));var N=null==(i=rm.scene)||null==(n=i._activeCamera)||null==(a=n.node)||null==(s=a.camera)||null==(r=s._postEffects)?void 0:r.destinationRenderTarget;null!=(o=rm.scene)&&null!=(l=o._activeCamera)&&null!=(h=l.node)&&null!=(c=h.camera)&&c._postEffects&&(rm.scene._activeCamera.node.camera._postEffects.destinationRenderTarget=L);var G,W,H,j,X=[];null!=(u=rm.scene.layers.cameras)&&u.filter(function(e){return e.renderTarget}).length&&((G=X).push.apply(G,null==(W=rm.scene.layers.cameras)?void 0:W.map(function(e){return e.renderTarget})),null==(H=rm.scene.layers.cameras)||H.forEach(function(e){e.renderTarget=L})),rm.renderer.renderComposition(rm.scene.layers),X.length&&(null==(j=rm.scene.layers.cameras)||j.forEach(function(e,t){return e.renderTarget=X[t]})),null!=(d=rm.scene)&&null!=(p=d._activeCamera)&&null!=(f=p.node)&&null!=(m=f.camera)&&m._postEffects&&(rm.scene._activeCamera.node.camera._postEffects.destinationRenderTarget=N),$y&&$y.background&&"image"===$y.background.type&&!A&&this.worldLayer.cameras.forEach(function(e,t){e.clearColorBuffer=b.backupCameraColor[t]}),x.bindFramebuffer(x.FRAMEBUFFER,L._glFrameBuffer),x.readPixels(R,D,_,y,x.RGBA,x.UNSIGNED_BYTE,L.pixels),this.worldLayer.renderTarget=B,this.transparentLayer.renderTarget=U,A?rm.scene._activeCamera.clearColor=k:this.skyboxLayer.renderTarget=V;var q=new ImageData(L.pixelsClamped,_,y);return this.canvas.width=_,this.canvas.height=y,this.ctx.putImageData(q,0,0,0,0,_,y),this.sceneCanvas.width=S,this.sceneCanvas.height=w,this.sceneCtx.scale(1,-1),this.sceneCtx.translate(0,-w),this.sceneCtx.drawImage(this.canvas,0,0,S,w),L=X=null,this.registry.destroyRenderTarget(v,g),this.sceneCanvas.toDataURL(T)},t.destroy=function(){this.registry=null,this.canvas=null,this.ctx=null,this.layerComposition=null,this.layer=null,this.backupCameraColor=[],this.sceneCanvas=null,this.worldLayer=null,this.skyboxLayer=null},e}(),Zb=null,Qb=function(){function e(){(Zb=this).canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.preInitialize(),this.preInitializeEvents(),this.material=new $b(this),this.model=new Yb(this),this.scene=new Kb(this)}var t=e.prototype;return t.preInitialize=function(){this.layer=new _a({id:-1,enabled:!0,opaqueSortMode:2,transparentSortMode:3}),this.renderTargets={},this.layerComposition=new pi("thumbnail-renderer"),this.layerComposition.push(this.layer)},t.preInitializeEvents=function(){rm.method("edk:render:preview:resource",this.previewResource,this),rm.method("edk:render:preview:viewport",this.previewViewport,this),rm.method("edk:render:preview:canvas",this.getCanvas,this),rm.method("edk:render:preview:canvas:ctx",this.getCtx,this)},t.previewResource=function(n,a){var s=this;return new Promise(function(e,t){if(Xy){var i=Xy.getResource(n,a);if(i&&i.type&&i.asset&&i.asset.loaded)try{s.getHandler(i.type)([i.type,i.asset,{},!0],e,t)}catch(e){}else t()}else t()})},t.getHandler=function(e){switch(e){case"material":return this.materialHandler.bind(this);default:return this.normalHandler.bind(this)}},t.materialHandler=function(i,n,e){var t;i[0];var a=i[1];i[2],i[3],null!=a&&null!=(t=a.resource)&&t.transmission&&!rm.generatedTransmissionRT?rm.once("app:renderer:transmissionRT",function(){var e,t=(e=Zb).previeRender.apply(e,i);n(t)}):this.normalHandler.apply(this,arguments)},t.normalHandler=function(e,t,i){var n;t((n=Zb).previeRender.apply(n,e))},t.previewViewport=function(e){return this.scene.render(e)},t.getCanvas=function(){return this.canvas},t.getCtx=function(){return this.ctx},t.getRenderTarget=function(e,t,i,n,a,s){var r=this.renderTargets[t+"-"+i];if(r)return r;a=void 0!==a?a:t,s=void 0!==s?s:i;var o=new Kt(e.graphicsDevice,{width:t,height:i,format:7});r=new Fm({colorBuffer:o,flipY:n}),this.renderTargets[t+"-"+i]=r;try{r.buffer=new ArrayBuffer(a*s*4),r.pixels=new Uint8Array(r.buffer),r.pixelsClamped=new Uint8ClampedArray(r.buffer)}catch(e){return{isError:!0,message:"Insufficient Memory"}}return r},t.destroyRenderTarget=function(e,t){var i=this.renderTargets[e+"-"+t];i&&(i.buffer=null,i.pixels=null,i.pixelsClamped=null,i.destroy(),i.destroyTextureBuffers(),delete this.renderTargets[e+"-"+t])},t.previeRender=function(e,t,i,n){if(this[e]){var a=this.nextPow2(512),s=this.nextPow2(a),r=this.getRenderTarget(rm,a,s);return this.canvas.width=a,this.canvas.height=s,this[e].render(t,r,i,n)}return null},t.nextPow2=function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)))},t.destroy=function(){var t=this;this.canvas=null,this.ctx=null,this.layer=null,Object.keys(this.renderTargets).forEach(function(e){t.renderTargets[e]&&t.renderTargets[e].destroy()}),this.renderTargets={},this.layerComposition.destroy(),this.material.destroy(),this.material=null,this.model.destroy(),this.model=null,this.scene.destroy(),this.scene=null},e}(),Jb=function(n){function e(e){var t;return(t=n.call(this,e)||this).needReset=!1,t.meshIndex=0,t.scaleFactor=1,t.scale=new de(1,1,1),t.mappingScale=new de(1,1,1),t.centerPos=new de(0,0,0),t.relativePos=new de(0,0,0),t.mapTiling=new J(1,1),t.defaultTiling=[1,1],t.defaultRotation=[0,0,0],t.defaultTranslation=[0,0,0],t.entity=new Cr,t.uvmapping=null,t.root=null,t.meshInstance=null,t.layerIDs=[],t.material=null,t.mapField=null,t.parent=null,t.enabled=!1,t.aabbA=null,t.aabbB=null,t.recordRotation=t.defaultRotation,Object.assign(g(t),e),t.root.addChild(t.entity),rm.on("edk:render:uvmapping:update:model",t.updateData,g(t)),t.camera=rm.call("edk:render:camera:get"),t.camera||rm.once("edk:render:camera:change",t.setCamera,g(t)),t}u(e,n);var t=e.prototype;return t.setCamera=function(e){this.camera=e},t.initialize=function(e){try{this.initEntity(e),this.initTiling(),this.initPosition(),this.initRotation(),this.initScale()}catch(e){}},t.initEntity=function(e){this.entity.name=e+" Mapping",this.entity.addComponent("model",{type:e,layers:this.layerIDs}),this.entity.model.material.cull=0,this.entity.model.material.blend=!0,this.entity.model.material.blendType=4,this.entity.model.material.depthTest=!1,this.entity.model.material.diffuse=new $(1,1,1),this.entity.model.material.opacity=.25,this.entity.model.castShadows=!1,this.entity.enabled=this.enabled,this.aabbA=this.meshInstance.aabb.clone(),this.aabbB=this.entity.model.meshInstances[this.meshIndex].aabb.clone(),this.centerPos=this.meshInstance.aabb.center,this.relativePos.sub2(this.centerPos,this.entity.getPosition())},t.initPosition=function(){var e=this.material[this.mapField+"MappingTranslation"];this.needReset||e.toString()===de.ZERO.toString()?this.updateField("mapTranslation",[this.relativePos.x,this.relativePos.y,this.relativePos.z],{action:"complete"}):this.setPosition(e.clone().add(this.centerPos).sub(this.relativePos))},t.initScale=function(){var e=this.material[this.mapField+"MappingScale"];if(this.needReset||e.toString()===de.ONE.toString()){var t=this.aabbA.halfExtents,i=this.aabbB.halfExtents,n=new de(this.getScaleComp(t.x,i.x),this.getScaleComp(t.y,i.y),this.getScaleComp(t.z,i.z));return this.setScale(n),n}var a=this.getScaleByMapTiling();return this.entity.setLocalScale(a),a},t.initTiling=function(){this.needReset&&this.updateField("mapTiling",this.defaultTiling),this.mapTiling=this.material[this.mapField+"Tiling"]},t.initRotation=function(){var e=this.material[this.mapField+"MappingRotation"];this.updateGizmo("rotation",[e.x,e.z,e.y]),this.setRotation([e.x,e.z,e.y])},t.onAdaptX=function(){this.reset()},t.onAdaptY=function(){this.reset()},t.onAdaptZ=function(){this.reset()},t.reset=function(e){var t;void 0===e&&(e={}),this.needReset=!0;var i=this.initScale();this.updateData(Object.assign({mapRotation:this.defaultRotation,mapTranslation:[this.relativePos.x,this.relativePos.y,this.relativePos.z],mapTiling:this.defaultTiling,mapScale:i instanceof de?[i.x,i.y,i.z]:i},e),null,{action:"complete"}),this.updateGizmo("rotation",(null==(t=e)?void 0:t.mapRotation)||this.defaultRotation)},t.update=function(e,t){e instanceof Object?Object.assign(this,e):this[e]=t},t.updateGizmo=function(e,t){this.uvmapping.currentGizmo&&(this.uvmapping.gizmoWorldMode&&("rotation"===e?t=[0,0,0]:null!=e&&e.rotation&&(e.rotation=[0,0,0])),this.uvmapping.currentGizmo.update(e,t))},t.updateField=function(e,t,i){void 0===i&&(i={action:"complete"});var n=i.action,a=void 0===n?"complete":n;switch(t instanceof de&&(t=[t.x,t.y,t.z]),e){case"mapTranslation":a?this.requestUpdate("mapTranslation",t,i):(t=z(de,t).add(this.centerPos).sub(this.relativePos),this.setPosition(t));break;case"mapRotation":a?this.requestUpdate("mapRotation",t,i):this.setRotation(t);break;case"mapScale":t=t.map(function(e){return e||1}),this.setScale.apply(this,t),a&&this.requestUpdate("mapScale",t,i);break;case"mapTiling":if(this.scale){var s;this.mapTiling=new J(t[0]/2,t[1]/2);var r=this.getScaleByMapTiling();a&&this.requestUpdate("mapTiling",t,i),(s=this.entity).setLocalScale.apply(s,r)}}},t.updateData=function(i,e,t){var n=this;void 0===t&&(t={action:"complete"}),e instanceof de&&(e=[e.x,e.y,e.z]),"object"==(void 0===i?"undefined":dx(i))?(Object.keys(i).forEach(function(e){var t=i[e];t instanceof de&&(i[e]=[t.x,t.y,t.z]),n.updateField(e,t,{action:""})}),this.requestUpdate(i,null,t)):this.updateField(i,e,t)},t.setPosition=function(e){var t,i=e instanceof de?[e.x,e.y,e.z]:e instanceof Array?[e[0],e[1],e[2]]:[e,arguments[1],arguments[2]];this.updateGizmo("position",i),(t=this.entity).setPosition.apply(t,i)},t.setRotation=function(e){var t;e instanceof Array?(this.recordRotation=z(de,e),(t=this.entity).setEulerAngles.apply(t,e)):e instanceof de&&(this.recordRotation=e,this.entity.setEulerAngles(e)),this.updateGizmo("rotation",e)},t.setScale=function(e,t,i){var n;e instanceof de?(t=e.y||1,i=e.z||1,e=e.x||1):e instanceof Array&&(t=e[1]||1,i=e[2]||1,e=e[0]||1),this.scale.set(e,t,i),(n=this.entity).setLocalScale.apply(n,this.getScaleByMapTiling())},t.setMaxScale=function(){var e=this.mapTiling,t=Math.max(2*e.x,2*e.y),i=this.aabbA.halfExtents,n=this.aabbB.halfExtents,a=Math.max(this.getScaleComp(i.x,n.x),this.getScaleComp(i.y,n.y),this.getScaleComp(i.z,n.z)),s=new de(a*t,a*t,a*t);return this.setScale(s),s},t.getScaleComp=function(e,t,i){return void 0===i&&(i=this.scaleFactor),e/(t<.001?e:t)*i},t.getScaleByMapTiling=function(){var e=this.mapTiling;return[this.scale.x*e.x*2,this.scale.y*e.y*2,this.scale.z*e.x*2]},t.destroy=function(){var e,t,i;n.prototype.destroy.call(this),null==this||null==(e=this.entity)||e.destroy(),rm.off("edk:render:uvmapping:update:model",this.updateData,this),this.needReset=!1,this.scale=null,(this.camera=null)==(t=this.entity)||null==(i=t.model)||i.model.destroy(),this.entity.destroy(),this.entity=null,this.recordRotation=null,this.mappingScale=null,this.centerPos=null,this.relativePos=null,this.mapTiling=null,this.defaultTiling=null,this.defaultRotation=null,this.defaultTranslation=null,this.uvmapping=null,this.root=null,this.meshInstance=null,this.layerIDs=null,this.material=null,this.mapField=null,this.parent=null,this.enabled=!1,this.aabbA=null,this.aabbB=null},e}(function(){function e(e){this.seleted=!1,this.startPosition=new de,this.currPosition=new de,this.transPosition=new de,this.startRotation=new fe,this.currRotation=new fe,this.transRotation=new fe,this.startScale=new de,this.currScale=new de,this.transScale=new de,rm.on("edk:script:gizmo:translate:start:uvmapping",this.onTranslateStart,this),rm.on("edk:script:gizmo:translate:set:uvmapping",this.onTranslate,this),rm.on("edk:script:gizmo:translate:end:uvmapping",this.onTranslateEnd,this),rm.on("edk:script:gizmo:rotate:start:uvmapping",this.onRotateStart,this),rm.on("edk:script:gizmo:rotate:set:uvmapping",this.onRotate,this),rm.on("edk:script:gizmo:rotate:end:uvmapping",this.onRotateEnd,this),rm.on("edk:script:gizmo:scale:end:uvmapping",this.onScaleEnd,this),rm.on("edk:script:gizmo:scale:set:uvmapping",this.onScale,this),rm.on("edk:script:gizmo:scale:start:uvmapping",this.onScaleStart,this)}var t=e.prototype;return t.requestUpdate=function(e,t,i){void 0===i&&(i={action:"complete"});var n=i.action,a=void 0===n?"complete":n;rm.fire("edk:render:uvmapping:data:"+a,e,t,i)},t.onTranslateStart=function(){this.entity&&this.startPosition.copy(this.entity.getPosition())},t.onTranslate=function(e){var t;this.entity&&((t=this.transPosition).set.apply(t,e),this.currPosition.add2(this.startPosition,this.transPosition),this.setPosition(this.currPosition),this.requestUpdate("mapTranslation",[this.currPosition.x-(this.centerPos.x-this.relativePos.x),this.currPosition.y-(this.centerPos.y-this.relativePos.y),this.currPosition.z-(this.centerPos.z-this.relativePos.z)],{action:"change",domain:"studio"}))},t.onTranslateEnd=function(){if(this.entity){var e=this.entity.getPosition();this.setPosition(e);var t=[e.x-(this.centerPos.x-this.relativePos.x),e.y-(this.centerPos.y-this.relativePos.y),e.z-(this.centerPos.z-this.relativePos.z)];this.requestUpdate("mapTranslation",t,{action:"complete",domain:"studio"})}},t.onRotateStart=function(){if(this.entity){var e=this.material[this.mapField+"MappingRotation"];this.startRotation.setFromEulerAngles(e.x,-e.z,e.y)}},t.calRotation=function(e){return[e.x,e.y,e.z]},t.onRotate=function(e){var t;this.entity&&((t=this.transRotation).set.apply(t,e),this.currRotation.copy(this.transRotation).mul(this.startRotation),this.entity.setRotation(this.currRotation),this.requestUpdate("mapRotation",this.calRotation(this.entity.getEulerAngles()),{action:"change",domain:"studio"}))},t.onRotateEnd=function(){this.entity&&this.requestUpdate("mapRotation",this.calRotation(this.entity.getEulerAngles()),{action:"complete",domain:"studio"})},t.onScaleStart=function(){this.entity&&this.startScale.copy(de.ONE)},t.onScale=function(e){if(this.entity){var t,i;(t=this.transScale).set.apply(t,e),this.currScale.add2(this.startScale,this.transScale);var n=[this.currScale.x*this.scale.x,this.currScale.y*this.scale.y,this.currScale.z*this.scale.z],a=this.getWorldVec(n);(i=this.entity).setLocalScale.apply(i,a),this.requestUpdate("mapScale",n,{action:"change",domain:"studio"})}},t.onScaleEnd=function(){if(this.entity){var e=[this.currScale.x*this.scale.x,this.currScale.y*this.scale.y,this.currScale.z*this.scale.z],t=this.getWorldVec(e);this.setScale.apply(this,t),this.requestUpdate("mapScale",e,{action:"complete",domain:"studio"})}},t.getWorldVec=function(e){e instanceof de&&(e=[e.x,e.y,e.z]);var t=this.entity.getEulerAngles(),i=(new fe).setFromEulerAngles(t.x,t.y,t.z).invert().transformVector(z(de,e));return[i.x,i.y,i.z]},t.destroy=function(){rm.off("edk:script:gizmo:translate:start:uvmapping",this.onTranslateStart,this),rm.off("edk:script:gizmo:translate:set:uvmapping",this.onTranslate,this),rm.off("edk:script:gizmo:translate:end:uvmapping",this.onTranslateEnd,this),rm.off("edk:script:gizmo:rotate:start:uvmapping",this.onRotateStart,this),rm.off("edk:script:gizmo:rotate:set:uvmapping",this.onRotate,this),rm.off("edk:script:gizmo:rotate:end:uvmapping",this.onRotateEnd,this),rm.off("edk:script:gizmo:scale:end:uvmapping",this.onScaleEnd,this),rm.off("edk:script:gizmo:scale:set:uvmapping",this.onScale,this),rm.off("edk:script:gizmo:scale:start:uvmapping",this.onScaleStart,this),this.startPosition=null,this.currPosition=null,this.transPosition=null,this.startRotation=null,this.currRotation=null,this.transRotation=null,this.startScale=null,this.currScale=null,this.transScale=null},e}()),ex=function(i){function e(e){var t;return(t=i.call(this,e)||this).initialize("plane"),t}u(e,i);var t=e.prototype;return t.initPosition=function(){var e=this.material[this.mapField+"MappingTranslation"];e&&(e=new de(e.x,-e.z,e.y-1).add(this.centerPos).sub(this.relativePos)),this.needReset||0===e[0]&&0===e[1]&&0===e[2]?this.updateField("mapTranslation",[this.relativePos.x,this.relativePos.y,this.relativePos.z],{action:"complete"}):this.setPosition(e)},t.initScale=function(e){void 0===e&&(e=this.needReset);var t=this.material[this.mapField+"MappingScale"];if(e||t.toString()===de.ONE.toString()){var i=this.material[this.mapField+"MappingRotation"],n=new de(1,1,1);return n="[0, 0, 90]"===i.toString()?this.getAdaptXScale():"[90, 0, 0]"===i.toString()?this.getAdaptZScale():this.getAdaptYScale(),this.updateField("mapScale",n),n}return this.setScale(t),t},t.getAdaptXScale=function(){var e=this.aabbA.halfExtents,t=this.aabbB.halfExtents,i=[e.y/(t.z<.001?e.y:t.z),e.x/(t.y<.001?e.x:t.y),e.z/(t.z<.001?e.z:t.z)];return this.getScale(i,e,t)},t.onAdaptX=function(){var e=this.getAdaptXScale();this.reset({mapRotation:[0,0,90],mapScale:e})},t.getAdaptYScale=function(){var e=this.aabbA.halfExtents,t=this.aabbB.halfExtents,i=[e.x/(t.x<.001?e.x:t.x),e.y/(t.y<.001?e.y:t.y),e.z/(t.z<.001?e.z:t.z)];return this.getScale(i,e,t)},t.onAdaptY=function(){this.aabbA.halfExtents,this.aabbB.halfExtents;var e=this.getAdaptYScale();this.reset({mapRotation:this.defaultRotation,mapScale:e})},t.getAdaptZScale=function(){var e=this.aabbA.halfExtents,t=this.aabbB.halfExtents,i=[e.x/(t.x<.001?e.x:t.x),e.y/(t.z<.001?e.y:t.z),e.y/(t.z<.001?e.y:t.z)].sort(function(e,t){return t-e});return this.getScale(i,e,t)},t.onAdaptZ=function(){var e=this.getAdaptZScale();this.reset({mapRotation:[-90,0,0],mapScale:e})},t.getScale=function(e,t,i){var n=Math.max.apply(Math,e);return[n,n,n]},e}(Jb),tx=function(i){function e(e){var t;return(t=i.call(this,e)||this).scaleFactor=1,t.initialize("box"),t}u(e,i);var t=e.prototype;return t.initScale=function(e){void 0===e&&(e=this.needReset);var t=this.material[this.mapField+"MappingScale"],i=this.setMaxScale(e);return(e||t.toString()===de.ONE.toString())&&this.updateField("mapScale",i),i},t.onAdaptX=function(){var e=this.setMaxScale(!0);this.reset({mapScale:e})},t.onAdaptY=function(){var e=this.setMaxScale(!0);this.reset({mapScale:e})},t.onAdaptZ=function(){var e=this.setMaxScale(!0);this.reset({mapScale:e})},t.getScaleByMapTiling=function(){var e=this.material[this.mapField+"Tiling"],t=Math.max(e.x,e.y);return[this.scale.x*t,this.scale.y*t,this.scale.z*t]},t.setMaxScale=function(){this.mapTiling;var e=this.aabbA.halfExtents,t=this.aabbB.halfExtents,i=Math.max(this.getScaleComp(e.x,t.x),this.getScaleComp(e.y,t.y),this.getScaleComp(e.z,t.z)),n=new de(i,i,i);return this.setScale(n),n},e}(Jb),ix=function(i){function e(e){var t;return(t=i.call(this,e)||this).scaleFactor=1,t.initialize("sphere"),t}u(e,i);var t=e.prototype;return t.initScale=function(e){void 0===e&&(e=this.needReset);var t=this.setMaxScale(e);return e&&this.updateField("mapScale",t),t},t.onAdaptX=function(){var e=this.setMaxScale(!0);this.reset({mapScale:e})},t.onAdaptY=function(){var e=this.setMaxScale(!0);this.reset({mapScale:e})},t.onAdaptZ=function(){var e=this.setMaxScale(!0);this.reset({mapScale:e})},e}(Jb),nx=function(i){function e(e){var t;return(t=i.call(this,e)||this).scaleFactor=1,t.horizonFactor=1,t.initialize("cylinder"),rm.on("edk:render:uvmapping:cylinder:radius",t.onChangeRadius,g(t)),t}u(e,i);var t=e.prototype;return t.initScale=function(e){void 0===e&&(e=this.needReset);var t=this.material[this.mapField+"MappingScale"];if(this.needReset||t.toString()===de.ONE.toString()){this.aabbA.halfExtents,this.aabbB.halfExtents;var i,n=this.material[this.mapField+"MappingRotation"];return i="[0, 0, 90]"===n.toString()?this.getAdaptXScale():"[90, 0, 0]"===n.toString()?this.getAdaptZScale():this.getAdaptYScale(),this.setScale(i),e&&this.updateField("mapScale",i),i}return this.setScale(t),t},t.getAdaptXScale=function(){var t=this,e=this.aabbA.halfExtents,i=this.aabbB.halfExtents,n=Math.max(e.y/(i.x<.001?e.y:i.x),e.z/(i.z<.001?e.z:i.z))*this.horizonFactor;return[n,e.x/(i.y<.001?e.x:i.y),n].map(function(e){return e*t.scaleFactor})},t.onAdaptX=function(){var e=this.getAdaptXScale();this.reset({mapRotation:[0,0,90],mapScale:e})},t.getAdaptYScale=function(){var t=this,e=this.aabbA.halfExtents,i=this.aabbB.halfExtents,n=Math.max(e.x/(i.x<.001?e.x:i.x),e.z/(i.z<.001?e.z:i.z))*this.horizonFactor;return[n,e.y/(i.y<.001?e.y:i.y),n].map(function(e){return e*t.scaleFactor})},t.onAdaptY=function(){var e=this.getAdaptYScale();this.reset({mapRotation:this.defaultRotation,mapScale:e})},t.getAdaptZScale=function(){var t=this,e=this.aabbA.halfExtents,i=this.aabbB.halfExtents,n=Math.max(e.x/(i.x<.001?e.x:i.x),e.y/(i.z<.001?e.y:i.z))*this.horizonFactor;return[n,e.z/(i.y<.001?e.z:i.y),n].map(function(e){return e*t.scaleFactor})},t.onAdaptZ=function(){var e=this.getAdaptZScale();this.reset({mapRotation:[-90,0,0],mapScale:e})},t.onChangeRadius=function(e){this.setScale.apply(this,e)},t.destroy=function(){i.prototype.destroy.call(this),rm.off("edk:render:uvmapping:cylinder:radius",this.onChangeRadius,this)},e}(Jb),ax="diffuseMap",sx=null,rx=function(){function e(e){this.root=null,this.mapField="",this.selectedMaterial="",this.enabled=!1,this.layerIDs=[],this.pickerEnabled=!1,this.gizmoSuffix=":uvmapping",this.gizmoWorldMode=!0,this.currentGizmo=null,this.currentGizmoType="",this.triangleMat4=new pe,this.triangleQuat=new fe,this.triangleV1=new de,this.triangleV2=new de,this.triangleV3=new de,(sx=this).rotate=new Nb({suffix:this.gizmoSuffix}),this.scale=new Gb({suffix:this.gizmoSuffix}),this.translate=new Wb({suffix:this.gizmoSuffix}),this.entity=new Cr,this.entity.name="UVMapping Gizmo Root",this.entity.addChild(this.rotate.entity),this.entity.addChild(this.scale.entity),this.entity.addChild(this.translate.entity),this.entity.enabled=!0,rm.root.addChild(this.entity),rm.method("edk:render:uvmapping:disable",this.onDisabled,this),rm.method("edk:render:uvmapping:enabled",this.onEnabled,this),rm.method("edk:render:uvmapping:reset",this.onResetModel,this),rm.method("edk:render:uvmapping:picker",this.onSwitchPicker,this),rm.method("edk:render:uvmapping:change:type",this.onChangeType,this),rm.method("edk:render:uvmapping:change:map",this.onChangeMap,this),rm.method("edk:render:uvmapping:change:material",this.onChangeMaterial,this),rm.method("edk:render:uvmapping:adapt",this.onAdapt,this),rm.method("edk:render:uvmapping:change:worldMode",this.onChangeGizmoWorldMode,this),rm.method("edk:render:uvmapping:change:gizmo",this.onChangeGizmoType,this),rm.on("edk:plugin:entity:picker:click",this.onSelectorPickerClick,this),rm.on("edk:plugin:entity:picker:double:click",this.onSelectorPickerDoubleClick,this);var t=y_.getLayer("UVMapping");t&&(this.layerIDs=[t.id])}var t=e.prototype;return t.onSelectorPickerClick=function(e,t,i,n){if(this.enabled)if(t){if(this.pickerEnabled&&null!=n&&n.length){var a,s,r,o=n[0],l=o.point,h=o.normal;this.triangleV1=(new de).cross(de.UP,h),this.triangleV2=(new de).cross(h,this.triangleV1),this.triangleMat4.setLookAt(l,(new de).add2(l,h),this.triangleV2),this.triangleMat4=(new pe).setFromAxisAngle(this.triangleV1,90).mul(this.triangleMat4),this.triangleQuat.setFromMat4(this.triangleMat4),this.clickRecordAngles=this.triangleQuat.getEulerAngles();var c=this.root.getPosition();null==(a=this.assistModel)||a.requestUpdate({mapTranslation:[l.x-c.x,l.y-c.y,l.z-c.z],mapRotation:[this.clickRecordAngles.x,this.clickRecordAngles.y,this.clickRecordAngles.z]},null,{action:"complete"}),null==(s=this.assistModel)||s.entity.setRotation(this.triangleQuat),!this.gizmoWorldMode&&(null==(r=this.currentGizmo)||r.update({rotation:this.clickRecordAngles}))}}else rm.fire("edk:render:uvmapping:destroy:model"),this.pickerEnabled=!1,this.reset()},t.onSelectorPickerDoubleClick=function(e,t,i){if(t){this.mapField=ax;var n=rm.call("edk:scene:entity:get",e,t);if(n&&n.entity&&n.entity.model){var a=n.entity.model.meshInstances[i];a&&(this.meshInstance=a,this.root=n.entity)}}else this.reset()},t.onChangeMaterial=function(e,t){void 0===t&&(t=!1),this.reset(),this.material=e,this.resetAssistModel(t)},t.onEnabled=function(e,t){void 0===t&&(t=ax),this.selectedMaterial=e,this.mapField=t,this.enabled=!0},t.onDisabled=function(){rm.fire("edk:render:uvmapping:destroy:model"),this.pickerEnabled=!1,this.enabled=!1,this.reset()},t.onResetModel=function(){var e;this.assistModel?null==(e=this.assistModel)||e.reset():rm.fire("edk:render:uvmapping:data:complete",{mapTranslation:[0,0,0],mapRotation:[0,0,0],mapScale:[1,1,1],mapTiling:[1,1]})},t.onChangeType=function(e){this.reset(),6!==e&&this.resetAssistModel(!0)},t.onChangeMap=function(e){this.reset(),this.mapField=e,this.resetAssistModel()},t.resetAssistModel=function(e){var t;if(void 0===e&&(e=!1),this.root&&this.material){null!=(t=this.assistModel)&&t.entity&&this.reset();var i={uvmapping:this,root:this.root,meshInstance:this.meshInstance,layerIDs:this.layerIDs,material:this.material,mapField:this.mapField,needReset:e,enabled:this.enabled};switch(this.material[this.mapField+"MappingType"]){case 5:this.assistModel=new ex(i);break;case 2:this.assistModel=new tx(i);break;case 3:this.assistModel=new ix(i);break;case 4:this.assistModel=new nx(i)}this.assistModel&&rm.fire("edk:render:uvmapping:init:model")}},t.onSwitchPicker=function(e){this.pickerEnabled=e},t.reset=function(){this.onChangeGizmoType(""),this.assistModel&&(this.assistModel.destroy(),this.assistModel=null),this.pickerEnabled=!1},t.onAdapt=function(e){var t,i,n;switch(e){case"x":null==(t=this.assistModel)||t.onAdaptX();break;case"y":null==(i=this.assistModel)||i.onAdaptY();break;case"z":null==(n=this.assistModel)||n.onAdaptZ()}},t.onChangeGizmoType=function(t){var i=this;this.assistModel&&(this.currentGizmoType=t,-1!==["scale","rotate","translate"].indexOf(t)?(["scale","rotate","translate"].forEach(function(e){t===e?(i[t].entity.enabled=!0,i.currentGizmo=i[t]):i[e].entity.enabled=!1}),this.updateGizmo()):(this.currentGizmo&&this.currentGizmo.update({enabled:!1}),this.currentGizmo=null))},t.onChangeGizmoWorldMode=function(e){void 0===e&&(e=!0),this.gizmoWorldMode=e,this.updateGizmo()},t.updateGizmo=function(){if(this.currentGizmo){var e=[0,0,0];if(!this.gizmoWorldMode){var t=this.material[this.mapField+"MappingRotation"];t&&(e=[t.x,t.z,t.y])}if(this.assistModel){var i=this.assistModel.entity.getPosition();this.currentGizmo.update({enabled:!0,worldMode:!0,position:[i.x,i.y,i.z],rotation:e})}else this.currentGizmo.update("enabled",!1)}},t.destroy=function(){sx=null,this.root=null,this.mapField="",this.selectedMaterial="",this.enabled=!1,this.layerIDs=[],this.pickerEnabled=!1,this.gizmoSuffix=":uvmapping",this.gizmoWorldMode=!0,this.currentGizmo=null,this.currentGizmoType="",this.rotate.destroy(),this.rotate=null,this.scale.destroy(),this.scale=null,this.translate.destroy(),this.translate=null,this.entity.destroy(),this.entity=null},e}(),ox=null,lx=function(){function e(){ox=this,new Yy,new k_,new Qb,rm.mode===e_&&(new Xb,new rx,rm.method("edk:render:prefilter:cubemap",this.prefilterCubemap,this)),new qb}var t,i=e.prototype;return i.initialize=function(e,t){if(void 0===t&&(t={}),I_&&!I_.cameraReady){var i=function(e){var t=e.entities,i=e.scene;if(t instanceof Array){var n,a=null;if(a=rm.mode===e_?t.find(function(e){return e&&"camera"===e.type&&"editor"===e.extensions.camera_type}):t.find(function(e){return e&&"camera"===e.type&&"orbit"===e.extensions.camera_type}))return a.components||(a.components=[]),i.components&&(a.components=a.components.concat(i.components.filter(function(e){return e.camera}))),a;null!=(n=a)&&n.extensions&&!a.extensions.clearColor&&(a.extensions.clearColor=[.7215686274509804,.7215686274509804,.7215686274509804])}return null}(e);i&&I_.initialize(i,t)}$y&&!$y.skyboxReady&&$y.initialize(e.scene,t)},i.prefilterCubemap=(t=o(__.mark(function e(o){var l=this;return __.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(n,a){for(var s=6,r=new Array(6),e=function(e,i){rm.assets._loader.load(s_(e),"texture",function(e,t){e?a(e):t&&(r[i]=t),0==--s&&function(){var e=new Kt(rm.graphicsDevice,{cubemap:!0,rgbm:!1,fixCubemapSeams:!0,format:r[0].format,width:r[0].width,height:r[0].height});e.addressU=1,e.addressV=1,e._levels[0]=r.map(function(e){return e._levels[0]});var t={device:rm.graphicsDevice,sourceCubemap:e,method:1,samples:4096,cpuSync:!0,filteredFixed:[],filteredFixedRgbm:[],singleFilteredFixedRgbm:!0};Bm(t),n(t.singleFilteredFixedRgbm.getDds())}()})},t=["right","left","top","bottom","front","back"],i=0;i<t.length;i++)o[t[i]]&&(o[t[i]].endsWith("png")?e(l.swapExtension(o[t[i]],".png",".DDS"),i):e(o[t[i]],i))}));case 1:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)}),i.swapExtension=function(e,t,i){for(;0<=e.indexOf(t);)e=e.replace(t,i);return e},i.destroy=function(){I_&&I_.destroy(),$y&&$y.destroy(),jb&&jb.destroy(),Zb&&Zb.destroy(),sx&&sx.destroy()},e}(),hx=function(){function e(e){this.enabled=!1,this.device=e,this.shader=null,this.depthMap=null,this.vertexBuffer=Wm(e),this.needsDepthBuffer=!1;var t={aPosition:Te};this.backgroundShader=new Et(e,{attributes:t,vshader:"\n\t\tattribute vec2 aPosition;\n\t\tvarying vec2 vUv0;\n\t\tvarying vec2 uv;\n\t\n\t\tuniform vec4 clearColor;\n\t\tuniform sampler2D source;\n\t\tuniform vec2 scale;\n\t\n\t\tvoid main() {\n\t\t\tvUv0 = (aPosition.xy + 1.0) * 0.5;\n\t\t\tuv = (1.0 / scale * aPosition.xy + 1.0) * 0.5;\n\t\t\tgl_Position = vec4(aPosition.xy, 0.5, 1.0);\n\t\t}",fshader:"\n\t\tprecision highp float;\n\t\tprecision highp int;\n\t\n\t\tuniform vec4 clearColor;\n\t\tvarying vec2 vUv0;\n\t\tvarying vec2 uv;\n\t\tuniform int wrapMode;\n\t\tuniform int scaleMode;\n\t\tuniform sampler2D source;\n\t\tuniform sampler2D bg;\n\t\n\t\tvoid main(void) {\n\t\t\tif (scaleMode == 4) {\n\t\t\t\tgl_FragColor = texture2D(bg, vUv0);\n\t\t\t} else {\n\t\t\t\tif (uv.x > 1.0 || uv.x < 0.0 || uv.y > 1.0 || uv.y < 0.0) {\n\t\t\t\t\tif (wrapMode == 0) {\n\t\t\t\t\t\tdiscard;\n\t\t\t\t\t} else if (wrapMode == 1) {\n\t\t\t\t\t\tgl_FragColor = clearColor;\n\t\t\t\t\t} else if (wrapMode == 2) {\n\t\t\t\t\t\tgl_FragColor = texture2D(bg, vec2(fract(uv.x), fract(uv.y)));\n\t\t\t\t\t} else if (wrapMode == 3) {\n\t\t\t\t\t\tgl_FragColor = texture2D(bg, uv);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tgl_FragColor = texture2D(bg, uv);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t"}),this.scaleMode=0,this.wrapMode=0,this.renderTarget=null}var t=e.prototype;return t.setRenderTarget=function(e){void 0===e&&(e=null),this.renderTarget=e},t.onEnable=function(){this.enabled=!0},t.onDisable=function(){this.enabled=!1},t.render=function(e){void 0===e&&(e={});var t=e,i=t.canvasWidth,n=void 0===i?this.device.width:i,a=t.canvasHeight,s=void 0===a?this.device.height:a;if(this.camera=rm.scene._activeCamera,this.enabled&&this.image&&this.camera){this.scene=rm.scene,this.device=rm.graphicsDevice;var r=this.device.scope,o=this.image.width,l=this.image.height,h=n/s,c=o/l,u=1,d=1;switch(this.scaleMode||0){case 0:1<(d=c/h)&&(u=1/d,d=1);break;case 1:(d=c/h)<1&&(u=1/d,d=1);break;case 3:d=c/h;break;case 4:u=h/c;break;case 5:1<(d=c/h)&&(u=1/d,d=1);var p=n/o,f=s/l,m=Math.min(p,f);d/=m,u/=m}r.resolve("scale").setValue(new Float32Array([d,u])),r.resolve("wrapMode").setValue(this.wrapMode||0),r.resolve("scaleMode").setValue(this.scaleMode||0),r.resolve("bg").setValue(this.image),r.resolve("clearColor").setValue([this.camera.clearColor.r,this.camera.clearColor.g,this.camera.clearColor.b,this.camera.clearColor.a]),Hm(this.device,this.renderTarget,this.vertexBuffer,this.backgroundShader)}},t.loadBackgroundImage=function(e,t){var n=this;e&&rm.loader.load(s_(e),"texture",function(e,t,i){e||(n.image=t)})},e}();Lg();var cx=new Eg,ux=function(e){rm&&rm.fire("edk:app:window:mouse:out",e)};return Lg([function(){function e(e,t){var i,n,a=this;void 0===t&&(t={}),this.canvas=null,this.setting={mode:"viewer",inputSettings:{useMouse:!0,useTouch:!0,useKeyboard:!0,useGamepads:!1},assetPrefix:"",dracoDecoderConfig:{},requestThrottle:!0,requestMaximum:10,disableContextMenu:!0,preferWebGl2:!0,showGrid:!1},i=t,n=this.setting,i.keyboard&&(n.inputSettings.useKeyboard=!0,delete i.keyboard),i.mouse&&(n.inputSettings.useMouse=!0,delete i.mouse),i.touch&&(n.inputSettings.useTouch=!0,delete i.touch),i.elementInput&&(n.inputSettings.useMouse=!0,n.inputSettings.useTouch=!0,delete i.elementInput),i.prefix&&(n.assetPrefix=i.prefix),t instanceof Object&&(this.setting=Object.assign({},this.setting,t)),this.setting.protocol&&(q.protocol=this.setting.protocol),this.canvas=e;var s=h({},{elementInput:new xg(e,{useMouse:this.setting.inputSettings.useMouse,useTouch:this.setting.inputSettings.useTouch}),keyboard:this.setting.inputSettings.useKeyboard?new Gv(m):null,mouse:this.setting.inputSettings.useMouse?new qv(e):null,gamepads:this.setting.inputSettings.useGamepads?new wg:null,touch:this.setting.inputSettings.useTouch&&w?new Tg(e):null},{graphicsDeviceOptions:{alpha:!0,antialias:!0,preserveDrawingBuffer:!0,preferWebGl2:this.setting.preferWebGl2},assetPrefix:this.setting.assetPrefix});new om(this.canvas,s),rm.graphicsDevice.maxPixelRatio=window.devicePixelRatio||1,rm.setCanvasResolution(hh),rm.setCanvasFillMode(oh),rm.loader.getHandler("texture").crossOrigin="anonymous",rm.mode=this.setting.mode||"viewer",Object.assign(xe.prototype,{intersectTriangle:(new de,new de,new de,new de,new de,new de,new de,function(e,t,i,n,a){d_.sub2(t,e),p_.sub2(i,e),f_.cross(d_,p_);var s,r=this.direction.dot(f_);if(0<r){if(n)return null;s=1}else{if(!(r<0))return null;s=-1,r=-r}u_.sub2(this.origin,e);var o=s*this.direction.dot(p_.cross(u_,p_));if(o<0)return null;var l=s*this.direction.dot((new de).cross(d_,u_));if(l<0)return null;if(r<o+l)return null;var h=-s*u_.dot(f_);return h<0?null:(new de).copy(this.direction).mulScalar(h/r).add(this.origin)})}),Object.assign(Mn.prototype,{intersectsRay:function(){var T=new xe,x=new de,A=new ue,E=[new de,new de,new de],M=new de,S=new de,w=new de,C=new de,R=new pe,D=new pe,P=new de,I=new de;function k(e,t,i,n,a,s,r){var o,l=1===e.material.cull||3===e.material.cull;if(null===(o=e.skinInstance?i.intersectTriangle(n,a,s,l,r):T.intersectTriangle(n,a,s,l,r)))return null;M.sub2(a,n),S.sub2(s,n),C.cross(M,S).normalize(),P.copy(o),I.copy(o);var h=1,c=1;if(e.skinInstance){R.transformPoint(P,P),w.sub2(I,n);var u=new de,d=Math.acos(u.copy(w).normalize().dot(M.clone().normalize())),p=new de,f=Math.acos(p.copy(w).normalize().dot(S.clone().normalize())),m=Math.PI-d-f,v=Math.sin(d),g=Math.sin(f),_=Math.sin(m),y=w.length()*g/_,b=w.length()*v/_;h=y/M.length(),c=b/S.length()}else D.transformPoint(I,I),D.transformPoint(n,n),D.transformPoint(a,a),D.transformPoint(s,s),D.transformVector(C,C);return x.sub2(I,i.origin),{index:t,distance:x.length(),point:I.clone(),localPoint:P.clone(),direction:i.direction.clone(),normal:C.clone(),vertices:[n.clone(),a.clone(),s.clone()],edgeScales:[h,c],meshInstance:e}}return function(e,t){if(A.copy(this.aabb),!1===A.intersectsRay(e))return[];var i,n,a,s,r=this.mesh.vertexBuffer,o=this.mesh.indexBuffer[0],l=this.mesh.primitive[0].base,h=this.mesh.primitive[0].count,c=new Float32Array(r.storage),u=new Uint8Array(r.storage),d=2===o.bytesPerIndex?new Uint16Array(o.lock()):new Uint32Array(o.lock()),p=r.format.elements,f=r.format.size,m=0,v=0,g=0,_=null;for(i=0;i<p.length;i++)p[i].name===Te?m=p[i].offset:p[i].name===De?v=p[i].offset:p[i].name===Re&&(g=p[i].offset);var y=m/4,b=g/4,x=f/4;if(T.origin.copy(e.origin),T.direction.copy(e.direction),D.copy(this.node.getWorldTransform()),R.copy(D).invert(),R.transformPoint(T.origin,T.origin),R.transformVector(T.direction,T.direction),this.skinInstance){var M=[0,0,0,0],S=[0,0,0,0],w=this.skinInstance.matrices,C=[new de,new de,new de,new de];for(i=l;i<l+h;i+=3){for(n=0;n<3;n++){var P=0;for(s=d[i+n],a=0;a<4;a++)M[a]=u[s*f+v+a],S[a]=c[s*x+y+b+a],P+=S[a];for(s=s*x+y,E[n].set(c[s],c[s+1],c[s+2]),a=0;a<4;a++)w[M[a]].transformPoint(E[n],C[a]),C[a].mulScalar(S[a]/P);E[n].copy(C[0]).add(C[1]).add(C[2]).add(C[3]),D.transformPoint(E[n],E[n])}(_=k(this,i,e,E[0],E[1],E[2]))&&t.push(_)}}else for(i=l;i<l+h;i+=3){for(n=0;n<3;n++)s=d[i+n]*x+y,E[n].set(c[s],c[s+1],c[s+2]);(_=k(this,i,e,E[0],E[1],E[2]))&&t.push(_)}return o.unlock(),0<t.length?t:null}}()}),Object.assign(lu.prototype,{raycastMeshInstances:function(e,t){var i=0,n=[];if(t instanceof Array)for(i=0;i<t.length;i++)t[i].intersectsRay(e,n);else t instanceof Mn&&t.intersectsRay(e,n);return 0===n.length?null:n.sort(function(e,t){return e.distance-t.distance})}}),Object.assign(ue.prototype,{toJSON:function(){return{center:[this.center.x,this.center.y,this.center.z],halfExtents:[this.halfExtents.x,this.halfExtents.y,this.halfExtents.z]}}}),function(){rm.scene.defaultMaterial.useMatCap=!1,rm.scene.defaultMaterial.cubeMapProjectionBox=new ue(new de(0,0,0),new de(.5,.5,.5));var e={toJSON:function(){var a=e.call(rm.scene.defaultMaterial);function e(e){var t=this,n={};return void 0===e&&(e={}),m_.forEach(function(e){void 0!==t[e]&&null!==t[e]&&("texture"===Wi[e]&&void 0===v_[e]?null!==t[e]&&t[e].id?n[e]=t[e].id:n[e]=null:"vec2"===Wi[e]?n[e]=[t[e].x,t[e].y]:"vec3"===Wi[e]?n[e]=[t[e].x,t[e].y,t[e].z]:"rgb"===Wi[e]?n[e]=[t[e].r,t[e].g,t[e].b,t[e].a]:n[e]="boundingbox"===g_[e]?t[e]?t[e].toJSON():null:t[e],(v_[e]||g_[e])&&delete n[e])}),e.diff&&m_.forEach(function(e){var t=a[e],i=n[e];"vec2"!==Wi[e]&&"rgb"!==Wi[e]||(t=t.toString(),i=i.toString()),"boundingbox"===g_[e]&&(t=JSON.stringify(t),i=JSON.stringify(i)),t===i&&delete n[e]}),delete n.validated,n}return e}()};Object.assign(vv.prototype,e),Object.assign(gm.prototype,e)}(),Object.assign(nu.prototype,{_createOffscreenTarget:function(e,t){var i=this.camera.rect,n=Math.floor(i.z*this.app.graphicsDevice.width*this.renderTargetScale),a=Math.floor(i.w*this.app.graphicsDevice.height*this.renderTargetScale),s=this.app.graphicsDevice,r=t?s.getHdrFormat():7,o=new Kt(s,{format:r,width:n,height:a,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"posteffect-color"});if(!e)return new Fm(this.app.graphicsDevice,o,{autoResolve:!0});var l=new Kt(s,{format:Pe,width:n,height:a,minFilter:0,magFilter:0,addressU:0,addressV:0,name:"posteffect-depth"});return new Fm({colorBuffer:o,depthBuffer:l,autoResolve:!0,samples:4})},_resizeOffscreenTarget:function(e){var t=this.app.graphicsDevice,i=this.camera.rect,n=Math.floor(i.z*t.width*this.renderTargetScale),a=Math.floor(i.w*t.height*this.renderTargetScale);if(e._colorBuffer){var s=e._colorBuffer.format;e._colorBuffer.destroy(),e._colorBuffer=new Kt(t,{format:s,width:n,height:a,name:"posteffect-color",minFilter:0,magFilter:0,addressU:1,addressV:1})}if(e._depthBuffer){var r=e._depthBuffer.format;e._depthBuffer.destroy(),e._depthBuffer=new Kt(t,{format:r,width:n,height:a,minFilter:0,magFilter:0,addressU:0,addressV:0,name:"posteffect-depth"})}e.destroy()}}),this.events={on:rm.on.bind(rm),off:rm.off.bind(rm),fire:rm.fire.bind(rm),once:rm.once.bind(rm),hasEvent:rm.hasEvent.bind(rm),method:rm.method.bind(rm),call:rm.call.bind(rm)},rm.method("edk:app",function(){return a},this),rm.method("edk:app:resize",this.resize,this),rm.method("edk:app:get:setting",this.getSetting,this),new H_,new b_,new Fb(t.scripts),new lx,new qy,new Bb,rm.start(),this.initFontAsset(),rm.graphicsDevice.canvas.oncontextmenu=function(e){e.preventDefault()},window.addEventListener("resize",this.resize,!1),window.addEventListener("orientationchange",this.resize,!1),window.addEventListener("mouseout",ux,!1),rm.backgroundRenderer=new hx(rm.graphicsDevice)}var t=e.prototype;return t.loadData=function(e,t){var i=this;void 0===t&&(t={});var a,n="";"object"==(void 0===e?"undefined":dx(e))&&void 0!==dx(e.scene)&&e.resources instanceof Array&&e.entities instanceof Array&&e.events instanceof Array?n="scene":"object"==(void 0===e?"undefined":dx(e))&&void 0!==e.config&&void 0!==e.version?n="model":"string"==typeof e&&e.endsWith("rbs")?n="rbs":e instanceof ArrayBuffer&&(n=n_),window.DracoDecoderModule?this.initialize(n,e,t):(a=this.setting.dracoDecoderConfig,new Promise(function(t,i){"object"!=("undefined"==typeof WebAssembly?"undefined":dx(WebAssembly))?a.decoderFilePath?l_(a.decoderFilePath).then(function(){h_().then(function(){t()}).catch(function(){i()})}).catch(function(){i()}):i():a.wasmWrapperFilePath?l_(a.wasmWrapperFilePath).then(function(){var n;(n=a,new Promise(function(e,t){var i=new XMLHttpRequest;i.open("GET",n.wasmFilePath,!0),i.responseType="arraybuffer",i.onload=function(){e(i.response)},i.onerror=function(){t()},i.send(null)})).then(function(e){o_.wasmBinary=e,h_().then(function(){t()}).catch(function(){i()})}).catch(function(){})}).catch(function(){i()}):i()})).then(function(){i.initialize(n,e,t)}).catch(function(){})},t.initialize=function(e,t,n){try{if(Xy&&ox)if("rbs"===e)q.get(t,{retry:!1,maxRetries:0,responseType:X.ResponseType.ARRAY_BUFFER},function(e,t){if(!e){var i=a_(t,kg.k);n.dataProcessingHook&&"function"==typeof n.dataProcessingHook&&(i=n.dataProcessingHook(i)),i?(ox.initialize(i,n),Xy.loadSceneData(i,n)):cx.log("数据解析失败")}});else if(e===n_){var i=a_(t,kg.k);n.dataProcessingHook&&"function"==typeof n.dataProcessingHook&&(i=n.dataProcessingHook(i)),i?(ox.initialize(i,n),Xy.loadSceneData(i,n)):cx.log("数据解析失败")}}catch(e){}},t.removeData=function(e){Xy.removeSceneData(e)},t.getSetting=function(e){return this.setting[e]},t.setSetting=function(e,t){return this.setting[e]=t},t.initFontAsset=function(){this.fontAsset=new Kr("font_msyh_asset","font",{url:rm.assets.prefix?"realibox/font/asset/msyh.png":s_("//asset.realibox.com/realibox/font/asset/msyh.png")},Og),this.fontAsset.ready(function(e){rm.fire("edk:app:font:asset",e)}),rm.assets.add(this.fontAsset),rm.assets.load(this.fontAsset)},t.resize=function(){rm.resizeCanvas(rm.graphicsDevice.canvas.width,rm.graphicsDevice.canvas.height),rm.graphicsDevice.canvas.style.width="",rm.graphicsDevice.canvas.style.height=""},t.destroy=function(e){rm&&rm.destroy(),y_&&y_.destroy(),W_&&W_.destroy(),zb&&zb.destroy(),ox&&ox.destroy(),Xy&&Xy.destroy(),this.fontAsset=null,window.removeEventListener("resize",this.resize,!1),window.removeEventListener("orientationchange",this.resize,!1),window.removeEventListener("mouseout",ux,!1),e&&e()},e}()])},"object"==dx(t)&&void 0!==e?e.exports=s():void 0===(a="function"==typeof(n=s)?n.call(t,i,t,e):n)||(e.exports=a)},NjnD:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r,o,l,h=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),c=i("2vnA"),u=p(i("+P3/")),d=p(i("IgRy"));function p(e){return e&&e.__esModule?e:{default:e}}function f(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function m(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var v=(n=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),f(this,"provinceName",a,this),f(this,"provinceId",s,this),f(this,"cityId",r,this),f(this,"provinceArr",o,this),f(this,"province",l,this),this.store=$$.events.call("store")}return h(t,[{key:"onProvinceChange",value:function(e){this.provinceId=e}},{key:"onCityChange",value:function(e){this.cityId=e}},{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}},{key:"cityArr",get:function(){return 0<this.provinceId?d.default[this.provinceId]:[]}},{key:"selectCity",get:function(){var t=this,e=this.cityArr.filter(function(e){return e.id===t.cityId});return 0<e.length?e[0]:{}}}]),t}(),a=m(n.prototype,"provinceName",[c.observable],{enumerable:!0,initializer:function(){return null}}),s=m(n.prototype,"provinceId",[c.observable],{enumerable:!0,initializer:function(){return null}}),r=m(n.prototype,"cityId",[c.observable],{enumerable:!0,initializer:function(){return null}}),o=m(n.prototype,"provinceArr",[c.observable],{enumerable:!0,initializer:function(){return u.default}}),m(n.prototype,"cityArr",[c.computed],Object.getOwnPropertyDescriptor(n.prototype,"cityArr"),n.prototype),m(n.prototype,"selectCity",[c.computed],Object.getOwnPropertyDescriptor(n.prototype,"selectCity"),n.prototype),m(n.prototype,"onProvinceChange",[c.action],Object.getOwnPropertyDescriptor(n.prototype,"onProvinceChange"),n.prototype),l=m(n.prototype,"province",[c.observable],{enumerable:!0,initializer:function(){return null}}),m(n.prototype,"update",[c.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),n);t.default=v;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(v,"CircleMenu","D:/shun/gs3power/src/stores/regions.js")},P4xH:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r,o=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),l=i("2vnA");function h(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function c(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var u=(n=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),h(this,"galleryVisible",a,this),h(this,"galleryNum",s,this),h(this,"golleryList",r,this),this.store=$$.events.call("store")}return o(t,[{key:"updateGalleryList",value:function(e){if(this.store.menu.currentVersion===$$.SEM.Version_CrossStar){for(var t=[],i=1;i<=this.galleryNum;i++)t.splice(i-1,1,{src:$$.asset("images/gallery/"+e+"/c"+i+".jpg")+"?t="+(new Date).getTime()});this.golleryList=t}else{for(var n=[],a=1;a<=this.galleryNum;a++)n.splice(a-1,1,{src:$$.asset("images/gallery/"+e+"/s"+a+".jpg")+"?t="+(new Date).getTime()});this.golleryList=n}}},{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}}]),t}(),a=c(n.prototype,"galleryVisible",[l.observable],{enumerable:!0,initializer:function(){return!1}}),s=c(n.prototype,"galleryNum",[l.observable],{enumerable:!0,initializer:function(){return 10}}),r=c(n.prototype,"golleryList",[l.observable],{enumerable:!0,initializer:function(){return[]}}),c(n.prototype,"updateGalleryList",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"updateGalleryList"),n.prototype),c(n.prototype,"update",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),n);t.default=u;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(u,"Gallery","D:/shun/gs3power/src/stores/common/gallery.js")},Pq7S:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),o=i("2vnA");function l(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function h(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var c=(n=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),l(this,"content",a,this),l(this,"show",s,this),this.store=$$.events.call("store")}return r(t,[{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}}]),t}(),a=h(n.prototype,"content",[o.observable],{enumerable:!0,initializer:function(){return""}}),s=h(n.prototype,"show",[o.observable],{enumerable:!0,initializer:function(){return!1}}),h(n.prototype,"update",[o.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),n);t.default=c;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(c,"Message","D:/shun/gs3power/src/stores/common/message.js")},TGrZ:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),o=i("2vnA");function l(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function h(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var c=(n=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,"config",a,this),l(this,"current_id",s,this),this.store=$$.events.call("store")}return r(e,[{key:"onCheckoutVersion",value:function(e){if(this.current_id!==e){var t=this.current_id;this.current_id=e,$$.events.fire("store:version:checkout",e,t),this.store.runInteraction(e)}}},{key:"current",get:function(){var t=this;return this.config.find(function(e){return e.id===t.current_id})}}]),e}(),a=h(n.prototype,"config",[o.observable],{enumerable:!0,initializer:function(){return[{id:$$.SEM.Version.V1,name:"自动劲智版"},{id:$$.SEM.Version.V2,name:"270T自动劲享"},{id:$$.SEM.Version.V3,name:"235T手动劲酷"},{id:$$.SEM.Version.V4,name:"270T自动劲爽版"}]}}),s=h(n.prototype,"current_id",[o.observable],{enumerable:!0,initializer:function(){return $$.SEM.Version.V1}}),h(n.prototype,"current",[o.computed],Object.getOwnPropertyDescriptor(n.prototype,"current"),n.prototype),h(n.prototype,"onCheckoutVersion",[o.action],Object.getOwnPropertyDescriptor(n.prototype,"onCheckoutVersion"),n.prototype),n);t.default=c;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(c,"Version","D:/shun/gs3power/src/stores/version.js")},"TcX+":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r,o,l,h,c=f(i("QpBz")),u=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();i("tL+A");var d=i("2vnA"),p=f(i("Yixb"));f(i("5aor"));function f(e){return e&&e.__esModule?e:{default:e}}function m(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function v(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var g=(n=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),m(this,"showLottery",a,this),m(this,"name",s,this),m(this,"email",r,this),m(this,"message",o,this),m(this,"modalShow",l,this),m(this,"loading",h,this),this.store=$$.events.call("store"),c.default.config({duration:2,maxCount:1})}return u(t,[{key:"postMessage",value:function(){var n=this;return new Promise(function(t,i){if(n.loading=!0,!n.name)return c.default.info("请输入昵称"),void i("请输入昵称");if(!n.store.regions.selectCity.province||!n.store.regions.selectCity.province)return c.default.info("请选择地址信息"),void i("请选择地址信息");return/^[1][3,4,5,6,7,8,9][0-9]{9}$/.test(n.email)?n.message?void p.default.post("//xxx.com",{username:n.name,content:n.message,email:n.email,province:n.store.regions.selectCity.province,city:n.store.regions.selectCity.name,like_num:Math.floor(10*Math.random())}).then(function(e){c.default.success("留言成功"),n.name=null,n.email=null,n.message="",n.showLottery=!0,t()}).catch(function(e){c.default.info("留言失败"),i(e)}):(c.default.info("请输入留言内容"),void i("请输入留言内容")):(c.default.info("请输入正确的手机号"),void i("请输入正确的手机号"))})}},{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}},{key:"messageLength",get:function(){return 0<this.message.length?this.message.length:0}}]),t}(),a=v(n.prototype,"showLottery",[d.observable],{enumerable:!0,initializer:function(){return!1}}),s=v(n.prototype,"name",[d.observable],{enumerable:!0,initializer:function(){return null}}),r=v(n.prototype,"email",[d.observable],{enumerable:!0,initializer:function(){return null}}),o=v(n.prototype,"message",[d.observable],{enumerable:!0,initializer:function(){return""}}),l=v(n.prototype,"modalShow",[d.observable],{enumerable:!0,initializer:function(){return!1}}),h=v(n.prototype,"loading",[d.observable],{enumerable:!0,initializer:function(){return!1}}),v(n.prototype,"messageLength",[d.computed],Object.getOwnPropertyDescriptor(n.prototype,"messageLength"),n.prototype),v(n.prototype,"postMessage",[d.action],Object.getOwnPropertyDescriptor(n.prototype,"postMessage"),n.prototype),v(n.prototype,"update",[d.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),n);t.default=g;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(g,"Message","D:/shun/gs3power/src/stores/message.js")},VkRT:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={apiHost:"",publicPath:"/trumpchi_gs3_power/",assetPath:"/trumpchi_gs3_power/assets/",pcUid:"e7d43d0c7faa068e60b24886625070646de57ca5",mobileUid:"cf233bd11167db7b71b9fe820cb3b1bba3261bf6",data:"local",appDownloadUrl:"//gsp.gacmotor.com/h5/html/appdownload/appdownload.html"};t.default=n;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(n,"default","D:/shun/gs3power/src/core/config/config.js")},Yixb:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(i("vDqi")),a=r(i("VkRT")),s=r(i("scdK"));function r(e){return e&&e.__esModule?e:{default:e}}var o=n.default.create({baseURL:""+a.default.apiHost,transformResponse:[function(e){return e=/<\?xml/.test(e)?s.default.xmlToJson(e):JSON.parse(e)}]});o.rawAxios=n.default,o.interceptors.response.use(function(e){return void 0===e.data.code||void 0===e.data.message?e.data:e.data.code<0?Promise.reject(e.data):0<e.data.code?e.data:void 0},function(e){return Promise.reject(e)});var l=o;t.default=l;"undefined"!=typeof __REACT_HOT_LOADER__&&(__REACT_HOT_LOADER__.register(o,"axiosIns","D:/shun/gs3power/src/core/axios.js"),__REACT_HOT_LOADER__.register(l,"default","D:/shun/gs3power/src/core/axios.js"))},aCKS:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r,o,l=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),h=i("2vnA");function c(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function u(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var d=(n=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),c(this,"selling_point_list",a,this),c(this,"selling_point_uuid",s,this),c(this,"display_selling_point",r,this),c(this,"animation_list",o,this),this.annotation_data={},this.store=$$.events.call("store"),$$.events.on("store:app",this.initAppEventListener.bind(this))}return l(e,[{key:"selling_point_data",get:function(){var t={};return this.selling_point_list.forEach(function(e){t[e.entity]||(t[e.entity]=e)}),t}},{key:"current_selling_point",get:function(){return this.selling_point_uuid?this.selling_point_data[this.selling_point_uuid]:{}}},{key:"animation_data",get:function(){var i={};return this.animation_list.forEach(function(e,t){i[e.entity]||(e.index=t,i[e.entity]=e)}),i}}]),l(e,[{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}},{key:"initAppEventListener",value:function(e){this.app=e,this.app.events.on("edk:entity:create",this.onCreate.bind(this))}},{key:"onCreate",value:function(e,t){e&&e.extensions&&"annotation"===e.type&&(this.annotation_data[e.uuid]||(this.annotation_data[e.uuid]=e))}},{key:"onAnnotationClick",value:function(e,t){var i=this;if(this.selling_point_data[e]&&!this.display_selling_point&&(this.selling_point_uuid=e,this.display_selling_point=!0,this.annotation_data[e]&&this.annotation_data[e].extensions&&this.annotation_data[e].extensions.timelines&&this.annotation_data[e].extensions.timelines.length&&this.annotation_data[e].extensions.timelines.forEach(function(e){i.store.runInteraction(e)}),this.selling_point_data[e].show&&this.store.runInteraction(this.selling_point_data[e].show)),this.animation_data[e]&&(this.animation_data[e].active?(this.onSwitchAnimation(this.animation_data[e].index,!1),this.store.runInteraction(this.animation_data[e].close)):(this.onSwitchAnimation(this.animation_data[e].index,!0),this.store.runInteraction(this.animation_data[e].open))),e===this.backseatAnnotation)switch(this.backseatStep){case 0:this.backseatStep=1,this.store.runInteraction("1326629b-3f68-4b2a-bf79-89432247dbcf");break;case 1:this.backseatStep=2,this.store.runInteraction("67b9c52c-0467-4b63-977d-975cd70065d5");break;case 2:this.backseatStep=0,this.store.runInteraction("e55a0733-6ce7-420d-8a03-cceebf7e0206")}}},{key:"onSellPointClose",value:function(){this.display_selling_point=!1,this.current_selling_point.close&&(this.store.stopInteraction(),this.store.runInteraction($$.SEM.DefaultCamera)),this.current_selling_point.hide&&this.store.runInteraction(this.current_selling_point.hide)}},{key:"onSwitchAnimation",value:function(e,t){this.animation_list[e]&&(this.animation_list[e].active=t)}},{key:"onCloseAllAnimation",value:function(){var i=this;this.animation_list.forEach(function(e,t){e.active&&(i.onSwitchAnimation(t,!1),i.store.runInteraction(e.close))})}},{key:"onOpenAllAnimation",value:function(){var i=this;this.animation_list.forEach(function(e,t){e.backseat&&(i.onSwitchAnimation(t,!0),i.store.runInteraction(e.open))})}},{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}}]),e}(),a=u(n.prototype,"selling_point_list",[h.observable],{enumerable:!0,initializer:function(){return[{name:"舒适精致的座舱造型",desc:"座舱内饰整体造型尽显舒展、科技与运动感。中控台上下分层式设计，营造跃级空间感；无帽檐式家族化双连屏， 匹配10.25英寸中控大屏并内置传祺A DiGO， 科技体验得以大幅提升。",img:$$.asset("images/sellpoint/interior1.jpg"),entity:"68c6076c-3c0d-41bf-8917-1bc5bf358c6e",close:!1,mp3:$$.asset("audio/interior1.mp3")},{name:"ADiGO智能物联系统",desc:"智能全程语音交互\n            1、非全时免唤醒，呼叫小祺一次就够，反馈监听并行同步，中间最长可90s间断，无需重新唤醒\n            2、跨场景上下文交互(18种跨越式的场景语音交互)，支持连续对话，支持高噪环境下识别\n            3、主副驾智能分区识别，听声辨别锁定服务对象；方言口音识别， 解决人机交互障碍\n            \n            智趣丰富车载娱乐\n            1、智能听歌识曲，车载音乐与QQ音乐合作，在线和本地音乐题心听；车载电台与喜马拉雅合作，用户规模庞大，有声资源更丰富；车载唱吧60万首伴奏曲库，帮助用户变身唱歌高手\n            2、搭载车载小程序，包括美食查询/预定/订单管理、电影院查询/预定/订单管理、周边服务-酒店/停车场/加油站查询、违章查询等，全程音控制\n            3、丰富的免费音乐、电台、听书、新闻等， 尽在应用商店， 支持OTA在线升级\n            \n            智慧便利无忧出行\n            1、高德车载地图最新4.0版，根据路况变化智能算路，实现分钟级推荐用户最佳路线\n            2、多端互联，满足更多出行场景需求(多车组队，手机车机互联，收发路线)\n            3、高德讯飞深度合作，全局语音操控，依托多信源动态数据躲游拥堵，高效出行\n            \n            T-BOX传祺智能安防远程控制系统\n            1、远程启动发动机、车况查询、诊断车辆故障、开启空调、门锁、鸣笛、闪灯、前排座椅加热，为生活带来更多的舒适和便利\n            2、智能安防功能，车辆定位、车辆异动自动报警、车辆异常信息自动上传，随时随地了解车内各种信息\n            3、紧急救援，可实现碰撞自动求助、紧急救援求助、路边救援协助",img:$$.asset("images/sellpoint/interior2.jpg"),entity:"61f5bd1d61a458164be8900bce936b8b0a9f3e26",close:!1,mp3:$$.asset("audio/interior2.mp3")},{name:"ADiGO智能辅助驾驶系统",desc:"FCW前碰撞预警系统\n            当检测到碰撞危险时，系统会发出命令在组合仪表中通过图像和声音的方式提醒驾驶员。\n            \n            LDW车道偏离预警系统\n            通过前挡风玻璃上前摄像头探测车道线，在驾驶员注意力不集中，而偏离出车道时，通过仪表上的图像+声音来提醒驾驶员。\n            \n            AEB主动制动辅助系统\n            实时探测车辆与前方障碍物的距离与相对速度，有碰撞风险时通过视觉或声音警告驾驶员，如果驾驶员没有采取任何措施，系统将主动刹车以减轻碰撞伤害。",img:$$.asset("images/sellpoint/interior3.jpg"),entity:"be581bc82d7ac806030780f9c87ddc015ad60d30",close:!1,mp3:$$.asset("audio/interior3.mp3")},{name:"高档科技双联大屏",desc:"无边界7英寸液晶仪表\n            7英寸彩色TFT液晶仪表， 表盘采用半透黑膜材料， 熄屏状态下一体黑效果。可提供车辆运行的参数、故障、里程等信息，实时更新整车状态数据显示(驻车/行车等)\n            1、个性化开机界面；不同模式不同主题背景；高分辨率屏幕：800x480\n            2、一体黑效果，提升整体质感；显示信息丰富多样化，整体科技感强\n            \n            同级领先10.25英寸科技大屏\n            10.25英寸中控大屏屏幕分辨率：1920x720",img:$$.asset("images/sellpoint/interior4.jpg"),entity:"49a56dcaf9f498170e23fe3bff7ac800ce4e64ab",close:!1,mp3:$$.asset("audio/interior4.mp3")},{name:"人体工学运动座椅全面升级",desc:"采用广汽新一代平台化座椅设计理念，结合多年多代人机数据，人机曲线更合理，提供舒适的肩部、腰部与臀部支撑；合理裁片及双色皮革打孔材质，提高品质感与耐久度；座椅面料采用水性处理剂等工艺优化， VOC极低， 保证了车内空气质量。",img:$$.asset("images/sellpoint/interior5.jpg"),entity:"eee2b3c75b4e2921513026ef1377200dbcf2419e",close:!1,mp3:$$.asset("audio/interior5.mp3")},{name:"多模式智能6向电动调节座椅",desc:"主驾驶座椅配备6向电动调节功能，满足不同体型的各种坐姿，提升舒适性减少驾乘疲劳；前排座椅三模式智能加热三档可调，通过温度控制器将温度保持在一定范围。",img:$$.asset("images/sellpoint/interior5.jpg"),entity:"8cde26fd946e05fcd4bdc2895ba89c3640d22b9a",close:!1,mp3:$$.asset("audio/interior6.mp3")},{name:"极致进化凌云翼3.0格栅",desc:"极简产品设计风格，强调纵向同时增加横向转折，搭配凌云翼格栅、科技大灯、飞行器雾灯，整体前脸更年轻时尚、辨识度高。",img:$$.asset("images/sellpoint/appearance1.png"),entity:"05fe47da-3720-422f-a1c0-8ae0c2198bbb",close:!0,mp3:$$.asset("audio/appearance1.mp3")},{name:"超音速战机细节设计",desc:"雾灯设计灵感源于超音速战机，强调速度感和现代感。横向贯穿布局增加前脸视觉宽度，赋予整车生动、年轻的特色。",img:$$.asset("images/sellpoint/appearance2.png"),entity:"b568d43d1fa9178b621c484575b90aa875da98c5",close:!0,mp3:$$.asset("audio/appearance2.mp3")},{name:"几何图形尾部",desc:"尾部延续前脸设计风格，尾灯和两侧回反上下相呼应，配合分色处理，使尾部整体更加时尚科技、更具辨识度。",img:$$.asset("images/sellpoint/appearance3.jpg"),entity:"2c29d505b45a6728404d42d66ccbab3856461f91",close:!0,mp3:$$.asset("audio/appearance3.mp3")},{name:"深邃星舰大灯",desc:"异型化轮廓设计的头灯，线条犀利，颜色深邃，充满科技感与战斗气息；双模组LED灯芯，造型犀利立体，运动感十足。",img:$$.asset("images/sellpoint/appearance4.png"),entity:"547091e1d6f02a095bbea01b0fe97df90698dc2a",close:!0,mp3:$$.asset("audio/appearance5.mp3")},{name:"全新传祺第三代270T(1.5TGDI) 发动机",desc:"联合世界级供应商团队，全面技术优化，性能全面提升：\n            1、200bar缸内直喷技术， 满足国6b正式排放标准， 优良的雾化效果可提升燃烧效率，多次喷射策略可降低排放\n            2、低惯量涡轮增压器，兼顾高速功率和低扭矩，提升低速响应性和高原适应性\n            3、电控可变机油泵技术+GCCS燃烧控制专利技术， 高能量独立驱动点火线圈+高性能火花塞，有效降低油耗\n            4、缸体优化+铝合金油底壳技术+博格华纳最新静音链， 提升NVH性能",img:$$.asset("images/sellpoint/appearance5.jpg"),entity:"f35b68ea8e06b8ea8e85bbb8da6c7881b96e0bf9",close:!0,mp3:$$.asset("audio/appearance7.mp3")},{name:"钻石切边式型面语言",desc:"灵感源于黑水晶，锋利的切边使前脸更加犀利，简洁大气的型面设计，增强前脸设计的现代感及生动气息。",img:$$.asset("images/sellpoint/appearance1.jpg"),entity:"b854efe05636da6269ac312443ebd49c83c7a5b8",close:!0,mp3:$$.asset("audio/appearance6.mp3")},{name:"14位一体博世ESP 9.3系统",desc:"全系标配博世ESP 9.3系统， 配备HHC上坡辅助、HDC下坡辅助等“14位一体”主动安全，实时计算并监控车辆的状态，让驾驶更智能，具有卓越安全性。",img:$$.asset("images/sellpoint/appearance7.jpg"),entity:"0feda243b92ed194d043525b988feb0dad02842f",close:!0,mp3:$$.asset("audio/appearance4.mp3")},{name:"同级领先行李箱容积",desc:"后排座椅靠背可放倒，可满足购物、旅游等各种生活需求，真正做到“随心购，随便用”。",img:$$.asset("images/sellpoint/transparent1.jpg"),entity:"34940a9f51713f8aa872865034b5fe233e64120e",close:!0,show:"745c7855-9373-4e0c-b61e-926da9680e33",hide:"a826706604a5dd9a8e797eb6ed5c5783646eb77c",mp3:$$.asset("audio/transparent1.mp3")},{name:"车规级CN95高效防护",desc:"荣获中汽研权威认证的车规级CN95高效空调滤芯，对3微米颗粒过滤高于95%；纳米级负离子发生器，释放300万负离子，杀灭细菌、净化车内空气。",img:$$.asset("images/sellpoint/transparent2.jpg"),entity:"620d4acc-bdd4-459a-a3cc-0ac2b502f40d",close:!0,show:"595d25b0-c31c-4f4c-aa1b-b7f281b613ce",hide:"f3984b89901053efe29b8214a255a07a52e96c03",mp3:$$.asset("audio/transparent2.mp3")},{name:"同级最优内舱宽度",desc:"前排肩部空间1410mm，后排肩部空间1400mm，多人乘坐更为宽敞。",img:$$.asset("images/sellpoint/transparent3.jpg"),entity:"415a21f0844e0b89c99cb40367f27106eeda8a90",close:!0,mp3:$$.asset("audio/transparent3.mp3")}]}}),u(n.prototype,"selling_point_data",[h.computed],Object.getOwnPropertyDescriptor(n.prototype,"selling_point_data"),n.prototype),s=u(n.prototype,"selling_point_uuid",[h.observable],{enumerable:!0,initializer:function(){return null}}),u(n.prototype,"current_selling_point",[h.computed],Object.getOwnPropertyDescriptor(n.prototype,"current_selling_point"),n.prototype),r=u(n.prototype,"display_selling_point",[h.observable],{enumerable:!0,initializer:function(){return!1}}),o=u(n.prototype,"animation_list",[h.observable],{enumerable:!0,initializer:function(){return[{name:"车前灯",entity:"ffbbbfc5bed7698b50dc3583e6efb7a7db9cdbd5",active:!1,open:"027cb8ff-ae92-4a0b-bde0-7a144b13549e",close:"a7ecdca598ef31f9b068905708af5a6def6c21fd",backseat:!0},{name:"左前门",entity:"9a62b3f4-03cd-4791-b229-eac0cb1bfdbd",active:!1,open:"ec4c10d4-025d-44b9-a355-075d2201216b",close:"4b1773a5aa6674ea2b1aec1e66a3dbd152ebf692",backseat:!0},{name:"右前门",entity:"d1d404b420207a201d4146e2d42cf5010526e25b",active:!1,open:"7b383898-0b87-4661-925c-cf77f44915f1",close:"804a65f5131962d0abe9d703c758f6f0bcc42873",backseat:!0},{name:"右后门",entity:"aaf81edd85b2838f8727229981481adddda68ab9",active:!1,open:"f450068ace368256c36f6e5cb7865f1a5cf3aa0c",close:"b9d317a0-1df6-4afd-9341-e4ad0c782e61",backseat:!0},{name:"左后门",entity:"802c4f8b730bd6dd07fa293c5a2a0a43e5433261",active:!1,open:"df5c5550-ec03-4609-abf0-28ce38519f76",close:"a26328c2bc9470a44ef80958d4e24462d66341dc",backseat:!0},{name:"尾箱",entity:"fc9db10c242daa8f8cc9f7612ee435bde96b1a91",active:!1,open:"bad2acf1-a179-413e-ad91-7b7de37c4820",close:"2a297d25ee997620459d3f39ede0be46750902ab",backseat:!0},{name:"天窗",entity:"86193e1a18bbed90a54fb75263416b918699002f",active:!1,open:"9c5ea79d-84cb-410a-87a2-cc2f9e0e7383",close:"5ba2d92e3793ab7134964a0adbb20797f6e059fe",backseat:!0},{name:"尾灯",entity:"06e81af5db1e6490bc4548e45d78cf457aa1c139",active:!1,open:"c19c3fb6-a721-4f88-ab13-8a2224b3b5ce",close:"0615d9c07d145d2598dfdfe81e8250d24fedf654",backseat:!0},{name:"后排",entity:"e6bc18a4-2740-4fb9-946d-279b16221bc7",active:!1,open:"07d82c0b-d8ca-4081-b8ad-324d40b29f79",close:"bec3047ab7359bd08c5c4e573a258c35621de189",backseat:!1},{name:"后尾箱",entity:"06f4143f8ee7d47bf6083285a65084fe89689ccd",active:!1,open:"6357324e-0314-4828-9a58-2acc10020918",close:"183df0aa-3064-4f87-b2a0-e574eabeaeda",backseat:!1},{name:"内天窗",entity:"708aeaa0fd15bcf599978d5b15644aafd06d07e1",active:!1,open:"9c5ea79d-84cb-410a-87a2-cc2f9e0e7383",close:"5ba2d92e3793ab7134964a0adbb20797f6e059fe",backseat:!0}]}}),u(n.prototype,"animation_data",[h.computed],Object.getOwnPropertyDescriptor(n.prototype,"animation_data"),n.prototype),u(n.prototype,"update",[h.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),u(n.prototype,"onCreate",[h.action],Object.getOwnPropertyDescriptor(n.prototype,"onCreate"),n.prototype),u(n.prototype,"onAnnotationClick",[h.action],Object.getOwnPropertyDescriptor(n.prototype,"onAnnotationClick"),n.prototype),u(n.prototype,"onSellPointClose",[h.action],Object.getOwnPropertyDescriptor(n.prototype,"onSellPointClose"),n.prototype),u(n.prototype,"onSwitchAnimation",[h.action],Object.getOwnPropertyDescriptor(n.prototype,"onSwitchAnimation"),n.prototype),u(n.prototype,"onCloseAllAnimation",[h.action],Object.getOwnPropertyDescriptor(n.prototype,"onCloseAllAnimation"),n.prototype),u(n.prototype,"onOpenAllAnimation",[h.action],Object.getOwnPropertyDescriptor(n.prototype,"onOpenAllAnimation"),n.prototype),u(n.prototype,"update",[h.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),n);t.default=d;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(d,"Annotation","D:/shun/gs3power/src/stores/annotation.js")},eJF5:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,a=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),s=i("q1tI"),r=i("17x9"),o=(n=r)&&n.__esModule?n:{default:n};function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var h=function(e){function r(){var e,t,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r);for(var n=arguments.length,a=Array(n),s=0;s<n;s++)a[s]=arguments[s];return(t=i=l(this,(e=r.__proto__||Object.getPrototypeOf(r)).call.apply(e,[this].concat(a)))).state={mod:null},l(i,t)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(r,s.Component),a(r,[{key:"componentWillMount",value:function(){this.load(this.props)}},{key:"componentWillReceiveProps",value:function(e){e.load!==this.props.load&&this.load(e)}},{key:"load",value:function(e){var t=this;this.setState({mod:null}),e.load(function(e){t.setState({mod:e.default?e.default:e})})}},{key:"render",value:function(){return this.props.children(this.state.mod)}}]),r}();h.propTypes={load:o.default.func,children:o.default.func};var c=h;t.default=c;"undefined"!=typeof __REACT_HOT_LOADER__&&(__REACT_HOT_LOADER__.register(h,"Bundle","D:/shun/gs3power/src/router/Bundle.js"),__REACT_HOT_LOADER__.register(c,"default","D:/shun/gs3power/src/router/Bundle.js"))},fsYI:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r,o,l,h,c,u,d,p,f,m,v,g,_,y,b,x,M,S=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),w=i("2vnA");function C(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function P(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function T(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var A=(T((n=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),P(this,"barrage",a,this),P(this,"eqgo",s,this),P(this,"eqgoShow",r,this),P(this,"qrcodeShow",o,this),P(this,"disableArr",l,this),P(this,"stopInteractionArr",h,this),P(this,"initStatus",c,this),P(this,"currentPattern",u,this),P(this,"currentColor",d,this),P(this,"currentTires",p,this),P(this,"currentXRay",f,this),P(this,"currentInterior",m,this),P(this,"currentInteriorPosition",v,this),P(this,"currentInteriorColor",g,this),P(this,"animationSwitch",_,this),P(this,"sellPointSwitch",y,this),P(this,"transparentSwitch",b,this),P(this,"sizeSwitch",x,this),P(this,"motionAnimationSwitch",M,this),this.store=$$.events.call("store"),$$.events.on("store:app",this.initAppEventListener.bind(this)),this.state={colorIndex:{"皓月灰":{id:$$.SEM.COLOR.C0,imgSrc:$$.asset("images/common/color1.png"),active:this.currentColor===$$.SEM.COLOR.C0,name:"皓月灰"},"象牙白":{id:$$.SEM.COLOR.C3,imgSrc:$$.asset("images/common/color4.png"),active:this.currentColor===$$.SEM.COLOR.C3,name:"象牙白"}}}}return S(t,[{key:"initAppEventListener",value:function(e){this.app=e,this.app.events.on("edk:scene:interaction:timeline:stop",this.onInteractionStop.bind(this))}},{key:"onInteractionStop",value:function(e,t){this.disableArr[t]&&(this.disableArr[t]=!1)}},{key:"clickHeader",value:function(e){this.currentInterior&&e===$$.SEM.Pattern.Motion||this.disable||(e===$$.SEM.Pattern.Motion&&this.onSwitch(),this.currentPattern=e,this.store.runInteraction(this.currentPattern),this.currentInterior||(this.disableArr[$$.SEM.DefaultCamera]=!0,this.store.runInteraction($$.SEM.DefaultCamera)),this.currentPattern===$$.SEM.Pattern.Outdoor&&this.eqgo.outdoor&&(this.eqgo.outdoor=!1))}},{key:"clickSwitch",value:function(e,t){if(!this.disable)switch("currentInterior"!==e&&"currentXRay"!==e||this.onSwitch(),this[e]=t,e){case"motionAnimationSwitch":this.onSwitchMotion();break;case"sizeSwitch":this.onSwitchSize();break;case"currentInterior":this.intoInterior();break;case"animationSwitch":this.onSwitchAnimation();break;case"sellPointSwitch":this.onSwitchSellPoint();break;case"transparentSwitch":this.onSwitchTransparent();break;case"currentXRay":this.intoXRay();break;case"currentInteriorPosition":this.disableArr[this[e]]=!0,this.store.runInteraction(this[e]);break;case"barrage":break;default:this.store.runInteraction(this[e])}}},{key:"intoMotion",value:function(){this.initStatus?this.onSwitchMotion():this.initStatus=!0,this.currentXRay&&(this.currentXRay=!1,this.intoXRay())}},{key:"outMotion",value:function(){var t=this;this.motionAnimationSwitch&&(this.store.stopInteraction(),$$.SEM.MotionAnimation.off.map(function(e){return t.store.runInteraction(e)})),this.store.runInteraction($$.SEM.DefaultCamera)}},{key:"onSwitchMotion",value:function(){var t=this;this.motionAnimationSwitch?$$.SEM.MotionAnimation.on.map(function(e){t.store.runInteraction(e)}):(this.store.stopInteraction(),$$.SEM.MotionAnimation.off.map(function(e){return t.store.runInteraction(e)}))}},{key:"onSwitchSize",value:function(){this.sizeSwitch?this.store.runInteraction($$.SEM.Size.on):this.store.runInteraction($$.SEM.Size.off)}},{key:"intoInterior",value:function(){var e=void 0;if(this.currentInterior)e=$$.SEM.Interior.into;else{switch(this.currentInteriorPosition){case $$.SEM.Interior.Position1:e=$$.SEM.Interior.outPosition1;break;case $$.SEM.Interior.Position2:e=$$.SEM.Interior.outPosition2;break;case $$.SEM.Interior.Position3:e=$$.SEM.Interior.outPosition3}this.currentInteriorPosition=$$.SEM.Interior.Position1}this.store.runInteraction(e),this.disableArr[e]=!0,this.currentXRay&&(this.currentXRay=!1,this.intoXRay())}},{key:"intoXRay",value:function(){this.currentXRay?(this.store.annotation.update("selling_point_uuid",null),this.store.runInteraction($$.SEM.Transparent.on)):(this.store.annotation.update("selling_point_uuid",null),this.store.runInteraction($$.SEM.Transparent.off))}},{key:"onSwitchAnimation",value:function(){var e=this.currentInterior?"Interior":"Appearance",t=this.animationSwitch?"on":"off";this.store.runInteraction($$.SEM.Animation[e][t]),this.animationSwitch&&!this.currentInterior?!this.currentInterior&&this.store.annotation.onOpenAllAnimation():this.store.annotation.onCloseAllAnimation()}},{key:"onSwitchSellPoint",value:function(){var e=this.currentInterior?"Interior":"Appearance",t=this.sellPointSwitch?"on":"off";this.store.runInteraction($$.SEM.SellPoint[e][t]),this.eqgo.sellpoint&&(this.eqgo.sellpoint=!1)}},{key:"onSwitchTransparent",value:function(){this.transparentSwitch?this.store.runInteraction($$.SEM.Transparent.point_on):this.store.runInteraction($$.SEM.Transparent.point_off)}},{key:"onSwitch",value:function(){var t=this;["animationSwitch","sellPointSwitch","sizeSwitch"].forEach(function(e){t[e]&&t.clickSwitch(e,!1)}),this.clickSwitch("transparentSwitch",!0)}},{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}},{key:"disable",get:function(){var e=this.disableArr,t=!1;for(var i in e)!0===e[i]&&(t=!0);return t}},{key:"header",get:function(){return[{id:$$.SEM.Pattern.Motion,title:"运动",icon:"iconspace_textsport",imgSrc:$$.asset("images/header/space_imgsport.png"),active:this.currentPattern===$$.SEM.Pattern.Motion},{id:$$.SEM.Pattern.Indoor,title:"展厅",icon:"iconspace_textindoor",imgSrc:$$.asset("images/header/space_imgindoor.png"),active:this.currentPattern===$$.SEM.Pattern.Indoor},{id:$$.SEM.Pattern.Outdoor,title:"户外",icon:"iconspace_textoutdoor",imgSrc:$$.asset("images/header/space_imgoutdoor.png"),active:this.currentPattern===$$.SEM.Pattern.Outdoor}]}},{key:"color",get:function(){var e,t=this,i={},n=(C(e={},$$.SEM.Version.V1,["皓月灰","象牙白"]),C(e,$$.SEM.Version.V2,["皓月灰","象牙白"]),C(e,$$.SEM.Version.V3,["象牙白"]),C(e,$$.SEM.Version.V4,["象牙白"]),e);return this.store&&(i.color=n[this.store.version.current_id].map(function(e){return t.state.colorIndex[e]})),i}},{key:"interiorColor",get:function(){return[{id:$$.SEM.Interior.C1,imgSrc:$$.asset("images/common/interiorcolor_2.png"),active:this.currentInteriorColor===$$.SEM.Interior.C1,name:"潮派酷玩"},{id:$$.SEM.Interior.C0,imgSrc:$$.asset("images/common/interiorcolor_1.png"),active:this.currentInteriorColor===$$.SEM.Interior.C0,name:"经典醇黑"},{id:$$.SEM.Interior.C2,imgSrc:$$.asset("images/common/interiorcolor_3.png"),active:this.currentInteriorColor===$$.SEM.Interior.C2,name:"都市活力"}]}},{key:"interiorPosition",get:function(){return[{id:$$.SEM.Interior.Position1,imgSrc:$$.asset("images/common/position1.png"),active:this.currentInteriorPosition===$$.SEM.Interior.Position1,name:"主驾驶"},{id:$$.SEM.Interior.Position2,imgSrc:$$.asset("images/common/position2.png"),active:this.currentInteriorPosition===$$.SEM.Interior.Position2,name:"副驾驶"},{id:$$.SEM.Interior.Position3,imgSrc:$$.asset("images/common/position3.png"),active:this.currentInteriorPosition===$$.SEM.Interior.Position3,name:"后座"}]}},{key:"tires",get:function(){return[{id:$$.SEM.Tires.T0,imgSrc:$$.asset("images/common/tires1.png"),active:this.currentTires===$$.SEM.Tires.T0,name:"18寸"},{id:$$.SEM.Tires.T2,imgSrc:$$.asset("images/common/tires3.png"),active:this.currentTires===$$.SEM.Tires.T2,name:"18寸"},{id:$$.SEM.Tires.T1,imgSrc:$$.asset("images/common/tires2.png"),active:this.currentTires===$$.SEM.Tires.T1,name:"17寸"}]}},{key:"xrayData",get:function(){$$.utils.platform().mobile;return this.currentXRay?{imgSrc:$$.asset("images/scene/xray_off.png"),title:"退出透视",status:!0}:{imgSrc:$$.asset("images/scene/xray_off.png"),title:"透视",status:!1}}},{key:"switchArr",get:function(){var e=[];return!this.currentXRay||this.currentInterior?e.push({title:"动画开关",field:"animationSwitch",status:this.animationSwitch},{title:"卖点开关",field:"sellPointSwitch",status:this.sellPointSwitch}):e.push({title:"透明卖点",field:"transparentSwitch",status:this.transparentSwitch}),this.currentXRay||this.currentInterior||e.push({title:"尺寸显示",field:"sizeSwitch",status:this.sizeSwitch}),e}},{key:"radioArr",get:function(){var e=[];return this.currentInterior&&e.push({data:this.interiorPosition,field:"currentInteriorPosition"}),this.currentInterior||this.currentXRay?e.push({data:this.interiorColor,field:"currentInteriorColor"}):e.push({data:this.color,field:"currentColor"}),e}},{key:"interiorData",get:function(){return this.currentXRay?null:this.currentInterior?{imgSrc:$$.asset("images/scene/exterior.png"),title:"返回外观",status:!0}:{imgSrc:$$.asset("images/scene/interior.jpg"),title:"内饰",status:!1}}}]),t}()).prototype,"disable",[w.computed],Object.getOwnPropertyDescriptor(n.prototype,"disable"),n.prototype),a=T(n.prototype,"barrage",[w.observable],{enumerable:!0,initializer:function(){return!0}}),s=T(n.prototype,"eqgo",[w.observable],{enumerable:!0,initializer:function(){return{sellpoint:!0,outdoor:!0,purchase:!0}}}),r=T(n.prototype,"eqgoShow",[w.observable],{enumerable:!0,initializer:function(){return!1}}),o=T(n.prototype,"qrcodeShow",[w.observable],{enumerable:!0,initializer:function(){return!1}}),l=T(n.prototype,"disableArr",[w.observable],{enumerable:!0,initializer:function(){return{}}}),h=T(n.prototype,"stopInteractionArr",[w.observable],{enumerable:!0,initializer:function(){return{}}}),c=T(n.prototype,"initStatus",[w.observable],{enumerable:!0,initializer:function(){return!1}}),u=T(n.prototype,"currentPattern",[w.observable],{enumerable:!0,initializer:function(){return $$.SEM.Pattern.Motion}}),d=T(n.prototype,"currentColor",[w.observable],{enumerable:!0,initializer:function(){return $$.SEM.COLOR.C0}}),p=T(n.prototype,"currentTires",[w.observable],{enumerable:!0,initializer:function(){return $$.SEM.Tires.T0}}),f=T(n.prototype,"currentXRay",[w.observable],{enumerable:!0,initializer:function(){return!1}}),m=T(n.prototype,"currentInterior",[w.observable],{enumerable:!0,initializer:function(){return!1}}),v=T(n.prototype,"currentInteriorPosition",[w.observable],{enumerable:!0,initializer:function(){return $$.SEM.Interior.Position1}}),g=T(n.prototype,"currentInteriorColor",[w.observable],{enumerable:!0,initializer:function(){return $$.SEM.Interior.C1}}),_=T(n.prototype,"animationSwitch",[w.observable],{enumerable:!0,initializer:function(){return!1}}),y=T(n.prototype,"sellPointSwitch",[w.observable],{enumerable:!0,initializer:function(){return!1}}),b=T(n.prototype,"transparentSwitch",[w.observable],{enumerable:!0,initializer:function(){return!0}}),x=T(n.prototype,"sizeSwitch",[w.observable],{enumerable:!0,initializer:function(){return!1}}),M=T(n.prototype,"motionAnimationSwitch",[w.observable],{enumerable:!0,initializer:function(){return!0}}),T(n.prototype,"header",[w.computed],Object.getOwnPropertyDescriptor(n.prototype,"header"),n.prototype),T(n.prototype,"clickHeader",[w.action],Object.getOwnPropertyDescriptor(n.prototype,"clickHeader"),n.prototype),T(n.prototype,"color",[w.computed],Object.getOwnPropertyDescriptor(n.prototype,"color"),n.prototype),T(n.prototype,"interiorColor",[w.computed],Object.getOwnPropertyDescriptor(n.prototype,"interiorColor"),n.prototype),T(n.prototype,"interiorPosition",[w.computed],Object.getOwnPropertyDescriptor(n.prototype,"interiorPosition"),n.prototype),T(n.prototype,"tires",[w.computed],Object.getOwnPropertyDescriptor(n.prototype,"tires"),n.prototype),T(n.prototype,"xrayData",[w.computed],Object.getOwnPropertyDescriptor(n.prototype,"xrayData"),n.prototype),T(n.prototype,"switchArr",[w.computed],Object.getOwnPropertyDescriptor(n.prototype,"switchArr"),n.prototype),T(n.prototype,"radioArr",[w.computed],Object.getOwnPropertyDescriptor(n.prototype,"radioArr"),n.prototype),T(n.prototype,"interiorData",[w.computed],Object.getOwnPropertyDescriptor(n.prototype,"interiorData"),n.prototype),T(n.prototype,"clickSwitch",[w.action],Object.getOwnPropertyDescriptor(n.prototype,"clickSwitch"),n.prototype),T(n.prototype,"intoMotion",[w.action],Object.getOwnPropertyDescriptor(n.prototype,"intoMotion"),n.prototype),T(n.prototype,"outMotion",[w.action],Object.getOwnPropertyDescriptor(n.prototype,"outMotion"),n.prototype),T(n.prototype,"onSwitchMotion",[w.action],Object.getOwnPropertyDescriptor(n.prototype,"onSwitchMotion"),n.prototype),T(n.prototype,"onSwitch",[w.action],Object.getOwnPropertyDescriptor(n.prototype,"onSwitch"),n.prototype),T(n.prototype,"update",[w.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),n);t.default=A;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(A,"Menu","D:/shun/gs3power/src/stores/menu.js")},"gE/l":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={NOT_FOUND_PAGE:"找不到页面"};t.default=n;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(n,"default","D:/shun/gs3power/src/core/lang/zh_CN.js")},gvet:function(e,t,i){},iKIH:function(e,t,i){e.exports={loading:"index__loading__3yFm4",fullspan:"index__fullspan__XoFin"}},lkCJ:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={index:function(){0<arguments.length&&void 0!==arguments[0]&&arguments[0];return"*"}};t.default=n;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(n,"default","D:/shun/gs3power/src/core/config/route.js")},pC9Z:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=h(i("q1tI")),a=h(i("MA9d")),s=h(i("Jeaf")),r=h(i("eJF5")),o=h(i("28lc")),l=h(i("HMSZ"));function h(e){return e&&e.__esModule?e:{default:e}}var c=function(e){return function(){return n.default.createElement(r.default,{load:e},function(e){return e?n.default.createElement(e,null):n.default.createElement(o.default,null)})}},u=function(){return n.default.createElement(s.default,null,n.default.createElement(a.default,{exch:!0,path:$$.route("index"),component:c(l.default)}))},d=u;t.default=d;"undefined"!=typeof __REACT_HOT_LOADER__&&(__REACT_HOT_LOADER__.register(c,"createComponent","D:/shun/gs3power/src/router/Runtime.js"),__REACT_HOT_LOADER__.register(u,"Runtime","D:/shun/gs3power/src/router/Runtime.js"),__REACT_HOT_LOADER__.register(d,"default","D:/shun/gs3power/src/router/Runtime.js"))},pHvw:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.store=void 0;var n,a,s,r,o,l,h,c,u=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),d=i("2vnA"),p=P(i("5aor")),f=P(i("Yixb")),m=P(i("fsYI")),v=P(i("aCKS")),g=P(i("P4xH")),_=P(i("Pq7S")),y=P(i("IfyZ")),b=P(i("rnng")),x=P(i("TcX+")),M=P(i("NjnD")),S=P(i("vpQy")),w=P(i("4M7o")),C=P(i("TGrZ"));function P(e){return e&&e.__esModule?e:{default:e}}function T(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function A(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var E=i("JPoV").studio,R=(n=function(e){function n(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n);var t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return T(t,"canvas",a,t),T(t,"settingVisible",s,t),T(t,"currentLayerUrl",r,t),T(t,"_isScroller",o,t),T(t,"scene",l,t),T(t,"isTmall",h,t),T(t,"barrageArr",c,t),t.gallery=new g.default,t.tips=new _.default,t.menu=new m.default,t.message=new x.default,t.annotation=new v.default,t.staticData=new y.default,t.barrage=new b.default,t.regions=new M.default,t.music=new S.default,t.version=new C.default,t.isWechat&&(t.wechat=new w.default),t.onJudgeTamll(),t}var t,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(n,p.default),u(n,[{key:"isWechat",get:function(){return"micromessenger"==navigator.userAgent.toLowerCase().match(/MicroMessenger/i)}},{key:"isIPhone",get:function(){return!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)}}]),u(n,[{key:"init",value:function(e){var i=this;this.canvas=e,"local"===$$.config.data&&f.default.rawAxios.get($$.config.publicPath+"info.json").then(function(e){var t=e.data;i.initConfig($$.platform.mobile?t.m_config:t.config,t.prefix)}).catch(function(){})}},{key:"initConfig",value:function(e,t){var i=this;f.default.rawAxios.get($$.config.publicPath+e,{responseType:"arraybuffer"}).then(function(e){i.initApp(e.data,t)}).catch(function(){})}},{key:"initApp",value:(t=regeneratorRuntime.mark(function e(t){var i,n,a=this,s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=this.modifyData(t),this.canvas&&(n={mode:"viewer",dracoDecoderConfig:{decoderFilePath:$$.asset("libs/draco/draco_decoder.js"),wasmWrapperFilePath:$$.asset("libs/draco/draco_wasm_wrapper.js"),wasmFilePath:$$.asset("libs/draco/draco_decoder.wasm")},preferWebGl2:"true"===$$.utils.getQueryString("webgl2")},s&&(n.prefix=s),this.app=new E(this.canvas,n),this.app&&($$.events.method("store:app",function(){return a.app}),$$.events.fire("store:app",this.app),this.initAppEvent(),this.app.loadData(i,{id:this.sceneID})));case 2:case"end":return e.stop()}},e,this)}),i=function(){var o=t.apply(this,arguments);return new Promise(function(s,r){return function t(e,i){try{var n=o[e](i),a=n.value}catch(e){return void r(e)}if(!n.done)return Promise.resolve(a).then(function(e){t("next",e)},function(e){t("throw",e)});s(a)}("next")})},function(e){return i.apply(this,arguments)})},{key:"modifyData",value:function(e){return e}},{key:"onLoadResourceEnd",value:function(){var t=this;(function e(t,i,n){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,i);if(void 0===a){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,i,n)}if("value"in a)return a.value;var r=a.get;return void 0!==r?r.call(n):void 0})(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"onLoadResourceEnd",this).call(this),$$.utils.platform().mobile?($$.SEM.StartAnimation.map(function(e){t.runInteraction(e)}),this.runInteraction($$.SEM.StartAnimationMobile),this.menu.disableArr[$$.SEM.StartAnimationMobile]=!0):$$.SEM.MotionAnimation.on.map(function(e){t.runInteraction(e)}),this.runInteraction($$.SEM.DefaultCamera),this.runInteraction($$.SEM.Pattern.Motion),this.runInteraction($$.SEM.DisableCameraMove);var e=this.music.musicList[0];if(e.action){var i=document.getElementById(e.id);i&&i.paused&&i.play()}}},{key:"onJudgeTamll",value:function(){this.isTmall="gacmotor.ews.m.jaeapp.com"===window.location.hostname||"gacmotor.ewszjk.m.jaeapp.com"===window.location.hostname}},{key:"onAnnotationClick",value:function(e,t,i){this.annotation&&this.annotation.onAnnotationClick(t,i)}},{key:"switchScene",value:function(e){this.scene=e,this.runInteraction(e)}},{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}},{key:"getData",value:function(){var n=this;return new Promise(function(i,t){f.default.get("//xxx.com").then(function(e){var t=e.list;n.barrageArr=n.barrageArr.concat(t.data),i(t.data)}).catch(function(e){t(e)})})}},{key:"gotoLotteryPC",value:function(){window.location.href=this.isTmall?$$.SEM.GAME_TMALL_PC_URL:$$.SEM.GAME_NORMAL_PC_URL}},{key:"gotoLotteryMobile",value:function(){var e=this.isTmall?$$.SEM.GAME_TMALL_MOBILE_URL:$$.SEM.GAME_NORMAL_PC_URL;window.open(e)}}]),n}(),a=A(n.prototype,"canvas",[d.observable],{enumerable:!0,initializer:function(){return null}}),s=A(n.prototype,"settingVisible",[d.observable],{enumerable:!0,initializer:function(){return!1}}),r=A(n.prototype,"currentLayerUrl",[d.observable],{enumerable:!0,initializer:function(){return null}}),o=A(n.prototype,"_isScroller",[d.observable],{enumerable:!0,initializer:function(){return!1}}),l=A(n.prototype,"scene",[d.observable],{enumerable:!0,initializer:function(){return $$.SEM.SCENE_OUTDOOR}}),h=A(n.prototype,"isTmall",[d.observable],{enumerable:!0,initializer:function(){return!1}}),A(n.prototype,"isWechat",[d.computed],Object.getOwnPropertyDescriptor(n.prototype,"isWechat"),n.prototype),A(n.prototype,"isIPhone",[d.computed],Object.getOwnPropertyDescriptor(n.prototype,"isIPhone"),n.prototype),A(n.prototype,"onLoadResourceEnd",[d.action],Object.getOwnPropertyDescriptor(n.prototype,"onLoadResourceEnd"),n.prototype),A(n.prototype,"onJudgeTamll",[d.action],Object.getOwnPropertyDescriptor(n.prototype,"onJudgeTamll"),n.prototype),A(n.prototype,"onAnnotationClick",[d.action],Object.getOwnPropertyDescriptor(n.prototype,"onAnnotationClick"),n.prototype),A(n.prototype,"switchScene",[d.action],Object.getOwnPropertyDescriptor(n.prototype,"switchScene"),n.prototype),A(n.prototype,"update",[d.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),c=A(n.prototype,"barrageArr",[d.observable],{enumerable:!0,initializer:function(){return[]}}),A(n.prototype,"getData",[d.action],Object.getOwnPropertyDescriptor(n.prototype,"getData"),n.prototype),A(n.prototype,"gotoLotteryPC",[d.action],Object.getOwnPropertyDescriptor(n.prototype,"gotoLotteryPC"),n.prototype),A(n.prototype,"gotoLotteryMobile",[d.action],Object.getOwnPropertyDescriptor(n.prototype,"gotoLotteryMobile"),n.prototype),n),D=new R;t.store=D;"undefined"!=typeof __REACT_HOT_LOADER__&&(__REACT_HOT_LOADER__.register(E,"Application","D:/shun/gs3power/src/stores/index.js"),__REACT_HOT_LOADER__.register(R,"Store","D:/shun/gs3power/src/stores/index.js"),__REACT_HOT_LOADER__.register(D,"store","D:/shun/gs3power/src/stores/index.js"))},"qNl/":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={StartAnimation:["ea65e800-6097-466f-9efc-2c3a21626865","027cb8ff-ae92-4a0b-bde0-7a144b13549e","f5d84cd3-267c-4035-bbed-bf8740a365ab","c19c3fb6-a721-4f88-ab13-8a2224b3b5ce"],StartAnimationMobile:"3360de95-8fa4-4332-b558-2742b6257dd0",DefaultCamera:"59d9fb1b-c066-49d9-8923-8c18dcee7d2e",DisableCameraMove:"f9a67cce-8e12-4048-adf9-d0b8c52232b9",MotionAnimation:{on:["ea65e800-6097-466f-9efc-2c3a21626865","027cb8ff-ae92-4a0b-bde0-7a144b13549e","ea129dbf97c4b136317f131298f5a2c011339617","c19c3fb6-a721-4f88-ab13-8a2224b3b5ce"],off:["a7ecdca598ef31f9b068905708af5a6def6c21fd","0615d9c07d145d2598dfdfe81e8250d24fedf654"]},Pattern:{Motion:"4c4aceb4-cfe3-4472-8cb2-193988ecc446",Outdoor:"a314425d335276a4b7d24f64d1faa9decef200fe",Indoor:"24d7c2b1-965c-42de-a0a5-9e0f37eb11b3"},COLOR:{C0:"481982fa-8276-4bd8-91c4-4075fa297d59",C3:"5f9117d1-7a80-4b0f-850a-0fe03a015478"},Tires:{T0:"31d4f126-6c2d-42e4-8059-8697aeb453d5",T1:"1c122b80039505714f7255e599809fde2126ecb9",T2:"ab281a0183d26ea3ed6fe02141ac59a6c8d1dc94"},Interior:{Position1:"aa61b2e6-cd46-4e93-8834-3a044cd883ac",Position2:"7ee3c77bf0a80d4c116a93cb5aa9aef13c0aeab8",Position3:"923c634150c9a9c15d1265f36e14758d01290abc",into:"314a1383-b69b-429b-9ad7-5ccc870b3755",outPosition1:"f2cb0809-83d6-4f30-864e-4832b3b17f4f",outPosition2:"a362aa5684013afe9c5c2135eaa053436642886d",outPosition3:"8a2ceaabe08e94cfa8910ed6addf860a9bfd8ca1",C0:"bab82f93-0f37-418c-abde-c3e79f174335",C1:"cdb0fe17-f152-411a-8e17-31f06b54b738",C2:"1e1029968af3ea8d12d7aa92348ae41ae1ec3576"},Size:{off:"6b9addc2-c4fb-41d3-bf3d-0e667ebe5b72",on:"2fc99d501925edf1183a28b8607264f3718cdc7f"},SellPoint:{Appearance:{on:"d20082d7e2655f66eb71e60760af52e07c2dba89",off:"5aa30750-e86c-4bc8-92f5-8273aaf8b673"},Interior:{on:"83c09403-452e-4063-8f2d-852634b872c7",off:"7e8a03ba-971d-4e99-acc4-7a127ad26a29"}},Animation:{Appearance:{on:"9faebc05-2d07-40fd-8a61-7578d6229b95",off:"b793224b-2658-4fa3-a58b-3a3ff7e24b23"},Interior:{on:"f50faf38-3422-4bce-a21c-e27274b25972",off:"2f56d6a49297f02c2ba9c94c92d760f711b65b19"}},Transparent:{on:"7891ad6b-98e9-4015-a0b4-90b291b3e4fa",off:"52b8357b-298e-4ffd-ba3a-a2466c9c9019",point_on:"1412d523-5f81-494e-817e-58b94ee5239a",point_off:"200c0b0e6fe5f4e59c62cdfa87a3d79b6a61ca4f"},Version:{V1:"87e92046-8fa5-4bba-a885-29cb21e65c5e",V2:"2337826368180453391",V3:"d6fa5198-d203-4549-92b7-da36a05fce25",V4:"2337826930730991714"},GAME_TMALL_MOBILE_URL:"//m.duanqu.com/?_ariver_appid=3000000002241023&_mp_code=tb&transition=present&page=i%2fi%3fi%3dWJCRFH1G",GAME_TMALL_PC_URL:"//topauth.taobao.com/container?appkey=12262395&state=p-LDzRFzLEzSAzLCzSEzLDzSAzLEzRHzLFzSC",GAME_NORMAL_PC_URL:"//100000267683.voice.n.weimob.com/saas/voice/100000267683/50006877?v=cf52469c73a251a2a43c647c76168b02&activityType=2",TMALL_MALL_MOBILE_URL:"//shop.m.taobao.com/shop/shopIndex.htm?shop_id=109405253",TMALL_MALL_PC_URL:"//trumpchi.tmall.com/?spm=a1z10.4-b-s.w5001-21508432235.3.3abc5cd2Ut4jzg&scene=taobao_shop",NORMAL_MALL_URL:"//100000267683.retail.n.weimob.com/saas/retail/100000267683/64263683/shop/index",TMALL_RESERVE_MOBILE_URL:"//h5.m.taobao.com/awp/core/detail.htm?id=609092886300",TMALL_RESERVE_PC_URL:"//detail.tmall.com/item.htm?spm=a1z10.1-b-s.w5001-21508432235.4.49c96b64bHnQoj&id=609092886300&rn=369c8c9a3139cdf9496afbc81ff4a7a9&abbucket=10&scene=taobao_shop",NORMAL_RESERVE_URL:"//www.gacmotor.com/index/testdrive",TMALL_BUY_MOBILE_URL:"//h5.m.taobao.com/awp/core/detail.htm?id=627875803741",TMALL_BUY_PC_URL:"//detail.tmall.com/item.htm?spm=a1z10.1-b-s.w5003-23160133912.1.49c96b64bHnQoj&id=627875803741&skuId=4621370530073&scene=taobao_shop",NORAML_BUY_URL:"http://100000267683.retail.n.weimob.com/saas/retail/100000267683/0/goods/detail?id=1260642390183",prize:"//xxx.com/project/trumpchi/gs3/prize/cover.png"};t.default=n;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(n,"default","D:/shun/gs3power/src/core/config/semantic.js")},rnng:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r,o,l,h,c,u,d,p=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),f=i("2vnA"),m=v(i("Yixb"));v(i("5aor"));function v(e){return e&&e.__esModule?e:{default:e}}function g(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function _(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var y=(n=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),g(this,"showArr",a,this),g(this,"index1",s,this),g(this,"index2",r,this),g(this,"index3",o,this),g(this,"index4",l,this),g(this,"lastIndex",h,this),g(this,"likeNum",c,this),g(this,"liveNum",u,this),g(this,"barrageArr",d,this),this.store=$$.events.call("store")}return p(t,[{key:"updateIndex",value:function(e){this.index4=e,this.index3=e-1,this.index2=e-2,this.index1=e-3}},{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}},{key:"getData",value:function(){var n=this;return new Promise(function(i,t){m.default.get("//xxx.com").then(function(e){var t=e.list;n.barrageArr=n.barrageArr.concat(t.data),i(t.data)}).catch(function(e){t(e)})})}},{key:"item1",get:function(){var e=this.barrageArr;return e[this.index1]?e[this.index1]:{}}},{key:"item2",get:function(){var e=this.barrageArr;return e[this.index2]?e[this.index2]:{}}},{key:"item3",get:function(){var e=this.barrageArr;return e[this.index3]?e[this.index3]:{}}},{key:"item4",get:function(){var e=this.barrageArr;return e[this.index4]?e[this.index4]:{}}}]),t}(),a=_(n.prototype,"showArr",[f.observable],{enumerable:!0,initializer:function(){return[]}}),s=_(n.prototype,"index1",[f.observable],{enumerable:!0,initializer:function(){return 0}}),r=_(n.prototype,"index2",[f.observable],{enumerable:!0,initializer:function(){return 1}}),o=_(n.prototype,"index3",[f.observable],{enumerable:!0,initializer:function(){return 2}}),l=_(n.prototype,"index4",[f.observable],{enumerable:!0,initializer:function(){return 3}}),h=_(n.prototype,"lastIndex",[f.observable],{enumerable:!0,initializer:function(){return 0}}),_(n.prototype,"updateIndex",[f.action],Object.getOwnPropertyDescriptor(n.prototype,"updateIndex"),n.prototype),_(n.prototype,"item1",[f.computed],Object.getOwnPropertyDescriptor(n.prototype,"item1"),n.prototype),_(n.prototype,"item2",[f.computed],Object.getOwnPropertyDescriptor(n.prototype,"item2"),n.prototype),_(n.prototype,"item3",[f.computed],Object.getOwnPropertyDescriptor(n.prototype,"item3"),n.prototype),_(n.prototype,"item4",[f.computed],Object.getOwnPropertyDescriptor(n.prototype,"item4"),n.prototype),_(n.prototype,"update",[f.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),c=_(n.prototype,"likeNum",[f.observable],{enumerable:!0,initializer:function(){return 0}}),u=_(n.prototype,"liveNum",[f.observable],{enumerable:!0,initializer:function(){return 0}}),d=_(n.prototype,"barrageArr",[f.observable],{enumerable:!0,initializer:function(){return[]}}),_(n.prototype,"getData",[f.action],Object.getOwnPropertyDescriptor(n.prototype,"getData"),n.prototype),n);t.default=y;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(y,"Barrage","D:/shun/gs3power/src/stores/barrage.js")},scdK:function(e,t,i){"use strict";(function(n){Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e={guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},getQueryString:function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=n.window.location.search.substr(1).match(t);return null!=i?unescape(i[2]):null},getCookie:function(e){if(n.document&&0<n.document.cookie.length){var t=n.document.cookie.indexOf(e+"=");if(-1!==t){t=t+e.length+1;var i=n.document.cookie.indexOf(";",t);return-1===i&&(i=n.document.cookie.length),unescape(n.document.cookie.substring(t,i))}}return""},dataURLtoBlob:function(e){for(var t=e.split(","),i=t[0].match(/:(.*?);/)[1],n=atob(t[1]),a=n.length,s=new Uint8Array(a);a--;)s[a]=n.charCodeAt(a);return new Blob([s],{type:i})},xmlToJson:function(e){var t=function(){};return t.prototype.setXml=function(e){e&&"string"==typeof e?(this.xml=document.createElement("div"),this.xml.innerHTML=e,this.xml=this.xml.getElementsByTagName("*")[0]):"object"===(void 0===e?"undefined":i(e))&&(this.xml=e)},t.prototype.getXml=function(){return this.xml},t.prototype.parse=function(e){return this.setXml(e),this.convert(this.xml)},t.prototype.convert=function(e){if(1!=e.nodeType)return null;var t={};t.xtype=e.nodeName.toLowerCase();var i=(e.textContent||"").replace(/(\r|\n)/g,"").replace(/^\s+|\s+$/g,"");if(i&&1==e.childNodes.length&&(t.text=i),0<e.attributes.length)for(var n=0;n<e.attributes.length;n++){var a=e.attributes.item(n);t[a.nodeName]=a.nodeValue}if(0<e.childNodes.length){for(var s=[],r=0;r<e.childNodes.length;r++){var o=e.childNodes.item(r),l=this.convert(o);l&&s.push(l)}0<s.length&&(t.items=s)}return t},(new t).parse(e)},adaptResourceUrl:function(e){return e&&-1===e.indexOf("data:")&&-1===e.indexOf("blob:")&&(0===e.indexOf("http://")&&(e=e.substring(5)),0===e.indexOf("https://")&&(e=e.substring(6)),-1!==e.indexOf("//")&&0===e.indexOf("//")||(e="//"+e)),e},platform:function(){var e={desktop:!1,mobile:!1,ios:!1,android:!1,tablet:!1,windows:!1,cocoonjs:!1,xbox:!1,gamepads:!1,chrome:!1,firefox:!1,touch:!1},t=navigator.userAgent;return/(windows|mac os|linux|cros)/i.test(t)&&(e.desktop=!0),/xbox/i.test(t)&&(e.xbox=!0),/(?:Firefox)/.test(t)&&(e.firefox=!0),/(?:Chrome|CriOS)/.test(t)&&(e.chrome=!0),/(windows phone|iemobile|wpdesktop)/i.test(t)?(e.desktop=!1,e.mobile=!0,e.windows=!0):/android/i.test(t)?(e.desktop=!1,e.mobile=!0,e.android=!0):/ip([ao]d|hone)/i.test(t)&&(e.desktop=!1,e.mobile=!0,e.ios=!0),e.tablet=/(?:iPad|PlayBook)/.test(t)||e.android&&!/(?:Mobile)/.test(t)||e.firefox&&/(?:Tablet)/.test(t),e.touch="ontouchstart"in window,e.gamepads="getGamepads"in navigator,e},loadScript:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=document.getElementById(t);n?document.body.removeChild(n):n=document.createElement("script"),n.id=t,n.type="text/javascript",n.src=$$.utils.adaptResourceUrl(e),Object.keys(i).forEach(function(e){n.setAttribute(e,i[e])}),document.body.appendChild(n)}};t.default=e;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(e,"default","D:/shun/gs3power/src/core/utils.js")}).call(this,i("yLpj"))},uDJ7:function(e,f,m){"use strict";(function(e){Object.defineProperty(f,"__esModule",{value:!0}),f.Application=void 0;var t=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),i=c(m("qNl/")),n=c(m("JNVv")),a=c(m("yRYd")),s=c(m("lkCJ")),r=c(m("VkRT")),o=c(m("scdK")),l=c(m("Cm0m")),h=c(m("gE/l"));function c(e){return e&&e.__esModule?e:{default:e}}var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.SEM=i.default,this.IMAGE=n.default,this.LN=h.default,this.config=r.default,this.utils=o.default,this.platform=o.default.platform(),this.events=new l.default}return t(e,[{key:"url",value:function(e,t){return a.default[e](t)}},{key:"route",value:function(e,t){return s.default[e](t)}},{key:"asset",value:function(e){return""+this.config.assetPath+e}}]),e}(),d=new u,p=e.$$=d;f.default=p,f.Application=u;"undefined"!=typeof __REACT_HOT_LOADER__&&(__REACT_HOT_LOADER__.register(u,"Application","D:/shun/gs3power/src/core/application.js"),__REACT_HOT_LOADER__.register(d,"application","D:/shun/gs3power/src/core/application.js"),__REACT_HOT_LOADER__.register(p,"default","D:/shun/gs3power/src/core/application.js"))}).call(this,m("yLpj"))},vpQy:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,a,s,r,o=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),l=i("2vnA");h(i("Yixb")),h(i("5aor"));function h(e){return e&&e.__esModule?e:{default:e}}function c(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function u(i,n,e,t,a){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},s),a&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(a):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,n,s),s=null),s}var d=(n=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,"shouldInterrupt",a,this),c(this,"musicList",s,this),c(this,"selectMusicId",r,this),this.store=$$.events.call("store")}return o(t,[{key:"update",value:function(t,e){var i=this;t instanceof Object?Object.keys(t).forEach(function(e){i.update(e,t[e])}):this[t]=e}},{key:"interrupt",value:function(){this.shouldInterrupt=!1,this.musicList[0].action=!1,this.musicList[1].action=!0}}]),t}(),a=u(n.prototype,"shouldInterrupt",[l.observable],{enumerable:!0,initializer:function(){return!0}}),u(n.prototype,"update",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"update"),n.prototype),s=u(n.prototype,"musicList",[l.observable],{enumerable:!0,initializer:function(){return[{id:"music_welcome",action:!0,loop:!1,src:$$.asset("audio/gs3_bg.mp3")},{id:"music_bg",action:!1,src:$$.asset("audio/gs3_bg.mp3"),loop:!0}]}}),u(n.prototype,"interrupt",[l.action],Object.getOwnPropertyDescriptor(n.prototype,"interrupt"),n.prototype),r=u(n.prototype,"selectMusicId",[l.observable],{enumerable:!0,initializer:function(){return"music_welcome"}}),n);t.default=d;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(d,"Music","D:/shun/gs3power/src/stores/music.js")},x7I7:function(e,t,i){"use strict";var n=d(i("vgIT"));i("Saan"),i("201c");var a=d(i("q1tI")),s=d(i("i8i4")),r=i("0cfB"),o=d(i("pC9Z")),l=d(i("1Kko")),h=i("okNM");i("uDJ7");var c=function(e){{if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}}(i("pHvw")),u=d(i("xc/l"));function d(e){return e&&e.__esModule?e:{default:e}}function p(e){s.default.render(a.default.createElement(n.default,{locale:u.default},a.default.createElement(r.AppContainer,null,a.default.createElement(h.Provider,c,a.default.createElement(l.default,null,e)))),document.getElementById("app"))}i("gvet"),p((0,o.default)());"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(p,"renderWithHotReload","D:/shun/gs3power/src/core/index.js")},yRYd:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={index:function(){0<arguments.length&&void 0!==arguments[0]&&arguments[0];return"/"},mini_home:function(){0<arguments.length&&void 0!==arguments[0]&&arguments[0];return"/components/pages/index/index"},mini_login:function(){0<arguments.length&&void 0!==arguments[0]&&arguments[0];return"/components/pages/login/index"},mini_signup:function(){0<arguments.length&&void 0!==arguments[0]&&arguments[0];return"/components/pages/signup/index"},mini_share:function(){return"/components/pages/share/index?id="+(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).id},mini_jump:function(){return"/components/pages/jump/index?target="+(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).target},mini_jump_custom:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return"/components/pages/jump/index?target="+e.target+"&label="+e.label+"&path="+e.path+"&params="+e.params}};t.default=n;"undefined"!=typeof __REACT_HOT_LOADER__&&__REACT_HOT_LOADER__.register(n,"default","D:/shun/gs3power/src/core/config/url.js")}},[[0,1,0,5]]]);